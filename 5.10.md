# 5.10 çµæ§‹åŒ–è³‡æ–™è½‰æ›å™¨

> **æœ¬ç« é‡é»**ï¼šå­¸ç¿’ Spring AI çš„çµæ§‹åŒ–è³‡æ–™è½‰æ›æŠ€è¡“ï¼ŒæŒæ¡å¦‚ä½•è®“ AI è¼¸å‡ºæ¨™æº–åŒ–çš„è³‡æ–™æ ¼å¼ï¼Œå»ºç«‹ä¼æ¥­ç´šçš„è³‡æ–™è™•ç†å’Œæ•´åˆç³»çµ±ã€‚

## ğŸ¯ å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬ç« å­¸ç¿’å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š

- ğŸ¯ **ç†è§£çµæ§‹åŒ–è¼¸å‡º**ï¼šæŒæ¡ AI çµæ§‹åŒ–è³‡æ–™è¼¸å‡ºçš„é‡è¦æ€§å’Œæ‡‰ç”¨å ´æ™¯
- ğŸ¯ **ä½¿ç”¨ç¾ä»£åŒ– API**ï¼šå­¸æœƒä½¿ç”¨ ChatClient çš„ entity() æ–¹æ³•é€²è¡Œé¡å‹è½‰æ›
- ğŸ¯ **æŒæ¡å‚³çµ±è½‰æ›å™¨**ï¼šäº†è§£ BeanOutputConverterã€MapOutputConverter ç­‰è½‰æ›å™¨
- ğŸ¯ **è¨­è¨ˆè³‡æ–™æ¨¡å‹**ï¼šå»ºç«‹é©åˆ AI è¼¸å‡ºçš„ Java è³‡æ–™çµæ§‹
- ğŸ¯ **ä¼æ¥­ç´šæ‡‰ç”¨**ï¼šå¯¦ç¾å¯ç”¨æ–¼ç”Ÿç”¢ç’°å¢ƒçš„çµæ§‹åŒ–è³‡æ–™è™•ç†ç³»çµ±

---

## 5.10.1 çµæ§‹åŒ–è¼¸å‡ºçš„é‡è¦æ€§

### Spring å¾ˆæ³¨é‡ä¸€è‡´æ€§

![Spring ä¸€è‡´æ€§](https://ithelp.ithome.com.tw/upload/images/20240814/20161290CYmKc1rZYz.png)

å…ˆèªªå€‹é¡Œå¤–è©±ï¼ŒSpring AI 1.1 åœ¨çµæ§‹åŒ–è¼¸å‡ºæ–¹é¢æœ‰äº†é‡å¤§æ”¹é€²ï¼ä¸åƒ…ä¿ç•™äº†åŸæœ‰çš„ `StructuredOutputConverter`ï¼Œé‚„åœ¨ ChatClient ä¸­æ–°å¢äº†æ›´ç°¡æ½”çš„ `entity()` æ–¹æ³•ï¼Œè®“é–‹ç™¼è€…æœ‰æ›´å¤šé¸æ“‡ã€‚

### Converter å°±æ˜¯å°‡ JSON è½‰ç‚º Java çš„çµæ§‹

å°ç¨‹å¼è€Œè¨€ï¼Œè¦çœ‹æ‡‚ ChatGPT å›æ‡‰çš„æ–‡å­—ä¸¦ä¸å®¹æ˜“ï¼Œæ‰€ä»¥ OpenAI ä¹Ÿæä¾›äº†è¨±å¤šæ–¹å¼å°‡å›æ‡‰è½‰ç‚ºä¸åŒå‹æ…‹ï¼ŒJSONã€XML æˆ–æ˜¯ Markdown çš„èªæ³•ï¼Œæœ€è¿‘ OpenAI é‚„æ›´æ–°äº†æ–°çš„åŠŸèƒ½ï¼Œé€éå¼·åˆ¶ç´„æŸï¼Œè®“ OpenAI çš„è¼¸å‡ºå¯ä»¥èˆ‡å®šç¾©çš„ JSON æ ¼å¼å®Œå…¨ä¸€è‡´ï¼Œæœ‰äº†é€™åŠŸèƒ½å¾Œé€²è¡Œå¤–éƒ¨ç³»çµ±æ•´åˆæ‰èƒ½è®“å¤±èª¤ç‡é™åˆ°æœ€ä½ã€‚

### çµæ§‹åŒ–è¼¸å‡ºçš„æ ¸å¿ƒåƒ¹å€¼

**1. ç³»çµ±æ•´åˆçš„å¿…è¦æ€§**
- ğŸ”— **API æ•´åˆ**ï¼šèˆ‡å…¶ä»–ç³»çµ±é€²è¡Œè³‡æ–™äº¤æ›æ™‚éœ€è¦æ¨™æº–æ ¼å¼
- ğŸ“Š **è³‡æ–™è™•ç†**ï¼šç¨‹å¼éœ€è¦çµæ§‹åŒ–è³‡æ–™æ‰èƒ½é€²è¡Œé‚è¼¯è™•ç†
- ğŸ¯ **é¡å‹å®‰å…¨**ï¼šå¼·å‹åˆ¥èªè¨€éœ€è¦æ˜ç¢ºçš„è³‡æ–™çµæ§‹
- ğŸ”„ **è‡ªå‹•åŒ–æµç¨‹**ï¼šçµæ§‹åŒ–è³‡æ–™å¯ä»¥è§¸ç™¼å¾ŒçºŒçš„è‡ªå‹•åŒ–è™•ç†

**2. å‚³çµ±æ–‡å­— vs çµæ§‹åŒ–è³‡æ–™**

| æ¯”è¼ƒé …ç›® | å‚³çµ±æ–‡å­—å›æ‡‰ | çµæ§‹åŒ–è³‡æ–™ |
|----------|-------------|------------|
| **å¯è®€æ€§** | äººé¡å‹å–„ | ç¨‹å¼å‹å–„ |
| **è™•ç†é›£åº¦** | éœ€è¦è§£æ | ç›´æ¥ä½¿ç”¨ |
| **æº–ç¢ºæ€§** | å®¹æ˜“å‡ºéŒ¯ | æ ¼å¼ä¿è­‰ |
| **æ•´åˆæ€§** | å›°é›£ | å®¹æ˜“ |
| **ç¶­è­·æ€§** | è¤‡é›œ | ç°¡å–® |
| **æ“´å±•æ€§** | å—é™ | éˆæ´» |

**3. Spring AI 1.1 çš„æ”¹é€²**

Spring AI 1.1 åœ¨é€™æ–¹é¢æœ‰äº†é¡¯è‘—çš„æ”¹é€²ï¼Œç¾åœ¨æä¾›äº†å…©ç¨®ä¸»è¦æ–¹å¼ä¾†è™•ç†çµæ§‹åŒ–è¼¸å‡ºï¼š

1. **å‚³çµ±çš„ StructuredOutputConverter** - éœ€è¦æ‰‹å‹•è™•ç†æ ¼å¼æè¿°
2. **æ–°çš„ ChatClient entity() æ–¹æ³•** - è‡ªå‹•è™•ç†é¡å‹è½‰æ›

![è½‰æ›å™¨æ¶æ§‹](https://ithelp.ithome.com.tw/upload/images/20240814/201612906iIB5Aaeg3.jpg)

---

## 5.10.2 ä¸‰ç¨®è½‰æ›å™¨çš„ç”¨é€”

### è½‰æ›å™¨é¡å‹æ¦‚è¦½

Spring AI ç›®å‰æä¾›çš„è½‰æ›å™¨æœ‰ä¸‰å€‹ `BeanOutputConverter`ã€`MapOutputConverter` å’Œ `ListOutputConverter`ï¼ˆæŠ½è±¡é¡åˆ¥å°±ä¸çœ‹äº†ï¼‰

![è½‰æ›å™¨é¡å‹](https://ithelp.ithome.com.tw/upload/images/20240814/20161290XuAnAxIQer.jpg)

### å„è½‰æ›å™¨è©³ç´°èªªæ˜

**1. BeanOutputConverter**
- ğŸ¯ **ç”¨é€”**ï¼šAI ç”¢ç”Ÿçš„æ ¼å¼åŒ–è³‡æ–™ä¸»è¦ä»¥ JSON ç‚ºä¸»ï¼Œé€™å€‹è½‰æ›å™¨å°±æ˜¯å°‡ JSON è½‰ç‚º Java ç¨‹å¼éœ€è¦çš„ Bean
- ğŸ”§ **æŠ€è¡“å¯¦ç¾**ï¼šèƒŒå¾Œç”¨åˆ°çš„å°±æ˜¯ Spring MVC æœ€å¸¸ç”¨åˆ°çš„ ObjectMapper
- ğŸ“‹ **é©ç”¨å ´æ™¯**ï¼šè¤‡é›œçš„è³‡æ–™çµæ§‹ã€ä¼æ¥­ç´šæ‡‰ç”¨ã€éœ€è¦å¼·å‹åˆ¥çš„å ´åˆ
- âœ… **å„ªå‹¢**ï¼šé¡å‹å®‰å…¨ã€IDE æ”¯æ´ã€æ˜“æ–¼ç¶­è­·

**2. MapOutputConverter**
- ğŸ¯ **ç”¨é€”**ï¼šé€™å€‹è½‰æ›å™¨æ˜¯å°‡è³‡æ–™ä½¿ç”¨ Map çš„æ–¹å¼è½‰å‡ºï¼Œå°æœªçŸ¥çš„æ ¼å¼æœ€å¸¸ä½¿ç”¨çš„è™•ç†æ–¹å¼
- ğŸ”§ **æŠ€è¡“å¯¦ç¾**ï¼šå°‡ JSON è½‰æ›ç‚º Map<String, Object> çµæ§‹
- ğŸ“‹ **é©ç”¨å ´æ™¯**ï¼šå‹•æ…‹è³‡æ–™çµæ§‹ã€æ¢ç´¢æ€§é–‹ç™¼ã€å¿«é€ŸåŸå‹
- âœ… **å„ªå‹¢**ï¼šéˆæ´»æ€§é«˜ã€ç„¡éœ€é å®šç¾©çµæ§‹ã€å¿«é€Ÿé–‹ç™¼

**3. ListOutputConverter**
- ğŸ¯ **ç”¨é€”**ï¼šé€™å€‹è½‰æ›å™¨é¡§åæ€ç¾©å°±æ˜¯å°‡çµæœè½‰ç‚º Listï¼Œä¸éé€™è£¡ä¸»è¦ä»¥å­—ä¸²çš„ List ç‚ºä¸»
- ğŸ”§ **æŠ€è¡“å¯¦ç¾**ï¼šè§£æ AI å›æ‡‰ä¸­çš„åˆ—è¡¨é …ç›®
- ğŸ“‹ **é©ç”¨å ´æ™¯**ï¼šç°¡å–®åˆ—è¡¨è³‡æ–™ã€é¸é …æ¸…å–®ã€æ¨™ç±¤é›†åˆ
- âœ… **å„ªå‹¢**ï¼šç°¡å–®ç›´æ¥ã€è™•ç†æ•ˆç‡é«˜ã€è¨˜æ†¶é«”ä½”ç”¨å°‘

**ä½¿ç”¨å»ºè­°**ï¼š
- ä¾‹å¦‚è«‹ AI æä¾›æœ€å—æ­¡è¿çš„äº”ç¨®å†°æ·‡æ·‹å£å‘³ï¼Œè‹¥æ˜¯çµæ§‹åŒ–çš„è¤‡æ•¸è³‡æ–™å‰‡é‚„æ˜¯ä½¿ç”¨ `BeanOutputConverter` é€²è¡Œè½‰æ›ï¼Œåªæ˜¯å°‡ Bean çš„é¡åˆ¥æ”¹ç‚º `ParameterizedTypeReference`

---

## 5.10.3 ç¾ä»£åŒ– API å¯¦ç¾

### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ ChatClient entity() æ–¹æ³•ï¼ˆæ¨è–¦ï¼‰

Spring AI 1.1 æ–°å¢çš„ `entity()` æ–¹æ³•æ˜¯æœ€ç°¡æ½”çš„æ–¹å¼ï¼Œå®ƒæœƒè‡ªå‹•è™•ç†é¡å‹è½‰æ›ï¼š

```java
package com.example.controller;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/structured")
@RequiredArgsConstructor
@Slf4j
public class StructuredOutputController {
    
    private final ChatClient chatClient;
    
    /**
     * å–®ä¸€æ¼”å“¡çš„é›»å½±ä½œå“
     * @param actor æ¼”å“¡åç¨±
     * @return æ¼”å“¡é›»å½±ä½œå“
     */
    @GetMapping("/actor-films")
    public ActorsFilms getActorFilms(@RequestParam String actor) {
        try {
            log.info("æŸ¥è©¢æ¼”å“¡é›»å½±ä½œå“ï¼š{}", actor);
            
            ActorsFilms result = chatClient.prompt()
                    .user("Generate the filmography of 5 movies for {actor}. " +
                          "Please provide the response in JSON format with 'actor' and 'movies' fields.", 
                          Map.of("actor", actor))
                    .call()
                    .entity(ActorsFilms.class);
            
            log.info("æˆåŠŸå–å¾— {} çš„é›»å½±ä½œå“ï¼Œå…± {} éƒ¨é›»å½±", 
                    result.actor(), result.movies().size());
            
            return result;
            
        } catch (Exception e) {
            log.error("æŸ¥è©¢æ¼”å“¡é›»å½±ä½œå“å¤±æ•—ï¼š{}", actor, e);
            return new ActorsFilms(actor, List.of("æŸ¥è©¢å¤±æ•—ï¼š" + e.getMessage()));
        }
    }
    
    /**
     * å¤šä½æ¼”å“¡çš„é›»å½±ä½œå“
     * @return å¤šä½æ¼”å“¡çš„é›»å½±ä½œå“åˆ—è¡¨
     */
    @GetMapping("/multiple-actors")
    public List<ActorsFilms> getMultipleActors() {
        try {
            log.info("æŸ¥è©¢å¤šä½æ¼”å“¡é›»å½±ä½œå“");
            
            List<ActorsFilms> results = chatClient.prompt()
                    .user("Generate the filmography of 5 movies each for Tom Hanks and Bill Murray. " +
                          "Please provide the response as a JSON array with each object containing 'actor' and 'movies' fields.")
                    .call()
                    .entity(new ParameterizedTypeReference<List<ActorsFilms>>() {});
            
            log.info("æˆåŠŸå–å¾— {} ä½æ¼”å“¡çš„é›»å½±ä½œå“", results.size());
            
            return results;
            
        } catch (Exception e) {
            log.error("æŸ¥è©¢å¤šä½æ¼”å“¡é›»å½±ä½œå“å¤±æ•—", e);
            return List.of(
                new ActorsFilms("Tom Hanks", List.of("æŸ¥è©¢å¤±æ•—ï¼š" + e.getMessage())),
                new ActorsFilms("Bill Murray", List.of("æŸ¥è©¢å¤±æ•—ï¼š" + e.getMessage()))
            );
        }
    }
    
    /**
     * é›»å½±è³‡è¨ŠæŸ¥è©¢
     * @param movieTitle é›»å½±æ¨™é¡Œ
     * @return é›»å½±è©³ç´°è³‡è¨Š
     */
    @GetMapping("/movie-info")
    public MovieInfo getMovieInfo(@RequestParam String movieTitle) {
        try {
            log.info("æŸ¥è©¢é›»å½±è³‡è¨Šï¼š{}", movieTitle);
            
            MovieInfo result = chatClient.prompt()
                    .user("Provide detailed information about the movie '{movieTitle}'. " +
                          "Include title, director, year, genre, rating, and a brief plot summary. " +
                          "Format the response as JSON.", 
                          Map.of("movieTitle", movieTitle))
                    .call()
                    .entity(MovieInfo.class);
            
            log.info("æˆåŠŸå–å¾—é›»å½±è³‡è¨Šï¼š{} ({})", result.title(), result.year());
            
            return result;
            
        } catch (Exception e) {
            log.error("æŸ¥è©¢é›»å½±è³‡è¨Šå¤±æ•—ï¼š{}", movieTitle, e);
            return new MovieInfo(
                    movieTitle,
                    "æœªçŸ¥",
                    0,
                    "æœªçŸ¥",
                    0.0,
                    "æŸ¥è©¢å¤±æ•—ï¼š" + e.getMessage()
            );
        }
    }
    
    /**
     * ç”¢å“æ¨è–¦åˆ—è¡¨
     * @param category ç”¢å“é¡åˆ¥
     * @param count æ¨è–¦æ•¸é‡
     * @return ç”¢å“æ¨è–¦åˆ—è¡¨
     */
    @GetMapping("/product-recommendations")
    public ProductRecommendations getProductRecommendations(
            @RequestParam String category,
            @RequestParam(defaultValue = "5") int count) {
        
        try {
            log.info("æŸ¥è©¢ç”¢å“æ¨è–¦ï¼šé¡åˆ¥={}ï¼Œæ•¸é‡={}", category, count);
            
            ProductRecommendations result = chatClient.prompt()
                    .user("Recommend {count} popular {category} products. " +
                          "For each product, provide name, brand, price, rating, and description. " +
                          "Format as JSON with 'category', 'count', and 'products' array.",
                          Map.of("count", count, "category", category))
                    .call()
                    .entity(ProductRecommendations.class);
            
            log.info("æˆåŠŸå–å¾— {} é¡åˆ¥çš„ {} å€‹ç”¢å“æ¨è–¦", 
                    result.category(), result.products().size());
            
            return result;
            
        } catch (Exception e) {
            log.error("æŸ¥è©¢ç”¢å“æ¨è–¦å¤±æ•—ï¼šé¡åˆ¥={}", category, e);
            return new ProductRecommendations(
                    category,
                    0,
                    List.of(),
                    "æŸ¥è©¢å¤±æ•—ï¼š" + e.getMessage()
            );
        }
    }
}
```

### è³‡æ–™æ¨¡å‹å®šç¾©

```java
package com.example.model;

import com.fasterxml.jackson.annotation.JsonProperty;

import java.util.List;

/**
 * æ¼”å“¡é›»å½±ä½œå“
 */
public record ActorsFilms(
        @JsonProperty("actor") String actor,
        @JsonProperty("movies") List<String> movies
) {}

/**
 * é›»å½±è³‡è¨Š
 */
public record MovieInfo(
        @JsonProperty("title") String title,
        @JsonProperty("director") String director,
        @JsonProperty("year") int year,
        @JsonProperty("genre") String genre,
        @JsonProperty("rating") double rating,
        @JsonProperty("plot") String plot
) {}

/**
 * ç”¢å“è³‡è¨Š
 */
public record Product(
        @JsonProperty("name") String name,
        @JsonProperty("brand") String brand,
        @JsonProperty("price") double price,
        @JsonProperty("rating") double rating,
        @JsonProperty("description") String description
) {}

/**
 * ç”¢å“æ¨è–¦åˆ—è¡¨
 */
public record ProductRecommendations(
        @JsonProperty("category") String category,
        @JsonProperty("count") int count,
        @JsonProperty("products") List<Product> products,
        @JsonProperty("error") String error
) {
    public ProductRecommendations(String category, int count, List<Product> products) {
        this(category, count, products, null);
    }
}

/**
 * ä¼æ¥­è³‡æ–™åˆ†æçµæœ
 */
public record BusinessAnalysis(
        @JsonProperty("summary") String summary,
        @JsonProperty("key_metrics") List<KeyMetric> keyMetrics,
        @JsonProperty("recommendations") List<String> recommendations,
        @JsonProperty("risk_factors") List<String> riskFactors,
        @JsonProperty("confidence_score") double confidenceScore
) {}

public record KeyMetric(
        @JsonProperty("name") String name,
        @JsonProperty("value") String value,
        @JsonProperty("trend") String trend,
        @JsonProperty("importance") String importance
) {}
```

---

## 5.10.4 å‚³çµ±è½‰æ›å™¨å¯¦ç¾

### æ–¹æ³•äºŒï¼šä½¿ç”¨å‚³çµ±çš„ StructuredOutputConverter

å¦‚æœä½ éœ€è¦æ›´å¤šæ§åˆ¶æ¬Šï¼Œä»å¯ä»¥ä½¿ç”¨å‚³çµ±çš„è½‰æ›å™¨ï¼š

```java
package com.example.controller;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.converter.BeanOutputConverter;
import org.springframework.ai.converter.ListOutputConverter;
import org.springframework.ai.converter.MapOutputConverter;
import org.springframework.core.convert.support.DefaultConversionService;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/converter")
@RequiredArgsConstructor
@Slf4j
public class ConverterController {
    
    private final ChatClient chatClient;
    
    /**
     * Bean Output Converter ç¯„ä¾‹
     * @param actor æ¼”å“¡åç¨±
     * @return æ¼”å“¡é›»å½±ä½œå“
     */
    @GetMapping("/actor-films-converter")
    public ActorsFilms getActorFilmsWithConverter(@RequestParam String actor) {
        try {
            log.info("ä½¿ç”¨ BeanOutputConverter æŸ¥è©¢æ¼”å“¡é›»å½±ä½œå“ï¼š{}", actor);
            
            BeanOutputConverter<ActorsFilms> beanOutputConverter = 
                    new BeanOutputConverter<>(ActorsFilms.class);
            String format = beanOutputConverter.getFormat();
            
            log.debug("è½‰æ›å™¨æ ¼å¼ï¼š{}", format);
            
            String response = chatClient.prompt()
                    .user("Generate the filmography of 5 movies for {actor}. {format}", 
                          Map.of("actor", actor, "format", format))
                    .call()
                    .content();
            
            log.debug("AI å›æ‡‰ï¼š{}", response);
            
            ActorsFilms result = beanOutputConverter.convert(response);
            
            log.info("æˆåŠŸè½‰æ›æ¼”å“¡é›»å½±ä½œå“ï¼š{}", result.actor());
            
            return result;
            
        } catch (Exception e) {
            log.error("BeanOutputConverter æŸ¥è©¢å¤±æ•—ï¼š{}", actor, e);
            return new ActorsFilms(actor, List.of("æŸ¥è©¢å¤±æ•—ï¼š" + e.getMessage()));
        }
    }
    
    /**
     * Map Output Converter ç¯„ä¾‹
     * @return æ•¸å­—è³‡æ–™çš„ Map æ ¼å¼
     */
    @GetMapping("/numbers-map")
    public Map<String, Object> getNumbersAsMap() {
        try {
            log.info("ä½¿ç”¨ MapOutputConverter æŸ¥è©¢æ•¸å­—è³‡æ–™");
            
            MapOutputConverter mapOutputConverter = new MapOutputConverter();
            String format = mapOutputConverter.getFormat();
            
            log.debug("è½‰æ›å™¨æ ¼å¼ï¼š{}", format);
            
            String response = chatClient.prompt()
                    .user("Provide interesting statistics about the number 42. {format}", 
                          Map.of("format", format))
                    .call()
                    .content();
            
            log.debug("AI å›æ‡‰ï¼š{}", response);
            
            Map<String, Object> result = mapOutputConverter.convert(response);
            
            log.info("æˆåŠŸè½‰æ›ç‚º Mapï¼ŒåŒ…å« {} å€‹éµå€¼å°", result.size());
            
            return result;
            
        } catch (Exception e) {
            log.error("MapOutputConverter æŸ¥è©¢å¤±æ•—", e);
            return Map.of("error", "æŸ¥è©¢å¤±æ•—ï¼š" + e.getMessage());
        }
    }
    
    /**
     * List Output Converter ç¯„ä¾‹
     * @param category é¡åˆ¥
     * @param count æ•¸é‡
     * @return é …ç›®åˆ—è¡¨
     */
    @GetMapping("/items-list")
    public List<String> getItemsList(
            @RequestParam String category,
            @RequestParam(defaultValue = "5") int count) {
        
        try {
            log.info("ä½¿ç”¨ ListOutputConverter æŸ¥è©¢é …ç›®åˆ—è¡¨ï¼šé¡åˆ¥={}ï¼Œæ•¸é‡={}", category, count);
            
            ListOutputConverter listOutputConverter = 
                    new ListOutputConverter(new DefaultConversionService());
            String format = listOutputConverter.getFormat();
            
            log.debug("è½‰æ›å™¨æ ¼å¼ï¼š{}", format);
            
            String response = chatClient.prompt()
                    .user("List {count} popular {category} items. {format}",
                          Map.of("count", count, "category", category, "format", format))
                    .call()
                    .content();
            
            log.debug("AI å›æ‡‰ï¼š{}", response);
            
            List<String> result = listOutputConverter.convert(response);
            
            log.info("æˆåŠŸè½‰æ›ç‚ºåˆ—è¡¨ï¼ŒåŒ…å« {} å€‹é …ç›®", result.size());
            
            return result;
            
        } catch (Exception e) {
            log.error("ListOutputConverter æŸ¥è©¢å¤±æ•—ï¼šé¡åˆ¥={}", category, e);
            return List.of("æŸ¥è©¢å¤±æ•—ï¼š" + e.getMessage());
        }
    }
    
    /**
     * è¤‡é›œæ¥­å‹™åˆ†æï¼ˆä½¿ç”¨ BeanOutputConverterï¼‰
     * @param businessData æ¥­å‹™è³‡æ–™
     * @return åˆ†æçµæœ
     */
    @PostMapping("/business-analysis")
    public BusinessAnalysis analyzeBusinessData(@RequestBody String businessData) {
        try {
            log.info("ä½¿ç”¨ BeanOutputConverter é€²è¡Œæ¥­å‹™åˆ†æ");
            
            BeanOutputConverter<BusinessAnalysis> converter = 
                    new BeanOutputConverter<>(BusinessAnalysis.class);
            String format = converter.getFormat();
            
            String response = chatClient.prompt()
                    .user("Analyze the following business data and provide insights: \n{data}\n\n" +
                          "Please provide a comprehensive analysis including summary, key metrics, " +
                          "recommendations, risk factors, and confidence score. {format}",
                          Map.of("data", businessData, "format", format))
                    .call()
                    .content();
            
            BusinessAnalysis result = converter.convert(response);
            
            log.info("æ¥­å‹™åˆ†æå®Œæˆï¼Œä¿¡å¿ƒåˆ†æ•¸ï¼š{}", result.confidenceScore());
            
            return result;
            
        } catch (Exception e) {
            log.error("æ¥­å‹™åˆ†æå¤±æ•—", e);
            return new BusinessAnalysis(
                    "åˆ†æå¤±æ•—ï¼š" + e.getMessage(),
                    List.of(),
                    List.of(),
                    List.of("ç³»çµ±éŒ¯èª¤"),
                    0.0
            );
        }
    }
}
```

---

## 5.10.5 ä¼æ¥­ç´šæ‡‰ç”¨å ´æ™¯

### è³‡æ–™åˆ†æå¹³å°æ•´åˆ

```java
package com.example.service;

import com.example.model.BusinessAnalysis;
import com.example.model.ProductRecommendations;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Map;

@Service
@RequiredArgsConstructor
@Slf4j
public class StructuredAnalysisService {
    
    private final ChatClient chatClient;
    
    /**
     * éŠ·å”®è³‡æ–™åˆ†æ
     * @param salesData éŠ·å”®è³‡æ–™
     * @return çµæ§‹åŒ–åˆ†æçµæœ
     */
    public SalesAnalysisResult analyzeSalesData(Map<String, Object> salesData) {
        try {
            log.info("é–‹å§‹éŠ·å”®è³‡æ–™åˆ†æ");
            
            SalesAnalysisResult result = chatClient.prompt()
                    .system("ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„éŠ·å”®è³‡æ–™åˆ†æå¸«ï¼Œè«‹æä¾›æº–ç¢ºä¸”çµæ§‹åŒ–çš„åˆ†æçµæœã€‚")
                    .user("åˆ†æä»¥ä¸‹éŠ·å”®è³‡æ–™ä¸¦æä¾›æ´å¯Ÿï¼š\n{data}\n\n" +
                          "è«‹æä¾›çµæ§‹åŒ–çš„åˆ†æï¼ŒåŒ…æ‹¬ï¼š\n" +
                          "1. éŠ·å”®è¶¨å‹¢åˆ†æ\n" +
                          "2. ç”¢å“è¡¨ç¾è©•ä¼°\n" +
                          "3. å¸‚å ´æ©Ÿæœƒè­˜åˆ¥\n" +
                          "4. æ”¹é€²å»ºè­°\n" +
                          "5. é¢¨éšªè©•ä¼°",
                          Map.of("data", salesData))
                    .call()
                    .entity(SalesAnalysisResult.class);
            
            log.info("éŠ·å”®è³‡æ–™åˆ†æå®Œæˆï¼Œè¶¨å‹¢ï¼š{}", result.trend());
            
            return result;
            
        } catch (Exception e) {
            log.error("éŠ·å”®è³‡æ–™åˆ†æå¤±æ•—", e);
            throw new RuntimeException("éŠ·å”®è³‡æ–™åˆ†æå¤±æ•—ï¼š" + e.getMessage());
        }
    }
    
    /**
     * å®¢æˆ¶è¡Œç‚ºåˆ†æ
     * @param customerData å®¢æˆ¶è³‡æ–™
     * @return å®¢æˆ¶æ´å¯Ÿ
     */
    public CustomerInsights analyzeCustomerBehavior(List<Map<String, Object>> customerData) {
        try {
            log.info("é–‹å§‹å®¢æˆ¶è¡Œç‚ºåˆ†æï¼Œè³‡æ–™ç­†æ•¸ï¼š{}", customerData.size());
            
            CustomerInsights result = chatClient.prompt()
                    .system("ä½ æ˜¯ä¸€å€‹å®¢æˆ¶è¡Œç‚ºåˆ†æå°ˆå®¶ï¼Œè«‹åŸºæ–¼è³‡æ–™æä¾›æ·±å…¥çš„å®¢æˆ¶æ´å¯Ÿã€‚")
                    .user("åˆ†æä»¥ä¸‹å®¢æˆ¶è¡Œç‚ºè³‡æ–™ï¼š\n{data}\n\n" +
                          "è«‹æä¾›çµæ§‹åŒ–çš„å®¢æˆ¶æ´å¯Ÿï¼ŒåŒ…æ‹¬ï¼š\n" +
                          "1. å®¢æˆ¶ç´°åˆ†\n" +
                          "2. è¡Œç‚ºæ¨¡å¼\n" +
                          "3. åå¥½åˆ†æ\n" +
                          "4. æµå¤±é¢¨éšª\n" +
                          "5. å€‹æ€§åŒ–å»ºè­°",
                          Map.of("data", customerData))
                    .call()
                    .entity(CustomerInsights.class);
            
            log.info("å®¢æˆ¶è¡Œç‚ºåˆ†æå®Œæˆï¼Œè­˜åˆ¥å‡º {} å€‹å®¢æˆ¶ç¾¤é«”", 
                    result.segments().size());
            
            return result;
            
        } catch (Exception e) {
            log.error("å®¢æˆ¶è¡Œç‚ºåˆ†æå¤±æ•—", e);
            throw new RuntimeException("å®¢æˆ¶è¡Œç‚ºåˆ†æå¤±æ•—ï¼š" + e.getMessage());
        }
    }
    
    /**
     * å¸‚å ´è¶¨å‹¢é æ¸¬
     * @param marketData å¸‚å ´è³‡æ–™
     * @param timeframe é æ¸¬æ™‚é–“ç¯„åœ
     * @return å¸‚å ´é æ¸¬çµæœ
     */
    public MarketForecast predictMarketTrends(Map<String, Object> marketData, String timeframe) {
        try {
            log.info("é–‹å§‹å¸‚å ´è¶¨å‹¢é æ¸¬ï¼Œæ™‚é–“ç¯„åœï¼š{}", timeframe);
            
            MarketForecast result = chatClient.prompt()
                    .system("ä½ æ˜¯ä¸€å€‹å¸‚å ´åˆ†æå’Œé æ¸¬å°ˆå®¶ï¼Œè«‹åŸºæ–¼æ­·å²è³‡æ–™æä¾›æº–ç¢ºçš„å¸‚å ´é æ¸¬ã€‚")
                    .user("åŸºæ–¼ä»¥ä¸‹å¸‚å ´è³‡æ–™é æ¸¬ {timeframe} çš„å¸‚å ´è¶¨å‹¢ï¼š\n{data}\n\n" +
                          "è«‹æä¾›çµæ§‹åŒ–çš„é æ¸¬çµæœï¼ŒåŒ…æ‹¬ï¼š\n" +
                          "1. æ•´é«”å¸‚å ´è¶¨å‹¢\n" +
                          "2. é—œéµæŒ‡æ¨™é æ¸¬\n" +
                          "3. æ©Ÿæœƒèˆ‡å¨è„…\n" +
                          "4. ç­–ç•¥å»ºè­°\n" +
                          "5. é æ¸¬ä¿¡å¿ƒåº¦",
                          Map.of("data", marketData, "timeframe", timeframe))
                    .call()
                    .entity(MarketForecast.class);
            
            log.info("å¸‚å ´è¶¨å‹¢é æ¸¬å®Œæˆï¼Œæ•´é«”è¶¨å‹¢ï¼š{}ï¼Œä¿¡å¿ƒåº¦ï¼š{}", 
                    result.overallTrend(), result.confidenceLevel());
            
            return result;
            
        } catch (Exception e) {
            log.error("å¸‚å ´è¶¨å‹¢é æ¸¬å¤±æ•—", e);
            throw new RuntimeException("å¸‚å ´è¶¨å‹¢é æ¸¬å¤±æ•—ï¼š" + e.getMessage());
        }
    }
}
```

### ä¼æ¥­è³‡æ–™æ¨¡å‹

```java
package com.example.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import java.util.List;

/**
 * éŠ·å”®åˆ†æçµæœ
 */
public record SalesAnalysisResult(
        @JsonProperty("trend") String trend,
        @JsonProperty("total_revenue") double totalRevenue,
        @JsonProperty("growth_rate") double growthRate,
        @JsonProperty("top_products") List<String> topProducts,
        @JsonProperty("opportunities") List<String> opportunities,
        @JsonProperty("recommendations") List<String> recommendations,
        @JsonProperty("risk_factors") List<String> riskFactors
) {}

/**
 * å®¢æˆ¶æ´å¯Ÿ
 */
public record CustomerInsights(
        @JsonProperty("segments") List<CustomerSegment> segments,
        @JsonProperty("behavior_patterns") List<String> behaviorPatterns,
        @JsonProperty("preferences") List<String> preferences,
        @JsonProperty("churn_risk") ChurnRisk churnRisk,
        @JsonProperty("personalization_suggestions") List<String> personalizationSuggestions
) {}

public record CustomerSegment(
        @JsonProperty("name") String name,
        @JsonProperty("size") int size,
        @JsonProperty("characteristics") List<String> characteristics,
        @JsonProperty("value") String value
) {}

public record ChurnRisk(
        @JsonProperty("high_risk_count") int highRiskCount,
        @JsonProperty("medium_risk_count") int mediumRiskCount,
        @JsonProperty("low_risk_count") int lowRiskCount,
        @JsonProperty("key_indicators") List<String> keyIndicators
) {}

/**
 * å¸‚å ´é æ¸¬
 */
public record MarketForecast(
        @JsonProperty("overall_trend") String overallTrend,
        @JsonProperty("key_metrics") List<MetricForecast> keyMetrics,
        @JsonProperty("opportunities") List<String> opportunities,
        @JsonProperty("threats") List<String> threats,
        @JsonProperty("strategic_recommendations") List<String> strategicRecommendations,
        @JsonProperty("confidence_level") double confidenceLevel,
        @JsonProperty("timeframe") String timeframe
) {}

public record MetricForecast(
        @JsonProperty("metric_name") String metricName,
        @JsonProperty("current_value") double currentValue,
        @JsonProperty("predicted_value") double predictedValue,
        @JsonProperty("change_percentage") double changePercentage,
        @JsonProperty("confidence") double confidence
) {}
```

---

## 5.10.6 æœ€ä½³å¯¦è¸å’Œå„ªåŒ–

### è½‰æ›å™¨é¸æ“‡æŒ‡å—

```java
package com.example.service;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

@Service
@Slf4j
public class ConverterSelectionGuide {
    
    /**
     * æ ¹æ“šä½¿ç”¨å ´æ™¯é¸æ“‡æœ€é©åˆçš„è½‰æ›å™¨
     */
    public String getRecommendedApproach(String useCase) {
        return switch (useCase.toLowerCase()) {
            case "simple_entity" -> 
                "æ¨è–¦ä½¿ç”¨ ChatClient.entity() æ–¹æ³• - æœ€ç°¡æ½”ä¸”é¡å‹å®‰å…¨";
            
            case "complex_validation" -> 
                "æ¨è–¦ä½¿ç”¨ BeanOutputConverter - å¯ä»¥æ·»åŠ è‡ªå®šç¾©é©—è­‰é‚è¼¯";
            
            case "dynamic_structure" -> 
                "æ¨è–¦ä½¿ç”¨ MapOutputConverter - é©åˆæœªçŸ¥æˆ–å‹•æ…‹çš„è³‡æ–™çµæ§‹";
            
            case "simple_list" -> 
                "æ¨è–¦ä½¿ç”¨ ListOutputConverter - è™•ç†ç°¡å–®çš„åˆ—è¡¨è³‡æ–™";
            
            case "enterprise_integration" -> 
                "æ¨è–¦ä½¿ç”¨ ChatClient.entity() + è‡ªå®šç¾© Jackson é…ç½®";
            
            default -> 
                "å»ºè­°å…ˆä½¿ç”¨ ChatClient.entity() æ–¹æ³•ï¼Œå¦‚éœ€æ›´å¤šæ§åˆ¶å†è€ƒæ…®å‚³çµ±è½‰æ›å™¨";
        };
    }
}
```

### æ•ˆèƒ½å„ªåŒ–ç­–ç•¥

```java
package com.example.config;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.PropertyNamingStrategies;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class StructuredOutputConfig {
    
    /**
     * è‡ªå®šç¾© ObjectMapper ç”¨æ–¼çµæ§‹åŒ–è¼¸å‡º
     */
    @Bean("structuredOutputMapper")
    public ObjectMapper structuredOutputMapper() {
        return new ObjectMapper()
                .setPropertyNamingStrategy(PropertyNamingStrategies.SNAKE_CASE)
                .findAndRegisterModules();
    }
    
    /**
     * æä¾›è½‰æ›å™¨æœ€ä½³å¯¦è¸å»ºè­°
     */
    public static class BestPractices {
        
        public static final String[] RECOMMENDATIONS = {
            "1. å„ªå…ˆä½¿ç”¨ entity() æ–¹æ³•ï¼šå°æ–¼å¤§å¤šæ•¸çµæ§‹åŒ–è¼¸å‡ºéœ€æ±‚ï¼Œæ–°çš„ entity() æ–¹æ³•æ›´ç°¡æ½”",
            "2. è¤‡é›œå ´æ™¯ä½¿ç”¨è½‰æ›å™¨ï¼šéœ€è¦è‡ªå®šç¾©æ ¼å¼æˆ–ç‰¹æ®Šè™•ç†æ™‚ï¼Œä½¿ç”¨å‚³çµ±è½‰æ›å™¨",
            "3. åˆç†è¨­è¨ˆè³‡æ–™æ¨¡å‹ï¼šä½¿ç”¨ record é¡å‹æé«˜æ•ˆèƒ½å’Œå¯è®€æ€§",
            "4. æ·»åŠ é©ç•¶çš„ JSON è¨»è§£ï¼šç¢ºä¿åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ­£ç¢ºæ€§",
            "5. å¯¦ç¾éŒ¯èª¤è™•ç†ï¼šå°è½‰æ›å¤±æ•—çš„æƒ…æ³æä¾›å„ªé›…çš„é™ç´šè™•ç†",
            "6. ä½¿ç”¨å¿«å–æ©Ÿåˆ¶ï¼šå°æ–¼é‡è¤‡çš„è½‰æ›æ“ä½œè€ƒæ…®æ·»åŠ å¿«å–",
            "7. ç›£æ§è½‰æ›æ•ˆèƒ½ï¼šè¿½è¹¤è½‰æ›æ™‚é–“å’ŒæˆåŠŸç‡",
            "8. é©—è­‰è¼¸å‡ºæ ¼å¼ï¼šç¢ºä¿ AI è¼¸å‡ºç¬¦åˆé æœŸçš„è³‡æ–™çµæ§‹"
        };
    }
}
```

---

## ğŸ“ æœ¬ç« é‡é»å›é¡§

1. **çµæ§‹åŒ–è¼¸å‡ºç†è§£**ï¼šæŒæ¡äº† AI çµæ§‹åŒ–è³‡æ–™è¼¸å‡ºçš„é‡è¦æ€§å’ŒæŠ€è¡“å¯¦ç¾
2. **ç¾ä»£åŒ– API ä½¿ç”¨**ï¼šå­¸æœƒäº†ä½¿ç”¨ ChatClient çš„ entity() æ–¹æ³•é€²è¡Œé¡å‹è½‰æ›
3. **å‚³çµ±è½‰æ›å™¨æŒæ¡**ï¼šäº†è§£äº†ä¸‰ç¨®è½‰æ›å™¨çš„ç‰¹é»å’Œé©ç”¨å ´æ™¯
4. **ä¼æ¥­ç´šæ‡‰ç”¨è¨­è¨ˆ**ï¼šå¯¦ç¾äº†å®Œæ•´çš„çµæ§‹åŒ–è³‡æ–™è™•ç†ç³»çµ±
5. **æœ€ä½³å¯¦è¸æ‡‰ç”¨**ï¼šæŒæ¡äº†è½‰æ›å™¨é¸æ“‡å’Œæ•ˆèƒ½å„ªåŒ–ç­–ç•¥

### æŠ€è¡“è¦é»ç¸½çµ

| æŠ€è¡“é» | é‡è¦æ€§ | å¯¦ç¾é›£åº¦ | ä½¿ç”¨å ´æ™¯ |
|--------|--------|----------|----------|
| **ChatClient entity()** | â­â­â­ | ä½ | ç¾ä»£åŒ–æ‡‰ç”¨é–‹ç™¼ |
| **BeanOutputConverter** | â­â­â­ | ä¸­ | è¤‡é›œè³‡æ–™çµæ§‹ |
| **MapOutputConverter** | â­â­ | ä½ | å‹•æ…‹è³‡æ–™è™•ç† |
| **ListOutputConverter** | â­â­ | ä½ | ç°¡å–®åˆ—è¡¨è³‡æ–™ |
| **è³‡æ–™æ¨¡å‹è¨­è¨ˆ** | â­â­ | ä¸­ | ä¼æ¥­ç´šæ‡‰ç”¨ |
| **éŒ¯èª¤è™•ç†** | â­â­ | ä¸­ | ç”Ÿç”¢ç’°å¢ƒç©©å®šæ€§ |

### é¸æ“‡å»ºè­°

**1. æ–°å°ˆæ¡ˆæ¨è–¦**
- âœ… **å„ªå…ˆé¸æ“‡**ï¼šChatClient entity() æ–¹æ³•
- ğŸ¯ **ç†ç”±**ï¼šç°¡æ½”ã€é¡å‹å®‰å…¨ã€æ˜“æ–¼ç¶­è­·
- ğŸ“‹ **é©ç”¨**ï¼š90% çš„çµæ§‹åŒ–è¼¸å‡ºéœ€æ±‚

**2. ç‰¹æ®Šéœ€æ±‚å ´æ™¯**
- ğŸ”§ **BeanOutputConverter**ï¼šéœ€è¦è‡ªå®šç¾©æ ¼å¼æè¿°æˆ–é©—è­‰é‚è¼¯
- ğŸ—ºï¸ **MapOutputConverter**ï¼šè™•ç†æœªçŸ¥æˆ–å‹•æ…‹çš„è³‡æ–™çµæ§‹
- ğŸ“ **ListOutputConverter**ï¼šç°¡å–®çš„å­—ä¸²åˆ—è¡¨è™•ç†

**3. ä¼æ¥­ç´šæ‡‰ç”¨å»ºè­°**
- ğŸ¢ **æ··åˆä½¿ç”¨**ï¼šæ ¹æ“šå…·é«”å ´æ™¯é¸æ“‡æœ€é©åˆçš„æ–¹æ³•
- ğŸ“Š **ç›£æ§æ©Ÿåˆ¶**ï¼šè¿½è¹¤è½‰æ›æˆåŠŸç‡å’Œæ•ˆèƒ½æŒ‡æ¨™
- ğŸ›¡ï¸ **éŒ¯èª¤è™•ç†**ï¼šå¯¦ç¾å®Œå–„çš„ç•°å¸¸è™•ç†å’Œé™ç´šæ©Ÿåˆ¶
- ğŸ”„ **ç‰ˆæœ¬ç®¡ç†**ï¼šè€ƒæ…®è³‡æ–™æ¨¡å‹çš„ç‰ˆæœ¬ç›¸å®¹æ€§

### ä¼æ¥­æ‡‰ç”¨åƒ¹å€¼

**1. ç³»çµ±æ•´åˆæ•ˆç›Š**
- ğŸ”— **API æ¨™æº–åŒ–**ï¼šæä¾›ä¸€è‡´çš„è³‡æ–™ä»‹é¢æ ¼å¼
- ğŸ“Š **è³‡æ–™è™•ç†è‡ªå‹•åŒ–**ï¼šæ¸›å°‘äººå·¥è³‡æ–™è™•ç†å·¥ä½œ
- ğŸ¯ **é¡å‹å®‰å…¨ä¿è­‰**ï¼šç·¨è­¯æ™‚æœŸç™¼ç¾è³‡æ–™çµæ§‹å•é¡Œ
- ğŸš€ **é–‹ç™¼æ•ˆç‡æå‡**ï¼šç°¡åŒ– AI è¼¸å‡ºçš„è™•ç†é‚è¼¯

**2. æ¥­å‹™åƒ¹å€¼å‰µé€ **
- ğŸ’¼ **æ±ºç­–æ”¯æ´**ï¼šçµæ§‹åŒ–çš„åˆ†æçµæœæ”¯æ´å•†æ¥­æ±ºç­–
- ğŸ“ˆ **æ´å¯Ÿç”Ÿæˆ**ï¼šè‡ªå‹•åŒ–çš„è³‡æ–™æ´å¯Ÿå’Œè¶¨å‹¢åˆ†æ
- ğŸ¨ **å€‹æ€§åŒ–æœå‹™**ï¼šåŸºæ–¼çµæ§‹åŒ–è³‡æ–™çš„å€‹æ€§åŒ–æ¨è–¦
- ğŸ” **æ™ºèƒ½åˆ†æ**ï¼šæ·±åº¦çš„æ¥­å‹™è³‡æ–™åˆ†æå’Œé æ¸¬

### ä¸‹ä¸€æ­¥å­¸ç¿’æ–¹å‘

æ­å–œæ‚¨å®Œæˆäº†ç¬¬äº”ç« ã€Œå€‹æ€§åŒ– ChatBotã€çš„å®Œæ•´å­¸ç¿’ï¼æ¥ä¸‹ä¾†æˆ‘å€‘å°‡é€²å…¥ç¬¬å…­ç« ï¼Œå­¸ç¿’å¦‚ä½•è®“ ChatBot æ“æœ‰è¨˜æ†¶èƒ½åŠ›ï¼Œå»ºç«‹çœŸæ­£æ™ºèƒ½çš„å°è©±ç³»çµ±ã€‚

---

**åƒè€ƒè³‡æ–™ï¼š**
- [Spring AI Structured Output Documentation](https://docs.spring.io/spring-ai/reference/api/structured-output-converter.html)
- [ChatClient Entity Method Guide](https://docs.spring.io/spring-ai/reference/api/chatclient.html)
- [Jackson JSON Processing](https://github.com/FasterXML/jackson)
- [OpenAI Structured Outputs](https://platform.openai.com/docs/guides/structured-outputs)