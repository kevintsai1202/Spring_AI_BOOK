# 1.3 核心註解與依賴注入

> **本章重點**：掌握 Spring Boot 核心註解體系和依賴注入機制，為 Spring AI 應用開發建立堅實的技術基礎。

## 🎯 學習目標

完成本章學習後，您將能夠：

- 🎯 **掌握核心註解**：熟練使用 @SpringBootApplication、@RestController、@Service 等基礎註解
- 🎯 **理解依賴注入**：掌握 @Autowired 和構造函數注入的使用方法
- 🎯 **實現組件管理**：使用 Spring 容器管理應用程式組件
- 🎯 **建立分層架構**：運用註解建立清晰的分層架構
- 🎯 **為 AI 服務做準備**：掌握 AI 應用開發所需的核心註解技能

---

## 1.3.1 Spring Boot 註解體系概覽

### 註解分類

Spring Boot 的註解可以分為以下幾個核心類別：

| 類別 | 用途 | 核心註解 | AI 應用重要性 |
|------|------|----------|---------------|
| **啟動註解** | 應用程式啟動 | `@SpringBootApplication` | ⭐⭐⭐ |
| **組件註解** | 定義和管理 Bean | `@Component`、`@Service`、`@RestController` | ⭐⭐⭐ |
| **依賴注入** | 處理依賴關係 | `@Autowired` | ⭐⭐⭐ |
| **Web 註解** | API 開發 | `@RequestMapping`、`@GetMapping`、`@PostMapping` | ⭐⭐⭐ |
| **配置註解** | 配置管理 | `@Value`、`@ConfigurationProperties` | ⭐⭐ |

---

## 1.3.2 核心啟動註解

### @SpringBootApplication

這是 Spring Boot 最重要的註解，它是一個**組合註解**：

```java
@SpringBootApplication
public class DemoApplication {
    public static void main(String[] args) {
        SpringApplication.run(DemoApplication.class, args);
    }
}
```

**@SpringBootApplication 等同於**：
```java
@SpringBootConfiguration  // 等同於 @Configuration
@EnableAutoConfiguration  // 啟用自動配置
@ComponentScan           // 啟用組件掃描
public class DemoApplication {
    // ...
}
```

**核心功能**：
- **自動配置**：根據 classpath 自動配置 Spring 應用
- **組件掃描**：自動掃描並註冊 Spring 組件
- **配置類別**：將主類別標記為配置類別

---

## 1.3.3 組件註解

### @Component 系列註解

**基礎組件註解**：
```java
// 通用組件
@Component
public class DataProcessor {
    public String process(String data) {
        return "Processed: " + data;
    }
}
```

**專用組件註解**：

**1. @Service - 業務邏輯層**
```java
@Service
public class UserService {
    
    public List<User> getAllUsers() {
        // 業務邏輯實現
        return Arrays.asList(
            new User(1L, "Alice", "alice@example.com"),
            new User(2L, "Bob", "bob@example.com")
        );
    }
    
    public User createUser(String name, String email) {
        // 建立使用者的業務邏輯
        return new User(System.currentTimeMillis(), name, email);
    }
}
```

**2. @RestController - API 控制器**
```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    private final UserService userService;
    
    // 構造函數注入（推薦方式）
    public UserController(UserService userService) {
        this.userService = userService;
    }
    
    @GetMapping
    public List<User> getUsers() {
        return userService.getAllUsers();
    }
    
    @PostMapping
    public User createUser(@RequestBody CreateUserRequest request) {
        return userService.createUser(request.getName(), request.getEmail());
    }
}
```

**3. @Repository - 資料存取層**
```java
@Repository
public class UserRepository {
    
    private final List<User> users = new ArrayList<>();
    
    public List<User> findAll() {
        return new ArrayList<>(users);
    }
    
    public User save(User user) {
        users.add(user);
        return user;
    }
    
    public Optional<User> findById(Long id) {
        return users.stream()
                .filter(user -> user.getId().equals(id))
                .findFirst();
    }
}
```

---

## 1.3.4 依賴注入

### 為什麼需要依賴注入？

**沒有依賴注入的問題**：
```java
// ❌ 緊密耦合的程式碼
public class UserController {
    private UserService userService = new UserService(); // 硬編碼依賴
    
    // 難以測試、難以擴展
}
```

**使用依賴注入的優勢**：
```java
// ✅ 鬆散耦合的程式碼
@RestController
public class UserController {
    private final UserService userService;
    
    // Spring 自動注入依賴
    public UserController(UserService userService) {
        this.userService = userService;
    }
    
    // 易於測試、易於擴展
}
```

### 依賴注入方式

**1. 構造函數注入（推薦）**
```java
@RestController
public class UserController {
    
    private final UserService userService;
    private final EmailService emailService;
    
    // 構造函數注入 - 推薦方式
    public UserController(UserService userService, EmailService emailService) {
        this.userService = userService;
        this.emailService = emailService;
    }
}
```

**優勢**：
- 確保依賴不為 null
- 支援 final 欄位
- 便於單元測試
- 明確表達依賴關係

**2. @Autowired 欄位注入**
```java
@RestController
public class UserController {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private EmailService emailService;
    
    // 簡潔但不推薦用於生產環境
}
```

**3. Setter 注入**
```java
@RestController
public class UserController {
    
    private UserService userService;
    
    @Autowired
    public void setUserService(UserService userService) {
        this.userService = userService;
    }
}
```

---

## 1.3.5 Web 開發核心註解

### HTTP 方法註解

```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    private final UserService userService;
    
    public UserController(UserService userService) {
        this.userService = userService;
    }
    
    // GET 請求 - 獲取所有使用者
    @GetMapping
    public List<User> getAllUsers() {
        return userService.getAllUsers();
    }
    
    // GET 請求 - 根據 ID 獲取使用者
    @GetMapping("/{id}")
    public User getUserById(@PathVariable Long id) {
        return userService.findById(id);
    }
    
    // POST 請求 - 建立新使用者
    @PostMapping
    public User createUser(@RequestBody CreateUserRequest request) {
        return userService.createUser(request);
    }
    
    // PUT 請求 - 更新使用者
    @PutMapping("/{id}")
    public User updateUser(@PathVariable Long id, @RequestBody UpdateUserRequest request) {
        return userService.updateUser(id, request);
    }
    
    // DELETE 請求 - 刪除使用者
    @DeleteMapping("/{id}")
    public void deleteUser(@PathVariable Long id) {
        userService.deleteUser(id);
    }
}
```

### 參數綁定註解

```java
@RestController
@RequestMapping("/api/search")
public class SearchController {
    
    // 路徑變數
    @GetMapping("/users/{id}")
    public User getUser(@PathVariable Long id) {
        return userService.findById(id);
    }
    
    // 查詢參數
    @GetMapping("/users")
    public List<User> searchUsers(
            @RequestParam(required = false) String name,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size) {
        return userService.search(name, page, size);
    }
    
    // 請求體
    @PostMapping("/users")
    public User createUser(@RequestBody CreateUserRequest request) {
        return userService.createUser(request);
    }
    
    // 請求標頭
    @GetMapping("/profile")
    public User getCurrentUser(@RequestHeader("Authorization") String token) {
        return userService.findByToken(token);
    }
}
```

---

## 1.3.6 配置相關註解

### @Value - 屬性注入

```java
@Service
public class ConfigService {
    
    @Value("${app.name:Default App}")
    private String appName;
    
    @Value("${app.version:1.0.0}")
    private String appVersion;
    
    @Value("${app.max-users:100}")
    private int maxUsers;
    
    public String getAppInfo() {
        return String.format("%s v%s (Max Users: %d)", appName, appVersion, maxUsers);
    }
}
```

### @ConfigurationProperties - 類型安全配置

```java
@ConfigurationProperties(prefix = "app")
@Component
public class AppProperties {
    
    private String name = "Default App";
    private String version = "1.0.0";
    private int maxUsers = 100;
    private Database database = new Database();
    
    // Getters and Setters
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    
    public String getVersion() { return version; }
    public void setVersion(String version) { this.version = version; }
    
    public int getMaxUsers() { return maxUsers; }
    public void setMaxUsers(int maxUsers) { this.maxUsers = maxUsers; }
    
    public Database getDatabase() { return database; }
    public void setDatabase(Database database) { this.database = database; }
    
    public static class Database {
        private String url = "jdbc:h2:mem:testdb";
        private String username = "sa";
        private String password = "";
        
        // Getters and Setters
        public String getUrl() { return url; }
        public void setUrl(String url) { this.url = url; }
        
        public String getUsername() { return username; }
        public void setUsername(String username) { this.username = username; }
        
        public String getPassword() { return password; }
        public void setPassword(String password) { this.password = password; }
    }
}
```

**對應的 application.yml**：
```yaml
app:
  name: Spring Boot Demo
  version: 2.0.0
  max-users: 500
  database:
    url: jdbc:mysql://localhost:3306/demo
    username: demo_user
    password: demo_pass
```

---

## 1.3.7 為 Spring AI 做準備

### AI 服務的註解模式

```java
// AI 服務層
@Service
public class AIService {
    
    @Value("${ai.openai.api-key}")
    private String apiKey;
    
    @Value("${ai.openai.model:gpt-3.5-turbo}")
    private String model;
    
    public String chat(String message) {
        // 預留給 Spring AI 整合
        return "AI Response: " + message;
    }
}

// AI 控制器
@RestController
@RequestMapping("/api/ai")
public class AIController {
    
    private final AIService aiService;
    
    public AIController(AIService aiService) {
        this.aiService = aiService;
    }
    
    @PostMapping("/chat")
    public ResponseEntity<String> chat(@RequestBody ChatRequest request) {
        String response = aiService.chat(request.getMessage());
        return ResponseEntity.ok(response);
    }
}

// AI 配置類別
@ConfigurationProperties(prefix = "ai")
@Component
public class AIProperties {
    
    private OpenAI openai = new OpenAI();
    
    public OpenAI getOpenai() { return openai; }
    public void setOpenai(OpenAI openai) { this.openai = openai; }
    
    public static class OpenAI {
        private String apiKey;
        private String model = "gpt-3.5-turbo";
        private int maxTokens = 1000;
        private double temperature = 0.7;
        
        // Getters and Setters
    }
}
```

### 實用的註解組合

```java
// 完整的 AI 應用範例
@RestController
@RequestMapping("/api/ai")
public class AIApplicationController {
    
    private final AIService aiService;
    private final UserService userService;
    
    // 構造函數注入多個服務
    public AIApplicationController(AIService aiService, UserService userService) {
        this.aiService = aiService;
        this.userService = userService;
    }
    
    @PostMapping("/analyze")
    public ResponseEntity<AnalysisResult> analyzeUserData(
            @PathVariable Long userId,
            @RequestBody AnalysisRequest request,
            @RequestHeader("Authorization") String token) {
        
        // 驗證使用者
        User user = userService.findById(userId);
        
        // AI 分析
        AnalysisResult result = aiService.analyze(user, request);
        
        return ResponseEntity.ok(result);
    }
}
```

---

## 📝 本章重點回顧

1. **核心註解掌握**：學會了 @SpringBootApplication、@RestController、@Service 等基礎註解
2. **依賴注入理解**：掌握了構造函數注入和 @Autowired 的使用方法
3. **Web 開發註解**：熟悉了 HTTP 方法註解和參數綁定註解
4. **配置管理**：學會了使用 @Value 和 @ConfigurationProperties 管理配置
5. **AI 整合準備**：為 Spring AI 應用開發建立了註解使用基礎

### 下一步學習方向

在下一章中，我們將建立第一個完整的 Spring Boot 應用，實際運用這些註解來開發一個使用者管理系統。

---

**參考資料：**
- [Spring Boot Annotations](https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.auto-configuration)
- [Spring Framework Core](https://docs.spring.io/spring-framework/docs/current/reference/html/core.html)
- [Dependency Injection](https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-dependencies)