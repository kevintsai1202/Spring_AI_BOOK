# 6.2 è®“ AI è¨˜ä½å°è©±

> **æœ¬ç« é‡é»**ï¼šå¯¦éš›å‹•æ‰‹å¯¦ç¾ Spring AI çš„å°è©±è¨˜æ†¶åŠŸèƒ½ï¼Œå¾åŸºç¤çš„è¨˜æ†¶é«”å­˜å„²åˆ°ä¼æ¥­ç´šçš„æŒä¹…åŒ–è§£æ±ºæ–¹æ¡ˆï¼Œè®“ AI çœŸæ­£æ“æœ‰è¨˜æ†¶èƒ½åŠ›ã€‚

## ğŸ¯ å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬ç« å­¸ç¿’å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š

- ğŸ¯ **å¯¦ç¾åŸºæœ¬å°è©±è¨˜æ†¶**ï¼šä½¿ç”¨ InMemoryChatMemory å»ºç«‹ç°¡å–®çš„è¨˜æ†¶åŠŸèƒ½
- ğŸ¯ **æŒæ¡ Advisor ç³»çµ±**ï¼šç†è§£ Spring AI çš„å¢å¼·å™¨æ©Ÿåˆ¶å’Œæœ€æ–° API
- ğŸ¯ **é…ç½®è¨˜æ†¶ç®¡ç†**ï¼šå­¸æœƒé…ç½®ä¸åŒé¡å‹çš„è¨˜æ†¶å­˜å„²å¾Œç«¯
- ğŸ¯ **å¯¦ç¾æœƒè©±éš”é›¢**ï¼šç‚ºä¸åŒç”¨æˆ¶å»ºç«‹ç¨ç«‹çš„å°è©±è¨˜æ†¶
- ğŸ¯ **å„ªåŒ–è¨˜æ†¶æ•ˆèƒ½**ï¼šæŒæ¡è¨˜æ†¶å¤§å°æ§åˆ¶å’Œæ•ˆèƒ½å„ªåŒ–æŠ€å·§

---

## 6.2.1 å¾åœŸç‚®åˆ°ä¼æ¥­ç´šçš„é€²åŒ–

### AOP ç„¡æ‰€ä¸åœ¨

![AOPæ¦‚å¿µåœ–](https://ithelp.ithome.com.tw/upload/images/20240819/20161290PpCeC08JCZ.jpg)

Spring æ¡†æ¶æœ‰å…©å€‹å¾ˆé‡è¦çš„è§€å¿µï¼Œä¸€å€‹æ˜¯ IoCï¼Œå¦ä¸€å€‹å‰‡æ˜¯ AOPã€‚AOP çš„åŸºæœ¬æ¦‚å¿µå°±æ˜¯å¯ä»¥æ””æˆªæŒ‡å®šçš„æ–¹æ³•ä¸¦ä¸”å¢å¼·æ–¹æ³•çš„åŠŸèƒ½ï¼Œä¸”ç„¡éœ€ä¿®æ”¹åˆ°ä¸»è¦çš„æ¥­å‹™ä»£ç¢¼ï¼Œä½¿æ¥­å‹™èˆ‡éæ¥­å‹™è™•ç†é‚è¼¯åˆ†é›¢ã€‚

**AOP åœ¨æ—¥å¸¸é–‹ç™¼ä¸­çš„æ‡‰ç”¨**ï¼š
- ğŸ”„ **@Transactional**ï¼šè‡ªå‹•è™•ç†è³‡æ–™åº«äº¤æ˜“çš„é–‹å•Ÿã€æäº¤å’Œå›æ»¾
- ğŸ“ **@Cacheable**ï¼šè‡ªå‹•è™•ç†å¿«å–çš„å­˜å–å’Œæ›´æ–°
- ğŸ”’ **@PreAuthorize**ï¼šè‡ªå‹•é€²è¡Œæ¬Šé™æª¢æŸ¥
- ğŸ“Š **@Timed**ï¼šè‡ªå‹•è¨˜éŒ„æ–¹æ³•åŸ·è¡Œæ™‚é–“

### Spring AI çš„ Advisor ç³»çµ±

Spring AI å°‡ AOP çš„æ¦‚å¿µæ‡‰ç”¨åˆ° AI å°è©±è™•ç†ä¸­ï¼Œæä¾›äº† **Advisorï¼ˆå¢å¼·å™¨ï¼‰** ç³»çµ±ã€‚Advisor å¯ä»¥åœ¨ AI è«‹æ±‚çš„å‰å¾Œé€²è¡Œæ””æˆªå’Œå¢å¼·ï¼Œå¯¦ç¾è¨˜æ†¶ç®¡ç†ã€å…§å®¹éæ¿¾ã€æ—¥èªŒè¨˜éŒ„ç­‰åŠŸèƒ½ã€‚

---

## 6.2.2 Spring AI Advisor API çš„é‡å¤§æ›´æ–°

### API æ¼”é€²æ­·ç¨‹

**é‡è¦æ›´æ–°èªªæ˜**ï¼šSpring AI 1.0 GA ç‰ˆæœ¬å° Advisor API é€²è¡Œäº†é‡å¤§é‡æ§‹ï¼Œæä¾›äº†æ›´æ¸…æ™°å’Œå¼·å¤§çš„ä»‹é¢ã€‚

#### èˆŠç‰ˆ APIï¼ˆå·²å»¢æ£„ï¼‰
```java
// âŒ å·²åœ¨ 1.0.0-M3 æ¨™è¨˜ç‚º deprecatedï¼Œ1.0.0-RC1 å®Œå…¨ç§»é™¤
RequestResponseAdvisor advisor = new MessageChatMemoryAdvisor(chatMemory, chatId, 30);
```

#### æ–°ç‰ˆ APIï¼ˆç•¶å‰ä½¿ç”¨ï¼‰
```java
// âœ… ä½¿ç”¨æœ€æ–°çš„ Builder æ¨¡å¼å’Œæ¸…æ™°çš„ä»‹é¢
ChatMemory chatMemory = MessageWindowChatMemory.builder().build();

ChatClient chatClient = ChatClient.builder(chatModel)
    .defaultAdvisors(MessageChatMemoryAdvisor.builder(chatMemory).build())
    .build();

// åœ¨èª¿ç”¨æ™‚æŒ‡å®šå°è©± ID
String conversationId = "007";
String response = chatClient.prompt()
    .advisors(advisor -> advisor.param(ChatMemory.CONVERSATION_ID, conversationId))
    .user(userText)
    .call()
    .content();
```

### æ–°ç‰ˆ API çš„æ ¸å¿ƒä»‹é¢

**1. CallAdvisor - éä¸²æµå ´æ™¯**
```java
public interface CallAdvisor {
    String getName();
    int getOrder();
    
    ChatClientRequest adviseRequest(ChatClientRequest request, Map<String, Object> context);
    ChatClientResponse adviseResponse(ChatClientResponse response, Map<String, Object> context);
}
```

**2. StreamAdvisor - ä¸²æµå ´æ™¯**
```java
public interface StreamAdvisor {
    String getName();
    int getOrder();
    
    ChatClientRequest adviseRequest(ChatClientRequest request, Map<String, Object> context);
    Flux<ChatClientResponse> adviseResponse(Flux<ChatClientResponse> response, Map<String, Object> context);
}
```

### API æ›´æ–°çš„å„ªå‹¢

| ç‰¹æ€§ | èˆŠç‰ˆ API | æ–°ç‰ˆ API |
|------|----------|----------|
| **é¡å‹å®‰å…¨** | è¼ƒå¼± | å¼·é¡å‹æª¢æŸ¥ |
| **å»ºæ§‹æ–¹å¼** | æ§‹é€ å‡½æ•¸ | Builder æ¨¡å¼ |
| **å¯è®€æ€§** | ä¸€èˆ¬ | é«˜å¯è®€æ€§ |
| **æ“´å±•æ€§** | æœ‰é™ | é«˜åº¦å¯æ“´å±• |
| **ç¶­è­·æ€§** | å›°é›£ | å®¹æ˜“ç¶­è­· |

---

## 6.2.3 Spring AI å…§å»ºçš„ Advisor é¡åˆ¥

### è¨˜æ†¶ç®¡ç† Advisor

![Advisoré¡åˆ¥åœ–](https://ithelp.ithome.com.tw/upload/images/20240819/201612900g7q0iHGAj.png)

Spring AI æä¾›äº†ä¸‰ç¨®ä¸»è¦çš„è¨˜æ†¶ç®¡ç† Advisorï¼š

**1. MessageChatMemoryAdvisor**
```java
ç‰¹é»ï¼š
- å°‡å°è©±æ­·å²ä½œç‚º Message é›†åˆåŠ å…¥åˆ° Prompt ä¸­
- ä¿æŒå®Œæ•´çš„å°è©±çµæ§‹å’Œä¸Šä¸‹æ–‡
- é©åˆéœ€è¦ç²¾ç¢ºå°è©±é †åºçš„å ´æ™¯

ä½¿ç”¨å ´æ™¯ï¼š
- å®¢æˆ¶æœå‹™å°è©±
- ä»»å‹™å°å‘çš„å¤šè¼ªå°è©±
- éœ€è¦åš´æ ¼ä¸Šä¸‹æ–‡çš„æ¥­å‹™æµç¨‹

**1. MessageChatMemoryAdvisor - åŸºæœ¬è¨˜æ†¶ç®¡ç†**
```java
// å»ºç«‹è¨˜æ†¶å­˜å„²
ChatMemory chatMemory = MessageWindowChatMemory.builder()
    .maxMessages(10)  // ä¿ç•™æœ€è¿‘ 10 æ¢è¨Šæ¯
    .build();

// é…ç½® ChatClient
ChatClient chatClient = ChatClient.builder(chatModel)
    .defaultAdvisors(MessageChatMemoryAdvisor.builder(chatMemory).build())
    .build();

// ä½¿ç”¨æ™‚æŒ‡å®šå°è©± ID
String conversationId = "user-123";
String response = chatClient.prompt()
    .advisors(a -> a.param(ChatMemory.CONVERSATION_ID, conversationId))
    .user("ä½ å¥½ï¼Œæˆ‘æ˜¯æ–°ç”¨æˆ¶")
    .call()
    .content();
```

**2. PromptChatMemoryAdvisor**
```java
ç‰¹é»ï¼š
- å°‡å°è©±æ­·å²è½‰æ›ç‚ºç´”æ–‡å­—é™„åŠ åˆ°ç³»çµ±æç¤ºä¸­
- æ›´ç¯€çœ Token ä½¿ç”¨é‡
- é©åˆç°¡å–®çš„ä¸Šä¸‹æ–‡è¨˜æ†¶

ä½¿ç”¨å ´æ™¯ï¼š
- ç°¡å–®çš„å•ç­”ç³»çµ±
- æˆæœ¬æ•æ„Ÿçš„æ‡‰ç”¨
- ä¸éœ€è¦è¤‡é›œå°è©±çµæ§‹çš„å ´æ™¯
```

**3. VectorStoreChatMemoryAdvisor**
```java
ç‰¹é»ï¼š
- ä½¿ç”¨å‘é‡è³‡æ–™åº«å­˜å„²å°è©±è¨˜æ†¶
- æ”¯æ´èªç¾©ç›¸ä¼¼æ€§æœå°‹
- å¯è™•ç†å¤§é‡æ­·å²å°è©±è³‡æ–™

ä½¿ç”¨å ´æ™¯ï¼š
- é•·æœŸå°è©±æ­·å²ç®¡ç†
- å¤§è¦æ¨¡ç”¨æˆ¶ç³»çµ±
- éœ€è¦èªç¾©æœå°‹çš„æ™ºèƒ½åŠ©æ‰‹
```

### Advisor æ¯”è¼ƒè¡¨

| Advisor é¡å‹ | å­˜å„²æ–¹å¼ | Token æ¶ˆè€— | æª¢ç´¢èƒ½åŠ› | é©ç”¨è¦æ¨¡ |
|--------------|----------|------------|----------|----------|
| **MessageChatMemoryAdvisor** | çµæ§‹åŒ–è¨Šæ¯ | é«˜ | é †åºæª¢ç´¢ | ä¸­å°å‹ |
| **PromptChatMemoryAdvisor** | ç´”æ–‡å­— | ä¸­ | æ–‡å­—åŒ¹é… | å°å‹ |
| **VectorStoreChatMemoryAdvisor** | å‘é‡åŒ– | ä½ | èªç¾©æœå°‹ | å¤§å‹ |

---

## 6.2.4 å¯¦ç¾åŸºæœ¬å°è©±è¨˜æ†¶

### ç¬¬ä¸€æ­¥ï¼šå»ºç«‹ç°¡å–®çš„è¨˜æ†¶æœå‹™

```java
import lombok.RequiredArgsConstructor;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.memory.ChatMemory;
import org.springframework.ai.chat.memory.InMemoryChatMemoryRepository;
import org.springframework.ai.chat.memory.MessageWindowChatMemory;
import org.springframework.ai.chat.memory.advisor.MessageChatMemoryAdvisor;
import org.springframework.ai.chat.messages.Message;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
@RequiredArgsConstructor
public class BasicChatMemoryService {
    
    private final ChatClient chatClient;
    private final ChatMemory chatMemory = MessageWindowChatMemory.builder()
            .chatMemoryRepository(new InMemoryChatMemoryRepository())
            .build();
    
    /**
     * åŸºæœ¬å°è©±è¨˜æ†¶å¯¦ç¾
     */
    public String chat(String conversationId, String userMessage) {
        return chatClient.prompt()
            .advisors(advisor -> advisor.param(ChatMemory.CONVERSATION_ID, conversationId))
            .user(userMessage)
            .call()
            .content();
    }
    
    /**
     * ç²å–å°è©±æ­·å²
     */
    public List<Message> getConversationHistory(String conversationId) {
        return chatMemory.get(conversationId);
    }
    
    /**
     * æ¸…é™¤å°è©±è¨˜æ†¶
     */
    public void clearConversation(String conversationId) {
        chatMemory.clear(conversationId);
    }
}
```

### ç¬¬äºŒæ­¥ï¼šå»ºç«‹ REST API æ§åˆ¶å™¨

```java
import lombok.RequiredArgsConstructor;
import org.springframework.ai.chat.messages.Message;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.List;

@RestController
@RequestMapping("/api/chat")
@RequiredArgsConstructor
public class ChatMemoryController {
    
    private final BasicChatMemoryService chatService;
    
    /**
     * å°è©± API
     */
    @PostMapping("/conversation/{conversationId}")
    public ResponseEntity<ChatResponse> chat(
            @PathVariable String conversationId,
            @RequestBody ChatRequest request) {
        
        String response = chatService.chat(conversationId, request.getMessage());
        
        return ResponseEntity.ok(ChatResponse.builder()
            .conversationId(conversationId)
            .message(response)
            .timestamp(LocalDateTime.now())
            .build());
    }
    
    /**
     * ç²å–å°è©±æ­·å²
     */
    @GetMapping("/conversation/{conversationId}/history")
    public ResponseEntity<ConversationHistory> getHistory(
            @PathVariable String conversationId,
            @RequestParam(defaultValue = "50") int limit) {
        
        List<Message> messages = chatService.getConversationHistory(conversationId);
        
        // é™åˆ¶è¿”å›çš„è¨Šæ¯æ•¸é‡
        if (messages.size() > limit) {
            messages = messages.subList(messages.size() - limit, messages.size());
        }
        
        return ResponseEntity.ok(ConversationHistory.builder()
            .conversationId(conversationId)
            .messages(messages)
            .totalCount(messages.size())
            .build());
    }
    
    /**
     * æ¸…é™¤å°è©±
     */
    @DeleteMapping("/conversation/{conversationId}")
    public ResponseEntity<Void> clearConversation(@PathVariable String conversationId) {
        chatService.clearConversation(conversationId);
        return ResponseEntity.ok().build();
    }
}
```

### ç¬¬ä¸‰æ­¥ï¼šå®šç¾©è³‡æ–™å‚³è¼¸ç‰©ä»¶

```java
import lombok.Builder;
import lombok.Data;
import org.springframework.ai.chat.messages.Message;

import javax.validation.constraints.NotBlank;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;

/**
 * èŠå¤©è«‹æ±‚ DTO
 */
@Data
@Builder
public class ChatRequest {
    @NotBlank(message = "è¨Šæ¯ä¸èƒ½ç‚ºç©º")
    private String message;
    
    private Map<String, Object> metadata;
}

/**
 * èŠå¤©å›æ‡‰ DTO
 */
@Data
@Builder
public class ChatResponse {
    private String conversationId;
    private String message;
    private LocalDateTime timestamp;
    private Map<String, Object> metadata;
}

/**
 * å°è©±æ­·å² DTO
 */
@Data
@Builder
public class ConversationHistory {
    private String conversationId;
    private List<Message> messages;
    private int totalCount;
    private LocalDateTime lastUpdated;
}
```

---

## 6.2.5 ä¼æ¥­ç´šè¨˜æ†¶é…ç½®

### é…ç½®ä¸åŒçš„å­˜å„²å¾Œç«¯

```java
import org.springframework.ai.chat.memory.ChatMemory;
import org.springframework.ai.chat.memory.InMemoryChatMemoryRepository;
import org.springframework.ai.chat.memory.JdbcChatMemoryRepository;
import org.springframework.ai.chat.memory.MessageWindowChatMemory;
import org.springframework.ai.chat.memory.RedisChatMemoryRepository;
import org.springframework.ai.chat.memory.Neo4jChatMemoryRepository;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.neo4j.core.Neo4jTemplate;

import javax.sql.DataSource;

@Configuration
@EnableConfigurationProperties(ChatMemoryProperties.class)
public class ChatMemoryConfig {
    
    /**
     * è¨˜æ†¶é«”å­˜å„²ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰
     */
    @Bean
    @ConditionalOnProperty(name = "app.chat.memory.type", havingValue = "memory")
    public ChatMemory inMemoryChatMemory() {
        return MessageWindowChatMemory.builder()
            .chatMemoryRepository(new InMemoryChatMemoryRepository())
            .build();
    }
    
    /**
     * JDBC å­˜å„²ï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰
     */
    @Bean
    @ConditionalOnProperty(name = "app.chat.memory.type", havingValue = "jdbc")
    public ChatMemory jdbcChatMemory(DataSource dataSource) {
        return MessageWindowChatMemory.builder()
            .maxMessages(200)
            .chatMemoryRepository(new JdbcChatMemoryRepository(dataSource))
            .build();
    }
    
    /**
     * Redis å­˜å„²ï¼ˆé«˜æ•ˆèƒ½ç’°å¢ƒï¼‰
     */
    @Bean
    @ConditionalOnProperty(name = "app.chat.memory.type", havingValue = "redis")
    public ChatMemory redisChatMemory(RedisTemplate<String, Object> redisTemplate) {
        return MessageWindowChatMemory.builder()
            .maxMessages(500)
            .chatMemoryRepository(new RedisChatMemoryRepository(redisTemplate))
            .build();
    }
    
    /**
     * Neo4j å­˜å„²ï¼ˆåœ–å½¢è³‡æ–™åº«ï¼‰
     */
    @Bean
    @ConditionalOnProperty(name = "app.chat.memory.type", havingValue = "neo4j")
    public ChatMemory neo4jChatMemory(Neo4jTemplate neo4jTemplate) {
        return MessageWindowChatMemory.builder()
            .maxMessages(1000)
            .chatMemoryRepository(new Neo4jChatMemoryRepository(neo4jTemplate))
            .build();
    }
}
```

### è¨˜æ†¶é…ç½®å±¬æ€§

```java
import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;

@ConfigurationProperties(prefix = "app.chat.memory")
@Data
public class ChatMemoryProperties {
    
    /**
     * è¨˜æ†¶å­˜å„²é¡å‹
     */
    private String type = "memory";
    
    /**
     * æœ€å¤§è¨Šæ¯æ•¸é‡
     */
    private int maxMessages = 100;
    
    /**
     * è¨˜æ†¶éæœŸæ™‚é–“ï¼ˆå°æ™‚ï¼‰
     */
    private int expirationHours = 24;
    
    /**
     * æ˜¯å¦å•Ÿç”¨è¨˜æ†¶å£“ç¸®
     */
    private boolean compressionEnabled = false;
    
    /**
     * å£“ç¸®é–¾å€¼
     */
    private int compressionThreshold = 200;
}
```

### æ‡‰ç”¨ç¨‹å¼é…ç½®

```yaml
# application.yml
app:
  chat:
    memory:
      type: jdbc  # memory, jdbc, redis, neo4j
      max-messages: 200
      expiration-hours: 48
      compression-enabled: true
      compression-threshold: 300

# é–‹ç™¼ç’°å¢ƒ
---
spring:
  config:
    activate:
      on-profile: dev
app:
  chat:
    memory:
      type: memory
      max-messages: 50

# ç”Ÿç”¢ç’°å¢ƒ
---
spring:
  config:
    activate:
      on-profile: prod
app:
  chat:
    memory:
      type: redis
      max-messages: 500
      expiration-hours: 72
```

---

## 6.2.6 é€²éšè¨˜æ†¶ç®¡ç†

### å»ºè­°çš„æœ€ä½³å¯¦è¸å¯«æ³•

æ¨è–¦åœ¨ ChatClient å»ºæ§‹æ™‚å°±é è¨­ Advisorï¼Œé€™æ¨£å¯ä»¥ç²å¾—æ›´å¥½çš„æ•ˆèƒ½ï¼š

```java
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.memory.ChatMemory;
import org.springframework.ai.chat.memory.advisor.MessageChatMemoryAdvisor;
import org.springframework.ai.chat.model.ChatModel;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class ChatClientConfig {
    
    @Bean
    public ChatClient chatClient(ChatModel chatModel, ChatMemory chatMemory) {
        return ChatClient.builder(chatModel)
            .defaultAdvisors(
                MessageChatMemoryAdvisor.builder(chatMemory).build()
            )
            .build();
    }
    
    @Bean
    public ChatClient streamingChatClient(ChatModel chatModel, ChatMemory chatMemory) {
        return ChatClient.builder(chatModel)
            .defaultAdvisors(
                // ä¸²æµå ´æ™¯ä½¿ç”¨ä¸åŒçš„é…ç½®
                MessageChatMemoryAdvisor.builder(chatMemory)
                    .lastN(20)  // ä¸²æµæ™‚ä½¿ç”¨è¼ƒå°‘çš„æ­·å²è¨Šæ¯
                    .build()
            )
            .build();
    }
}
```

### å‹•æ…‹ Advisor åƒæ•¸è¨­å®š

```java
import lombok.RequiredArgsConstructor;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.memory.ChatMemory;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class DynamicChatService {
    
    private final ChatClient chatClient;
    private final ChatMemory chatMemory;
    
    public String chat(String conversationId, String userMessage, ChatOptions options) {
        return chatClient.prompt()
            .advisors(advisor -> {
                // å‹•æ…‹è¨­å®š Advisor åƒæ•¸
                advisor.param(ChatMemory.CONVERSATION_ID, conversationId);
                
                // æ ¹æ“šé¸é …èª¿æ•´è¨˜æ†¶å¤§å°
                if (options.isDetailedContext()) {
                    advisor.param("lastN", 50);
                } else {
                    advisor.param("lastN", 20);
                }
            })
            .user(userMessage)
            .call()
            .content();
    }
}
```

### è¨˜æ†¶æ•ˆèƒ½å„ªåŒ–

```java
import lombok.RequiredArgsConstructor;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.memory.ChatMemory;
import org.springframework.ai.chat.messages.Message;
import org.springframework.ai.chat.messages.SystemMessage;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

@Component
@RequiredArgsConstructor
public class MemoryOptimizationService {
    
    private final ChatMemory chatMemory;
    private final ChatClient summaryClient;
    
    /**
     * æ™ºèƒ½è¨˜æ†¶å£“ç¸®
     */
    @Scheduled(fixedRate = 3600000) // æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡
    public void optimizeMemory() {
        // ç²å–æ‰€æœ‰æ´»èºçš„å°è©± ID
        Set<String> activeConversations = getActiveConversations();
        
        for (String conversationId : activeConversations) {
            List<Message> messages = chatMemory.get(conversationId);
            
            if (messages.size() > 100) {
                compressConversation(conversationId, messages);
            }
        }
    }
    
    private void compressConversation(String conversationId, List<Message> messages) {
        // ä¿ç•™æœ€è¿‘ 30 æ¢è¨Šæ¯
        List<Message> recentMessages = messages.subList(messages.size() - 30, messages.size());
        
        // å°‡è¼ƒèˆŠçš„è¨Šæ¯é€²è¡Œæ‘˜è¦
        List<Message> oldMessages = messages.subList(0, messages.size() - 30);
        String summary = summarizeMessages(oldMessages);
        
        // é‡å»ºè¨˜æ†¶
        chatMemory.clear(conversationId);
        chatMemory.add(conversationId, new SystemMessage("å°è©±æ‘˜è¦ï¼š" + summary));
        chatMemory.add(conversationId, recentMessages);
    }
    
    private String summarizeMessages(List<Message> messages) {
        String conversation = messages.stream()
            .map(Message::getContent)
            .collect(Collectors.joining("\n"));
            
        return summaryClient.prompt()
            .user("è«‹ç°¡æ½”æ‘˜è¦ä»¥ä¸‹å°è©±çš„é‡é»ï¼š\n" + conversation)
            .call()
            .content();
    }
}
```

---

## 6.2.7 æ¸¬è©¦å°è©±è¨˜æ†¶åŠŸèƒ½

### åŸºæœ¬åŠŸèƒ½æ¸¬è©¦

```java
import org.junit.jupiter.api.Order;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.TestMethodOrder;
import org.junit.jupiter.api.MethodOrderer.OrderAnnotation;
import org.springframework.ai.chat.messages.Message;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest
@TestMethodOrder(OrderAnnotation.class)
class ChatMemoryServiceTest {
    
    @Autowired
    private BasicChatMemoryService chatService;
    
    private static final String CONVERSATION_ID = "test-conversation-001";
    
    @Test
    @Order(1)
    void testFirstMessage() {
        String response = chatService.chat(CONVERSATION_ID, "æˆ‘çš„åå­—æ˜¯ Kevin");
        
        assertThat(response).isNotNull();
        
        // é©—è­‰è¨˜æ†¶ä¸­æœ‰è¨Šæ¯
        List<Message> history = chatService.getConversationHistory(CONVERSATION_ID);
        assertThat(history).hasSize(2); // User + Assistant
    }
    
    @Test
    @Order(2)
    void testMemoryRecall() {
        String response = chatService.chat(CONVERSATION_ID, "æˆ‘å‰›æ‰èªªæˆ‘çš„åå­—æ˜¯ä»€éº¼ï¼Ÿ");
        
        assertThat(response.toLowerCase()).contains("kevin");
        
        // é©—è­‰è¨˜æ†¶å¢é•·
        List<Message> history = chatService.getConversationHistory(CONVERSATION_ID);
        assertThat(history).hasSizeGreaterThan(2);
    }
    
    @Test
    @Order(3)
    void testClearMemory() {
        chatService.clearConversation(CONVERSATION_ID);
        
        List<Message> history = chatService.getConversationHistory(CONVERSATION_ID);
        assertThat(history).isEmpty();
    }
}
```

### API ç«¯é»æ¸¬è©¦

```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.autoconfigure.jdbc.AutoConfigureTestDatabase;
import org.springframework.boot.test.web.client.TestRestTemplate;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;

import static org.assertj.core.api.Assertions.assertThat;

@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@AutoConfigureTestDatabase
class ChatMemoryControllerTest {
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @Test
    void testChatConversation() {
        String conversationId = "api-test-001";
        
        // ç¬¬ä¸€è¼ªå°è©±
        ChatRequest request1 = ChatRequest.builder()
            .message("æˆ‘å–œæ­¡å–å’–å•¡")
            .build();
            
        ResponseEntity<ChatResponse> response1 = restTemplate.postForEntity(
            "/api/chat/conversation/" + conversationId,
            request1,
            ChatResponse.class
        );
        
        assertThat(response1.getStatusCode()).isEqualTo(HttpStatus.OK);
        
        // ç¬¬äºŒè¼ªå°è©± - æ¸¬è©¦è¨˜æ†¶
        ChatRequest request2 = ChatRequest.builder()
            .message("æˆ‘å‰›æ‰èªªæˆ‘å–œæ­¡ä»€éº¼ï¼Ÿ")
            .build();
            
        ResponseEntity<ChatResponse> response2 = restTemplate.postForEntity(
            "/api/chat/conversation/" + conversationId,
            request2,
            ChatResponse.class
        );
        
        assertThat(response2.getStatusCode()).isEqualTo(HttpStatus.OK);
        assertThat(response2.getBody().getMessage().toLowerCase()).contains("å’–å•¡");
    }
}
```

---

## ğŸ“ æœ¬ç« é‡é»å›é¡§

1. **Advisor ç³»çµ±ç†è§£**ï¼šæŒæ¡äº† Spring AI çš„å¢å¼·å™¨æ©Ÿåˆ¶å’Œ AOP æ¦‚å¿µçš„æ‡‰ç”¨
2. **API æ›´æ–°èªçŸ¥**ï¼šå­¸æœƒäº†æœ€æ–°çš„ Advisor API ä½¿ç”¨æ–¹å¼å’Œ Builder æ¨¡å¼
3. **è¨˜æ†¶é¡å‹é¸æ“‡**ï¼šç†è§£äº†ä¸åŒ Advisor çš„ç‰¹é»å’Œé©ç”¨å ´æ™¯
4. **å¯¦éš›åŠŸèƒ½å¯¦ç¾**ï¼šå®Œæˆäº†åŸºæœ¬å°è©±è¨˜æ†¶åŠŸèƒ½çš„å®Œæ•´å¯¦ç¾
5. **ä¼æ¥­ç´šé…ç½®**ï¼šæŒæ¡äº†å¤šç¨®å­˜å„²å¾Œç«¯çš„é…ç½®å’Œé¸æ“‡ç­–ç•¥

### æŠ€è¡“è¦é»ç¸½çµ

| æŠ€è¡“é» | é‡è¦æ€§ | å¯¦ç¾é›£åº¦ | ä½¿ç”¨å ´æ™¯ |
|--------|--------|----------|----------|
| **MessageChatMemoryAdvisor** | â­â­â­ | ä½ | åŸºæœ¬å°è©±è¨˜æ†¶ |
| **å¤šå­˜å„²å¾Œç«¯é…ç½®** | â­â­â­ | ä¸­ | ä¼æ¥­ç´šæ‡‰ç”¨ |
| **å‹•æ…‹ Advisor åƒæ•¸** | â­â­ | ä¸­ | éˆæ´»é…ç½® |
| **è¨˜æ†¶æ•ˆèƒ½å„ªåŒ–** | â­â­ | é«˜ | å¤§è¦æ¨¡æ‡‰ç”¨ |
| **API æ¸¬è©¦** | â­â­ | ä½ | å“è³ªä¿è­‰ |

### æœ€ä½³å¯¦è¸å»ºè­°

1. **é–‹ç™¼éšæ®µ**ï¼šä½¿ç”¨ InMemoryChatMemory é€²è¡Œå¿«é€ŸåŸå‹é–‹ç™¼
2. **æ¸¬è©¦éšæ®µ**ï¼šé…ç½®é©ç•¶çš„è¨˜æ†¶å¤§å°é™åˆ¶ï¼Œé¿å…æ¸¬è©¦è³‡æ–™éå¤š
3. **ç”Ÿç”¢éšæ®µ**ï¼šé¸æ“‡åˆé©çš„æŒä¹…åŒ–å­˜å„²ï¼Œä¸¦é…ç½®è¨˜æ†¶æ¸…ç†ç­–ç•¥
4. **æ•ˆèƒ½å„ªåŒ–**ï¼šå¯¦æ–½è¨˜æ†¶å£“ç¸®å’Œå®šæœŸæ¸…ç†æ©Ÿåˆ¶
5. **ç›£æ§å‘Šè­¦**ï¼šå»ºç«‹è¨˜æ†¶ä½¿ç”¨é‡çš„ç›£æ§å’Œå‘Šè­¦æ©Ÿåˆ¶

### ä¸‹ä¸€æ­¥å­¸ç¿’æ–¹å‘

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘å€‘å°‡æ·±å…¥å­¸ç¿’ Spring AI çš„å®˜æ–¹è¨˜æ†¶ç³»çµ±ï¼ŒåŒ…æ‹¬ï¼š
- Spring AI å®˜æ–¹æä¾›çš„è¨˜æ†¶ç®¡ç† API
- æ›´é€²éšçš„è¨˜æ†¶é…ç½®é¸é …
- è¨˜æ†¶ç³»çµ±çš„ç›£æ§å’Œç®¡ç†
- èˆ‡å…¶ä»– Spring AI åŠŸèƒ½çš„æ•´åˆ

---

**åƒè€ƒè³‡æ–™ï¼š**
- [Spring AI Advisors Documentation](https://docs.spring.io/spring-ai/reference/api/advisors.html)
- [Chat Memory API Guide](https://docs.spring.io/spring-ai/reference/api/chat-memory.html)
- [ChatClient Builder Pattern](https://docs.spring.io/spring-ai/reference/api/chatclient.html)
- [Spring AI Best Practices](https://docs.spring.io/spring-ai/reference/concepts.html)