# 5.9 å–å¾—å¯¦éš›æ°£è±¡è³‡è¨Š

> **æœ¬ç« é‡é»**ï¼šå­¸ç¿’å¦‚ä½•æ•´åˆçœŸå¯¦çš„ç¬¬ä¸‰æ–¹ API è³‡æ–™ï¼Œé€é Function Calling è®“ AI èƒ½å¤ ç²å–å³æ™‚çš„æ°£è±¡è³‡è¨Šï¼Œå»ºç«‹å®Œæ•´çš„å¤©æ°£æŸ¥è©¢å’Œåˆ†æç³»çµ±ã€‚

## ğŸ¯ å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬ç« å­¸ç¿’å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š

- ğŸ¯ **æ•´åˆç¬¬ä¸‰æ–¹ API**ï¼šå­¸æœƒå¦‚ä½•æ•´åˆä¸­å¤®æ°£è±¡å±€ç­‰çœŸå¯¦ API æœå‹™
- ğŸ¯ **å¯¦ç¾å³æ™‚è³‡æ–™æŸ¥è©¢**ï¼šè®“ AI èƒ½å¤ ç²å–æœ€æ–°çš„æ°£è±¡è³‡è¨Š
- ğŸ¯ **è¨­è¨ˆå¤©æ°£å·¥å…·ç³»çµ±**ï¼šå»ºç«‹å®Œæ•´çš„å¤©æ°£æŸ¥è©¢å’Œåˆ†æå·¥å…·
- ğŸ¯ **è™•ç† API ç•°å¸¸**ï¼šæŒæ¡ç¬¬ä¸‰æ–¹ API çš„éŒ¯èª¤è™•ç†å’Œå®¹éŒ¯æ©Ÿåˆ¶
- ğŸ¯ **å„ªåŒ–æŸ¥è©¢æ•ˆèƒ½**ï¼šå¯¦ç¾å¿«å–å’Œæ‰¹æ¬¡æŸ¥è©¢å„ªåŒ–ç­–ç•¥

---

## 5.9.1 çœŸå¯¦ API æ•´åˆçš„é‡è¦æ€§

### æœ‰äº† AI å¯«ç¨‹å¼éƒ½å¯ä»¥å·æ‡¶

![AI Development](https://example.com/ai-development.jpg)

é‚„è¨˜å¾—å‰é¢æåˆ°è¦å–å¾—å³æ™‚è³‡è¨Šåªèƒ½é€é Function Calling å—ï¼Ÿç¶²è·¯ä¸Šä¸€å †æ•™å­¸éƒ½ä½¿ç”¨æ¨¡æ“¬è³‡æ–™ï¼Œä»Šå¤©ä¾†æ•™å¤§å®¶æ€éº¼æŠ“ä¸­å¤®æ°£è±¡å±€çš„è³‡æ–™ï¼Œä¸¦ä½¿ç”¨æœ€æ–°çš„ @Tool è¨»è§£å¯¦ç¾æ›´å„ªé›…çš„ Function Callingã€‚

### æ¨¡æ“¬è³‡æ–™ vs çœŸå¯¦è³‡æ–™

| æ¯”è¼ƒé …ç›® | æ¨¡æ“¬è³‡æ–™ | çœŸå¯¦ API è³‡æ–™ |
|----------|----------|---------------|
| **è³‡æ–™æº–ç¢ºæ€§** | å›ºå®šä¸è®Š | å³æ™‚æ›´æ–° |
| **é–‹ç™¼è¤‡é›œåº¦** | ç°¡å–® | éœ€è¦è™•ç† API æ•´åˆ |
| **å¯¦ç”¨åƒ¹å€¼** | åƒ…ä¾›å­¸ç¿’ | å¯å¯¦éš›æ‡‰ç”¨ |
| **éŒ¯èª¤è™•ç†** | ä¸éœ€è¦ | å¿…é ˆå®Œå–„è™•ç† |
| **æ•ˆèƒ½è€ƒé‡** | ç„¡é™åˆ¶ | éœ€è¦è€ƒæ…® API é™åˆ¶ |
| **æˆæœ¬** | å…è²» | å¯èƒ½æœ‰ä½¿ç”¨è²»ç”¨ |

### çœŸå¯¦ API æ•´åˆçš„æŒ‘æˆ°

**1. API é™åˆ¶å’Œé…é¡**
- ğŸ“Š **è«‹æ±‚é »ç‡é™åˆ¶**ï¼šæ¯åˆ†é˜/æ¯å°æ™‚çš„è«‹æ±‚æ¬¡æ•¸é™åˆ¶
- ğŸ’° **ä½¿ç”¨æˆæœ¬**ï¼šè¶…éå…è²»é¡åº¦å¾Œçš„è¨ˆè²»
- ğŸ”‘ **èªè­‰æ©Ÿåˆ¶**ï¼šAPI Key ç®¡ç†å’Œå®‰å…¨æ€§
- â° **å›æ‡‰æ™‚é–“**ï¼šç¶²è·¯å»¶é²å’Œ API è™•ç†æ™‚é–“

**2. è³‡æ–™æ ¼å¼å’Œè§£æ**
- ğŸ“‹ **è¤‡é›œçš„ JSON çµæ§‹**ï¼šéœ€è¦æ·±åº¦è§£æå·¢ç‹€è³‡æ–™
- ğŸ”„ **è³‡æ–™æ ¼å¼è®Šæ›´**ï¼šAPI ç‰ˆæœ¬æ›´æ–°å¯èƒ½æ”¹è®Šæ ¼å¼
- ğŸŒ **å¤šèªè¨€æ”¯æ´**ï¼šè™•ç†ä¸åŒèªè¨€çš„è³‡æ–™
- ğŸ“ **å–®ä½è½‰æ›**ï¼šæº«åº¦ã€é¢¨é€Ÿç­‰å–®ä½çš„æ¨™æº–åŒ–

**3. éŒ¯èª¤è™•ç†å’Œå®¹éŒ¯**
- ğŸš« **API æœå‹™ä¸­æ–·**ï¼šç¬¬ä¸‰æ–¹æœå‹™ä¸å¯ç”¨æ™‚çš„è™•ç†
- ğŸ“¡ **ç¶²è·¯å•é¡Œ**ï¼šé€£ç·šè¶…æ™‚å’Œé‡è©¦æ©Ÿåˆ¶
- ğŸ” **è³‡æ–™ç¼ºå¤±**ï¼šéƒ¨åˆ†åœ°å€æˆ–æ™‚é–“çš„è³‡æ–™ä¸å®Œæ•´
- âš ï¸ **æ ¼å¼éŒ¯èª¤**ï¼šAPI å›å‚³ç•°å¸¸æ ¼å¼çš„è™•ç†

---

## 5.9.2 ä¸­å¤®æ°£è±¡å±€ API æ•´åˆ

### å–å¾—ä¸­å¤®æ°£è±¡å±€é–‹æ”¾å¹³å°è³‡æ–™

**æ­¥é©Ÿ 1ï¼šè¨»å†Šå’Œå–å¾— API Key**

ä¸­å¤®æ°£è±¡å±€æœ‰å€‹è³‡æ–™é–‹æ”¾å¹³å°ï¼š[https://opendata.cwa.gov.tw/index](https://opendata.cwa.gov.tw/index)

è¨»å†Šå¾Œå°±èƒ½åœ¨ **æœƒå“¡è³‡è¨Šï¼å–å¾—æˆæ¬Šç¢¼** æ‹¿åˆ°è‡ªå·±çš„æˆæ¬Šç¢¼ã€‚

![Weather API](https://example.com/weather-api.png)

**æ­¥é©Ÿ 2ï¼šé¸æ“‡åˆé©çš„è³‡æ–™é›†**

å¯ä»¥åœ¨è³‡æ–™ä¸»é¡Œæ‰¾éœ€è¦çš„è³‡æ–™ï¼Œç”±æ–¼æˆ‘åªè¦æŠ“åˆ°ç›®å‰çš„æ°£è±¡è³‡è¨Šï¼Œæ‰€ä»¥é¸æ“‡ **è§€æ¸¬-ç¾åœ¨å¤©æ°£è§€æ¸¬å ±å‘Š**ã€‚

> ğŸ’¡ **å°æç¤º**ï¼šæœ€å¥½æ‰¾æœ‰ API çš„ï¼Œä¸ç„¶éœ€è¦ä¸‹è¼‰æª”æ¡ˆå†ç”¨è®€æª”çš„æ–¹å¼è™•ç†

**æ­¥é©Ÿ 3ï¼šAPI æ¸¬è©¦**

é€²å…¥å¾Œå°±æ˜¯ API å¸¸ç”¨çš„ Swagger ç¶²ç«™äº†ã€‚é»é¸ Try it out è¼¸å…¥æˆæ¬Šç¢¼ï¼ŒæŒ‰ä¸‹ Execute å°±èƒ½å–å¾— JSON è³‡æ–™äº†ã€‚

### å°ˆæ¡ˆé…ç½®

**Maven ä¾è³´**ï¼š

```xml
<!-- ä½¿ç”¨ Spring AI BOM ç®¡ç†ç‰ˆæœ¬ -->
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-bom</artifactId>
            <version>1.0.0</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>

<dependencies>
    <!-- Spring AI OpenAI Starter -->
    <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-openai-spring-boot-starter</artifactId>
        </dependency>
    
    <!-- Spring Boot Web -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
</dependencies>
```

**æ‡‰ç”¨ç¨‹å¼é…ç½®**ï¼š

```yaml
# application.yml
spring:
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      chat:
        options:
          model: gpt-4o-mini
          temperature: 0.1

# ä¸­å¤®æ°£è±¡å±€ API é…ç½®
cwa:
  api:
    key: ${CWA_API_KEY}  # ä¸­å¤®æ°£è±¡å±€ API Key
    base-url: https://opendata.cwa.gov.tw/api/v1/rest/datastore

# æ—¥èªŒé…ç½®
logging:
  level:
    com.example.weather: DEBUG
    org.springframework.ai: DEBUG
```

---

## 5.9.3 å¤©æ°£æœå‹™å¯¦ç¾

### æ ¸å¿ƒå¤©æ°£æœå‹™

```java
package com.example.service;

import com.fasterxml.jackson.databind.JsonNode;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.tool.annotation.Tool;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;

@Service
@RequiredArgsConstructor
@Slf4j
public class WeatherService {

    private final RestTemplate restTemplate;
    
    @Value("${cwa.api.key}")
    private String apiKey;
    
    @Value("${cwa.api.base-url:https://opendata.cwa.gov.tw/api/v1/rest/datastore}")
    private String baseUrl;

    /**
     * å–å¾—æŒ‡å®šåœ°å€çš„ç›®å‰å¤©æ°£è³‡è¨Š
     * @param location åœ°å€åç¨±
     * @return å¤©æ°£è³‡è¨Š
     */
    @Tool(description = "Get current weather information for a specific location in Taiwan. " +
          "Supports major cities and counties like Taipei, Taoyuan, Taichung, Tainan, Kaohsiung, etc.")
    public WeatherInfo getCurrentWeather(String location) {
        try {
            log.info("æŸ¥è©¢å¤©æ°£è³‡è¨Šï¼š{}", location);
            
            String url = baseUrl + "/O-A0003-001?Authorization=" + apiKey;
            
            JsonNode response = restTemplate.getForObject(url, JsonNode.class);
            
            if (response == null || !response.has("records")) {
                return WeatherInfo.error("ç„¡æ³•å–å¾—å¤©æ°£è³‡æ–™");
            }
            
            // è§£æå¤©æ°£è³‡æ–™
            JsonNode records = response.get("records");
            JsonNode locations = records.get("location");
            
            if (locations == null || !locations.isArray()) {
                return WeatherInfo.error("å¤©æ°£è³‡æ–™æ ¼å¼éŒ¯èª¤");
            }
            
            // å°‹æ‰¾æŒ‡å®šåœ°å€çš„å¤©æ°£è³‡æ–™
            for (JsonNode locationNode : locations) {
                String locationName = locationNode.get("locationName").asText();
                
                if (locationName.contains(location) || location.contains(locationName)) {
                    WeatherInfo result = parseWeatherData(locationNode, locationName);
                    log.info("æˆåŠŸå–å¾— {} çš„å¤©æ°£è³‡è¨Š", locationName);
                    return result;
                }
            }
            
            return WeatherInfo.notFound("æ‰¾ä¸åˆ° " + location + " çš„å¤©æ°£è³‡æ–™ï¼Œè«‹ç¢ºèªåœ°å€åç¨±æ˜¯å¦æ­£ç¢º");
            
        } catch (Exception e) {
            log.error("å–å¾—å¤©æ°£è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: {}", e.getMessage(), e);
            return WeatherInfo.error("å–å¾—å¤©æ°£è³‡æ–™å¤±æ•—ï¼š" + e.getMessage());
        }
    }

    /**
     * å–å¾—å…¨å°å„åœ°çš„æº«åº¦æ’è¡Œæ¦œ
     * @param topCount æ’è¡Œæ•¸é‡
     * @return æº«åº¦æ’è¡Œ
     */
    @Tool(description = "Get temperature ranking for all locations in Taiwan. " +
          "Returns top N locations sorted by temperature.")
    public TemperatureRanking getTemperatureRanking(Integer topCount) {
        if (topCount == null || topCount <= 0) {
            topCount = 10;
        }
        
        try {
            log.info("æŸ¥è©¢æº«åº¦æ’è¡Œæ¦œï¼šå‰ {} å", topCount);
            
            String url = baseUrl + "/O-A0003-001?Authorization=" + apiKey;
            JsonNode response = restTemplate.getForObject(url, JsonNode.class);
            
            if (response == null || !response.has("records")) {
                return TemperatureRanking.error("ç„¡æ³•å–å¾—å¤©æ°£è³‡æ–™");
            }
            
            List<LocationTemperature> temperatures = new ArrayList<>();
            JsonNode locations = response.get("records").get("location");
            
            for (JsonNode locationNode : locations) {
                String locationName = locationNode.get("locationName").asText();
                JsonNode weatherElements = locationNode.get("weatherElement");
                
                Double temp = extractTemperature(weatherElements);
                if (temp != null) {
                    temperatures.add(new LocationTemperature(locationName, temp));
                }
            }
            
            // æŒ‰æº«åº¦æ’åºä¸¦å–å‰ N å
            List<LocationTemperature> topTemperatures = temperatures.stream()
                    .sorted((a, b) -> Double.compare(b.temperature(), a.temperature()))
                    .limit(topCount)
                    .toList();
            
            log.info("æˆåŠŸå–å¾—æº«åº¦æ’è¡Œæ¦œï¼š{} å€‹åœ°é»", topTemperatures.size());
            
            return new TemperatureRanking(
                    topTemperatures,
                    true,
                    null,
                    LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"))
            );
            
        } catch (Exception e) {
            log.error("å–å¾—æº«åº¦æ’è¡Œæ™‚ç™¼ç”ŸéŒ¯èª¤: {}", e.getMessage(), e);
            return TemperatureRanking.error("å–å¾—æº«åº¦æ’è¡Œå¤±æ•—ï¼š" + e.getMessage());
        }
    }

    /**
     * å–å¾—å¤©æ°£é å ±è³‡è¨Š
     * @param location åœ°å€åç¨±
     * @param days é å ±å¤©æ•¸
     * @return å¤©æ°£é å ±
     */
    @Tool(description = "Get weather forecast for a specific location. " +
          "Provides multi-day weather forecast including temperature and conditions.")
    public WeatherForecast getWeatherForecast(String location, Integer days) {
        if (days == null || days <= 0) {
            days = 3;
        }
        
        try {
            log.info("æŸ¥è©¢å¤©æ°£é å ±ï¼š{}ï¼Œ{} å¤©", location, days);
            
            // é€™è£¡å¯ä»¥æ•´åˆé å ± API
            // ç›®å‰å…ˆè¿”å›æ¨¡æ“¬è³‡æ–™
            List<DailyForecast> forecasts = generateMockForecast(location, days);
            
            return new WeatherForecast(
                    location,
                    forecasts,
                    true,
                    null
            );
            
        } catch (Exception e) {
            log.error("å–å¾—å¤©æ°£é å ±æ™‚ç™¼ç”ŸéŒ¯èª¤: {}", e.getMessage(), e);
            return WeatherForecast.error("å–å¾—å¤©æ°£é å ±å¤±æ•—ï¼š" + e.getMessage());
        }
    }
    
    /**
     * è§£æå¤©æ°£è³‡æ–™
     */
    private WeatherInfo parseWeatherData(JsonNode locationNode, String locationName) {
        try {
            JsonNode weatherElements = locationNode.get("weatherElement");
            
            Double temperature = extractTemperature(weatherElements);
            Double humidity = extractHumidity(weatherElements);
            String weather = extractWeatherDescription(weatherElements);
            Double rainfall = extractRainfall(weatherElements);
            String windDirection = extractWindDirection(weatherElements);
            Double windSpeed = extractWindSpeed(weatherElements);
            
            return new WeatherInfo(
                    locationName,
                    temperature,
                    humidity,
                    weather,
                    rainfall,
                    windDirection,
                    windSpeed,
                    true,
                    null,
                    LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"))
            );
            
        } catch (Exception e) {
            log.error("è§£æå¤©æ°£è³‡æ–™å¤±æ•—", e);
            return WeatherInfo.error("è§£æå¤©æ°£è³‡æ–™å¤±æ•—ï¼š" + e.getMessage());
        }
    }
    
    private Double extractTemperature(JsonNode weatherElements) {
        return extractElementValue(weatherElements, "TEMP");
    }
    
    private Double extractHumidity(JsonNode weatherElements) {
        return extractElementValue(weatherElements, "HUMD");
    }
    
    private Double extractRainfall(JsonNode weatherElements) {
        return extractElementValue(weatherElements, "24R");
    }
    
    private Double extractWindSpeed(JsonNode weatherElements) {
        return extractElementValue(weatherElements, "WDSD");
    }
    
    private String extractWeatherDescription(JsonNode weatherElements) {
        JsonNode element = findWeatherElement(weatherElements, "Weather");
        if (element != null && element.has("elementValue")) {
            return element.get("elementValue").asText();
        }
        return null;
    }
    
    private String extractWindDirection(JsonNode weatherElements) {
        JsonNode element = findWeatherElement(weatherElements, "WDIR");
        if (element != null && element.has("elementValue")) {
            return element.get("elementValue").asText();
        }
        return null;
    }
    
    private Double extractElementValue(JsonNode weatherElements, String elementName) {
        JsonNode element = findWeatherElement(weatherElements, elementName);
        if (element != null && element.has("elementValue")) {
            try {
                return element.get("elementValue").asDouble();
            } catch (Exception e) {
                log.warn("ç„¡æ³•è§£æ {} çš„æ•¸å€¼", elementName);
            }
        }
        return null;
    }
    
    private JsonNode findWeatherElement(JsonNode weatherElements, String elementName) {
        if (weatherElements != null && weatherElements.isArray()) {
            for (JsonNode element : weatherElements) {
                if (element.has("elementName") && 
                    elementName.equals(element.get("elementName").asText())) {
                    return element;
                }
            }
        }
        return null;
    }
    
    private List<DailyForecast> generateMockForecast(String location, int days) {
        List<DailyForecast> forecasts = new ArrayList<>();
        for (int i = 0; i < days; i++) {
            forecasts.add(new DailyForecast(
                    LocalDateTime.now().plusDays(i).toLocalDate().toString(),
                    "æ™´æ™‚å¤šé›²",
                    25.0 + i,
                    30.0 + i,
                    20.0 + i,
                    60.0
            ));
        }
        return forecasts;
    }
}
```

### è³‡æ–™æ¨¡å‹å®šç¾©

```java
package com.example.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.Builder;

import java.util.List;

/**
 * å¤©æ°£è³‡è¨Šè³‡æ–™é¡åˆ¥
 */
public record WeatherInfo(
        @JsonProperty("location") String location,
        @JsonProperty("temperature") Double temperature,
        @JsonProperty("humidity") Double humidity,
        @JsonProperty("weather") String weather,
        @JsonProperty("rainfall") Double rainfall,
        @JsonProperty("wind_direction") String windDirection,
        @JsonProperty("wind_speed") Double windSpeed,
        @JsonProperty("success") boolean success,
        @JsonProperty("error") String error,
        @JsonProperty("observation_time") String observationTime
) {
    public static WeatherInfo error(String message) {
        return new WeatherInfo(null, null, null, null, null, null, null,
                false, message, null);
    }
    
    public static WeatherInfo notFound(String message) {
        return new WeatherInfo(null, null, null, null, null, null, null,
                false, message, null);
    }
    
    @Override
    public String toString() {
        if (!success) {
            return "âŒ " + error;
        }
        
        StringBuilder sb = new StringBuilder();
        sb.append("ğŸ“ åœ°é»ï¼š").append(location).append("\n");
        sb.append("ğŸŒ¡ï¸ æº«åº¦ï¼š").append(temperature != null ? temperature + "Â°C" : "ç„¡è³‡æ–™").append("\n");
        sb.append("ğŸ’§ æ¿•åº¦ï¼š").append(humidity != null ? humidity + "%" : "ç„¡è³‡æ–™").append("\n");
        sb.append("â˜ï¸ å¤©æ°£ï¼š").append(weather != null ? weather : "ç„¡è³‡æ–™").append("\n");
        sb.append("ğŸŒ§ï¸ é™é›¨é‡ï¼š").append(rainfall != null ? rainfall + "mm" : "ç„¡è³‡æ–™").append("\n");
        sb.append("ğŸ’¨ é¢¨å‘ï¼š").append(windDirection != null ? windDirection : "ç„¡è³‡æ–™").append("\n");
        sb.append("ğŸŒªï¸ é¢¨é€Ÿï¼š").append(windSpeed != null ? windSpeed + "m/s" : "ç„¡è³‡æ–™").append("\n");
        sb.append("â° è§€æ¸¬æ™‚é–“ï¼š").append(observationTime);
        
        return sb.toString();
    }
}

/**
 * æº«åº¦æ’è¡Œè³‡æ–™
 */
public record TemperatureRanking(
        List<LocationTemperature> rankings,
        boolean success,
        String error,
        String updateTime
) {
    public static TemperatureRanking error(String message) {
        return new TemperatureRanking(List.of(), false, message, null);
    }
}

public record LocationTemperature(
        String location,
        Double temperature
) {}

/**
 * å¤©æ°£é å ±è³‡æ–™
 */
public record WeatherForecast(
        String location,
        List<DailyForecast> forecasts,
        boolean success,
        String error
) {
    public static WeatherForecast error(String message) {
        return new WeatherForecast(null, List.of(), false, message);
    }
}

public record DailyForecast(
        String date,
        String weather,
        Double temperature,
        Double maxTemperature,
        Double minTemperature,
        Double humidity
) {}
```

---

## 5.9.4 å¤©æ°£æŸ¥è©¢æ§åˆ¶å™¨

### REST API æ§åˆ¶å™¨

```java
package com.example.controller;

import com.example.model.WeatherInfo;
import com.example.model.TemperatureRanking;
import com.example.service.WeatherService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/weather")
@RequiredArgsConstructor
@Slf4j
public class WeatherController {

    private final ChatClient chatClient;
    private final WeatherService weatherService;

    /**
     * AI å¤©æ°£æŸ¥è©¢
     * @param question å¤©æ°£æŸ¥è©¢å•é¡Œ
     * @return AI å›æ‡‰
     */
    @GetMapping("/chat")
    public ResponseEntity<WeatherChatResponse> chatWeather(@RequestParam String question) {
        
        try {
            log.info("æ”¶åˆ°å¤©æ°£æŸ¥è©¢ï¼š{}", question);
            
            String response = chatClient
                    .prompt(question)
                    .tools(weatherService)
                    .call()
                    .content();
            
            WeatherChatResponse chatResponse = new WeatherChatResponse(
                    question,
                    response,
                    true,
                    null,
                    System.currentTimeMillis()
            );
            
            return ResponseEntity.ok(chatResponse);
            
        } catch (Exception e) {
            log.error("å¤©æ°£æŸ¥è©¢å¤±æ•—: {}", e.getMessage(), e);
            
            WeatherChatResponse errorResponse = new WeatherChatResponse(
                    question,
                    null,
                    false,
                    "å¤©æ°£æŸ¥è©¢å¤±æ•—ï¼š" + e.getMessage(),
                    System.currentTimeMillis()
            );
            
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(errorResponse);
        }
    }

    /**
     * ç›´æ¥å–å¾—å¤©æ°£è³‡è¨Š
     * @param location åœ°é»åç¨±
     * @return å¤©æ°£è³‡è¨Š
     */
    @GetMapping("/current")
    public ResponseEntity<WeatherInfo> getCurrentWeather(@RequestParam String location) {
        
        WeatherInfo weatherInfo = weatherService.getCurrentWeather(location);
        
        if (weatherInfo.success()) {
            return ResponseEntity.ok(weatherInfo);
        } else {
            return ResponseEntity.status(HttpStatus.NOT_FOUND).body(weatherInfo);
        }
    }

    /**
     * å–å¾—æº«åº¦æ’è¡Œæ¦œ
     * @param topCount æ’è¡Œæ•¸é‡
     * @return æº«åº¦æ’è¡Œ
     */
    @GetMapping("/temperature-ranking")
    public ResponseEntity<TemperatureRanking> getTemperatureRanking(
            @RequestParam(defaultValue = "10") Integer topCount) {
        
        TemperatureRanking ranking = weatherService.getTemperatureRanking(topCount);
        return ResponseEntity.ok(ranking);
    }

    /**
     * å¤©æ°£æŸ¥è©¢å›æ‡‰
     */
    public record WeatherChatResponse(
            String question,
            String answer,
            boolean success,
            String error,
            long timestamp
    ) {}
}
```

---

## 5.9.5 ç°¡åŒ–é…ç½®

### åŸºæœ¬é…ç½®é¡

```java
package com.example.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.client.RestTemplate;

@Configuration
public class WeatherApiConfig {

    /**
     * å¤©æ°£ API å°ˆç”¨çš„ RestTemplate
     */
    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

---

## 5.9.6 æ¸¬è©¦æ‡‰ç”¨

### æ¸¬è©¦å¤©æ°£æŸ¥è©¢

**åŸºæœ¬ API æ¸¬è©¦**ï¼š

```bash
# åŸºæœ¬å¤©æ°£æŸ¥è©¢
curl "http://localhost:8080/api/weather/chat?question=æ¡ƒåœ’ç›®å‰å¤©æ°£å¦‚ä½•ï¼Ÿ"

# æº«åº¦æ’è¡ŒæŸ¥è©¢
curl "http://localhost:8080/api/weather/chat?question=å…¨å°æœ€é«˜æº«çš„å‰ä¸‰åæ˜¯å“ªäº›åœ°æ–¹ï¼Ÿ"

# å¤©æ°£é å ±æŸ¥è©¢
curl "http://localhost:8080/api/weather/chat?question=å°ä¸­æœªä¾†ä¸‰å¤©å¤©æ°£é å ±"

# ç›´æ¥ API èª¿ç”¨
curl "http://localhost:8080/api/weather/current?location=å°åŒ—"

# æº«åº¦æ’è¡Œæ¦œ
curl "http://localhost:8080/api/weather/temperature-ranking?topCount=5"
```

**å›æ‡‰ç¯„ä¾‹**ï¼š

```json
{
  "question": "æ¡ƒåœ’ç›®å‰å¤©æ°£å¦‚ä½•ï¼Ÿ",
  "answer": "ğŸ“ åœ°é»ï¼šæ¡ƒåœ’\nğŸŒ¡ï¸ æº«åº¦ï¼š28.5Â°C\nğŸ’§ æ¿•åº¦ï¼š72%\nâ˜ï¸ å¤©æ°£ï¼šå¤šé›²\nğŸŒ§ï¸ é™é›¨é‡ï¼š0.0mm\nğŸ’¨ é¢¨å‘ï¼šæ±å—é¢¨\nğŸŒªï¸ é¢¨é€Ÿï¼š2.3m/s\nâ° è§€æ¸¬æ™‚é–“ï¼š2025-01-29 14:30",
  "success": true,
  "error": null,
  "timestamp": 1706518200000
}
```

### é€²éšåŠŸèƒ½æ¸¬è©¦

**å¤šåœ°é»æ¯”è¼ƒæŸ¥è©¢**ï¼š

```
ç”¨æˆ¶ï¼šã€Œæ¯”è¼ƒå°åŒ—ã€å°ä¸­ã€é«˜é›„ä¸‰å€‹åŸå¸‚çš„å¤©æ°£ç‹€æ³ã€

AI å›æ‡‰ï¼š
ğŸŒ¤ï¸ **ä¸‰å¤§åŸå¸‚å¤©æ°£æ¯”è¼ƒ**

ğŸ“ **å°åŒ—**
ğŸŒ¡ï¸ æº«åº¦ï¼š26.8Â°C
ğŸ’§ æ¿•åº¦ï¼š78%
â˜ï¸ å¤©æ°£ï¼šé™°å¤©

ğŸ“ **å°ä¸­**
ğŸŒ¡ï¸ æº«åº¦ï¼š29.2Â°C
ğŸ’§ æ¿•åº¦ï¼š65%
â˜ï¸ å¤©æ°£ï¼šæ™´æ™‚å¤šé›²

ğŸ“ **é«˜é›„**
ğŸŒ¡ï¸ æº«åº¦ï¼š31.5Â°C
ğŸ’§ æ¿•åº¦ï¼š70%
â˜ï¸ å¤©æ°£ï¼šæ™´å¤©

ğŸ“Š **åˆ†æç¸½çµ**
- ğŸ”¥ æœ€ç†±ï¼šé«˜é›„ (31.5Â°C)
- ğŸŒ¡ï¸ æœ€æ¶¼ï¼šå°åŒ— (26.8Â°C)
- ğŸ’§ æœ€æ½®æ¿•ï¼šå°åŒ— (78%)
- â˜€ï¸ å¤©æ°£æœ€ä½³ï¼šé«˜é›„
```

**æ™ºèƒ½å»ºè­°æŸ¥è©¢**ï¼š

```
ç”¨æˆ¶ï¼šã€Œæ˜å¤©è¦å»å°ä¸­ï¼Œéœ€è¦å¸¶é›¨å…·å—ï¼Ÿã€

AI å›æ‡‰ï¼š
ğŸŒ¦ï¸ **å°ä¸­æ˜å¤©å¤©æ°£å»ºè­°**

ğŸ“… **æ˜å¤©å¤©æ°£é å ±**
ğŸŒ¡ï¸ æº«åº¦ï¼š25-30Â°C
â˜ï¸ å¤©æ°£ï¼šæ™´æ™‚å¤šé›²
ğŸŒ§ï¸ é™é›¨æ©Ÿç‡ï¼š20%
ğŸ’¨ é¢¨åŠ›ï¼šå¾®é¢¨

â˜‚ï¸ **æ”œå¸¶å»ºè­°**
âœ… å»ºè­°æ”œå¸¶è¼•ä¾¿é›¨å…·
- é›–ç„¶é™é›¨æ©Ÿç‡ä¸é«˜ï¼Œä½†åˆå¾Œå¯èƒ½æœ‰å±€éƒ¨é™£é›¨
- å¯æº–å‚™æ‘ºç–Šå‚˜ä»¥å‚™ä¸æ™‚ä¹‹éœ€
- ç©¿è‘—è¼•è–„é€æ°£çš„è¡£ç‰©å³å¯

ğŸ¯ **å‡ºè¡Œå»ºè­°**
- é©åˆæˆ¶å¤–æ´»å‹•
- æ³¨æ„é˜²æ›¬
- å¤šè£œå……æ°´åˆ†
```

---

## ğŸ“ æœ¬ç« é‡é»å›é¡§

1. **çœŸå¯¦ API æ•´åˆ**ï¼šå­¸æœƒäº†æ•´åˆä¸­å¤®æ°£è±¡å±€ç­‰ç¬¬ä¸‰æ–¹ API æœå‹™
2. **å³æ™‚è³‡æ–™æŸ¥è©¢**ï¼šå¯¦ç¾äº† AI ç²å–æœ€æ–°æ°£è±¡è³‡è¨Šçš„èƒ½åŠ›
3. **Tool Calling æ‡‰ç”¨**ï¼šå»ºç«‹äº†å¤©æ°£æŸ¥è©¢å’Œåˆ†æçš„ AI å·¥å…·
4. **è³‡æ–™è§£æè™•ç†**ï¼šæŒæ¡äº† JSON è³‡æ–™çš„è§£æå’Œè½‰æ›æŠ€è¡“
5. **AI æ™ºèƒ½åˆ†æ**ï¼šå¯¦ç¾äº†åŸºæ–¼çœŸå¯¦è³‡æ–™çš„æ™ºèƒ½å¤©æ°£åˆ†æ

### æŠ€è¡“è¦é»ç¸½çµ

| æŠ€è¡“é» | é‡è¦æ€§ | å¯¦ç¾é›£åº¦ | ä½¿ç”¨å ´æ™¯ |
|--------|--------|----------|----------|
| **ç¬¬ä¸‰æ–¹ API æ•´åˆ** | â­â­â­ | ä¸­ | æ‰€æœ‰å³æ™‚è³‡æ–™æ‡‰ç”¨ |
| **è³‡æ–™è§£æè™•ç†** | â­â­â­ | ä¸­ | API è³‡æ–™è™•ç† |
| **Tool Calling** | â­â­â­ | ä¸­ | AI å·¥å…·æ•´åˆ |
| **JSON è™•ç†** | â­â­ | ä½ | è³‡æ–™è½‰æ› |
| **éŒ¯èª¤è™•ç†** | â­â­ | ä¸­ | ç³»çµ±ç©©å®šæ€§ |

### æœ€ä½³å¯¦è¸å»ºè­°

**1. API ä½¿ç”¨ç­–ç•¥**
- ğŸ”‘ **å®‰å…¨ç®¡ç†**ï¼šå¦¥å–„ä¿ç®¡ API Keyï¼Œä½¿ç”¨ç’°å¢ƒè®Šæ•¸
- ğŸ“Š **é…é¡ç›£æ§**ï¼šç›£æ§ API ä½¿ç”¨é‡ï¼Œé¿å…è¶…éé™åˆ¶
- ğŸ›¡ï¸ **éŒ¯èª¤è™•ç†**ï¼šå° API èª¿ç”¨å¤±æ•—é€²è¡Œé©ç•¶çš„éŒ¯èª¤è™•ç†

**2. è³‡æ–™è™•ç†å„ªåŒ–**
- ğŸ¯ **ç²¾ç¢ºè§£æ**ï¼šä»”ç´°è™•ç† JSON çµæ§‹ï¼Œé¿å…è§£æéŒ¯èª¤
- ğŸ›¡ï¸ **é˜²ç¦¦æ€§ç·¨ç¨‹**ï¼šå°æ‰€æœ‰å¯èƒ½çš„ç©ºå€¼å’Œç•°å¸¸é€²è¡Œè™•ç†
- ğŸ“ **å–®ä½æ¨™æº–åŒ–**ï¼šçµ±ä¸€æº«åº¦ã€é¢¨é€Ÿç­‰å–®ä½çš„è¡¨ç¤ºæ–¹å¼

**3. AI å·¥å…·è¨­è¨ˆ**
- ğŸ’¬ **æ¸…æ™°æè¿°**ï¼šç‚º @Tool è¨»è§£æä¾›æ¸…æ™°çš„åŠŸèƒ½æè¿°
- ğŸ“Š **çµæ§‹åŒ–å›æ‡‰**ï¼šæä¾›æ¸…æ™°ã€æ˜“è®€çš„å¤©æ°£è³‡è¨Šæ ¼å¼
- ğŸ¨ **è¦–è¦ºåŒ–å±•ç¤º**ï¼šä½¿ç”¨è¡¨æƒ…ç¬¦è™Ÿå’Œæ ¼å¼åŒ–å¢å¼·å¯è®€æ€§
- ğŸ’¡ **æ™ºèƒ½å»ºè­°**ï¼šåŸºæ–¼å¤©æ°£è³‡è¨Šæä¾›å¯¦ç”¨çš„ç”Ÿæ´»å»ºè­°

### ä¼æ¥­æ‡‰ç”¨åƒ¹å€¼

**1. å•†æ¥­æ‡‰ç”¨å ´æ™¯**
- ğŸ¢ **ä¼æ¥­æ±ºç­–æ”¯æ´**ï¼šç‚ºæˆ¶å¤–ä½œæ¥­ã€ç‰©æµé…é€æä¾›å¤©æ°£è³‡è¨Š
- ğŸ“± **ç§»å‹•æ‡‰ç”¨æ•´åˆ**ï¼šç‚º App æä¾›å³æ™‚å¤©æ°£æŸ¥è©¢åŠŸèƒ½
- ğŸ¤– **æ™ºèƒ½å®¢æœ**ï¼šåœ¨å®¢æœç³»çµ±ä¸­æ•´åˆå¤©æ°£æŸ¥è©¢èƒ½åŠ›
- ğŸ“Š **è³‡æ–™åˆ†æå¹³å°**ï¼šå°‡å¤©æ°£è³‡æ–™ç´å…¥å•†æ¥­åˆ†ææ¨¡å‹

**2. æŠ€è¡“æ¶æ§‹å„ªå‹¢**
- ğŸ”§ **æ¨¡çµ„åŒ–è¨­è¨ˆ**ï¼šå¤©æ°£æœå‹™å¯ç¨ç«‹éƒ¨ç½²å’Œæ“´å±•
- ğŸš€ **AI å·¥å…·æ•´åˆ**ï¼šé€é Tool Calling å¯¦ç¾æ™ºèƒ½å¤©æ°£åˆ†æ
- ğŸ“ˆ **å³æ™‚è³‡æ–™å­˜å–**ï¼šç²å–æœ€æ–°çš„æ°£è±¡è³‡è¨Š
- ğŸ”„ **æ˜“æ–¼ç¶­è­·**ï¼šæ¸…æ™°çš„ä»£ç¢¼çµæ§‹å’ŒéŒ¯èª¤è™•ç†

### ä¸‹ä¸€æ­¥å­¸ç¿’æ–¹å‘

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘å€‘å°‡å­¸ç¿’çµæ§‹åŒ–è³‡æ–™è½‰æ›å™¨ï¼Œæ¢ç´¢å¦‚ä½•è®“ AI è¼¸å‡ºçµæ§‹åŒ–çš„è³‡æ–™æ ¼å¼ï¼Œç‚ºä¼æ¥­æ‡‰ç”¨æä¾›æ›´æ¨™æº–åŒ–çš„è³‡æ–™ä»‹é¢ã€‚

---

**åƒè€ƒè³‡æ–™ï¼š**
- [ä¸­å¤®æ°£è±¡å±€é–‹æ”¾è³‡æ–™å¹³å°](https://opendata.cwa.gov.tw/index)
- [Spring AI Tool Calling Documentation](https://docs.spring.io/spring-ai/reference/api/tools.html)