# 2.3 API è«‹æ±‚èˆ‡å›æ‡‰è™•ç†

> **æœ¬ç« é‡é»**ï¼šæŒæ¡ Spring MVC ä¸­è«‹æ±‚åƒæ•¸è™•ç†å’Œå›æ‡‰æ ¼å¼è¨­è¨ˆçš„æ ¸å¿ƒæŠ€è¡“ï¼Œå»ºç«‹å®Œæ•´çš„ API è³‡æ–™äº¤æ›é«”ç³»ï¼Œç‚º Spring AI æ•´åˆåšå¥½æº–å‚™ã€‚

## ğŸ¯ å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬ç« å­¸ç¿’å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š

- ğŸ¯ **æŒæ¡åƒæ•¸è¨»è§£é«”ç³»**ï¼šç†è§£ @PathVariableã€@RequestParamã€@RequestBody ç­‰æ ¸å¿ƒè¨»è§£çš„ä½¿ç”¨å ´æ™¯
- ğŸ¯ **è¨­è¨ˆçµ±ä¸€å›æ‡‰æ ¼å¼**ï¼šå»ºç«‹æ¨™æº–åŒ–çš„ API å›æ‡‰çµæ§‹ï¼Œæå‡ä»‹é¢ä¸€è‡´æ€§
- ğŸ¯ **ç†Ÿç·´é‹ç”¨ HTTP ç‹€æ…‹ç¢¼**ï¼šæ­£ç¢ºä½¿ç”¨å„ç¨®ç‹€æ…‹ç¢¼è¡¨é”ä¸åŒçš„æ¥­å‹™æƒ…å¢ƒ
- ğŸ¯ **å¯¦ç¾å®Œå–„éŒ¯èª¤è™•ç†**ï¼šå»ºæ§‹çµ±ä¸€çš„éŒ¯èª¤å›æ‡‰æ©Ÿåˆ¶å’Œç•°å¸¸è™•ç†ç­–ç•¥
- ğŸ¯ **ç‚º AI æœå‹™åšæº–å‚™**ï¼šè¨­è¨ˆé©åˆ AI æ‡‰ç”¨çš„è«‹æ±‚å›æ‡‰æ¨¡å¼

---

## 2.3.1 è«‹æ±‚åƒæ•¸è™•ç†

### ç‚ºä»€éº¼éœ€è¦ç†è§£è«‹æ±‚åƒæ•¸è™•ç†ï¼Ÿ

åœ¨ç¾ä»£ Web æ‡‰ç”¨é–‹ç™¼ä¸­ï¼ŒAPI æ˜¯å‰å¾Œç«¯äº¤äº’çš„æ©‹æ¨‘ã€‚ä¸€å€‹è¨­è¨ˆè‰¯å¥½çš„ API éœ€è¦èƒ½å¤ éˆæ´»åœ°è™•ç†å„ç¨®é¡å‹çš„è«‹æ±‚åƒæ•¸ï¼Œç‰¹åˆ¥æ˜¯åœ¨ AI æ‡‰ç”¨ä¸­ï¼Œæˆ‘å€‘éœ€è¦è™•ç†è¤‡é›œçš„è¼¸å…¥è³‡æ–™ã€‚

### Spring MVC åƒæ•¸è¨»è§£æ¦‚è¦½

| è¨»è§£ | ç”¨é€” | è³‡æ–™ä¾†æº | é©ç”¨å ´æ™¯ |
|------|------|----------|----------|
| **@PathVariable** | è·¯å¾‘åƒæ•¸ | URL è·¯å¾‘ | RESTful è³‡æºè­˜åˆ¥ |
| **@RequestParam** | æŸ¥è©¢åƒæ•¸ | URL æŸ¥è©¢å­—ä¸² | æœå°‹æ¢ä»¶ã€åˆ†é åƒæ•¸ |
| **@RequestBody** | è«‹æ±‚é«”åƒæ•¸ | HTTP è«‹æ±‚é«” | JSON ç‰©ä»¶ã€è¤‡é›œè³‡æ–™ |
| **@RequestHeader** | è«‹æ±‚æ¨™é ­ | HTTP æ¨™é ­ | èªè­‰è³‡è¨Šã€å®¢æˆ¶ç«¯è³‡è¨Š |

### @PathVariable - è·¯å¾‘åƒæ•¸è™•ç†

è·¯å¾‘åƒæ•¸æ˜¯ RESTful API è¨­è¨ˆçš„æ ¸å¿ƒï¼Œç”¨æ–¼æ¨™è­˜ç‰¹å®šçš„è³‡æºï¼š

```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    private final UserService userService;
    
    public UserController(UserService userService) {
        this.userService = userService;
    }
    
    /**
     * ç²å–å–®ä¸€ä½¿ç”¨è€…è³‡è¨Š
     * URL: GET /api/users/123
     */
    @GetMapping("/{id}")
    public ResponseEntity<User> getUser(@PathVariable Long id) {
        User user = userService.findById(id);
        return ResponseEntity.ok(user);
    }
    
    /**
     * ç²å–ä½¿ç”¨è€…çš„ç‰¹å®šè¨‚å–®
     * URL: GET /api/users/123/orders/456
     */
    @GetMapping("/{userId}/orders/{orderId}")
    public ResponseEntity<Order> getUserOrder(
            @PathVariable Long userId,
            @PathVariable Long orderId) {
        Order order = orderService.findByUserIdAndOrderId(userId, orderId);
        return ResponseEntity.ok(order);
    }
}
```

### @RequestParam - æŸ¥è©¢åƒæ•¸è™•ç†

æŸ¥è©¢åƒæ•¸é©ç”¨æ–¼æœå°‹æ¢ä»¶ã€åˆ†é å’Œæ’åºç­‰å ´æ™¯ï¼š

```java
@RestController
@RequestMapping("/api/products")
public class ProductController {
    
    /**
     * å•†å“æœå°‹èˆ‡åˆ†é 
     * URL: GET /api/products?keyword=æ‰‹æ©Ÿ&page=1&size=10&sort=price
     */
    @GetMapping
    public ResponseEntity<Page<Product>> searchProducts(
            @RequestParam(required = false) String keyword,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size,
            @RequestParam(defaultValue = "id") String sort) {
        
        Pageable pageable = PageRequest.of(page, size, Sort.by(sort));
        Page<Product> products = productService.search(keyword, pageable);
        return ResponseEntity.ok(products);
    }
    
    /**
     * è¤‡é›œæŸ¥è©¢æ¢ä»¶
     * URL: GET /api/products?category=electronics&minPrice=100&maxPrice=1000
     */
    @GetMapping("/filter")
    public ResponseEntity<List<Product>> filterProducts(
            @RequestParam String category,
            @RequestParam(required = false) BigDecimal minPrice,
            @RequestParam(required = false) BigDecimal maxPrice) {
        
        List<Product> products = productService.filter(category, minPrice, maxPrice);
        return ResponseEntity.ok(products);
    }
}
```

### @RequestBody - è«‹æ±‚é«”åƒæ•¸è™•ç†

è«‹æ±‚é«”åƒæ•¸é©ç”¨æ–¼è¤‡é›œçš„è³‡æ–™çµæ§‹ï¼Œç‰¹åˆ¥æ˜¯ JSON ç‰©ä»¶ï¼š

```java
@RestController
@RequestMapping("/api/orders")
public class OrderController {
    
    /**
     * å»ºç«‹è¨‚å–®
     * æ¥æ”¶è¤‡é›œçš„ JSON ç‰©ä»¶
     */
    @PostMapping
    public ResponseEntity<Order> createOrder(@RequestBody CreateOrderRequest request) {
        Order order = orderService.createOrder(request);
        return ResponseEntity.status(HttpStatus.CREATED).body(order);
    }
    
    /**
     * æ‰¹é‡æ›´æ–°å•†å“
     * è™•ç†é™£åˆ—è³‡æ–™
     */
    @PutMapping("/batch")
    public ResponseEntity<List<Product>> batchUpdateProducts(
            @RequestBody List<UpdateProductRequest> requests) {
        List<Product> updatedProducts = productService.batchUpdate(requests);
        return ResponseEntity.ok(updatedProducts);
    }
}
```

---

## 2.3.2 çµ±ä¸€å›æ‡‰æ ¼å¼è¨­è¨ˆ

### ç‚ºä»€éº¼éœ€è¦æ¨™æº–åŒ–çš„ API å›æ‡‰æ ¼å¼ï¼Ÿ

çµ±ä¸€çš„å›æ‡‰æ ¼å¼èƒ½å¤ ï¼š
- æå‡å‰ç«¯è™•ç†çš„ä¸€è‡´æ€§
- ç°¡åŒ–éŒ¯èª¤è™•ç†é‚è¼¯
- æ”¹å–„ API çš„å¯ç¶­è­·æ€§
- ç‚º AI æœå‹™æä¾›æ¨™æº–åŒ–çš„è³‡æ–™ä»‹é¢

### åŸºç¤å›æ‡‰çµæ§‹è¨­è¨ˆ

```java
/**
 * çµ±ä¸€ API å›æ‡‰æ ¼å¼
 * é©ç”¨æ–¼æ‰€æœ‰ API ç«¯é»ï¼ŒåŒ…æ‹¬æœªä¾†çš„ AI æœå‹™
 */
public class ApiResponse<T> {
    
    /** å›æ‡‰ç‹€æ…‹ç¢¼ */
    private int code;
    
    /** å›æ‡‰è¨Šæ¯ */
    private String message;
    
    /** å›æ‡‰è³‡æ–™ */
    private T data;
    
    /** æ™‚é–“æˆ³è¨˜ */
    private long timestamp;
    
    /** è«‹æ±‚è¿½è¹¤ ID */
    private String traceId;
    
    // å»ºæ§‹å­
    private ApiResponse(int code, String message, T data) {
        this.code = code;
        this.message = message;
        this.data = data;
        this.timestamp = System.currentTimeMillis();
        this.traceId = UUID.randomUUID().toString();
    }
    
    /**
     * å»ºç«‹æˆåŠŸå›æ‡‰
     */
    public static <T> ApiResponse<T> success(T data) {
        return new ApiResponse<>(200, "æ“ä½œæˆåŠŸ", data);
    }
    
    public static <T> ApiResponse<T> success(String message, T data) {
        return new ApiResponse<>(200, message, data);
    }
    
    /**
     * å»ºç«‹éŒ¯èª¤å›æ‡‰
     */
    public static <T> ApiResponse<T> error(int code, String message) {
        return new ApiResponse<>(code, message, null);
    }
    
    public static <T> ApiResponse<T> error(String message) {
        return new ApiResponse<>(500, message, null);
    }
    
    // Getters and Setters
    // ...
}
```

### åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨çµ±ä¸€å›æ‡‰æ ¼å¼

```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    /**
     * ç²å–ä½¿ç”¨è€…åˆ—è¡¨
     */
    @GetMapping
    public ApiResponse<List<User>> getUsers() {
        List<User> users = userService.findAll();
        return ApiResponse.success("ç²å–ä½¿ç”¨è€…åˆ—è¡¨æˆåŠŸ", users);
    }
    
    /**
     * å»ºç«‹ä½¿ç”¨è€…
     */
    @PostMapping
    public ApiResponse<User> createUser(@RequestBody CreateUserRequest request) {
        User user = userService.createUser(request);
        return ApiResponse.success("ä½¿ç”¨è€…å»ºç«‹æˆåŠŸ", user);
    }
    
    /**
     * åˆªé™¤ä½¿ç”¨è€…
     */
    @DeleteMapping("/{id}")
    public ApiResponse<Void> deleteUser(@PathVariable Long id) {
        userService.deleteUser(id);
        return ApiResponse.success("ä½¿ç”¨è€…åˆªé™¤æˆåŠŸ", null);
    }
}
```

---

## 2.3.3 HTTP ç‹€æ…‹ç¢¼æœ€ä½³å¯¦è¸

### å¸¸ç”¨ç‹€æ…‹ç¢¼åŠå…¶æ‡‰ç”¨å ´æ™¯

| ç‹€æ…‹ç¢¼ | åç¨± | ä½¿ç”¨å ´æ™¯ | ç¯„ä¾‹ |
|--------|------|----------|------|
| **200** | OK | æˆåŠŸç²å–è³‡æº | GET /api/users |
| **201** | Created | æˆåŠŸå»ºç«‹è³‡æº | POST /api/users |
| **204** | No Content | æˆåŠŸä½†ç„¡å›æ‡‰å…§å®¹ | DELETE /api/users/1 |
| **400** | Bad Request | è«‹æ±‚åƒæ•¸éŒ¯èª¤ | ç¼ºå°‘å¿…è¦åƒæ•¸ |
| **401** | Unauthorized | æœªèªè­‰ | ç¼ºå°‘èªè­‰è³‡è¨Š |
| **403** | Forbidden | ç„¡æ¬Šé™ | æ¬Šé™ä¸è¶³ |
| **404** | Not Found | è³‡æºä¸å­˜åœ¨ | ä½¿ç”¨è€…ä¸å­˜åœ¨ |
| **500** | Internal Server Error | ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤ | ç³»çµ±ç•°å¸¸ |

### ResponseEntity çš„ä½¿ç”¨

```java
@RestController
@RequestMapping("/api/products")
public class ProductController {
    
    /**
     * ç²å–å•†å“è©³æƒ…
     */
    @GetMapping("/{id}")
    public ResponseEntity<ApiResponse<Product>> getProduct(@PathVariable Long id) {
        try {
            Product product = productService.findById(id);
            ApiResponse<Product> response = ApiResponse.success(product);
            return ResponseEntity.ok(response);
        } catch (ProductNotFoundException e) {
            ApiResponse<Product> response = ApiResponse.error(404, "å•†å“ä¸å­˜åœ¨");
            return ResponseEntity.status(HttpStatus.NOT_FOUND).body(response);
        }
    }
    
    /**
     * å»ºç«‹å•†å“
     */
    @PostMapping
    public ResponseEntity<ApiResponse<Product>> createProduct(
            @RequestBody CreateProductRequest request) {
        Product product = productService.createProduct(request);
        ApiResponse<Product> response = ApiResponse.success("å•†å“å»ºç«‹æˆåŠŸ", product);
        return ResponseEntity.status(HttpStatus.CREATED).body(response);
    }
}
```

---

## 2.3.4 å…¨åŸŸç•°å¸¸è™•ç†

### å»ºç«‹å…¨åŸŸç•°å¸¸è™•ç†å™¨

```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    /**
     * è™•ç†åƒæ•¸é©—è­‰ç•°å¸¸
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ApiResponse<Void>> handleValidationException(
            MethodArgumentNotValidException e) {
        
        StringBuilder message = new StringBuilder("åƒæ•¸é©—è­‰å¤±æ•—ï¼š");
        e.getBindingResult().getFieldErrors().forEach(error -> 
            message.append(error.getField()).append(" ").append(error.getDefaultMessage()).append("; ")
        );
        
        ApiResponse<Void> response = ApiResponse.error(400, message.toString());
        return ResponseEntity.badRequest().body(response);
    }
    
    /**
     * è™•ç†è³‡æºä¸å­˜åœ¨ç•°å¸¸
     */
    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<ApiResponse<Void>> handleResourceNotFoundException(
            ResourceNotFoundException e) {
        ApiResponse<Void> response = ApiResponse.error(404, e.getMessage());
        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(response);
    }
    
    /**
     * è™•ç†ä¸€èˆ¬ç•°å¸¸
     */
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiResponse<Void>> handleGeneralException(Exception e) {
        ApiResponse<Void> response = ApiResponse.error(500, "ç³»çµ±å…§éƒ¨éŒ¯èª¤");
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(response);
    }
}
```

---

## 2.3.5 ç‚º Spring AI åšæº–å‚™

### AI æœå‹™çš„ç‰¹æ®Šéœ€æ±‚

åœ¨è¨­è¨ˆ API è«‹æ±‚å›æ‡‰æ ¼å¼æ™‚ï¼Œæˆ‘å€‘éœ€è¦è€ƒæ…® Spring AI çš„ç‰¹æ®Šéœ€æ±‚ï¼š

**æµå¼å›æ‡‰æ”¯æ´**ï¼š
```java
@RestController
@RequestMapping("/api/ai")
public class AIController {
    
    /**
     * æµå¼å°è©± APIï¼ˆç‚º Spring AI é ç•™ï¼‰
     */
    @PostMapping(value = "/chat/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public SseEmitter chatStream(@RequestBody ChatRequest request) {
        SseEmitter emitter = new SseEmitter();
        // é ç•™çµ¦ Spring AI æµå¼è™•ç†
        return emitter;
    }
}
```

**å¤šåª’é«”å…§å®¹è™•ç†**ï¼š
```java
/**
 * å¤šåª’é«”è«‹æ±‚æ ¼å¼ï¼ˆç‚º AI è¦–è¦ºæœå‹™é ç•™ï¼‰
 */
public class MultimodalRequest {
    private String text;
    private String imageBase64;
    private String audioBase64;
    
    // Getters and Setters
}

@PostMapping("/analyze/multimodal")
public ResponseEntity<ApiResponse<AnalysisResult>> analyzeMultimodal(
        @RequestBody MultimodalRequest request) {
    // é ç•™çµ¦ Spring AI å¤šæ¨¡æ…‹åˆ†æ
    return ResponseEntity.ok(ApiResponse.success("åˆ†æå®Œæˆ", new AnalysisResult()));
}
```

**æ‰¹é‡è™•ç†æ”¯æ´**ï¼š
```java
/**
 * æ‰¹é‡è™•ç†è«‹æ±‚ï¼ˆé©åˆ AI æ‰¹é‡æ¨ç†ï¼‰
 */
@PostMapping("/batch/process")
public ResponseEntity<ApiResponse<List<ProcessResult>>> batchProcess(
        @RequestBody List<ProcessRequest> requests) {
    // é ç•™çµ¦ Spring AI æ‰¹é‡è™•ç†
    List<ProcessResult> results = new ArrayList<>();
    return ResponseEntity.ok(ApiResponse.success("æ‰¹é‡è™•ç†å®Œæˆ", results));
}
```

---

## ğŸ“ æœ¬ç« é‡é»å›é¡§

1. **åƒæ•¸è™•ç†**ï¼šæŒæ¡äº† @PathVariableã€@RequestParamã€@RequestBody çš„ä½¿ç”¨
2. **çµ±ä¸€å›æ‡‰æ ¼å¼**ï¼šå»ºç«‹äº†æ¨™æº–åŒ–çš„ API å›æ‡‰çµæ§‹
3. **HTTP ç‹€æ…‹ç¢¼**ï¼šå­¸æœƒäº†æ­£ç¢ºä½¿ç”¨å„ç¨®ç‹€æ…‹ç¢¼
4. **ç•°å¸¸è™•ç†**ï¼šå¯¦ç¾äº†å…¨åŸŸç•°å¸¸è™•ç†æ©Ÿåˆ¶
5. **AI æ•´åˆæº–å‚™**ï¼šç‚º Spring AI çš„ç‰¹æ®Šéœ€æ±‚åšå¥½äº†æ¶æ§‹æº–å‚™

### ä¸‹ä¸€æ­¥å­¸ç¿’æ–¹å‘

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘å€‘å°‡é€²å…¥ç¬¬ä¸‰ç« çš„ä¼æ¥­ç´šåŠŸèƒ½é–‹ç™¼ï¼Œå­¸ç¿’è³‡æ–™é©—è­‰ã€æª”æ¡ˆè™•ç†ç­‰é€²éšæŠ€è¡“ï¼Œé€²ä¸€æ­¥å®Œå–„æˆ‘å€‘çš„ API é–‹ç™¼æŠ€èƒ½ã€‚

---

**åƒè€ƒè³‡æ–™ï¼š**
- [Spring MVC Request Mapping](https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-ann-requestmapping)
- [HTTP Status Codes](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status)
- [Spring Boot Error Handling](https://docs.spring.io/spring-boot/docs/current/reference/html/web.html#web.servlet.spring-mvc.error-handling)