# 5.4 åšä¸€å€‹å­—å¹•ç”¢ç”Ÿå™¨

> **æœ¬ç« é‡é»**ï¼šå­¸ç¿’ä½¿ç”¨ Spring AI çš„èªéŸ³è½‰æ–‡å­—åŠŸèƒ½ï¼Œå»ºç«‹å®Œæ•´çš„å­—å¹•ç”¢ç”Ÿç³»çµ±ï¼ŒæŒæ¡éŸ³è¨Šè™•ç†å’Œå¤šæ ¼å¼å­—å¹•è¼¸å‡ºæŠ€è¡“ï¼Œç‚ºå¤šåª’é«”å…§å®¹è™•ç†æä¾›å°ˆæ¥­è§£æ±ºæ–¹æ¡ˆã€‚

## ğŸ¯ å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬ç« å­¸ç¿’å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š

- ğŸ¯ **ç†è§£èªéŸ³è½‰æ–‡å­—æŠ€è¡“**ï¼šæŒæ¡ Whisper æ¨¡å‹çš„å·¥ä½œåŸç†å’Œæ‡‰ç”¨å ´æ™¯
- ğŸ¯ **å¯¦ç¾éŸ³è¨Šæª”æ¡ˆè™•ç†**ï¼šå»ºç«‹å®Œæ•´çš„éŸ³è¨Šä¸Šå‚³å’Œè½‰è­¯åŠŸèƒ½
- ğŸ¯ **ç”Ÿæˆå¤šæ ¼å¼å­—å¹•**ï¼šæ”¯æ´ SRTã€VTTã€JSON ç­‰å¤šç¨®å­—å¹•æ ¼å¼
- ğŸ¯ **å„ªåŒ–è½‰è­¯å“è³ª**ï¼šæŒæ¡èªè¨€è¨­å®šã€æº«åº¦èª¿æ•´ç­‰å„ªåŒ–æŠ€å·§
- ğŸ¯ **ä¼æ¥­ç´šæ‡‰ç”¨è¨­è¨ˆ**ï¼šå»ºç«‹å¯å•†ç”¨çš„å­—å¹•ç”Ÿæˆæœå‹™ç³»çµ±

---

## 5.4.1 èªéŸ³è½‰æ–‡å­—æŠ€è¡“é©å‘½

### ä¸Šå­—å¹•ä¸å†ç—›è‹¦

![å­—å¹•ç”¢ç”Ÿå™¨](https://ithelp.ithome.com.tw/upload/images/20240810/20161290jCx3iLQjtI.jpg)

ç›¸ä¿¡å¾ˆå¤šäººçŸ¥é“ OpenAI é–‹æºäº† Whisper æ¨¡å‹ï¼Œç¶²è·¯ä¸Šä¹Ÿå¾ˆå¤šäººè£½ä½œæœ¬æ©Ÿç«¯çš„å­—å¹•ç”¢ç”Ÿç¨‹å¼ï¼Œå‡±æ–‡å¤§å”è©¦éï¼Œåªèƒ½èªªæ…˜ä¸å¿ç¹ï¼Œç”±æ–¼é›»è…¦æ²’æœ‰ç¨ç«‹é¡¯å¡ï¼Œä¸åˆ° 30 åˆ†é˜çš„å½±ç‰‡ç«Ÿç„¶ä¸€å€‹å°æ™‚é‚„æ²’å®Œæˆã€‚

é€™æ™‚å°±å¾ˆé©åˆç”¨å¹³å°çš„ç®—åŠ›ä¾†å”åŠ©äº†ï¼

### é›²ç«¯ vs æœ¬åœ°è™•ç†å°æ¯”

| è™•ç†æ–¹å¼ | å„ªå‹¢ | åŠ£å‹¢ | é©ç”¨å ´æ™¯ |
|----------|------|------|----------|
| **é›²ç«¯è™•ç†** | é€Ÿåº¦å¿«ã€å“è³ªé«˜ã€ç„¡ç¡¬é«”è¦æ±‚ | éœ€è¦ç¶²è·¯ã€æœ‰ä½¿ç”¨æˆæœ¬ | å•†æ¥­æ‡‰ç”¨ã€å¤§é‡è™•ç† |
| **æœ¬åœ°è™•ç†** | éš±ç§ä¿è­·ã€ç„¡ç¶²è·¯ä¾è³´ | é€Ÿåº¦æ…¢ã€ç¡¬é«”è¦æ±‚é«˜ | æ•æ„Ÿå…§å®¹ã€é›¢ç·šç’°å¢ƒ |

**æˆæœ¬æ•ˆç›Šåˆ†æ**ï¼š
- ğŸ• **æ™‚é–“æˆæœ¬**ï¼šé›²ç«¯è™•ç† 30 åˆ†é˜å½±ç‰‡ç´„ 2-3 åˆ†é˜ï¼Œæœ¬åœ°å¯èƒ½éœ€è¦ 1-2 å°æ™‚
- ğŸ’° **é‡‘éŒ¢æˆæœ¬**ï¼šOpenAI Whisper ç´„ $0.006/åˆ†é˜ï¼Œ22MB å››åˆ†å¤šé˜å½±ç‰‡ç´„ $0.03
- ğŸ”§ **ç¡¬é«”æˆæœ¬**ï¼šé›²ç«¯ç„¡éœ€æŠ•è³‡ GPUï¼Œæœ¬åœ°éœ€è¦é«˜éšé¡¯å¡

### Spring AI éŸ³è¨Šè½‰è­¯æ”¯æ´

![Spring AI éŸ³è¨Šæ”¯æ´](https://ithelp.ithome.com.tw/upload/images/20240807/201612904zZn4fPMwh.png)

éŸ³é »è½‰è­¯åœ¨ Spring AI çš„æ–‡ä»¶ä¸­ä¸»è¦æ”¯æ´ï¼š
- **OpenAI Whisper**ï¼šåŠŸèƒ½å®Œæ•´ï¼Œæ”¯æ´æ™‚é–“æˆ³è¨˜
- **Azure OpenAI**ï¼šä¼æ¥­ç´šéƒ¨ç½²ï¼Œåˆè¦æ€§ä½³
- **Groq**ï¼šé€Ÿåº¦å¿«ä½†åŠŸèƒ½å—é™ï¼ˆç„¡æ™‚é–“æˆ³è¨˜ï¼‰

**é‡è¦æé†’**ï¼šåŸæœ¬æƒ³èªªå¯ä»¥ç”¨ Groq çœéŒ¢ï¼Œä¸éå‡±æ–‡å¤§å”å¯¦éš›æ¸¬è©¦ç™¼ç¾ Groq é–¹å‰²äº†å¾ˆå¤šåŠŸèƒ½ï¼Œåªèƒ½ç”¢ç”Ÿç´”æ–‡å­—ï¼Œå­—å¹•æœ€é‡è¦çš„æ™‚é–“æˆ³è¨˜å»ç„¡æ³•ç”¢ç”Ÿï¼Œè‹¥å–®ç´”ç”¢ç”Ÿæ–‡å­—ç¨¿é‚„æ˜¯èƒ½ç”¨ï¼Œéœ€è¦æ™‚é–“æˆ³è¨˜å°±åªèƒ½èŠ±é»å°éŒ¢äº†ã€‚

---

## 5.4.2 å°ˆæ¡ˆå»ºç«‹èˆ‡é…ç½®

### Maven ä¾è³´é…ç½®

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0">
    <modelVersion>4.0.0</modelVersion>
    
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.3.0</version>
        <relativePath/>
    </parent>
    
    <groupId>com.example</groupId>
    <artifactId>subtitle-generator</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>subtitle-generator</name>
    <description>AI-powered subtitle generator using Spring AI</description>
    
    <properties>
        <java.version>17</java.version>
    </properties>
    
    <!-- ä½¿ç”¨ Spring AI BOM ç®¡ç†ç‰ˆæœ¬ -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>1.0.0</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>
    
    <dependencies>
        <!-- Spring AI OpenAI Starter -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-openai</artifactId>
        </dependency>
        
        <!-- Spring Boot Web -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        
        <!-- Spring Boot Validation -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
        
        <!-- File Processing -->
        <dependency>
            <groupId>org.apache.tika</groupId>
            <artifactId>tika-core</artifactId>
            <version>2.9.1</version>
        </dependency>
        
        <!-- JSON Processing -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
        </dependency>
        
        <!-- Lombok -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        
        <!-- Test Dependencies -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
</project>
```

### æ‡‰ç”¨ç¨‹å¼é…ç½®

```yaml
# application.yml
spring:
  application:
    name: subtitle-generator
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      base-url: https://api.openai.com
      audio:
        transcription:
          options:
            model: whisper-1
            response-format: verbose_json  # åŒ…å«æ™‚é–“æˆ³è¨˜çš„è©³ç´°æ ¼å¼
            temperature: 0.0  # æœ€ç¢ºå®šçš„çµæœ
            language: zh  # æŒ‡å®šä¸­æ–‡å¯æå‡æº–ç¢ºåº¦
            # timestamp-granularities åƒæ•¸éœ€åœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®š
  
  # æª”æ¡ˆä¸Šå‚³é…ç½®
  servlet:
    multipart:
      max-file-size: 25MB  # Whisper çš„æª”æ¡ˆå¤§å°é™åˆ¶
      max-request-size: 25MB
      enabled: true

# æ‡‰ç”¨ç¨‹å¼é…ç½®
app:
  subtitle:
    output-directory: ./subtitles
    supported-formats: ["srt", "vtt", "json", "txt"]
    max-duration: 3600  # æœ€å¤§è™•ç†æ™‚é•·ï¼ˆç§’ï¼‰
    default-language: zh

# ä¼ºæœå™¨é…ç½®
server:
  port: 8080
  servlet:
    context-path: /api

# æ—¥èªŒé…ç½®
logging:
  level:
    org.springframework.ai: DEBUG
    com.example: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
```

---

## 5.4.3 åŸºç¤å­—å¹•ç”ŸæˆåŠŸèƒ½

### éŸ³è¨Šè½‰è­¯æ§åˆ¶å™¨

```java
package com.example.controller;

import com.example.dto.SubtitleRequest;
import com.example.dto.SubtitleResponse;
import com.example.service.SubtitleGenerationService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.util.Arrays;
import java.util.List;

@RestController
@RequestMapping("/subtitle")
@RequiredArgsConstructor
@Slf4j
public class SubtitleController {
    
    private final SubtitleGenerationService subtitleService;
    
    /**
     * åŸºç¤å­—å¹•ç”Ÿæˆ
     * @param file éŸ³è¨Šæˆ–å½±ç‰‡æª”æ¡ˆ
     * @param format è¼¸å‡ºæ ¼å¼ï¼ˆsrt, vtt, json, txtï¼‰
     * @param language èªè¨€ä»£ç¢¼ï¼ˆå¯é¸ï¼‰
     * @return å­—å¹•å…§å®¹
     */
    @PostMapping(value = "/generate", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public ResponseEntity<SubtitleResponse> generateSubtitle(
            @RequestParam("file") MultipartFile file,
            @RequestParam(value = "format", defaultValue = "srt") String format,
            @RequestParam(value = "language", required = false) String language) {
        
        try {
            // é©—è­‰æª”æ¡ˆ
            validateAudioFile(file);
            
            log.info("é–‹å§‹è™•ç†å­—å¹•ç”Ÿæˆï¼šæª”æ¡ˆ={}, æ ¼å¼={}, èªè¨€={}", 
                    file.getOriginalFilename(), format, language);
            
            // ç”Ÿæˆå­—å¹•
            SubtitleResponse response = subtitleService.generateSubtitle(
                    file, format, language
            );
            
            log.info("å­—å¹•ç”Ÿæˆå®Œæˆï¼š{}", file.getOriginalFilename());
            
            return ResponseEntity.ok(response);
            
        } catch (Exception e) {
            log.error("å­—å¹•ç”Ÿæˆå¤±æ•—ï¼š{}", file.getOriginalFilename(), e);
            
            SubtitleResponse errorResponse = SubtitleResponse.builder()
                    .success(false)
                    .error(e.getMessage())
                    .fileName(file.getOriginalFilename())
                    .build();
            
            return ResponseEntity.badRequest().body(errorResponse);
        }
    }
    
    /**
     * é€²éšå­—å¹•ç”Ÿæˆï¼ˆæ”¯æ´æ›´å¤šé¸é …ï¼‰
     * @param file éŸ³è¨Šæª”æ¡ˆ
     * @param request ç”Ÿæˆé¸é …
     * @return å­—å¹•å›æ‡‰
     */
    @PostMapping(value = "/generate-advanced", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public ResponseEntity<SubtitleResponse> generateAdvancedSubtitle(
            @RequestParam("file") MultipartFile file,
            @ModelAttribute SubtitleRequest request) {
        
        try {
            validateAudioFile(file);
            
            log.info("é–‹å§‹é€²éšå­—å¹•ç”Ÿæˆï¼š{}", request);
            
            SubtitleResponse response = subtitleService.generateAdvancedSubtitle(
                    file, request
            );
            
            return ResponseEntity.ok(response);
            
        } catch (Exception e) {
            log.error("é€²éšå­—å¹•ç”Ÿæˆå¤±æ•—", e);
            
            SubtitleResponse errorResponse = SubtitleResponse.builder()
                    .success(false)
                    .error(e.getMessage())
                    .fileName(file.getOriginalFilename())
                    .build();
            
            return ResponseEntity.badRequest().body(errorResponse);
        }
    }
    
    /**
     * æ‰¹æ¬¡å­—å¹•ç”Ÿæˆ
     * @param files å¤šå€‹éŸ³è¨Šæª”æ¡ˆ
     * @param format è¼¸å‡ºæ ¼å¼
     * @return æ‰¹æ¬¡è™•ç†çµæœ
     */
    @PostMapping(value = "/batch-generate", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public ResponseEntity<List<SubtitleResponse>> batchGenerateSubtitles(
            @RequestParam("files") MultipartFile[] files,
            @RequestParam(value = "format", defaultValue = "srt") String format) {
        
        try {
            log.info("é–‹å§‹æ‰¹æ¬¡å­—å¹•ç”Ÿæˆï¼š{} å€‹æª”æ¡ˆ", files.length);
            
            List<SubtitleResponse> responses = subtitleService.batchGenerateSubtitles(
                    Arrays.asList(files), format
            );
            
            return ResponseEntity.ok(responses);
            
        } catch (Exception e) {
            log.error("æ‰¹æ¬¡å­—å¹•ç”Ÿæˆå¤±æ•—", e);
            return ResponseEntity.badRequest().build();
        }
    }
    
    /**
     * é©—è­‰éŸ³è¨Šæª”æ¡ˆ
     */
    private void validateAudioFile(MultipartFile file) {
        if (file.isEmpty()) {
            throw new IllegalArgumentException("æª”æ¡ˆä¸èƒ½ç‚ºç©º");
        }
        
        // æª¢æŸ¥æª”æ¡ˆå¤§å°ï¼ˆ25MB é™åˆ¶ï¼‰
        if (file.getSize() > 25 * 1024 * 1024) {
            throw new IllegalArgumentException("æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 25MB");
        }
        
        // æª¢æŸ¥æª”æ¡ˆæ ¼å¼
        String contentType = file.getContentType();
        if (contentType == null || !isValidAudioFormat(contentType)) {
            throw new IllegalArgumentException(
                "ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼Œè«‹ä¸Šå‚³ MP3ã€WAVã€M4Aã€MP4 æˆ– WEBM æ ¼å¼"
            );
        }
    }
    
    private boolean isValidAudioFormat(String contentType) {
        return contentType.startsWith("audio/") || 
               contentType.equals("video/mp4") ||
               contentType.equals("video/webm");
    }
}
```

### å­—å¹•ç”Ÿæˆæœå‹™

```java
package com.example.service;

import com.example.dto.SubtitleRequest;
import com.example.dto.SubtitleResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.audio.transcription.AudioTranscriptionModel;
import org.springframework.ai.audio.transcription.AudioTranscriptionPrompt;
import org.springframework.ai.audio.transcription.AudioTranscriptionResponse;
import org.springframework.ai.openai.OpenAiAudioTranscriptionOptions;
import org.springframework.core.io.ByteArrayResource;
import org.springframework.core.io.Resource;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.time.LocalDateTime;
import java.util.List;
import java.util.concurrent.CompletableFuture;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Slf4j
public class SubtitleGenerationService {
    
    private final AudioTranscriptionModel transcriptionModel;
    private final SubtitleFormatterService formatterService;
    
    /**
     * åŸºç¤å­—å¹•ç”Ÿæˆ
     * @param file éŸ³è¨Šæª”æ¡ˆ
     * @param format è¼¸å‡ºæ ¼å¼
     * @param language èªè¨€ï¼ˆå¯é¸ï¼‰
     * @return å­—å¹•å›æ‡‰
     */
    public SubtitleResponse generateSubtitle(
            MultipartFile file, 
            String format, 
            String language) {
        
        try {
            // å»ºç«‹è½‰è­¯é¸é …
            OpenAiAudioTranscriptionOptions options = OpenAiAudioTranscriptionOptions.builder()
                    .withModel("whisper-1")
                    .withResponseFormat("verbose_json")  // åŒ…å«æ™‚é–“æˆ³è¨˜
                    .withTemperature(0.0f)
                    .withLanguage(language != null ? language : "zh")
                    .withTimestampGranularities(List.of("word", "segment"))
                    .build();
            
            // å»ºç«‹éŸ³è¨Šè³‡æº
            Resource audioResource = createAudioResource(file);
            
            // å»ºç«‹è½‰è­¯è«‹æ±‚
            AudioTranscriptionPrompt prompt = new AudioTranscriptionPrompt(
                    audioResource, options
            );
            
            // åŸ·è¡Œè½‰è­¯
            AudioTranscriptionResponse response = transcriptionModel.call(prompt);
            String transcriptionResult = response.getResult().getOutput();
            
            // æ ¼å¼åŒ–å­—å¹•
            String formattedSubtitle = formatterService.formatSubtitle(
                    transcriptionResult, format
            );
            
            return SubtitleResponse.builder()
                    .success(true)
                    .fileName(file.getOriginalFilename())
                    .format(format)
                    .language(language != null ? language : "zh")
                    .content(formattedSubtitle)
                    .fileSize(file.getSize())
                    .processingTime(calculateProcessingTime())
                    .timestamp(LocalDateTime.now())
                    .build();
            
        } catch (Exception e) {
            log.error("å­—å¹•ç”Ÿæˆå¤±æ•—ï¼š{}", file.getOriginalFilename(), e);
            throw new RuntimeException("å­—å¹•ç”Ÿæˆå¤±æ•—ï¼š" + e.getMessage(), e);
        }
    }
    
    /**
     * é€²éšå­—å¹•ç”Ÿæˆ
     * @param file éŸ³è¨Šæª”æ¡ˆ
     * @param request ç”Ÿæˆé¸é …
     * @return å­—å¹•å›æ‡‰
     */
    public SubtitleResponse generateAdvancedSubtitle(
            MultipartFile file, 
            SubtitleRequest request) {
        
        try {
            // å»ºç«‹é€²éšè½‰è­¯é¸é …
            OpenAiAudioTranscriptionOptions options = OpenAiAudioTranscriptionOptions.builder()
                    .withModel("whisper-1")
                    .withResponseFormat("verbose_json")
                    .withTemperature(request.getTemperature())
                    .withLanguage(request.getLanguage())
                    .withTimestampGranularities(request.getTimestampGranularities())
                    .build();
            
            // å¦‚æœæœ‰æç¤ºè©ï¼ŒåŠ å…¥æç¤º
            if (request.getPrompt() != null && !request.getPrompt().isEmpty()) {
                options = options.toBuilder()
                        .withPrompt(request.getPrompt())
                        .build();
            }
            
            // å»ºç«‹éŸ³è¨Šè³‡æº
            Resource audioResource = createAudioResource(file);
            
            AudioTranscriptionPrompt prompt = new AudioTranscriptionPrompt(
                    audioResource, options
            );
            
            AudioTranscriptionResponse response = transcriptionModel.call(prompt);
            String transcriptionResult = response.getResult().getOutput();
            
            // æ ¼å¼åŒ–å­—å¹•
            String formattedSubtitle = formatterService.formatSubtitle(
                    transcriptionResult, request.getFormat()
            );
            
            return SubtitleResponse.builder()
                    .success(true)
                    .fileName(file.getOriginalFilename())
                    .format(request.getFormat())
                    .language(request.getLanguage())
                    .content(formattedSubtitle)
                    .fileSize(file.getSize())
                    .temperature(request.getTemperature())
                    .prompt(request.getPrompt())
                    .processingTime(calculateProcessingTime())
                    .timestamp(LocalDateTime.now())
                    .build();
            
        } catch (Exception e) {
            log.error("é€²éšå­—å¹•ç”Ÿæˆå¤±æ•—ï¼š{}", file.getOriginalFilename(), e);
            throw new RuntimeException("é€²éšå­—å¹•ç”Ÿæˆå¤±æ•—ï¼š" + e.getMessage(), e);
        }
    }
    
    /**
     * æ‰¹æ¬¡å­—å¹•ç”Ÿæˆ
     * @param files æª”æ¡ˆåˆ—è¡¨
     * @param format è¼¸å‡ºæ ¼å¼
     * @return æ‰¹æ¬¡è™•ç†çµæœ
     */
    public List<SubtitleResponse> batchGenerateSubtitles(
            List<MultipartFile> files, 
            String format) {
        
        log.info("é–‹å§‹æ‰¹æ¬¡è™•ç† {} å€‹æª”æ¡ˆ", files.size());
        
        List<CompletableFuture<SubtitleResponse>> futures = files.stream()
                .map(file -> CompletableFuture.supplyAsync(() -> {
                    try {
                        return generateSubtitle(file, format, null);
                    } catch (Exception e) {
                        log.error("æ‰¹æ¬¡è™•ç†å¤±æ•—ï¼š{}", file.getOriginalFilename(), e);
                        return SubtitleResponse.builder()
                                .success(false)
                                .fileName(file.getOriginalFilename())
                                .error(e.getMessage())
                                .build();
                    }
                }))
                .collect(Collectors.toList());
        
        // ç­‰å¾…æ‰€æœ‰ä»»å‹™å®Œæˆ
        CompletableFuture<Void> allFutures = CompletableFuture.allOf(
                futures.toArray(new CompletableFuture[0])
        );
        
        return allFutures.thenApply(v -> 
                futures.stream()
                        .map(CompletableFuture::join)
                        .collect(Collectors.toList())
        ).join();
    }
    
    private long calculateProcessingTime() {
        // å¯¦éš›å¯¦ç¾ä¸­æ‡‰è©²è¨˜éŒ„é–‹å§‹æ™‚é–“ä¸¦è¨ˆç®—å·®å€¼
        return System.currentTimeMillis();
    }
    
    /**
     * å»ºç«‹éŸ³è¨Šè³‡æº
     * @param file MultipartFile æª”æ¡ˆ
     * @return Resource éŸ³è¨Šè³‡æº
     */
    private Resource createAudioResource(MultipartFile file) {
        try {
            return new ByteArrayResource(file.getBytes()) {
                @Override
                public String getFilename() {
                    return file.getOriginalFilename();
                }
            };
        } catch (IOException e) {
            throw new RuntimeException("å»ºç«‹éŸ³è¨Šè³‡æºå¤±æ•—ï¼š" + e.getMessage(), e);
        }
    }
}
```

---

## 5.4.4 å¤šæ ¼å¼å­—å¹•è¼¸å‡º

### å­—å¹•æ ¼å¼åŒ–æœå‹™

```java
package com.example.service;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.time.Duration;
import java.util.List;

@Service
@RequiredArgsConstructor
@Slf4j
public class SubtitleFormatterService {
    
    private final ObjectMapper objectMapper;
    
    /**
     * æ ¼å¼åŒ–å­—å¹•ç‚ºæŒ‡å®šæ ¼å¼
     * @param transcriptionJson Whisper å›å‚³çš„ JSON çµæœ
     * @param format ç›®æ¨™æ ¼å¼
     * @return æ ¼å¼åŒ–å¾Œçš„å­—å¹•å…§å®¹
     */
    public String formatSubtitle(String transcriptionJson, String format) {
        try {
            JsonNode jsonNode = objectMapper.readTree(transcriptionJson);
            
            return switch (format.toLowerCase()) {
                case "srt" -> formatToSRT(jsonNode);
                case "vtt" -> formatToVTT(jsonNode);
                case "json" -> formatToJSON(jsonNode);
                case "txt" -> formatToTXT(jsonNode);
                default -> throw new IllegalArgumentException("ä¸æ”¯æ´çš„æ ¼å¼ï¼š" + format);
            };
            
        } catch (Exception e) {
            log.error("å­—å¹•æ ¼å¼åŒ–å¤±æ•—", e);
            throw new RuntimeException("å­—å¹•æ ¼å¼åŒ–å¤±æ•—ï¼š" + e.getMessage(), e);
        }
    }
    
    /**
     * æ ¼å¼åŒ–ç‚º SRT æ ¼å¼
     */
    private String formatToSRT(JsonNode jsonNode) {
        StringBuilder srt = new StringBuilder();
        JsonNode segments = jsonNode.get("segments");
        
        if (segments != null && segments.isArray()) {
            int index = 1;
            for (JsonNode segment : segments) {
                double start = segment.get("start").asDouble();
                double end = segment.get("end").asDouble();
                String text = segment.get("text").asText().trim();
                
                if (!text.isEmpty()) {
                    srt.append(index++).append("\n");
                    srt.append(formatTime(start)).append(" --> ").append(formatTime(end)).append("\n");
                    srt.append(text).append("\n\n");
                }
            }
        }
        
        return srt.toString();
    }
    
    /**
     * æ ¼å¼åŒ–ç‚º VTT æ ¼å¼
     */
    private String formatToVTT(JsonNode jsonNode) {
        StringBuilder vtt = new StringBuilder();
        vtt.append("WEBVTT\n\n");
        
        JsonNode segments = jsonNode.get("segments");
        
        if (segments != null && segments.isArray()) {
            for (JsonNode segment : segments) {
                double start = segment.get("start").asDouble();
                double end = segment.get("end").asDouble();
                String text = segment.get("text").asText().trim();
                
                if (!text.isEmpty()) {
                    vtt.append(formatTimeVTT(start)).append(" --> ").append(formatTimeVTT(end)).append("\n");
                    vtt.append(text).append("\n\n");
                }
            }
        }
        
        return vtt.toString();
    }
    
    /**
     * æ ¼å¼åŒ–ç‚º JSON æ ¼å¼ï¼ˆçµæ§‹åŒ–ï¼‰
     */
    private String formatToJSON(JsonNode jsonNode) {
        try {
            // å»ºç«‹çµæ§‹åŒ–çš„å­—å¹• JSON
            SubtitleData subtitleData = new SubtitleData();
            subtitleData.setLanguage(jsonNode.get("language").asText());
            subtitleData.setDuration(jsonNode.get("duration").asDouble());
            
            JsonNode segments = jsonNode.get("segments");
            if (segments != null && segments.isArray()) {
                for (JsonNode segment : segments) {
                    SubtitleSegment subtitleSegment = new SubtitleSegment();
                    subtitleSegment.setStart(segment.get("start").asDouble());
                    subtitleSegment.setEnd(segment.get("end").asDouble());
                    subtitleSegment.setText(segment.get("text").asText().trim());
                    
                    // å¦‚æœæœ‰è©ç´šæ™‚é–“æˆ³è¨˜
                    JsonNode words = segment.get("words");
                    if (words != null && words.isArray()) {
                        for (JsonNode word : words) {
                            SubtitleWord subtitleWord = new SubtitleWord();
                            subtitleWord.setWord(word.get("word").asText());
                            subtitleWord.setStart(word.get("start").asDouble());
                            subtitleWord.setEnd(word.get("end").asDouble());
                            subtitleSegment.getWords().add(subtitleWord);
                        }
                    }
                    
                    subtitleData.getSegments().add(subtitleSegment);
                }
            }
            
            return objectMapper.writerWithDefaultPrettyPrinter()
                    .writeValueAsString(subtitleData);
            
        } catch (Exception e) {
            log.error("JSON æ ¼å¼åŒ–å¤±æ•—", e);
            return jsonNode.toPrettyString();
        }
    }
    
    /**
     * æ ¼å¼åŒ–ç‚ºç´”æ–‡å­—æ ¼å¼
     */
    private String formatToTXT(JsonNode jsonNode) {
        StringBuilder txt = new StringBuilder();
        JsonNode segments = jsonNode.get("segments");
        
        if (segments != null && segments.isArray()) {
            for (JsonNode segment : segments) {
                String text = segment.get("text").asText().trim();
                if (!text.isEmpty()) {
                    txt.append(text).append(" ");
                }
            }
        }
        
        return txt.toString().trim();
    }
    
    /**
     * æ ¼å¼åŒ–æ™‚é–“ç‚º SRT æ ¼å¼ (HH:MM:SS,mmm)
     */
    private String formatTime(double seconds) {
        Duration duration = Duration.ofMillis((long) (seconds * 1000));
        long hours = duration.toHours();
        long minutes = duration.toMinutesPart();
        long secs = duration.toSecondsPart();
        long millis = duration.toMillisPart();
        
        return String.format("%02d:%02d:%02d,%03d", hours, minutes, secs, millis);
    }
    
    /**
     * æ ¼å¼åŒ–æ™‚é–“ç‚º VTT æ ¼å¼ (HH:MM:SS.mmm)
     */
    private String formatTimeVTT(double seconds) {
        Duration duration = Duration.ofMillis((long) (seconds * 1000));
        long hours = duration.toHours();
        long minutes = duration.toMinutesPart();
        long secs = duration.toSecondsPart();
        long millis = duration.toMillisPart();
        
        return String.format("%02d:%02d:%02d.%03d", hours, minutes, secs, millis);
    }
}
```

### å­—å¹•è³‡æ–™çµæ§‹

```java
package com.example.dto;

import lombok.Data;
import java.util.ArrayList;
import java.util.List;

@Data
public class SubtitleData {
    private String language;
    private Double duration;
    private List<SubtitleSegment> segments = new ArrayList<>();
}

@Data
public class SubtitleSegment {
    private Double start;
    private Double end;
    private String text;
    private List<SubtitleWord> words = new ArrayList<>();
}

@Data
public class SubtitleWord {
    private String word;
    private Double start;
    private Double end;
}
```

---

## 5.4.5 è«‹æ±‚å’Œå›æ‡‰ DTO

### å­—å¹•è«‹æ±‚ DTO

```java
package com.example.dto;

import lombok.Data;
import javax.validation.constraints.*;
import java.util.List;

@Data
public class SubtitleRequest {
    
    @NotBlank(message = "è¼¸å‡ºæ ¼å¼ä¸èƒ½ç‚ºç©º")
    @Pattern(regexp = "^(srt|vtt|json|txt)$", message = "æ ¼å¼å¿…é ˆæ˜¯ srtã€vttã€json æˆ– txt")
    private String format = "srt";
    
    @Pattern(regexp = "^[a-z]{2}$", message = "èªè¨€ä»£ç¢¼å¿…é ˆæ˜¯å…©ä½å­—æ¯")
    private String language = "zh";
    
    @DecimalMin(value = "0.0", message = "æº«åº¦å€¼å¿…é ˆå¤§æ–¼ç­‰æ–¼ 0")
    @DecimalMax(value = "1.0", message = "æº«åº¦å€¼å¿…é ˆå°æ–¼ç­‰æ–¼ 1")
    private Float temperature = 0.0f;
    
    @Size(max = 224, message = "æç¤ºè©ä¸èƒ½è¶…é 224 å€‹å­—å…ƒ")
    private String prompt;
    
    private List<String> timestampGranularities = List.of("segment");
    
    private Boolean includeWordTimestamps = false;
    
    private String model = "whisper-1";
}
```

### å­—å¹•å›æ‡‰ DTO

```java
package com.example.dto;

import lombok.Builder;
import lombok.Data;
import java.time.LocalDateTime;

@Data
@Builder
public class SubtitleResponse {
    
    private boolean success;
    private String fileName;
    private String format;
    private String language;
    private String content;
    private Long fileSize;
    private Float temperature;
    private String prompt;
    private String model;
    private Long processingTime;
    private String error;
    private LocalDateTime timestamp;
    
    // çµ±è¨ˆè³‡è¨Š
    private Integer segmentCount;
    private Integer wordCount;
    private Double audioDuration;
    
    /**
     * å»ºç«‹æˆåŠŸå›æ‡‰
     */
    public static SubtitleResponse success(String fileName, String format, String content) {
        return SubtitleResponse.builder()
                .success(true)
                .fileName(fileName)
                .format(format)
                .content(content)
                .timestamp(LocalDateTime.now())
                .build();
    }
    
    /**
     * å»ºç«‹éŒ¯èª¤å›æ‡‰
     */
    public static SubtitleResponse error(String fileName, String error) {
        return SubtitleResponse.builder()
                .success(false)
                .fileName(fileName)
                .error(error)
                .timestamp(LocalDateTime.now())
                .build();
    }
}
```

---

## 5.4.6 é€²éšåŠŸèƒ½å¯¦ç¾

### å­—å¹•æª”æ¡ˆä¸‹è¼‰æœå‹™

```java
package com.example.service;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.io.ByteArrayResource;
import org.springframework.core.io.Resource;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;

import java.nio.charset.StandardCharsets;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

@Service
@RequiredArgsConstructor
@Slf4j
public class SubtitleDownloadService {
    
    @Value("${app.subtitle.output-directory:./subtitles}")
    private String outputDirectory;
    
    /**
     * å»ºç«‹å­—å¹•æª”æ¡ˆä¸‹è¼‰å›æ‡‰
     * @param content å­—å¹•å…§å®¹
     * @param fileName åŸå§‹æª”æ¡ˆåç¨±
     * @param format å­—å¹•æ ¼å¼
     * @return ä¸‹è¼‰å›æ‡‰
     */
    public ResponseEntity<Resource> createDownloadResponse(
            String content, 
            String fileName, 
            String format) {
        
        try {
            // ç”Ÿæˆä¸‹è¼‰æª”æ¡ˆåç¨±
            String downloadFileName = generateDownloadFileName(fileName, format);
            
            // å»ºç«‹è³‡æº
            ByteArrayResource resource = new ByteArrayResource(
                    content.getBytes(StandardCharsets.UTF_8)
            );
            
            // è¨­å®š Content-Type
            MediaType mediaType = getMediaTypeForFormat(format);
            
            return ResponseEntity.ok()
                    .header(HttpHeaders.CONTENT_DISPOSITION, 
                           "attachment; filename=\"" + downloadFileName + "\"")
                    .contentType(mediaType)
                    .contentLength(resource.contentLength())
                    .body(resource);
            
        } catch (Exception e) {
            log.error("å»ºç«‹ä¸‹è¼‰å›æ‡‰å¤±æ•—", e);
            throw new RuntimeException("å»ºç«‹ä¸‹è¼‰å›æ‡‰å¤±æ•—ï¼š" + e.getMessage(), e);
        }
    }
    
    /**
     * ç”Ÿæˆä¸‹è¼‰æª”æ¡ˆåç¨±
     */
    private String generateDownloadFileName(String originalFileName, String format) {
        String baseName = originalFileName;
        
        // ç§»é™¤åŸå§‹å‰¯æª”å
        int lastDotIndex = baseName.lastIndexOf('.');
        if (lastDotIndex > 0) {
            baseName = baseName.substring(0, lastDotIndex);
        }
        
        // æ·»åŠ æ™‚é–“æˆ³è¨˜
        String timestamp = LocalDateTime.now().format(
                DateTimeFormatter.ofPattern("yyyyMMdd_HHmmss")
        );
        
        return String.format("%s_å­—å¹•_%s.%s", baseName, timestamp, format);
    }
    
    /**
     * æ ¹æ“šæ ¼å¼ç²å– MediaType
     */
    private MediaType getMediaTypeForFormat(String format) {
        return switch (format.toLowerCase()) {
            case "srt" -> MediaType.parseMediaType("application/x-subrip");
            case "vtt" -> MediaType.parseMediaType("text/vtt");
            case "json" -> MediaType.APPLICATION_JSON;
            case "txt" -> MediaType.TEXT_PLAIN;
            default -> MediaType.APPLICATION_OCTET_STREAM;
        };
    }
}
```

### å­—å¹•å“è³ªå„ªåŒ–æœå‹™

```java
package com.example.service;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.regex.Pattern;

@Service
@RequiredArgsConstructor
@Slf4j
public class SubtitleOptimizationService {
    
    /**
     * å„ªåŒ–å­—å¹•å…§å®¹
     * @param content åŸå§‹å­—å¹•å…§å®¹
     * @param language èªè¨€
     * @return å„ªåŒ–å¾Œçš„å­—å¹•å…§å®¹
     */
    public String optimizeSubtitleContent(String content, String language) {
        String optimized = content;
        
        // ç§»é™¤å¤šé¤˜ç©ºç™½
        optimized = removeExtraWhitespace(optimized);
        
        // ä¿®æ­£æ¨™é»ç¬¦è™Ÿ
        optimized = fixPunctuation(optimized, language);
        
        // åˆä½µçŸ­å¥
        optimized = mergeShortSentences(optimized);
        
        // åˆ†å‰²é•·å¥
        optimized = splitLongSentences(optimized);
        
        return optimized;
    }
    
    /**
     * ç§»é™¤å¤šé¤˜ç©ºç™½
     */
    private String removeExtraWhitespace(String content) {
        return content.replaceAll("\\s+", " ").trim();
    }
    
    /**
     * ä¿®æ­£æ¨™é»ç¬¦è™Ÿ
     */
    private String fixPunctuation(String content, String language) {
        if ("zh".equals(language)) {
            // ä¸­æ–‡æ¨™é»ç¬¦è™Ÿä¿®æ­£
            content = content.replaceAll("\\s*,\\s*", "ï¼Œ");
            content = content.replaceAll("\\s*\\.\\s*", "ã€‚");
            content = content.replaceAll("\\s*\\?\\s*", "ï¼Ÿ");
            content = content.replaceAll("\\s*!\\s*", "ï¼");
        }
        
        return content;
    }
    
    /**
     * åˆä½µçŸ­å¥
     */
    private String mergeShortSentences(String content) {
        // å¦‚æœå¥å­å¤ªçŸ­ï¼ˆå°‘æ–¼10å€‹å­—å…ƒï¼‰ï¼Œå˜—è©¦èˆ‡ä¸‹ä¸€å¥åˆä½µ
        String[] sentences = content.split("[ã€‚ï¼ï¼Ÿ.!?]");
        StringBuilder merged = new StringBuilder();
        
        for (int i = 0; i < sentences.length; i++) {
            String sentence = sentences[i].trim();
            if (sentence.length() < 10 && i < sentences.length - 1) {
                // åˆä½µçŸ­å¥
                sentence += sentences[++i].trim();
            }
            if (!sentence.isEmpty()) {
                merged.append(sentence).append("ã€‚");
            }
        }
        
        return merged.toString();
    }
    
    /**
     * åˆ†å‰²é•·å¥
     */
    private String splitLongSentences(String content) {
        // å¦‚æœå¥å­å¤ªé•·ï¼ˆè¶…é50å€‹å­—å…ƒï¼‰ï¼Œå˜—è©¦åœ¨é©ç•¶ä½ç½®åˆ†å‰²
        return content.replaceAll("([ï¼Œ,])(?=.{20,})", "$1\n");
    }
    
    /**
     * é©—è­‰å­—å¹•å“è³ª
     * @param content å­—å¹•å…§å®¹
     * @return å“è³ªè©•åˆ†ï¼ˆ0-100ï¼‰
     */
    public int evaluateSubtitleQuality(String content) {
        int score = 100;
        
        // æª¢æŸ¥æ˜¯å¦æœ‰æ˜é¡¯éŒ¯èª¤
        if (content.contains("[éŸ³æ¨‚]") || content.contains("[æŒè²]")) {
            score -= 10;  // åŒ…å«éŸ³æ•ˆæ¨™è¨˜
        }
        
        if (Pattern.compile("[a-zA-Z]{10,}").matcher(content).find()) {
            score -= 15;  // åŒ…å«é•·è‹±æ–‡å–®è©ï¼ˆå¯èƒ½æ˜¯éŒ¯èª¤è­˜åˆ¥ï¼‰
        }
        
        if (content.length() < 10) {
            score -= 30;  // å…§å®¹å¤ªçŸ­
        }
        
        // æª¢æŸ¥æ¨™é»ç¬¦è™Ÿæ¯”ä¾‹
        long punctuationCount = content.chars()
                .filter(ch -> "ï¼Œã€‚ï¼ï¼Ÿ,.!?".indexOf(ch) >= 0)
                .count();
        
        double punctuationRatio = (double) punctuationCount / content.length();
        if (punctuationRatio < 0.05) {
            score -= 20;  // æ¨™é»ç¬¦è™Ÿå¤ªå°‘
        }
        
        return Math.max(0, score);
    }
}
```

---

## 5.4.7 Web ä»‹é¢å¯¦ç¾

### å­—å¹•ç”Ÿæˆé é¢

```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å­—å¹•ç”¢ç”Ÿå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 800px;
            width: 90%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1rem;
        }
        
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .upload-area.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 15px;
        }
        
        .upload-text {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            color: #999;
            font-size: 0.9rem;
        }
        
        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .option-group {
            display: flex;
            flex-direction: column;
        }
        
        .option-group label {
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .option-group select,
        .option-group input {
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .option-group select:focus,
        .option-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .generate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .progress {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .result {
            display: none;
            margin-top: 20px;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .result-title {
            color: #333;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .download-btn {
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }
        
        .download-btn:hover {
            background: #218838;
        }
        
        .result-content {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .options {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ AI å­—å¹•ç”¢ç”Ÿå™¨</h1>
            <p>ä¸Šå‚³éŸ³è¨Šæˆ–å½±ç‰‡æª”æ¡ˆï¼ŒAI è‡ªå‹•ç”Ÿæˆé«˜å“è³ªå­—å¹•</p>
        </div>
        
        <form id="subtitleForm" enctype="multipart/form-data">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">é»æ“Šé¸æ“‡æª”æ¡ˆæˆ–æ‹–æ‹½åˆ°æ­¤è™•</div>
                <div class="upload-hint">æ”¯æ´ MP3ã€WAVã€M4Aã€MP4ã€WEBM æ ¼å¼ï¼Œæœ€å¤§ 25MB</div>
                <input type="file" id="fileInput" name="file" accept="audio/*,video/*" style="display: none;">
            </div>
            
            <div class="options">
                <div class="option-group">
                    <label for="format">å­—å¹•æ ¼å¼</label>
                    <select id="format" name="format">
                        <option value="srt">SRT (æœ€å¸¸ç”¨)</option>
                        <option value="vtt">VTT (ç¶²é å­—å¹•)</option>
                        <option value="json">JSON (çµæ§‹åŒ–)</option>
                        <option value="txt">TXT (ç´”æ–‡å­—)</option>
                    </select>
                </div>
                
                <div class="option-group">
                    <label for="language">èªè¨€</label>
                    <select id="language" name="language">
                        <option value="zh">ä¸­æ–‡</option>
                        <option value="en">English</option>
                        <option value="ja">æ—¥æœ¬èª</option>
                        <option value="ko">í•œêµ­ì–´</option>
                        <option value="auto">è‡ªå‹•åµæ¸¬</option>
                    </select>
                </div>
            </div>
            
            <button type="submit" class="generate-btn" id="generateBtn">
                ğŸš€ é–‹å§‹ç”Ÿæˆå­—å¹•
            </button>
        </form>
        
        <div class="progress" id="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText">æ­£åœ¨è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>
        </div>
        
        <div class="result" id="result">
            <div class="result-header">
                <div class="result-title">âœ… å­—å¹•ç”Ÿæˆå®Œæˆ</div>
                <button class="download-btn" id="downloadBtn">ğŸ“¥ ä¸‹è¼‰å­—å¹•</button>
            </div>
            <div class="result-content" id="resultContent"></div>
        </div>
    </div>
    
    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const form = document.getElementById('subtitleForm');
        const generateBtn = document.getElementById('generateBtn');
        const progress = document.getElementById('progress');
        const result = document.getElementById('result');
        const resultContent = document.getElementById('resultContent');
        const downloadBtn = document.getElementById('downloadBtn');
        
        let currentSubtitleData = null;
        
        // æª”æ¡ˆä¸Šå‚³å€åŸŸäº‹ä»¶
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);
        
        fileInput.addEventListener('change', handleFileSelect);
        form.addEventListener('submit', handleSubmit);
        downloadBtn.addEventListener('click', handleDownload);
        
        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                updateUploadArea(files[0]);
            }
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                updateUploadArea(file);
            }
        }
        
        function updateUploadArea(file) {
            const uploadText = uploadArea.querySelector('.upload-text');
            const uploadHint = uploadArea.querySelector('.upload-hint');
            
            uploadText.textContent = `å·²é¸æ“‡ï¼š${file.name}`;
            uploadHint.textContent = `æª”æ¡ˆå¤§å°ï¼š${(file.size / 1024 / 1024).toFixed(2)} MB`;
        }
        
        async function handleSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(form);
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è«‹é¸æ“‡è¦è™•ç†çš„æª”æ¡ˆ');
                return;
            }
            
            // é¡¯ç¤ºé€²åº¦
            showProgress();
            
            try {
                const response = await fetch('/api/subtitle/generate', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult(data);
                } else {
                    showError(data.error || 'å­—å¹•ç”Ÿæˆå¤±æ•—');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showError('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                hideProgress();
            }
        }
        
        function showProgress() {
            generateBtn.disabled = true;
            generateBtn.textContent = 'â³ è™•ç†ä¸­...';
            progress.style.display = 'block';
            result.style.display = 'none';
            
            // æ¨¡æ“¬é€²åº¦
            let progressValue = 0;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            const interval = setInterval(() => {
                progressValue += Math.random() * 10;
                if (progressValue > 90) progressValue = 90;
                
                progressFill.style.width = progressValue + '%';
                
                if (progressValue < 30) {
                    progressText.textContent = 'æ­£åœ¨ä¸Šå‚³æª”æ¡ˆ...';
                } else if (progressValue < 60) {
                    progressText.textContent = 'AI æ­£åœ¨åˆ†æéŸ³è¨Š...';
                } else {
                    progressText.textContent = 'æ­£åœ¨ç”Ÿæˆå­—å¹•...';
                }
            }, 500);
            
            // å„²å­˜ interval ID ä»¥ä¾¿å¾ŒçºŒæ¸…é™¤
            progress.dataset.intervalId = interval;
        }
        
        function hideProgress() {
            generateBtn.disabled = false;
            generateBtn.textContent = 'ğŸš€ é–‹å§‹ç”Ÿæˆå­—å¹•';
            progress.style.display = 'none';
            
            // æ¸…é™¤é€²åº¦æ¨¡æ“¬
            const intervalId = progress.dataset.intervalId;
            if (intervalId) {
                clearInterval(intervalId);
            }
        }
        
        function showResult(data) {
            currentSubtitleData = data;
            resultContent.textContent = data.content;
            result.style.display = 'block';
        }
        
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = 'âŒ ' + message;
            
            // ç§»é™¤èˆŠçš„éŒ¯èª¤è¨Šæ¯
            const oldError = document.querySelector('.error');
            if (oldError) {
                oldError.remove();
            }
            
            form.appendChild(errorDiv);
            
            // 3ç§’å¾Œè‡ªå‹•ç§»é™¤éŒ¯èª¤è¨Šæ¯
            setTimeout(() => {
                errorDiv.remove();
            }, 3000);
        }
        
        function handleDownload() {
            if (!currentSubtitleData) return;
            
            const blob = new Blob([currentSubtitleData.content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            a.href = url;
            a.download = `${currentSubtitleData.fileName}_å­—å¹•.${currentSubtitleData.format}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
```

---

## ğŸ“ æœ¬ç« é‡é»å›é¡§

1. **èªéŸ³è½‰æ–‡å­—æŠ€è¡“**ï¼šæŒæ¡äº† Whisper æ¨¡å‹çš„å·¥ä½œåŸç†å’Œé›²ç«¯è™•ç†å„ªå‹¢
2. **å¤šæ ¼å¼å­—å¹•è¼¸å‡º**ï¼šå¯¦ç¾äº† SRTã€VTTã€JSONã€TXT ç­‰å¤šç¨®å­—å¹•æ ¼å¼
3. **ä¼æ¥­ç´šåŠŸèƒ½**ï¼šå»ºç«‹äº†å®Œæ•´çš„å­—å¹•ç”Ÿæˆã€å„ªåŒ–å’Œç®¡ç†ç³»çµ±
4. **Web ä»‹é¢æ•´åˆ**ï¼šæä¾›äº†å‹å–„çš„æ‹–æ‹½ä¸Šå‚³å’Œå³æ™‚é è¦½åŠŸèƒ½
5. **å“è³ªå„ªåŒ–æŠ€è¡“**ï¼šæŒæ¡äº†å­—å¹•å…§å®¹å„ªåŒ–å’Œå“è³ªè©•ä¼°æ–¹æ³•

### æŠ€è¡“è¦é»ç¸½çµ

| æŠ€è¡“é» | é‡è¦æ€§ | å¯¦ç¾é›£åº¦ | ä½¿ç”¨å ´æ™¯ |
|--------|--------|----------|----------|
| **åŸºç¤è½‰è­¯** | â­â­â­ | ä½ | æ‰€æœ‰å­—å¹•æ‡‰ç”¨ |
| **å¤šæ ¼å¼è¼¸å‡º** | â­â­â­ | ä¸­ | ä¸åŒå¹³å°éœ€æ±‚ |
| **æ‰¹æ¬¡è™•ç†** | â­â­ | ä¸­ | å¤§é‡å…§å®¹è™•ç† |
| **å“è³ªå„ªåŒ–** | â­â­ | é«˜ | å°ˆæ¥­å­—å¹•è£½ä½œ |
| **Web ä»‹é¢** | â­â­ | ä¸­ | ä½¿ç”¨è€…é«”é©— |
| **æª”æ¡ˆç®¡ç†** | â­ | ä½ | ä¼æ¥­ç´šéƒ¨ç½² |

### æˆæœ¬æ•ˆç›Šåˆ†æ

**OpenAI Whisper å®šåƒ¹**ï¼š
- ğŸ’° **æˆæœ¬**ï¼š$0.006 per minute
- â±ï¸ **é€Ÿåº¦**ï¼šé€šå¸¸æ¯”éŸ³è¨Šæ™‚é•·å¿« 5-10 å€
- ğŸ¯ **æº–ç¢ºåº¦**ï¼šä¸­æ–‡è­˜åˆ¥æº–ç¢ºç‡ > 95%
- ğŸ“Š **æ€§åƒ¹æ¯”**ï¼šç›¸æ¯”äººå·¥å­—å¹•è£½ä½œç¯€çœ 80% æˆæœ¬

### æœ€ä½³å¯¦è¸å»ºè­°

1. **æª”æ¡ˆé è™•ç†**ï¼šç¢ºä¿éŸ³è¨Šå“è³ªï¼Œç§»é™¤èƒŒæ™¯å™ªéŸ³
2. **èªè¨€è¨­å®š**ï¼šæ­£ç¢ºè¨­å®šèªè¨€å¯æå‡ 10-15% æº–ç¢ºåº¦
3. **æº«åº¦èª¿æ•´**ï¼šä½¿ç”¨ 0.0 æº«åº¦ç²å¾—æœ€ç©©å®šçµæœ
4. **æ‰¹æ¬¡è™•ç†**ï¼šå¤§é‡æª”æ¡ˆä½¿ç”¨éåŒæ­¥è™•ç†æå‡æ•ˆç‡
5. **å“è³ªæª¢æŸ¥**ï¼šå¯¦æ–½è‡ªå‹•å“è³ªè©•ä¼°å’Œäººå·¥æ ¡å°æµç¨‹

### ä¸‹ä¸€æ­¥å­¸ç¿’æ–¹å‘

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘å€‘å°‡å­¸ç¿’æ–‡å­—è½‰èªéŸ³æŠ€è¡“ï¼Œæ¢ç´¢å¦‚ä½•è®“ AI å¹«ä½ é…éŸ³ï¼Œå»ºç«‹å®Œæ•´çš„èªéŸ³åˆæˆæ‡‰ç”¨ã€‚

---

**åƒè€ƒè³‡æ–™ï¼š**
- [Spring AI Audio Transcription Documentation](https://docs.spring.io/spring-ai/reference/api/audio.html)
- [OpenAI Whisper API](https://platform.openai.com/docs/guides/speech-to-text)
- [SRT Subtitle Format Specification](https://en.wikipedia.org/wiki/SubRip)
- [WebVTT Specification](https://www.w3.org/TR/webvtt1/)