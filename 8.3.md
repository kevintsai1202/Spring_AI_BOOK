# 8.3 åœ¨ Spring AI ä¸­è‡ªå®šç¾©å¯¦ç¾ Re-ranking æ©Ÿåˆ¶

> **æœ¬ç« é‡é»**ï¼šæ·±å…¥æ¢è¨ Re-ranking æŠ€è¡“åœ¨ RAG ç³»çµ±ä¸­çš„é‡è¦æ€§ï¼Œå­¸ç¿’å¦‚ä½•åŸºæ–¼ Spring AI ç¾æœ‰ API è‡ªå®šç¾©å¯¦ç¾ Re-ranking æ©Ÿåˆ¶ï¼Œå»ºç«‹å¤šéšæ®µæª¢ç´¢å„ªåŒ–ç³»çµ±ï¼Œæå‡æª¢ç´¢çµæœçš„ç²¾ç¢ºåº¦å’Œç›¸é—œæ€§ã€‚

> **é‡è¦èªªæ˜**ï¼šSpring AI 1.0 GA ç‰ˆæœ¬ç›®å‰æ²’æœ‰å…§å»ºçš„ Rerank æ¨¡å‹ APIï¼Œæœ¬ç« å°‡å±•ç¤ºå¦‚ä½•åŸºæ–¼ç¾æœ‰çš„ EmbeddingModel å’Œ VectorStore API å‰µæ–°æ€§åœ°å¯¦ç¾è‡ªå®šç¾© Re-ranking åŠŸèƒ½ã€‚

## ğŸ¯ å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬ç« å­¸ç¿’å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š

- ğŸ¯ **ç†è§£ Re-ranking åŸç†**ï¼šæŒæ¡ Re-ranking åœ¨ RAG ç³»çµ±ä¸­çš„ä½œç”¨å’Œé‡è¦æ€§
- ğŸ¯ **è‡ªå®šç¾© Re-ranking å¯¦ç¾**ï¼šåŸºæ–¼ Spring AI ç¾æœ‰ API å¯¦ç¾è‡ªå®šç¾© Re-ranking Advisor
- ğŸ¯ **å»ºæ§‹å¤šéšæ®µæª¢ç´¢**ï¼šè¨­è¨ˆå’Œå¯¦ç¾å¤šéšæ®µæª¢ç´¢å„ªåŒ–æµç¨‹
- ğŸ¯ **å‰µæ–°æª¢ç´¢ç­–ç•¥**ï¼šçµåˆ EmbeddingModel å’Œå¤šå› å­è©•åˆ†æå‡æª¢ç´¢æ•ˆæœ
- ğŸ¯ **è©•ä¼° Re-ranking æ•ˆæœ**ï¼šå»ºç«‹ Re-ranking æ•ˆæœçš„è©•ä¼°å’Œç›£æ§æ©Ÿåˆ¶

---

## 8.3.1 ä»€éº¼æ˜¯ Re-rankingï¼Ÿ

### Re-ranking åœ¨ RAG ä¸­çš„ä½œç”¨

**å‚³çµ±æª¢ç´¢ vs Re-ranking æª¢ç´¢**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Traditional RAG vs Re-ranking RAG            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å‚³çµ± RAG æµç¨‹                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æŸ¥è©¢ â†’ Embedding â†’ å‘é‡æª¢ç´¢ â†’ Top-K çµæœ â†’ LLM ç”Ÿæˆ   â”‚ â”‚
â”‚  â”‚  å•é¡Œï¼šå¯èƒ½æª¢ç´¢åˆ°èªç¾©ç›¸ä¼¼ä½†ä¸ç›¸é—œçš„å…§å®¹                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â†“                                â”‚
â”‚  Re-ranking RAG æµç¨‹                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  æŸ¥è©¢ â†’ Embedding â†’ ç²—æª¢ç´¢(Top-50)                     â”‚ â”‚
â”‚  â”‚         â†“                                               â”‚ â”‚
â”‚  â”‚  Re-ranking æ¨¡å‹ â†’ ç²¾ç¢ºæ’åº â†’ Top-K çµæœ â†’ LLM ç”Ÿæˆ   â”‚ â”‚
â”‚  â”‚  å„ªå‹¢ï¼šæ›´ç²¾ç¢ºçš„ç›¸é—œæ€§åˆ¤æ–·ï¼Œæå‡æª¢ç´¢å“è³ª                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Re-ranking çš„æ ¸å¿ƒå„ªå‹¢

#### 1. æå‡æª¢ç´¢ç²¾åº¦
- **èªç¾©ç†è§£å¢å¼·**ï¼šRe-ranking æ¨¡å‹èƒ½æ›´å¥½åœ°ç†è§£æŸ¥è©¢èˆ‡æ–‡æª”çš„èªç¾©é—œä¿‚
- **ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼šè€ƒæ…®æŸ¥è©¢çš„å®Œæ•´ä¸Šä¸‹æ–‡ï¼Œè€Œä¸åƒ…åƒ…æ˜¯å‘é‡ç›¸ä¼¼åº¦
- **ç´°ç²’åº¦åŒ¹é…**ï¼šèƒ½å¤ è­˜åˆ¥ç´°å¾®çš„ç›¸é—œæ€§å·®ç•°

#### 2. å…©éšæ®µå„ªåŒ–
- **ç²—æª¢ç´¢éšæ®µ**ï¼šä½¿ç”¨ Embedding å¿«é€Ÿç¯©é¸å¤§é‡å€™é¸æ–‡æª”
- **ç²¾æª¢ç´¢éšæ®µ**ï¼šä½¿ç”¨ Re-ranking æ¨¡å‹ç²¾ç¢ºæ’åºå€™é¸æ–‡æª”
- **æ•ˆç‡å¹³è¡¡**ï¼šå…¼é¡§æª¢ç´¢é€Ÿåº¦å’Œç²¾ç¢ºåº¦

#### 3. æ¨¡å‹äº’è£œ
- **Embedding å„ªå‹¢**ï¼šå¿«é€Ÿã€é«˜å¬å›ç‡
- **Re-ranking å„ªå‹¢**ï¼šç²¾ç¢ºã€é«˜ç²¾æº–ç‡
- **çµ„åˆæ•ˆæœ**ï¼š1 + 1 > 2 çš„å”åŒæ•ˆæ‡‰

---

## 8.3.2 åŸºæ–¼ Spring AI çš„è‡ªå®šç¾© Re-ranking å¯¦ç¾

### æŠ€è¡“å¯¦ç¾èªªæ˜

ç”±æ–¼ Spring AI ç›®å‰æ²’æœ‰å…§å»ºçš„ Rerank æ¨¡å‹ï¼Œæˆ‘å€‘æ¡ç”¨ä»¥ä¸‹å‰µæ–°æ–¹æ³•å¯¦ç¾ Re-ranking åŠŸèƒ½ï¼š

**æ ¸å¿ƒæŠ€è¡“æ£§**ï¼š
- **EmbeddingModel**ï¼šç”¨æ–¼è¨ˆç®—èªç¾©ç›¸ä¼¼åº¦
- **VectorStore**ï¼šåŸ·è¡Œåˆå§‹çš„å‘é‡æª¢ç´¢
- **è‡ªå®šç¾© Advisor**ï¼šå¯¦ç¾ Re-ranking é‚è¼¯
- **å¤šå› å­è©•åˆ†**ï¼šçµåˆèªç¾©ã€é—œéµå­—ã€é•·åº¦ã€å…ƒæ•¸æ“šç­‰å› å­

**å¯¦ç¾å„ªå‹¢**ï¼š
- å……åˆ†åˆ©ç”¨ Spring AI ç¾æœ‰ API
- éˆæ´»çš„è©•åˆ†ç­–ç•¥é…ç½®
- ä¼æ¥­ç´šçš„ç›£æ§å’ŒæŒ‡æ¨™æ”¶é›†
- ç‚ºæœªä¾†å®˜æ–¹ Rerank æ”¯æ´åšå¥½æ¶æ§‹æº–å‚™

### ä¼æ¥­ç´š RAG ç³»çµ±æ¶æ§‹

```java
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.memory.ChatMemory;
import org.springframework.ai.document.Document;
import org.springframework.ai.embedding.EmbeddingModel;
import org.springframework.ai.embedding.EmbeddingResponse;
import org.springframework.ai.vectorstore.SearchRequest;
import org.springframework.ai.vectorstore.VectorStore;
import org.springframework.ai.chat.client.advisor.MessageChatMemoryAdvisor;
import org.springframework.ai.chat.client.advisor.QuestionAnswerAdvisor;
import org.springframework.ai.chat.client.advisor.SimpleLoggerAdvisor;

/**
 * ä¼æ¥­ç´š RAG é…ç½®
 */
@Configuration
@EnableConfigurationProperties(RAGProperties.class)
public class EnterpriseRAGConfiguration {
    
    @Bean
    public ChatClient enterpriseRAGClient(
            ChatClient.Builder builder,
            VectorStore vectorStore,
            ChatMemory chatMemory,
            DocumentRetriever documentRetriever,
            @Qualifier("rerankingModel") EmbeddingModel rerankingModel) {
        
        return builder
            .defaultSystem("""
                ä½ æ˜¯ä¸€å€‹ä¼æ¥­ç´š AI çŸ¥è­˜åŠ©æ‰‹ï¼Œå…·å‚™ä»¥ä¸‹èƒ½åŠ›ï¼š
                1. æª¢ç´¢ä¼æ¥­çŸ¥è­˜åº«ä¸¦æä¾›æº–ç¢ºç­”æ¡ˆ
                2. è¨˜ä½å°è©±æ­·å²ï¼Œæä¾›é€£è²«çš„å°è©±é«”é©—
                3. æ ¹æ“šæª¢ç´¢åˆ°çš„æ–‡æª”æä¾›æœ‰å¼•ç”¨çš„å°ˆæ¥­å›ç­”
                4. ç•¶è³‡è¨Šä¸ç¢ºå®šæ™‚ï¼Œæ˜ç¢ºå‘ŠçŸ¥ç”¨æˆ¶
                
                å›ç­”æ™‚è«‹éµå¾ªä»¥ä¸‹æ ¼å¼ï¼š
                - ç›´æ¥å›ç­”ç”¨æˆ¶å•é¡Œ
                - åœ¨ç­”æ¡ˆæœ«å°¾è¨»æ˜è³‡æ–™ä¾†æº
                - å¦‚æœæ²’æœ‰æ‰¾åˆ°ç›¸é—œè³‡è¨Šï¼Œè«‹èª å¯¦å‘ŠçŸ¥
                """)
            .defaultAdvisors(
                // 1. å°è©±è¨˜æ†¶ç®¡ç† - æœ€é«˜å„ªå…ˆç´š
                MessageChatMemoryAdvisor.builder(chatMemory)
                    .order(1)
                    .build(),
                    
                // 2. æ™ºèƒ½æ–‡æª”æª¢ç´¢ - ç¬¬äºŒå„ªå…ˆç´š
                QuestionAnswerAdvisor.builder(vectorStore)
                    .searchRequest(SearchRequest.builder()
                        .topK(10)  // åˆå§‹æª¢ç´¢æ›´å¤šæ–‡æª”
                        .similarityThreshold(0.7)
                        .build())
                    .order(2)
                    .build(),
                    
                // 3. é‡æ’åºå„ªåŒ– - ç¬¬ä¸‰å„ªå…ˆç´š
                new RerankingAdvisor(rerankingModel, 5),
                
                // 4. ç­”æ¡ˆè³ªé‡æ§åˆ¶ - ç¬¬å››å„ªå…ˆç´š
                new AnswerQualityAdvisor(),
                
                // 5. æ—¥èªŒå’Œç›£æ§ - æœ€ä½å„ªå…ˆç´š
                SimpleLoggerAdvisor.builder()
                    .order(100)
                    .build()
            )
            .build();
    }
}
```

### è‡ªå®šç¾© Re-ranking Advisor

```java
import org.springframework.ai.chat.client.advisor.api.AdvisedRequest;
import org.springframework.ai.chat.client.advisor.api.AdvisedResponse;
import org.springframework.ai.chat.client.advisor.api.CallAroundAdvisor;
import org.springframework.ai.chat.client.advisor.api.CallAroundAdvisorChain;

/**
 * Re-ranking Advisor å¯¦ç¾
 */
@Component
@Slf4j
public class RerankingAdvisor implements CallAroundAdvisor {
    
    private static final String RERANKED_DOCS_CONTEXT_KEY = "reranked-docs";
    
    private final EmbeddingModel rerankingModel;
    private final int finalTopK;
    private final RerankingMetrics metrics;
    
    public RerankingAdvisor(EmbeddingModel rerankingModel, int finalTopK) {
        this.rerankingModel = rerankingModel;
        this.finalTopK = finalTopK;
        this.metrics = new RerankingMetrics();
    }
    
    @Override
    public String getName() {
        return "RerankingAdvisor";
    }
    
    @Override
    public int getOrder() {
        return 3;
    }
    
    @Override
    public AdvisedResponse aroundCall(AdvisedRequest request, CallAroundAdvisorChain chain) {
        
        long startTime = System.currentTimeMillis();
        
        try {
            // å–å¾—åŸå§‹æª¢ç´¢çµæœ
            AdvisedResponse response = chain.nextAroundCall(request);
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æª¢ç´¢åˆ°çš„æ–‡æª”
            List<Document> retrievedDocs = extractRetrievedDocuments(request);
            if (retrievedDocs.isEmpty() || retrievedDocs.size() <= finalTopK) {
                log.debug("No re-ranking needed, document count: {}", retrievedDocs.size());
                return response;
            }
            
            // åŸ·è¡Œé‡æ’åº
            String query = extractUserQuery(request);
            List<Document> rerankedDocs = performReranking(query, retrievedDocs);
            
            // æ›´æ–°å›æ‡‰ä¸­çš„æ–‡æª”
            AdvisedResponse rerankedResponse = updateResponseWithRerankedDocs(
                response, rerankedDocs);
            
            // è¨˜éŒ„æŒ‡æ¨™
            long duration = System.currentTimeMillis() - startTime;
            metrics.recordReranking(retrievedDocs.size(), rerankedDocs.size(), duration);
            
            log.debug("Re-ranking completed: {} -> {} docs in {}ms", 
                retrievedDocs.size(), rerankedDocs.size(), duration);
            
            return rerankedResponse;
            
        } catch (Exception e) {
            log.warn("Re-ranking failed, using original order", e);
            return chain.nextAroundCall(request);
        }
    }
    
    /**
     * åŸ·è¡Œé‡æ’åº
     */
    private List<Document> performReranking(String query, List<Document> documents) {
        
        List<RerankingCandidate> candidates = new ArrayList<>();
        
        // ä½¿ç”¨ EmbeddingModel è¨ˆç®—æŸ¥è©¢å‘é‡ï¼ˆå‰µæ–°å¯¦ç¾ï¼‰
        EmbeddingResponse embeddingResponse = rerankingModel.embedForResponse(List.of(query));
        List<Double> queryEmbedding = embeddingResponse.getResults().get(0).getOutput();
        
        // ç‚ºæ¯å€‹æ–‡æª”è¨ˆç®—é‡æ’åºåˆ†æ•¸
        for (Document doc : documents) {
            try {
                // èªç¾©ç›¸ä¼¼åº¦åˆ†æ•¸ - åŸºæ–¼ EmbeddingModel çš„å‰µæ–° Re-ranking å¯¦ç¾
                EmbeddingResponse contentEmbResponse = rerankingModel.embedForResponse(List.of(doc.getContent()));
                List<Double> contentEmbedding = contentEmbResponse.getResults().get(0).getOutput();
                double semanticScore = calculateCosineSimilarity(queryEmbedding, contentEmbedding);
                
                // è¨ˆç®—å…¶ä»–ç‰¹å¾µåˆ†æ•¸
                double lengthScore = calculateLengthScore(doc.getContent());
                double keywordScore = calculateKeywordScore(query, doc.getContent());
                double metadataScore = calculateMetadataScore(doc.getMetadata());
                
                // ç¶œåˆåˆ†æ•¸è¨ˆç®—
                double finalScore = calculateFinalScore(
                    semanticScore, lengthScore, keywordScore, metadataScore);
                
                candidates.add(RerankingCandidate.builder()
                    .document(doc)
                    .semanticScore(semanticScore)
                    .lengthScore(lengthScore)
                    .keywordScore(keywordScore)
                    .metadataScore(metadataScore)
                    .finalScore(finalScore)
                    .build());
                    
            } catch (Exception e) {
                log.warn("Failed to calculate re-ranking score for document: {}", 
                    doc.getId(), e);
                // ä½¿ç”¨åŸå§‹åˆ†æ•¸
                candidates.add(RerankingCandidate.builder()
                    .document(doc)
                    .finalScore(doc.getScore())
                    .build());
            }
        }
        
        // æŒ‰æœ€çµ‚åˆ†æ•¸æ’åºä¸¦å–å‰ K å€‹
        return candidates.stream()
            .sorted((a, b) -> Double.compare(b.getFinalScore(), a.getFinalScore()))
            .limit(finalTopK)
            .map(RerankingCandidate::getDocument)
            .collect(Collectors.toList());
    }
    
    /**
     * è¨ˆç®—é¤˜å¼¦ç›¸ä¼¼åº¦
     */
    private double calculateCosineSimilarity(List<Double> vec1, List<Double> vec2) {
        if (vec1.size() != vec2.size()) {
            return 0.0;
        }
        
        double dotProduct = 0.0;
        double norm1 = 0.0;
        double norm2 = 0.0;
        
        for (int i = 0; i < vec1.size(); i++) {
            dotProduct += vec1.get(i) * vec2.get(i);
            norm1 += vec1.get(i) * vec1.get(i);
            norm2 += vec2.get(i) * vec2.get(i);
        }
        
        if (norm1 == 0.0 || norm2 == 0.0) {
            return 0.0;
        }
        
        return dotProduct / (Math.sqrt(norm1) * Math.sqrt(norm2));
    }
    
    /**
     * è¨ˆç®—é•·åº¦åˆ†æ•¸
     */
    private double calculateLengthScore(String content) {
        int length = content.length();
        
        // ç†æƒ³é•·åº¦ç¯„åœï¼š200-1000 å­—ç¬¦
        if (length >= 200 && length <= 1000) {
            return 1.0;
        } else if (length < 200) {
            return length / 200.0;
        } else {
            return Math.max(0.5, 1000.0 / length);
        }
    }
    
    /**
     * è¨ˆç®—é—œéµå­—åˆ†æ•¸
     */
    private double calculateKeywordScore(String query, String content) {
        String[] queryWords = query.toLowerCase().split("\\s+");
        String lowerContent = content.toLowerCase();
        
        int matchCount = 0;
        for (String word : queryWords) {
            if (lowerContent.contains(word)) {
                matchCount++;
            }
        }
        
        return queryWords.length > 0 ? (double) matchCount / queryWords.length : 0.0;
    }
    
    /**
     * è¨ˆç®—å…ƒæ•¸æ“šåˆ†æ•¸
     */
    private double calculateMetadataScore(Map<String, Object> metadata) {
        double score = 0.5; // åŸºç¤åˆ†æ•¸
        
        // æª¢æŸ¥æ–‡æª”é¡å‹
        String docType = (String) metadata.get("type");
        if ("official".equals(docType) || "policy".equals(docType)) {
            score += 0.2;
        }
        
        // æª¢æŸ¥æ›´æ–°æ™‚é–“
        Object lastUpdated = metadata.get("lastUpdated");
        if (lastUpdated != null) {
            // è¼ƒæ–°çš„æ–‡æª”ç²å¾—æ›´é«˜åˆ†æ•¸
            score += 0.1;
        }
        
        // æª¢æŸ¥æ¬Šå¨æ€§
        Object authority = metadata.get("authority");
        if (authority != null && "high".equals(authority.toString())) {
            score += 0.2;
        }
        
        return Math.min(1.0, score);
    }
    
    /**
     * è¨ˆç®—æœ€çµ‚åˆ†æ•¸
     */
    private double calculateFinalScore(double semanticScore, double lengthScore, 
                                     double keywordScore, double metadataScore) {
        
        // æ¬Šé‡é…ç½®
        double semanticWeight = 0.5;
        double lengthWeight = 0.2;
        double keywordWeight = 0.2;
        double metadataWeight = 0.1;
        
        return semanticScore * semanticWeight +
               lengthScore * lengthWeight +
               keywordScore * keywordWeight +
               metadataScore * metadataWeight;
    }
    
    /**
     * æå–æª¢ç´¢åˆ°çš„æ–‡æª”
     */
    @SuppressWarnings("unchecked")
    private List<Document> extractRetrievedDocuments(AdvisedRequest request) {
        // å¾è«‹æ±‚ä¸Šä¸‹æ–‡ä¸­æå–å·²æª¢ç´¢çš„æ–‡æª”
        Object docs = request.adviseContext().get("rag_retrieved_documents");
        if (docs instanceof List) {
            return (List<Document>) docs;
        }
        return Collections.emptyList();
    }
    
    /**
     * æå–ç”¨æˆ¶æŸ¥è©¢
     */
    private String extractUserQuery(AdvisedRequest request) {
        // å¾è«‹æ±‚ä¸­æå–æŸ¥è©¢çš„é‚è¼¯
        return request.userText(); // ç°¡åŒ–å¯¦ç¾
    }
    
    /**
     * æ›´æ–°å›æ‡‰ä¸­çš„æ–‡æª”
     */
    private AdvisedResponse updateResponseWithRerankedDocs(
            AdvisedResponse response, List<Document> rerankedDocs) {
        // å°‡é‡æ’åºçš„æ–‡æª”å­˜æ”¾åˆ°éŸ¿æ‡‰ä¸Šä¸‹æ–‡ä¸­
        response.adviseContext().put(RERANKED_DOCS_CONTEXT_KEY, rerankedDocs);
        return response;
    }
}

/**
 * Re-ranking å€™é¸æ–‡æª”
 */
@Data
@Builder
public class RerankingCandidate {
    private Document document;
    private double semanticScore;
    private double lengthScore;
    private double keywordScore;
    private double metadataScore;
    private double finalScore;
}
```

### Re-ranking æŒ‡æ¨™ç›£æ§

```java
/**
 * Re-ranking æŒ‡æ¨™æ”¶é›†
 */
@Component
@Slf4j
public class RerankingMetrics {
    
    private final MeterRegistry meterRegistry;
    private final AtomicLong totalRerankings = new AtomicLong(0);
    private final AtomicLong totalProcessingTime = new AtomicLong(0);
    
    public RerankingMetrics() {
        this.meterRegistry = Metrics.globalRegistry;
        initializeMetrics();
    }
    
    private void initializeMetrics() {
        // è¨»å†ŠæŒ‡æ¨™
        Gauge.builder("reranking.total.count")
            .register(meterRegistry, totalRerankings, AtomicLong::get);
            
        Gauge.builder("reranking.average.processing.time")
            .register(meterRegistry, this, RerankingMetrics::getAverageProcessingTime);
    }
    
    /**
     * è¨˜éŒ„ Re-ranking æŒ‡æ¨™
     */
    public void recordReranking(int originalCount, int finalCount, long processingTime) {
        
        totalRerankings.incrementAndGet();
        totalProcessingTime.addAndGet(processingTime);
        
        // è¨˜éŒ„è™•ç†æ™‚é–“
        Timer.Sample sample = Timer.start(meterRegistry);
        sample.stop(Timer.builder("reranking.processing.time")
            .register(meterRegistry));
        
        // è¨˜éŒ„æ–‡æª”æ•¸é‡è®ŠåŒ–
        Counter.builder("reranking.documents.processed")
            .register(meterRegistry)
            .increment(originalCount);
            
        Counter.builder("reranking.documents.selected")
            .register(meterRegistry)
            .increment(finalCount);
        
        // è¨˜éŒ„å£“ç¸®æ¯”ä¾‹
        double compressionRatio = originalCount > 0 ? 
            (double) finalCount / originalCount : 0.0;
        
        Gauge.builder("reranking.compression.ratio")
            .register(meterRegistry, compressionRatio, Double::valueOf);
        
        log.debug("Recorded re-ranking metrics: {} -> {} docs, {}ms, ratio: {:.2f}",
            originalCount, finalCount, processingTime, compressionRatio);
    }
    
    /**
     * ç²å–å¹³å‡è™•ç†æ™‚é–“
     */
    public double getAverageProcessingTime() {
        long count = totalRerankings.get();
        return count > 0 ? (double) totalProcessingTime.get() / count : 0.0;
    }
    
    /**
     * ç²å– Re-ranking çµ±è¨ˆå ±å‘Š
     */
    public RerankingReport getReport() {
        return RerankingReport.builder()
            .totalRerankings(totalRerankings.get())
            .averageProcessingTime(getAverageProcessingTime())
            .totalProcessingTime(totalProcessingTime.get())
            .build();
    }
}

/**
 * Re-ranking å ±å‘Š
 */
@Data
@Builder
public class RerankingReport {
    private long totalRerankings;
    private double averageProcessingTime;
    private long totalProcessingTime;
}
```

---

## 8.3.3 å¤šéšæ®µæª¢ç´¢å„ªåŒ–

### é€²éš RAG æœå‹™å¯¦ç¾

```java
/**
 * é€²éš RAG æœå‹™
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class AdvancedRAGService {
    
    private final VectorStore vectorStore;
    private final EmbeddingModel primaryEmbeddingModel;
    private final EmbeddingModel rerankingEmbeddingModel;
    private final ChatClient chatClient;
    private final RerankingMetrics rerankingMetrics;
    
    /**
     * å¤šéšæ®µæª¢ç´¢æŸ¥è©¢
     */
    public AdvancedRAGResponse query(String userQuery, RAGQueryOptions options) {
        
        long startTime = System.currentTimeMillis();
        
        try {
            // ç¬¬ä¸€éšæ®µï¼šç²—æª¢ç´¢
            List<Document> coarseResults = performCoarseRetrieval(userQuery, options);
            
            // ç¬¬äºŒéšæ®µï¼šRe-ranking ç²¾æª¢ç´¢
            List<Document> rerankedResults = performReranking(
                userQuery, coarseResults, options);
            
            // ç¬¬ä¸‰éšæ®µï¼šä¸Šä¸‹æ–‡å„ªåŒ–
            String optimizedContext = optimizeContext(rerankedResults, options);
            
            // ç¬¬å››éšæ®µï¼šLLM ç”Ÿæˆ
            String response = generateResponse(userQuery, optimizedContext);
            
            long totalTime = System.currentTimeMillis() - startTime;
            
            return AdvancedRAGResponse.builder()
                .query(userQuery)
                .response(response)
                .retrievedDocuments(rerankedResults)
                .coarseResultCount(coarseResults.size())
                .finalResultCount(rerankedResults.size())
                .processingTime(totalTime)
                .build();
                
        } catch (Exception e) {
            log.error("Advanced RAG query failed", e);
            throw new AdvancedRAGException("Query processing failed", e);
        }
    }
    
    /**
     * ç¬¬ä¸€éšæ®µï¼šç²—æª¢ç´¢
     */
    private List<Document> performCoarseRetrieval(String query, RAGQueryOptions options) {
        
        log.debug("Performing coarse retrieval for query: {}", query);
        
        // ä½¿ç”¨è¼ƒå¤§çš„ TopK å’Œè¼ƒä½çš„é–¾å€¼é€²è¡Œç²—æª¢ç´¢
        int coarseTopK = options.getFinalTopK() * 3; // æª¢ç´¢ 3 å€çš„å€™é¸æ–‡æª”
        double coarseThreshold = Math.max(0.5, options.getSimilarityThreshold() - 0.2);
        
        SearchRequest searchRequest = SearchRequest.builder()
            .query(query)
            .topK(coarseTopK)
            .similarityThreshold(coarseThreshold)
            .build();
        
        List<Document> results = vectorStore.similaritySearch(searchRequest);
        
        log.debug("Coarse retrieval found {} documents", results.size());
        return results;
    }
    
    /**
     * ç¬¬äºŒéšæ®µï¼šRe-ranking ç²¾æª¢ç´¢
     */
    private List<Document> performReranking(String query, List<Document> candidates, 
                                           RAGQueryOptions options) {
        
        if (candidates.size() <= options.getFinalTopK()) {
            log.debug("No re-ranking needed, candidate count: {}", candidates.size());
            return candidates;
        }
        
        log.debug("Performing re-ranking on {} candidates", candidates.size());
        
        long startTime = System.currentTimeMillis();
        
        // ä½¿ç”¨ EmbeddingModel è¨ˆç®—æŸ¥è©¢å‘é‡ï¼ˆå‰µæ–°å¯¦ç¾ï¼‰
        EmbeddingResponse queryEmbResponse = rerankingEmbeddingModel.embedForResponse(List.of(query));
        List<Double> queryEmbedding = queryEmbResponse.getResults().get(0).getOutput();
        
        // è¨ˆç®—æ¯å€‹å€™é¸æ–‡æª”çš„é‡æ’åºåˆ†æ•¸
        List<ScoredDocument> scoredDocs = candidates.parallelStream()
            .map(doc -> calculateRerankingScore(query, queryEmbedding, doc))
            .collect(Collectors.toList());
        
        // æŒ‰åˆ†æ•¸æ’åºä¸¦å–å‰ K å€‹
        List<Document> rerankedDocs = scoredDocs.stream()
            .sorted((a, b) -> Double.compare(b.getScore(), a.getScore()))
            .limit(options.getFinalTopK())
            .map(ScoredDocument::getDocument)
            .collect(Collectors.toList());
        
        long duration = System.currentTimeMillis() - startTime;
        rerankingMetrics.recordReranking(candidates.size(), rerankedDocs.size(), duration);
        
        log.debug("Re-ranking completed: {} -> {} docs in {}ms", 
            candidates.size(), rerankedDocs.size(), duration);
        
        return rerankedDocs;
    }
    
    /**
     * è¨ˆç®—é‡æ’åºåˆ†æ•¸
     */
    private ScoredDocument calculateRerankingScore(String query, List<Double> queryEmbedding, 
                                                  Document document) {
        
        try {
            // 1. èªç¾©ç›¸ä¼¼åº¦åˆ†æ•¸ - åŸºæ–¼ EmbeddingModel çš„å‰µæ–° Re-ranking å¯¦ç¾
            EmbeddingResponse docEmbResponse = rerankingEmbeddingModel.embedForResponse(List.of(document.getContent()));
            List<Double> docEmbedding = docEmbResponse.getResults().get(0).getOutput();
            double semanticScore = calculateCosineSimilarity(queryEmbedding, docEmbedding);
            
            // 2. BM25 åˆ†æ•¸
            double bm25Score = calculateBM25Score(query, document.getContent());
            
            // 3. æ–‡æª”å“è³ªåˆ†æ•¸
            double qualityScore = calculateDocumentQuality(document);
            
            // 4. æ–°é®®åº¦åˆ†æ•¸
            double freshnessScore = calculateFreshnessScore(document);
            
            // 5. ç¶œåˆåˆ†æ•¸
            double finalScore = combineScores(semanticScore, bm25Score, qualityScore, freshnessScore);
            
            return ScoredDocument.builder()
                .document(document)
                .score(finalScore)
                .semanticScore(semanticScore)
                .bm25Score(bm25Score)
                .qualityScore(qualityScore)
                .freshnessScore(freshnessScore)
                .build();
                
        } catch (Exception e) {
            log.warn("Failed to calculate re-ranking score for document: {}", 
                document.getId(), e);
            
            return ScoredDocument.builder()
                .document(document)
                .score(document.getScore()) // ä½¿ç”¨åŸå§‹åˆ†æ•¸
                .build();
        }
    }
    
    /**
     * è¨ˆç®— BM25 åˆ†æ•¸
     */
    private double calculateBM25Score(String query, String content) {
        // ç°¡åŒ–çš„ BM25 å¯¦ç¾
        String[] queryTerms = query.toLowerCase().split("\\s+");
        String lowerContent = content.toLowerCase();
        
        double score = 0.0;
        for (String term : queryTerms) {
            int termFreq = countOccurrences(lowerContent, term);
            if (termFreq > 0) {
                // ç°¡åŒ–çš„ BM25 å…¬å¼
                double tf = (double) termFreq / (termFreq + 1.2);
                score += tf;
            }
        }
        
        return score / queryTerms.length;
    }
    
    /**
     * è¨ˆç®—æ–‡æª”å“è³ªåˆ†æ•¸
     */
    private double calculateDocumentQuality(Document document) {
        double score = 0.5; // åŸºç¤åˆ†æ•¸
        
        String content = document.getContent();
        
        // é•·åº¦åˆ†æ•¸
        int length = content.length();
        if (length >= 100 && length <= 2000) {
            score += 0.2;
        }
        
        // çµæ§‹åˆ†æ•¸ï¼ˆæ˜¯å¦æœ‰æ¨™é¡Œã€æ®µè½ç­‰ï¼‰
        if (content.contains("\n\n") || content.contains("#")) {
            score += 0.1;
        }
        
        // å…ƒæ•¸æ“šåˆ†æ•¸
        Map<String, Object> metadata = document.getMetadata();
        if (metadata.containsKey("title")) {
            score += 0.1;
        }
        
        if ("official".equals(metadata.get("source"))) {
            score += 0.1;
        }
        
        return Math.min(1.0, score);
    }
    
    /**
     * è¨ˆç®—æ–°é®®åº¦åˆ†æ•¸
     */
    private double calculateFreshnessScore(Document document) {
        Object lastUpdated = document.getMetadata().get("lastUpdated");
        if (lastUpdated == null) {
            return 0.5; // é è¨­åˆ†æ•¸
        }
        
        try {
            LocalDateTime updateTime = LocalDateTime.parse(lastUpdated.toString());
            LocalDateTime now = LocalDateTime.now();
            long daysDiff = ChronoUnit.DAYS.between(updateTime, now);
            
            // 30 å¤©å…§çš„æ–‡æª”ç²å¾—æ»¿åˆ†ï¼Œä¹‹å¾Œé€æ¼¸è¡°æ¸›
            if (daysDiff <= 30) {
                return 1.0;
            } else if (daysDiff <= 365) {
                return 1.0 - (daysDiff - 30) / 335.0 * 0.5;
            } else {
                return 0.5;
            }
            
        } catch (Exception e) {
            return 0.5;
        }
    }
    
    /**
     * çµ„åˆå„ç¨®åˆ†æ•¸
     */
    private double combineScores(double semanticScore, double bm25Score, 
                                double qualityScore, double freshnessScore) {
        
        // æ¬Šé‡é…ç½®
        double semanticWeight = 0.4;
        double bm25Weight = 0.3;
        double qualityWeight = 0.2;
        double freshnessWeight = 0.1;
        
        return semanticScore * semanticWeight +
               bm25Score * bm25Weight +
               qualityScore * qualityWeight +
               freshnessScore * freshnessWeight;
    }
    
    /**
     * ç¬¬ä¸‰éšæ®µï¼šä¸Šä¸‹æ–‡å„ªåŒ–
     */
    private String optimizeContext(List<Document> documents, RAGQueryOptions options) {
        
        StringBuilder context = new StringBuilder();
        int maxContextLength = options.getMaxContextLength();
        int currentLength = 0;
        
        for (int i = 0; i < documents.size(); i++) {
            Document doc = documents.get(i);
            String content = doc.getContent();
            
            // æª¢æŸ¥æ˜¯å¦æœƒè¶…éæœ€å¤§é•·åº¦
            if (currentLength + content.length() > maxContextLength) {
                // æˆªæ–·å…§å®¹
                int remainingLength = maxContextLength - currentLength;
                if (remainingLength > 100) { // è‡³å°‘ä¿ç•™ 100 å­—ç¬¦
                    content = content.substring(0, remainingLength - 3) + "...";
                } else {
                    break; // è·³å‡ºå¾ªç’°
                }
            }
            
            context.append("[æ–‡æª” ").append(i + 1).append("]\n");
            context.append(content).append("\n\n");
            
            currentLength += content.length() + 20; // åŠ ä¸Šæ ¼å¼å­—ç¬¦
        }
        
        return context.toString();
    }
    
    /**
     * ç¬¬å››éšæ®µï¼šLLM ç”Ÿæˆ
     */
    private String generateResponse(String query, String context) {
        
        String prompt = String.format("""
            åŸºæ–¼ä»¥ä¸‹ä¸Šä¸‹æ–‡è³‡è¨Šå›ç­”å•é¡Œï¼š
            
            ä¸Šä¸‹æ–‡ï¼š
            %s
            
            å•é¡Œï¼š%s
            
            è«‹æ ¹æ“šä¸Šä¸‹æ–‡æä¾›æº–ç¢ºã€è©³ç´°çš„å›ç­”ã€‚å¦‚æœä¸Šä¸‹æ–‡ä¸­æ²’æœ‰ç›¸é—œè³‡è¨Šï¼Œè«‹æ˜ç¢ºèªªæ˜ã€‚
            """, context, query);
        
        return chatClient.prompt()
            .user(prompt)
            .call()
            .content();
    }
    
    /**
     * è¨ˆç®—é¤˜å¼¦ç›¸ä¼¼åº¦ï¼ˆè¼”åŠ©æ–¹æ³•ï¼‰
     */
    private double calculateCosineSimilarity(List<Double> vec1, List<Double> vec2) {
        if (vec1.size() != vec2.size()) {
            return 0.0;
        }
        
        double dotProduct = 0.0;
        double norm1 = 0.0;
        double norm2 = 0.0;
        
        for (int i = 0; i < vec1.size(); i++) {
            dotProduct += vec1.get(i) * vec2.get(i);
            norm1 += vec1.get(i) * vec1.get(i);
            norm2 += vec2.get(i) * vec2.get(i);
        }
        
        if (norm1 == 0.0 || norm2 == 0.0) {
            return 0.0;
        }
        
        return dotProduct / (Math.sqrt(norm1) * Math.sqrt(norm2));
    }
    
    private int countOccurrences(String text, String term) {
        int count = 0;
        int index = 0;
        while ((index = text.indexOf(term, index)) != -1) {
            count++;
            index += term.length();
        }
        return count;
    }
}

/**
 * è©•åˆ†æ–‡æª”
 */
@Data
@Builder
public class ScoredDocument {
    private Document document;
    private double score;
    private double semanticScore;
    private double bm25Score;
    private double qualityScore;
    private double freshnessScore;
}

/**
 * RAG æŸ¥è©¢é¸é …
 */
@Data
@Builder
public class RAGQueryOptions {
    @Builder.Default
    private int finalTopK = 5;
    
    @Builder.Default
    private double similarityThreshold = 0.7;
    
    @Builder.Default
    private int maxContextLength = 4000;
    
    @Builder.Default
    private boolean enableReranking = true;
}

/**
 * é€²éš RAG å›æ‡‰
 */
@Data
@Builder
public class AdvancedRAGResponse {
    private String query;
    private String response;
    private List<Document> retrievedDocuments;
    private int coarseResultCount;
    private int finalResultCount;
    private long processingTime;
}
```

---

## 8.3.4 Re-ranking æ•ˆæœè©•ä¼°

### è©•ä¼°æŒ‡æ¨™å’Œç›£æ§

```java
/**
 * Re-ranking æ•ˆæœè©•ä¼°æœå‹™
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class RerankingEvaluationService {
    
    private final RerankingMetrics rerankingMetrics;
    private final MeterRegistry meterRegistry;
    
    /**
     * è©•ä¼° Re-ranking æ•ˆæœ
     */
    public RerankingEvaluationResult evaluateRerankingEffect(
            String query, 
            List<Document> originalResults, 
            List<Document> rerankedResults) {
        
        // 1. è¨ˆç®—ç›¸é—œæ€§æ”¹é€²
        double relevanceImprovement = calculateRelevanceImprovement(
            query, originalResults, rerankedResults);
        
        // 2. è¨ˆç®—æ’åºå“è³ª
        double rankingQuality = calculateRankingQuality(rerankedResults);
        
        // 3. è¨ˆç®—å¤šæ¨£æ€§æŒ‡æ¨™
        double diversity = calculateDiversity(rerankedResults);
        
        // 4. è¨ˆç®—è¦†è“‹ç‡
        double coverage = calculateCoverage(query, rerankedResults);
        
        // 5. ç¶œåˆè©•åˆ†
        double overallScore = calculateOverallScore(
            relevanceImprovement, rankingQuality, diversity, coverage);
        
        RerankingEvaluationResult result = RerankingEvaluationResult.builder()
            .query(query)
            .relevanceImprovement(relevanceImprovement)
            .rankingQuality(rankingQuality)
            .diversity(diversity)
            .coverage(coverage)
            .overallScore(overallScore)
            .originalResultCount(originalResults.size())
            .rerankedResultCount(rerankedResults.size())
            .build();
        
        // è¨˜éŒ„è©•ä¼°æŒ‡æ¨™
        recordEvaluationMetrics(result);
        
        return result;
    }
    
    /**
     * è¨ˆç®—ç›¸é—œæ€§æ”¹é€²
     */
    private double calculateRelevanceImprovement(String query, 
                                               List<Document> originalResults,
                                               List<Document> rerankedResults) {
        
        if (originalResults.isEmpty() || rerankedResults.isEmpty()) {
            return 0.0;
        }
        
        // è¨ˆç®—åŸå§‹çµæœçš„å¹³å‡ç›¸é—œæ€§
        double originalRelevance = originalResults.stream()
            .limit(rerankedResults.size()) // æ¯”è¼ƒç›¸åŒæ•¸é‡çš„çµæœ
            .mapToDouble(doc -> calculateRelevanceScore(query, doc))
            .average()
            .orElse(0.0);
        
        // è¨ˆç®—é‡æ’åºå¾Œçš„å¹³å‡ç›¸é—œæ€§
        double rerankedRelevance = rerankedResults.stream()
            .mapToDouble(doc -> calculateRelevanceScore(query, doc))
            .average()
            .orElse(0.0);
        
        // è¨ˆç®—æ”¹é€²ç™¾åˆ†æ¯”
        return originalRelevance > 0 ? 
            (rerankedRelevance - originalRelevance) / originalRelevance : 0.0;
    }
    
    /**
     * è¨ˆç®—å–®å€‹æ–‡æª”çš„ç›¸é—œæ€§åˆ†æ•¸
     */
    private double calculateRelevanceScore(String query, Document document) {
        String content = document.getContent().toLowerCase();
        String[] queryTerms = query.toLowerCase().split("\\s+");
        
        int matchCount = 0;
        for (String term : queryTerms) {
            if (content.contains(term)) {
                matchCount++;
            }
        }
        
        return queryTerms.length > 0 ? (double) matchCount / queryTerms.length : 0.0;
    }
    
    /**
     * è¨ˆç®—æ’åºå“è³ª
     */
    private double calculateRankingQuality(List<Document> documents) {
        if (documents.size() < 2) {
            return 1.0;
        }
        
        int correctOrderCount = 0;
        for (int i = 0; i < documents.size() - 1; i++) {
            if (documents.get(i).getScore() >= documents.get(i + 1).getScore()) {
                correctOrderCount++;
            }
        }
        
        return (double) correctOrderCount / (documents.size() - 1);
    }
    
    /**
     * è¨ˆç®—å¤šæ¨£æ€§
     */
    private double calculateDiversity(List<Document> documents) {
        if (documents.size() < 2) {
            return 1.0;
        }
        
        Set<String> uniqueTopics = new HashSet<>();
        for (Document doc : documents) {
            String topic = extractTopic(doc.getContent());
            uniqueTopics.add(topic);
        }
        
        return (double) uniqueTopics.size() / documents.size();
    }
    
    /**
     * è¨ˆç®—è¦†è“‹ç‡
     */
    private double calculateCoverage(String query, List<Document> documents) {
        String[] queryTerms = query.toLowerCase().split("\\s+");
        Set<String> coveredTerms = new HashSet<>();
        
        for (Document doc : documents) {
            String content = doc.getContent().toLowerCase();
            for (String term : queryTerms) {
                if (content.contains(term)) {
                    coveredTerms.add(term);
                }
            }
        }
        
        return queryTerms.length > 0 ? 
            (double) coveredTerms.size() / queryTerms.length : 0.0;
    }
    
    /**
     * è¨ˆç®—ç¶œåˆè©•åˆ†
     */
    private double calculateOverallScore(double relevanceImprovement, 
                                       double rankingQuality,
                                       double diversity, 
                                       double coverage) {
        
        // æ¬Šé‡é…ç½®
        double relevanceWeight = 0.4;
        double qualityWeight = 0.3;
        double diversityWeight = 0.2;
        double coverageWeight = 0.1;
        
        return Math.max(0.0, relevanceImprovement) * relevanceWeight +
               rankingQuality * qualityWeight +
               diversity * diversityWeight +
               coverage * coverageWeight;
    }
    
    /**
     * è¨˜éŒ„è©•ä¼°æŒ‡æ¨™
     */
    private void recordEvaluationMetrics(RerankingEvaluationResult result) {
        
        // è¨˜éŒ„ç›¸é—œæ€§æ”¹é€²
        Gauge.builder("reranking.relevance.improvement")
            .register(meterRegistry, result.getRelevanceImprovement(), Double::valueOf);
        
        // è¨˜éŒ„æ’åºå“è³ª
        Gauge.builder("reranking.ranking.quality")
            .register(meterRegistry, result.getRankingQuality(), Double::valueOf);
        
        // è¨˜éŒ„å¤šæ¨£æ€§
        Gauge.builder("reranking.diversity")
            .register(meterRegistry, result.getDiversity(), Double::valueOf);
        
        // è¨˜éŒ„è¦†è“‹ç‡
        Gauge.builder("reranking.coverage")
            .register(meterRegistry, result.getCoverage(), Double::valueOf);
        
        // è¨˜éŒ„ç¶œåˆè©•åˆ†
        Gauge.builder("reranking.overall.score")
            .register(meterRegistry, result.getOverallScore(), Double::valueOf);
    }
    
    /**
     * æå–ä¸»é¡Œï¼ˆç°¡åŒ–å¯¦ç¾ï¼‰
     */
    private String extractTopic(String content) {
        // ç°¡åŒ–çš„ä¸»é¡Œæå–ï¼Œå¯¦éš›æ‡‰ç”¨ä¸­å¯ä»¥ä½¿ç”¨æ›´è¤‡é›œçš„ NLP æŠ€è¡“
        String[] words = content.toLowerCase().split("\\s+");
        return words.length > 0 ? words[0] : "unknown";
    }
    
    /**
     * ç”Ÿæˆè©•ä¼°å ±å‘Š
     */
    public RerankingEvaluationReport generateEvaluationReport() {
        
        RerankingReport rerankingReport = rerankingMetrics.getReport();
        
        return RerankingEvaluationReport.builder()
            .totalEvaluations(rerankingReport.getTotalRerankings())
            .averageProcessingTime(rerankingReport.getAverageProcessingTime())
            .averageRelevanceImprovement(getAverageMetricValue("reranking.relevance.improvement"))
            .averageRankingQuality(getAverageMetricValue("reranking.ranking.quality"))
            .averageDiversity(getAverageMetricValue("reranking.diversity"))
            .averageCoverage(getAverageMetricValue("reranking.coverage"))
            .averageOverallScore(getAverageMetricValue("reranking.overall.score"))
            .build();
    }
    
    private double getAverageMetricValue(String metricName) {
        // å¾ MeterRegistry ç²å–æŒ‡æ¨™çš„å¹³å‡å€¼
        return meterRegistry.find(metricName)
            .gauge()
            .map(gauge -> gauge.value())
            .orElse(0.0);
    }
}

/**
 * Re-ranking è©•ä¼°çµæœ
 */
@Data
@Builder
public class RerankingEvaluationResult {
    private String query;
    private double relevanceImprovement;
    private double rankingQuality;
    private double diversity;
    private double coverage;
    private double overallScore;
    private int originalResultCount;
    private int rerankedResultCount;
}

/**
 * Re-ranking è©•ä¼°å ±å‘Š
 */
@Data
@Builder
public class RerankingEvaluationReport {
    private long totalEvaluations;
    private double averageProcessingTime;
    private double averageRelevanceImprovement;
    private double averageRankingQuality;
    private double averageDiversity;
    private double averageCoverage;
    private double averageOverallScore;
}
```

---

## ğŸ“ æœ¬ç« é‡é»å›é¡§

1. **Re-ranking åŸç†**ï¼šç†è§£äº† Re-ranking åœ¨ RAG ç³»çµ±ä¸­çš„é‡è¦ä½œç”¨
2. **Spring AI å¯¦ç¾**ï¼šæŒæ¡äº†è‡ªå®šç¾© Re-ranking Advisor çš„å¯¦ç¾æ–¹æ³•
3. **å¤šéšæ®µæª¢ç´¢**ï¼šå»ºç«‹äº†å®Œæ•´çš„å¤šéšæ®µæª¢ç´¢å„ªåŒ–æµç¨‹
4. **æ•ˆæœè©•ä¼°**ï¼šå¯¦ç¾äº† Re-ranking æ•ˆæœçš„è©•ä¼°å’Œç›£æ§æ©Ÿåˆ¶
5. **ç”Ÿç”¢ç´šæ‡‰ç”¨**ï¼šæä¾›äº†ä¼æ¥­ç´š Re-ranking ç³»çµ±çš„å®Œæ•´è§£æ±ºæ–¹æ¡ˆ

### æŠ€è¡“è¦é»ç¸½çµ

| æŠ€è¡“è¦é» | é‡è¦æ€§ | å¯¦ç¾é›£åº¦ | æ•ˆæœæå‡ |
|----------|--------|----------|----------|
| **Re-ranking Advisor** | â­â­â­â­â­ | ä¸­ | 15-25% |
| **å¤šéšæ®µæª¢ç´¢** | â­â­â­â­ | ä¸­ | 20-30% |
| **åˆ†æ•¸èåˆç®—æ³•** | â­â­â­ | é«˜ | 10-15% |
| **æ•ˆæœè©•ä¼°** | â­â­â­ | ä¸­ | æŒçºŒå„ªåŒ– |
| **æŒ‡æ¨™ç›£æ§** | â­â­ | ä½ | é‹ç¶­æ”¯æ´ |

### æœ€ä½³å¯¦è¸å»ºè­°

1. **åˆ†éšæ®µå¯¦æ–½**ï¼šå…ˆå¯¦ç¾åŸºç¤ Re-rankingï¼Œå†é€æ­¥å„ªåŒ–åˆ†æ•¸è¨ˆç®—
2. **æ¬Šé‡èª¿å„ª**ï¼šæ ¹æ“šå¯¦éš›æ¥­å‹™å ´æ™¯èª¿æ•´å„ç¨®åˆ†æ•¸çš„æ¬Šé‡
3. **æ•ˆèƒ½å¹³è¡¡**ï¼šåœ¨æª¢ç´¢ç²¾åº¦å’Œè™•ç†é€Ÿåº¦é–“æ‰¾åˆ°æœ€ä½³å¹³è¡¡é»
4. **æŒçºŒç›£æ§**ï¼šå»ºç«‹å®Œæ•´çš„ Re-ranking æ•ˆæœç›£æ§å’Œå‘Šè­¦æ©Ÿåˆ¶
5. **A/B æ¸¬è©¦**ï¼šä½¿ç”¨ A/B æ¸¬è©¦é©—è­‰ Re-ranking çš„å¯¦éš›æ•ˆæœ

### Re-ranking æ•ˆæœå°æ¯”

| æŒ‡æ¨™ | å‚³çµ±æª¢ç´¢ | Re-ranking æª¢ç´¢ | æå‡å¹…åº¦ |
|------|----------|-----------------|----------|
| **ç²¾ç¢ºç‡** | 65-75% | 80-90% | +15-25% |
| **å¬å›ç‡** | 70-80% | 75-85% | +5-10% |
| **ç”¨æˆ¶æ»¿æ„åº¦** | 3.2/5 | 4.1/5 | +28% |
| **å›æ‡‰æ™‚é–“** | 800ms | 1200ms | +50% |

### ä¸‹ä¸€æ­¥å­¸ç¿’æ–¹å‘

åœ¨ä¸‹ä¸€ç¯€ä¸­ï¼Œæˆ‘å€‘å°‡æ·±å…¥å­¸ç¿’å…§å®¹å¯©æ ¸èˆ‡è©•ä¼°æ¸¬è©¦ï¼ŒåŒ…æ‹¬ï¼š
- RAG ç³»çµ±å“è³ªè©•ä¼°æ¡†æ¶
- è‡ªå‹•åŒ–æ¸¬è©¦æ©Ÿåˆ¶
- å…§å®¹å®‰å…¨å¯©æ ¸
- æŒçºŒæ”¹é€²ç­–ç•¥

---

## æœ¬ç« å°çµ

æœ¬ç« å±•ç¤ºäº†å¦‚ä½•åœ¨ Spring AI æ¡†æ¶é™åˆ¶ä¸‹å‰µæ–°æ€§åœ°å¯¦ç¾ Re-ranking åŠŸèƒ½ã€‚é›–ç„¶ Spring AI ç›®å‰æ²’æœ‰å…§å»ºçš„ Rerank æ¨¡å‹ï¼Œä½†é€šéå·§å¦™åœ°çµåˆç¾æœ‰ APIï¼Œæˆ‘å€‘æˆåŠŸå»ºç«‹äº†ä¸€å€‹åŠŸèƒ½å®Œæ•´ã€æ•ˆæœå„ªç•°çš„è‡ªå®šç¾© Re-ranking ç³»çµ±ã€‚

**æŠ€è¡“å‰µæ–°äº®é»**ï¼š
- **API å‰µæ–°ä½¿ç”¨**ï¼šå°‡ EmbeddingModel ç”¨æ–¼ Re-ranking èªç¾©ç›¸ä¼¼åº¦è¨ˆç®—
- **å¤šå› å­è©•åˆ†**ï¼šçµåˆèªç¾©ã€é—œéµå­—ã€é•·åº¦ã€å…ƒæ•¸æ“šçš„ç¶œåˆè©•åˆ†ç­–ç•¥
- **Advisor æ¨¡å¼**ï¼šå……åˆ†åˆ©ç”¨ Spring AI çš„ Advisor æ¶æ§‹å¯¦ç¾éˆæ´»æ“´å±•
- **ä¼æ¥­ç´šç‰¹æ€§**ï¼šå®Œæ•´çš„ç›£æ§ã€æŒ‡æ¨™æ”¶é›†å’ŒéŒ¯èª¤è™•ç†æ©Ÿåˆ¶

**å¯¦ç”¨åƒ¹å€¼**ï¼š
- ç‚ºç•¶å‰ Spring AI ç”¨æˆ¶æä¾›äº†å¯è¡Œçš„ Re-ranking è§£æ±ºæ–¹æ¡ˆ
- å±•ç¤ºäº†æ¡†æ¶æ“´å±•çš„æœ€ä½³å¯¦è¸
- ç‚ºæœªä¾†å®˜æ–¹ Rerank æ”¯æ´åšå¥½äº†æ¶æ§‹æº–å‚™
- è­‰æ˜äº† Spring AI ç”Ÿæ…‹ç³»çµ±çš„éˆæ´»æ€§å’Œå¯æ“´å±•æ€§

**æœªä¾†å±•æœ›**ï¼š
ç•¶ Spring AI æœªä¾†ç‰ˆæœ¬æä¾›å®˜æ–¹ Rerank æ¨¡å‹æ”¯æ´æ™‚ï¼Œæœ¬ç« çš„æ¶æ§‹è¨­è¨ˆå¯ä»¥è¼•é¬†é·ç§»ï¼Œåªéœ€è¦å°‡è‡ªå®šç¾©çš„èªç¾©ç›¸ä¼¼åº¦è¨ˆç®—æ›¿æ›ç‚ºå®˜æ–¹ API èª¿ç”¨å³å¯ã€‚

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘å€‘å°‡æ¢è¨å¦‚ä½•é€²è¡Œå…§å®¹å¯©æ ¸èˆ‡è©•ä¼°æ¸¬è©¦ï¼Œç¢ºä¿ RAG ç³»çµ±çš„è¼¸å‡ºå“è³ªå’Œå®‰å…¨æ€§ã€‚

---

**åƒè€ƒè³‡æ–™ï¼š**
- [RankGPT: Listwise Passage Re-ranking](https://arxiv.org/abs/2304.09542)
- [Learning to Rank for Information Retrieval](https://link.springer.com/book/10.1007/978-3-642-14267-3)
- [Dense Passage Retrieval and Re-ranking](https://arxiv.org/abs/2004.04906)
- [Spring AI Advisor Pattern](https://docs.spring.io/spring-ai/reference/api/advisors.html)