# 4.3 å¦‚ä½•åƒ ChatGPT ç”¢ç”Ÿæµå¼è¼¸å‡º

> **æœ¬ç« é‡é»**ï¼šå­¸ç¿’å¯¦ç¾ AI æµå¼è¼¸å‡ºåŠŸèƒ½ï¼Œè®“ä½¿ç”¨è€…é«”é©—å¦‚åŒ ChatGPT èˆ¬çš„å³æ™‚å›æ‡‰æ•ˆæœï¼Œå¤§å¹…æå‡æ‡‰ç”¨ç¨‹å¼çš„äº’å‹•æ€§å’Œä½¿ç”¨è€…æ»¿æ„åº¦ã€‚

## ğŸ¯ å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬ç« å­¸ç¿’å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š

- ğŸ¯ **ç†è§£æµå¼è¼¸å‡ºåŸç†**ï¼šæŒæ¡ Server-Sent Events (SSE) çš„å·¥ä½œæ©Ÿåˆ¶
- ğŸ¯ **å¯¦ç¾ AI æµå¼å›æ‡‰**ï¼šä½¿ç”¨ ChatClient å»ºç«‹æµå¼ AI å°è©±åŠŸèƒ½
- ğŸ¯ **å„ªåŒ–ä½¿ç”¨è€…é«”é©—**ï¼šè®“ AI å›æ‡‰å³æ™‚é¡¯ç¤ºï¼Œé¿å…é•·æ™‚é–“ç­‰å¾…
- ğŸ¯ **è™•ç†æµå¼è³‡æ–™**ï¼šæŒæ¡ Reactive Streams å’ŒèƒŒå£“è™•ç†
- ğŸ¯ **å‰ç«¯æ•´åˆæŠ€è¡“**ï¼šå­¸æœƒä½¿ç”¨ EventSource æ¥æ”¶æµå¼è³‡æ–™

---

## 4.3.1 ç‚ºä»€éº¼éœ€è¦æµå¼è¼¸å‡ºï¼Ÿ

### ä½¿ç”¨è€…é«”é©—çš„é©å‘½

![æµå¼è¼¸å‡º](https://ithelp.ithome.com.tw/upload/images/20240810/20161290gaE6Faz85x.jpg)

ç”±æ–¼ AI ç”¢ç”Ÿå…§å®¹å¾—é ä¼ºæœå™¨é‹ç®—å¾Œç”¢ç”Ÿçµæœï¼Œè³‡æ–™å¤šçš„è©±å¾—ç­‰ä¸å°‘æ™‚é–“ï¼Œè‹¥èƒ½ç”¢ç”Ÿè³‡æ–™å¾Œé¦¬ä¸Šåˆ†æ®µé€å‡ºï¼Œå¯å¤§å¤§æå‡ä½¿ç”¨è€…æ„Ÿå—ã€‚

**å‚³çµ±åŒæ­¥å›æ‡‰ vs æµå¼è¼¸å‡º**ï¼š

```
å‚³çµ±æ–¹å¼ï¼š
ä½¿ç”¨è€…æå• â†’ [ç­‰å¾… 10 ç§’] â†’ å®Œæ•´å›æ‡‰é¡¯ç¤º

æµå¼è¼¸å‡ºï¼š
ä½¿ç”¨è€…æå• â†’ [0.5ç§’] é–‹å§‹é¡¯ç¤º â†’ [æŒçºŒæ›´æ–°] â†’ å®Œæ•´å›æ‡‰
```

**æµå¼è¼¸å‡ºçš„å„ªå‹¢**ï¼š
- âš¡ **å³æ™‚åé¥‹**ï¼šä½¿ç”¨è€…ç«‹å³çœ‹åˆ° AI é–‹å§‹å›æ‡‰
- ğŸ¯ **é™ä½ç„¦æ…®**ï¼šé¿å…é•·æ™‚é–“ç­‰å¾…é€ æˆçš„ä¸ç¢ºå®šæ„Ÿ
- ğŸ“± **æ›´å¥½çš„äº’å‹•æ€§**ï¼šé¡ä¼¼çœŸäººå°è©±çš„é«”é©—
- ğŸš€ **æ„ŸçŸ¥æ•ˆèƒ½æå‡**ï¼šé›–ç„¶ç¸½æ™‚é–“ç›¸åŒï¼Œä½†æ„Ÿè¦ºæ›´å¿«
- ğŸ’¡ **æ—©æœŸä¸­æ–·**ï¼šä½¿ç”¨è€…å¯ä»¥æå‰åˆ¤æ–·å›æ‡‰å“è³ª

### Server-Sent Events (SSE) æŠ€è¡“

è¦é”åˆ°é€™ç¨®æ•ˆæœä¸»è¦é çš„æ˜¯ **Server-Sent Events (SSE)** ä¼ºæœå™¨ä¸»å‹•æ¨æ’­å”å®šï¼š

**SSE ç‰¹é»**ï¼š
- ğŸ“¡ **å–®å‘é€šè¨Š**ï¼šä¼ºæœå™¨å‘å®¢æˆ¶ç«¯æ¨é€è³‡æ–™
- ğŸ”„ **è‡ªå‹•é‡é€£**ï¼šé€£ç·šä¸­æ–·æ™‚è‡ªå‹•é‡æ–°é€£æ¥
- ğŸŒ **æ¨™æº–å”å®š**ï¼šåŸºæ–¼ HTTPï¼Œå»£æ³›æ”¯æ´
- ğŸ’» **ç€è¦½å™¨åŸç”Ÿæ”¯æ´**ï¼šä½¿ç”¨ EventSource API

---

## 4.3.2 ChatClient æµå¼è¼¸å‡ºå¯¦ä½œ

### åŸºæœ¬æµå¼è¼¸å‡º

Spring AI 1.0 GA çš„ ChatClient æä¾›äº†å„ªé›…çš„æµå¼è¼¸å‡º APIï¼š

```java
package com.example.controller;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Flux;

@RestController
@RequestMapping("/api/ai")
@RequiredArgsConstructor
@Slf4j
public class StreamingAiController {
    
    private final ChatClient chatClient;

    /**
     * åŸºæœ¬æµå¼ AI å°è©±
     * @param prompt ä½¿ç”¨è€…è¼¸å…¥çš„æç¤ºè©
     * @return æµå¼å­—ä¸²å›æ‡‰
     */
    @GetMapping(value = "/chat/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux<String> chatStream(@RequestParam String prompt) {
        log.info("é–‹å§‹æµå¼å°è©±ï¼š{}", prompt);
        
        return chatClient.prompt()
                .user(prompt)
                .stream()
                .content();
    }
    
    /**
     * å¸¶ç³»çµ±æç¤ºè©çš„æµå¼å°è©±
     * @param prompt ä½¿ç”¨è€…è¼¸å…¥
     * @param system ç³»çµ±æç¤ºè©
     * @return æµå¼å›æ‡‰
     */
    @GetMapping(value = "/chat/stream/system", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux<String> chatStreamWithSystem(
            @RequestParam String prompt,
            @RequestParam(defaultValue = "ä½ æ˜¯ä¸€å€‹å‹å–„ä¸”å°ˆæ¥­çš„ AI åŠ©æ‰‹") String system) {
        
        return chatClient.prompt()
                .system(system)
                .user(prompt)
                .stream()
                .content()
                .doOnSubscribe(subscription -> 
                    log.info("é–‹å§‹æµå¼å°è©± - ç³»çµ±ï¼š{}, ä½¿ç”¨è€…ï¼š{}", system, prompt))
                .doOnComplete(() -> 
                    log.info("æµå¼å°è©±å®Œæˆ"));
    }
}
```

### ç¨‹å¼ç¢¼é‡é»èªªæ˜

**æ ¸å¿ƒ API**ï¼š
- **`stream()`**: æ›¿ä»£ `call()` ä¾†å•Ÿç”¨æµå¼è¼¸å‡º
- **`content()`**: è¿”å› `Flux<String>` æµå¼å­—ä¸²å…§å®¹
- **`produces = MediaType.TEXT_EVENT_STREAM_VALUE`**: æŒ‡å®šå›æ‡‰æ ¼å¼ç‚º SSE

**Reactive æ“ä½œç¬¦**ï¼š
- **`doOnSubscribe()`**: è¨‚é–±æ™‚åŸ·è¡Œçš„å‹•ä½œ
- **`doOnComplete()`**: å®Œæˆæ™‚åŸ·è¡Œçš„å‹•ä½œ
- **`doOnNext()`**: æ¯å€‹å…ƒç´ ç™¼å‡ºæ™‚åŸ·è¡Œçš„å‹•ä½œ

---

## 4.3.3 é€²éšæµå¼è¼¸å‡ºæ§åˆ¶

### å®Œæ•´ ChatResponse æµ

å¦‚æœéœ€è¦æ›´å¤šæ§åˆ¶é¸é …ï¼Œå¯ä»¥ä½¿ç”¨å®Œæ•´çš„ ChatResponse æµï¼š

```java
@GetMapping(value = "/chat/stream/response", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public Flux<ChatResponse> chatStreamResponse(@RequestParam String prompt) {
    return chatClient.prompt()
            .user(prompt)
            .stream()
            .chatResponse()
            .doOnNext(response -> {
                // å¯ä»¥å­˜å–å®Œæ•´çš„å›æ‡‰è³‡è¨Š
                log.debug("æ”¶åˆ°å›æ‡‰ç‰‡æ®µï¼š{}", response.getResult().getOutput().getContent());
                log.debug("ä½¿ç”¨çš„æ¨¡å‹ï¼š{}", response.getMetadata().getModel());
            });
}
```

### è‡ªå®šç¾©æµå¼è¼¸å‡ºè™•ç†

```java
@GetMapping(value = "/chat/stream/custom", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public Flux<String> chatStreamCustom(@RequestParam String prompt) {
    return chatClient.prompt()
            .user(prompt)
            .stream()
            .content()
            .map(content -> {
                // è‡ªå®šç¾©è™•ç†æ¯å€‹æµå¼ç‰‡æ®µ
                return "ğŸ¤– AI: " + content;
            })
            .filter(content -> {
                // éæ¿¾ç©ºå…§å®¹
                return content != null && !content.trim().isEmpty();
            })
            .doOnNext(content -> {
                // è¨˜éŒ„æ¯å€‹ç‰‡æ®µ
                log.debug("æµå¼å…§å®¹ï¼š{}", content);
            })
            .onErrorResume(error -> {
                log.error("æµå¼è¼¸å‡ºéŒ¯èª¤", error);
                return Flux.just("âŒ æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤ï¼š" + error.getMessage());
            });
}
```

### çµæ§‹åŒ–æµå¼å›æ‡‰

```java
@Data
public class StreamChunk {
    private String content;
    private String timestamp;
    private String model;
    private boolean isComplete;
    
    public static StreamChunk of(String content, String model) {
        StreamChunk chunk = new StreamChunk();
        chunk.setContent(content);
        chunk.setTimestamp(Instant.now().toString());
        chunk.setModel(model);
        chunk.setComplete(false);
        return chunk;
    }
}

@GetMapping(value = "/chat/stream/structured", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public Flux<StreamChunk> chatStreamStructured(@RequestParam String prompt) {
    return chatClient.prompt()
            .user(prompt)
            .stream()
            .chatResponse()
            .map(response -> StreamChunk.of(
                response.getResult().getOutput().getContent(),
                response.getMetadata().getModel()
            ))
            .concatWith(Flux.just(new StreamChunk() {{
                setContent("");
                setComplete(true);
            }}));
}
```

---

## 4.3.4 ä½¿ç”¨ ChatModel çš„æµå¼è¼¸å‡º

### åº•å±¤ API å¯¦ç¾

å¦‚æœç›´æ¥ä½¿ç”¨ ChatModelï¼Œä¹Ÿå¯ä»¥å¯¦ç¾æµå¼è¼¸å‡ºï¼š

```java
package com.example.controller;

import lombok.RequiredArgsConstructor;
import org.springframework.ai.chat.model.StreamingChatModel;
import org.springframework.ai.chat.prompt.Prompt;
import org.springframework.ai.chat.prompt.PromptTemplate;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Flux;

import java.util.Map;

@RestController
@RequestMapping("/api/model")
@RequiredArgsConstructor
public class StreamingModelController {
    
    private final StreamingChatModel streamingChatModel;

    /**
     * ä½¿ç”¨ ChatModel çš„åŸºæœ¬æµå¼è¼¸å‡º
     * @param prompt ä½¿ç”¨è€…è¼¸å…¥
     * @return æµå¼å›æ‡‰
     */
    @GetMapping(value = "/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux<String> modelStream(@RequestParam String prompt) {
        return streamingChatModel.stream(prompt)
                .map(chatResponse -> 
                    chatResponse.getResult().getOutput().getContent())
                .filter(content -> content != null && !content.isEmpty());
    }
    
    /**
     * ä½¿ç”¨ PromptTemplate çš„æµå¼è¼¸å‡º
     * @param topic è©±é¡Œ
     * @param style é¢¨æ ¼
     * @return æµå¼å›æ‡‰
     */
    @GetMapping(value = "/stream/template", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux<String> modelStreamWithTemplate(
            @RequestParam String topic,
            @RequestParam(defaultValue = "å°ˆæ¥­") String style) {
        
        String template = "è«‹ä»¥{style}çš„é¢¨æ ¼ï¼Œè©³ç´°èªªæ˜{topic}çš„ç›¸é—œçŸ¥è­˜";
        
        PromptTemplate promptTemplate = new PromptTemplate(template);
        Prompt prompt = promptTemplate.create(Map.of(
            "topic", topic,
            "style", style
        ));
        
        return streamingChatModel.stream(prompt)
                .map(chatResponse -> 
                    chatResponse.getResult().getOutput().getContent())
                .filter(content -> content != null && !content.isEmpty());
    }
}
```

---

## 4.3.5 æ‡‰ç”¨ç¨‹å¼é…ç½®

### å¿…è¦ä¾è³´

è¦ä½¿ç”¨ Spring AI çš„æµå¼è¼¸å‡ºåŠŸèƒ½ï¼Œå¿…é ˆåŒ…å« WebFlux ä¾è³´ï¼š

```xml
<!-- å¿…é ˆåŒ…å« WebFlux ä»¥æ”¯æ´æµå¼è¼¸å‡º -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-webflux</artifactId>
</dependency>

<!-- Spring AI OpenAI Starter -->
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-openai-spring-boot-starter</artifactId>
</dependency>
```

> **é‡è¦æé†’**ï¼šæµå¼è¼¸å‡ºåƒ…æ”¯æ´ Reactive æ¶æ§‹ã€‚å³ä½¿æ˜¯å‘½ä»¤å¼æ‡‰ç”¨ç¨‹å¼ï¼Œä¹Ÿå¿…é ˆåŒ…å« Reactive ä¾è³´æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚

### Spring Boot é…ç½®

ç¢ºä¿åœ¨ `application.yml` ä¸­æ­£ç¢ºè¨­å®šå­—å…ƒç·¨ç¢¼å’Œæµå¼é¸é …ï¼š

```yaml
server:
  port: 8080
  servlet:
    encoding:
      charset: UTF-8
      enabled: true
      force: true

spring:
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      base-url: https://api.openai.com
      chat:
        options:
          model: gpt-4o-mini
          temperature: 0.7
          max-completion-tokens: 1000
          stream-usage: true  # åœ¨æµå¼å›æ‡‰ä¸­åŒ…å«ä½¿ç”¨é‡çµ±è¨ˆ

# æ—¥èªŒé…ç½®
logging:
  level:
    org.springframework.ai: DEBUG
    reactor.netty: INFO
    com.example: DEBUG
```

### è·¨åŸŸé…ç½®ï¼ˆå¦‚éœ€è¦ï¼‰

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**")
                .allowedOrigins("http://localhost:3000", "http://localhost:8081")
                .allowedMethods("GET", "POST", "PUT", "DELETE")
                .allowedHeaders("*")
                .allowCredentials(true);
    }
}
```

---

## 4.3.6 å®Œæ•´çš„èŠå¤©æœå‹™å¯¦ä½œ

### èŠå¤©æœå‹™å±¤

```java
package com.example.service;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Flux;

import java.time.Duration;

@Service
@RequiredArgsConstructor
@Slf4j
public class ChatService {
    
    private final ChatClient chatClient;
    
    /**
     * æµå¼èŠå¤©æœå‹™
     * @param userMessage ä½¿ç”¨è€…è¨Šæ¯
     * @param systemPrompt ç³»çµ±æç¤ºè©
     * @return æµå¼å›æ‡‰
     */
    public Flux<String> streamChat(String userMessage, String systemPrompt) {
        String defaultSystem = "ä½ æ˜¯ä¸€å€‹å‹å–„ä¸”å°ˆæ¥­çš„ AI åŠ©æ‰‹ï¼Œ" +
                              "è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œä¸¦æä¾›æœ‰ç”¨çš„è³‡è¨Šã€‚";
        
        return chatClient.prompt()
                .system(systemPrompt != null ? systemPrompt : defaultSystem)
                .user(userMessage)
                .stream()
                .content()
                .timeout(Duration.ofSeconds(30))  // è¨­å®šè¶…æ™‚
                .retry(2)  // é‡è©¦æ©Ÿåˆ¶
                .onErrorResume(error -> {
                    log.error("èŠå¤©æµå¼è¼¸å‡ºéŒ¯èª¤", error);
                    return Flux.just("âŒ æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚éŒ¯èª¤è¨Šæ¯ï¼š" + error.getMessage());
                })
                .doOnSubscribe(subscription -> 
                    log.info("é–‹å§‹æµå¼èŠå¤© - ä½¿ç”¨è€…ï¼š{}", userMessage))
                .doOnComplete(() -> 
                    log.info("æµå¼èŠå¤©å®Œæˆ"))
                .doOnError(error -> 
                    log.error("æµå¼èŠå¤©ç™¼ç”ŸéŒ¯èª¤ï¼š{}", error.getMessage()));
    }
    
    /**
     * ç¨‹å¼ç¢¼ç”Ÿæˆå°ˆç”¨æµå¼æœå‹™
     * @param description ç¨‹å¼éœ€æ±‚æè¿°
     * @param language ç¨‹å¼èªè¨€
     * @return æµå¼ç¨‹å¼ç¢¼å›æ‡‰
     */
    public Flux<String> streamCodeGeneration(String description, String language) {
        String systemPrompt = String.format(
            "ä½ æ˜¯ä¸€å€‹è³‡æ·±çš„ %s é–‹ç™¼å°ˆå®¶ã€‚" +
            "è«‹æ ¹æ“šéœ€æ±‚æè¿°ç”Ÿæˆé«˜å“è³ªã€å¯åŸ·è¡Œçš„ç¨‹å¼ç¢¼ï¼Œ" +
            "åŒ…å«é©ç•¶çš„è¨»è§£å’Œæœ€ä½³å¯¦è¸ã€‚" +
            "è«‹åªå›å‚³ç¨‹å¼ç¢¼ï¼Œä¸è¦é¡å¤–çš„èªªæ˜æ–‡å­—ã€‚",
            language
        );
        
        return streamChat(description, systemPrompt);
    }
}
```

### æ§åˆ¶å™¨æ•´åˆ

```java
package com.example.controller;

import com.example.service.ChatService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Flux;

@RestController
@RequestMapping("/api/chat")
@RequiredArgsConstructor
public class ChatController {
    
    private final ChatService chatService;

    /**
     * é€šç”¨æµå¼èŠå¤©ç«¯é»
     * @param prompt ä½¿ç”¨è€…è¼¸å…¥
     * @param system ç³»çµ±æç¤ºè©ï¼ˆå¯é¸ï¼‰
     * @return æµå¼å›æ‡‰
     */
    @GetMapping(value = "/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux<String> chat(
            @RequestParam String prompt,
            @RequestParam(required = false) String system) {
        return chatService.streamChat(prompt, system);
    }
    
    /**
     * ç¨‹å¼ç¢¼ç”Ÿæˆæµå¼ç«¯é»
     * @param description ç¨‹å¼éœ€æ±‚æè¿°
     * @param language ç¨‹å¼èªè¨€
     * @return æµå¼ç¨‹å¼ç¢¼
     */
    @GetMapping(value = "/code/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux<String> generateCode(
            @RequestParam String description,
            @RequestParam(defaultValue = "Java") String language) {
        return chatService.streamCodeGeneration(description, language);
    }
    
    /**
     * POST æ–¹å¼çš„æµå¼èŠå¤©ï¼ˆæ”¯æ´è¤‡é›œè«‹æ±‚ï¼‰
     * @param request èŠå¤©è«‹æ±‚
     * @return æµå¼å›æ‡‰
     */
    @PostMapping(value = "/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux<String> chatPost(@RequestBody ChatStreamRequest request) {
        return chatService.streamChat(request.getMessage(), request.getSystemPrompt());
    }
}
```

### è«‹æ±‚ DTO

```java
package com.example.dto;

import lombok.Data;

@Data
public class ChatStreamRequest {
    private String message;
    private String systemPrompt;
    private Double temperature;
    private Integer maxTokens;
}
```

---

## 4.3.7 å‰ç«¯æ•´åˆæŠ€è¡“

### JavaScript EventSource æ•´åˆ

å‰ç«¯å¯ä»¥ä½¿ç”¨ EventSource ä¾†æ¥æ”¶æµå¼è³‡æ–™ï¼š

```javascript
/**
 * æµå¼èŠå¤©åŠŸèƒ½
 * @param {string} prompt - ä½¿ç”¨è€…è¼¸å…¥
 * @param {string} containerId - é¡¯ç¤ºå®¹å™¨ ID
 */
function streamChat(prompt, containerId = 'chat-response') {
    const chatContainer = document.getElementById(containerId);
    const encodedPrompt = encodeURIComponent(prompt);
    const eventSource = new EventSource(`/api/chat/stream?prompt=${encodedPrompt}`);
    
    // æ¸…ç©ºä¹‹å‰çš„å…§å®¹
    chatContainer.innerHTML = '';
    
    // æ¥æ”¶æµå¼è³‡æ–™
    eventSource.onmessage = function(event) {
        const content = event.data;
        if (content && content.trim() !== '') {
            chatContainer.innerHTML += content;
            // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    };
    
    // éŒ¯èª¤è™•ç†
    eventSource.onerror = function(event) {
        console.error('Stream error:', event);
        chatContainer.innerHTML += '<br><span style="color: red;">âŒ é€£ç·šéŒ¯èª¤ï¼Œè«‹é‡æ–°å˜—è©¦</span>';
        eventSource.close();
    };
    
    // é€£ç·šé—œé–‰è™•ç†
    eventSource.addEventListener('close', function() {
        console.log('Stream completed');
        eventSource.close();
    });
    
    // è¿”å› EventSource å¯¦ä¾‹ï¼Œä»¥ä¾¿å¤–éƒ¨æ§åˆ¶
    return eventSource;
}

/**
 * é€²éšæµå¼èŠå¤©ï¼ˆæ”¯æ´å–æ¶ˆï¼‰
 */
class StreamingChat {
    constructor(containerId) {
        this.container = document.getElementById(containerId);
        this.eventSource = null;
    }
    
    start(prompt, systemPrompt = null) {
        this.stop(); // åœæ­¢ä¹‹å‰çš„é€£ç·š
        
        let url = `/api/chat/stream?prompt=${encodeURIComponent(prompt)}`;
        if (systemPrompt) {
            url += `&system=${encodeURIComponent(systemPrompt)}`;
        }
        
        this.eventSource = new EventSource(url);
        this.container.innerHTML = '';
        
        this.eventSource.onmessage = (event) => {
            this.container.innerHTML += event.data;
            this.container.scrollTop = this.container.scrollHeight;
        };
        
        this.eventSource.onerror = (event) => {
            console.error('Stream error:', event);
            this.container.innerHTML += '<br><span class="error">âŒ ç™¼ç”ŸéŒ¯èª¤</span>';
            this.stop();
        };
    }
    
    stop() {
        if (this.eventSource) {
            this.eventSource.close();
            this.eventSource = null;
        }
    }
}

// ä½¿ç”¨ç¯„ä¾‹
const chat = new StreamingChat('chat-response');
chat.start('è«‹ä»‹ç´¹ Spring AI çš„ä¸»è¦åŠŸèƒ½');
```

### React æ•´åˆç¯„ä¾‹

```jsx
import React, { useState, useEffect, useRef } from 'react';

function StreamingChat() {
    const [message, setMessage] = useState('');
    const [response, setResponse] = useState('');
    const [isStreaming, setIsStreaming] = useState(false);
    const eventSourceRef = useRef(null);
    
    const startStreaming = () => {
        if (!message.trim()) return;
        
        setResponse('');
        setIsStreaming(true);
        
        const encodedMessage = encodeURIComponent(message);
        eventSourceRef.current = new EventSource(
            `/api/chat/stream?prompt=${encodedMessage}`
        );
        
        eventSourceRef.current.onmessage = (event) => {
            setResponse(prev => prev + event.data);
        };
        
        eventSourceRef.current.onerror = (error) => {
            console.error('Stream error:', error);
            setIsStreaming(false);
            eventSourceRef.current?.close();
        };
        
        eventSourceRef.current.addEventListener('close', () => {
            setIsStreaming(false);
            eventSourceRef.current?.close();
        });
    };
    
    const stopStreaming = () => {
        eventSourceRef.current?.close();
        setIsStreaming(false);
    };
    
    useEffect(() => {
        return () => {
            eventSourceRef.current?.close();
        };
    }, []);
    
    return (
        <div className="streaming-chat">
            <div className="input-section">
                <textarea
                    value={message}
                    onChange={(e) => setMessage(e.target.value)}
                    placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ..."
                    disabled={isStreaming}
                />
                <button 
                    onClick={startStreaming} 
                    disabled={isStreaming || !message.trim()}
                >
                    {isStreaming ? 'ç”Ÿæˆä¸­...' : 'ç™¼é€'}
                </button>
                {isStreaming && (
                    <button onClick={stopStreaming}>åœæ­¢</button>
                )}
            </div>
            
            <div className="response-section">
                <h3>AI å›æ‡‰ï¼š</h3>
                <div className="response-content">
                    {response || (isStreaming ? 'æ­£åœ¨æ€è€ƒä¸­...' : 'ç­‰å¾…æ‚¨çš„å•é¡Œ')}
                </div>
            </div>
        </div>
    );
}

export default StreamingChat;
```

---

## 4.3.8 æ¸¬è©¦èˆ‡é™¤éŒ¯

### ä½¿ç”¨ Postman æ¸¬è©¦

**åŸºæœ¬æµå¼æ¸¬è©¦**ï¼š
```
GET http://localhost:8080/api/chat/stream?prompt=è§£é‡‹ä»€éº¼æ˜¯Spring AI
```

åœ¨ Postman ä¸­ä½ æœƒçœ‹åˆ°ï¼š
- Response Type é¡¯ç¤ºç‚º `text/event-stream`
- å…§å®¹æœƒåˆ†æ®µå³æ™‚é¡¯ç¤º
- ä¸æœƒç­‰å¾…å®Œæ•´å›æ‡‰æ‰é¡¯ç¤º

**å¸¶ç³»çµ±æç¤ºè©çš„æ¸¬è©¦**ï¼š
```
GET http://localhost:8080/api/chat/stream?prompt=å¯«ä¸€å€‹Hello Worldç¨‹å¼&system=ä½ æ˜¯ä¸€å€‹Javaå°ˆå®¶
```

### ä½¿ç”¨ curl æ¸¬è©¦

```bash
# åŸºæœ¬æµå¼æ¸¬è©¦
curl -N "http://localhost:8080/api/chat/stream?prompt=ä»‹ç´¹Springæ¡†æ¶"

# ç¨‹å¼ç¢¼ç”Ÿæˆæ¸¬è©¦
curl -N "http://localhost:8080/api/chat/code/stream?description=å»ºç«‹ä¸€å€‹ç°¡å–®çš„REST API&language=Java"

# POST æ–¹å¼æ¸¬è©¦
curl -N -X POST "http://localhost:8080/api/chat/stream" \
     -H "Content-Type: application/json" \
     -d '{
       "message": "è«‹è§£é‡‹ä»€éº¼æ˜¯å¾®æœå‹™æ¶æ§‹",
       "systemPrompt": "ä½ æ˜¯ä¸€å€‹æ¶æ§‹å¸«å°ˆå®¶"
     }'
```

**é‡è¦åƒæ•¸**ï¼š
- `-N`: ç¢ºä¿ä¸ç·©è¡è¼¸å‡ºï¼Œèƒ½å³æ™‚çœ‹åˆ°æµå¼çµæœ

### æ•ˆèƒ½æ¸¬è©¦

```bash
# ä½¿ç”¨ Apache Bench æ¸¬è©¦ä½µç™¼æµå¼è«‹æ±‚
ab -n 10 -c 2 "http://localhost:8080/api/chat/stream?prompt=Hello"

# ä½¿ç”¨ wrk é€²è¡Œå£“åŠ›æ¸¬è©¦
wrk -t4 -c10 -d30s "http://localhost:8080/api/chat/stream?prompt=æ¸¬è©¦"
```

---

## 4.3.9 æ•ˆèƒ½å„ªåŒ–èˆ‡æœ€ä½³å¯¦è¸

### é€£ç·šæ± èˆ‡è³‡æºç®¡ç†

```yaml
# application.yml
spring:
  ai:
    openai:
      chat:
        options:
          max-completion-tokens: 1000  # é™åˆ¶è¼¸å‡ºé•·åº¦
          stream-usage: true  # å–å¾—æµå¼å›æ‡‰ä¸­çš„ä½¿ç”¨é‡çµ±è¨ˆ
```

### èƒŒå£“è™•ç†

```java
@GetMapping(value = "/chat/stream/backpressure", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public Flux<String> chatStreamWithBackpressure(@RequestParam String prompt) {
    return chatClient.prompt()
            .user(prompt)
            .stream()
            .content()
            .onBackpressureBuffer(1000)  // è¨­å®šç·©è¡å€å¤§å°
            .publishOn(Schedulers.boundedElastic())  // ä½¿ç”¨å½ˆæ€§åŸ·è¡Œç·’æ± 
            .delayElements(Duration.ofMillis(10));  // æ§åˆ¶ç™¼é€é »ç‡
}
```

### è¨˜æ†¶é«”å„ªåŒ–

```java
@Service
public class OptimizedChatService {
    
    private final ChatClient chatClient;
    private final Scheduler scheduler = Schedulers.newBoundedElastic(
        10, 100, "chat-stream", 60, true
    );
    
    public Flux<String> streamChatOptimized(String prompt) {
        return chatClient.prompt()
                .user(prompt)
                .stream()
                .content()
                .subscribeOn(scheduler)  // ä½¿ç”¨å°ˆç”¨åŸ·è¡Œç·’æ± 
                .doFinally(signalType -> {
                    // æ¸…ç†è³‡æº
                    log.debug("Stream finished with signal: {}", signalType);
                });
    }
}
```

### éŒ¯èª¤è™•ç†èˆ‡é‡è©¦

```java
@GetMapping(value = "/chat/stream/resilient", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public Flux<String> chatStreamResilient(@RequestParam String prompt) {
    return chatClient.prompt()
            .user(prompt)
            .stream()
            .content()
            .timeout(Duration.ofSeconds(30))  // è¨­å®šè¶…æ™‚
            .retryWhen(Retry.backoff(3, Duration.ofSeconds(1))  // æŒ‡æ•¸é€€é¿é‡è©¦
                .filter(throwable -> !(throwable instanceof IllegalArgumentException)))
            .onErrorResume(TimeoutException.class, error -> 
                Flux.just("â° è«‹æ±‚è¶…æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦"))
            .onErrorResume(Exception.class, error -> 
                Flux.just("âŒ æœå‹™æš«æ™‚ä¸å¯ç”¨ï¼š" + error.getMessage()));
}
```

---

## ğŸ“ æœ¬ç« é‡é»å›é¡§

1. **æµå¼è¼¸å‡ºåŸç†**ï¼šç†è§£äº† SSE æŠ€è¡“å’Œæµå¼è¼¸å‡ºçš„å„ªå‹¢
2. **ChatClient æµå¼ API**ï¼šæŒæ¡äº†ä½¿ç”¨ `stream()` æ–¹æ³•å¯¦ç¾æµå¼è¼¸å‡º
3. **Reactive Streams**ï¼šå­¸æœƒäº†ä½¿ç”¨ Flux è™•ç†æµå¼è³‡æ–™
4. **å‰ç«¯æ•´åˆ**ï¼šäº†è§£å¦‚ä½•ä½¿ç”¨ EventSource æ¥æ”¶æµå¼è³‡æ–™
5. **æ•ˆèƒ½å„ªåŒ–**ï¼šæŒæ¡äº†èƒŒå£“è™•ç†ã€éŒ¯èª¤è™•ç†ç­‰æœ€ä½³å¯¦è¸

### æ–°èˆŠç‰ˆæœ¬å°æ¯”

| åŠŸèƒ½ | èˆŠç‰ˆæœ¬ (pre-1.0) | æ–°ç‰ˆæœ¬ (1.0 GA) |
|------|------------------|----------------|
| **API é¢¨æ ¼** | `chatModel.stream(prompt)` | `chatClient.prompt().user(prompt).stream().content()` |
| **å¯è®€æ€§** | è¼ƒä½ | é«˜ï¼ˆFluent APIï¼‰ |
| **åŠŸèƒ½è±å¯Œåº¦** | åŸºç¤ | è±å¯Œï¼ˆç³»çµ±æç¤ºè©ã€é¸é …é…ç½®ç­‰ï¼‰ |
| **éŒ¯èª¤è™•ç†** | éœ€æ‰‹å‹•å¯¦ä½œ | å…§å»ºæ”¯æ´ |
| **æ•ˆèƒ½å„ªåŒ–** | æœ‰é™ | å®Œæ•´çš„ Reactive æ”¯æ´ |

### ä¸‹ä¸€æ­¥å­¸ç¿’æ–¹å‘

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘å€‘å°‡æ·±å…¥æ¢è¨ ChatModel çš„å…§éƒ¨æ©Ÿåˆ¶ï¼Œäº†è§£ä¸åŒ AI æ¨¡å‹çš„ç‰¹æ€§å’Œé¸æ“‡ç­–ç•¥ï¼Œç‚ºä¼æ¥­ç´šæ‡‰ç”¨åšå¥½æº–å‚™ã€‚

---

**åƒè€ƒè³‡æ–™ï¼š**
- [Server-Sent Events Specification](https://html.spec.whatwg.org/multipage/server-sent-events.html)
- [Spring WebFlux Reactive Streams](https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html)
- [Project Reactor Documentation](https://projectreactor.io/docs/core/release/reference/)
- [Spring AI Streaming Documentation](https://docs.spring.io/spring-ai/reference/api/chatclient.html#streaming)