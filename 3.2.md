# 3.1 æª”æ¡ˆä¸Šå‚³èˆ‡ä¸‹è¼‰åŸºç¤

## å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬ç« å­¸ç¿’å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š

- ğŸ¯ **ç†è§£æª”æ¡ˆè™•ç†çš„é‡è¦æ€§**ï¼šæŒæ¡ Web æ‡‰ç”¨ä¸­æª”æ¡ˆè™•ç†çš„æ ¸å¿ƒæ¦‚å¿µå’Œæ‡‰ç”¨å ´æ™¯
- ğŸ¯ **æŒæ¡ Spring Boot æª”æ¡ˆé…ç½®**ï¼šå­¸æœƒé…ç½®æª”æ¡ˆä¸Šå‚³çš„åŸºæœ¬åƒæ•¸å’Œé™åˆ¶
- ğŸ¯ **å¯¦ä½œæª”æ¡ˆä¸Šå‚³åŠŸèƒ½**ï¼šä½¿ç”¨ MultipartFile è™•ç†å–®æª”æ¡ˆå’Œå¤šæª”æ¡ˆä¸Šå‚³
- ğŸ¯ **å¯¦ç¾æª”æ¡ˆä¸‹è¼‰æœå‹™**ï¼šå»ºç«‹å®‰å…¨å¯é çš„æª”æ¡ˆä¸‹è¼‰æ©Ÿåˆ¶
- ğŸ¯ **è™•ç†å¸¸è¦‹å•é¡Œ**ï¼šäº†è§£æª”æ¡ˆè™•ç†ä¸­çš„å®‰å…¨æ€§å’Œæ•ˆèƒ½è€ƒé‡

---

## 3.1.1 ç‚ºä»€éº¼éœ€è¦æª”æ¡ˆè™•ç†ï¼Ÿ

### æª”æ¡ˆè™•ç†åœ¨ç¾ä»£æ‡‰ç”¨ä¸­çš„é‡è¦æ€§

åœ¨ç¾ä»£ Web æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œæª”æ¡ˆè™•ç†æ˜¯ä¸€é …åŸºç¤ä¸”é‡è¦çš„åŠŸèƒ½ã€‚ç„¡è«–æ˜¯ç¤¾ç¾¤åª’é«”çš„ç…§ç‰‡åˆ†äº«ã€ä¼æ¥­ç³»çµ±çš„æ–‡ä»¶ç®¡ç†ï¼Œé‚„æ˜¯é›»å•†å¹³å°çš„å•†å“åœ–ç‰‡ä¸Šå‚³ï¼Œéƒ½é›¢ä¸é–‹æª”æ¡ˆè™•ç†æ©Ÿåˆ¶ã€‚

> **æ€è€ƒå•é¡Œ**ï¼šæ‚¨åœ¨æ—¥å¸¸ä½¿ç”¨çš„æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œæœ‰å“ªäº›åŠŸèƒ½æ¶‰åŠåˆ°æª”æ¡ˆä¸Šå‚³æˆ–ä¸‹è¼‰ï¼Ÿ
> - ç¤¾ç¾¤åª’é«”ä¸Šå‚³ç…§ç‰‡å’Œå½±ç‰‡
> - é›²ç«¯ç¡¬ç¢Ÿå„²å­˜å’Œåˆ†äº«æª”æ¡ˆ
> - ç·šä¸Šè¾¦å…¬ç³»çµ±çš„æ–‡ä»¶å”ä½œ
> - é›»å•†å¹³å°çš„å•†å“åœ–ç‰‡ç®¡ç†

### å¸¸è¦‹çš„æª”æ¡ˆè™•ç†å ´æ™¯

**1. ä½¿ç”¨è€…å…§å®¹ç®¡ç†**
- å€‹äººé ­åƒä¸Šå‚³
- æ–‡ä»¶é™„ä»¶è™•ç†
- å¤šåª’é«”å…§å®¹åˆ†äº«

**2. ä¼æ¥­æ–‡ä»¶ç³»çµ±**
- åˆç´„æ–‡ä»¶ä¸Šå‚³
- å ±è¡¨æª”æ¡ˆä¸‹è¼‰
- å‚™ä»½æª”æ¡ˆç®¡ç†

**3. é›»å•†æ‡‰ç”¨**
- å•†å“åœ–ç‰‡ä¸Šå‚³
- ç”¢å“ç›®éŒ„ä¸‹è¼‰
- è¨‚å–®ç›¸é—œæ–‡ä»¶

ğŸ’¡ **é‡é»æç¤º**ï¼šè‰¯å¥½çš„æª”æ¡ˆè™•ç†æ©Ÿåˆ¶ä¸åƒ…è¦è€ƒæ…®åŠŸèƒ½å¯¦ç¾ï¼Œé‚„è¦é‡è¦–å®‰å…¨æ€§ã€æ•ˆèƒ½å’Œä½¿ç”¨è€…é«”é©—ã€‚

---

## 3.1.2 æª”æ¡ˆä¸Šå‚³åŸºç¤æ¦‚å¿µ

### HTTP æª”æ¡ˆä¸Šå‚³åŸç†

æª”æ¡ˆä¸Šå‚³æ˜¯é€é HTTP å”å®šçš„ `multipart/form-data` ç·¨ç¢¼æ–¹å¼å¯¦ç¾çš„ã€‚é€™ç¨®ç·¨ç¢¼æ–¹å¼å…è¨±åœ¨å–®ä¸€è«‹æ±‚ä¸­å‚³é€æ–‡å­—è³‡æ–™å’ŒäºŒé€²ä½æª”æ¡ˆã€‚

**å‚³çµ±è¡¨å–® vs æª”æ¡ˆä¸Šå‚³è¡¨å–®**ï¼š

```html
<!-- å‚³çµ±è¡¨å–® -->
<form method="post" action="/submit">
    <input type="text" name="username" />
    <input type="submit" value="æäº¤" />
</form>

<!-- æª”æ¡ˆä¸Šå‚³è¡¨å–® -->
<form method="post" action="/upload" enctype="multipart/form-data">
    <input type="file" name="file" />
    <input type="submit" value="ä¸Šå‚³" />
</form>
```

### Spring Boot ä¸­çš„æª”æ¡ˆè™•ç†

Spring Boot é€é `MultipartFile` ä»‹é¢æä¾›äº†ç°¡æ½”çš„æª”æ¡ˆè™•ç†æ–¹å¼ï¼š

```java
// MultipartFile çš„æ ¸å¿ƒæ–¹æ³•
public interface MultipartFile {
    String getName();           // å–å¾—è¡¨å–®æ¬„ä½åç¨±
    String getOriginalFilename(); // å–å¾—åŸå§‹æª”æ¡ˆåç¨±
    String getContentType();    // å–å¾—æª”æ¡ˆé¡å‹
    long getSize();            // å–å¾—æª”æ¡ˆå¤§å°
    byte[] getBytes();         // å–å¾—æª”æ¡ˆå…§å®¹
    InputStream getInputStream(); // å–å¾—è¼¸å…¥ä¸²æµ
    void transferTo(File dest); // å„²å­˜æª”æ¡ˆåˆ°æŒ‡å®šä½ç½®
}
```

âš ï¸ **æ³¨æ„äº‹é …**ï¼š
- `MultipartFile` åªåœ¨è«‹æ±‚è™•ç†æœŸé–“æœ‰æ•ˆ
- æª”æ¡ˆå…§å®¹æœƒæš«å­˜åœ¨è¨˜æ†¶é«”æˆ–è‡¨æ™‚æª”æ¡ˆä¸­
- è™•ç†å®Œæˆå¾Œæ‡‰åŠæ™‚æ¸…ç†è³‡æº

---

## 3.1.3 åŸºæœ¬æª”æ¡ˆä¸Šå‚³å¯¦ä½œ

### 1. æª”æ¡ˆä¸Šå‚³é…ç½®

é¦–å…ˆåœ¨ [`application.properties`](application.properties) ä¸­é…ç½®æª”æ¡ˆä¸Šå‚³åƒæ•¸ï¼š

```properties
# æª”æ¡ˆä¸Šå‚³é…ç½®
spring.servlet.multipart.enabled=true
spring.servlet.multipart.max-file-size=10MB
spring.servlet.multipart.max-request-size=50MB
spring.servlet.multipart.file-size-threshold=2KB

# æª”æ¡ˆå„²å­˜è·¯å¾‘
app.upload.path=./uploads
```

**é…ç½®èªªæ˜**ï¼š

| é…ç½®é …ç›® | èªªæ˜ | é è¨­å€¼ | å»ºè­°å€¼ |
|---------|------|--------|--------|
| `max-file-size` | å–®æª”æ¡ˆæœ€å¤§å¤§å° | 1MB | 10MB |
| `max-request-size` | è«‹æ±‚æœ€å¤§å¤§å° | 10MB | 50MB |
| `file-size-threshold` | è¨˜æ†¶é«”æš«å­˜é–¾å€¼ | 0 | 2KB |

### 2. ç°¡å–®æª”æ¡ˆä¸Šå‚³æ§åˆ¶å™¨

```java
/**
 * æª”æ¡ˆä¸Šå‚³æ§åˆ¶å™¨
 * æä¾›åŸºæœ¬çš„æª”æ¡ˆä¸Šå‚³åŠŸèƒ½
 */
@RestController
@RequestMapping("/api/files")
@Slf4j
public class FileUploadController {
    
    @Value("${app.upload.path:./uploads}")
    private String uploadPath;
    
    /**
     * å–®æª”æ¡ˆä¸Šå‚³
     * @param file ä¸Šå‚³çš„æª”æ¡ˆ
     * @return ä¸Šå‚³çµæœ
     */
    @PostMapping("/upload")
    public ResponseEntity<String> uploadFile(@RequestParam("file") MultipartFile file) {
        
        // æª¢æŸ¥æª”æ¡ˆæ˜¯å¦ç‚ºç©º
        if (file.isEmpty()) {
            return ResponseEntity.badRequest().body("è«‹é¸æ“‡è¦ä¸Šå‚³çš„æª”æ¡ˆ");
        }
        
        try {
            // å»ºç«‹ä¸Šå‚³ç›®éŒ„
            Path uploadDir = Paths.get(uploadPath);
            if (!Files.exists(uploadDir)) {
                Files.createDirectories(uploadDir);
            }
            
            // ç”¢ç”Ÿå”¯ä¸€æª”æ¡ˆåç¨±
            String fileName = System.currentTimeMillis() + "_" + file.getOriginalFilename();
            Path filePath = uploadDir.resolve(fileName);
            
            // å„²å­˜æª”æ¡ˆ
            file.transferTo(filePath.toFile());
            
            log.info("æª”æ¡ˆä¸Šå‚³æˆåŠŸ: {}", fileName);
            return ResponseEntity.ok("æª”æ¡ˆä¸Šå‚³æˆåŠŸ: " + fileName);
            
        } catch (IOException e) {
            log.error("æª”æ¡ˆä¸Šå‚³å¤±æ•—", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body("æª”æ¡ˆä¸Šå‚³å¤±æ•—: " + e.getMessage());
        }
    }
}
```

### 3. å¤šæª”æ¡ˆä¸Šå‚³è™•ç†

```java
/**
 * å¤šæª”æ¡ˆä¸Šå‚³
 * @param files ä¸Šå‚³çš„æª”æ¡ˆé™£åˆ—
 * @return ä¸Šå‚³çµæœ
 */
@PostMapping("/upload-multiple")
public ResponseEntity<List<String>> uploadMultipleFiles(
        @RequestParam("files") MultipartFile[] files) {
    
    List<String> uploadedFiles = new ArrayList<>();
    
    for (MultipartFile file : files) {
        if (!file.isEmpty()) {
            try {
                String fileName = System.currentTimeMillis() + "_" + file.getOriginalFilename();
                Path filePath = Paths.get(uploadPath).resolve(fileName);
                file.transferTo(filePath.toFile());
                uploadedFiles.add(fileName);
                
            } catch (IOException e) {
                log.error("æª”æ¡ˆä¸Šå‚³å¤±æ•—: {}", file.getOriginalFilename(), e);
            }
        }
    }
    
    return ResponseEntity.ok(uploadedFiles);
}
```

ğŸš€ **å¯¦ç”¨æŠ€å·§**ï¼šä½¿ç”¨æ™‚é–“æˆ³è¨˜å‰ç¶´å¯ä»¥é¿å…æª”æ¡ˆåç¨±è¡çªï¼ŒåŒæ™‚ä¿æŒæª”æ¡ˆçš„å¯è¿½è¹¤æ€§ã€‚

---

## 3.1.4 æª”æ¡ˆä¸‹è¼‰åŸºç¤å¯¦ä½œ

### 1. ç°¡å–®æª”æ¡ˆä¸‹è¼‰

```java
/**
 * æª”æ¡ˆä¸‹è¼‰
 * @param fileName æª”æ¡ˆåç¨±
 * @return æª”æ¡ˆå…§å®¹
 */
@GetMapping("/download/{fileName}")
public ResponseEntity<Resource> downloadFile(@PathVariable String fileName) {
    
    try {
        Path filePath = Paths.get(uploadPath).resolve(fileName);
        Resource resource = new UrlResource(filePath.toUri());
        
        if (resource.exists() && resource.isReadable()) {
            return ResponseEntity.ok()
                    .header(HttpHeaders.CONTENT_DISPOSITION, 
                           "attachment; filename=\"" + fileName + "\"")
                    .body(resource);
        } else {
            return ResponseEntity.notFound().build();
        }
        
    } catch (MalformedURLException e) {
        log.error("æª”æ¡ˆä¸‹è¼‰å¤±æ•—: {}", fileName, e);
        return ResponseEntity.badRequest().build();
    }
}
```

### 2. æª”æ¡ˆé è¦½åŠŸèƒ½

```java
/**
 * æª”æ¡ˆé è¦½ï¼ˆé©ç”¨æ–¼åœ–ç‰‡ç­‰åª’é«”æª”æ¡ˆï¼‰
 * @param fileName æª”æ¡ˆåç¨±
 * @return æª”æ¡ˆå…§å®¹
 */
@GetMapping("/preview/{fileName}")
public ResponseEntity<Resource> previewFile(@PathVariable String fileName) {
    
    try {
        Path filePath = Paths.get(uploadPath).resolve(fileName);
        Resource resource = new UrlResource(filePath.toUri());
        
        if (resource.exists() && resource.isReadable()) {
            // æ ¹æ“šæª”æ¡ˆå‰¯æª”åè¨­å®š Content-Type
            String contentType = Files.probeContentType(filePath);
            
            return ResponseEntity.ok()
                    .header(HttpHeaders.CONTENT_TYPE, contentType)
                    .body(resource);
        } else {
            return ResponseEntity.notFound().build();
        }
        
    } catch (Exception e) {
        log.error("æª”æ¡ˆé è¦½å¤±æ•—: {}", fileName, e);
        return ResponseEntity.badRequest().build();
    }
}
```

---

## 3.1.5 å¸¸è¦‹å•é¡Œèˆ‡æ³¨æ„äº‹é …

### 1. æª”æ¡ˆå®‰å…¨æ€§è€ƒé‡

**æª”æ¡ˆé¡å‹é©—è­‰**ï¼š
```java
/**
 * æª¢æŸ¥æª”æ¡ˆé¡å‹æ˜¯å¦å…è¨±
 * @param file ä¸Šå‚³çš„æª”æ¡ˆ
 * @return æ˜¯å¦å…è¨±
 */
private boolean isAllowedFileType(MultipartFile file) {
    String contentType = file.getContentType();
    return contentType != null && (
        contentType.startsWith("image/") ||
        contentType.equals("application/pdf") ||
        contentType.equals("text/plain")
    );
}
```

**æª”æ¡ˆå¤§å°é™åˆ¶**ï¼š
```java
/**
 * æª¢æŸ¥æª”æ¡ˆå¤§å°
 * @param file ä¸Šå‚³çš„æª”æ¡ˆ
 * @return æ˜¯å¦ç¬¦åˆå¤§å°é™åˆ¶
 */
private boolean isValidFileSize(MultipartFile file) {
    long maxSize = 10 * 1024 * 1024; // 10MB
    return file.getSize() <= maxSize;
}
```

### 2. æ•ˆèƒ½æœ€ä½³åŒ–å»ºè­°

âœ… **æœ€ä½³å¯¦è¸**ï¼š
- ä½¿ç”¨ä¸²æµè™•ç†å¤§æª”æ¡ˆï¼Œé¿å…è¨˜æ†¶é«”æº¢ä½
- å¯¦ä½œæª”æ¡ˆé¡å‹å’Œå¤§å°é©—è­‰
- ä½¿ç”¨å”¯ä¸€æª”æ¡ˆåç¨±é¿å…è¡çª
- å®šæœŸæ¸…ç†æš«å­˜æª”æ¡ˆ

âš ï¸ **å¸¸è¦‹é™·é˜±**ï¼š
- æœªé©—è­‰æª”æ¡ˆé¡å‹å¯èƒ½å°è‡´å®‰å…¨é¢¨éšª
- æª”æ¡ˆåç¨±æœªè™•ç†å¯èƒ½é€ æˆè·¯å¾‘éæ­·æ”»æ“Š
- ç¼ºä¹æª”æ¡ˆå¤§å°é™åˆ¶å¯èƒ½å°è‡´ç£ç¢Ÿç©ºé–“è€—ç›¡

### 3. éŒ¯èª¤è™•ç†ç­–ç•¥

```java
/**
 * å…¨åŸŸæª”æ¡ˆè™•ç†ç•°å¸¸è™•ç†å™¨
 */
@ControllerAdvice
public class FileExceptionHandler {
    
    @ExceptionHandler(MaxUploadSizeExceededException.class)
    public ResponseEntity<String> handleMaxSizeException(MaxUploadSizeExceededException e) {
        return ResponseEntity.status(HttpStatus.PAYLOAD_TOO_LARGE)
                .body("æª”æ¡ˆå¤§å°è¶…éé™åˆ¶");
    }
    
    @ExceptionHandler(MultipartException.class)
    public ResponseEntity<String> handleMultipartException(MultipartException e) {
        return ResponseEntity.badRequest()
                .body("æª”æ¡ˆä¸Šå‚³æ ¼å¼éŒ¯èª¤");
    }
}
```

---

## é‡é»æ‘˜è¦

### ğŸ¯ æ ¸å¿ƒæ¦‚å¿µå›é¡§

1. **æª”æ¡ˆè™•ç†çš„é‡è¦æ€§**ï¼š
   - ç¾ä»£ Web æ‡‰ç”¨çš„åŸºç¤åŠŸèƒ½
   - æ¶µè“‹ä½¿ç”¨è€…å…§å®¹ã€ä¼æ¥­æ–‡ä»¶ã€é›»å•†æ‡‰ç”¨ç­‰å ´æ™¯
   - éœ€è¦è€ƒæ…®å®‰å…¨æ€§ã€æ•ˆèƒ½å’Œä½¿ç”¨è€…é«”é©—

2. **Spring Boot æª”æ¡ˆè™•ç†æ©Ÿåˆ¶**ï¼š
   - ä½¿ç”¨ `MultipartFile` ä»‹é¢è™•ç†æª”æ¡ˆä¸Šå‚³
   - é€é `multipart/form-data` ç·¨ç¢¼å‚³è¼¸æª”æ¡ˆ
   - æ”¯æ´å–®æª”æ¡ˆå’Œå¤šæª”æ¡ˆä¸Šå‚³

3. **åŸºæœ¬å¯¦ä½œè¦é»**ï¼š
   - æ­£ç¢ºé…ç½®æª”æ¡ˆä¸Šå‚³åƒæ•¸
   - å¯¦ä½œæª”æ¡ˆé¡å‹å’Œå¤§å°é©—è­‰
   - æä¾›å®‰å…¨çš„æª”æ¡ˆä¸‹è¼‰æ©Ÿåˆ¶

### ğŸ’¡ å­¸ç¿’è¦é»

- æª”æ¡ˆè™•ç†ä¸åƒ…æ˜¯æŠ€è¡“å¯¦ä½œï¼Œæ›´è¦é‡è¦–å®‰å…¨æ€§è€ƒé‡
- `MultipartFile` æä¾›äº†ç°¡æ½”æ˜“ç”¨çš„æª”æ¡ˆè™•ç† API
- é©ç•¶çš„é…ç½®å’Œé©—è­‰æ˜¯æª”æ¡ˆè™•ç†ç³»çµ±çš„åŸºç¤
- éŒ¯èª¤è™•ç†å’Œç•°å¸¸ç®¡ç†åŒæ¨£é‡è¦

### ğŸš€ ä¸‹ä¸€æ­¥è¡Œå‹•

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘å€‘å°‡å­¸ç¿’æ›´é€²éšçš„æª”æ¡ˆè™•ç†æŠ€è¡“ï¼ŒåŒ…æ‹¬ï¼š
- æª”æ¡ˆé¡å‹æª¢æ¸¬å’Œå®‰å…¨æƒæ
- å¤§æª”æ¡ˆåˆ†å¡Šä¸Šå‚³è™•ç†
- æª”æ¡ˆå¿«å–å’Œ CDN æ•´åˆ
- æª”æ¡ˆè™•ç†çš„ç›£æ§å’Œæ—¥èªŒè¨˜éŒ„

---

> **ç« ç¯€ç¸½çµ**ï¼šæª”æ¡ˆä¸Šå‚³èˆ‡ä¸‹è¼‰æ˜¯ Web æ‡‰ç”¨ç¨‹å¼ä¸­çš„åŸºç¤åŠŸèƒ½ï¼ŒSpring Boot é€é MultipartFile ä»‹é¢æä¾›äº†ç°¡æ½”è€Œå¼·å¤§çš„æª”æ¡ˆè™•ç†èƒ½åŠ›ã€‚æŒæ¡åŸºæœ¬çš„æª”æ¡ˆä¸Šå‚³ä¸‹è¼‰å¯¦ä½œï¼Œä¸¦é‡è¦–å®‰å…¨æ€§å’Œæ•ˆèƒ½è€ƒé‡ï¼Œæ˜¯å»ºæ§‹å¯é æª”æ¡ˆè™•ç†ç³»çµ±çš„é—œéµã€‚åœ¨å¯¦éš›é–‹ç™¼ä¸­ï¼Œé™¤äº†åŠŸèƒ½å¯¦ç¾å¤–ï¼Œæ›´è¦æ³¨é‡ä½¿ç”¨è€…é«”é©—å’Œç³»çµ±ç©©å®šæ€§ã€‚