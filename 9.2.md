# 9.2 引入 Spring MCP

> **本章重點**：學習如何在 Spring AI 專案中引入 MCP 支援，掌握 MCP Client 和 Server 的基礎配置方法，建立簡單的 Spring MCP 開發環境。

## 🎯 學習目標

完成本章學習後，您將能夠：

- 🎯 **配置 Spring MCP 依賴**：正確引入 Spring AI MCP 相關依賴套件
- 🎯 **設置 MCP Client**：配置和使用 Spring AI MCP Client
- 🎯 **建立 MCP Server**：創建和配置 Spring AI MCP Server
- 🎯 **整合現有系統**：將 MCP 整合到現有的 Spring AI 應用中

---

## 9.2.1 Spring AI MCP 依賴配置

### Maven 依賴設置

#### MCP Client 依賴

```xml
<!-- Spring AI MCP Client Starter -->
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-mcp-client-starter</artifactId>
</dependency>
```

#### MCP Server 依賴

```xml
<!-- Spring AI MCP Server WebMVC 版本 -->
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-mcp-server-webmvc-starter</artifactId>
</dependency>
```

#### 完整的 pom.xml 範例

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.4.0</version>
        <relativePath/>
    </parent>
    
    <groupId>com.example</groupId>
    <artifactId>spring-ai-mcp-demo</artifactId>
    <version>1.0.0</version>
    <name>Spring AI MCP Demo</name>
    <description>Spring AI MCP 整合示範專案</description>
    
    <properties>
        <java.version>17</java.version>
        <spring-ai.version>1.0.0</spring-ai.version>
    </properties>
    
    <dependencies>
        <!-- Spring Boot 基礎依賴 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        
        <!-- Spring AI 核心依賴 -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-spring-boot-starter</artifactId>
        </dependency>
        
        <!-- Spring AI OpenAI 支援 -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-openai-spring-boot-starter</artifactId>
        </dependency>
        
        <!-- Spring AI MCP Client -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-mcp-client-starter</artifactId>
        </dependency>
        
        <!-- Spring AI MCP Server WebMVC -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-mcp-server-webmvc-starter</artifactId>
        </dependency>
        
        <!-- 測試依賴 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
    
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>${spring-ai.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>
    
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
```

---

## 9.2.2 MCP Client 配置

### 基礎配置

#### application.yml 配置

```yaml
# Spring AI MCP Client 配置
spring:
  ai:
    mcp:
      client:
        # 客戶端基本資訊
        enabled: true
        name: enterprise-mcp-client
        version: "1.0.0"
        type: SYNC
        initialized: true
        request-timeout: 30s
        root-change-notification: true
        toolcallback:
          enabled: true
        
        # SSE 連接配置
        sse:
          connections:
            document-search:
              url: http://localhost:8080
              sse-endpoint: /sse
            knowledge-base:
              url: http://localhost:8081
              sse-endpoint: /sse
        
        # Streamable HTTP 連接配置
        streamable-http:
          connections:
            api-server:
              url: http://localhost:8082
              endpoint: /mcp
        
        # STDIO 連接配置
        stdio:
          connections:
            filesystem-server:
              command: npx
              args:
                - "-y"
                - "@modelcontextprotocol/server-filesystem"
                - "/path/to/documents"
                - "/path/to/workspace"
              env:
                NODE_ENV: "production"
            local-java-server:
              command: java
              args:
                - "-jar"
                - "/path/to/custom-mcp-server.jar"
                - "--server.port=0"
                - "--spring.profiles.active=mcp"
              env:
                SPRING_PROFILES_ACTIVE: "mcp"
                SERVER_MODE: "stdio"
```

### Java 配置類

```java
/**
 * MCP Client 配置類
 */
@Configuration
@Slf4j
public class McpClientConfiguration {
    
    /**
     * 自定義 MCP Sync Client 配置
     */
    @Bean
    public McpSyncClientCustomizer enterpriseClientCustomizer() {
        return new EnterpriseMcpClientCustomizer();
    }
}

/**
 * 企業級 MCP Client 自定義器
 */
@Component
@Slf4j
public class EnterpriseMcpClientCustomizer implements McpSyncClientCustomizer {
    
    @Override
    public void customize(String serverConfigurationName, McpClient.SyncSpec spec) {
        log.info("自定義 MCP Client: {}", serverConfigurationName);
        
        // 配置請求超時
        spec.requestTimeout(Duration.ofSeconds(30));
        
        // 配置事件監聽器
        configureEventListeners(serverConfigurationName, spec);
    }
    
    private void configureEventListeners(String serverName, McpClient.SyncSpec spec) {
        // 工具變更事件
        spec.toolsChangeConsumer(tools -> {
            log.info("伺服器 {} 的工具已更新，共 {} 個工具", serverName, tools.size());
        });
        
        // 資源變更事件
        spec.resourcesChangeConsumer(resources -> {
            log.info("伺服器 {} 的資源已更新，共 {} 個資源", serverName, resources.size());
        });
        
        // 提示變更事件
        spec.promptsChangeConsumer(prompts -> {
            log.info("伺服器 {} 的提示已更新，共 {} 個提示", serverName, prompts.size());
        });
        
        // 日誌事件
        spec.loggingConsumer(logMessage -> {
            handleServerLog(serverName, logMessage);
        });
    }
    
    private void handleServerLog(String serverName, McpSchema.LoggingMessageNotification log) {
        // 處理伺服器日誌
        String message = String.format("[%s] %s", serverName, log.data());
        switch (log.level()) {
            case ERROR -> log.error(message);
            case WARNING -> log.warn(message);  
            case INFO -> log.info(message);
            case DEBUG -> log.debug(message);
        }
    }
}
```

---

## 9.2.3 MCP Server 配置

### 基礎 Server 配置

#### application.yml 配置

```yaml
# Spring AI MCP Server 配置
spring:
  ai:
    mcp:
      server:
        # 伺服器基本資訊
        enabled: true
        name: enterprise-mcp-server
        version: "1.0.0"
        instructions: "Enterprise MCP Server providing document search and knowledge base access"
        type: SYNC
        request-timeout: 20s
        
        # 能力配置
        capabilities:
          resource: true
          tool: true
          prompt: true
          completion: true
        
        # 變更通知配置
        resource-change-notification: true
        prompt-change-notification: true
        tool-change-notification: true
        
        # Server-Sent Events 配置
        sse-endpoint: /sse
        sse-message-endpoint: /mcp/message
        base-url: ""
```

### 簡單的 Java Server 配置

```java
/**
 * MCP Server 配置類
 */
@Configuration
@Slf4j
public class McpServerConfiguration {
    
    /**
     * 文檔搜尋工具
     */
    @Bean
    public ToolCallbackProvider documentSearchTools(DocumentSearchService service) {
        return MethodToolCallbackProvider.builder()
            .toolObjects(service)
            .build();
    }
}

/**
 * 文檔搜尋服務
 */
@Service
@Slf4j
public class DocumentSearchService {
    
    /**
     * 搜尋企業文檔
     */
    @Tool(description = "搜尋企業文檔庫中的相關文檔")
    public String searchDocuments(
            @Parameter(description = "搜尋關鍵字") String query) {
        
        log.info("執行文檔搜尋: {}", query);
        
        // 實際搜尋邏輯
        return "找到相關文檔: " + query;
    }
}
```

---

## 9.2.4 整合 ChatClient

### MCP 與 ChatClient 整合服務

```java
/**
 * MCP 與 ChatClient 整合服務
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class McpChatIntegrationService {
    
    private final ChatClient chatClient;
    private final SyncMcpToolCallbackProvider toolCallbackProvider;
    
    /**
     * 使用 MCP 工具增強的聊天服務
     */
    public String chatWithMcpTools(String userMessage) {
        
        try {
            // 獲取 MCP 工具
            ToolCallback[] mcpTools = toolCallbackProvider.getToolCallbacks();
            
            // 使用 ChatClient 與 MCP 工具整合
            return chatClient.prompt()
                .user(userMessage)
                .functions(mcpTools)  // 使用 functions 整合 MCP 工具
                .call()
                .content();
                
        } catch (Exception e) {
            log.error("MCP 聊天服務失敗", e);
            return "抱歉，服務暫時不可用，請稍後再試。";
        }
    }
}
```

### 聊天控制器

```java
/**
 * MCP 聊天控制器
 */
@RestController
@RequestMapping("/api/chat")
@RequiredArgsConstructor
@Slf4j
public class McpChatController {
    
    private final McpChatIntegrationService chatService;
    
    /**
     * MCP 增強的聊天端點
     */
    @PostMapping("/mcp")
    public ResponseEntity<String> chatWithMcp(@RequestBody String message) {
        
        try {
            String response = chatService.chatWithMcpTools(message);
            return ResponseEntity.ok(response);
            
        } catch (Exception e) {
            log.error("聊天請求處理失敗", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body("服務暫時不可用");
        }
    }
}
```

---

## 9.2.5 應用程式入口

### Spring Boot 主類別

```java
/**
 * Spring AI MCP 示範應用
 */
@SpringBootApplication
@Slf4j
public class SpringAiMcpDemoApplication {
    
    public static void main(String[] args) {
        SpringApplication.run(SpringAiMcpDemoApplication.class, args);
        log.info("Spring AI MCP 示範應用已啟動");
    }
}
```

---

## 📝 本章重點回顧

1. **依賴配置**：正確引入 Spring AI MCP Client 和 Server 相關依賴
2. **基礎配置**：掌握了 MCP 的基本 YAML 和 Java 配置方法
3. **工具註冊**：學會使用 `@Tool` 註解和 `ToolCallbackProvider` 註冊 MCP 工具
4. **ChatClient 整合**：實現了 MCP 工具與 ChatClient 的無縫整合
5. **實際應用**：建立了完整的 MCP 應用程式架構

### 核心配置要點

| 配置項目 | 說明 | 重要性 |
|---------|------|--------|
| **Client 配置** | 設置 MCP Client 連接和參數 | ⭐⭐⭐⭐⭐ |
| **Server 配置** | 設置 MCP Server 基本資訊 | ⭐⭐⭐⭐⭐ |
| **工具註冊** | 使用 `@Tool` 註解註冊工具 | ⭐⭐⭐⭐⭐ |
| **ChatClient 整合** | 使用 `.functions()` 整合工具 | ⭐⭐⭐⭐ |

### 下一步學習方向

在下一節中，我們將學習如何在 Spring AI 應用中具體使用 MCP 工具，包括：
- MCP 工具的發現和調用
- 與 ChatClient 的進階整合
- 錯誤處理和監控
- 實際應用場景示例

---

**參考資料：**
- [Spring AI MCP Client Documentation](https://docs.spring.io/spring-ai/reference/1.1-SNAPSHOT/api/mcp/mcp-client-boot-starter-docs.html)
- [Spring AI MCP Server Documentation](https://docs.spring.io/spring-ai/reference/1.1-SNAPSHOT/api/mcp/mcp-server-boot-starter-docs.html)
- [Spring AI MCP Overview](https://docs.spring.io/spring-ai/reference/1.1-SNAPSHOT/api/mcp/mcp-overview.html)
- [Model Context Protocol Specification](https://modelcontextprotocol.github.io/specification/)