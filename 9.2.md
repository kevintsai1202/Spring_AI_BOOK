# 9.2 å¼•å…¥ Spring MCP

> **æœ¬ç« é‡é»**ï¼šå­¸ç¿’å¦‚ä½•åœ¨ Spring AI å°ˆæ¡ˆä¸­å¼•å…¥ MCP æ”¯æ´ï¼ŒæŒæ¡ MCP Client å’Œ Server çš„åŸºç¤é…ç½®æ–¹æ³•ï¼Œå»ºç«‹ç°¡å–®çš„ Spring MCP é–‹ç™¼ç’°å¢ƒã€‚

## ğŸ¯ å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬ç« å­¸ç¿’å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š

- ğŸ¯ **é…ç½® Spring MCP ä¾è³´**ï¼šæ­£ç¢ºå¼•å…¥ Spring AI MCP ç›¸é—œä¾è³´å¥—ä»¶
- ğŸ¯ **è¨­ç½® MCP Client**ï¼šé…ç½®å’Œä½¿ç”¨ Spring AI MCP Client
- ğŸ¯ **å»ºç«‹ MCP Server**ï¼šå‰µå»ºå’Œé…ç½® Spring AI MCP Server
- ğŸ¯ **æ•´åˆç¾æœ‰ç³»çµ±**ï¼šå°‡ MCP æ•´åˆåˆ°ç¾æœ‰çš„ Spring AI æ‡‰ç”¨ä¸­

---

## 9.2.1 Spring AI MCP ä¾è³´é…ç½®

### Maven ä¾è³´è¨­ç½®

#### MCP Client ä¾è³´

```xml
<!-- Spring AI MCP Client Starter -->
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-mcp-client-starter</artifactId>
</dependency>
```

#### MCP Server ä¾è³´

```xml
<!-- Spring AI MCP Server WebMVC ç‰ˆæœ¬ -->
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-mcp-server-webmvc-starter</artifactId>
</dependency>
```

#### å®Œæ•´çš„ pom.xml ç¯„ä¾‹

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.4.0</version>
        <relativePath/>
    </parent>
    
    <groupId>com.example</groupId>
    <artifactId>spring-ai-mcp-demo</artifactId>
    <version>1.0.0</version>
    <name>Spring AI MCP Demo</name>
    <description>Spring AI MCP æ•´åˆç¤ºç¯„å°ˆæ¡ˆ</description>
    
    <properties>
        <java.version>17</java.version>
        <spring-ai.version>1.0.0</spring-ai.version>
    </properties>
    
    <dependencies>
        <!-- Spring Boot åŸºç¤ä¾è³´ -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        
        <!-- Spring AI æ ¸å¿ƒä¾è³´ -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-spring-boot-starter</artifactId>
        </dependency>
        
        <!-- Spring AI OpenAI æ”¯æ´ -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-openai-spring-boot-starter</artifactId>
        </dependency>
        
        <!-- Spring AI MCP Client -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-mcp-client-starter</artifactId>
        </dependency>
        
        <!-- Spring AI MCP Server WebMVC -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-mcp-server-webmvc-starter</artifactId>
        </dependency>
        
        <!-- æ¸¬è©¦ä¾è³´ -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
    
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>${spring-ai.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>
    
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
```

---

## 9.2.2 MCP Client é…ç½®

### åŸºç¤é…ç½®

#### application.yml é…ç½®

```yaml
# Spring AI MCP Client é…ç½®
spring:
  ai:
    mcp:
      client:
        # å®¢æˆ¶ç«¯åŸºæœ¬è³‡è¨Š
        enabled: true
        name: enterprise-mcp-client
        version: "1.0.0"
        type: SYNC
        initialized: true
        request-timeout: 30s
        root-change-notification: true
        toolcallback:
          enabled: true
        
        # SSE é€£æ¥é…ç½®
        sse:
          connections:
            document-search:
              url: http://localhost:8080
              sse-endpoint: /sse
            knowledge-base:
              url: http://localhost:8081
              sse-endpoint: /sse
        
        # Streamable HTTP é€£æ¥é…ç½®
        streamable-http:
          connections:
            api-server:
              url: http://localhost:8082
              endpoint: /mcp
        
        # STDIO é€£æ¥é…ç½®
        stdio:
          connections:
            filesystem-server:
              command: npx
              args:
                - "-y"
                - "@modelcontextprotocol/server-filesystem"
                - "/path/to/documents"
                - "/path/to/workspace"
              env:
                NODE_ENV: "production"
            local-java-server:
              command: java
              args:
                - "-jar"
                - "/path/to/custom-mcp-server.jar"
                - "--server.port=0"
                - "--spring.profiles.active=mcp"
              env:
                SPRING_PROFILES_ACTIVE: "mcp"
                SERVER_MODE: "stdio"
```

### Java é…ç½®é¡

```java
/**
 * MCP Client é…ç½®é¡
 */
@Configuration
@Slf4j
public class McpClientConfiguration {
    
    /**
     * è‡ªå®šç¾© MCP Sync Client é…ç½®
     */
    @Bean
    public McpSyncClientCustomizer enterpriseClientCustomizer() {
        return new EnterpriseMcpClientCustomizer();
    }
}

/**
 * ä¼æ¥­ç´š MCP Client è‡ªå®šç¾©å™¨
 */
@Component
@Slf4j
public class EnterpriseMcpClientCustomizer implements McpSyncClientCustomizer {
    
    @Override
    public void customize(String serverConfigurationName, McpClient.SyncSpec spec) {
        log.info("è‡ªå®šç¾© MCP Client: {}", serverConfigurationName);
        
        // é…ç½®è«‹æ±‚è¶…æ™‚
        spec.requestTimeout(Duration.ofSeconds(30));
        
        // é…ç½®äº‹ä»¶ç›£è½å™¨
        configureEventListeners(serverConfigurationName, spec);
    }
    
    private void configureEventListeners(String serverName, McpClient.SyncSpec spec) {
        // å·¥å…·è®Šæ›´äº‹ä»¶
        spec.toolsChangeConsumer(tools -> {
            log.info("ä¼ºæœå™¨ {} çš„å·¥å…·å·²æ›´æ–°ï¼Œå…± {} å€‹å·¥å…·", serverName, tools.size());
        });
        
        // è³‡æºè®Šæ›´äº‹ä»¶
        spec.resourcesChangeConsumer(resources -> {
            log.info("ä¼ºæœå™¨ {} çš„è³‡æºå·²æ›´æ–°ï¼Œå…± {} å€‹è³‡æº", serverName, resources.size());
        });
        
        // æç¤ºè®Šæ›´äº‹ä»¶
        spec.promptsChangeConsumer(prompts -> {
            log.info("ä¼ºæœå™¨ {} çš„æç¤ºå·²æ›´æ–°ï¼Œå…± {} å€‹æç¤º", serverName, prompts.size());
        });
        
        // æ—¥èªŒäº‹ä»¶
        spec.loggingConsumer(logMessage -> {
            handleServerLog(serverName, logMessage);
        });
    }
    
    private void handleServerLog(String serverName, McpSchema.LoggingMessageNotification log) {
        // è™•ç†ä¼ºæœå™¨æ—¥èªŒ
        String message = String.format("[%s] %s", serverName, log.data());
        switch (log.level()) {
            case ERROR -> log.error(message);
            case WARNING -> log.warn(message);  
            case INFO -> log.info(message);
            case DEBUG -> log.debug(message);
        }
    }
}
```

---

## 9.2.3 MCP Server é…ç½®

### åŸºç¤ Server é…ç½®

#### application.yml é…ç½®

```yaml
# Spring AI MCP Server é…ç½®
spring:
  ai:
    mcp:
      server:
        # ä¼ºæœå™¨åŸºæœ¬è³‡è¨Š
        enabled: true
        name: enterprise-mcp-server
        version: "1.0.0"
        instructions: "Enterprise MCP Server providing document search and knowledge base access"
        type: SYNC
        request-timeout: 20s
        
        # èƒ½åŠ›é…ç½®
        capabilities:
          resource: true
          tool: true
          prompt: true
          completion: true
        
        # è®Šæ›´é€šçŸ¥é…ç½®
        resource-change-notification: true
        prompt-change-notification: true
        tool-change-notification: true
        
        # Server-Sent Events é…ç½®
        sse-endpoint: /sse
        sse-message-endpoint: /mcp/message
        base-url: ""
```

### ç°¡å–®çš„ Java Server é…ç½®

```java
/**
 * MCP Server é…ç½®é¡
 */
@Configuration
@Slf4j
public class McpServerConfiguration {
    
    /**
     * æ–‡æª”æœå°‹å·¥å…·
     */
    @Bean
    public ToolCallbackProvider documentSearchTools(DocumentSearchService service) {
        return MethodToolCallbackProvider.builder()
            .toolObjects(service)
            .build();
    }
}

/**
 * æ–‡æª”æœå°‹æœå‹™
 */
@Service
@Slf4j
public class DocumentSearchService {
    
    /**
     * æœå°‹ä¼æ¥­æ–‡æª”
     */
    @Tool(description = "æœå°‹ä¼æ¥­æ–‡æª”åº«ä¸­çš„ç›¸é—œæ–‡æª”")
    public String searchDocuments(
            @Parameter(description = "æœå°‹é—œéµå­—") String query) {
        
        log.info("åŸ·è¡Œæ–‡æª”æœå°‹: {}", query);
        
        // å¯¦éš›æœå°‹é‚è¼¯
        return "æ‰¾åˆ°ç›¸é—œæ–‡æª”: " + query;
    }
}
```

---

## 9.2.4 æ•´åˆ ChatClient

### MCP èˆ‡ ChatClient æ•´åˆæœå‹™

```java
/**
 * MCP èˆ‡ ChatClient æ•´åˆæœå‹™
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class McpChatIntegrationService {
    
    private final ChatClient chatClient;
    private final SyncMcpToolCallbackProvider toolCallbackProvider;
    
    /**
     * ä½¿ç”¨ MCP å·¥å…·å¢å¼·çš„èŠå¤©æœå‹™
     */
    public String chatWithMcpTools(String userMessage) {
        
        try {
            // ç²å– MCP å·¥å…·
            ToolCallback[] mcpTools = toolCallbackProvider.getToolCallbacks();
            
            // ä½¿ç”¨ ChatClient èˆ‡ MCP å·¥å…·æ•´åˆ
            return chatClient.prompt()
                .user(userMessage)
                .functions(mcpTools)  // ä½¿ç”¨ functions æ•´åˆ MCP å·¥å…·
                .call()
                .content();
                
        } catch (Exception e) {
            log.error("MCP èŠå¤©æœå‹™å¤±æ•—", e);
            return "æŠ±æ­‰ï¼Œæœå‹™æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
        }
    }
}
```

### èŠå¤©æ§åˆ¶å™¨

```java
/**
 * MCP èŠå¤©æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api/chat")
@RequiredArgsConstructor
@Slf4j
public class McpChatController {
    
    private final McpChatIntegrationService chatService;
    
    /**
     * MCP å¢å¼·çš„èŠå¤©ç«¯é»
     */
    @PostMapping("/mcp")
    public ResponseEntity<String> chatWithMcp(@RequestBody String message) {
        
        try {
            String response = chatService.chatWithMcpTools(message);
            return ResponseEntity.ok(response);
            
        } catch (Exception e) {
            log.error("èŠå¤©è«‹æ±‚è™•ç†å¤±æ•—", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body("æœå‹™æš«æ™‚ä¸å¯ç”¨");
        }
    }
}
```

---

## 9.2.5 æ‡‰ç”¨ç¨‹å¼å…¥å£

### Spring Boot ä¸»é¡åˆ¥

```java
/**
 * Spring AI MCP ç¤ºç¯„æ‡‰ç”¨
 */
@SpringBootApplication
@Slf4j
public class SpringAiMcpDemoApplication {
    
    public static void main(String[] args) {
        SpringApplication.run(SpringAiMcpDemoApplication.class, args);
        log.info("Spring AI MCP ç¤ºç¯„æ‡‰ç”¨å·²å•Ÿå‹•");
    }
}
```

---

## ğŸ“ æœ¬ç« é‡é»å›é¡§

1. **ä¾è³´é…ç½®**ï¼šæ­£ç¢ºå¼•å…¥ Spring AI MCP Client å’Œ Server ç›¸é—œä¾è³´
2. **åŸºç¤é…ç½®**ï¼šæŒæ¡äº† MCP çš„åŸºæœ¬ YAML å’Œ Java é…ç½®æ–¹æ³•
3. **å·¥å…·è¨»å†Š**ï¼šå­¸æœƒä½¿ç”¨ `@Tool` è¨»è§£å’Œ `ToolCallbackProvider` è¨»å†Š MCP å·¥å…·
4. **ChatClient æ•´åˆ**ï¼šå¯¦ç¾äº† MCP å·¥å…·èˆ‡ ChatClient çš„ç„¡ç¸«æ•´åˆ
5. **å¯¦éš›æ‡‰ç”¨**ï¼šå»ºç«‹äº†å®Œæ•´çš„ MCP æ‡‰ç”¨ç¨‹å¼æ¶æ§‹

### æ ¸å¿ƒé…ç½®è¦é»

| é…ç½®é …ç›® | èªªæ˜ | é‡è¦æ€§ |
|---------|------|--------|
| **Client é…ç½®** | è¨­ç½® MCP Client é€£æ¥å’Œåƒæ•¸ | â­â­â­â­â­ |
| **Server é…ç½®** | è¨­ç½® MCP Server åŸºæœ¬è³‡è¨Š | â­â­â­â­â­ |
| **å·¥å…·è¨»å†Š** | ä½¿ç”¨ `@Tool` è¨»è§£è¨»å†Šå·¥å…· | â­â­â­â­â­ |
| **ChatClient æ•´åˆ** | ä½¿ç”¨ `.functions()` æ•´åˆå·¥å…· | â­â­â­â­ |

### ä¸‹ä¸€æ­¥å­¸ç¿’æ–¹å‘

åœ¨ä¸‹ä¸€ç¯€ä¸­ï¼Œæˆ‘å€‘å°‡å­¸ç¿’å¦‚ä½•åœ¨ Spring AI æ‡‰ç”¨ä¸­å…·é«”ä½¿ç”¨ MCP å·¥å…·ï¼ŒåŒ…æ‹¬ï¼š
- MCP å·¥å…·çš„ç™¼ç¾å’Œèª¿ç”¨
- èˆ‡ ChatClient çš„é€²éšæ•´åˆ
- éŒ¯èª¤è™•ç†å’Œç›£æ§
- å¯¦éš›æ‡‰ç”¨å ´æ™¯ç¤ºä¾‹

---

**åƒè€ƒè³‡æ–™ï¼š**
- [Spring AI MCP Client Documentation](https://docs.spring.io/spring-ai/reference/1.1-SNAPSHOT/api/mcp/mcp-client-boot-starter-docs.html)
- [Spring AI MCP Server Documentation](https://docs.spring.io/spring-ai/reference/1.1-SNAPSHOT/api/mcp/mcp-server-boot-starter-docs.html)
- [Spring AI MCP Overview](https://docs.spring.io/spring-ai/reference/1.1-SNAPSHOT/api/mcp/mcp-overview.html)
- [Model Context Protocol Specification](https://modelcontextprotocol.github.io/specification/)