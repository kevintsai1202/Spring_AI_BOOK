# 4.2 Hello AI World

> **本章重點**：建立第一個 Spring AI 應用程式，體驗 AI 對話的魅力，掌握 ChatClient 和 ChatModel 的基本使用方法。

## 🎯 學習目標

完成本章學習後，您將能夠：

- 🎯 **建立第一個 Spring AI 應用**：使用 Spring Boot 整合 AI 服務
- 🎯 **理解 ChatClient 與 ChatModel**：掌握兩種 AI 介面的差異和使用場景
- 🎯 **實現基本 AI 對話功能**：建立可與 AI 互動的 RESTful API
- 🎯 **配置 Spring AI 環境**：正確設定依賴和配置檔案
- 🎯 **測試 AI 應用程式**：驗證 AI 功能的正確性

---

## 4.2.1 Spring AI 架構概述

### Hello AI World

![Hello AI World](https://ithelp.ithome.com.tw/upload/images/20240810/201612902bf1GgYwyV.jpg)

寫程式不免俗要來個 Hello World，依據開發 Spring Boot 程式的經驗，我們只需定義變數，並透過自動注入的機制就能開始使用，為了測試方便直接寫個 API。

### Spring AI 1.0 GA 架構說明

在 Spring AI 1.0 正式版中，ChatClient 和 ChatModel 的關係如下：

```
┌─────────────────────────────────────────────────┐
│                  ChatClient                     │
│  ┌─────────────────────────────────────────┐    │
│  │            Fluent API                   │    │
│  │  .prompt().user().call().content()      │    │
│  └─────────────────────────────────────────┘    │
│                     │                           │
│                     ▼                           │
│  ┌─────────────────────────────────────────┐    │
│  │              ChatModel                  │    │
│  │     (OpenAI, Azure, Google, etc.)       │    │
│  └─────────────────────────────────────────┘    │
└─────────────────────────────────────────────────┘
```

**核心組件說明**：
- **ChatModel**: 提供底層的 AI 模型介面，是與各種 AI 提供商（OpenAI、Azure、Google 等）溝通的核心抽象層
- **ChatClient**: 提供更高級的 Fluent API，類似於 Spring 生態系統中的 RestClient、WebClient 和 JdbcClient，內部依賴 ChatModel 來執行實際的 AI 呼叫

---

## 4.2.2 專案建立與依賴配置

### Maven 依賴配置

首先確保使用最新的 Spring AI 版本。在 `pom.xml` 中加入：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0">
    <modelVersion>4.0.0</modelVersion>
    
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.3.0</version>
        <relativePath/>
    </parent>
    
    <groupId>com.example</groupId>
    <artifactId>spring-ai-hello-world</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>spring-ai-hello-world</name>
    <description>Spring AI Hello World Demo</description>
    
    <properties>
        <java.version>17</java.version>
    </properties>
    
    <!-- 使用 Spring AI BOM 管理版本 -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.ai</groupId>
                <artifactId>spring-ai-bom</artifactId>
                <version>1.0.0</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>
    
    <dependencies>
        <!-- Spring AI OpenAI Starter -->
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-starter-model-openai</artifactId>
        </dependency>
        
        <!-- Spring Boot Web Starter -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        
        <!-- Lombok for cleaner code -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        
        <!-- Spring Boot Test -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
    
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>
```

### 配置檔案設定

在 `application.yml` 中設定 AI 服務配置：

```yaml
spring:
  application:
    name: spring-ai-hello-world
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      base-url: https://api.openai.com
      chat:
        options:
          model: gpt-5-nano
          temperature: 0.7
          maxCompletionTokens: 1000

# 應用程式配置
server:
  port: 8080

# 日誌配置
logging:
  level:
    org.springframework.ai: DEBUG
    com.example: DEBUG
```

---

## 4.2.3 使用 ChatClient 實現 AI 對話

### 基本 AI 控制器

使用現代化的 ChatClient Fluent API：

```java
package com.example.controller;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/ai")
@RequiredArgsConstructor
@Slf4j
public class AiController {
    
    private final ChatClient chatClient;

    /**
     * 基本 AI 對話端點
     * @param prompt 使用者輸入的提示詞
     * @return AI 的回應
     */
    @GetMapping("/chat")
    public String chat(@RequestParam String prompt) {
        log.info("收到 AI 對話請求：{}", prompt);
        
        String response = chatClient.prompt()
                .user(prompt)
                .call()
                .content();
        
        log.info("AI 回應：{}", response);
        return response;
    }
    
    /**
     * 帶有系統提示詞的 AI 對話
     * @param prompt 使用者輸入
     * @return AI 回應
     */
    @PostMapping("/chat/system")
    public String chatWithSystem(@RequestBody ChatRequest request) {
        return chatClient.prompt()
                .system(request.getSystemMessage())
                .user(request.getUserMessage())
                .call()
                .content();
    }
    
    /**
     * Hello World 專用端點
     * @return AI 生成的 Hello World 程式
     */
    @GetMapping("/hello-world")
    public String helloWorld() {
        String prompt = "請用 Java Spring Boot 寫一個 Hello World 程式，" +
                       "包含一個簡單的 REST API 端點";
        
        return chatClient.prompt()
                .system("你是一個專業的 Java 開發專家，" +
                       "請提供清晰、可執行的程式碼範例")
                .user(prompt)
                .call()
                .content();
    }
}
```

### 請求 DTO 類別

```java
package com.example.dto;

import lombok.Data;

@Data
public class ChatRequest {
    private String systemMessage;
    private String userMessage;
}
```

### 程式碼重點說明

**核心註解**：
- **@RestController**: 專門用來開發 API 的標註
- **@RequiredArgsConstructor**: Lombok 提供的快速標註，可幫我們寫一個建構子並將 final 變數當作參數
- **@Slf4j**: Lombok 提供的日誌標註

**ChatClient Fluent API**：
- **chatClient.prompt()**: 開始建立聊天請求的 Fluent API
- **system()**: 設定系統提示詞（定義 AI 的角色和行為）
- **user()**: 設定使用者訊息
- **call()**: 執行同步請求
- **content()**: 取得回應內容

---

## 4.2.4 ChatClient 自動配置與客製化

### 預設自動配置

Spring Boot 會自動為我們配置 ChatClient，但我們也可以自定義配置：

```java
package com.example.config;

import org.springframework.ai.chat.client.ChatClient;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class AiConfig {
    
    /**
     * 自定義 ChatClient 配置
     * @param builder ChatClient 建構器
     * @return 配置好的 ChatClient
     */
    @Bean
    public ChatClient chatClient(ChatClient.Builder builder) {
        return builder
                .defaultSystem("你是一個友善且專業的 AI 助手，" +
                             "專門協助 Java Spring Boot 開發。" +
                             "請用繁體中文回答，並提供實用的程式碼範例。")
                .build();
    }
    
    /**
     * 專門用於程式碼生成的 ChatClient
     * @param builder ChatClient 建構器
     * @return 程式碼生成專用的 ChatClient
     */
    @Bean("codeChatClient")
    public ChatClient codeChatClient(ChatClient.Builder builder) {
        return builder
                .defaultSystem("你是一個資深的 Java 開發專家。" +
                             "請提供高品質、可執行的程式碼，" +
                             "包含適當的註解和最佳實踐。")
                .build();
    }
}
```

### 使用特定的 ChatClient

```java
@RestController
@RequestMapping("/api/code")
@RequiredArgsConstructor
public class CodeGeneratorController {
    
    @Qualifier("codeChatClient")
    private final ChatClient codeChatClient;
    
    @GetMapping("/generate")
    public String generateCode(@RequestParam String description) {
        return codeChatClient.prompt()
                .user("請根據以下描述生成 Java 程式碼：" + description)
                .call()
                .content();
    }
}
```

---

## 4.2.5 ChatModel 直接使用方式

### 底層 API 使用

如果需要更直接的控制，也可以直接使用 ChatModel：

```java
package com.example.controller;

import lombok.RequiredArgsConstructor;
import org.springframework.ai.chat.model.ChatModel;
import org.springframework.ai.chat.prompt.Prompt;
import org.springframework.ai.chat.prompt.PromptTemplate;
import org.springframework.web.bind.annotation.*;

import java.util.Map;

@RestController
@RequestMapping("/api/model")
@RequiredArgsConstructor
public class AiModelController {
    
    private final ChatModel chatModel;

    /**
     * 使用 ChatModel 的簡單對話
     * @param prompt 使用者輸入
     * @return AI 回應
     */
    @GetMapping("/chat")
    public String chatWithModel(@RequestParam String prompt) {
        return chatModel.call(prompt);
    }
    
    /**
     * 使用 PromptTemplate 的進階對話
     * @param topic 話題
     * @param style 風格
     * @return AI 回應
     */
    @GetMapping("/chat/template")
    public String chatWithTemplate(
            @RequestParam String topic,
            @RequestParam(defaultValue = "專業") String style) {
        
        String template = "請以{style}的風格，詳細說明{topic}的相關知識";
        
        PromptTemplate promptTemplate = new PromptTemplate(template);
        Prompt prompt = promptTemplate.create(Map.of(
            "topic", topic,
            "style", style
        ));
        
        return chatModel.call(prompt).getResult().getOutput().getContent();
    }
}
```

---

## 4.2.6 測試 AI 應用程式

### 使用 Postman 測試

**1. 基本對話測試**
```
GET http://localhost:8080/api/ai/chat?prompt=你好，請介紹一下Spring AI
```

**2. Hello World 測試**
```
GET http://localhost:8080/api/ai/hello-world
```

**3. 系統提示詞測試**
```
POST http://localhost:8080/api/ai/chat/system
Content-Type: application/json

{
    "systemMessage": "你是一個幽默的程式設計師",
    "userMessage": "解釋什麼是遞迴"
}
```

### 使用 curl 測試

```bash
# 基本對話
curl -X GET "http://localhost:8080/api/ai/chat?prompt=使用Spring AI寫一個Hello World程式"

# Hello World 專用端點
curl -X GET "http://localhost:8080/api/ai/hello-world"

# 帶系統提示詞的對話
curl -X POST "http://localhost:8080/api/ai/chat/system" \
     -H "Content-Type: application/json" \
     -d '{
       "systemMessage": "你是一個資深的Java開發專家",
       "userMessage": "請解釋Spring Boot的自動配置原理"
     }'
```

### 單元測試

```java
package com.example.controller;

import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureWebMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.web.servlet.MockMvc;

import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@SpringBootTest
@AutoConfigureWebMvc
class AiControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @Test
    void testChatEndpoint() throws Exception {
        mockMvc.perform(get("/api/ai/chat")
                .param("prompt", "Hello"))
                .andExpect(status().isOk())
                .andExpect(content().string(org.hamcrest.Matchers.not(org.hamcrest.Matchers.emptyString())));
    }
    
    @Test
    void testHelloWorldEndpoint() throws Exception {
        mockMvc.perform(get("/api/ai/hello-world"))
                .andExpect(status().isOk())
                .andExpect(content().string(org.hamcrest.Matchers.containsString("Spring Boot")));
    }
}
```

---

## 4.2.7 ChatClient vs ChatModel 使用時機

### 選擇指南

**使用 ChatClient 當你需要**：
- ✅ 複雜的提示詞組合
- ✅ 系統提示詞設定
- ✅ 流式輸出（下一章介紹）
- ✅ 更豐富的 API 功能
- ✅ 現代化的 Fluent API 體驗

**使用 ChatModel 當你需要**：
- ✅ 簡單直接的 AI 呼叫
- ✅ 更底層的控制
- ✅ 原始的 Prompt 物件操作
- ✅ 自定義複雜的提示詞模板

### 效能比較

```java
@Service
public class PerformanceComparisonService {
    
    private final ChatClient chatClient;
    private final ChatModel chatModel;
    
    // ChatClient 方式（推薦）
    public String useChatClient(String message) {
        return chatClient.prompt()
                .user(message)
                .call()
                .content();
    }
    
    // ChatModel 方式（底層）
    public String useChatModel(String message) {
        return chatModel.call(message);
    }
}
```

---

## 📝 本章重點回顧

1. **Spring AI 架構理解**：掌握了 ChatClient 與 ChatModel 的關係和差異
2. **專案建立**：學會了配置 Spring AI 依賴和基本設定
3. **ChatClient 使用**：熟練使用現代化的 Fluent API 進行 AI 對話
4. **自定義配置**：了解如何客製化 ChatClient 的行為
5. **測試方法**：掌握了多種測試 AI 應用的方法

### 下一步學習方向

在下一章中，我們將學習如何實現流式輸出，讓 AI 回應像 ChatGPT 一樣即時顯示，大幅提升使用者體驗。

---

**參考資料：**
- [Spring AI ChatClient Documentation](https://docs.spring.io/spring-ai/reference/api/chatclient.html)
- [Spring AI ChatModel Documentation](https://docs.spring.io/spring-ai/reference/api/chatmodel.html)
- [OpenAI Spring Boot Starter](https://docs.spring.io/spring-ai/reference/api/chat/openai-chat.html)