# 6.1 é­”é¡~èª°æ˜¯ Spring AI çš„å°ˆå®¶ï¼Ÿ

> **æœ¬ç« é‡é»**ï¼šæ¢ç´¢ Spring AI è¨˜æ†¶ç®¡ç†ç³»çµ±çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå¾å‚³çµ±çš„ã€ŒåœŸç‚®è¨˜æ†¶ã€åˆ°ä¼æ¥­ç´šè¨˜æ†¶è§£æ±ºæ–¹æ¡ˆï¼Œç‚ºå»ºç«‹çœŸæ­£æ™ºèƒ½çš„å°è©±ç³»çµ±å¥ å®šåŸºç¤ã€‚

## ğŸ¯ å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬ç« å­¸ç¿’å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š

- ğŸ¯ **ç†è§£è¨˜æ†¶çš„é‡è¦æ€§**ï¼šæŒæ¡ç‚ºä»€éº¼ AI éœ€è¦è¨˜æ†¶èƒ½åŠ›ä»¥åŠè¨˜æ†¶åœ¨å°è©±ç³»çµ±ä¸­çš„ä½œç”¨
- ğŸ¯ **èªè­˜è¨˜æ†¶é¡å‹**ï¼šäº†è§£çŸ­æœŸè¨˜æ†¶ã€é•·æœŸè¨˜æ†¶å’Œå‘é‡è¨˜æ†¶çš„å·®ç•°èˆ‡æ‡‰ç”¨å ´æ™¯
- ğŸ¯ **æŒæ¡ Spring AI è¨˜æ†¶æ¶æ§‹**ï¼šå­¸ç¿’ Spring AI 1.0 GA ä¸­çš„è¨˜æ†¶ç®¡ç†ç³»çµ±è¨­è¨ˆ
- ğŸ¯ **æ¯”è¼ƒè¨˜æ†¶å¯¦ç¾æ–¹æ¡ˆ**ï¼šåˆ†æå‚³çµ±åšæ³•èˆ‡ä¼æ¥­ç´šè§£æ±ºæ–¹æ¡ˆçš„å„ªç¼ºé»
- ğŸ¯ **å»ºç«‹è¨˜æ†¶ç³»çµ±åŸºç¤**ï¼šç‚ºå¾ŒçºŒç« ç¯€çš„è¨˜æ†¶å¯¦ç¾åšå¥½æº–å‚™

---

## 6.1.1 AI è¨˜æ†¶çš„é‡è¦æ€§

### é­”é¡é­”é¡å‘Šè¨´æˆ‘ï¼Œèª°æ˜¯ Spring AI çš„å°ˆå®¶ï¼Ÿ

![Spring AI è¨˜æ†¶ç³»çµ±](https://ithelp.ithome.com.tw/upload/images/20240817/20161290GI4axNwalT.png)

æƒ³åƒä¸€ä¸‹ï¼Œå¦‚æœæ¯æ¬¡èˆ‡æœ‹å‹å°è©±æ™‚ï¼Œå°æ–¹éƒ½å®Œå…¨å¿˜è¨˜ä¹‹å‰èªªéçš„è©±ï¼Œé€™æ¨£çš„å°è©±é«”é©—æœƒæ˜¯å¤šéº¼ç³Ÿç³•ï¼åŒæ¨£åœ°ï¼Œæ²’æœ‰è¨˜æ†¶èƒ½åŠ›çš„ AI å°±åƒæ‚£äº†ã€Œé‡‘é­šè…¦ã€ï¼Œæ¯æ¬¡å°è©±éƒ½æ˜¯å…¨æ–°çš„é–‹å§‹ï¼Œç„¡æ³•å»ºç«‹é€£è²«çš„å°è©±é«”é©—ã€‚

### AI è¨˜æ†¶çš„æ ¸å¿ƒåƒ¹å€¼

**1. å°è©±é€£è²«æ€§**
- ğŸ”— **ä¸Šä¸‹æ–‡ç†è§£**ï¼šAI èƒ½å¤ ç†è§£å°è©±çš„å‰å¾Œé—œè¯
- ğŸ’¬ **è‡ªç„¶å°è©±æµç¨‹**ï¼šé¿å…é‡è¤‡è©¢å•ç›¸åŒå•é¡Œ
- ğŸ¯ **å€‹æ€§åŒ–å›æ‡‰**ï¼šæ ¹æ“šå°è©±æ­·å²æä¾›æ›´ç²¾æº–çš„å›ç­”
- ğŸ“ **ä»»å‹™å»¶çºŒ**ï¼šèƒ½å¤ è·¨å¤šè¼ªå°è©±å®Œæˆè¤‡é›œä»»å‹™

**2. ç”¨æˆ¶é«”é©—æå‡**
- ğŸ˜Š **å‹å–„äº’å‹•**ï¼šæ›´åƒèˆ‡çœŸäººå°è©±çš„è‡ªç„¶é«”é©—
- âš¡ **æ•ˆç‡æå‡**ï¼šæ¸›å°‘é‡è¤‡èªªæ˜ï¼Œæé«˜æºé€šæ•ˆç‡
- ğŸ¨ **å€‹æ€§åŒ–æœå‹™**ï¼šè¨˜ä½ç”¨æˆ¶åå¥½å’Œç¿’æ…£
- ğŸ”„ **æœƒè©±æ¢å¾©**ï¼šèƒ½å¤ åœ¨ä¸­æ–·å¾Œç¹¼çºŒä¹‹å‰çš„å°è©±

**3. ä¼æ¥­æ‡‰ç”¨åƒ¹å€¼**
- ğŸ“Š **å®¢æˆ¶æœå‹™**ï¼šè¨˜ä½å®¢æˆ¶å•é¡Œå’Œè§£æ±ºæ–¹æ¡ˆ
- ğŸ“ **çŸ¥è­˜ç´¯ç©**ï¼šå»ºç«‹çµ„ç¹”çš„å°è©±çŸ¥è­˜åº«
- ğŸ” **è¡Œç‚ºåˆ†æ**ï¼šåˆ†æç”¨æˆ¶å°è©±æ¨¡å¼å’Œéœ€æ±‚
- ğŸ’¼ **æ¥­å‹™é€£çºŒæ€§**ï¼šè·¨æœƒè©±çš„æ¥­å‹™æµç¨‹æ”¯æ´

---

## 6.1.2 è¨˜æ†¶é¡å‹èˆ‡æ‡‰ç”¨å ´æ™¯

### è¨˜æ†¶çš„åˆ†é¡é«”ç³»

åœ¨ Spring AI ä¸­ï¼Œè¨˜æ†¶ç³»çµ±å¯ä»¥åˆ†ç‚ºä»¥ä¸‹å¹¾ç¨®é¡å‹ï¼š

**1. çŸ­æœŸè¨˜æ†¶ï¼ˆSession Memoryï¼‰**
```
ç‰¹é»ï¼š
- å­˜åœ¨æ–¼å–®æ¬¡æœƒè©±ä¸­
- é€šå¸¸å­˜å„²åœ¨è¨˜æ†¶é«”ä¸­
- æœƒè©±çµæŸå¾Œæ¶ˆå¤±
- è™•ç†é€Ÿåº¦å¿«

é©ç”¨å ´æ™¯ï¼š
- å–®æ¬¡å°è©±çš„ä¸Šä¸‹æ–‡ç®¡ç†
- è‡¨æ™‚ä»»å‹™çš„ç‹€æ…‹è¿½è¹¤
- å¿«é€ŸåŸå‹é–‹ç™¼
- æ¸¬è©¦å’Œé™¤éŒ¯
```

**2. é•·æœŸè¨˜æ†¶ï¼ˆPersistent Memoryï¼‰**
```
ç‰¹é»ï¼š
- æŒä¹…åŒ–å­˜å„²
- è·¨æœƒè©±ä¿æŒ
- æ”¯æ´å¤šç¨®å­˜å„²å¾Œç«¯
- å¯æ“´å±•æ€§å¼·

é©ç”¨å ´æ™¯ï¼š
- ç”¨æˆ¶å€‹äººåŠ©æ‰‹
- å®¢æˆ¶æœå‹™ç³»çµ±
- çŸ¥è­˜ç®¡ç†å¹³å°
- ä¼æ¥­ç´šæ‡‰ç”¨
```

**3. å‘é‡è¨˜æ†¶ï¼ˆVector Memoryï¼‰**
```
ç‰¹é»ï¼š
- åŸºæ–¼èªç¾©ç›¸ä¼¼æ€§
- æ”¯æ´æ¨¡ç³ŠåŒ¹é…
- å¯è™•ç†å¤§é‡æ­·å²è³‡æ–™
- æ™ºèƒ½æª¢ç´¢èƒ½åŠ›

é©ç”¨å ´æ™¯ï¼š
- å¤§è¦æ¨¡å°è©±æ­·å²æª¢ç´¢
- èªç¾©ç›¸é—œå…§å®¹æŸ¥æ‰¾
- çŸ¥è­˜åœ–è­œæ‡‰ç”¨
- æ™ºèƒ½æ¨è–¦ç³»çµ±
```

### è¨˜æ†¶é¡å‹æ¯”è¼ƒ

| è¨˜æ†¶é¡å‹ | å­˜å„²æ–¹å¼ | æŒä¹…æ€§ | æª¢ç´¢æ–¹å¼ | é©ç”¨è¦æ¨¡ | å¯¦ç¾è¤‡é›œåº¦ |
|----------|----------|--------|----------|----------|------------|
| **çŸ­æœŸè¨˜æ†¶** | è¨˜æ†¶é«” | æœƒè©±ç´š | é †åºå­˜å– | å°å‹ | ä½ |
| **é•·æœŸè¨˜æ†¶** | è³‡æ–™åº« | æ°¸ä¹… | é—œéµå­—æŸ¥è©¢ | ä¸­å¤§å‹ | ä¸­ |
| **å‘é‡è¨˜æ†¶** | å‘é‡è³‡æ–™åº« | æ°¸ä¹… | èªç¾©æœå°‹ | å¤§å‹ | é«˜ |

---

## 6.1.3 å‚³çµ±åšæ³• vs ä¼æ¥­ç´šè§£æ±ºæ–¹æ¡ˆ

### åœŸç‚®è¨˜æ†¶å¯¦ç¾

æœ€ç°¡å–®çš„è¨˜æ†¶å¯¦ç¾æ–¹å¼æ˜¯ä½¿ç”¨ List ä¾†å­˜å„²å°è©±æ­·å²ï¼š

```java
import lombok.RequiredArgsConstructor;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.messages.Message;
import org.springframework.ai.chat.messages.UserMessage;
import org.springframework.ai.chat.messages.AssistantMessage;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;

import java.util.ArrayList;
import java.util.List;

@RestController
@RequiredArgsConstructor
public class BasicMemoryController {
    
    private final ChatClient chatClient;
    private List<Message> memMessage = new ArrayList<>();
    
    @GetMapping("/basic-memory")
    public String chat(@RequestParam String prompt) {
        // å°‡ç”¨æˆ¶è¨Šæ¯åŠ å…¥è¨˜æ†¶
        memMessage.add(new UserMessage(prompt));
        
        // ç™¼é€å®Œæ•´å°è©±æ­·å²çµ¦ AI
        String response = chatClient.prompt()
            .messages(memMessage)
            .call()
            .content();
            
        // å°‡ AI å›æ‡‰ä¹ŸåŠ å…¥è¨˜æ†¶
        memMessage.add(new AssistantMessage(response));
        
        return response;
    }
}
```

**åœŸç‚®è¨˜æ†¶çš„ç‰¹é»**ï¼š
- âœ… **å¯¦ç¾ç°¡å–®**ï¼šå¹¾è¡Œç¨‹å¼ç¢¼å°±èƒ½å®Œæˆ
- âœ… **ç†è§£å®¹æ˜“**ï¼šé‚è¼¯ç›´è§€ï¼Œæ˜“æ–¼é™¤éŒ¯
- âœ… **å¿«é€ŸåŸå‹**ï¼šé©åˆæ¦‚å¿µé©—è­‰å’Œæ¸¬è©¦
- âŒ **ç„¡æŒä¹…åŒ–**ï¼šæ‡‰ç”¨é‡å•Ÿå¾Œè¨˜æ†¶æ¶ˆå¤±
- âŒ **ç„¡éš”é›¢æ€§**ï¼šæ‰€æœ‰ç”¨æˆ¶å…±äº«åŒä¸€å€‹è¨˜æ†¶
- âŒ **è¨˜æ†¶é«”æ´©æ¼**ï¼šé•·æ™‚é–“é‹è¡Œæœƒæ¶ˆè€—å¤§é‡è¨˜æ†¶é«”
- âŒ **ç„¡æ“´å±•æ€§**ï¼šç„¡æ³•è™•ç†å¤§é‡ç”¨æˆ¶å’Œå°è©±

### Spring AI ä¼æ¥­ç´šè¨˜æ†¶ç³»çµ±

Spring AI 1.0 GA æä¾›äº†å®Œæ•´çš„ä¼æ¥­ç´šè¨˜æ†¶ç®¡ç†ç³»çµ±ï¼š

```java
import org.springframework.ai.chat.memory.ChatMemory;
import org.springframework.ai.chat.memory.ChatMemoryRepository;
import org.springframework.ai.chat.memory.MessageWindowChatMemory;
import org.springframework.ai.chat.memory.JdbcChatMemoryRepository;
import org.springframework.ai.chat.memory.RedisChatMemoryRepository;
import org.springframework.ai.chat.memory.Neo4jChatMemoryRepository;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.neo4j.core.Neo4jTemplate;

import javax.sql.DataSource;

@Configuration
public class EnterpriseMemoryConfig {
    
    @Bean
    public ChatMemory chatMemory(ChatMemoryRepository repository) {
        return MessageWindowChatMemory.builder()
            .maxMessages(100)        // æ»‘å‹•è¦–çª—å¤§å°
            .chatMemoryRepository(repository)
            .build();
    }
    
    @Bean
    @ConditionalOnProperty(name = "app.memory.type", havingValue = "jdbc")
    public ChatMemoryRepository jdbcChatMemoryRepository(DataSource dataSource) {
        return new JdbcChatMemoryRepository(dataSource);
    }
    
    @Bean
    @ConditionalOnProperty(name = "app.memory.type", havingValue = "redis")
    public ChatMemoryRepository redisChatMemoryRepository(RedisTemplate<String, Object> redisTemplate) {
        return new RedisChatMemoryRepository(redisTemplate);
    }
    
    @Bean
    @ConditionalOnProperty(name = "app.memory.type", havingValue = "neo4j")
    public ChatMemoryRepository neo4jChatMemoryRepository(Neo4jTemplate neo4jTemplate) {
        return new Neo4jChatMemoryRepository(neo4jTemplate);
    }
}
```

**ä¼æ¥­ç´šè¨˜æ†¶çš„å„ªå‹¢**ï¼š
- âœ… **æŒä¹…åŒ–å­˜å„²**ï¼šæ”¯æ´å¤šç¨®è³‡æ–™åº«å¾Œç«¯
- âœ… **æœƒè©±éš”é›¢**ï¼šæ¯å€‹ç”¨æˆ¶æœ‰ç¨ç«‹çš„å°è©±è¨˜æ†¶
- âœ… **æ»‘å‹•è¦–çª—**ï¼šè‡ªå‹•ç®¡ç†è¨˜æ†¶å¤§å°ï¼Œé¿å…ç„¡é™å¢é•·
- âœ… **é«˜å¯ç”¨æ€§**ï¼šæ”¯æ´å¢é›†éƒ¨ç½²å’Œæ•…éšœæ¢å¾©
- âœ… **å¯æ“´å±•æ€§**ï¼šèƒ½å¤ è™•ç†å¤§é‡ä¸¦ç™¼ç”¨æˆ¶
- âœ… **éˆæ´»é…ç½®**ï¼šå¯æ ¹æ“šéœ€æ±‚é¸æ“‡ä¸åŒçš„å­˜å„²å¾Œç«¯

---

## 6.1.4 Spring AI è¨˜æ†¶æ¶æ§‹æ·±åº¦è§£æ

### æ ¸å¿ƒä»‹é¢è¨­è¨ˆ

Spring AI çš„è¨˜æ†¶ç³»çµ±æ¡ç”¨åˆ†å±¤æ¶æ§‹è¨­è¨ˆï¼š

```java
import org.springframework.ai.chat.messages.Message;
import java.util.List;

// 1. ChatMemory æ ¸å¿ƒä»‹é¢
public interface ChatMemory {
    // æ–°å¢è¨Šæ¯åˆ°å°è©±
    void add(String conversationId, Message message);
    void add(String conversationId, List<Message> messages);
    
    // å–å¾—å°è©±æ­·å²
    List<Message> get(String conversationId);
    List<Message> get(String conversationId, int lastN);
    
    // æ¸…é™¤å°è©±
    void clear(String conversationId);
    
    // æª¢æŸ¥å°è©±æ˜¯å¦å­˜åœ¨
    boolean exists(String conversationId);
}

// 2. ChatMemoryRepository å­˜å„²å±¤
public interface ChatMemoryRepository {
    void save(String conversationId, List<Message> messages);
    List<Message> findByConversationId(String conversationId);
    void deleteByConversationId(String conversationId);
    boolean existsByConversationId(String conversationId);
}

// 3. MessageWindowChatMemory å¯¦ç¾é¡
public class MessageWindowChatMemory implements ChatMemory {
    private final int maxMessages;
    private final ChatMemoryRepository repository;
    
    // å¯¦ç¾æ»‘å‹•è¦–çª—é‚è¼¯
    @Override
    public void add(String conversationId, Message message) {
        List<Message> messages = get(conversationId);
        messages.add(message);
        
        // æ»‘å‹•è¦–çª—ï¼šä¿æŒæœ€æ–°çš„ maxMessages æ¢è¨Šæ¯
        if (messages.size() > maxMessages) {
            messages = messages.subList(messages.size() - maxMessages, messages.size());
        }
        
        repository.save(conversationId, messages);
    }
}
```

### è¨˜æ†¶ç³»çµ±æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Spring AI Memory System                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ChatClient API Layer                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  MessageChat    â”‚    â”‚  PromptChat     â”‚               â”‚
â”‚  â”‚  MemoryAdvisor  â”‚    â”‚  MemoryAdvisor  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Memory Management Layer                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              ChatMemory Interface                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚        MessageWindowChatMemory                  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Sliding Window Logic                         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Message Lifecycle Management                 â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Conversation Isolation                       â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Storage Abstraction Layer                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚           ChatMemoryRepository Interface                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Storage Implementation Layer                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚InMemory     â”‚ â”‚JDBC         â”‚ â”‚Redis        â”‚          â”‚
â”‚  â”‚Repository   â”‚ â”‚Repository   â”‚ â”‚Repository   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚Cassandra    â”‚ â”‚Neo4j        â”‚ â”‚MongoDB      â”‚          â”‚
â”‚  â”‚Repository   â”‚ â”‚Repository   â”‚ â”‚Repository   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6.1.5 è¨˜æ†¶ç³»çµ±çš„é¸æ“‡ç­–ç•¥

### æ ¹æ“šæ‡‰ç”¨å ´æ™¯é¸æ“‡è¨˜æ†¶é¡å‹

**1. é–‹ç™¼å’Œæ¸¬è©¦éšæ®µ**
```yaml
# application-dev.yml
app:
  memory:
    type: memory  # ä½¿ç”¨è¨˜æ†¶é«”å­˜å„²
    max-messages: 50
```

**2. ç”Ÿç”¢ç’°å¢ƒ - ä¸­å°å‹æ‡‰ç”¨**
```yaml
# application-prod.yml
app:
  memory:
    type: jdbc    # ä½¿ç”¨é—œè¯å¼è³‡æ–™åº«
    max-messages: 200
    
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/chatbot
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
```

**3. ç”Ÿç”¢ç’°å¢ƒ - å¤§å‹æ‡‰ç”¨**
```yaml
# application-prod.yml
app:
  memory:
    type: redis   # ä½¿ç”¨ Redis å¿«å–
    max-messages: 500
    
spring:
  data:
    redis:
      host: ${REDIS_HOST}
      port: ${REDIS_PORT}
      password: ${REDIS_PASSWORD}
```

**4. ä¼æ¥­ç´š - çŸ¥è­˜åœ–è­œæ‡‰ç”¨**
```yaml
# application-enterprise.yml
app:
  memory:
    type: neo4j   # ä½¿ç”¨åœ–å½¢è³‡æ–™åº«
    max-messages: 1000
    
spring:
  neo4j:
    uri: ${NEO4J_URI}
    authentication:
      username: ${NEO4J_USERNAME}
      password: ${NEO4J_PASSWORD}
```

### é¸æ“‡æ±ºç­–æ¨¹

```
é–‹å§‹é¸æ“‡è¨˜æ†¶ç³»çµ±
        â”‚
        â–¼
   æ˜¯å¦ç‚ºç”Ÿç”¢ç’°å¢ƒï¼Ÿ
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
   å¦â”‚          â”‚æ˜¯
    â–¼           â–¼
è¨˜æ†¶é«”å­˜å„²    éœ€è¦æŒä¹…åŒ–ï¼Ÿ
 (InMemory)   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
             å¦â”‚          â”‚æ˜¯
              â–¼           â–¼
           Rediså¿«å–   è³‡æ–™é‡å¤§å°ï¼Ÿ
                      â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                     å°â”‚          â”‚å¤§
                      â–¼           â–¼
                   JDBC        Neo4j/MongoDB
                 (PostgreSQL)  (åœ–å½¢/æ–‡æª”)
```

---

## 6.1.6 è¨˜æ†¶ç³»çµ±çš„æœ€ä½³å¯¦è¸

### 1. è¨˜æ†¶å¤§å°ç®¡ç†

```java
import lombok.RequiredArgsConstructor;
import org.springframework.ai.chat.memory.ChatMemory;
import org.springframework.ai.chat.messages.Message;
import org.springframework.ai.chat.messages.SystemMessage;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.util.List;

@Component
@RequiredArgsConstructor
public class MemoryManagementService {
    
    private final ChatMemory chatMemory;
    
    /**
     * æ™ºèƒ½è¨˜æ†¶æ¸…ç†ç­–ç•¥
     */
    @Scheduled(fixedRate = 3600000) // æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡
    public void cleanupOldConversations() {
        // æ¸…ç†è¶…é 7 å¤©çš„å°è©±
        LocalDateTime cutoff = LocalDateTime.now().minusDays(7);
        
        // å¯¦ç¾å…·é«”çš„æ¸…ç†é‚è¼¯
        cleanupConversationsOlderThan(cutoff);
    }
    
    /**
     * è¨˜æ†¶å£“ç¸®ç­–ç•¥
     */
    public void compressLongConversation(String conversationId) {
        List<Message> messages = chatMemory.get(conversationId);
        
        if (messages.size() > 100) {
            // ä¿ç•™æœ€è¿‘ 50 æ¢è¨Šæ¯
            List<Message> recentMessages = messages.subList(messages.size() - 50, messages.size());
            
            // å°‡è¼ƒèˆŠçš„è¨Šæ¯é€²è¡Œæ‘˜è¦
            String summary = summarizeOldMessages(messages.subList(0, messages.size() - 50));
            
            // é‡å»ºè¨˜æ†¶
            chatMemory.clear(conversationId);
            chatMemory.add(conversationId, new SystemMessage("å°è©±æ‘˜è¦ï¼š" + summary));
            chatMemory.add(conversationId, recentMessages);
        }
    }
}
```

### 2. è¨˜æ†¶å®‰å…¨æ€§

```java
import org.springframework.ai.chat.messages.Message;
import org.springframework.ai.chat.messages.UserMessage;
import org.springframework.stereotype.Component;

@Component
public class MemorySecurityService {
    
    /**
     * æ•æ„Ÿè³‡è¨Šéæ¿¾
     */
    public Message sanitizeMessage(Message message) {
        String content = message.getContent();
        
        // ç§»é™¤æ•æ„Ÿè³‡è¨Š
        content = removeSensitiveInfo(content);
        
        return new UserMessage(content);
    }
    
    private String removeSensitiveInfo(String content) {
        // ç§»é™¤ä¿¡ç”¨å¡è™Ÿ
        content = content.replaceAll("\\b\\d{4}[\\s-]?\\d{4}[\\s-]?\\d{4}[\\s-]?\\d{4}\\b", "[CARD_NUMBER]");
        
        // ç§»é™¤é›»è©±è™Ÿç¢¼
        content = content.replaceAll("\\b\\d{10,11}\\b", "[PHONE_NUMBER]");
        
        // ç§»é™¤é›»å­éƒµä»¶
        content = content.replaceAll("\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}\\b", "[EMAIL]");
        
        return content;
    }
}
```

### 3. è¨˜æ†¶æ•ˆèƒ½ç›£æ§

```java
import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.MeterRegistry;
import io.micrometer.core.instrument.Tags;
import io.micrometer.core.instrument.Timer;
import org.springframework.stereotype.Component;

import java.util.function.Supplier;

@Component
public class MemoryMetricsService {
    
    private final MeterRegistry meterRegistry;
    private final Counter memoryOperations;
    private final Timer memoryAccessTime;
    
    public MemoryMetricsService(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.memoryOperations = Counter.builder("memory.operations")
            .description("Memory operations count")
            .register(meterRegistry);
        this.memoryAccessTime = Timer.builder("memory.access.time")
            .description("Memory access time")
            .register(meterRegistry);
    }
    
    public void recordMemoryOperation(String operation, String conversationId) {
        memoryOperations.increment(
            Tags.of(
                "operation", operation,
                "conversation_id", conversationId
            )
        );
    }
    
    public <T> T timeMemoryAccess(Supplier<T> operation) {
        return memoryAccessTime.recordCallable(operation::get);
    }
}
```

---

## ğŸ“ æœ¬ç« é‡é»å›é¡§

1. **è¨˜æ†¶é‡è¦æ€§ç†è§£**ï¼šæŒæ¡äº† AI è¨˜æ†¶åœ¨å°è©±ç³»çµ±ä¸­çš„æ ¸å¿ƒåƒ¹å€¼å’Œä½œç”¨
2. **è¨˜æ†¶é¡å‹åˆ†é¡**ï¼šå­¸æœƒäº†çŸ­æœŸè¨˜æ†¶ã€é•·æœŸè¨˜æ†¶å’Œå‘é‡è¨˜æ†¶çš„ç‰¹é»èˆ‡æ‡‰ç”¨
3. **æ¶æ§‹è¨­è¨ˆèªçŸ¥**ï¼šç†è§£äº† Spring AI è¨˜æ†¶ç³»çµ±çš„åˆ†å±¤æ¶æ§‹å’Œè¨­è¨ˆåŸå‰‡
4. **å¯¦ç¾æ–¹æ¡ˆæ¯”è¼ƒ**ï¼šåˆ†æäº†å‚³çµ±åšæ³•èˆ‡ä¼æ¥­ç´šè§£æ±ºæ–¹æ¡ˆçš„å„ªç¼ºé»
5. **é¸æ“‡ç­–ç•¥æŒæ¡**ï¼šå­¸æœƒäº†æ ¹æ“šä¸åŒå ´æ™¯é¸æ“‡åˆé©çš„è¨˜æ†¶ç³»çµ±é¡å‹

### æŠ€è¡“è¦é»ç¸½çµ

| æŠ€è¡“é» | é‡è¦æ€§ | å¯¦ç¾é›£åº¦ | ä½¿ç”¨å ´æ™¯ |
|--------|--------|----------|----------|
| **ChatMemory ä»‹é¢** | â­â­â­ | ä½ | æ‰€æœ‰è¨˜æ†¶æ‡‰ç”¨ |
| **MessageWindowChatMemory** | â­â­â­ | ä¸­ | ä¼æ¥­ç´šæ‡‰ç”¨ |
| **å¤šå­˜å„²å¾Œç«¯æ”¯æ´** | â­â­ | ä¸­ | å¤§å‹ç³»çµ± |
| **è¨˜æ†¶å®‰å…¨æ€§** | â­â­ | ä¸­ | ç”Ÿç”¢ç’°å¢ƒ |
| **æ•ˆèƒ½ç›£æ§** | â­â­ | ä½ | é‹ç¶­ç®¡ç† |

### ä¸‹ä¸€æ­¥å­¸ç¿’æ–¹å‘

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘å€‘å°‡æ·±å…¥å¯¦ä½œ Spring AI çš„è¨˜æ†¶åŠŸèƒ½ï¼Œå­¸ç¿’å¦‚ä½•ï¼š
- å¯¦ç¾åŸºæœ¬çš„å°è©±è¨˜æ†¶åŠŸèƒ½
- é…ç½®ä¸åŒçš„å­˜å„²å¾Œç«¯
- ä½¿ç”¨ MessageChatMemoryAdvisor é€²è¡Œè¨˜æ†¶ç®¡ç†
- å»ºç«‹å®Œæ•´çš„å°è©±ç³»çµ±

---

**åƒè€ƒè³‡æ–™ï¼š**
- [Spring AI Memory Documentation](https://docs.spring.io/spring-ai/reference/api/chat-memory.html)
- [ChatClient API Guide](https://docs.spring.io/spring-ai/reference/api/chatclient.html)
- [Spring AI Advisors](https://docs.spring.io/spring-ai/reference/api/advisors.html)
- [Memory Management Best Practices](https://docs.spring.io/spring-ai/reference/concepts.html)