# 6.6 å®‰è£ Neo4j å‘é‡è³‡æ–™åº«

> **æœ¬ç« é‡é»**ï¼šå­¸ç¿’å¦‚ä½•å®‰è£å’Œé…ç½® Neo4j å‘é‡è³‡æ–™åº«ï¼Œç‚º Spring AI çš„å‘é‡è¨˜æ†¶åŠŸèƒ½å»ºç«‹å¼·å¤§çš„å­˜å„²å¾Œç«¯ã€‚

## ğŸ¯ å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬ç« å­¸ç¿’å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š

- ğŸ¯ **ç†è§£å‘é‡è³‡æ–™åº«æ¦‚å¿µ**ï¼šæŒæ¡å‘é‡è³‡æ–™åº«çš„åŸç†å’Œæ‡‰ç”¨å ´æ™¯
- ğŸ¯ **å®‰è£ Neo4j è³‡æ–™åº«**ï¼šå­¸æœƒåœ¨ä¸åŒç’°å¢ƒä¸­å®‰è£å’Œé…ç½® Neo4j
- ğŸ¯ **é…ç½®å‘é‡ç´¢å¼•**ï¼šå»ºç«‹é«˜æ•ˆçš„å‘é‡æœå°‹å’Œå­˜å„²æ©Ÿåˆ¶
- ğŸ¯ **æ•´åˆ Spring AI**ï¼šå°‡ Neo4j èˆ‡ Spring AI è¨˜æ†¶ç³»çµ±å®Œç¾æ•´åˆ
- ğŸ¯ **æ•ˆèƒ½å„ªåŒ–èª¿æ ¡**ï¼šæŒæ¡ Neo4j çš„æ•ˆèƒ½èª¿æ ¡å’Œç›£æ§æŠ€å·§

---

## 6.6.1 å‘é‡è³‡æ–™åº«æ¦‚è¿°

### ä»€éº¼æ˜¯å‘é‡è³‡æ–™åº«ï¼Ÿ

å‘é‡è³‡æ–™åº«æ˜¯å°ˆé–€è¨­è¨ˆç”¨ä¾†å­˜å„²ã€ç´¢å¼•å’ŒæŸ¥è©¢é«˜ç¶­å‘é‡è³‡æ–™çš„è³‡æ–™åº«ç³»çµ±ã€‚åœ¨ AI å’Œæ©Ÿå™¨å­¸ç¿’é ˜åŸŸï¼Œå‘é‡è³‡æ–™åº«æ‰®æ¼”è‘—é—œéµè§’è‰²ã€‚

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- ğŸ” **èªç¾©æœå°‹**ï¼šåŸºæ–¼å‘é‡ç›¸ä¼¼æ€§é€²è¡Œæœå°‹ï¼Œè€Œéé—œéµå­—åŒ¹é…
- ğŸ“Š **é«˜ç¶­æ”¯æ´**ï¼šæ”¯æ´æ•¸ç™¾åˆ°æ•¸åƒç¶­çš„å‘é‡è³‡æ–™
- âš¡ **é«˜æ•ˆæª¢ç´¢**ï¼šä½¿ç”¨å°ˆé–€çš„ç´¢å¼•ç®—æ³•å¯¦ç¾å¿«é€Ÿç›¸ä¼¼æ€§æœå°‹
- ğŸ”„ **å¯¦æ™‚æ›´æ–°**ï¼šæ”¯æ´å‘é‡è³‡æ–™çš„å³æ™‚æ’å…¥ã€æ›´æ–°å’Œåˆªé™¤
- ğŸ“ˆ **å¯æ“´å±•æ€§**ï¼šèƒ½å¤ è™•ç†å¤§è¦æ¨¡çš„å‘é‡è³‡æ–™é›†

### å‘é‡è³‡æ–™åº« vs å‚³çµ±è³‡æ–™åº«

| ç‰¹æ€§ | å‚³çµ±è³‡æ–™åº« | å‘é‡è³‡æ–™åº« |
|------|------------|------------|
| **è³‡æ–™é¡å‹** | çµæ§‹åŒ–è³‡æ–™ | é«˜ç¶­å‘é‡ |
| **æŸ¥è©¢æ–¹å¼** | ç²¾ç¢ºåŒ¹é… | ç›¸ä¼¼æ€§æœå°‹ |
| **ç´¢å¼•æ–¹æ³•** | B-Tree, Hash | HNSW, IVF, LSH |
| **æ‡‰ç”¨å ´æ™¯** | äº‹å‹™è™•ç† | AI/ML æ‡‰ç”¨ |
| **æŸ¥è©¢èªè¨€** | SQL | å‘é‡æŸ¥è©¢ API |

### Neo4j ä½œç‚ºå‘é‡è³‡æ–™åº«çš„å„ªå‹¢

**1. åœ–å½¢è³‡æ–™åº«åŸºç¤**
- ğŸ•¸ï¸ **é—œä¿‚å»ºæ¨¡**ï¼šå¤©ç„¶æ”¯æ´è¤‡é›œçš„è³‡æ–™é—œä¿‚
- ğŸ”— **åœ–å½¢æŸ¥è©¢**ï¼šå¼·å¤§çš„ Cypher æŸ¥è©¢èªè¨€
- ğŸ“Š **åœ–å½¢åˆ†æ**ï¼šå…§å»ºè±å¯Œçš„åœ–å½¢ç®—æ³•

**2. å‘é‡åŠŸèƒ½æ•´åˆ**
- ğŸ¯ **å‘é‡ç´¢å¼•**ï¼šæ”¯æ´é«˜æ•ˆçš„å‘é‡ç›¸ä¼¼æ€§æœå°‹
- ğŸ”„ **æ··åˆæŸ¥è©¢**ï¼šçµåˆåœ–å½¢æŸ¥è©¢å’Œå‘é‡æœå°‹
- ğŸ“ˆ **å¯æ“´å±•æ€§**ï¼šæ”¯æ´å¤§è¦æ¨¡å‘é‡è³‡æ–™è™•ç†

**3. ä¼æ¥­ç´šç‰¹æ€§**
- ğŸ›¡ï¸ **ACID äº‹å‹™**ï¼šä¿è­‰è³‡æ–™ä¸€è‡´æ€§
- ğŸ”’ **å®‰å…¨æ§åˆ¶**ï¼šå®Œæ•´çš„èº«ä»½é©—è­‰å’Œæˆæ¬Š
- ğŸ“Š **ç›£æ§ç®¡ç†**ï¼šè±å¯Œçš„ç›£æ§å’Œç®¡ç†å·¥å…·

---

## 6.6.2 Neo4j å®‰è£æ–¹å¼é¸æ“‡

### å®‰è£æ–¹å¼æ¯”è¼ƒ

| å®‰è£æ–¹å¼ | é©ç”¨å ´æ™¯ | å„ªé» | ç¼ºé» |
|----------|----------|------|------|
| **Docker** | é–‹ç™¼ã€æ¸¬è©¦ | å¿«é€Ÿéƒ¨ç½²ã€ç’°å¢ƒéš”é›¢ | æ•ˆèƒ½ç•¥ä½ |
| **æœ¬åœ°å®‰è£** | ç”Ÿç”¢ç’°å¢ƒ | æœ€ä½³æ•ˆèƒ½ã€å®Œå…¨æ§åˆ¶ | é…ç½®è¤‡é›œ |
| **Neo4j Desktop** | é–‹ç™¼å­¸ç¿’ | åœ–å½¢ä»‹é¢ã€æ˜“æ–¼ä½¿ç”¨ | åƒ…é©åˆé–‹ç™¼ |
| **é›²ç«¯æœå‹™** | ä¼æ¥­éƒ¨ç½² | è¨—ç®¡æœå‹™ã€é«˜å¯ç”¨ | æˆæœ¬è¼ƒé«˜ |

### ç³»çµ±éœ€æ±‚

**æœ€ä½éœ€æ±‚**ï¼š
- **CPU**ï¼š2 æ ¸å¿ƒ
- **è¨˜æ†¶é«”**ï¼š4GB RAM
- **å­˜å„²**ï¼š10GB å¯ç”¨ç©ºé–“
- **Java**ï¼šJDK 17 æˆ–æ›´é«˜ç‰ˆæœ¬

**æ¨è–¦é…ç½®**ï¼š
- **CPU**ï¼š4+ æ ¸å¿ƒ
- **è¨˜æ†¶é«”**ï¼š8GB+ RAM
- **å­˜å„²**ï¼šSSD å­˜å„²ï¼Œ50GB+ å¯ç”¨ç©ºé–“
- **ç¶²è·¯**ï¼šåƒå…†ç¶²è·¯é€£æ¥

---

## 6.6.3 Docker æ–¹å¼å®‰è£ Neo4j

### åŸºæœ¬ Docker å®‰è£

```bash
# æ‹‰å– Neo4j å®˜æ–¹æ˜ åƒ
docker pull neo4j:5.15

# å»ºç«‹ Neo4j å®¹å™¨
docker run -d \
  --name neo4j-vector \
  -p 7474:7474 \
  -p 7687:7687 \
  -e NEO4J_AUTH=neo4j/password123 \
  -e NEO4J_PLUGINS='["apoc","graph-data-science"]' \
  -v neo4j_data:/data \
  -v neo4j_logs:/logs \
  neo4j:5.15
```

### Docker Compose é…ç½®

```yaml
# docker-compose.yml
version: '3.8'

services:
  neo4j:
    image: neo4j:5.15
    container_name: neo4j-vector
    restart: unless-stopped
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      # èªè­‰è¨­å®š
      NEO4J_AUTH: neo4j/password123
      
      # æ’ä»¶é…ç½®
      NEO4J_PLUGINS: '["apoc","graph-data-science"]'
      
      # è¨˜æ†¶é«”é…ç½®
      NEO4J_dbms_memory_heap_initial__size: 1G
      NEO4J_dbms_memory_heap_max__size: 2G
      NEO4J_dbms_memory_pagecache_size: 1G
      
      # å‘é‡é…ç½®
      NEO4J_db_index_vector_enabled: 'true'
      NEO4J_db_index_vector_dimensions_limit: 2048
      
      # å®‰å…¨é…ç½®
      NEO4J_dbms_security_procedures_unrestricted: 'apoc.*,gds.*'
      NEO4J_dbms_security_procedures_allowlist: 'apoc.*,gds.*'
      
      # æ•ˆèƒ½é…ç½®
      NEO4J_dbms_query_cache_size: 1000
      NEO4J_dbms_query_cache_ttl: 70s
      
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins
    
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p password123 'RETURN 1'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  neo4j_data:
  neo4j_logs:
  neo4j_import:
  neo4j_plugins:

networks:
  default:
    name: spring-ai-network
```

### å•Ÿå‹•å’Œé©—è­‰

```bash
# å•Ÿå‹• Neo4j
docker-compose up -d

# æª¢æŸ¥å®¹å™¨ç‹€æ…‹
docker-compose ps

# æŸ¥çœ‹æ—¥èªŒ
docker-compose logs -f neo4j

# é€²å…¥å®¹å™¨
docker exec -it neo4j-vector bash

# ä½¿ç”¨ Cypher Shell é€£æ¥
docker exec -it neo4j-vector cypher-shell -u neo4j -p password123
```

---

## 6.6.4 Neo4j å‘é‡åŠŸèƒ½é…ç½®

### å•Ÿç”¨å‘é‡ç´¢å¼•åŠŸèƒ½

```cypher
-- æª¢æŸ¥å‘é‡åŠŸèƒ½æ˜¯å¦å•Ÿç”¨
CALL dbms.components() YIELD name, versions, edition
WHERE name = 'Neo4j Kernel'
RETURN name, versions, edition;

-- æª¢æŸ¥å¯ç”¨çš„ç´¢å¼•é¡å‹
CALL db.indexes() YIELD name, type, entityType, labelsOrTypes, properties
WHERE type CONTAINS 'VECTOR'
RETURN *;
```

### å»ºç«‹å‘é‡ç´¢å¼•

```cypher
-- å»ºç«‹æ–‡æª”å‘é‡ç´¢å¼•
CREATE VECTOR INDEX document_embeddings IF NOT EXISTS
FOR (d:Document)
ON d.embedding
OPTIONS {
  indexConfig: {
    `vector.dimensions`: 1536,
    `vector.similarity_function`: 'cosine'
  }
};

-- å»ºç«‹å°è©±è¨˜æ†¶å‘é‡ç´¢å¼•
CREATE VECTOR INDEX conversation_embeddings IF NOT EXISTS
FOR (m:Message)
ON m.embedding
OPTIONS {
  indexConfig: {
    `vector.dimensions`: 1536,
    `vector.similarity_function`: 'cosine'
  }
};

-- å»ºç«‹ç”¨æˆ¶æŸ¥è©¢å‘é‡ç´¢å¼•
CREATE VECTOR INDEX query_embeddings IF NOT EXISTS
FOR (q:Query)
ON q.embedding
OPTIONS {
  indexConfig: {
    `vector.dimensions`: 1536,
    `vector.similarity_function`: 'euclidean'
  }
};
```

### å‘é‡ç›¸ä¼¼æ€§å‡½æ•¸é¸æ“‡

```cypher
-- Cosine ç›¸ä¼¼æ€§ï¼ˆæ¨è–¦ç”¨æ–¼æ–‡æœ¬åµŒå…¥ï¼‰
CREATE VECTOR INDEX cosine_index
FOR (n:Node) ON n.embedding
OPTIONS {
  indexConfig: {
    `vector.dimensions`: 1536,
    `vector.similarity_function`: 'cosine'
  }
};

-- Euclidean è·é›¢
CREATE VECTOR INDEX euclidean_index
FOR (n:Node) ON n.embedding
OPTIONS {
  indexConfig: {
    `vector.dimensions`: 1536,
    `vector.similarity_function`: 'euclidean'
  }
};

-- å…§ç©ç›¸ä¼¼æ€§
CREATE VECTOR INDEX dot_product_index
FOR (n:Node) ON n.embedding
OPTIONS {
  indexConfig: {
    `vector.dimensions`: 1536,
    `vector.similarity_function`: 'dot_product'
  }
};
```

---

## 6.6.5 Spring AI æ•´åˆé…ç½®

### Maven ä¾è³´é…ç½®

```xml
<!-- pom.xml -->
<dependencies>
    <!-- Spring AI Neo4j Vector Store -->
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-starter-vector-store-neo4j</artifactId>
    </dependency>
    
    <!-- Neo4j Java Driver -->
    <dependency>
        <groupId>org.neo4j.driver</groupId>
        <artifactId>neo4j-java-driver</artifactId>
    </dependency>
    
    <!-- Spring Boot Starter -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter</artifactId>
    </dependency>
    
    <!-- Spring AI OpenAI -->
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-openai-spring-boot-starter</artifactId>
    </dependency>
</dependencies>

<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-bom</artifactId>
            <version>1.0.0</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

### Spring Boot é…ç½®

```yaml
# application.yml
spring:
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      chat:
        options:
          model: gpt-4o-mini
          temperature: 0.7
    
    vectorstore:
      neo4j:
        initialize-schema: true
        database-name: neo4j
        index-name: spring-ai-document-index
        embedding-dimension: 1536
        distance-type: cosine
        label: Document
        embedding-property: embedding

  neo4j:
    uri: bolt://localhost:7687
    authentication:
      username: neo4j
      password: password123

# é–‹ç™¼ç’°å¢ƒé…ç½®
---
spring:
  config:
    activate:
      on-profile: dev
  ai:
    vectorstore:
      neo4j:
        initialize-schema: true
  neo4j:
    uri: bolt://localhost:7687
        
# ç”Ÿç”¢ç’°å¢ƒé…ç½®
---
spring:
  config:
    activate:
      on-profile: prod
  ai:
    vectorstore:
      neo4j:
        initialize-schema: false
  neo4j:
    uri: ${NEO4J_URI}
    authentication:
      username: ${NEO4J_USERNAME}
      password: ${NEO4J_PASSWORD}
```

### Neo4j å‘é‡å­˜å„²é…ç½®é¡

```java
import org.neo4j.driver.Driver;
import org.neo4j.driver.GraphDatabase;
import org.neo4j.driver.AuthTokens;
import org.neo4j.driver.Config;
import org.neo4j.driver.Logging;
import org.springframework.ai.vectorstore.Neo4jVectorStore;
import org.springframework.ai.vectorstore.Neo4jVectorStore.Neo4jDistanceType;
import org.springframework.ai.embedding.EmbeddingModel;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import io.micrometer.core.instrument.MeterRegistry;
import lombok.extern.slf4j.Slf4j;
import java.util.concurrent.TimeUnit;

/**
 * Neo4j å‘é‡å­˜å„²é…ç½®
 */
@Configuration
@EnableConfigurationProperties(Neo4jVectorStoreProperties.class)
@Slf4j
public class Neo4jVectorStoreConfig {
    
    /**
     * Neo4j Driver é…ç½®
     */
    @Bean
    public Driver neo4jDriver(@Value("${spring.neo4j.uri}") String uri,
                              @Value("${spring.neo4j.authentication.username}") String username,
                              @Value("${spring.neo4j.authentication.password}") String password) {
        log.info("Configuring Neo4j Driver with URI: {}", uri);
        
        Config config = Config.builder()
            .withConnectionTimeout(30, TimeUnit.SECONDS)
            .withMaxTransactionRetryTime(15, TimeUnit.SECONDS)
            .withLogging(Logging.slf4j())
            .build();
        
        return GraphDatabase.driver(uri, AuthTokens.basic(username, password), config);
    }
    
    /**
     * Neo4j Vector Store é…ç½®
     */
    @Bean
    public Neo4jVectorStore neo4jVectorStore(
            Driver driver,
            EmbeddingModel embeddingModel,
            Neo4jVectorStoreProperties properties) {
        
        log.info("Configuring Neo4j Vector Store");
        
        return Neo4jVectorStore.builder(driver, embeddingModel)
            .databaseName(properties.getDatabaseName())
            .embeddingDimension(properties.getEmbeddingDimension())
            .distanceType(Neo4jDistanceType.valueOf(properties.getDistanceType().toUpperCase()))
            .indexName(properties.getIndexName())
            .label(properties.getLabel())
            .embeddingProperty(properties.getEmbeddingProperty())
            .initializeSchema(properties.isInitializeSchema())
            .build();
    }
    
    /**
     * Neo4j å¥åº·æª¢æŸ¥
     */
    @Bean
    public Neo4jHealthIndicator neo4jHealthIndicator(Driver driver) {
        return new Neo4jHealthIndicator(driver);
    }
    
    /**
     * Neo4j ç›£æ§æŒ‡æ¨™
     */
    @Bean
    public Neo4jMetrics neo4jMetrics(Driver driver, MeterRegistry meterRegistry) {
        return new Neo4jMetrics(driver, meterRegistry);
    }
}
```

### é…ç½®å±¬æ€§é¡

```java
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.validation.annotation.Validated;
import lombok.Data;
import javax.validation.constraints.NotBlank;
import javax.validation.constraints.Min;
import javax.validation.constraints.Max;
import java.time.Duration;

/**
 * Neo4j å‘é‡å­˜å„²é…ç½®å±¬æ€§
 */
@ConfigurationProperties(prefix = "spring.ai.vectorstore.neo4j")
@Data
@Validated
public class Neo4jVectorStoreProperties {
    
    /**
     * æ˜¯å¦åˆå§‹åŒ– Schema
     */
    private boolean initializeSchema = false;
    
    /**
     * è³‡æ–™åº«åç¨±
     */
    private String databaseName = "neo4j";
    
    /**
     * å‘é‡ç¶­åº¦
     */
    @Min(1)
    @Max(4096)
    private int embeddingDimension = 1536;
    
    /**
     * è·é›¢å‡½æ•¸é¡å‹
     */
    private String distanceType = "cosine";
    
    /**
     * ç´¢å¼•åç¨±
     */
    private String indexName = "spring_ai_embeddings";
    
    /**
     * ç¯€é»æ¨™ç±¤
     */
    private String label = "Document";
    
    /**
     * åµŒå…¥å±¬æ€§åç¨±
     */
    private String embeddingProperty = "embedding";
    
    
    // Getter å’Œ Setter æ–¹æ³•
    public boolean isInitializeSchema() {
        return initializeSchema;
    }
    
    public void setInitializeSchema(boolean initializeSchema) {
        this.initializeSchema = initializeSchema;
    }
    
    public String getDatabaseName() {
        return databaseName;
    }
    
    public void setDatabaseName(String databaseName) {
        this.databaseName = databaseName;
    }
}
```

---

## 6.6.6 Neo4j æ•ˆèƒ½å„ªåŒ–

### è¨˜æ†¶é«”é…ç½®å„ªåŒ–

```bash
# neo4j.conf é…ç½®æª”æ¡ˆ

# JVM å †è¨˜æ†¶é«”é…ç½®
server.memory.heap.initial_size=2G
server.memory.heap.max_size=4G

# é é¢å¿«å–é…ç½®ï¼ˆç”¨æ–¼å­˜å„²ç¯€é»å’Œé—œä¿‚ï¼‰
server.memory.pagecache.size=2G

# äº‹å‹™ç‹€æ…‹è¨˜æ†¶é«”
db.memory.transaction.global_max_size=1G
db.memory.transaction.max_size=100M

# æŸ¥è©¢è¨˜æ†¶é«”é…ç½®
dbms.memory.query.max_size=500M
dbms.memory.query.cache_size=1000
```

### å‘é‡ç´¢å¼•å„ªåŒ–

```cypher
-- æª¢æŸ¥å‘é‡ç´¢å¼•ç‹€æ…‹
CALL db.indexes() YIELD name, type, state, populationPercent
WHERE type CONTAINS 'VECTOR'
RETURN name, type, state, populationPercent;

-- é‡å»ºå‘é‡ç´¢å¼•ï¼ˆå¦‚æœéœ€è¦ï¼‰
DROP INDEX document_embeddings IF EXISTS;
CREATE VECTOR INDEX document_embeddings
FOR (d:Document)
ON d.embedding
OPTIONS {
  indexConfig: {
    `vector.dimensions`: 1536,
    `vector.similarity_function`: 'cosine',
    `vector.hnsw.max_connections`: 16,
    `vector.hnsw.ef_construction`: 200
  }
};

-- æª¢æŸ¥ç´¢å¼•æ•ˆèƒ½
CALL db.index.fulltext.queryNodes('document_embeddings', 'test') 
YIELD node, score
RETURN count(node) as total_nodes;
```

### æŸ¥è©¢æ•ˆèƒ½å„ªåŒ–

```cypher
-- ä½¿ç”¨ EXPLAIN åˆ†ææŸ¥è©¢è¨ˆåŠƒ
EXPLAIN
CALL db.index.vector.queryNodes('document_embeddings', 10, $queryVector)
YIELD node, score
RETURN node.content, score
ORDER BY score DESC
LIMIT 5;

-- ä½¿ç”¨ PROFILE åˆ†ææŸ¥è©¢æ•ˆèƒ½
PROFILE
CALL db.index.vector.queryNodes('document_embeddings', 10, $queryVector)
YIELD node, score
WHERE score > 0.8
RETURN node.content, score
ORDER BY score DESC
LIMIT 5;
```

### ç›£æ§å’Œè¨ºæ–·

```java
/**
 * Neo4j æ•ˆèƒ½ç›£æ§æœå‹™
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class Neo4jMonitoringService {
    
    private final Driver driver;
    private final MeterRegistry meterRegistry;
    
    @EventListener
    @Async
    public void handleVectorQuery(VectorQueryEvent event) {
        // è¨˜éŒ„å‘é‡æŸ¥è©¢çµ±è¨ˆ
        Timer.Sample sample = Timer.start(meterRegistry);
        sample.stop(Timer.builder("neo4j.vector.query.time")
            .description("Neo4j vector query execution time")
            .tag("index", event.getIndexName())
            .register(meterRegistry));
        
        meterRegistry.counter("neo4j.vector.query.count",
            "index", event.getIndexName(),
            "success", String.valueOf(event.isSuccess()))
            .increment();
    }
    
    /**
     * å–å¾—è³‡æ–™åº«çµ±è¨ˆè³‡è¨Š
     */
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é˜åŸ·è¡Œä¸€æ¬¡
    public void collectDatabaseStats() {
        try (Session session = driver.session()) {
            // ç¯€é»æ•¸é‡çµ±è¨ˆ
            Result nodeCountResult = session.run("MATCH (n) RETURN count(n) as nodeCount");
            long nodeCount = nodeCountResult.single().get("nodeCount").asLong();
            meterRegistry.gauge("neo4j.nodes.count", nodeCount);
            
            // é—œä¿‚æ•¸é‡çµ±è¨ˆ
            Result relCountResult = session.run("MATCH ()-[r]->() RETURN count(r) as relCount");
            long relCount = relCountResult.single().get("relCount").asLong();
            meterRegistry.gauge("neo4j.relationships.count", relCount);
            
            // å‘é‡ç´¢å¼•çµ±è¨ˆ
            Result indexResult = session.run(
                "CALL db.indexes() YIELD name, type, state, populationPercent " +
                "WHERE type CONTAINS 'VECTOR' " +
                "RETURN name, populationPercent"
            );
            
            while (indexResult.hasNext()) {
                Record record = indexResult.next();
                String indexName = record.get("name").asString();
                double populationPercent = record.get("populationPercent").asDouble();
                
                meterRegistry.gauge("neo4j.index.population.percent",
                    Tags.of("index", indexName), populationPercent);
            }
            
        } catch (Exception e) {
            log.error("Failed to collect Neo4j statistics", e);
        }
    }
    
    /**
     * æª¢æŸ¥è³‡æ–™åº«å¥åº·ç‹€æ…‹
     */
    public DatabaseHealthStatus checkHealth() {
        try (Session session = driver.session()) {
            // åŸ·è¡Œç°¡å–®æŸ¥è©¢æ¸¬è©¦é€£æ¥
            session.run("RETURN 1").consume();
            
            // æª¢æŸ¥å‘é‡ç´¢å¼•ç‹€æ…‹
            Result indexResult = session.run(
                "CALL db.indexes() YIELD name, type, state " +
                "WHERE type CONTAINS 'VECTOR' AND state <> 'ONLINE' " +
                "RETURN count(*) as offlineIndexes"
            );
            
            long offlineIndexes = indexResult.single().get("offlineIndexes").asLong();
            
            return DatabaseHealthStatus.builder()
                .healthy(true)
                .offlineIndexes(offlineIndexes)
                .timestamp(LocalDateTime.now())
                .build();
                
        } catch (Exception e) {
            log.error("Neo4j health check failed", e);
            return DatabaseHealthStatus.builder()
                .healthy(false)
                .error(e.getMessage())
                .timestamp(LocalDateTime.now())
                .build();
        }
    }
}
```

---

## 6.6.7 æ¸¬è©¦å’Œé©—è­‰

### åŸºæœ¬åŠŸèƒ½æ¸¬è©¦

```java
/**
 * Neo4j å‘é‡å­˜å„²æ¸¬è©¦
 */
@SpringBootTest
@TestMethodOrder(OrderAnnotation.class)
class Neo4jVectorStoreTest {
    
    @Autowired
    private Neo4jVectorStore vectorStore;
    
    @Autowired
    private EmbeddingModel embeddingModel;
    
    private static final String TEST_CONTENT_1 = "Spring AI is a powerful framework for building AI applications.";
    private static final String TEST_CONTENT_2 = "Neo4j is a graph database that supports vector operations.";
    
    @Test
    @Order(1)
    void testAddDocuments() {
        // å»ºç«‹æ¸¬è©¦æ–‡æª”
        List<Document> documents = Arrays.asList(
            new Document(TEST_CONTENT_1, Map.of("category", "framework")),
            new Document(TEST_CONTENT_2, Map.of("category", "database"))
        );
        
        // æ·»åŠ åˆ°å‘é‡å­˜å„²
        vectorStore.add(documents);
        
        // é©—è­‰æ–‡æª”å·²æ·»åŠ 
        assertThat(documents).allMatch(doc -> doc.getId() != null);
    }
    
    @Test
    @Order(2)
    void testSimilaritySearch() {
        // åŸ·è¡Œç›¸ä¼¼æ€§æœå°‹
        String query = "What is Spring AI?";
        List<Document> results = vectorStore.similaritySearch(
            SearchRequest.builder().query(query).topK(5).build()
        );
        
        // é©—è­‰æœå°‹çµæœ
        assertThat(results).isNotEmpty();
        assertThat(results.get(0).getContent()).contains("Spring AI");
    }
    
    @Test
    @Order(3)
    void testSimilaritySearchWithThreshold() {
        // ä½¿ç”¨ç›¸ä¼¼æ€§é–¾å€¼æœå°‹
        String query = "graph database";
        List<Document> results = vectorStore.similaritySearch(
            SearchRequest.builder()
                .query(query)
                .topK(10)
                .similarityThreshold(0.7)
                .build()
        );
        
        // é©—è­‰çµæœç¬¦åˆé–¾å€¼è¦æ±‚
        assertThat(results).isNotEmpty();
        results.forEach(doc -> {
            assertThat(doc.getMetadata()).containsKey("distance");
            double similarity = 1.0 - (Double) doc.getMetadata().get("distance");
            assertThat(similarity).isGreaterThanOrEqualTo(0.7);
        });
    }
    
    @Test
    @Order(4)
    void testDeleteDocuments() {
        // æœå°‹è¦åˆªé™¤çš„æ–‡æª”
        List<Document> documents = vectorStore.similaritySearch(
            SearchRequest.builder().query(TEST_CONTENT_1).topK(1).build()
        );
        
        assertThat(documents).isNotEmpty();
        
        // åˆªé™¤æ–‡æª”
        List<String> idsToDelete = documents.stream()
            .map(Document::getId)
            .collect(Collectors.toList());
        
        vectorStore.delete(idsToDelete);
        
        // é©—è­‰æ–‡æª”å·²åˆªé™¤
        List<Document> remainingDocs = vectorStore.similaritySearch(
            SearchRequest.builder().query(TEST_CONTENT_1).topK(1).build()
        );
        
        assertThat(remainingDocs).isEmpty();
    }
}
```

### æ•ˆèƒ½æ¸¬è©¦

```java
/**
 * Neo4j å‘é‡å­˜å„²æ•ˆèƒ½æ¸¬è©¦
 */
@SpringBootTest
class Neo4jVectorStorePerformanceTest {
    
    @Autowired
    private Neo4jVectorStore vectorStore;
    
    @Test
    void testBatchInsertPerformance() {
        int batchSize = 1000;
        List<Document> documents = generateTestDocuments(batchSize);
        
        StopWatch stopWatch = new StopWatch();
        stopWatch.start();
        
        vectorStore.add(documents);
        
        stopWatch.stop();
        
        long executionTime = stopWatch.getTotalTimeMillis();
        double documentsPerSecond = (double) batchSize / (executionTime / 1000.0);
        
        log.info("Batch insert performance: {} documents in {} ms ({} docs/sec)",
            batchSize, executionTime, String.format("%.2f", documentsPerSecond));
        
        // é©—è­‰æ•ˆèƒ½æŒ‡æ¨™
        assertThat(documentsPerSecond).isGreaterThan(10); // è‡³å°‘ 10 docs/sec
    }
    
    @Test
    void testSearchPerformance() {
        // å…ˆæ’å…¥æ¸¬è©¦è³‡æ–™
        List<Document> documents = generateTestDocuments(5000);
        vectorStore.add(documents);
        
        // æ¸¬è©¦æœå°‹æ•ˆèƒ½
        String query = "test query for performance";
        int iterations = 100;
        
        StopWatch stopWatch = new StopWatch();
        stopWatch.start();
        
        for (int i = 0; i < iterations; i++) {
            vectorStore.similaritySearch(
                SearchRequest.builder().query(query + " " + i).topK(10).build()
            );
        }
        
        stopWatch.stop();
        
        long totalTime = stopWatch.getTotalTimeMillis();
        double avgQueryTime = (double) totalTime / iterations;
        
        log.info("Search performance: {} queries in {} ms (avg: {} ms/query)",
            iterations, totalTime, String.format("%.2f", avgQueryTime));
        
        // é©—è­‰æœå°‹æ•ˆèƒ½
        assertThat(avgQueryTime).isLessThan(1000); // å¹³å‡æŸ¥è©¢æ™‚é–“å°æ–¼ 1 ç§’
    }
    
    private List<Document> generateTestDocuments(int count) {
        return IntStream.range(0, count)
            .mapToObj(i -> new Document(
                "Test document content " + i + " with some random text for testing purposes.",
                Map.of("index", i, "category", "test")
            ))
            .collect(Collectors.toList());
    }
}
```

---

## ğŸ“ æœ¬ç« é‡é»å›é¡§

1. **å‘é‡è³‡æ–™åº«æ¦‚å¿µ**ï¼šç†è§£äº†å‘é‡è³‡æ–™åº«çš„åŸç†å’Œ Neo4j çš„å„ªå‹¢
2. **Docker å®‰è£é…ç½®**ï¼šæŒæ¡äº†ä½¿ç”¨ Docker å’Œ Docker Compose å®‰è£ Neo4j
3. **å‘é‡ç´¢å¼•å»ºç«‹**ï¼šå­¸æœƒäº†å»ºç«‹å’Œé…ç½®é«˜æ•ˆçš„å‘é‡ç´¢å¼•
4. **Spring AI æ•´åˆ**ï¼šå®Œæˆäº† Neo4j èˆ‡ Spring AI çš„å®Œæ•´æ•´åˆé…ç½®
5. **æ•ˆèƒ½å„ªåŒ–èª¿æ ¡**ï¼šå¯¦ç¾äº†è¨˜æ†¶é«”é…ç½®ã€ç´¢å¼•å„ªåŒ–å’Œç›£æ§æ©Ÿåˆ¶

### æŠ€è¡“è¦é»ç¸½çµ

| æŠ€è¡“é» | é‡è¦æ€§ | å¯¦ç¾é›£åº¦ | ä¼æ¥­åƒ¹å€¼ |
|--------|--------|----------|----------|
| **Docker éƒ¨ç½²** | â­â­â­ | ä½ | å¿«é€Ÿéƒ¨ç½² |
| **å‘é‡ç´¢å¼•é…ç½®** | â­â­â­ | ä¸­ | æœå°‹æ•ˆèƒ½ |
| **Spring AI æ•´åˆ** | â­â­â­ | ä¸­ | åŠŸèƒ½æ•´åˆ |
| **æ•ˆèƒ½å„ªåŒ–** | â­â­ | é«˜ | ç”Ÿç”¢å°±ç·’ |
| **ç›£æ§è¨ºæ–·** | â­â­ | ä¸­ | é‹ç¶­ç®¡ç† |

### æœ€ä½³å¯¦è¸å»ºè­°

1. **ç’°å¢ƒè¦åŠƒ**ï¼šæ ¹æ“šæ‡‰ç”¨è¦æ¨¡é¸æ“‡åˆé©çš„éƒ¨ç½²æ–¹å¼å’Œç¡¬é«”é…ç½®
2. **ç´¢å¼•è¨­è¨ˆ**ï¼šåˆç†é¸æ“‡å‘é‡ç¶­åº¦å’Œç›¸ä¼¼æ€§å‡½æ•¸ï¼Œå„ªåŒ–æœå°‹æ•ˆèƒ½
3. **è¨˜æ†¶é«”é…ç½®**ï¼šæ ¹æ“šè³‡æ–™é‡å’ŒæŸ¥è©¢é »ç‡èª¿æ•´è¨˜æ†¶é«”åˆ†é…
4. **ç›£æ§å‘Šè­¦**ï¼šå»ºç«‹å®Œæ•´çš„æ•ˆèƒ½ç›£æ§å’Œå¥åº·æª¢æŸ¥æ©Ÿåˆ¶
5. **å‚™ä»½ç­–ç•¥**ï¼šåˆ¶å®šå®šæœŸå‚™ä»½å’Œç½é›£æ¢å¾©è¨ˆåŠƒ

### ä¸‹ä¸€æ­¥å­¸ç¿’æ–¹å‘

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘å€‘å°‡å­¸ç¿’å¦‚ä½•ä½¿ç”¨å‘é‡è³‡æ–™åº«ä½œç‚ºå°è©±çš„é•·ä¹…è¨˜æ†¶ï¼ŒåŒ…æ‹¬ï¼š
- VectorStoreChatMemoryAdvisor çš„ä½¿ç”¨
- èªç¾©ç›¸ä¼¼æ€§æœå°‹çš„å¯¦ç¾
- å¤§è¦æ¨¡å°è©±æ­·å²çš„ç®¡ç†
- æ™ºèƒ½è¨˜æ†¶æª¢ç´¢ç­–ç•¥

---

**åƒè€ƒè³‡æ–™ï¼š**
- [Neo4j Vector Index Documentation](https://neo4j.com/docs/cypher-manual/current/indexes-for-vector-search/)
- [Spring AI Neo4j Vector Store](https://docs.spring.io/spring-ai/reference/api/vectordbs/neo4j.html)
- [Neo4j Docker Documentation](https://neo4j.com/developer/docker/)
- [Neo4j Performance Tuning](https://neo4j.com/developer/guide-performance-tuning/)