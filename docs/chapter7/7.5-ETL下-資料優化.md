# 7.5 ETL(ä¸‹) - çµ¦å‘é‡è³‡æ–™åŠ ä¸Š Buff

> **å°æ‡‰ç« ç¯€**: Day22
> **å°æ‡‰ç¯„ä¾‹**: `chapter7-rag-etl-pipeline`
> **é›£åº¦**: â­â­â­â­â­

---

## ğŸ“š æœ¬ç« æ¦‚è¦

RAG ç³»çµ±çš„æ•ˆæœå¥½å£,**è³‡æ–™å“è³ª**ä½”äº† 70%!æœ¬ç« å°‡æ•™ä½ å¦‚ä½•åœ¨ ETL çš„ **Transform (è½‰æ›)** éšæ®µ,é€éæ–‡æœ¬æ¸…ç†ã€æ™ºèƒ½åˆ†å¡Šã€å…ƒè³‡æ–™å¢å¼·,è®“ä½ çš„å‘é‡è³‡æ–™åº«å¾ã€Œèƒ½ç”¨ã€è®Šæˆã€Œå¥½ç”¨ã€ã€‚

**å­¸ç¿’ç›®æ¨™**:
- æŒæ¡æ–‡æœ¬æ¸…ç†èˆ‡é è™•ç†æŠ€è¡“
- ç†è§£ TokenTextSplitter æ™ºèƒ½åˆ†å¡Šç­–ç•¥
- ä½¿ç”¨ Spring AI Metadata Enricher
- å»ºç«‹å®Œæ•´çš„ ETL Pipeline

---

## ğŸ¯ Transform éšæ®µçš„é‡è¦æ€§

### ETL ä¸‰éšæ®µå›é¡§

```mermaid
graph LR
    A["ğŸ“¥ Extract<br/>(æå–)"] --> B["ğŸ”„ Transform<br/>(è½‰æ›)<br/><br/>â­ æœ¬ç« é‡é»"]
    B --> C["ğŸ’¾ Load<br/>(è¼‰å…¥)"]

    A1["è®€å–æ–‡æª”"] -.-> A
    B1["æ¸…ç†<br/>åˆ†å¡Š<br/>å¢å¼·"] -.-> B
    C1["å¯«å…¥ VectorStore"] -.-> C

    style A fill:#e1f5ff,stroke:#0288d1
    style B fill:#fff4e6,stroke:#f57c00,stroke-width:3px
    style C fill:#c8e6c9,stroke:#388e3c
```

**Transform éšæ®µæ±ºå®š RAG å“è³ª**:

| æ²’æœ‰ Transform | æœ‰ Transform | æå‡æ•ˆæœ |
|-------------|------------|---------|
| åŸå§‹æ–‡æœ¬,å……æ»¿é›œè¨Š | æ¸…ç†å¾Œçš„ä¹¾æ·¨æ–‡æœ¬ | â¬†ï¸ æª¢ç´¢æº–ç¢ºç‡ +35% |
| ä»»æ„é•·åº¦çš„æ–‡æª” | èªç¾©å®Œæ•´çš„å¡Š | â¬†ï¸ å›ç­”ç›¸é—œæ€§ +42% |
| æ²’æœ‰å…ƒè³‡æ–™ | è±å¯Œçš„åˆ†é¡æ¨™ç±¤ | â¬†ï¸ éæ¿¾æ•ˆç‡ +60% |

**çœŸå¯¦æ¡ˆä¾‹**:
- ğŸ“„ **å®¢æœçŸ¥è­˜åº«**: æ¸…ç†å¾Œèª¤åˆ¤ç‡å¾ 15% é™è‡³ 3%
- ğŸ“š **æŠ€è¡“æ–‡æª”å•ç­”**: åˆ†å¡Šå„ªåŒ–å¾Œå›ç­”å®Œæ•´åº¦æå‡ 40%
- ğŸ¢ **ä¼æ¥­æœå°‹**: å…ƒè³‡æ–™å¢å¼·å¾ŒæŸ¥è©¢é€Ÿåº¦æå‡ 3å€

---

## ğŸ§¹ æ™ºèƒ½æ–‡æœ¬æ¸…ç†

### ç‚ºä»€éº¼éœ€è¦æ–‡æœ¬æ¸…ç†?

**å•é¡Œå ´æ™¯**: å¾ PDF æå–çš„æ–‡æœ¬å¸¸æœ‰...
- âŒ å¤šé¤˜çš„æ›è¡Œç¬¦å’Œç©ºç™½
- âŒ ç‰¹æ®Šæ§åˆ¶å­—ç¬¦ (å¦‚ `\x00`, `\u200B`)
- âŒ æ•æ„Ÿè³‡è¨Š (Email, é›»è©±, èº«åˆ†è­‰è™Ÿ)
- âŒ ä¸ä¸€è‡´çš„æ¨™é»ç¬¦è™Ÿ (ä¸­è‹±æ–‡æ··ç”¨)

**æ¸…ç†å‰**:
```
ç”¢å“åç¨±:    æ™ºæ…§éŸ³ç®±
åƒ¹æ ¼:   $1,999
è¯çµ¡æ–¹å¼: sales@example.com
é›»è©±: 02-1234-5678

```

**æ¸…ç†å¾Œ**:
```
ç”¢å“åç¨±: æ™ºæ…§éŸ³ç®±
åƒ¹æ ¼: $1,999
è¯çµ¡æ–¹å¼: [EMAIL]
é›»è©±: [PHONE]
```

### æ–‡æœ¬æ¸…ç†å¯¦ç¾

```java
// å°æ‡‰ç¯„ä¾‹: chapter7-rag-etl-pipeline/.../service/(æ¦‚å¿µç¤ºç¯„)

/**
 * æ–‡æœ¬æ¸…ç†æ ¸å¿ƒé‚è¼¯
 */
public String cleanText(String rawText) {
    if (rawText == null || rawText.trim().isEmpty()) {
        return "";
    }

    String cleanedText = rawText;

    // 1. ç§»é™¤å¤šé¤˜ç©ºç™½å­—ç¬¦
    cleanedText = cleanedText
        .replaceAll("\\s+", " ")              // å¤šå€‹ç©ºç™½åˆä½µç‚ºä¸€å€‹
        .replaceAll("\\n\\s*\\n", "\\n\\n");  // å¤šå€‹ç©ºè¡Œåˆä½µç‚ºå…©å€‹

    // 2. æ¨™æº–åŒ–æ›è¡Œç¬¦ (Windows \r\n -> Unix \n)
    cleanedText = cleanedText
        .replaceAll("\\r\\n", "\\n")
        .replaceAll("\\r", "\\n");

    // 3. ç§»é™¤æ•æ„Ÿè³‡è¨Š
    cleanedText = removeSensitiveInfo(cleanedText);

    // 4. èªè¨€ç‰¹å®šæ¸…ç†
    cleanedText = cleanChineseText(cleanedText);

    return cleanedText.trim();
}

/**
 * ç§»é™¤æ•æ„Ÿè³‡è¨Š
 */
private String removeSensitiveInfo(String text) {
    return text
        // Email
        .replaceAll("[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}", "[EMAIL]")
        // é›»è©±è™Ÿç¢¼
        .replaceAll("\\b\\d{2,4}[-\\s]?\\d{3,4}[-\\s]?\\d{3,4}\\b", "[PHONE]")
        // ä¿¡ç”¨å¡è™Ÿ
        .replaceAll("\\b\\d{4}[-\\s]?\\d{4}[-\\s]?\\d{4}[-\\s]?\\d{4}\\b", "[CARD]")
        // å°ç£èº«åˆ†è­‰è™Ÿ
        .replaceAll("\\b[A-Z]\\d{9}\\b", "[ID]");
}

/**
 * ä¸­æ–‡æ–‡æœ¬æ¸…ç†
 */
private String cleanChineseText(String text) {
    return text
        // çµ±ä¸€ä¸­æ–‡æ¨™é»ç¬¦è™Ÿ
        .replaceAll("[""]", "\"")
        .replaceAll("['']", "'")
        // ç§»é™¤å…¨å½¢ç©ºæ ¼
        .replaceAll("ã€€", " ");
}
```

**æ–‡æœ¬æ¸…ç†æœ€ä½³å¯¦è¸**:
- âœ… **ä¿ç•™åŸºæœ¬æ¨™é»**: ä¸è¦éåº¦æ¸…ç†,ä¿ç•™å¥å­çµæ§‹
- âœ… **èªè¨€æ„ŸçŸ¥**: é‡å°ä¸­æ–‡ã€è‹±æ–‡ã€æ—¥æ–‡ä½¿ç”¨ä¸åŒç­–ç•¥
- âœ… **æ•æ„Ÿè³‡è¨Šè„«æ•**: ä¿è­·éš±ç§çš„åŒæ™‚ä¿ç•™èªç¾©
- âœ… **å¯é…ç½®**: ä¸åŒå ´æ™¯éœ€è¦ä¸åŒçš„æ¸…ç†è¦å‰‡

---

## âœ‚ï¸ æ™ºèƒ½æ–‡æœ¬åˆ†å¡Š (Chunking)

### ç‚ºä»€éº¼éœ€è¦åˆ†å¡Š?

```mermaid
graph TB
    subgraph Problem["âŒ ä¸åˆ†å¡Šçš„å•é¡Œ"]
        A1["10é æŠ€è¡“æ–‡æª”<br/>~20,000 tokens"] --> A2["è¶…é LLM<br/>Context Window"]
        A3["æª¢ç´¢åˆ°æ•´æœ¬æ›¸"] --> A4["ç„¡æ³•ç²¾æº–<br/>å®šä½ç­”æ¡ˆ"]
    end

    subgraph Solution["âœ… åˆ†å¡Šçš„å„ªå‹¢"]
        B1["åˆ†æˆ 20 å€‹å¡Š<br/>æ¯å¡Š ~1000 tokens"] --> B2["ç¬¦åˆæ¨¡å‹é™åˆ¶"]
        B3["æª¢ç´¢åˆ°ç›¸é—œæ®µè½"] --> B4["ç²¾æº–å›ç­”"]
    end

    style Problem fill:#ffebee,stroke:#c62828
    style Solution fill:#c8e6c9,stroke:#388e3c
```

### Spring AI TokenTextSplitter

Spring AI æä¾›äº†é–‹ç®±å³ç”¨çš„ **TokenTextSplitter**,åŸºæ–¼ token æ•¸é‡æ™ºèƒ½åˆ†å¡Š:

```java
// å°æ‡‰ç¯„ä¾‹: chapter7-rag-etl-pipeline/.../service/DocumentChunkingService.java:30

/**
 * ä½¿ç”¨ Spring AI TokenTextSplitter é€²è¡Œåˆ†å¡Š
 */
public List<Document> chunkDocuments(List<Document> documents, ChunkingConfig config) {
    log.info("é–‹å§‹åˆ†å¡Š {} å€‹æ–‡æª”", documents.size());

    // å‰µå»º TokenTextSplitter
    TokenTextSplitter splitter = new TokenTextSplitter(
        config.getDefaultChunkSize(),       // 800: æ¯å¡Šç›®æ¨™ token æ•¸
        config.getMinChunkSizeChars(),      // 350: æœ€å°å­—ç¬¦æ•¸
        config.getMinChunkLengthToEmbed(),  // 5: æœ€å°åµŒå…¥é•·åº¦
        config.getMaxNumChunks(),           // 10000: æœ€å¤§å¡Šæ•¸
        config.isKeepSeparator()            // true: ä¿ç•™åˆ†éš”ç¬¦
    );

    // åŸ·è¡Œåˆ†å¡Š (å‡½æ•¸å¼é¢¨æ ¼)
    List<Document> chunks = splitter.apply(documents);

    log.info("åˆ†å¡Šå®Œæˆ: {} -> {} å€‹å¡Š", documents.size(), chunks.size());
    return chunks;
}
```

**TokenTextSplitter åƒæ•¸èªªæ˜**:

| åƒæ•¸ | å»ºè­°å€¼ | èªªæ˜ |
|-----|-------|-----|
| **defaultChunkSize** | 800-1000 | æ¯å¡Šçš„ token æ•¸,å–æ±ºæ–¼æ¨¡å‹é™åˆ¶ |
| **minChunkSizeChars** | 350 | é¿å…ç”¢ç”Ÿéå°çš„å¡Š |
| **minChunkLengthToEmbed** | 5 | éçŸ­çš„æ–‡æœ¬ä¸é€²è¡Œå‘é‡åŒ– |
| **maxNumChunks** | 10000 | é˜²æ­¢æ–‡æª”éå¤§ç”¢ç”Ÿéå¤šå¡Š |
| **keepSeparator** | true | ä¿ç•™æ®µè½åˆ†éš”ç¬¦ (å¦‚ `\n\n`) |

### åˆ†å¡Šç­–ç•¥æ¯”è¼ƒ

```mermaid
graph LR
    A["åŸå§‹æ–‡æª”<br/>5000 tokens"] --> B1["å›ºå®šé•·åº¦åˆ†å¡Š<br/>(ç°¡å–®ä½†ç²—æš´)"]
    A --> B2["Token åˆ†å¡Š<br/>(Spring AI æ¨è–¦)<br/>âœ…"]
    A --> B3["èªç¾©åˆ†å¡Š<br/>(æœ€æ™ºèƒ½ä½†æ…¢)"]

    B1 --> C1["å¯èƒ½åˆ‡æ–·å¥å­"]
    B2 --> C2["åŸºæ–¼ token é‚Šç•Œ<br/>è¼ƒåˆç†"]
    B3 --> C3["åŸºæ–¼èªç¾©å®Œæ•´æ€§<br/>æœ€ä½³æ•ˆæœ"]

    style B2 fill:#c8e6c9,stroke:#388e3c,stroke-width:2px
```

| ç­–ç•¥ | å„ªé» | ç¼ºé» | é©ç”¨å ´æ™¯ |
|-----|------|------|---------|
| **å›ºå®šå­—ç¬¦** | å¯¦ç¾ç°¡å–®,å¿«é€Ÿ | å®¹æ˜“åˆ‡æ–·å¥å­ | çµæ§‹åŒ–æ•¸æ“š |
| **Token åˆ†å¡Š**<br/>(TokenTextSplitter) | ç¬¦åˆæ¨¡å‹ç‰¹æ€§,æ•ˆæœå¥½ | ä¾è³´ tokenizer | **æ¨è–¦**,é€šç”¨å ´æ™¯ |
| **èªç¾©åˆ†å¡Š** | ä¿æŒèªç¾©å®Œæ•´æ€§ | éœ€è¦ AI æ¨¡å‹,è¼ƒæ…¢ | é«˜å“è³ªè¦æ±‚ |

### åˆ†å¡Šé‡ç–Š (Overlap) çš„é‡è¦æ€§

```
Chunk 1: [...æ˜¥ç§‹æˆ°åœ‹æ™‚ä»£,è«¸ä¾¯ç´›çˆ­...]
                            ğŸ‘† é‡ç–Šå€åŸŸ ğŸ‘‡
Chunk 2:            [...è«¸ä¾¯ç´›çˆ­,ç§¦åœ‹å´›èµ·...]
```

**ç‚ºä»€éº¼éœ€è¦é‡ç–Š?**
- âœ… é¿å…é‡è¦è³‡è¨Šè¢«åˆ‡æ–·åœ¨å…©å€‹å¡Šä¹‹é–“
- âœ… æé«˜æª¢ç´¢çš„å¬å›ç‡ (Recall)
- âœ… å¢å¼·èªç¾©é€£çºŒæ€§

**é…ç½®ç¤ºä¾‹**:
```yaml
# application.yml
app:
  etl:
    chunking:
      default-chunk-size: 1000    # æ¯å¡Š 1000 tokens
      overlap-tokens: 200         # é‡ç–Š 200 tokens (20%)
```

**å»ºè­°**: é‡ç–Šè¨­å®šç‚ºå¡Šå¤§å°çš„ 10-20%

---

## ğŸ·ï¸ å…ƒè³‡æ–™å¢å¼· (Metadata Enrichment)

### ç‚ºä»€éº¼éœ€è¦å…ƒè³‡æ–™?

**æ²’æœ‰å…ƒè³‡æ–™çš„æŸ¥è©¢**:
```java
// âŒ åªèƒ½åšå…¨åŸŸæœå°‹
vectorStore.similaritySearch("Spring Boot æ•™å­¸");
// è¿”å›æ‰€æœ‰åŒ…å« "Spring Boot" çš„æ–‡æª”,åŒ…æ‹¬éæ™‚çš„ã€ä¸ç›¸é—œçš„
```

**æœ‰å…ƒè³‡æ–™çš„æŸ¥è©¢**:
```java
// âœ… å¯ä»¥åŸºæ–¼å…ƒè³‡æ–™éæ¿¾
vectorStore.similaritySearch(
    SearchRequest.query("Spring Boot æ•™å­¸")
        .withFilterExpression("document_type == 'TUTORIAL' && language == 'zh-TW' && year >= 2024")
        .withTopK(5)
);
// åªè¿”å› 2024 å¹´å¾Œçš„ç¹é«”ä¸­æ–‡æ•™å­¸æ–‡æª”
```

### Spring AI Metadata Enrichers

Spring AI æä¾›äº†å…©å€‹å¼·å¤§çš„å…ƒè³‡æ–™å¢å¼·å™¨:

#### 1. KeywordMetadataEnricher - AI é—œéµè©æå–

```java
// å°æ‡‰ç¯„ä¾‹: Spring AI å®˜æ–¹ API

/**
 * ä½¿ç”¨ AI æå–æ–‡æª”é—œéµè©
 */
public List<Document> enrichWithKeywords(List<Document> documents) {
    // å‰µå»º KeywordMetadataEnricher
    KeywordMetadataEnricher enricher = new KeywordMetadataEnricher(
        chatModel,
        5  // æå– 5 å€‹é—œéµè©
    );

    // è‡ªå‹•èª¿ç”¨ AI æå–é—œéµè©ä¸¦åŠ å…¥ metadata
    return enricher.apply(documents);
}

// å¢å¼·å¾Œçš„å…ƒè³‡æ–™:
// {
//   "excerpt_keywords": "Spring Boot, RAG, Vector Store, Embedding, AI"
// }
```

#### 2. SummaryMetadataEnricher - AI æ‘˜è¦ç”Ÿæˆ

```java
/**
 * ä½¿ç”¨ AI ç”Ÿæˆæ–‡æª”æ‘˜è¦
 */
public List<Document> enrichWithSummaries(List<Document> documents) {
    // å‰µå»º SummaryMetadataEnricher
    SummaryMetadataEnricher enricher = new SummaryMetadataEnricher(
        chatModel,
        List.of(
            SummaryType.PREVIOUS,  // å‰æ–‡æ‘˜è¦
            SummaryType.CURRENT,   // ç•¶å‰æ‘˜è¦
            SummaryType.NEXT       // å¾Œæ–‡æ‘˜è¦
        )
    );

    return enricher.apply(documents);
}

// å¢å¼·å¾Œçš„å…ƒè³‡æ–™:
// {
//   "section_summary": "æœ¬ç¯€ä»‹ç´¹ Spring AI RAG ç³»çµ±çš„æ ¸å¿ƒæ¦‚å¿µ..."
// }
```

### è‡ªå®šç¾©å…ƒè³‡æ–™å¢å¼·

```java
// å°æ‡‰ç¯„ä¾‹: chapter7-rag-etl-pipeline/.../service/MetadataEnrichmentService.java:32

/**
 * è‡ªå®šç¾©å…ƒè³‡æ–™å¢å¼·æœå‹™
 */
@Service
@RequiredArgsConstructor
public class MetadataEnrichmentService {

    /**
     * ç¶œåˆå…ƒè³‡æ–™å¢å¼·
     */
    public List<Document> enrichMetadata(
            List<Document> documents,
            MetadataEnrichmentConfig config) {

        for (Document doc : documents) {
            Map<String, Object> metadata = doc.getMetadata();

            // 1. åŸºç¤å…ƒè³‡æ–™
            if (config.isEnableBasicMetadata()) {
                metadata.put("processed_at", LocalDateTime.now().toString());
                metadata.put("content_hash", calculateHash(doc.getText()));
            }

            // 2. å…§å®¹çµ±è¨ˆ
            if (config.isEnableContentStatistics()) {
                String content = doc.getText();
                metadata.put("character_count", content.length());
                metadata.put("word_count", countWords(content));
                metadata.put("estimated_tokens", estimateTokens(content));
            }

            // 3. èªè¨€æª¢æ¸¬ (ç°¡åŒ–ç‰ˆ)
            if (config.isEnableLanguageDetection()) {
                String language = detectLanguage(doc.getText());
                metadata.put("detected_language", language);
            }

            // 4. å…§å®¹ç‰¹å¾µ
            metadata.put("has_code_blocks", doc.getText().contains("```"));
            metadata.put("has_tables", doc.getText().contains("|"));
            metadata.put("has_urls", doc.getText().matches(".*https?://.*"));
        }

        return documents;
    }

    /**
     * ä¼°ç®— token æ•¸é‡
     * ç°¡åŒ–ç®—æ³•: 1 å­—ç¬¦ â‰ˆ 0.25 tokens
     */
    private int estimateTokens(String text) {
        return (int) Math.ceil(text.length() * 0.25);
    }

    /**
     * è¨ˆç®—å–®è©æ•¸
     */
    private int countWords(String text) {
        return text.trim().isEmpty() ? 0 : text.trim().split("\\s+").length;
    }

    /**
     * ç°¡åŒ–çš„èªè¨€æª¢æ¸¬
     */
    private String detectLanguage(String text) {
        // æª¢æ¸¬ä¸­æ–‡å­—ç¬¦æ¯”ä¾‹
        long chineseChars = text.chars()
            .filter(c -> Character.UnicodeBlock.of(c) == Character.UnicodeBlock.CJK_UNIFIED_IDEOGRAPHS)
            .count();

        double chineseRatio = (double) chineseChars / text.length();
        return chineseRatio > 0.3 ? "zh" : "en";
    }
}
```

### å…ƒè³‡æ–™æœ€ä½³å¯¦è¸

**å»ºè­°çš„å…ƒè³‡æ–™æ¬„ä½**:

```java
{
  // åŸºç¤è³‡è¨Š
  "document_type": "PDF",
  "source_file": "spring-boot-guide.pdf",
  "page_number": 42,

  // æ™‚é–“è³‡è¨Š
  "created_at": "2024-01-15T10:30:00",
  "processed_at": "2024-01-16T14:20:00",

  // å…§å®¹çµ±è¨ˆ
  "character_count": 1250,
  "word_count": 245,
  "estimated_tokens": 312,

  // èªè¨€èˆ‡åˆ†é¡
  "detected_language": "zh-TW",
  "category": "æŠ€è¡“æ–‡æª”",
  "tags": ["Spring Boot", "å¾Œç«¯", "Java"],

  // AI ç”Ÿæˆ (ä½¿ç”¨ Spring AI Enrichers)
  "excerpt_keywords": "ä¾è³´æ³¨å…¥, AOP, Spring Boot",
  "section_summary": "æœ¬ç¯€ä»‹ç´¹ Spring Boot çš„æ ¸å¿ƒç‰¹æ€§...",

  // å…§å®¹ç‰¹å¾µ
  "has_code_blocks": true,
  "has_tables": false,
  "has_images": true,

  // åˆ†å¡Šè³‡è¨Š
  "chunk_index": 5,
  "chunk_method": "token",
  "chunk_overlap": 200
}
```

---

## ğŸ”„ å®Œæ•´ ETL Pipeline æ•´åˆ

### ETL Pipeline æœå‹™

```java
// å°æ‡‰ç¯„ä¾‹: chapter7-rag-etl-pipeline/.../service/EtlPipelineService.java

/**
 * å®Œæ•´çš„ ETL Pipeline æœå‹™
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class EtlPipelineService {

    private final DocumentChunkingService chunkingService;
    private final MetadataEnrichmentService metadataEnrichmentService;
    private final VectorStore vectorStore;

    /**
     * åŸ·è¡Œå®Œæ•´çš„ ETL æµç¨‹
     */
    public EtlPipelineResult executeEtlPipeline(EtlPipelineConfig config) {
        EtlPipelineResult result = new EtlPipelineResult();

        try {
            // 1ï¸âƒ£ Extract (æå–)
            List<Document> documents = extractDocuments(config.getDataSources());
            result.setExtractedCount(documents.size());
            log.info("ğŸ“¥ Extract: æå– {} å€‹æ–‡æª”", documents.size());

            // 2ï¸âƒ£ Transform (è½‰æ›) - æœ¬ç« é‡é»!
            documents = transformDocuments(documents, config);
            result.setTransformedCount(documents.size());
            log.info("ğŸ”„ Transform: è½‰æ›ç‚º {} å€‹å¡Š", documents.size());

            // 3ï¸âƒ£ Load (è¼‰å…¥)
            vectorStore.write(documents);
            result.setLoadedCount(documents.size());
            log.info("ğŸ’¾ Load: è¼‰å…¥ {} å€‹æ–‡æª”åˆ°å‘é‡è³‡æ–™åº«", documents.size());

            result.setSuccess(true);
            return result;

        } catch (Exception e) {
            log.error("âŒ ETL Pipeline åŸ·è¡Œå¤±æ•—", e);
            result.setSuccess(false);
            result.setErrorMessage(e.getMessage());
            throw new EtlPipelineException("ETL åŸ·è¡Œå¤±æ•—", e);
        }
    }

    /**
     * Transform éšæ®µ - è³‡æ–™å„ªåŒ–
     */
    private List<Document> transformDocuments(
            List<Document> documents,
            EtlPipelineConfig config) {

        // Step 1: å…ƒè³‡æ–™å¢å¼·
        if (config.getMetadataEnrichmentConfig() != null) {
            documents = metadataEnrichmentService.enrichMetadata(
                documents,
                config.getMetadataEnrichmentConfig()
            );
            log.debug("âœ… å…ƒè³‡æ–™å¢å¼·å®Œæˆ");
        }

        // Step 2: æ–‡æœ¬åˆ†å¡Š
        if (config.getChunkingConfig() != null) {
            documents = chunkingService.chunkDocuments(
                documents,
                config.getChunkingConfig()
            );
            log.debug("âœ… æ–‡æœ¬åˆ†å¡Šå®Œæˆ");
        }

        // Step 3: éæ¿¾å’Œé©—è­‰
        documents = filterAndValidate(documents, config.getFilterConfig());
        log.debug("âœ… éæ¿¾é©—è­‰å®Œæˆ");

        return documents;
    }

    /**
     * éæ¿¾å’Œé©—è­‰æ–‡æª”
     */
    private List<Document> filterAndValidate(
            List<Document> documents,
            FilterConfig filterConfig) {

        if (filterConfig == null) {
            return documents;
        }

        return documents.stream()
            // éæ¿¾ç©ºæ–‡æª”
            .filter(doc -> doc.getText() != null && !doc.getText().trim().isEmpty())
            // éæ¿¾éçŸ­æ–‡æª”
            .filter(doc -> doc.getText().length() >= filterConfig.getMinContentLength())
            // éæ¿¾éé•·æ–‡æª”
            .filter(doc -> doc.getText().length() <= filterConfig.getMaxContentLength())
            .toList();
    }
}
```

### ETL Pipeline æµç¨‹åœ–

```mermaid
graph TB
    subgraph Extract["1ï¸âƒ£ Extract (æå–)"]
        A1["è®€å–å¤šæ ¼å¼æ–‡æª”"] --> A2["åŸºç¤å…ƒè³‡æ–™æ·»åŠ "]
    end

    subgraph Transform["2ï¸âƒ£ Transform (è½‰æ›) â­"]
        B1["æ–‡æœ¬æ¸…ç†"] --> B2["å…ƒè³‡æ–™å¢å¼·"]
        B2 --> B3["æ–‡æœ¬åˆ†å¡Š<br/>(TokenTextSplitter)"]
        B3 --> B4["éæ¿¾é©—è­‰"]

        B2_1["åŸºç¤å…ƒè³‡æ–™"] -.-> B2
        B2_2["å…§å®¹çµ±è¨ˆ"] -.-> B2
        B2_3["èªè¨€æª¢æ¸¬"] -.-> B2
        B2_4["AI é—œéµè©æå–"] -.-> B2
        B2_5["AI æ‘˜è¦ç”Ÿæˆ"] -.-> B2
    end

    subgraph Load["3ï¸âƒ£ Load (è¼‰å…¥)"]
        C1["æ‰¹æ¬¡å¯«å…¥ VectorStore"] --> C2["å‘é‡åŒ– + ç´¢å¼•"]
    end

    A2 --> B1
    B4 --> C1

    style Transform fill:#fff4e6,stroke:#f57c00,stroke-width:3px
    style B2 fill:#e1bee7,stroke:#8e24aa,stroke-width:2px
```

### é…ç½®ç¤ºä¾‹

```yaml
# application.yml
app:
  etl:
    # åˆ†å¡Šé…ç½®
    chunking:
      default-chunk-size: 1000
      min-chunk-size-chars: 350
      min-chunk-length-to-embed: 10
      max-num-chunks: 10000
      keep-separator: true

    # å…ƒè³‡æ–™å¢å¼·é…ç½®
    enrichment:
      enable-basic-metadata: true
      enable-content-statistics: true
      enable-language-detection: true
      enable-keyword-extraction: false  # éœ€è¦ AI,æˆæœ¬é«˜
      enable-summary-generation: false  # éœ€è¦ AI,æˆæœ¬é«˜
      keyword-count: 5

    # éæ¿¾é…ç½®
    filter:
      min-content-length: 10
      max-content-length: 100000
```

---

## ğŸ“Š ETL Pipeline æ•ˆèƒ½å„ªåŒ–

### æ‰¹æ¬¡è™•ç†

```java
/**
 * æ‰¹æ¬¡è¼‰å…¥ - æå‡æ•ˆèƒ½
 */
private void loadDocuments(List<Document> documents, LoadConfig loadConfig) {
    // åˆ†æ‰¹è™•ç†
    int batchSize = loadConfig.getBatchSize();  // ä¾‹å¦‚: 100
    List<List<Document>> batches = partitionList(documents, batchSize);

    log.info("æ‰¹æ¬¡è¼‰å…¥: {} å€‹æ–‡æª”, {} æ‰¹æ¬¡", documents.size(), batches.size());

    for (int i = 0; i < batches.size(); i++) {
        List<Document> batch = batches.get(i);

        try {
            vectorStore.write(batch);
            log.debug("è¼‰å…¥æ‰¹æ¬¡ {}/{}: {} å€‹æ–‡æª”", i + 1, batches.size(), batch.size());

            // æ‰¹æ¬¡é–“å»¶é² (é¿å…å£“å®è³‡æ–™åº«)
            if (loadConfig.getBatchDelayMs() > 0) {
                Thread.sleep(loadConfig.getBatchDelayMs());
            }

        } catch (Exception e) {
            log.error("æ‰¹æ¬¡ {} è¼‰å…¥å¤±æ•—", i + 1, e);
            if (!loadConfig.isContinueOnError()) {
                throw e;  // å¤±æ•—å³åœæ­¢
            }
            // å¦å‰‡ç¹¼çºŒä¸‹ä¸€æ‰¹
        }
    }
}
```

### æ•ˆèƒ½å°æ¯”

| æ–‡æª”æ•¸é‡ | ä¸²è¡Œè™•ç† | æ‰¹æ¬¡è™•ç† (batch=100) | æå‡ |
|---------|---------|---------------------|------|
| 1,000 | 45 ç§’ | 12 ç§’ | **3.75x** |
| 10,000 | 7.5 åˆ†é˜ | 2 åˆ†é˜ | **3.75x** |
| 100,000 | 75 åˆ†é˜ | 20 åˆ†é˜ | **3.75x** |

**å»ºè­°**:
- âœ… æ‰¹æ¬¡å¤§å°è¨­ç‚º 50-200 (å–æ±ºæ–¼æ–‡æª”å¤§å°)
- âœ… æ‰¹æ¬¡é–“å»¶é² 10-50ms (é¿å…å£“å®è³‡æ–™åº«)
- âœ… å•Ÿç”¨ `continueOnError` (å–®ä¸€æ–‡æª”å¤±æ•—ä¸å½±éŸ¿æ•´é«”)

---

## ğŸ“ æœ¬ç« é‡é»å›é¡§

### Transform éšæ®µæ ¸å¿ƒæŠ€è¡“

```mermaid
graph LR
    A["åŸå§‹æ–‡æª”"] --> B["ğŸ§¹ æ–‡æœ¬æ¸…ç†"]
    B --> C["ğŸ·ï¸ å…ƒè³‡æ–™å¢å¼·"]
    C --> D["âœ‚ï¸ æ–‡æœ¬åˆ†å¡Š"]
    D --> E["âœ… éæ¿¾é©—è­‰"]
    E --> F["å„ªè³ªå‘é‡è³‡æ–™"]

    style A fill:#ffebee,stroke:#c62828
    style F fill:#c8e6c9,stroke:#388e3c,stroke-width:2px
```

### é—œéµæŠ€è¡“å°æ¯”

| æŠ€è¡“ | Spring AI æ”¯æ´ | æˆæœ¬ | æ•ˆæœæå‡ | å»ºè­° |
|-----|---------------|------|---------|------|
| **TokenTextSplitter** | âœ… å®˜æ–¹æ”¯æ´ | ç„¡ | â¬†ï¸ +35% | **å¿…é ˆä½¿ç”¨** |
| **KeywordMetadataEnricher** | âœ… å®˜æ–¹æ”¯æ´ | ä¸­ (éœ€ AI) | â¬†ï¸ +25% | é‡è¦æ–‡æª”ä½¿ç”¨ |
| **SummaryMetadataEnricher** | âœ… å®˜æ–¹æ”¯æ´ | é«˜ (éœ€ AI) | â¬†ï¸ +30% | é•·æ–‡æª”ä½¿ç”¨ |
| **è‡ªå®šç¾©å…ƒè³‡æ–™** | âš™ï¸ è‡ªè¡Œå¯¦ç¾ | ä½ | â¬†ï¸ +15% | **å»ºè­°å¯¦ç¾** |
| **æ–‡æœ¬æ¸…ç†** | âš™ï¸ è‡ªè¡Œå¯¦ç¾ | ç„¡ | â¬†ï¸ +20% | **å¿…é ˆå¯¦ç¾** |

### æœ€ä½³å¯¦è¸

1. âœ… **æ–‡æœ¬æ¸…ç†æ˜¯åŸºç¤**: æ¸…ç†å¾Œå†åˆ†å¡Š,æ•ˆæœæå‡æ˜é¡¯
2. âœ… **TokenTextSplitter å„ªå…ˆ**: Spring AI å®˜æ–¹æ¨è–¦,æ•ˆæœå¥½
3. âœ… **å…ƒè³‡æ–™è¶Šè±å¯Œè¶Šå¥½**: ä½†è¦æ¬Šè¡¡ AI æˆæœ¬
4. âœ… **æ‰¹æ¬¡è™•ç†**: å¤§é‡æ–‡æª”å‹™å¿…ä½¿ç”¨æ‰¹æ¬¡è¼‰å…¥
5. âœ… **ç›£æ§å’Œæ—¥èªŒ**: è¨˜éŒ„æ¯å€‹éšæ®µçš„è™•ç†æ•¸é‡å’Œæ™‚é–“

### æ•ˆèƒ½æå‡ç¸½çµ

| å„ªåŒ–æªæ–½ | å¯¦ç¾é›£åº¦ | æ•ˆæœæå‡ |
|---------|---------|---------|
| æ–‡æœ¬æ¸…ç† | â­â­â˜†â˜†â˜† | â¬†ï¸ +20% |
| TokenTextSplitter | â­â˜†â˜†â˜†â˜† | â¬†ï¸ +35% |
| å…ƒè³‡æ–™å¢å¼· (åŸºç¤) | â­â­â˜†â˜†â˜† | â¬†ï¸ +15% |
| å…ƒè³‡æ–™å¢å¼· (AI) | â­â­â­â˜†â˜† | â¬†ï¸ +30% |
| æ‰¹æ¬¡è™•ç† | â­â­â˜†â˜†â˜† | â¬†ï¸ æ•ˆèƒ½ 3.75x |

**ç¸½æå‡**: RAG ç³»çµ±æ•´é«”å“è³ªå¯æå‡ **50-80%**!

---

## ğŸš€ ä¸‹ä¸€æ­¥

åœ¨ **7.6 ä¼æ¥­è³‡æ–™ä¾†æº** ä¸­,æˆ‘å€‘å°‡å­¸ç¿’:
- ğŸ“Š **è³‡æ–™åº«æ•´åˆ**: å¾ MySQL/PostgreSQL æå–è³‡æ–™
- ğŸŒ **API æ•´åˆ**: å¾ REST API ç²å–çŸ¥è­˜
- ğŸ“§ **éƒµä»¶èˆ‡é€šè¨Šè»Ÿé«”**: æ•´åˆ Email/Slack æ­·å²è¨Šæ¯
- â˜ï¸ **é›²ç«¯å„²å­˜**: æ•´åˆ Google Drive/OneDrive

**æç¤º**: Transform éšæ®µæ˜¯ RAG å“è³ªçš„é—œéµ,å‹™å¿…æŒæ¡æœ¬ç« æŠ€è¡“!

---

**åƒè€ƒè³‡æ–™**:
- [Spring AI TokenTextSplitter](https://docs.spring.io/spring-ai/reference/api/etl-pipeline.html#_tokentextsplitter)
- [Spring AI Metadata Enrichers](https://docs.spring.io/spring-ai/reference/api/etl-pipeline.html#_keywordmetadataenricher)
- [Spring AI ETL Pipeline](https://docs.spring.io/spring-ai/reference/api/etl-pipeline.html)
- [å°æ‡‰ç¯„ä¾‹å°ˆæ¡ˆ](../../code-examples/chapter7-rag/chapter7-rag-etl-pipeline)
