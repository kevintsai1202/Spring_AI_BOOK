# 7.2 å…§å®¹å‘é‡åŒ–

> **å°æ‡‰ç« ç¯€**: Day19
> **å°æ‡‰ç¯„ä¾‹**: `chapter7-rag-basic`
> **é›£åº¦**: â­â­â­â˜†â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

å‘é‡åŒ– (Embedding) æ˜¯ RAG çš„æ ¸å¿ƒæŠ€è¡“ã€‚å®ƒå°‡æ–‡å­—è½‰æ›æˆæ•¸å­—å‘é‡,è®“é›»è…¦èƒ½ã€Œç†è§£ã€æ–‡å­—çš„èªç¾©,ä¸¦è¨ˆç®—ç›¸ä¼¼åº¦ã€‚

**å­¸ç¿’ç›®æ¨™**:
- ç†è§£å‘é‡åŒ–çš„åŸç†å’Œæ„ç¾©
- æŒæ¡ Spring AI çš„ Embedding æ¨¡å‹
- å­¸æœƒé¸æ“‡åˆé©çš„å‘é‡æ¨¡å‹
- äº†è§£å‘é‡å“è³ªè©•ä¼°æ–¹æ³•

---

## ğŸ¯ ä»€éº¼æ˜¯å‘é‡åŒ–?

### å¾æ–‡å­—åˆ°æ•¸å­—

```
å‚³çµ±æ–¹å¼:
"Spring AI" â†’ å­—ä¸²æ¯”å° â†’ åªèƒ½æ‰¾åˆ°å®Œå…¨ç›¸åŒçš„æ–‡å­—

å‘é‡åŒ–:
"Spring AI"     â†’ [0.2, -0.1, 0.8, ..., 0.5] (1536ç¶­)
"Springæ¡†æ¶"    â†’ [0.18, -0.08, 0.82, ..., 0.52] (1536ç¶­)
"Javaæ¡†æ¶"      â†’ [0.15, -0.05, 0.75, ..., 0.48] (1536ç¶­)

â†’ è¨ˆç®—ç›¸ä¼¼åº¦ â†’ æ‰¾å‡ºèªç¾©ç›¸è¿‘çš„æ–‡å­—!
```

### å‘é‡åŒ–çš„å¨åŠ›

**ç¯„ä¾‹: èªç¾©ç›¸ä¼¼æ€§**

```java
// é€™ä¸‰å¥è©±æ„æ€ç›¸åŒ,ä½†æ–‡å­—å®Œå…¨ä¸åŒ
String text1 = "Spring AI å¾ˆå¥½ç”¨";
String text2 = "Spring AI éå¸¸å¯¦ç”¨";
String text3 = "Spring AI is very useful";

// å‘é‡åŒ–å¾Œ,ç›¸ä¼¼åº¦éƒ½å¾ˆé«˜!
similarity(text1, text2) = 0.92  // 92% ç›¸ä¼¼
similarity(text1, text3) = 0.89  // è·¨èªè¨€ä¹Ÿèƒ½è­˜åˆ¥!
```

**æ•¸å­¸åŸç†**:
- **é¤˜å¼¦ç›¸ä¼¼åº¦ (Cosine Similarity)**: å¸¸ç”¨æ–¹æ³•

```
ç›¸ä¼¼åº¦ = cos(Î¸) = (A Â· B) / (||A|| Ã— ||B||)

ç¯„åœ: -1 åˆ° 1
- 1.0  = å®Œå…¨ç›¸åŒ
- 0.8+ = éå¸¸ç›¸ä¼¼
- 0.0  = ç„¡é—œ
```

---

## ğŸ”§ Spring AI Embedding æ¨¡å‹

### OpenAI Embeddings (æ¨è–¦)

Spring AI é è¨­ä½¿ç”¨ OpenAI çš„ Embedding æ¨¡å‹:

```yaml
# application.yml
spring:
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      embedding:
        model: text-embedding-3-small  # æ¨è–¦æ¨¡å‹
        # model: text-embedding-3-large  # é«˜ç²¾åº¦ç‰ˆæœ¬
```

**æ¨¡å‹æ¯”è¼ƒ**:

| æ¨¡å‹ | å‘é‡ç¶­åº¦ | æˆæœ¬ | é©ç”¨å ´æ™¯ |
|------|---------|------|---------|
| **text-embedding-3-small** | 1536 | $0.02/1M tokens | â­ é€šç”¨æ¨è–¦ |
| **text-embedding-3-large** | 3072 | $0.13/1M tokens | é«˜ç²¾åº¦éœ€æ±‚ |
| text-embedding-ada-002 | 1536 | $0.10/1M tokens | èˆŠç‰ˆ(ç©©å®š) |

**é¸æ“‡å»ºè­°**:
- ğŸ’° **é ç®—æœ‰é™**: text-embedding-3-small (æ€§åƒ¹æ¯”æœ€é«˜)
- ğŸ¯ **è¿½æ±‚ç²¾åº¦**: text-embedding-3-large (æº–ç¢ºåº¦æœ€é«˜)
- ğŸš€ **å¿«é€Ÿå•Ÿå‹•**: text-embedding-3-small (æ–°å°ˆæ¡ˆé¦–é¸)

### æœ¬åœ°æ¨¡å‹ (Ollama)

å¦‚æœä¸æƒ³ä¾è³´ OpenAI,å¯ä»¥ä½¿ç”¨æœ¬åœ°æ¨¡å‹:

```yaml
spring:
  ai:
    ollama:
      base-url: http://localhost:11434
      embedding:
        model: nomic-embed-text  # æœ¬åœ° Embedding æ¨¡å‹
```

**Ollama æ¨¡å‹**:
- `nomic-embed-text`: 768 ç¶­,é©åˆè‹±æ–‡
- `mxbai-embed-large`: 1024 ç¶­,å¤šèªè¨€æ”¯æ´

**å„ªç¼ºé»**:
- âœ… å…è²»ã€éš±ç§ã€é›¢ç·šå¯ç”¨
- âŒ ç²¾åº¦è¼ƒ OpenAI ç¨ä½
- âŒ éœ€è¦æœ¬åœ°é‹ç®—è³‡æº

---

## ğŸ’» Spring AI å‘é‡åŒ–å¯¦ç¾

### è‡ªå‹•å‘é‡åŒ– (æ¨è–¦)

**æœ€ç°¡å–®çš„æ–¹å¼**: Spring AI æœƒè‡ªå‹•è™•ç†!

```java
// å°æ‡‰ç¯„ä¾‹: chapter7-rag-basic/.../service/RAGService.java:161

@Service
public class RAGService {

    private final VectorStore vectorStore;

    public void addDocuments(List<Resource> resources) {
        List<Document> documents = new ArrayList<>();

        for (Resource resource : resources) {
            // 1. è®€å–æ–‡æª”
            TextReader reader = new TextReader(resource);
            List<Document> docs = reader.read();

            // 2. æ–‡æœ¬åˆ†å¡Š
            TokenTextSplitter splitter = new TokenTextSplitter(800, 200);
            List<Document> chunks = splitter.apply(docs);

            documents.addAll(chunks);
        }

        // 3. VectorStore æœƒè‡ªå‹•å‘é‡åŒ–!
        vectorStore.add(documents);  // â† Spring AI è‡ªå‹•èª¿ç”¨ Embedding API

        log.info("Added {} documents (auto-embedded)", documents.size());
    }
}
```

**å…§éƒ¨æµç¨‹**:
```mermaid
graph LR
    A["ğŸ“„ Document"] --> B["VectorStore.add()"]
    B --> C["ğŸ”¢ è‡ªå‹•èª¿ç”¨ EmbeddingModel"]
    C --> D["ğŸ’¾ å­˜å„²æ–‡æœ¬ + å‘é‡"]

    style C fill:#fff4e6,stroke:#f57c00
    style D fill:#c8e6c9,stroke:#388e3c
```

### æ‰‹å‹•å‘é‡åŒ– (é€²éš)

å¦‚æœéœ€è¦æ›´å¤šæ§åˆ¶,å¯ä»¥æ‰‹å‹•å‘é‡åŒ–:

```java
@Service
public class ManualEmbeddingService {

    private final EmbeddingModel embeddingModel;

    /**
     * å–®ä¸€æ–‡æœ¬å‘é‡åŒ–
     */
    public float[] embedText(String text) {
        // èª¿ç”¨ Embedding Model
        EmbeddingResponse response = embeddingModel.embedForResponse(List.of(text));

        // æå–å‘é‡
        return response.getResults().get(0)
            .getOutput()
            .stream()
            .mapToDouble(Double::doubleValue)
            .toArray();
    }

    /**
     * æ‰¹æ¬¡å‘é‡åŒ– (æ•ˆç‡æ›´é«˜)
     */
    public List<float[]> embedTexts(List<String> texts) {
        EmbeddingResponse response = embeddingModel.embedForResponse(texts);

        return response.getResults().stream()
            .map(result -> result.getOutput())
            .map(list -> list.stream()
                .mapToDouble(Double::doubleValue)
                .toArray())
            .collect(Collectors.toList());
    }
}
```

---

## ğŸ“Š å‘é‡å“è³ªè©•ä¼°

### å¦‚ä½•è©•ä¼°å‘é‡å¥½å£?

**æ¸¬è©¦æ–¹æ³•: èªç¾©ç›¸ä¼¼æ€§æ¸¬è©¦**

```java
@Test
public void testEmbeddingQuality() {
    // æº–å‚™æ¸¬è©¦æ–‡æœ¬
    String text1 = "Spring AI æ˜¯ Java é–‹ç™¼æ¡†æ¶";
    String text2 = "Spring AI is a Java framework";
    String text3 = "Python æ˜¯ç¨‹å¼èªè¨€";

    // å‘é‡åŒ–
    float[] vec1 = embeddingService.embedText(text1);
    float[] vec2 = embeddingService.embedText(text2);
    float[] vec3 = embeddingService.embedText(text3);

    // è¨ˆç®—ç›¸ä¼¼åº¦
    double sim12 = cosineSimilarity(vec1, vec2);
    double sim13 = cosineSimilarity(vec1, vec3);

    // é©—è­‰çµæœ
    assertTrue(sim12 > 0.8);  // ç›¸åŒæ„æ€,æ‡‰è©²å¾ˆç›¸ä¼¼
    assertTrue(sim13 < 0.5);  // ä¸åŒä¸»é¡Œ,æ‡‰è©²ä¸ç›¸ä¼¼
}
```

### å‘é‡å“è³ªæª¢æŸ¥

```java
public class VectorQualityChecker {

    /**
     * æª¢æŸ¥å‘é‡æ˜¯å¦æ­£å¸¸
     */
    public boolean isVectorValid(float[] vector) {
        // 1. æª¢æŸ¥ç¶­åº¦
        if (vector.length != 1536) {
            log.warn("Wrong dimension: {}", vector.length);
            return false;
        }

        // 2. æª¢æŸ¥æ˜¯å¦ç‚ºé›¶å‘é‡
        boolean allZeros = Arrays.stream(vector)
            .allMatch(v -> Math.abs(v) < 1e-6);
        if (allZeros) {
            log.warn("Zero vector detected");
            return false;
        }

        // 3. æª¢æŸ¥æ•¸å€¼ç¯„åœ
        double max = Arrays.stream(vector).max().orElse(0);
        double min = Arrays.stream(vector).min().orElse(0);
        if (max > 10.0 || min < -10.0) {
            log.warn("Abnormal values: [{}, {}]", min, max);
            return false;
        }

        return true;
    }
}
```

---

## ğŸ” ç›¸ä¼¼åº¦è¨ˆç®—æ–¹æ³•

### é¤˜å¼¦ç›¸ä¼¼åº¦ (æœ€å¸¸ç”¨)

```java
/**
 * è¨ˆç®—å…©å€‹å‘é‡çš„é¤˜å¼¦ç›¸ä¼¼åº¦
 */
public double cosineSimilarity(float[] vec1, float[] vec2) {
    if (vec1.length != vec2.length) {
        throw new IllegalArgumentException("Vector dimensions must match");
    }

    double dotProduct = 0.0;
    double norm1 = 0.0;
    double norm2 = 0.0;

    for (int i = 0; i < vec1.length; i++) {
        dotProduct += vec1[i] * vec2[i];
        norm1 += vec1[i] * vec1[i];
        norm2 += vec2[i] * vec2[i];
    }

    return dotProduct / (Math.sqrt(norm1) * Math.sqrt(norm2));
}
```

**ç›¸ä¼¼åº¦è§£è®€**:

| ç›¸ä¼¼åº¦ç¯„åœ | æ„ç¾© | æ‡‰ç”¨å ´æ™¯ |
|-----------|------|---------|
| **0.9 - 1.0** | å¹¾ä¹ç›¸åŒ | å»é‡ã€ç²¾ç¢ºåŒ¹é… |
| **0.7 - 0.9** | é«˜åº¦ç›¸é—œ | â­ RAG æª¢ç´¢æ¨è–¦é–¾å€¼ |
| **0.5 - 0.7** | æœ‰ä¸€å®šé—œè¯ | ç›¸é—œæ¨è–¦ |
| **< 0.5** | é—œè¯æ€§å¼± | ä¸å»ºè­°ä½¿ç”¨ |

### æ­å¹¾é‡Œå¾—è·é›¢

```java
/**
 * æ­å¹¾é‡Œå¾—è·é›¢ (è¶Šå°è¶Šç›¸ä¼¼)
 */
public double euclideanDistance(float[] vec1, float[] vec2) {
    double sum = 0.0;
    for (int i = 0; i < vec1.length; i++) {
        sum += Math.pow(vec1[i] - vec2[i], 2);
    }
    return Math.sqrt(sum);
}
```

**é¤˜å¼¦ vs æ­æ°è·é›¢**:
- **é¤˜å¼¦ç›¸ä¼¼åº¦**: é—œæ³¨æ–¹å‘,ä¸é—œæ³¨é•·åº¦ â†’ RAG é¦–é¸
- **æ­æ°è·é›¢**: é—œæ³¨å¯¦éš›è·é›¢ â†’ åœ–åƒã€è²éŸ³è™•ç†å¸¸ç”¨

---

## ğŸ’° å‘é‡åŒ–æˆæœ¬å„ªåŒ–

### æ‰¹æ¬¡è™•ç†

**âŒ ä½æ•ˆåšæ³•**: é€ä¸€å‘é‡åŒ–
```java
// æ¯æ¬¡èª¿ç”¨ API = æ¯æ¬¡è¨ˆè²»
for (Document doc : documents) {
    float[] vector = embeddingModel.embed(doc.getContent());
    // 1000 å€‹æ–‡æª” = 1000 æ¬¡ API èª¿ç”¨!
}
```

**âœ… é«˜æ•ˆåšæ³•**: æ‰¹æ¬¡å‘é‡åŒ–
```java
// ä¸€æ¬¡èª¿ç”¨è™•ç† 100 å€‹
List<String> texts = documents.stream()
    .map(Document::getContent)
    .collect(Collectors.toList());

// æ‰¹æ¬¡è™•ç†,æ¸›å°‘ API èª¿ç”¨æ¬¡æ•¸
List<List<String>> batches = partition(texts, 100);
for (List<String> batch : batches) {
    embeddingModel.embedForResponse(batch);
}
// 1000 å€‹æ–‡æª” = 10 æ¬¡ API èª¿ç”¨ â†’ çœ 90% æ™‚é–“å’Œæˆæœ¬!
```

### å¿«å–ç­–ç•¥

**é¿å…é‡è¤‡å‘é‡åŒ–**:

```java
@Service
public class CachedEmbeddingService {

    private final Map<String, float[]> cache = new ConcurrentHashMap<>();
    private final EmbeddingModel embeddingModel;

    public float[] embedText(String text) {
        // ä½¿ç”¨æ–‡æœ¬ hash ä½œç‚º key
        String cacheKey = DigestUtils.md5Hex(text);

        // æª¢æŸ¥å¿«å–
        if (cache.containsKey(cacheKey)) {
            log.debug("Cache hit for: {}", text.substring(0, 30));
            return cache.get(cacheKey);
        }

        // å¿«å–æœªå‘½ä¸­,èª¿ç”¨ API
        float[] vector = embeddingModel.embed(text);
        cache.put(cacheKey, vector);

        return vector;
    }
}
```

**æˆæœ¬ç¯€çœ**:
```
å ´æ™¯: é‡è¤‡è™•ç†åŒä¸€ä»½æ–‡æª”
- ç„¡å¿«å–: æ¯æ¬¡éƒ½èª¿ç”¨ API â†’ $0.02/æ¬¡
- æœ‰å¿«å–: ç¬¬ä¸€æ¬¡èª¿ç”¨ API,ä¹‹å¾Œå…è²» â†’ çœ 99% æˆæœ¬!
```

---

## ğŸŒ å¤šèªè¨€æ”¯æ´

### OpenAI å¤šèªè¨€èƒ½åŠ›

OpenAI Embeddings **å¤©ç”Ÿæ”¯æ´å¤šèªè¨€**:

```java
@Test
public void testMultilingualEmbedding() {
    String zh = "Spring AI æ˜¯ä¸€å€‹å¼·å¤§çš„æ¡†æ¶";
    String en = "Spring AI is a powerful framework";
    String ja = "Spring AI ã¯å¼·åŠ›ãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™";

    float[] vecZh = embeddingModel.embed(zh);
    float[] vecEn = embeddingModel.embed(en);
    float[] vecJa = embeddingModel.embed(ja);

    // è·¨èªè¨€ç›¸ä¼¼åº¦æª¢æ¸¬
    double simZhEn = cosineSimilarity(vecZh, vecEn);
    double simZhJa = cosineSimilarity(vecZh, vecJa);

    assertTrue(simZhEn > 0.85);  // ä¸­è‹±ç›¸ä¼¼åº¦é«˜
    assertTrue(simZhJa > 0.85);  // ä¸­æ—¥ç›¸ä¼¼åº¦é«˜
}
```

**è·¨èªè¨€ RAG**:
```
çŸ¥è­˜åº«: è‹±æ–‡æ–‡æª”
ç”¨æˆ¶å•é¡Œ: ä¸­æ–‡

â†’ OpenAI Embedding è‡ªå‹•è™•ç†è·¨èªè¨€èªç¾©åŒ¹é…!
```

---

## ğŸ¯ å¯¦æˆ°æŠ€å·§

### 1. æ–‡æœ¬é è™•ç†

```java
/**
 * å‘é‡åŒ–å‰çš„æ–‡æœ¬æ¸…ç†
 */
public String preprocessText(String text) {
    return text
        .trim()
        .replaceAll("\\s+", " ")           // æ¨™æº–åŒ–ç©ºç™½
        .replaceAll("[\\r\\n]+", " ")      // ç§»é™¤æ›è¡Œ
        .substring(0, Math.min(text.length(), 8000));  // é™åˆ¶é•·åº¦
}
```

### 2. å‘é‡ç¶­åº¦é¸æ“‡

```yaml
# OpenAI æ”¯æ´è‡ªå®šç¾©ç¶­åº¦
spring:
  ai:
    openai:
      embedding:
        model: text-embedding-3-small
        options:
          dimensions: 512  # å¯é¸: 512, 1024, 1536
```

**ç¶­åº¦æ¬Šè¡¡**:
- **é«˜ç¶­åº¦ (1536)**: ç²¾åº¦é«˜,ä½†å„²å­˜ç©ºé–“å¤§
- **ä½ç¶­åº¦ (512)**: å„²å­˜çœç©ºé–“,ä½†ç²¾åº¦ç•¥é™

**å»ºè­°**: é™¤éå„²å­˜ç©ºé–“æ¥µåº¦å—é™,å¦å‰‡ä½¿ç”¨é è¨­ 1536 ç¶­

### 3. å‘é‡æ­¸ä¸€åŒ–

Neo4j VectorStore è‡ªå‹•è™•ç†æ­¸ä¸€åŒ–,ä½ ä¸éœ€è¦æ‰‹å‹•åš:

```java
// Spring AI + Neo4j æœƒè‡ªå‹•æ­¸ä¸€åŒ–å‘é‡
vectorStore.add(documents);  // â† å…§éƒ¨å·²è™•ç†
```

---

## ğŸ“ é‡é»å›é¡§

### æ ¸å¿ƒæ¦‚å¿µ
âœ… å‘é‡åŒ–å°‡æ–‡å­—è½‰ç‚ºæ•¸å­—,è®“é›»è…¦ç†è§£èªç¾©
âœ… é¤˜å¼¦ç›¸ä¼¼åº¦æ˜¯æœ€å¸¸ç”¨çš„ç›¸ä¼¼åº¦è¨ˆç®—æ–¹æ³•
âœ… OpenAI text-embedding-3-small æ˜¯æ€§åƒ¹æ¯”é¦–é¸

### Spring AI å¯¦ç¾
âœ… VectorStore è‡ªå‹•å‘é‡åŒ–,ç„¡éœ€æ‰‹å‹•èª¿ç”¨
âœ… æ”¯æ´æ‰¹æ¬¡è™•ç†,æé«˜æ•ˆç‡
âœ… å¤©ç”Ÿæ”¯æ´å¤šèªè¨€

### æœ€ä½³å¯¦è¸
âœ… ä½¿ç”¨æ‰¹æ¬¡è™•ç†ç¯€çœæˆæœ¬
âœ… å¯¦æ–½å¿«å–é¿å…é‡è¤‡è¨ˆç®—
âœ… RAG ç›¸ä¼¼åº¦é–¾å€¼å»ºè­° 0.7-0.8
âœ… é è¨­ç¶­åº¦ 1536 å·²è¶³å¤ ,ç„¡éœ€èª¿æ•´

---

## ğŸš€ ä¸‹ä¸€æ­¥

ğŸ‘‰ [7.3 ETL(ä¸Š)-çŸ¥è­˜ä¾†æº](./7.3-ETLä¸Š-çŸ¥è­˜ä¾†æº.md) - å­¸ç¿’å¤šç¨®è³‡æ–™ä¾†æºæ•´åˆ

---

**ç›¸é—œè³‡æº**:
- å°æ‡‰ç¯„ä¾‹: [`chapter7-rag-basic`](../../code-examples/chapter7-rag/chapter7-rag-basic/)
- [OpenAI Embeddings API](https://platform.openai.com/docs/guides/embeddings)
- [å‘é‡ç›¸ä¼¼åº¦è¨ˆç®—](https://www.pinecone.io/learn/vector-similarity/)
