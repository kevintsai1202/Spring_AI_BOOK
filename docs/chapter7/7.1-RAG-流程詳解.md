# 7.1 RAG æµç¨‹è©³è§£

> **å°æ‡‰ç« ç¯€**: Day18-19
> **å°æ‡‰ç¯„ä¾‹**: `chapter7-rag-basic`
> **é›£åº¦**: â­â­â­â­â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

RAG (Retrieval-Augmented Generation, æª¢ç´¢å¢å¼·ç”Ÿæˆ) æ˜¯ç›®å‰æœ€å¯¦ç”¨çš„ AI æ‡‰ç”¨æŠ€è¡“ä¹‹ä¸€ã€‚å®ƒè®“ AI èƒ½å¤ åŸºæ–¼**ä½ çš„ç§æœ‰çŸ¥è­˜åº«**ä¾†å›ç­”å•é¡Œ,è€Œä¸åƒ…åƒ…ä¾è³´è¨“ç·´æ™‚çš„èˆŠè³‡æ–™ã€‚

**å­¸ç¿’ç›®æ¨™**:
- ç†è§£ RAG çš„å·¥ä½œåŸç†å’Œåƒ¹å€¼
- æŒæ¡ Spring AI çš„ RAG å¯¦ç¾æ–¹å¼
- å­¸æœƒä½¿ç”¨ QuestionAnswerAdvisor
- å»ºç«‹ç¬¬ä¸€å€‹ RAG æ‡‰ç”¨

---

## ğŸ¯ ç‚ºä»€éº¼éœ€è¦ RAG?

### å‚³çµ± LLM çš„å±€é™

```
å•é¡Œ: "å…¬å¸ 2024 å¹´ Q4 çš„éŠ·å”®æ•¸æ“š?"
å‚³çµ± LLM: "æŠ±æ­‰,æˆ‘çš„è¨“ç·´è³‡æ–™åªåˆ° 2023 å¹´..."
```

å‚³çµ± LLM æœ‰ä¸‰å¤§å•é¡Œ:
1. âŒ **çŸ¥è­˜éæ™‚**: è¨“ç·´è³‡æ–™æœ‰æ™‚é–“é™åˆ¶
2. âŒ **æ²’æœ‰ç§æœ‰è³‡æ–™**: ç„¡æ³•çŸ¥é“ä½ å…¬å¸çš„å…§éƒ¨è³‡æ–™
3. âŒ **å¹»è¦ºå•é¡Œ**: å¯èƒ½ç·¨é€ ä¸å­˜åœ¨çš„è³‡è¨Š

### RAG çš„è§£æ±ºæ–¹æ¡ˆ

```
å•é¡Œ: "å…¬å¸ 2024 å¹´ Q4 çš„éŠ·å”®æ•¸æ“š?"
RAG ç³»çµ±:
  1. å¾çŸ¥è­˜åº«æª¢ç´¢ â†’ æ‰¾åˆ° Q4 éŠ·å”®å ±å‘Š
  2. çµåˆå ±å‘Šå…§å®¹ â†’ ç”Ÿæˆç­”æ¡ˆ
  3. é™„ä¸Šè³‡æ–™ä¾†æº â†’ å¯è¿½æº¯ã€å¯ä¿¡è³´

ç­”æ¡ˆ: "æ ¹æ“š Q4 éŠ·å”®å ±å‘Š,ç‡Ÿæ”¶æˆé•· 15%... (ä¾†æº: sales-report-q4.pdf)"
```

**RAG çš„å„ªå‹¢**:
- âœ… **å³æ™‚æ›´æ–°**: æ›´æ–°çŸ¥è­˜åº«å³å¯,ç„¡éœ€é‡æ–°è¨“ç·´
- âœ… **ç§æœ‰è³‡æ–™**: æ”¯æ´ä¼æ¥­å…§éƒ¨æ–‡æª”
- âœ… **å¯è¿½æº¯**: ç­”æ¡ˆé™„å¸¶ä¾†æº,æé«˜å¯ä¿¡åº¦
- âœ… **æˆæœ¬ä½**: ç›¸æ¯” Fine-tuning ä¾¿å®œå¾ˆå¤š

---

## ğŸ—ï¸ RAG å®Œæ•´æµç¨‹

### å…©éšæ®µå·¥ä½œæµç¨‹

```mermaid
graph TB
    subgraph Phase1["ğŸ“¦ éšæ®µä¸€: çŸ¥è­˜åº«å»ºç«‹ (é›¢ç·š)"]
        A1["ğŸ“„ åŸå§‹æ–‡æª”"] --> A2["âœ‚ï¸ æ–‡æœ¬åˆ†å¡Š<br/>(Chunking)"]
        A2 --> A3["ğŸ”¢ å‘é‡åŒ–<br/>(Embedding)"]
        A3 --> A4["ğŸ’¾ å­˜å…¥å‘é‡è³‡æ–™åº«"]
    end

    subgraph Phase2["ğŸ”„ éšæ®µäºŒ: æŸ¥è©¢å›ç­” (ç·šä¸Š)"]
        B1["â“ ç”¨æˆ¶å•é¡Œ"] --> B2["ğŸ”¢ å•é¡Œå‘é‡åŒ–"]
        B2 --> B3["ğŸ” å‘é‡ç›¸ä¼¼æ€§æœå°‹<br/>(æ‰¾æœ€ç›¸é—œçš„æ–‡æª”)"]
        B3 --> B4["ğŸ“‹ çµ„è£ä¸Šä¸‹æ–‡ + å•é¡Œ"]
        B4 --> B5["ğŸ¤– LLM ç”Ÿæˆç­”æ¡ˆ"]
        B5 --> B6["âœ… è¿”å›ç­”æ¡ˆ + ä¾†æº"]
    end

    A4 -.->|çŸ¥è­˜åº«| B3

    style Phase1 fill:#e1f5ff,stroke:#0288d1,stroke-width:2px
    style Phase2 fill:#fff4e6,stroke:#f57c00,stroke-width:2px
    style A4 fill:#c8e6c9,stroke:#388e3c
    style B3 fill:#ffccbc,stroke:#e64a19
    style B6 fill:#c8e6c9,stroke:#388e3c
```

---

## ğŸ’» Spring AI RAG å¯¦ç¾

### QuestionAnswerAdvisor - è‡ªå‹• RAG

Spring AI æä¾›äº† `QuestionAnswerAdvisor`,å®ƒæœƒ**è‡ªå‹•åŸ·è¡Œæ•´å€‹ RAG æµç¨‹**,ä½ åªéœ€è¦é…ç½®å¥½å‘é‡è³‡æ–™åº«å³å¯ã€‚

```java
// å°æ‡‰ç¯„ä¾‹: chapter7-rag-basic/.../config/RAGConfig.java:48

@Bean
public ChatClient ragChatClient(
        ChatModel chatModel,
        VectorStore vectorStore) {

    return ChatClient.builder(chatModel)
        .defaultAdvisors(
            new QuestionAnswerAdvisor(
                vectorStore,
                SearchRequest.defaults()
                    .withTopK(5)              // æª¢ç´¢å‰ 5 å€‹ç›¸é—œæ–‡æª”
                    .withSimilarityThreshold(0.7)  // ç›¸ä¼¼åº¦é–¾å€¼
            )
        )
        .build();
}
```

**QuestionAnswerAdvisor è‡ªå‹•è™•ç†**:
1. ğŸ”¢ å°‡ç”¨æˆ¶å•é¡Œå‘é‡åŒ–
2. ğŸ” å¾ `VectorStore` æœå°‹æœ€ç›¸é—œçš„æ–‡æª” (Top-K)
3. ğŸ“‹ è‡ªå‹•çµ„è£ Prompt: `Context: <æª¢ç´¢åˆ°çš„æ–‡æª”> \n Question: <ç”¨æˆ¶å•é¡Œ>`
4. ğŸ¤– èª¿ç”¨ LLM ç”Ÿæˆç­”æ¡ˆ

é€™æ¨£ä½ å°±**ä¸éœ€è¦æ‰‹å‹•å¯«æª¢ç´¢é‚è¼¯**äº†!

### RAG æœå‹™å¯¦ç¾

```java
// å°æ‡‰ç¯„ä¾‹: chapter7-rag-basic/.../service/RAGService.java:32

@Service
@RequiredArgsConstructor
@Slf4j
public class RAGService {

    private final ChatClient ragChatClient;
    private final VectorStore vectorStore;

    /**
     * RAG æŸ¥è©¢ - å°±é€™éº¼ç°¡å–®!
     */
    public RAGResponse query(String question) {
        log.debug("Processing RAG query: {}", question);

        // QuestionAnswerAdvisor è‡ªå‹•è™•ç†ä¸€åˆ‡
        String response = ragChatClient.prompt()
            .user(question)
            .call()
            .content();

        return RAGResponse.builder()
            .question(question)
            .answer(response)
            .timestamp(LocalDateTime.now())
            .build();
    }

    /**
     * æ·»åŠ æ–‡æª”åˆ°çŸ¥è­˜åº«
     */
    public void addDocuments(List<Resource> resources) {
        List<Document> documents = new ArrayList<>();

        for (Resource resource : resources) {
            // 1. è®€å–æ–‡æª”
            TextReader reader = new TextReader(resource);
            List<Document> docs = reader.read();

            // 2. æ–‡æœ¬åˆ†å¡Š
            TokenTextSplitter splitter = new TokenTextSplitter(800, 200);
            List<Document> chunks = splitter.apply(docs);

            documents.addAll(chunks);
        }

        // 3. å­˜å…¥å‘é‡è³‡æ–™åº« (è‡ªå‹•å‘é‡åŒ–)
        vectorStore.add(documents);

        log.info("Added {} document chunks to knowledge base", documents.size());
    }
}
```

**é—œéµæ­¥é©Ÿèªªæ˜**:
- `TextReader`: è®€å–æ–‡æª”å…§å®¹
- `TokenTextSplitter(800, 200)`:
  - 800 tokens ä¸€å¡Š
  - 200 tokens é‡ç–Š (ä¿è­‰ä¸Šä¸‹æ–‡é€£è²«æ€§)
- `vectorStore.add()`: Spring AI è‡ªå‹•å‘é‡åŒ–ä¸¦å­˜å„²

---

## ğŸ—„ï¸ å‘é‡è³‡æ–™åº«é…ç½®

### Neo4j Vector Store è¨­å®š

```yaml
# å°æ‡‰ç¯„ä¾‹: chapter7-rag-basic/src/main/resources/application.yml

spring:
  ai:
    # OpenAI é…ç½®
    openai:
      api-key: ${OPENAI_API_KEY}
      chat:
        model: gpt-4o
      embedding:
        model: text-embedding-3-small  # 1536 ç¶­å‘é‡

    # Neo4j å‘é‡è³‡æ–™åº«
    vectorstore:
      neo4j:
        uri: bolt://localhost:7687
        username: neo4j
        password: ${NEO4J_PASSWORD}
        database-name: neo4j
        index-name: document-embeddings    # ç´¢å¼•åç¨±
        embedding-dimension: 1536           # å¿…é ˆèˆ‡ Embedding Model ä¸€è‡´
        distance-type: COSINE               # é¤˜å¼¦ç›¸ä¼¼åº¦
```

### å•Ÿå‹• Neo4j

```bash
docker run -d \
  --name neo4j-rag \
  -p 7474:7474 -p 7687:7687 \
  -e NEO4J_AUTH=neo4j/test1234 \
  neo4j:5.15
```

---

## ğŸ¬ å®Œæ•´ä½¿ç”¨æµç¨‹

### Step 1: ä¸Šå‚³æ–‡æª”å»ºç«‹çŸ¥è­˜åº«

```bash
curl -X POST http://localhost:8080/api/rag/documents \
  -F "files=@spring-ai-guide.pdf" \
  -F "files=@company-handbook.txt"
```

**å…§éƒ¨æµç¨‹**:
```
spring-ai-guide.pdf
  â†’ TextReader è®€å–
  â†’ TokenTextSplitter åˆ†å¡Š (800 tokens/chunk, 200 overlap)
  â†’ OpenAI Embedding (æ¯å¡Š â†’ 1536 ç¶­å‘é‡)
  â†’ Neo4j å­˜å„² (æ–‡æœ¬ + å‘é‡)
```

### Step 2: RAG æŸ¥è©¢

```bash
curl -X POST http://localhost:8080/api/rag/query \
  -H "Content-Type: application/json" \
  -d '{
    "question": "ä»€éº¼æ˜¯ Spring AI çš„ Advisor?",
    "topK": 5
  }'
```

**QuestionAnswerAdvisor è‡ªå‹•åŸ·è¡Œ**:
```
1. å‘é‡åŒ–å•é¡Œ: "ä»€éº¼æ˜¯ Spring AI çš„ Advisor?"
   â†’ OpenAI Embedding â†’ [0.1, 0.3, ..., 0.5] (1536ç¶­)

2. å‘é‡æœå°‹: Neo4j æ‰¾å‡ºæœ€ç›¸ä¼¼çš„ 5 å€‹æ–‡æª”å¡Š
   â†’ Similarity Score: [0.92, 0.89, 0.87, 0.85, 0.83]

3. çµ„è£ Prompt:
   """
   Context:
   <æª¢ç´¢åˆ°çš„æ–‡æª”å¡Š 1>
   <æª¢ç´¢åˆ°çš„æ–‡æª”å¡Š 2>
   ...

   Question: ä»€éº¼æ˜¯ Spring AI çš„ Advisor?

   è«‹æ ¹æ“š Context å›ç­” Questionã€‚
   """

4. GPT-4o ç”Ÿæˆç­”æ¡ˆ

5. è¿”å›: ç­”æ¡ˆ + ä¾†æºæ–‡æª”
```

---

## ğŸ”§ æ–‡æœ¬åˆ†å¡Šç­–ç•¥

### ç‚ºä»€éº¼è¦åˆ†å¡Š?

```
å•é¡Œ: ä¸€æœ¬ 200 é çš„ PDF â†’ ä¸€æ•´å€‹å‘é‡?

1. âŒ å¤ªé•·:
   - LLM æœ‰ Token é™åˆ¶ (4K, 8K, 128K...)
   - å–®ä¸€å‘é‡ç„¡æ³•ç²¾ç¢ºè¡¨ç¤ºæ‰€æœ‰å…§å®¹

2. âŒ ä¸ç²¾ç¢º:
   - ç”¨æˆ¶å•"ç¬¬ 5 ç« çš„å…§å®¹" â†’ ä½†å‘é‡åŒ…å«å…¨æ›¸
   - ç›¸ä¼¼æ€§åˆ†æ•¸ä¸æº–ç¢º

è§£æ±ºæ–¹æ¡ˆ: åˆ†å¡Š!
   200 é  PDF â†’ åˆ‡æˆ 500 å€‹å°å¡Š
   â†’ æ¯å¡Šéƒ½æœ‰è‡ªå·±çš„å‘é‡
   â†’ æœå°‹æ™‚åªè¿”å›æœ€ç›¸é—œçš„å¡Š
```

### TokenTextSplitter è¨­å®š

```java
// å°æ‡‰ç¯„ä¾‹: chapter7-rag-basic/.../config/RAGConfig.java:60

@Bean
public TokenTextSplitter tokenTextSplitter() {
    return new TokenTextSplitter(
        800,    // chunkSize: æ¯å¡Š 800 tokens
        200,    // overlapSize: é‡ç–Š 200 tokens (é¿å…åˆ‡æ–·å¥å­)
        10,     // minChunkSize: æœ€å°å¡Šå¤§å°
        10000,  // maxNumChunks: æœ€å¤§å¡Šæ•¸é‡
        true    // keepSeparator: ä¿ç•™åˆ†éš”ç¬¦
    );
}
```

**é‡ç–Š (Overlap) çš„é‡è¦æ€§**:
```
æ²’æœ‰é‡ç–Š:
  Chunk 1: "Spring AI æä¾›äº†å¤šç¨®åŠŸèƒ½"
  Chunk 2: "åŒ…æ‹¬èŠå¤©ã€åµŒå…¥ã€åœ–åƒç”Ÿæˆ"
  âŒ ä¸Šä¸‹æ–‡æ–·è£‚

æœ‰é‡ç–Š 200 tokens:
  Chunk 1: "Spring AI æä¾›äº†å¤šç¨®åŠŸèƒ½,åŒ…æ‹¬èŠå¤©"
  Chunk 2: "æä¾›äº†å¤šç¨®åŠŸèƒ½,åŒ…æ‹¬èŠå¤©ã€åµŒå…¥ã€åœ–åƒç”Ÿæˆ"
  âœ… ä¸Šä¸‹æ–‡ä¿æŒé€£è²«
```

---

## ğŸ“Š RAG æ•ˆèƒ½èª¿æ ¡

### Top-K å’Œç›¸ä¼¼åº¦é–¾å€¼

```java
SearchRequest.defaults()
    .withTopK(5)                    // è¿”å›æœ€ç›¸é—œçš„ 5 å€‹æ–‡æª”
    .withSimilarityThreshold(0.7);  // åªè¿”å›ç›¸ä¼¼åº¦ > 0.7 çš„çµæœ
```

**å¦‚ä½•é¸æ“‡ Top-K?**

| Top-K | å„ªé» | ç¼ºé» | é©ç”¨å ´æ™¯ |
|-------|-----|------|---------|
| **K=3** | ç²¾æº–ã€å¿«é€Ÿ | å¯èƒ½éºæ¼ç›¸é—œè³‡è¨Š | ç­”æ¡ˆé›†ä¸­åœ¨å°‘æ•¸æ–‡æª” |
| **K=5** | â­ å¹³è¡¡ | - | **é€šç”¨æ¨è–¦** |
| **K=10** | è³‡è¨Šå®Œæ•´ | å¯èƒ½å¼•å…¥é›œè¨Š | è¤‡é›œå•é¡Œã€éœ€è¦ç¶œåˆå¤šä»½æ–‡æª” |

**ç›¸ä¼¼åº¦é–¾å€¼**:
- `0.9+`: å¹¾ä¹å®Œå…¨åŒ¹é… (å¯èƒ½å¤ªåš´æ ¼)
- `0.7-0.8`: â­ **æ¨è–¦ç¯„åœ**
- `0.5-0.6`: ç›¸é—œæ€§è¼ƒå¼± (å¯èƒ½å¼•å…¥ç„¡é—œå…§å®¹)

### å‹•æ…‹éæ¿¾æ¢ä»¶

```java
// å°æ‡‰ç¯„ä¾‹: chapter7-rag-basic/.../service/RAGService.java:58

public String queryWithFilter(String question, String category) {
    return ragChatClient.prompt()
        .user(question)
        .advisors(a -> a.param(
            QuestionAnswerAdvisor.FILTER_EXPRESSION,
            "category == '" + category + "'"  // åªæœå°‹ç‰¹å®šé¡åˆ¥
        ))
        .call()
        .content();
}
```

**ä½¿ç”¨å ´æ™¯**:
```
å•é¡Œ: "æœ€æ–°çš„ç”¢å“è¦æ ¼?"

ä¸åŠ éæ¿¾: å¯èƒ½æœåˆ°èˆŠç‰ˆæœ¬ã€æ¸¬è©¦ç‰ˆã€è‰ç¨¿...
åŠ éæ¿¾: category == 'official' AND version == '2024'
â†’ åªæœå°‹å®˜æ–¹ã€æœ€æ–°ç‰ˆæœ¬
```

---

## ğŸ¯ REST API è¨­è¨ˆ

### RAG Controller

```java
// å°æ‡‰ç¯„ä¾‹: chapter7-rag-basic/.../controller/RAGController.java:26

@RestController
@RequestMapping("/api/rag")
@RequiredArgsConstructor
@Slf4j
public class RAGController {

    private final RAGService ragService;

    /**
     * RAG æŸ¥è©¢
     */
    @PostMapping("/query")
    public ResponseEntity<RAGResponse> query(@RequestBody RAGQueryRequest request) {
        try {
            RAGResponse response = ragService.query(request.getQuestion());
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            log.error("RAG query failed", e);
            return ResponseEntity.badRequest()
                .body(RAGResponse.builder()
                    .question(request.getQuestion())
                    .error("æŸ¥è©¢å¤±æ•—: " + e.getMessage())
                    .build());
        }
    }

    /**
     * ä¸Šå‚³æ–‡æª”
     */
    @PostMapping("/documents")
    public ResponseEntity<ApiResponse> addDocuments(
            @RequestParam("files") List<MultipartFile> files) {

        try {
            List<Resource> resources = files.stream()
                .map(this::convertToResource)
                .collect(Collectors.toList());

            ragService.addDocuments(resources);

            return ResponseEntity.ok(
                ApiResponse.success("æˆåŠŸæ·»åŠ  " + files.size() + " å€‹æ–‡æª”åˆ°çŸ¥è­˜åº«")
            );
        } catch (Exception e) {
            log.error("Failed to add documents", e);
            return ResponseEntity.badRequest()
                .body(ApiResponse.error("æ–‡æª”æ·»åŠ å¤±æ•—: " + e.getMessage()));
        }
    }
}
```

---

## ğŸ“ é‡é»å›é¡§

### RAG æ ¸å¿ƒæ¦‚å¿µ
âœ… RAG = Retrieval + Augmented + Generation
âœ… è§£æ±º LLM çŸ¥è­˜éæ™‚ã€ç„¡ç§æœ‰è³‡æ–™çš„å•é¡Œ
âœ… æˆæœ¬ä½ã€æ˜“æ›´æ–°ã€å¯è¿½æº¯

### Spring AI å¯¦ç¾
âœ… `QuestionAnswerAdvisor` è‡ªå‹•è™•ç† RAG æµç¨‹
âœ… `VectorStore` çµ±ä¸€ä»‹é¢(Neo4j, Chroma, Pinecone...)
âœ… `TokenTextSplitter` æ™ºèƒ½åˆ†å¡Š

### æœ€ä½³å¯¦è¸
âœ… åˆ†å¡Šå¤§å°: 800 tokens + 200 overlap
âœ… Top-K: 5 å€‹æ–‡æª”(é€šç”¨æ¨è–¦)
âœ… ç›¸ä¼¼åº¦é–¾å€¼: 0.7 - 0.8
âœ… æ·»åŠ éæ¿¾æ¢ä»¶æé«˜ç²¾æº–åº¦

---

## ğŸš€ ä¸‹ä¸€æ­¥

ğŸ‘‰ [7.2 å…§å®¹å‘é‡åŒ–](./7.2-å…§å®¹å‘é‡åŒ–.md) - æ·±å…¥ç†è§£ Embedding æŠ€è¡“

---

**ç›¸é—œè³‡æº**:
- å°æ‡‰ç¯„ä¾‹: [`chapter7-rag-basic`](../../code-examples/chapter7-rag/chapter7-rag-basic/)
- [Spring AI RAG å®˜æ–¹æ–‡æª”](https://docs.spring.io/spring-ai/reference/api/vectordbs.html)
- [RAG è«–æ–‡](https://arxiv.org/abs/2005.11401)
