# 7.3 ETL(ä¸Š) - çŸ¥è­˜ä¾†æº

> **å°æ‡‰ç« ç¯€**: Day20
> **å°æ‡‰ç¯„ä¾‹**: `chapter7-rag-etl-pipeline`
> **é›£åº¦**: â­â­â­â­â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

RAG ç³»çµ±çš„çŸ¥è­˜ä¾†æºåƒè®Šè¬åŒ–: PDFã€Wordã€ç¶²é ã€è³‡æ–™åº«...ã€‚Spring AI æä¾›äº†çµ±ä¸€çš„ **DocumentReader** ä»‹é¢,è®“ä½ è¼•é¬†æ•´åˆå„ç¨®è³‡æ–™ä¾†æºã€‚

**å­¸ç¿’ç›®æ¨™**:
- ç†è§£ Spring AI ETL ä¸‰éšæ®µæµç¨‹
- æŒæ¡å„ç¨® DocumentReader çš„ä½¿ç”¨
- å­¸æœƒè¨­è¨ˆå¯æ“´å±•çš„ETLç®¡é“
- å¯¦ç¾å¤šæ ¼å¼æ–‡æª”è™•ç†

---

## ğŸ¯ ä»€éº¼æ˜¯ ETL?

### ETL ä¸‰éšæ®µ

```mermaid
graph LR
    A["ğŸ“¥ Extract<br/>(æå–)"] --> B["ğŸ”„ Transform<br/>(è½‰æ›)"]
    B --> C["ğŸ’¾ Load<br/>(è¼‰å…¥)"]

    A1["PDF, Word, ç¶²é ..."] -.-> A
    B1["åˆ†å¡Š, æ¸…ç†, å‘é‡åŒ–"] -.-> B
    C1["VectorStore"] -.-> C

    style A fill:#e1f5ff,stroke:#0288d1
    style B fill:#fff4e6,stroke:#f57c00
    style C fill:#c8e6c9,stroke:#388e3c
```

**ETL vs å‚³çµ±è³‡æ–™è™•ç†**:

| éšæ®µ | å‚³çµ± ETL | RAG ETL |
|------|---------|---------|
| **Extract** | å¾è³‡æ–™åº«æå–çµæ§‹åŒ–è³‡æ–™ | å¾æ–‡æª”æå–**éçµæ§‹åŒ–æ–‡å­—** |
| **Transform** | è³‡æ–™æ¸…ç†ã€æ ¼å¼è½‰æ› | æ–‡æœ¬åˆ†å¡Šã€**å‘é‡åŒ–** |
| **Load** | è¼‰å…¥é—œè¯å¼è³‡æ–™åº« | è¼‰å…¥**å‘é‡è³‡æ–™åº«** |

---

## ğŸ—ï¸ Spring AI ETL æ¶æ§‹

### ä¸‰å¤§æ ¸å¿ƒä»‹é¢

Spring AI æä¾›äº†å‡½æ•¸å¼ä»‹é¢,è¨­è¨ˆå„ªé›…:

```java
/**
 * DocumentReader: è®€å–è³‡æ–™ä¾†æº
 */
@FunctionalInterface
public interface DocumentReader extends Supplier<List<Document>> {
    // å°±æ˜¯ä¸€å€‹ Supplier,è¿”å›æ–‡æª”åˆ—è¡¨
}

/**
 * DocumentTransformer: è½‰æ›æ–‡æª”
 */
@FunctionalInterface
public interface DocumentTransformer extends Function<List<Document>, List<Document>> {
    // è¼¸å…¥æ–‡æª”åˆ—è¡¨,è¼¸å‡ºè½‰æ›å¾Œçš„æ–‡æª”åˆ—è¡¨
}

/**
 * DocumentWriter: å¯«å…¥ç›®æ¨™
 */
@FunctionalInterface
public interface DocumentWriter extends Consumer<List<Document>> {
    // æ¶ˆè²»æ–‡æª”åˆ—è¡¨
}
```

**å‡½æ•¸å¼çµ„åˆ**:

```java
// å‡½æ•¸å¼é¢¨æ ¼çš„ ETL Pipeline
DocumentReader reader = new PdfReader(resource);
DocumentTransformer splitter = new TokenTextSplitter();
DocumentWriter writer = vectorStore::add;

// çµ„åˆåŸ·è¡Œ
writer.accept(splitter.apply(reader.get()));

// æ›´ç°¡æ½”çš„å¯«æ³•
vectorStore.add(
    new TokenTextSplitter()
        .apply(new PdfReader(resource).get())
);
```

---

## ğŸ“„ PDF æ–‡æª”è™•ç†

### PagePdfDocumentReader (æŒ‰é åˆ†å‰²)

**ä¾è³´é…ç½®**:
```xml
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-pdf-document-reader</artifactId>
</dependency>
```

**åŸºæœ¬ä½¿ç”¨**:

```java
// å°æ‡‰ç¯„ä¾‹: chapter7-rag-etl-pipeline/.../service/PdfDocumentService.java

@Service
public class PdfDocumentService {

    /**
     * è®€å– PDF (æ¯é ä¸€å€‹ Document)
     */
    public List<Document> readPdf(Resource pdfResource) {
        PagePdfDocumentReader reader = new PagePdfDocumentReader(pdfResource);
        return reader.read();
    }

    /**
     * é€²éšé…ç½®
     */
    public List<Document> readPdfAdvanced(Resource pdfResource) {
        PdfDocumentReaderConfig config = PdfDocumentReaderConfig.builder()
            .withPageTopMargin(50)     // ä¸Šé‚Šè· (è·³éé é¦–)
            .withPageBottomMargin(50)  // ä¸‹é‚Šè· (è·³éé å°¾)
            .withPagesPerDocument(3)   // æ¯3é åˆä½µæˆä¸€å€‹ Document
            .withPageExtractedTextFormatter(
                ExtractedTextFormatter.builder()
                    .withNumberOfTopTextLinesToDelete(2)    // åˆªé™¤å‰2è¡Œ (æ¨™é¡Œ/é ç¢¼)
                    .withNumberOfBottomTextLinesToDelete(1) // åˆªé™¤æœ€å¾Œ1è¡Œ (é ç¢¼)
                    .build()
            )
            .build();

        return new PagePdfDocumentReader(pdfResource, config).read();
    }
}
```

**è¼¸å‡ºç¯„ä¾‹**:
```
PDF: 10é 

â†’ PagePdfDocumentReader (é è¨­)
  â””â†’ 10 å€‹ Document (æ¯é ä¸€å€‹)

â†’ PagePdfDocumentReader (pagesPerDocument=3)
  â””â†’ 4 å€‹ Document (3é , 3é , 3é , 1é )
```

### ParagraphPdfDocumentReader (æŒ‰æ®µè½åˆ†å‰²)

**æ›´æ™ºèƒ½çš„åˆ†å‰²æ–¹å¼**:

```java
public List<Document> readPdfByParagraph(Resource pdfResource) {
    ParagraphPdfDocumentReader reader = new ParagraphPdfDocumentReader(pdfResource);
    return reader.read();
}
```

**Page vs Paragraph**:

```
åŒä¸€ä»½ 10é  PDF:

PagePdfDocumentReader:
  â†’ 10 å€‹ Document (å›ºå®šæŒ‰é åˆ†å‰²)
  â†’ å¯èƒ½åœ¨å¥å­ä¸­é–“åˆ‡æ–·

ParagraphPdfDocumentReader:
  â†’ 25 å€‹ Document (æŒ‰æ®µè½åˆ†å‰²)
  â†’ ä¿æŒæ®µè½å®Œæ•´æ€§ â† æ›´é©åˆ RAG!
```

---

## ğŸ“ Office æ–‡æª”è™•ç† (Tika)

### TikaDocumentReader (è¬èƒ½è®€å–å™¨)

Apache Tika å¯ä»¥è™•ç† **300+ ç¨®æ ¼å¼**!

**ä¾è³´é…ç½®**:
```xml
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-tika-document-reader</artifactId>
</dependency>
```

**æ”¯æ´æ ¼å¼**:
- ğŸ“˜ Word: `.doc`, `.docx`
- ğŸ“Š Excel: `.xls`, `.xlsx`
- ğŸ“½ï¸ PowerPoint: `.ppt`, `.pptx`
- ğŸ–¼ï¸ åœ–åƒ: `.jpg`, `.png` (éœ€OCR)
- ğŸ—œï¸ å£“ç¸®æª”: `.zip`, `.tar`
- ...é‚„æœ‰ 290+ ç¨®!

**ä½¿ç”¨æ–¹å¼**:

```java
@Service
public class OfficeDocumentService {

    /**
     * Word æ–‡æª”
     */
    public List<Document> readWord(Resource wordFile) {
        TikaDocumentReader reader = new TikaDocumentReader(wordFile);
        return reader.read();
    }

    /**
     * PowerPoint æ–‡æª”
     */
    public List<Document> readPowerPoint(Resource pptFile) {
        TikaDocumentReader reader = new TikaDocumentReader(pptFile);
        List<Document> docs = reader.read();

        // æ·»åŠ å…ƒè³‡æ–™
        docs.forEach(doc -> {
            doc.getMetadata().put("doc_type", "POWERPOINT");
            doc.getMetadata().put("source", pptFile.getFilename());
        });

        return docs;
    }

    /**
     * è‡ªå‹•è­˜åˆ¥æ ¼å¼
     */
    public List<Document> readAnyFormat(Resource file) {
        // Tika è‡ªå‹•æª¢æ¸¬æ–‡ä»¶é¡å‹!
        TikaDocumentReader reader = new TikaDocumentReader(file);
        return reader.read();
    }
}
```

---

## ğŸ“ƒ æ–‡æœ¬æ–‡ä»¶è™•ç†

### TextReader (ç´”æ–‡æœ¬)

```java
@Service
public class TextDocumentService {

    /**
     * è®€å– TXT æ–‡ä»¶
     */
    public List<Document> readTextFile(Resource textFile) {
        TextReader reader = new TextReader(textFile);
        reader.setCharset(StandardCharsets.UTF_8);  // è¨­å®šç·¨ç¢¼

        // æ·»åŠ è‡ªå®šç¾©å…ƒè³‡æ–™
        reader.getCustomMetadata().put("filename", textFile.getFilename());

        return reader.read();
    }
}
```

### MarkdownDocumentReader

```java
/**
 * è®€å– Markdown æ–‡ä»¶
 */
public List<Document> readMarkdown(Resource mdFile) {
    MarkdownDocumentReaderConfig config = MarkdownDocumentReaderConfig.builder()
        .withHorizontalRuleCreateDocument(true)  // ç”¨ --- åˆ†å‰²æ–‡æª”
        .withIncludeCodeBlock(true)              // åŒ…å«ç¨‹å¼ç¢¼å€å¡Š
        .withIncludeBlockquote(true)             // åŒ…å«å¼•ç”¨å€å¡Š
        .build();

    MarkdownDocumentReader reader = new MarkdownDocumentReader(mdFile, config);
    return reader.read();
}
```

**Markdown åˆ†å‰²ç¯„ä¾‹**:
```markdown
# ç¬¬ä¸€ç« 
å…§å®¹...

---

# ç¬¬äºŒç« 
å…§å®¹...
```

â†’ `withHorizontalRuleCreateDocument(true)`
â†’ 2 å€‹ Document (æŒ‰ `---` åˆ†å‰²)

### JsonReader

```java
/**
 * è®€å– JSON æ–‡ä»¶
 */
public List<Document> readJson(Resource jsonFile) {
    // åªæå– "content" å’Œ "description" æ¬„ä½
    JsonReader reader = new JsonReader(jsonFile, "content", "description");
    return reader.read();
}

/**
 * JSON Pointer æŒ‡å®šè·¯å¾‘
 */
public List<Document> readJsonWithPointer(Resource jsonFile) {
    JsonReader reader = new JsonReader(jsonFile, "title", "body");

    // åªè®€å– /articles ä¸‹çš„å…§å®¹
    return reader.get("/articles");
}
```

**JSON ç¯„ä¾‹**:
```json
{
  "articles": [
    {"title": "Spring AI", "body": "Spring AI ä»‹ç´¹..."},
    {"title": "RAG ç³»çµ±", "body": "RAG ç³»çµ±ä»‹ç´¹..."}
  ]
}
```

â†’ `reader.get("/articles")`
â†’ 2 å€‹ Document

---

## ğŸŒ ç¶²é å…§å®¹è™•ç†

### JsoupDocumentReader (HTML)

**ä¾è³´**: Spring AI å·²å…§å»º Jsoup

```java
@Service
public class WebDocumentService {

    /**
     * è®€å– HTML æ–‡ä»¶
     */
    public List<Document> readHtml(Resource htmlFile) {
        JsoupDocumentReaderConfig config = JsoupDocumentReaderConfig.builder()
            .selector("article, div.content")  // CSS é¸æ“‡å™¨
            .charset("UTF-8")
            .includeLinkUrls(false)             // ä¸åŒ…å«è¶…é€£çµ
            .build();

        JsoupDocumentReader reader = new JsoupDocumentReader(htmlFile, config);
        return reader.read();
    }

    /**
     * è®€å–ç¶²é  URL
     */
    public List<Document> readWebPage(String url) {
        try {
            Resource urlResource = new UrlResource(url);

            JsoupDocumentReaderConfig config = JsoupDocumentReaderConfig.builder()
                .selector("body")                // æå–æ•´å€‹ body
                .metadataTags(List.of("title", "description", "keywords"))
                .build();

            return new JsoupDocumentReader(urlResource, config).read();

        } catch (Exception e) {
            log.error("Failed to read URL: {}", url, e);
            return Collections.emptyList();
        }
    }
}
```

**CSS é¸æ“‡å™¨ç¯„ä¾‹**:
```java
// æå–æ–‡ç« å…§å®¹
.selector("article")

// æå–å¤šå€‹å€åŸŸ
.selector("article, div.content, section.main")

// æ’é™¤å»£å‘Š
.selector("article:not(.ad)")
```

---

## ğŸ”„ ETL Pipeline è¨­è¨ˆ

### å®Œæ•´ ETL æµç¨‹

```java
// å°æ‡‰ç¯„ä¾‹: chapter7-rag-etl-pipeline/.../service/EtlPipelineService.java

@Service
@Slf4j
public class EtlPipelineService {

    private final VectorStore vectorStore;

    /**
     * å®Œæ•´ ETL ç®¡é“
     */
    public void processDocuments(List<Resource> resources) {
        log.info("Starting ETL pipeline with {} resources", resources.size());

        // 1. Extract - è®€å–æ–‡æª”
        List<Document> documents = extractDocuments(resources);
        log.info("Extracted {} documents", documents.size());

        // 2. Transform - è½‰æ›è™•ç†
        List<Document> transformed = transformDocuments(documents);
        log.info("Transformed to {} chunks", transformed.size());

        // 3. Load - è¼‰å…¥å‘é‡è³‡æ–™åº«
        loadDocuments(transformed);
        log.info("ETL pipeline completed");
    }

    /**
     * Extract: æ ¹æ“šæ–‡ä»¶é¡å‹é¸æ“‡ Reader
     */
    private List<Document> extractDocuments(List<Resource> resources) {
        List<Document> allDocs = new ArrayList<>();

        for (Resource resource : resources) {
            DocumentReader reader = createReader(resource);
            allDocs.addAll(reader.read());
        }

        return allDocs;
    }

    /**
     * å·¥å» æ¨¡å¼: å‰µå»ºå°æ‡‰çš„ Reader
     */
    private DocumentReader createReader(Resource resource) {
        String filename = resource.getFilename();
        if (filename == null) {
            throw new IllegalArgumentException("Filename is null");
        }

        String lower = filename.toLowerCase();

        if (lower.endsWith(".pdf")) {
            return new PagePdfDocumentReader(resource);
        } else if (lower.matches(".*\\.(docx?|pptx?|xlsx?)$")) {
            return new TikaDocumentReader(resource);
        } else if (lower.endsWith(".txt")) {
            return new TextReader(resource);
        } else if (lower.endsWith(".md")) {
            return new MarkdownDocumentReader(resource);
        } else if (lower.endsWith(".json")) {
            return new JsonReader(resource);
        } else if (lower.endsWith(".html")) {
            return new JsoupDocumentReader(resource);
        }

        throw new IllegalArgumentException("Unsupported file type: " + filename);
    }

    /**
     * Transform: æ–‡æœ¬åˆ†å¡Š
     */
    private List<Document> transformDocuments(List<Document> documents) {
        TokenTextSplitter splitter = new TokenTextSplitter(800, 200);
        return splitter.apply(documents);
    }

    /**
     * Load: å¯«å…¥å‘é‡è³‡æ–™åº«
     */
    private void loadDocuments(List<Document> documents) {
        vectorStore.add(documents);
    }
}
```

### DocumentReader å·¥å» æ¨¡å¼

æ›´å„ªé›…çš„è¨­è¨ˆ:

```java
@Component
public class DocumentReaderFactory {

    private final Map<String, Function<Resource, DocumentReader>> readerMap;

    public DocumentReaderFactory() {
        readerMap = Map.of(
            ".pdf", PagePdfDocumentReader::new,
            ".txt", TextReader::new,
            ".md", MarkdownDocumentReader::new,
            ".json", resource -> new JsonReader(resource),
            ".html", resource -> new JsoupDocumentReader(resource)
        );
    }

    public DocumentReader createReader(Resource resource) {
        String filename = resource.getFilename();
        if (filename == null) {
            throw new IllegalArgumentException("Filename is null");
        }

        String extension = filename.substring(filename.lastIndexOf('.'));

        Function<Resource, DocumentReader> constructor = readerMap.get(extension);
        if (constructor == null) {
            // Office æ–‡æª”çµ±ä¸€ç”¨ Tika
            if (extension.matches("\\.(docx?|pptx?|xlsx?)")) {
                return new TikaDocumentReader(resource);
            }
            throw new UnsupportedOperationException("Unsupported: " + extension);
        }

        return constructor.apply(resource);
    }
}
```

---

## ğŸ“Š å…ƒè³‡æ–™å¢å¼·

### ç‚ºä»€éº¼éœ€è¦å…ƒè³‡æ–™?

```
æ²’æœ‰å…ƒè³‡æ–™:
  Document("Spring AI æ˜¯ä¸€å€‹æ¡†æ¶...")
  â†’ RAG æŸ¥è©¢æ™‚ç„¡æ³•éæ¿¾ä¾†æºã€æ—¥æœŸç­‰

æœ‰å…ƒè³‡æ–™:
  Document("Spring AI æ˜¯ä¸€å€‹æ¡†æ¶...", {
    "source_file": "spring-ai-guide.pdf",
    "page_number": 5,
    "category": "æŠ€è¡“æ–‡æª”",
    "version": "1.0.0",
    "author": "Spring Team",
    "created_at": "2024-01-01"
  })
  â†’ å¯ä»¥æŒ‰ä¾†æºã€é¡åˆ¥ã€æ—¥æœŸéæ¿¾!
```

### æ·»åŠ å…ƒè³‡æ–™

```java
@Service
public class MetadataEnrichmentService {

    /**
     * æ·»åŠ è‡ªå®šç¾©å…ƒè³‡æ–™
     */
    public List<Document> enrichMetadata(List<Document> documents, Resource source) {
        String filename = source.getFilename();
        String fileType = getFileExtension(filename);

        documents.forEach(doc -> {
            Map<String, Object> metadata = doc.getMetadata();

            // åŸºæœ¬è³‡è¨Š
            metadata.put("source_file", filename);
            metadata.put("file_type", fileType);
            metadata.put("processed_at", LocalDateTime.now().toString());

            // åˆ†é¡
            metadata.put("category", detectCategory(doc.getContent()));

            // èªè¨€
            metadata.put("language", detectLanguage(doc.getContent()));
        });

        return documents;
    }

    private String detectCategory(String content) {
        // ç°¡å–®é—œéµå­—åŒ¹é…
        if (content.contains("Spring") || content.contains("Java")) {
            return "æŠ€è¡“æ–‡æª”";
        } else if (content.contains("å…¬å¸") || content.contains("æ”¿ç­–")) {
            return "å…¬å¸æ”¿ç­–";
        }
        return "å…¶ä»–";
    }

    private String detectLanguage(String content) {
        // ç°¡åŒ–åˆ¤æ–·
        return content.matches(".*[\\u4e00-\\u9fa5]+.*") ? "zh-TW" : "en";
    }
}
```

---

## ğŸ¯ REST API æ•´åˆ

### ETL Controller

```java
@RestController
@RequestMapping("/api/etl")
@RequiredArgsConstructor
public class EtlController {

    private final EtlPipelineService etlService;

    /**
     * æ‰¹æ¬¡ä¸Šå‚³æ–‡æª”
     */
    @PostMapping("/upload")
    public ResponseEntity<EtlResponse> uploadDocuments(
            @RequestParam("files") List<MultipartFile> files) {

        try {
            List<Resource> resources = files.stream()
                .map(this::convertToResource)
                .collect(Collectors.toList());

            etlService.processDocuments(resources);

            return ResponseEntity.ok(EtlResponse.builder()
                .success(true)
                .message("æˆåŠŸè™•ç† " + files.size() + " å€‹æ–‡æª”")
                .filesProcessed(files.size())
                .build());

        } catch (Exception e) {
            log.error("ETL failed", e);
            return ResponseEntity.badRequest()
                .body(EtlResponse.builder()
                    .success(false)
                    .error(e.getMessage())
                    .build());
        }
    }

    private Resource convertToResource(MultipartFile file) {
        try {
            return new ByteArrayResource(file.getBytes()) {
                @Override
                public String getFilename() {
                    return file.getOriginalFilename();
                }
            };
        } catch (IOException e) {
            throw new RuntimeException("Failed to convert file", e);
        }
    }
}
```

---

## ğŸ“ é‡é»å›é¡§

### Spring AI ETL æ¶æ§‹
âœ… DocumentReader, Transformer, Writer ä¸‰å¤§ä»‹é¢
âœ… å‡½æ•¸å¼è¨­è¨ˆ,æ˜“æ–¼çµ„åˆ
âœ… å·¥å» æ¨¡å¼å¯¦ç¾å¤šæ ¼å¼æ”¯æ´

### æ”¯æ´çš„æ–‡ä»¶æ ¼å¼
âœ… PDF: PagePdfDocumentReader, ParagraphPdfDocumentReader
âœ… Office: TikaDocumentReader (Word, Excel, PPT)
âœ… æ–‡æœ¬: TextReader, MarkdownDocumentReader, JsonReader
âœ… ç¶²é : JsoupDocumentReader (HTML, URL)

### æœ€ä½³å¯¦è¸
âœ… ä½¿ç”¨ ParagraphPdfDocumentReader ä¿æŒæ®µè½å®Œæ•´æ€§
âœ… å¯¦æ–½å…ƒè³‡æ–™å¢å¼·æé«˜æª¢ç´¢ç²¾æº–åº¦
âœ… å·¥å» æ¨¡å¼çµ±ä¸€ç®¡ç† Reader å‰µå»º
âœ… æ·»åŠ éŒ¯èª¤è™•ç†å’Œæ—¥èªŒè¨˜éŒ„

---

## ğŸš€ ä¸‹ä¸€æ­¥

ğŸ‘‰ [7.4 ETL(ä¸­)-é€²éšæ–‡ä»¶](./7.4-ETLä¸­-é€²éšæ–‡ä»¶.md) - OCRã€å£“ç¸®æª”æ¡ˆè™•ç†

---

**ç›¸é—œè³‡æº**:
- å°æ‡‰ç¯„ä¾‹: [`chapter7-rag-etl-pipeline`](../../code-examples/chapter7-rag/chapter7-rag-etl-pipeline/)
- [Spring AI DocumentReader](https://docs.spring.io/spring-ai/reference/api/etl-pipeline.html)
- [Apache Tika](https://tika.apache.org/)
