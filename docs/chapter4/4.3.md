# 4.3 å¦‚ä½•åƒ ChatGPT ç”¢ç”Ÿæµå¼è¼¸å‡º

> **å°æ‡‰ç« ç¯€**: Day13
> **å°æ‡‰ç¯„ä¾‹**: `chapter4-spring-ai-intro`
> **é›£åº¦**: â­â­â­â­â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

æµå¼è¼¸å‡ºæ˜¯ç¾ä»£ AI æ‡‰ç”¨çš„æ¨™é…åŠŸèƒ½ã€‚æœ¬ç« å°‡æ•™æ‚¨å¦‚ä½•å¯¦ç¾ ChatGPT èˆ¬çš„å³æ™‚å›æ‡‰æ•ˆæœï¼Œé€é Server-Sent Events (SSE) æŠ€è¡“è®“ AI å›æ‡‰é€å­—é¡¯ç¤ºã€‚

**å­¸ç¿’ç›®æ¨™**:
- ç†è§£æµå¼è¼¸å‡ºçš„åŸç†å’Œå„ªå‹¢
- æŒæ¡ Server-Sent Events (SSE) æŠ€è¡“
- ä½¿ç”¨ ChatClient å¯¦ç¾æµå¼ AI å°è©±
- è™•ç† Reactive Streams å’ŒéŒ¯èª¤æƒ…æ³
- é…ç½® CORS æ”¯æ´å‰ç«¯æ•´åˆ

---

## 4.3.1 ç‚ºä»€éº¼éœ€è¦æµå¼è¼¸å‡ºï¼Ÿ

### ä½¿ç”¨è€…é«”é©—çš„é©å‘½

![æµå¼è¼¸å‡º](https://ithelp.ithome.com.tw/upload/images/20240810/20161290gaE6Faz85x.jpg)

ç”±æ–¼ AI ç”¢ç”Ÿå…§å®¹å¾—é ä¼ºæœå™¨é‹ç®—å¾Œç”¢ç”Ÿçµæœï¼Œè³‡æ–™å¤šçš„è©±å¾—ç­‰ä¸å°‘æ™‚é–“ï¼Œè‹¥èƒ½ç”¢ç”Ÿè³‡æ–™å¾Œé¦¬ä¸Šåˆ†æ®µé€å‡ºï¼Œå¯å¤§å¤§æå‡ä½¿ç”¨è€…æ„Ÿå—ã€‚

### å•é¡Œå ´æ™¯: æ²’æœ‰æµå¼è¼¸å‡ºæœƒæ€æ¨£ï¼Ÿ

```
âŒ å‚³çµ±åŒæ­¥å›æ‡‰:
ä½¿ç”¨è€…: "è«‹å¯«ä¸€ç¯‡500å­—çš„æ–‡ç« "
      â†“
   [ç­‰å¾…15ç§’...]  â† ä½¿ç”¨è€…ç„¦æ…®ï¼Œä¸çŸ¥é“æ˜¯å¦é‚„åœ¨è™•ç†
      â†“
   å®Œæ•´æ–‡ç« ä¸€æ¬¡é¡¯ç¤º

å•é¡Œ:
- é•·æ™‚é–“ç­‰å¾…é€ æˆç„¦æ…®
- ç„¡æ³•æå‰åˆ¤æ–·å›æ‡‰å“è³ª
- æ„Ÿè¦ºç³»çµ±æ²’åæ‡‰
- ç„¡æ³•ä¸­é€”ä¸­æ–·

âœ… æµå¼è¼¸å‡º:
ä½¿ç”¨è€…: "è«‹å¯«ä¸€ç¯‡500å­—çš„æ–‡ç« "
      â†“
   [0.5ç§’] "æ˜¥å¤©æ˜¯..." â† ç«‹å³çœ‹åˆ°é–‹å§‹å›æ‡‰
      â†“
   [æŒçºŒæ›´æ–°] "æ˜¥å¤©æ˜¯è¬ç‰©å¾©ç”¦çš„å­£ç¯€..."
      â†“
   [å¯éš¨æ™‚åœæ­¢] å®Œæ•´å›æ‡‰

å„ªå‹¢:
- å³æ™‚åé¥‹ï¼Œé™ä½ç„¦æ…®
- å¯æå‰åˆ¤æ–·å“è³ª
- é¡ä¼¼çœŸäººå°è©±é«”é©—
- å¯ä¸­é€”ä¸­æ–·ç¯€çœæˆæœ¬
```

**æµå¼è¼¸å‡ºçš„å„ªå‹¢**ï¼š
- âš¡ **å³æ™‚åé¥‹**ï¼šä½¿ç”¨è€…ç«‹å³çœ‹åˆ° AI é–‹å§‹å›æ‡‰
- ğŸ¯ **é™ä½ç„¦æ…®**ï¼šé¿å…é•·æ™‚é–“ç­‰å¾…é€ æˆçš„ä¸ç¢ºå®šæ„Ÿ
- ğŸ“± **æ›´å¥½çš„äº’å‹•æ€§**ï¼šé¡ä¼¼çœŸäººå°è©±çš„é«”é©—
- ğŸš€ **æ„ŸçŸ¥æ•ˆèƒ½æå‡**ï¼šé›–ç„¶ç¸½æ™‚é–“ç›¸åŒï¼Œä½†æ„Ÿè¦ºæ›´å¿«
- ğŸ’¡ **æ—©æœŸä¸­æ–·**ï¼šä½¿ç”¨è€…å¯ä»¥æå‰åˆ¤æ–·å›æ‡‰å“è³ª

### Server-Sent Events (SSE) æŠ€è¡“

è¦é”åˆ°é€™ç¨®æ•ˆæœä¸»è¦é çš„æ˜¯ **Server-Sent Events (SSE)** ä¼ºæœå™¨ä¸»å‹•æ¨æ’­å”å®šï¼š

**SSE ç‰¹é»**ï¼š
- ğŸ“¡ **å–®å‘é€šè¨Š**ï¼šä¼ºæœå™¨å‘å®¢æˆ¶ç«¯æ¨é€è³‡æ–™
- ğŸ”„ **è‡ªå‹•é‡é€£**ï¼šé€£ç·šä¸­æ–·æ™‚è‡ªå‹•é‡æ–°é€£æ¥
- ğŸŒ **æ¨™æº–å”å®š**ï¼šåŸºæ–¼ HTTPï¼Œå»£æ³›æ”¯æ´
- ğŸ’» **ç€è¦½å™¨åŸç”Ÿæ”¯æ´**ï¼šä½¿ç”¨ EventSource API

---

## 4.3.2 ChatClient æµå¼è¼¸å‡ºå¯¦ä½œ

### åŸºæœ¬æµå¼è¼¸å‡º

Spring AI 1.0 GA çš„ ChatClient æä¾›äº†å„ªé›…çš„æµå¼è¼¸å‡º APIã€‚ä»¥ä¸‹æ˜¯ `StreamingAiController` ä¸­å¯¦ç¾åŸºæœ¬æµå¼å°è©±å’Œå¸¶ç³»çµ±æç¤ºè©æµå¼å°è©±çš„ç¯„ä¾‹ï¼š

```java
// ä¾†è‡ª code-examples/chapter4-spring-ai-intro/src/main/java/com/example/springai/controller/StreamingAiController.java
// ... (package and imports omitted for brevity)

@RestController
@RequestMapping("/api/ai")
@RequiredArgsConstructor
@Slf4j
public class StreamingAiController {
    
    private final ChatClient chatClient;

    /**
     * åŸºæœ¬æµå¼ AI å°è©±
     * @param prompt ä½¿ç”¨è€…è¼¸å…¥çš„æç¤ºè©
     * @return æµå¼å­—ä¸²å›æ‡‰
     */
    @GetMapping(value = "/chat/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux<String> chatStream(@RequestParam String prompt) {
        log.info("é–‹å§‹æµå¼å°è©±ï¼š{}", prompt);
        
        return chatClient.prompt()
                .user(prompt)
                .stream()
                .content();
    }
}
```

### ç¨‹å¼ç¢¼é‡é»èªªæ˜

**æ ¸å¿ƒ API**ï¼š
- **`stream()`**: æ›¿ä»£ `call()` ä¾†å•Ÿç”¨æµå¼è¼¸å‡º
- **`content()`**: è¿”å› `Flux<String>` æµå¼å­—ä¸²å…§å®¹
- **`produces = MediaType.TEXT_EVENT_STREAM_VALUE`**: æŒ‡å®šå›æ‡‰æ ¼å¼ç‚º SSE

**Reactive æ“ä½œç¬¦**ï¼š
- **`doOnSubscribe()`**: è¨‚é–±æ™‚åŸ·è¡Œçš„å‹•ä½œ
- **`doOnComplete()`**: å®Œæˆæ™‚åŸ·è¡Œçš„å‹•ä½œ
- **`doOnNext()`**: æ¯å€‹å…ƒç´ ç™¼å‡ºæ™‚åŸ·è¡Œçš„å‹•ä½œ

---

## 4.3.3 é€²éšæµå¼è¼¸å‡ºæ§åˆ¶

### è‡ªå®šç¾©æµå¼è¼¸å‡ºè™•ç†

æ‚¨å¯ä»¥é€é `map`ã€`filter`ã€`doOnNext` ç­‰ Reactive æ“ä½œç¬¦ä¾†è‡ªå®šç¾©æµå¼è¼¸å‡ºçš„è™•ç†é‚è¼¯ï¼š

```java
// ä¾†è‡ª code-examples/chapter4-spring-ai-intro/src/main/java/com/example/springai/controller/StreamingAiController.java
// ... (package and imports omitted for brevity)

@RestController
@RequestMapping("/api/ai")
@RequiredArgsConstructor
@Slf4j
public class StreamingAiController {

    private final ChatClient chatClient;

    // ... å…¶ä»–æ–¹æ³• ...

    /**
     * è‡ªå®šç¾©æµå¼è¼¸å‡ºè™•ç†
     * @param prompt ä½¿ç”¨è€…è¼¸å…¥
     * @return è™•ç†å¾Œçš„æµå¼å›æ‡‰
     */
    @GetMapping(value = "/chat/stream/custom", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux<String> chatStreamCustom(@RequestParam String prompt) {
        return chatClient.prompt()
                .user(prompt)
                .stream()
                .content()
                .map(content -> {
                    // è‡ªå®šç¾©è™•ç†æ¯å€‹æµå¼ç‰‡æ®µ
                    return "ğŸ¤– AI: " + content;
                })
                .filter(content -> {
                    // éæ¿¾ç©ºå…§å®¹
                    return content != null && !content.trim().isEmpty();
                })
                .doOnNext(content -> {
                    // è¨˜éŒ„æ¯å€‹ç‰‡æ®µ
                    log.debug("æµå¼å…§å®¹ï¼š{}", content);
                })
                .onErrorResume(error -> {
                    log.error("æµå¼è¼¸å‡ºéŒ¯èª¤", error);
                    return Flux.just("âŒ æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤ï¼š" + error.getMessage());
                });
    }
}
```

---

## 4.3.4 ä½¿ç”¨ ChatModel çš„æµå¼è¼¸å‡º

å¦‚æœç›´æ¥ä½¿ç”¨ `ChatModel`ï¼Œä¹Ÿå¯ä»¥å¯¦ç¾æµå¼è¼¸å‡ºã€‚`ChatModelService` ç¤ºç¯„äº†å¦‚ä½•ä½¿ç”¨åº•å±¤çš„ `StreamingChatModel` APIï¼š

```java
// ä¾†è‡ª code-examples/chapter4-spring-ai-intro/src/main/java/com/example/springai/service/ChatModelService.java
// ... (package and imports omitted for brevity)

@Service
@RequiredArgsConstructor
@Slf4j
public class ChatModelService {

    // private final ChatModel chatModel; // ç§»é™¤ä¸ç›¸é—œçš„æˆå“¡è®Šæ•¸
    private final StreamingChatModel streamingChatModel;

    /**
     * æµå¼å‘¼å«
     */
    public Flux<String> streamCall(String message) {
        return streamingChatModel.stream(message);
    }
}
```

---

## 4.3.5 æ‡‰ç”¨ç¨‹å¼é…ç½®

### å¿…è¦ä¾è³´

è¦ä½¿ç”¨ Spring AI çš„æµå¼è¼¸å‡ºåŠŸèƒ½ï¼Œå¿…é ˆåŒ…å« WebFlux ä¾è³´ï¼Œå³ä½¿æ˜¯å‘½ä»¤å¼æ‡‰ç”¨ç¨‹å¼ä¹Ÿéœ€è¦ï¼š

```xml
<!-- ä¾†è‡ª code-examples/chapter4-spring-ai-intro/pom.xml -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-webflux</artifactId>
</dependency>

<!-- Spring AI OpenAI Starter -->
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-openai-spring-boot-starter</artifactId>
</dependency>
```

### Spring Boot é…ç½®

ç¢ºä¿åœ¨ `application.yml` ä¸­æ­£ç¢ºè¨­å®šå­—å…ƒç·¨ç¢¼å’Œæµå¼é¸é …ï¼š

```yaml
# ä¾†è‡ª code-examples/chapter4-spring-ai-intro/src/main/resources/application.yml
server:
  port: 8080
  servlet:
    encoding:
      charset: UTF-8
      enabled: true
      force: true

spring:
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      base-url: https://api.openai.com
      chat:
        options:
          model: gpt-4o-mini
          temperature: 0.7
          max-tokens: 1000
          stream: true  # å•Ÿç”¨æµå¼è¼¸å‡º

# æ—¥èªŒé…ç½®
logging:
  level:
    org.springframework.ai: DEBUG
    reactor.netty: INFO
    com.example.springai: DEBUG
```

### è·¨åŸŸé…ç½® (CORS)

å¦‚æœå‰ç«¯å’Œå¾Œç«¯åœ¨ä¸åŒçš„ç¶²åŸŸï¼Œéœ€è¦é…ç½® CORSã€‚ä»¥ä¸‹æ˜¯ `CorsConfig.java` çš„ç¯„ä¾‹ï¼š

```java
// ä¾†è‡ª code-examples/chapter4-spring-ai-intro/src/main/java/com/example/springai/config/CorsConfig.java
// ... (package and imports omitted for brevity)

@Configuration
public class CorsConfig implements WebMvcConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**")
                .allowedOriginPatterns("*")  // å…è¨±æ‰€æœ‰ä¾†æºï¼ˆé–‹ç™¼ç’°å¢ƒä½¿ç”¨ï¼Œç”Ÿç”¢ç’°å¢ƒæ‡‰é™åˆ¶ç‚ºå…·é«”åŸŸåï¼‰
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                .allowedHeaders("*")
                .allowCredentials(true)
                .maxAge(3600);  // é æª¢è«‹æ±‚å¿«å–æ™‚é–“ï¼ˆç§’ï¼‰
    }
}
```

---

## ğŸ“ æœ¬ç« é‡é»å›é¡§

### æµå¼è¼¸å‡ºæ ¸å¿ƒæ¦‚å¿µ
âœ… SSE (Server-Sent Events) - HTML5 æ¨™æº–çš„å–®å‘æ¨é€å”å®š
âœ… Reactive Streams - ä½¿ç”¨ Flux è™•ç†éåŒæ­¥è³‡æ–™æµ
âœ… èƒŒå£“è™•ç† - æ§åˆ¶è³‡æ–™æµé€Ÿé¿å…è¨˜æ†¶é«”æº¢å‡º
âœ… éŒ¯èª¤æ¢å¾© - onErrorResume è™•ç†æµå¼éŒ¯èª¤

### ChatClient æµå¼ API
```java
// æ ¸å¿ƒæ¨¡å¼: stream() æ›¿ä»£ call()
chatClient.prompt()
    .user("ä½¿ç”¨è€…è¨Šæ¯")
    .stream()                  // å•Ÿç”¨æµå¼è¼¸å‡º
    .content();                // è¿”å› Flux<String>
```

### é…ç½®è¦é»
- **Content-Type**: `text/event-stream`
- **ä¾è³´**: spring-boot-starter-webflux
- **CORS**: å…è¨±å‰ç«¯è·¨åŸŸå­˜å–
- **ç·¨ç¢¼**: è¨­å®š UTF-8 é¿å…ä¸­æ–‡äº‚ç¢¼

### SSE vs WebSocket vs è¼ªè©¢

| ç‰¹æ€§ | SSE | WebSocket | è¼ªè©¢ |
|------|-----|-----------|------|
| **è¤‡é›œåº¦** | ä½ | ä¸­ | ä½ |
| **å³æ™‚æ€§** | é«˜ | é«˜ | ä½ |
| **è³‡æºæ¶ˆè€—** | ä½ | ä¸­ | é«˜ |
| **è‡ªå‹•é‡é€£** | æ˜¯ | å¦ | å¦ |
| **é©ç”¨å ´æ™¯** | AI æµå¼è¼¸å‡º | é›™å‘é€šè¨Š | ç°¡å–®æŸ¥è©¢ |

### Reactive æ“ä½œç¬¦
- `doOnSubscribe()`: è¨‚é–±æ™‚åŸ·è¡Œ
- `doOnNext()`: æ¯å€‹å…ƒç´ ç™¼å‡ºæ™‚åŸ·è¡Œ
- `doOnComplete()`: å®Œæˆæ™‚åŸ·è¡Œ
- `onErrorResume()`: éŒ¯èª¤è™•ç†å’Œæ¢å¾©

---

## ğŸš€ ä¸‹ä¸€æ­¥

ğŸ‘‰ [4.4 æ·±å…¥äº†è§£ ChatModel](./4.4.md) - æ¢è¨ ChatModel å…§éƒ¨æ©Ÿåˆ¶

---

**ç›¸é—œç« ç¯€**:
- â† ä¸Šä¸€ç« : [4.2 Hello AI World](./4.2.md)
- â†’ ä¸‹ä¸€ç« : [4.4 æ·±å…¥äº†è§£ ChatModel](./4.4.md)

**åƒè€ƒè³‡æ–™ï¼š**
- [Server-Sent Events Specification](https://html.spec.whatwg.org/multipage/server-sent-events.html)
- [Spring WebFlux Reactive Streams](https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html)
- [Project Reactor Documentation](https://projectreactor.io/docs/core/release/reference/)
- [Spring AI Streaming Documentation](https://docs.spring.io/spring-ai/reference/api/chatclient.html#streaming)
