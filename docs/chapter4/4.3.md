# 4.3 å¦‚ä½•åƒ ChatGPT ç”¢ç”Ÿæµå¼è¼¸å‡º

> **æœ¬ç« é‡é»**ï¼šå­¸ç¿’å¯¦ç¾ AI æµå¼è¼¸å‡ºåŠŸèƒ½ï¼Œè®“ä½¿ç”¨è€…é«”é©—å¦‚åŒ ChatGPT èˆ¬çš„å³æ™‚å›æ‡‰æ•ˆæœï¼Œå¤§å¹…æå‡æ‡‰ç”¨ç¨‹å¼çš„äº’å‹•æ€§å’Œä½¿ç”¨è€…æ»¿æ„åº¦ã€‚

## ğŸ¯ å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬ç« å­¸ç¿’å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š

- ğŸ¯ **ç†è§£æµå¼è¼¸å‡ºåŸç†**ï¼šæŒæ¡ Server-Sent Events (SSE) çš„å·¥ä½œæ©Ÿåˆ¶
- ğŸ¯ **å¯¦ç¾ AI æµå¼å›æ‡‰**ï¼šä½¿ç”¨ ChatClient å»ºç«‹æµå¼ AI å°è©±åŠŸèƒ½
- ğŸ¯ **å„ªåŒ–ä½¿ç”¨è€…é«”é©—**ï¼šè®“ AI å›æ‡‰å³æ™‚é¡¯ç¤ºï¼Œé¿å…é•·æ™‚é–“ç­‰å¾…
- ğŸ¯ **è™•ç†æµå¼è³‡æ–™**ï¼šæŒæ¡ Reactive Streams å’ŒèƒŒå£“è™•ç†
- ğŸ¯ **å‰ç«¯æ•´åˆæŠ€è¡“**ï¼šå­¸æœƒä½¿ç”¨ EventSource æ¥æ”¶æµå¼è³‡æ–™

---

## 4.3.1 ç‚ºä»€éº¼éœ€è¦æµå¼è¼¸å‡ºï¼Ÿ

### ä½¿ç”¨è€…é«”é©—çš„é©å‘½

![æµå¼è¼¸å‡º](https://ithelp.ithome.com.tw/upload/images/20240810/20161290gaE6Faz85x.jpg)

ç”±æ–¼ AI ç”¢ç”Ÿå…§å®¹å¾—é ä¼ºæœå™¨é‹ç®—å¾Œç”¢ç”Ÿçµæœï¼Œè³‡æ–™å¤šçš„è©±å¾—ç­‰ä¸å°‘æ™‚é–“ï¼Œè‹¥èƒ½ç”¢ç”Ÿè³‡æ–™å¾Œé¦¬ä¸Šåˆ†æ®µé€å‡ºï¼Œå¯å¤§å¤§æå‡ä½¿ç”¨è€…æ„Ÿå—ã€‚

**å‚³çµ±åŒæ­¥å›æ‡‰ vs æµå¼è¼¸å‡º**ï¼š

```
å‚³çµ±æ–¹å¼ï¼š
ä½¿ç”¨è€…æå• â†’ [ç­‰å¾… 10 ç§’] â†’ å®Œæ•´å›æ‡‰é¡¯ç¤º

æµå¼è¼¸å‡ºï¼š
ä½¿ç”¨è€…æå• â†’ [0.5ç§’] é–‹å§‹é¡¯ç¤º â†’ [æŒçºŒæ›´æ–°] â†’ å®Œæ•´å›æ‡‰
```

**æµå¼è¼¸å‡ºçš„å„ªå‹¢**ï¼š
- âš¡ **å³æ™‚åé¥‹**ï¼šä½¿ç”¨è€…ç«‹å³çœ‹åˆ° AI é–‹å§‹å›æ‡‰
- ğŸ¯ **é™ä½ç„¦æ…®**ï¼šé¿å…é•·æ™‚é–“ç­‰å¾…é€ æˆçš„ä¸ç¢ºå®šæ„Ÿ
- ğŸ“± **æ›´å¥½çš„äº’å‹•æ€§**ï¼šé¡ä¼¼çœŸäººå°è©±çš„é«”é©—
- ğŸš€ **æ„ŸçŸ¥æ•ˆèƒ½æå‡**ï¼šé›–ç„¶ç¸½æ™‚é–“ç›¸åŒï¼Œä½†æ„Ÿè¦ºæ›´å¿«
- ğŸ’¡ **æ—©æœŸä¸­æ–·**ï¼šä½¿ç”¨è€…å¯ä»¥æå‰åˆ¤æ–·å›æ‡‰å“è³ª

### Server-Sent Events (SSE) æŠ€è¡“

è¦é”åˆ°é€™ç¨®æ•ˆæœä¸»è¦é çš„æ˜¯ **Server-Sent Events (SSE)** ä¼ºæœå™¨ä¸»å‹•æ¨æ’­å”å®šï¼š

**SSE ç‰¹é»**ï¼š
- ğŸ“¡ **å–®å‘é€šè¨Š**ï¼šä¼ºæœå™¨å‘å®¢æˆ¶ç«¯æ¨é€è³‡æ–™
- ğŸ”„ **è‡ªå‹•é‡é€£**ï¼šé€£ç·šä¸­æ–·æ™‚è‡ªå‹•é‡æ–°é€£æ¥
- ğŸŒ **æ¨™æº–å”å®š**ï¼šåŸºæ–¼ HTTPï¼Œå»£æ³›æ”¯æ´
- ğŸ’» **ç€è¦½å™¨åŸç”Ÿæ”¯æ´**ï¼šä½¿ç”¨ EventSource API

---

## 4.3.2 ChatClient æµå¼è¼¸å‡ºå¯¦ä½œ

### åŸºæœ¬æµå¼è¼¸å‡º

Spring AI 1.0 GA çš„ ChatClient æä¾›äº†å„ªé›…çš„æµå¼è¼¸å‡º APIã€‚ä»¥ä¸‹æ˜¯ `StreamingAiController` ä¸­å¯¦ç¾åŸºæœ¬æµå¼å°è©±å’Œå¸¶ç³»çµ±æç¤ºè©æµå¼å°è©±çš„ç¯„ä¾‹ï¼š

```java
// ä¾†è‡ª code-examples/chapter4-spring-ai-intro/src/main/java/com/example/springai/controller/StreamingAiController.java
// ... (package and imports omitted for brevity)

@RestController
@RequestMapping("/api/ai")
@RequiredArgsConstructor
@Slf4j
public class StreamingAiController {
    
    private final ChatClient chatClient;

    /**
     * åŸºæœ¬æµå¼ AI å°è©±
     * @param prompt ä½¿ç”¨è€…è¼¸å…¥çš„æç¤ºè©
     * @return æµå¼å­—ä¸²å›æ‡‰
     */
    @GetMapping(value = "/chat/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux<String> chatStream(@RequestParam String prompt) {
        log.info("é–‹å§‹æµå¼å°è©±ï¼š{}", prompt);
        
        return chatClient.prompt()
                .user(prompt)
                .stream()
                .content();
    }
}
```

### ç¨‹å¼ç¢¼é‡é»èªªæ˜

**æ ¸å¿ƒ API**ï¼š
- **`stream()`**: æ›¿ä»£ `call()` ä¾†å•Ÿç”¨æµå¼è¼¸å‡º
- **`content()`**: è¿”å› `Flux<String>` æµå¼å­—ä¸²å…§å®¹
- **`produces = MediaType.TEXT_EVENT_STREAM_VALUE`**: æŒ‡å®šå›æ‡‰æ ¼å¼ç‚º SSE

**Reactive æ“ä½œç¬¦**ï¼š
- **`doOnSubscribe()`**: è¨‚é–±æ™‚åŸ·è¡Œçš„å‹•ä½œ
- **`doOnComplete()`**: å®Œæˆæ™‚åŸ·è¡Œçš„å‹•ä½œ
- **`doOnNext()`**: æ¯å€‹å…ƒç´ ç™¼å‡ºæ™‚åŸ·è¡Œçš„å‹•ä½œ

---

## 4.3.3 é€²éšæµå¼è¼¸å‡ºæ§åˆ¶

### è‡ªå®šç¾©æµå¼è¼¸å‡ºè™•ç†

æ‚¨å¯ä»¥é€é `map`ã€`filter`ã€`doOnNext` ç­‰ Reactive æ“ä½œç¬¦ä¾†è‡ªå®šç¾©æµå¼è¼¸å‡ºçš„è™•ç†é‚è¼¯ï¼š

```java
// ä¾†è‡ª code-examples/chapter4-spring-ai-intro/src/main/java/com/example/springai/controller/StreamingAiController.java
// ... (package and imports omitted for brevity)

@RestController
@RequestMapping("/api/ai")
@RequiredArgsConstructor
@Slf4j
public class StreamingAiController {

    private final ChatClient chatClient;

    // ... å…¶ä»–æ–¹æ³• ...

    /**
     * è‡ªå®šç¾©æµå¼è¼¸å‡ºè™•ç†
     * @param prompt ä½¿ç”¨è€…è¼¸å…¥
     * @return è™•ç†å¾Œçš„æµå¼å›æ‡‰
     */
    @GetMapping(value = "/chat/stream/custom", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux<String> chatStreamCustom(@RequestParam String prompt) {
        return chatClient.prompt()
                .user(prompt)
                .stream()
                .content()
                .map(content -> {
                    // è‡ªå®šç¾©è™•ç†æ¯å€‹æµå¼ç‰‡æ®µ
                    return "ğŸ¤– AI: " + content;
                })
                .filter(content -> {
                    // éæ¿¾ç©ºå…§å®¹
                    return content != null && !content.trim().isEmpty();
                })
                .doOnNext(content -> {
                    // è¨˜éŒ„æ¯å€‹ç‰‡æ®µ
                    log.debug("æµå¼å…§å®¹ï¼š{}", content);
                })
                .onErrorResume(error -> {
                    log.error("æµå¼è¼¸å‡ºéŒ¯èª¤", error);
                    return Flux.just("âŒ æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤ï¼š" + error.getMessage());
                });
    }
}
```

---

## 4.3.4 ä½¿ç”¨ ChatModel çš„æµå¼è¼¸å‡º

å¦‚æœç›´æ¥ä½¿ç”¨ `ChatModel`ï¼Œä¹Ÿå¯ä»¥å¯¦ç¾æµå¼è¼¸å‡ºã€‚`ChatModelService` ç¤ºç¯„äº†å¦‚ä½•ä½¿ç”¨åº•å±¤çš„ `StreamingChatModel` APIï¼š

```java
// ä¾†è‡ª code-examples/chapter4-spring-ai-intro/src/main/java/com/example/springai/service/ChatModelService.java
// ... (package and imports omitted for brevity)

@Service
@RequiredArgsConstructor
@Slf4j
public class ChatModelService {

    // private final ChatModel chatModel; // ç§»é™¤ä¸ç›¸é—œçš„æˆå“¡è®Šæ•¸
    private final StreamingChatModel streamingChatModel;

    /**
     * æµå¼å‘¼å«
     */
    public Flux<String> streamCall(String message) {
        return streamingChatModel.stream(message);
    }
}
```

---

## 4.3.5 æ‡‰ç”¨ç¨‹å¼é…ç½®

### å¿…è¦ä¾è³´

è¦ä½¿ç”¨ Spring AI çš„æµå¼è¼¸å‡ºåŠŸèƒ½ï¼Œå¿…é ˆåŒ…å« WebFlux ä¾è³´ï¼Œå³ä½¿æ˜¯å‘½ä»¤å¼æ‡‰ç”¨ç¨‹å¼ä¹Ÿéœ€è¦ï¼š

```xml
<!-- ä¾†è‡ª code-examples/chapter4-spring-ai-intro/pom.xml -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-webflux</artifactId>
</dependency>

<!-- Spring AI OpenAI Starter -->
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-openai-spring-boot-starter</artifactId>
</dependency>
```

### Spring Boot é…ç½®

ç¢ºä¿åœ¨ `application.yml` ä¸­æ­£ç¢ºè¨­å®šå­—å…ƒç·¨ç¢¼å’Œæµå¼é¸é …ï¼š

```yaml
# ä¾†è‡ª code-examples/chapter4-spring-ai-intro/src/main/resources/application.yml
server:
  port: 8080
  servlet:
    encoding:
      charset: UTF-8
      enabled: true
      force: true

spring:
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      base-url: https://api.openai.com
      chat:
        options:
          model: gpt-4o-mini
          temperature: 0.7
          max-tokens: 1000
          stream: true  # å•Ÿç”¨æµå¼è¼¸å‡º

# æ—¥èªŒé…ç½®
logging:
  level:
    org.springframework.ai: DEBUG
    reactor.netty: INFO
    com.example.springai: DEBUG
```

### è·¨åŸŸé…ç½® (CORS)

å¦‚æœå‰ç«¯å’Œå¾Œç«¯åœ¨ä¸åŒçš„ç¶²åŸŸï¼Œéœ€è¦é…ç½® CORSã€‚ä»¥ä¸‹æ˜¯ `CorsConfig.java` çš„ç¯„ä¾‹ï¼š

```java
// ä¾†è‡ª code-examples/chapter4-spring-ai-intro/src/main/java/com/example/springai/config/CorsConfig.java
// ... (package and imports omitted for brevity)

@Configuration
public class CorsConfig implements WebMvcConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**")
                .allowedOriginPatterns("*")  // å…è¨±æ‰€æœ‰ä¾†æºï¼ˆé–‹ç™¼ç’°å¢ƒä½¿ç”¨ï¼Œç”Ÿç”¢ç’°å¢ƒæ‡‰é™åˆ¶ç‚ºå…·é«”åŸŸåï¼‰
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                .allowedHeaders("*")
                .allowCredentials(true)
                .maxAge(3600);  // é æª¢è«‹æ±‚å¿«å–æ™‚é–“ï¼ˆç§’ï¼‰
    }
}
```

---

## ğŸ“ æœ¬ç« é‡é»å›é¡§

1. **æµå¼è¼¸å‡ºåŸç†**ï¼šç†è§£äº† SSE æŠ€è¡“å’Œæµå¼è¼¸å‡ºçš„å„ªå‹¢
2. **ChatClient æµå¼ API**ï¼šæŒæ¡äº†ä½¿ç”¨ `stream()` æ–¹æ³•å¯¦ç¾æµå¼è¼¸å‡º
3. **Reactive Streams**ï¼šå­¸æœƒäº†ä½¿ç”¨ Flux è™•ç†æµå¼è³‡æ–™
4. **å‰ç«¯æ•´åˆ**ï¼šäº†è§£å¦‚ä½•ä½¿ç”¨ EventSource æ¥æ”¶æµå¼è³‡æ–™
5. **æ•ˆèƒ½å„ªåŒ–**ï¼šæŒæ¡äº†èƒŒå£“è™•ç†ã€éŒ¯èª¤è™•ç†ç­‰æœ€ä½³å¯¦è¸

### æ–°èˆŠç‰ˆæœ¬å°æ¯”

| åŠŸèƒ½ | èˆŠç‰ˆæœ¬ (pre-1.0) | æ–°ç‰ˆæœ¬ (1.0 GA) |
|------|------------------|----------------|
| **API é¢¨æ ¼** | `chatModel.stream(prompt)` | `chatClient.prompt().user(prompt).stream().content()` |
| **å¯è®€æ€§** | è¼ƒä½ | é«˜ï¼ˆFluent APIï¼‰ |
| **åŠŸèƒ½è±å¯Œåº¦** | åŸºç¤ | è±å¯Œï¼ˆç³»çµ±æç¤ºè©ã€é¸é …é…ç½®ç­‰ï¼‰ |
| **éŒ¯èª¤è™•ç†** | éœ€æ‰‹å‹•å¯¦ä½œ | å…§å»ºæ”¯æ´ |
| **æ•ˆèƒ½å„ªåŒ–** | æœ‰é™ | å®Œæ•´çš„ Reactive æ”¯æ´ |

### ä¸‹ä¸€æ­¥å­¸ç¿’æ–¹å‘

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘å€‘å°‡æ·±å…¥æ¢è¨ ChatModel çš„å…§éƒ¨æ©Ÿåˆ¶ï¼Œäº†è§£ä¸åŒ AI æ¨¡å‹çš„ç‰¹æ€§å’Œé¸æ“‡ç­–ç•¥ï¼Œç‚ºä¼æ¥­ç´šæ‡‰ç”¨åšå¥½æº–å‚™ã€‚

---

**åƒè€ƒè³‡æ–™ï¼š**
- [Server-Sent Events Specification](https://html.spec.whatwg.org/multipage/server-sent-events.html)
- [Spring WebFlux Reactive Streams](https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html)
- [Project Reactor Documentation](https://projectreactor.io/docs/core/release/reference/)
- [Spring AI Streaming Documentation](https://docs.spring.io/spring-ai/reference/api/chatclient.html#streaming)
