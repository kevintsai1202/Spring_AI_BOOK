# 4.5 å‰ç«¯è©²å¦‚ä½•è™•ç†æµå¼è¼¸å‡º

> **æœ¬ç« é‡é»**ï¼šæ·±å…¥æ¢è¨å‰ç«¯å¦‚ä½•å„ªé›…åœ°è™•ç† AI æµå¼è¼¸å‡ºï¼Œå»ºç«‹å®Œæ•´çš„å‰å¾Œç«¯æ•´åˆæ–¹æ¡ˆï¼Œç‚ºä½¿ç”¨è€…æä¾›å¦‚åŒ ChatGPT èˆ¬çš„æµæš¢äº’å‹•é«”é©—ã€‚

## ğŸ¯ å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬ç« å­¸ç¿’å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š

- ğŸ¯ **æŒæ¡ EventSource API**ï¼šç†Ÿç·´ä½¿ç”¨ç€è¦½å™¨åŸç”Ÿçš„ SSE æ¥æ”¶æŠ€è¡“
- ğŸ¯ **å¯¦ç¾æµå¼ UI æ›´æ–°**ï¼šå»ºç«‹å³æ™‚æ›´æ–°çš„èŠå¤©ä»‹é¢
- ğŸ¯ **è™•ç†é€£ç·šç®¡ç†**ï¼šæŒæ¡é€£ç·šå»ºç«‹ã€ç¶­è­·å’ŒéŒ¯èª¤è™•ç†
- ğŸ¯ **å„ªåŒ–ä½¿ç”¨è€…é«”é©—**ï¼šå¯¦ç¾æ‰“å­—æ•ˆæœã€è¼‰å…¥ç‹€æ…‹ç­‰äº’å‹•ç´°ç¯€
- ğŸ¯ **æ•´åˆç¾ä»£å‰ç«¯æ¡†æ¶**ï¼šåœ¨ Reactã€Vue ç­‰æ¡†æ¶ä¸­å¯¦ç¾æµå¼åŠŸèƒ½

---

## 4.5.1 EventSource API åŸºç¤

### ä»€éº¼æ˜¯ Server-Sent Events (SSE)ï¼Ÿ

Server-Sent Events æ˜¯ HTML5 æ¨™æº–çš„ä¸€éƒ¨åˆ†ï¼Œå…è¨±ä¼ºæœå™¨å‘ç€è¦½å™¨æ¨é€è³‡æ–™ã€‚èˆ‡ WebSocket ä¸åŒï¼ŒSSE æ˜¯å–®å‘çš„ï¼ˆåƒ…ä¼ºæœå™¨åˆ°å®¢æˆ¶ç«¯ï¼‰ï¼Œä½†å°æ–¼ AI æµå¼è¼¸å‡ºä¾†èªªå·²ç¶“è¶³å¤ ã€‚

**SSE vs WebSocket vs è¼ªè©¢**ï¼š

| ç‰¹æ€§ | SSE | WebSocket | è¼ªè©¢ |
|------|-----|-----------|------|
| **è¤‡é›œåº¦** | ä½ | ä¸­ | ä½ |
| **å³æ™‚æ€§** | é«˜ | é«˜ | ä½ |
| **è³‡æºæ¶ˆè€—** | ä½ | ä¸­ | é«˜ |
| **ç€è¦½å™¨æ”¯æ´** | å»£æ³› | å»£æ³› | å…¨éƒ¨ |
| **è‡ªå‹•é‡é€£** | æ˜¯ | å¦ | å¦ |
| **é©ç”¨å ´æ™¯** | å–®å‘æ¨é€ | é›™å‘é€šè¨Š | ç°¡å–®æŸ¥è©¢ |

### EventSource åŸºæœ¬ç”¨æ³•

ä»¥ä¸‹æ˜¯ `frontend-demo/index.html` ä¸­ EventSource çš„åŸºæœ¬ä½¿ç”¨ç¯„ä¾‹ï¼Œå±•ç¤ºå¦‚ä½•å»ºç«‹é€£ç·šã€ç›£è½è¨Šæ¯å’Œè™•ç†éŒ¯èª¤ï¼š

```javascript
// ä¾†è‡ª code-examples/chapter4-spring-ai-intro/frontend-demo/index.html
// EventSource å¯¦ä¾‹
let eventSource = null;

/**
 * é–‹å§‹æµå¼è¼¸å‡º
 */
function startStreaming() {
    const apiUrl = document.getElementById('apiUrl').value.trim();
    const prompt = document.getElementById('prompt').value.trim();

    if (!prompt) {
        alert('è«‹è¼¸å…¥æç¤ºè©');
        return;
    }

    // æ¸…ç©ºä¹‹å‰çš„å›æ‡‰
    document.getElementById('response').textContent = '';

    // å»ºæ§‹å®Œæ•´çš„ URLï¼ˆåŒ…å«æŸ¥è©¢åƒæ•¸ï¼‰
    const fullUrl = `${apiUrl}?prompt=${encodeURIComponent(prompt)}`;
    console.log('é€£ç·šåˆ°:', fullUrl);

    try {
        // å»ºç«‹ EventSource é€£ç·š
        eventSource = new EventSource(fullUrl);

        // ç›£è½é€£ç·šé–‹å•Ÿäº‹ä»¶
        eventSource.onopen = function(event) {
            console.log('âœ… EventSource é€£ç·šå·²å»ºç«‹', event);
            // updateStatus('connected');
        };

        // ç›£è½è¨Šæ¯äº‹ä»¶ï¼ˆæ¥æ”¶è³‡æ–™ï¼‰
        eventSource.onmessage = function(event) {
            console.log('ğŸ“¨ æ”¶åˆ°è³‡æ–™:', event.data);

            // å°‡æ¥æ”¶åˆ°çš„è³‡æ–™é™„åŠ åˆ°å›æ‡‰å€åŸŸ
            const responseDiv = document.getElementById('response');
            responseDiv.textContent += event.data;

            // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
            responseDiv.scrollTop = responseDiv.scrollHeight;
        };

        // ç›£è½éŒ¯èª¤äº‹ä»¶
        eventSource.onerror = function(event) {
            console.error('âŒ EventSource éŒ¯èª¤:', event);

            if (eventSource.readyState === EventSource.CLOSED) {
                console.log('ğŸ”’ é€£ç·šå·²é—œé–‰');
                // updateStatus('closed');
                // stopStreaming();
            } else {
                // updateStatus('error');
                alert('é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æœå‹™æ˜¯å¦æ­£å¸¸é‹ä½œ');
                // stopStreaming();
            }
        };

    } catch (error) {
        console.error('å»ºç«‹ EventSource å¤±æ•—:', error);
        alert('å»ºç«‹é€£ç·šå¤±æ•—: ' + error.message);
        // stopStreaming();
    }
}

/**
 * åœæ­¢æµå¼è¼¸å‡º
 */
function stopStreaming() {
    if (eventSource) {
        eventSource.close();
        eventSource = null;
        console.log('ğŸ›‘ EventSource é€£ç·šå·²é—œé–‰');
    }
}
```

---

## 4.5.2 å»ºç«‹æµå¼èŠå¤©ä»‹é¢

### HTML çµæ§‹è¨­è¨ˆ

ä»¥ä¸‹æ˜¯ `frontend-demo/streaming-demo.html` çš„æ ¸å¿ƒ HTML çµæ§‹ï¼Œç”¨æ–¼å»ºç«‹ä¸€å€‹é¡ä¼¼ ChatGPT çš„èŠå¤©ä»‹é¢ï¼š

```html
<!-- ä¾†è‡ª code-examples/chapter4-spring-ai-intro/frontend-demo/streaming-demo.html (ç²¾ç°¡ç‰ˆ) -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æµå¼èŠå¤©ä»‹é¢ - Spring AI</title>
    <style>
        /* ... CSS æ¨£å¼ ... */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>ğŸ¤– AI æ™ºèƒ½åŠ©æ‰‹</h1>
                <div class="header-info">Spring AI æµå¼å°è©±å±•ç¤º</div>
            </div>
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">æœªé€£ç·š</span>
            </div>
        </div>

        <div class="chat-container">
            <div class="messages" id="messages">
                <!-- æ­¡è¿è¨Šæ¯ -->
                <div class="message ai">
                    <div class="message-avatar">AI</div>
                    <div class="message-content">
                        <strong>ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯ Spring AI æ™ºèƒ½åŠ©æ‰‹</strong><br><br>
                        <!-- ... æ­¡è¿è¨Šæ¯å…§å®¹ ... -->
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="example-prompts">
                    <button class="example-prompt" onclick="setPrompt('ä»€éº¼æ˜¯ Spring AIï¼Ÿ')">ä»€éº¼æ˜¯ Spring AIï¼Ÿ</button>
                    <!-- ... å…¶ä»–ç¯„ä¾‹æç¤ºè© ... -->
                </div>

                <div class="controls">
                    <button class="control-btn" onclick="clearChat()">ğŸ—‘ï¸ æ¸…é™¤å°è©±</button>
                    <button class="control-btn" id="autoScrollBtn" class="active" onclick="toggleAutoScroll()">ğŸ“œ è‡ªå‹•æ²å‹•</button>
                    <button class="control-btn" onclick="exportChat()">ğŸ’¾ åŒ¯å‡ºå°è©±</button>
                </div>

                <div class="input-wrapper">
                    <textarea
                        id="messageInput"
                        placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ... (Ctrl+Enter ç™¼é€)"
                        rows="1"
                    ></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        â¤
                    </button>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <span id="messageCount">è¨Šæ¯æ•¸ï¼š0</span>
            <span id="apiEndpoint">API: http://localhost:8080</span>
        </div>
    </div>

    <script>
        // ... JavaScript é‚è¼¯ ...
    </script>
</body>
</html>
```

### CSS æ¨£å¼è¨­è¨ˆ

`frontend-demo/streaming-demo.html` å…§åµŒäº†å®Œæ•´çš„ CSS æ¨£å¼ï¼Œç”¨æ–¼ç¾åŒ–èŠå¤©ä»‹é¢ï¼Œå¯¦ç¾é¡ä¼¼ ChatGPT çš„è¦–è¦ºæ•ˆæœã€‚

---

## 4.5.3 JavaScript æµå¼èŠå¤©å¯¦ç¾

### æµå¼è¼¸å‡ºæµç¨‹ç¤ºæ„åœ–

ä»¥ä¸‹æ˜¯å‰ç«¯è™•ç† AI æµå¼è¼¸å‡ºçš„æ•´é«”æµç¨‹ç¤ºæ„åœ–ï¼š

```mermaid
graph TD
    A[ä½¿ç”¨è€…ç™¼é€è«‹æ±‚] --> B(å‰ç«¯æ‡‰ç”¨)
    B --> C{å»ºç«‹ EventSource é€£ç·š}
    C --> D[å¾Œç«¯æœå‹™]
    D -- æµå¼å›æ‡‰ SSE --> E[å‰ç«¯ EventSource ç›£è½å™¨]
    E -- æ¥æ”¶è³‡æ–™å¡Š --> F[æ›´æ–° UI]
    F --> G[é¡¯ç¤º AI å›æ‡‰]
    G -- è‡ªå‹•æ²å‹• --> H[å„ªåŒ–ä½¿ç”¨è€…é«”é©—]
    E -- é€£ç·šé—œé–‰/éŒ¯èª¤ --> I[è™•ç†é€£ç·šç‹€æ…‹]
    I --> J[é¡¯ç¤ºéŒ¯èª¤æˆ–å®Œæˆè¨Šæ¯]
```

---

ä»¥ä¸‹æ˜¯ `frontend-demo/streaming-demo.html` ä¸­å¯¦ç¾æµå¼èŠå¤©åŠŸèƒ½çš„ JavaScript æ ¸å¿ƒé‚è¼¯ï¼ŒåŒ…æ‹¬è¨Šæ¯ç™¼é€ã€EventSource é€£ç·šç®¡ç†ã€UI æ›´æ–°ç­‰ï¼š

```javascript
// ä¾†è‡ª code-examples/chapter4-spring-ai-intro/frontend-demo/streaming-demo.html
// ... (å…¨åŸŸè®Šæ•¸å’Œè¼”åŠ©å‡½æ•¸çœç•¥)

/**
 * ç™¼é€è¨Šæ¯
 */
function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (!message) {
        return;
    }

    // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
    addUserMessage(message);

    // æ¸…ç©ºè¼¸å…¥æ¡†
    input.value = '';
    input.style.height = 'auto';

    // é–‹å§‹ AI å›æ‡‰
    startAiResponse(message);
}

/**
 * é–‹å§‹ AI å›æ‡‰ï¼ˆæµå¼è¼¸å‡ºï¼‰
 */
function startAiResponse(prompt) {
    const messagesDiv = document.getElementById('messages');

    // å»ºç«‹ AI è¨Šæ¯å®¹å™¨
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ai';
    messageDiv.innerHTML = `
        <div class="message-avatar">AI</div>
        <div class="message-content"></div>
    `;

    messagesDiv.appendChild(messageDiv);
    currentAiMessage = messageDiv.querySelector('.message-content');

    // é¡¯ç¤ºè¼¸å…¥ä¸­æŒ‡ç¤ºå™¨
    showTypingIndicator();

    // å»ºç«‹ EventSource é€£ç·š
    const url = `${API_BASE_URL}?prompt=${encodeURIComponent(prompt)}`;
    console.log('é–‹å§‹é€£ç·š:', url);

    try {
        eventSource = new EventSource(url);

        // é€£ç·šé–‹å•Ÿ
        eventSource.onopen = function(event) {
            console.log('âœ… é€£ç·šå·²å»ºç«‹');
            updateConnectionStatus(true);
            hideTypingIndicator();
        };

        // æ¥æ”¶è¨Šæ¯
        eventSource.onmessage = function(event) {
            const data = event.data;
            console.log('ğŸ“¨ æ”¶åˆ°è³‡æ–™:', data);

            if (currentAiMessage) {
                currentAiMessage.textContent += data;
                if (autoScroll) {
                    scrollToBottom();
                }
            }
        };

        // é€£ç·šéŒ¯èª¤
        eventSource.onerror = function(event) {
            console.error('âŒ é€£ç·šéŒ¯èª¤:', event);
            hideTypingIndicator();
            updateConnectionStatus(false);
            closeConnection();

            if (currentAiMessage && !currentAiMessage.textContent) {
                currentAiMessage.innerHTML = '<span style="color: red;">âš ï¸ é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºèªå¾Œç«¯æœå‹™æ˜¯å¦æ­£å¸¸é‹ä½œ</span>';
            }

            messageCount++;
            updateMessageCount();
            currentAiMessage = null;
        };

        // è‡ªå‹•é—œé–‰é€£ç·šï¼ˆæ”¶åˆ°å®Œæ•´å›æ‡‰å¾Œï¼‰
        setTimeout(() => {
            if (eventSource && eventSource.readyState === EventSource.OPEN) {
                closeConnection();
                messageCount++;
                updateMessageCount();
                currentAiMessage = null;
            }
        }, 30000); // 30ç§’è¶…æ™‚

    } catch (error) {
        console.error('å»ºç«‹é€£ç·šå¤±æ•—:', error);
        alert('å»ºç«‹é€£ç·šå¤±æ•—: ' + error.message);
        hideTypingIndicator();
    }
}

// ... (å…¶ä»–è¼”åŠ©å‡½æ•¸å’Œäº‹ä»¶ç›£è½çœç•¥)
```



## ğŸ“ æœ¬ç« é‡é»å›é¡§

1. **EventSource API æŒæ¡**ï¼šå­¸æœƒäº†ä½¿ç”¨ç€è¦½å™¨åŸç”Ÿçš„ SSE æŠ€è¡“æ¥æ”¶æµå¼è³‡æ–™
2. **æµå¼ UI å¯¦ç¾**ï¼šå»ºç«‹äº†å®Œæ•´çš„èŠå¤©ä»‹é¢ï¼ŒåŒ…å«å³æ™‚æ›´æ–°å’Œäº’å‹•æ•ˆæœ
3. **é€£ç·šç®¡ç†**ï¼šæŒæ¡äº†é€£ç·šå»ºç«‹ã€ç¶­è­·ã€éŒ¯èª¤è™•ç†å’Œè‡ªå‹•é‡é€£æ©Ÿåˆ¶
4. **ä½¿ç”¨è€…é«”é©—å„ªåŒ–**ï¼šå¯¦ç¾äº†æ‰“å­—æ•ˆæœã€è¼‰å…¥ç‹€æ…‹ã€æ­·å²ç®¡ç†ç­‰ç´°ç¯€
5. **ç¾ä»£æ¡†æ¶æ•´åˆ**ï¼šå­¸æœƒäº†åœ¨ React ç­‰æ¡†æ¶ä¸­æ•´åˆæµå¼åŠŸèƒ½

### æŠ€è¡“è¦é»ç¸½çµ

| æŠ€è¡“é» | é‡è¦æ€§ | å¯¦ç¾é›£åº¦ | ä½¿ç”¨å ´æ™¯ |
|--------|--------|----------|----------|
| **EventSource API** | â­â­â­ | ä½ | æ‰€æœ‰æµå¼æ‡‰ç”¨ |
| **é€£ç·šç®¡ç†** | â­â­â­ | ä¸­ | ç”Ÿç”¢ç’°å¢ƒå¿…éœ€ |
| **éŒ¯èª¤è™•ç†** | â­â­â­ | ä¸­ | ç©©å®šæ€§ä¿è­‰ |
| **UI å³æ™‚æ›´æ–°** | â­â­ | ä½ | ä½¿ç”¨è€…é«”é©— |
| **è¨˜æ†¶é«”å„ªåŒ–** | â­â­ | ä¸­ | é•·æ™‚é–“ä½¿ç”¨ |
| **è‡ªå‹•é‡é€£** | â­â­ | é«˜ | ç¶²è·¯ä¸ç©©å®šç’°å¢ƒ |

### æœ€ä½³å¯¦è¸å»ºè­°

1. **å§‹çµ‚è™•ç†éŒ¯èª¤**ï¼šEventSource é€£ç·šå¯èƒ½å› å„ç¨®åŸå› ä¸­æ–·
2. **é™åˆ¶è¨Šæ¯æ•¸é‡**ï¼šé¿å…é•·æ™‚é–“ä½¿ç”¨é€ æˆçš„è¨˜æ†¶é«”æ´©æ¼
3. **æä¾›ä½¿ç”¨è€…æ§åˆ¶**ï¼šå…è¨±ä½¿ç”¨è€…åœæ­¢æµå¼æ¥æ”¶
4. **å„ªé›…é™ç´š**ï¼šåœ¨ä¸æ”¯æ´ SSE çš„ç’°å¢ƒä¸­æä¾›æ›¿ä»£æ–¹æ¡ˆ
5. **æ•ˆèƒ½ç›£æ§**ï¼šç›£æ§é€£ç·šç‹€æ…‹å’Œè³‡æºä½¿ç”¨æƒ…æ³
6. **å®‰å…¨æ€§è€ƒé‡**ï¼šä½¿ç”¨ createTextNode é¿å… XSS æ”»æ“Š
7. **é‡é€£å„ªåŒ–**ï¼šåŠ å…¥éš¨æ©ŸæŠ–å‹•é¿å…é›·æ“Šæ•ˆæ‡‰
8. **è³‡æºæ¸…ç†**ï¼šç¢ºä¿çµ„ä»¶å¸è¼‰æ™‚æ­£ç¢ºé—œé–‰é€£ç·š

### ä¸‹ä¸€æ­¥å­¸ç¿’æ–¹å‘

å®Œæˆç¬¬å››ç« çš„å­¸ç¿’å¾Œï¼Œæˆ‘å€‘å·²ç¶“æŒæ¡äº† Spring AI çš„åŸºç¤çŸ¥è­˜å’Œæµå¼è¼¸å‡ºæŠ€è¡“ã€‚åœ¨ç¬¬äº”ç« ä¸­ï¼Œæˆ‘å€‘å°‡é€²å…¥æ›´é€²éšçš„ä¸»é¡Œï¼Œå­¸ç¿’å¦‚ä½•å»ºç«‹å€‹æ€§åŒ–çš„ ChatBotï¼ŒåŒ…æ‹¬æç¤ºè©ç¯„æœ¬ã€å¤šæ¨¡æ…‹è™•ç†ç­‰é«˜ç´šåŠŸèƒ½ã€‚

---

**åƒè€ƒè³‡æ–™ï¼š**
- [Server-Sent Events - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events)
- [EventSource API - MDN](https://developer.mozilla.org/en-US/docs/Web/API/EventSource)
- [React Hooks Documentation](https://reactjs.org/docs/hooks-intro.html)
- [Web Performance Best Practices](https://web.dev/performance/)

```