# 4.5 å‰ç«¯è©²å¦‚ä½•è™•ç†æµå¼è¼¸å‡º

> **å°æ‡‰ç« ç¯€**: Day15
> **å°æ‡‰ç¯„ä¾‹**: `chapter4-spring-ai-intro/frontend-demo`
> **é›£åº¦**: â­â­â­â­â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

å‰ç«¯æ˜¯ä½¿ç”¨è€…é«”é©—çš„é—œéµã€‚æœ¬ç« å°‡æ•™æ‚¨å¦‚ä½•ä½¿ç”¨ EventSource API æ¥æ”¶å¾Œç«¯çš„æµå¼è³‡æ–™ï¼Œå»ºç«‹å¦‚åŒ ChatGPT èˆ¬æµæš¢çš„èŠå¤©ä»‹é¢ã€‚

**å­¸ç¿’ç›®æ¨™**:
- æŒæ¡ EventSource API å’Œ SSE å®¢æˆ¶ç«¯æŠ€è¡“
- å¯¦ç¾å³æ™‚æ›´æ–°çš„èŠå¤© UI
- è™•ç†é€£ç·šç®¡ç†ã€éŒ¯èª¤å’Œé‡é€£
- å„ªåŒ–ä½¿ç”¨è€…é«”é©—ï¼ˆæ‰“å­—æ•ˆæœã€è¼‰å…¥ç‹€æ…‹ï¼‰
- æ•´åˆç¾ä»£å‰ç«¯æ¡†æ¶ï¼ˆReactã€Vueï¼‰

---

## 4.5.1 EventSource API åŸºç¤

### ä»€éº¼æ˜¯ Server-Sent Events (SSE)ï¼Ÿ

Server-Sent Events æ˜¯ HTML5 æ¨™æº–çš„ä¸€éƒ¨åˆ†ï¼Œå…è¨±ä¼ºæœå™¨å‘ç€è¦½å™¨æ¨é€è³‡æ–™ã€‚èˆ‡ WebSocket ä¸åŒï¼ŒSSE æ˜¯å–®å‘çš„ï¼ˆåƒ…ä¼ºæœå™¨åˆ°å®¢æˆ¶ç«¯ï¼‰ï¼Œä½†å°æ–¼ AI æµå¼è¼¸å‡ºä¾†èªªå·²ç¶“è¶³å¤ ã€‚

**SSE vs WebSocket vs è¼ªè©¢**ï¼š

| ç‰¹æ€§ | SSE | WebSocket | è¼ªè©¢ |
|------|-----|-----------|------|
| **è¤‡é›œåº¦** | ä½ | ä¸­ | ä½ |
| **å³æ™‚æ€§** | é«˜ | é«˜ | ä½ |
| **è³‡æºæ¶ˆè€—** | ä½ | ä¸­ | é«˜ |
| **ç€è¦½å™¨æ”¯æ´** | å»£æ³› | å»£æ³› | å…¨éƒ¨ |
| **è‡ªå‹•é‡é€£** | æ˜¯ | å¦ | å¦ |
| **é©ç”¨å ´æ™¯** | å–®å‘æ¨é€ | é›™å‘é€šè¨Š | ç°¡å–®æŸ¥è©¢ |

### EventSource åŸºæœ¬ç”¨æ³•

ä»¥ä¸‹æ˜¯ `frontend-demo/index.html` ä¸­ EventSource çš„åŸºæœ¬ä½¿ç”¨ç¯„ä¾‹ï¼Œå±•ç¤ºå¦‚ä½•å»ºç«‹é€£ç·šã€ç›£è½è¨Šæ¯å’Œè™•ç†éŒ¯èª¤ï¼š

```javascript
// ä¾†è‡ª code-examples/chapter4-spring-ai-intro/frontend-demo/index.html
// EventSource å¯¦ä¾‹
let eventSource = null;

/**
 * é–‹å§‹æµå¼è¼¸å‡º
 */
function startStreaming() {
    const apiUrl = document.getElementById('apiUrl').value.trim();
    const prompt = document.getElementById('prompt').value.trim();

    if (!prompt) {
        alert('è«‹è¼¸å…¥æç¤ºè©');
        return;
    }

    // æ¸…ç©ºä¹‹å‰çš„å›æ‡‰
    document.getElementById('response').textContent = '';

    // å»ºæ§‹å®Œæ•´çš„ URLï¼ˆåŒ…å«æŸ¥è©¢åƒæ•¸ï¼‰
    const fullUrl = `${apiUrl}?prompt=${encodeURIComponent(prompt)}`;
    console.log('é€£ç·šåˆ°:', fullUrl);

    try {
        // å»ºç«‹ EventSource é€£ç·š
        eventSource = new EventSource(fullUrl);

        // ç›£è½é€£ç·šé–‹å•Ÿäº‹ä»¶
        eventSource.onopen = function(event) {
            console.log('âœ… EventSource é€£ç·šå·²å»ºç«‹', event);
            // updateStatus('connected');
        };

        // ç›£è½è¨Šæ¯äº‹ä»¶ï¼ˆæ¥æ”¶è³‡æ–™ï¼‰
        eventSource.onmessage = function(event) {
            console.log('ğŸ“¨ æ”¶åˆ°è³‡æ–™:', event.data);

            // å°‡æ¥æ”¶åˆ°çš„è³‡æ–™é™„åŠ åˆ°å›æ‡‰å€åŸŸ
            const responseDiv = document.getElementById('response');
            responseDiv.textContent += event.data;

            // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
            responseDiv.scrollTop = responseDiv.scrollHeight;
        };

        // ç›£è½éŒ¯èª¤äº‹ä»¶
        eventSource.onerror = function(event) {
            console.error('âŒ EventSource éŒ¯èª¤:', event);

            if (eventSource.readyState === EventSource.CLOSED) {
                console.log('ğŸ”’ é€£ç·šå·²é—œé–‰');
                // updateStatus('closed');
                // stopStreaming();
            } else {
                // updateStatus('error');
                alert('é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æœå‹™æ˜¯å¦æ­£å¸¸é‹ä½œ');
                // stopStreaming();
            }
        };

    } catch (error) {
        console.error('å»ºç«‹ EventSource å¤±æ•—:', error);
        alert('å»ºç«‹é€£ç·šå¤±æ•—: ' + error.message);
        // stopStreaming();
    }
}

/**
 * åœæ­¢æµå¼è¼¸å‡º
 */
function stopStreaming() {
    if (eventSource) {
        eventSource.close();
        eventSource = null;
        console.log('ğŸ›‘ EventSource é€£ç·šå·²é—œé–‰');
    }
}
```

---

## 4.5.2 å»ºç«‹æµå¼èŠå¤©ä»‹é¢

### HTML çµæ§‹è¨­è¨ˆ

ä»¥ä¸‹æ˜¯ `frontend-demo/streaming-demo.html` çš„æ ¸å¿ƒ HTML çµæ§‹ï¼Œç”¨æ–¼å»ºç«‹ä¸€å€‹é¡ä¼¼ ChatGPT çš„èŠå¤©ä»‹é¢ï¼š

```html
<!-- ä¾†è‡ª code-examples/chapter4-spring-ai-intro/frontend-demo/streaming-demo.html (ç²¾ç°¡ç‰ˆ) -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æµå¼èŠå¤©ä»‹é¢ - Spring AI</title>
    <style>
        /* ... CSS æ¨£å¼ ... */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>ğŸ¤– AI æ™ºèƒ½åŠ©æ‰‹</h1>
                <div class="header-info">Spring AI æµå¼å°è©±å±•ç¤º</div>
            </div>
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">æœªé€£ç·š</span>
            </div>
        </div>

        <div class="chat-container">
            <div class="messages" id="messages">
                <!-- æ­¡è¿è¨Šæ¯ -->
                <div class="message ai">
                    <div class="message-avatar">AI</div>
                    <div class="message-content">
                        <strong>ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯ Spring AI æ™ºèƒ½åŠ©æ‰‹</strong><br><br>
                        <!-- ... æ­¡è¿è¨Šæ¯å…§å®¹ ... -->
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="example-prompts">
                    <button class="example-prompt" onclick="setPrompt('ä»€éº¼æ˜¯ Spring AIï¼Ÿ')">ä»€éº¼æ˜¯ Spring AIï¼Ÿ</button>
                    <!-- ... å…¶ä»–ç¯„ä¾‹æç¤ºè© ... -->
                </div>

                <div class="controls">
                    <button class="control-btn" onclick="clearChat()">ğŸ—‘ï¸ æ¸…é™¤å°è©±</button>
                    <button class="control-btn" id="autoScrollBtn" class="active" onclick="toggleAutoScroll()">ğŸ“œ è‡ªå‹•æ²å‹•</button>
                    <button class="control-btn" onclick="exportChat()">ğŸ’¾ åŒ¯å‡ºå°è©±</button>
                </div>

                <div class="input-wrapper">
                    <textarea
                        id="messageInput"
                        placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ... (Ctrl+Enter ç™¼é€)"
                        rows="1"
                    ></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        â¤
                    </button>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <span id="messageCount">è¨Šæ¯æ•¸ï¼š0</span>
            <span id="apiEndpoint">API: http://localhost:8080</span>
        </div>
    </div>

    <script>
        // ... JavaScript é‚è¼¯ ...
    </script>
</body>
</html>
```

### CSS æ¨£å¼è¨­è¨ˆ

`frontend-demo/streaming-demo.html` å…§åµŒäº†å®Œæ•´çš„ CSS æ¨£å¼ï¼Œç”¨æ–¼ç¾åŒ–èŠå¤©ä»‹é¢ï¼Œå¯¦ç¾é¡ä¼¼ ChatGPT çš„è¦–è¦ºæ•ˆæœã€‚

---

## 4.5.3 JavaScript æµå¼èŠå¤©å¯¦ç¾

### æµå¼è¼¸å‡ºæµç¨‹ç¤ºæ„åœ–

ä»¥ä¸‹æ˜¯å‰ç«¯è™•ç† AI æµå¼è¼¸å‡ºçš„æ•´é«”æµç¨‹ç¤ºæ„åœ–ï¼š

```mermaid
graph TD
    A[ä½¿ç”¨è€…ç™¼é€è«‹æ±‚] --> B(å‰ç«¯æ‡‰ç”¨)
    B --> C{å»ºç«‹ EventSource é€£ç·š}
    C --> D[å¾Œç«¯æœå‹™]
    D -- æµå¼å›æ‡‰ SSE --> E[å‰ç«¯ EventSource ç›£è½å™¨]
    E -- æ¥æ”¶è³‡æ–™å¡Š --> F[æ›´æ–° UI]
    F --> G[é¡¯ç¤º AI å›æ‡‰]
    G -- è‡ªå‹•æ²å‹• --> H[å„ªåŒ–ä½¿ç”¨è€…é«”é©—]
    E -- é€£ç·šé—œé–‰/éŒ¯èª¤ --> I[è™•ç†é€£ç·šç‹€æ…‹]
    I --> J[é¡¯ç¤ºéŒ¯èª¤æˆ–å®Œæˆè¨Šæ¯]
```

---

ä»¥ä¸‹æ˜¯ `frontend-demo/streaming-demo.html` ä¸­å¯¦ç¾æµå¼èŠå¤©åŠŸèƒ½çš„ JavaScript æ ¸å¿ƒé‚è¼¯ï¼ŒåŒ…æ‹¬è¨Šæ¯ç™¼é€ã€EventSource é€£ç·šç®¡ç†ã€UI æ›´æ–°ç­‰ï¼š

```javascript
// ä¾†è‡ª code-examples/chapter4-spring-ai-intro/frontend-demo/streaming-demo.html
// ... (å…¨åŸŸè®Šæ•¸å’Œè¼”åŠ©å‡½æ•¸çœç•¥)

/**
 * ç™¼é€è¨Šæ¯
 */
function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (!message) {
        return;
    }

    // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
    addUserMessage(message);

    // æ¸…ç©ºè¼¸å…¥æ¡†
    input.value = '';
    input.style.height = 'auto';

    // é–‹å§‹ AI å›æ‡‰
    startAiResponse(message);
}

/**
 * é–‹å§‹ AI å›æ‡‰ï¼ˆæµå¼è¼¸å‡ºï¼‰
 */
function startAiResponse(prompt) {
    const messagesDiv = document.getElementById('messages');

    // å»ºç«‹ AI è¨Šæ¯å®¹å™¨
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ai';
    messageDiv.innerHTML = `
        <div class="message-avatar">AI</div>
        <div class="message-content"></div>
    `;

    messagesDiv.appendChild(messageDiv);
    currentAiMessage = messageDiv.querySelector('.message-content');

    // é¡¯ç¤ºè¼¸å…¥ä¸­æŒ‡ç¤ºå™¨
    showTypingIndicator();

    // å»ºç«‹ EventSource é€£ç·š
    const url = `${API_BASE_URL}?prompt=${encodeURIComponent(prompt)}`;
    console.log('é–‹å§‹é€£ç·š:', url);

    try {
        eventSource = new EventSource(url);

        // é€£ç·šé–‹å•Ÿ
        eventSource.onopen = function(event) {
            console.log('âœ… é€£ç·šå·²å»ºç«‹');
            updateConnectionStatus(true);
            hideTypingIndicator();
        };

        // æ¥æ”¶è¨Šæ¯
        eventSource.onmessage = function(event) {
            const data = event.data;
            console.log('ğŸ“¨ æ”¶åˆ°è³‡æ–™:', data);

            if (currentAiMessage) {
                currentAiMessage.textContent += data;
                if (autoScroll) {
                    scrollToBottom();
                }
            }
        };

        // é€£ç·šéŒ¯èª¤
        eventSource.onerror = function(event) {
            console.error('âŒ é€£ç·šéŒ¯èª¤:', event);
            hideTypingIndicator();
            updateConnectionStatus(false);
            closeConnection();

            if (currentAiMessage && !currentAiMessage.textContent) {
                currentAiMessage.innerHTML = '<span style="color: red;">âš ï¸ é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºèªå¾Œç«¯æœå‹™æ˜¯å¦æ­£å¸¸é‹ä½œ</span>';
            }

            messageCount++;
            updateMessageCount();
            currentAiMessage = null;
        };

        // è‡ªå‹•é—œé–‰é€£ç·šï¼ˆæ”¶åˆ°å®Œæ•´å›æ‡‰å¾Œï¼‰
        setTimeout(() => {
            if (eventSource && eventSource.readyState === EventSource.OPEN) {
                closeConnection();
                messageCount++;
                updateMessageCount();
                currentAiMessage = null;
            }
        }, 30000); // 30ç§’è¶…æ™‚

    } catch (error) {
        console.error('å»ºç«‹é€£ç·šå¤±æ•—:', error);
        alert('å»ºç«‹é€£ç·šå¤±æ•—: ' + error.message);
        hideTypingIndicator();
    }
}

// ... (å…¶ä»–è¼”åŠ©å‡½æ•¸å’Œäº‹ä»¶ç›£è½çœç•¥)
```



## ğŸ“ æœ¬ç« é‡é»å›é¡§

### EventSource API æ ¸å¿ƒ
âœ… EventSource - ç€è¦½å™¨åŸç”Ÿçš„ SSE å®¢æˆ¶ç«¯
âœ… onmessage - æ¥æ”¶ä¼ºæœå™¨æ¨é€çš„è¨Šæ¯
âœ… onerror - è™•ç†é€£ç·šéŒ¯èª¤å’Œä¸­æ–·
âœ… readyState - ç›£æ§é€£ç·šç‹€æ…‹
âœ… close() - ä¸»å‹•é—œé–‰é€£ç·š

### æµå¼èŠå¤©ä»‹é¢è¦ç´ 
```javascript
// æ ¸å¿ƒæµç¨‹
const eventSource = new EventSource(url);
eventSource.onmessage = (event) => {
    appendContent(event.data);  // é€æ­¥é¡¯ç¤ºå…§å®¹
};
eventSource.onerror = () => {
    handleError();              // éŒ¯èª¤è™•ç†
    eventSource.close();        // é—œé–‰é€£ç·š
};
```

### æŠ€è¡“è¦é»ç¸½çµ

| æŠ€è¡“é» | é‡è¦æ€§ | å¯¦ç¾é›£åº¦ | ä½¿ç”¨å ´æ™¯ |
|--------|--------|----------|----------|
| **EventSource API** | â­â­â­ | ä½ | æ‰€æœ‰æµå¼æ‡‰ç”¨ |
| **é€£ç·šç®¡ç†** | â­â­â­ | ä¸­ | ç”Ÿç”¢ç’°å¢ƒå¿…éœ€ |
| **éŒ¯èª¤è™•ç†** | â­â­â­ | ä¸­ | ç©©å®šæ€§ä¿è­‰ |
| **UI å³æ™‚æ›´æ–°** | â­â­ | ä½ | ä½¿ç”¨è€…é«”é©— |
| **è¨˜æ†¶é«”å„ªåŒ–** | â­â­ | ä¸­ | é•·æ™‚é–“ä½¿ç”¨ |
| **è‡ªå‹•é‡é€£** | â­â­ | é«˜ | ç¶²è·¯ä¸ç©©å®šç’°å¢ƒ |

### React Hook æ•´åˆ
```javascript
// ä½¿ç”¨ useRef ç®¡ç† EventSource å¯¦ä¾‹
const eventSourceRef = useRef(null);

// æ¸…ç†å‰¯ä½œç”¨
useEffect(() => {
    return () => {
        if (eventSourceRef.current) {
            eventSourceRef.current.close();
        }
    };
}, []);
```

### æœ€ä½³å¯¦è¸
1. âœ… å§‹çµ‚è™•ç†éŒ¯èª¤å’Œç•°å¸¸ç‹€æ³
2. âœ… é™åˆ¶è¨Šæ¯æ•¸é‡é¿å…è¨˜æ†¶é«”æ´©æ¼
3. âœ… æä¾›åœæ­¢æŒ‰éˆ•è®“ä½¿ç”¨è€…æ§åˆ¶
4. âœ… ä½¿ç”¨ createTextNode é˜²æ­¢ XSS
5. âœ… é‡é€£æ©Ÿåˆ¶åŠ å…¥éš¨æ©ŸæŠ–å‹•
6. âœ… çµ„ä»¶å¸è¼‰æ™‚æ¸…ç†è³‡æº

### å®Œæ•´åŠŸèƒ½æ¸…å–®
- ğŸ“± å³æ™‚æµå¼é¡¯ç¤º
- â¸ï¸ åœæ­¢æµå¼æ¥æ”¶
- ğŸ”„ è‡ªå‹•éŒ¯èª¤é‡é€£
- ğŸ’¾ å°è©±æ­·å²ç®¡ç†
- ğŸ“Š å­—å…ƒè¨ˆæ•¸å’Œé™åˆ¶
- ğŸ¨ æ‰“å­—å‹•ç•«æ•ˆæœ
- ğŸ“± éŸ¿æ‡‰å¼è¨­è¨ˆ

---

## ğŸš€ ä¸‹ä¸€æ­¥

ğŸ‘‰ ç¬¬äº”ç« ï¼šSpring AI é€²éšåŠŸèƒ½ - æç¤ºè©ç¯„æœ¬ã€å¤šæ¨¡æ…‹è™•ç†ã€Function Calling

---

**ç›¸é—œç« ç¯€**:
- â† ä¸Šä¸€ç« : [4.4 æ·±å…¥äº†è§£ ChatModel](./4.4.md)
- â†’ ä¸‹ä¸€ç« : ç¬¬äº”ç«  Spring AI é€²éšåŠŸèƒ½

**åƒè€ƒè³‡æ–™ï¼š**
- [Server-Sent Events - MDN](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events)
- [EventSource API - MDN](https://developer.mozilla.org/en-US/docs/Web/API/EventSource)
- [React Hooks Documentation](https://reactjs.org/docs/hooks-intro.html)
- [Web Performance Best Practices](https://web.dev/performance/)