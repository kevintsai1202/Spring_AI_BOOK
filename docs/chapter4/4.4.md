# 4.4 æ·±å…¥ç­è§£ ChatModel

> **å°æ‡‰ç« ç¯€**: Day14
> **å°æ‡‰ç¯„ä¾‹**: `chapter4-spring-ai-intro`
> **é›£åº¦**: â­â­â­â­â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

ChatModel æ˜¯ Spring AI çš„æ ¸å¿ƒæŠ½è±¡å±¤ï¼Œçµ±ä¸€äº†ä¸åŒ AI æä¾›å•†çš„ä»‹é¢å·®ç•°ã€‚æœ¬ç« å°‡æ·±å…¥æ¢è¨ ChatModel çš„æ¶æ§‹è¨­è¨ˆã€åƒæ•¸èª¿æ ¡å’Œå¤šæ¨¡å‹æ”¯æ´ç­–ç•¥ã€‚

**å­¸ç¿’ç›®æ¨™**:
- ç†è§£ ChatModel èˆ‡ ChatClient çš„å®Œæ•´æ¶æ§‹é—œä¿‚
- æŒæ¡ AI æ¨¡å‹åƒæ•¸èª¿æ ¡æŠ€å·§
- å­¸æœƒå»ºç«‹å½ˆæ€§çš„å¤šæ¨¡å‹æ”¯æ´æ¶æ§‹
- äº†è§£ä¸åŒæ¨¡å‹çš„ç‰¹æ€§å’Œé©ç”¨å ´æ™¯
- å¯¦ç¾æ™ºèƒ½æ¨¡å‹è·¯ç”±å’Œå®¹éŒ¯æ©Ÿåˆ¶

---

## 4.4.1 Spring AI æ¶æ§‹å…¨è²Œ

### ChatModel vs ChatClient é—œä¿‚åœ–

![ChatModel æ¶æ§‹](https://ithelp.ithome.com.tw/upload/images/20240810/20161290nfq1H0dDoW.jpg)

åˆ°ç›®å‰ç‚ºæ­¢æˆ‘å€‘åšå¾—æ¯”ç›´æ¥ä¸Š ChatGPT ç™¼å•é‚„ä¸å¦‚ï¼ŒChatGPT èµ·ç¢¼é‚„èƒ½è¨˜ä½ä½ æ˜¯èª°ï¼ˆä¸ä¿¡è‡ªå·±å»å•ï¼‰ï¼Œä»Šå¤©æˆ‘å€‘å°±ä¾†æ·±å…¥äº†è§£ Spring AI 1.0 GA ä¸­ ChatClient å’Œ ChatModel çš„å®Œæ•´æ¶æ§‹èˆ‡åŠŸèƒ½ã€‚

```mermaid
graph TD
    subgraph ChatClient
        CC_LAYER[Fluent API Layer]
        CC_PROMPT[prompt]
        CC_SYSTEM[system / user]
        CC_CALL[call / stream]
        CC_CONTENT[content / chatResponse]
        CC_LAYER --> CC_PROMPT
        CC_LAYER --> CC_SYSTEM
        CC_LAYER --> CC_CALL
        CC_LAYER --> CC_CONTENT
    end

    CC_LAYER --> CM_ABSTRACT

    subgraph ChatModel
        CM_ABSTRACT[Model Abstraction]
        CM_CALL_STR[call String]
        CM_CALL_PROMPT[call Prompt]
        CM_STREAM_PROMPT[stream Prompt]
        CM_ABSTRACT --> CM_CALL_STR
        CM_ABSTRACT --> CM_CALL_PROMPT
        CM_ABSTRACT --> CM_STREAM_PROMPT
    end

    CM_ABSTRACT --> PI_LAYER

    subgraph Provider Implementations
        PI_LAYER[Provider Implementations]
        PI_OPENAI[OpenAI<br>ChatModel]
        PI_AZURE[Azure<br>ChatModel]
        PI_GROQ[Groq<br>ChatModel]
        PI_LAYER --> PI_OPENAI
        PI_LAYER --> PI_AZURE
        PI_LAYER --> PI_GROQ
    end
```

### æ¶æ§‹å±¤ç´šèªªæ˜

**1. ChatClientï¼ˆé«˜ç´š API å±¤ï¼‰**
- æä¾›ç¾ä»£åŒ–çš„ Fluent API ä»‹é¢
- é¡ä¼¼æ–¼ Spring ç”Ÿæ…‹ç³»çµ±ä¸­çš„ RestClientã€WebClient
- å…§å»ºå¸¸ç”¨åŠŸèƒ½ï¼šç³»çµ±æç¤ºè©ã€æµå¼è¼¸å‡ºã€éŒ¯èª¤è™•ç†
- æ¨è–¦ç”¨æ–¼å¤§éƒ¨åˆ†æ‡‰ç”¨å ´æ™¯

**2. ChatModelï¼ˆæŠ½è±¡å±¤ï¼‰**
- å®šç¾©èˆ‡ AI æ¨¡å‹äº’å‹•çš„æ ¸å¿ƒä»‹é¢
- æä¾›çµ±ä¸€çš„ API æŠ½è±¡ï¼Œéš±è—ä¸åŒæä¾›å•†çš„å·®ç•°
- æ”¯æ´åŒæ­¥å’Œç•°æ­¥ï¼ˆæµå¼ï¼‰å‘¼å«
- é©åˆéœ€è¦åº•å±¤æ§åˆ¶çš„å ´æ™¯

**3. Provider Implementationsï¼ˆå¯¦ç¾å±¤ï¼‰**
- å„ AI æœå‹™æä¾›å•†çš„å…·é«”å¯¦ç¾
- è™•ç†ç‰¹å®šæä¾›å•†çš„ API å”å®šå’Œèªè­‰
- è² è²¬è«‹æ±‚è½‰æ›å’Œå›æ‡‰è§£æ

---

## 4.4.2 ChatModel æ ¸å¿ƒä»‹é¢

`ChatModel` æä¾›äº†èˆ‡ AI æ¨¡å‹äº’å‹•çš„åº•å±¤ä»‹é¢ã€‚`ChatModelService` é¡åˆ¥å±•ç¤ºäº†å¦‚ä½•ç›´æ¥ä½¿ç”¨ `ChatModel` å’Œ `StreamingChatModel` é€²è¡ŒåŒæ­¥å’Œæµå¼å‘¼å«ï¼š

```java
// ä¾†è‡ª code-examples/chapter4-spring-ai-intro/src/main/java/com/example/springai/service/ChatModelService.java
// ... (package and imports omitted for brevity)

@Service
@RequiredArgsConstructor
@Slf4j
public class ChatModelService {
    
    private final ChatModel chatModel;
    private final StreamingChatModel streamingChatModel;
    
    /**
     * ç°¡å–®å­—ä¸²å‘¼å«
     */
    public String simpleCall(String message) {
        return chatModel.call(message);
    }
    
    /**
     * ä½¿ç”¨ Prompt ç‰©ä»¶çš„å®Œæ•´å‘¼å«
     */
    public ChatResponse fullCall(String systemMessage, String userMessage) {
        Prompt prompt = new Prompt(List.of(
            new SystemMessage(systemMessage),
            new UserMessage(userMessage)
        ));
        
        return chatModel.call(prompt);
    }

    // ... å…¶ä»– ChatModel ç›¸é—œæ–¹æ³• ...
}
```

---

## 4.4.3 AI æ¨¡å‹åƒæ•¸é…ç½®

æ‚¨å¯ä»¥é€é `OpenAiChatOptions` ç­‰é¡åˆ¥ä¾†é…ç½® AI æ¨¡å‹çš„å„ç¨®åƒæ•¸ï¼Œä»¥æ§åˆ¶å…¶è¡Œç‚ºå’Œå›æ‡‰é¢¨æ ¼ã€‚ä»¥ä¸‹æ˜¯ `AiConfig` ä¸­å®šç¾©ä¸åŒèŠå¤©é¸é …çš„ç¯„ä¾‹ï¼š

```java
// ä¾†è‡ª code-examples/chapter4-spring-ai-intro/src/main/java/com/example/springai/config/AiConfig.java

@Configuration
public class AiConfig {
    
    /**
     * é è¨­èŠå¤©é¸é …é…ç½®
     */
    @Bean
    public OpenAiChatOptions defaultChatOptions() {
        return OpenAiChatOptions.builder()
                .withModel(OpenAiApi.ChatModel.GPT_4_O_MINI.getValue())  // æ¨¡å‹é¸æ“‡
                .withTemperature(0.7)      // å‰µæ„åº¦ï¼š0.0-2.0
                .withMaxTokens(1000)       // æœ€å¤§è¼¸å‡º token æ•¸
                .withTopP(1.0)            // æ ¸å¿ƒæ¡æ¨£ï¼š0.0-1.0
                .withFrequencyPenalty(0.0) // é »ç‡æ‡²ç½°ï¼š-2.0-2.0
                .withPresencePenalty(0.0)  // å­˜åœ¨æ‡²ç½°ï¼š-2.0-2.0
                .build();
    }

    /**
     * å‰µæ„å¯«ä½œå°ˆç”¨é…ç½®
     */
    @Bean("creativeChatOptions")
    public OpenAiChatOptions creativeChatOptions() {
        return OpenAiChatOptions.builder()
                .withModel(OpenAiApi.ChatModel.GPT_4_O.getValue())
                .withTemperature(1.2)      // é«˜å‰µæ„åº¦
                .withMaxTokens(2000)       // è¼ƒé•·è¼¸å‡º
                .withTopP(0.9)            // ç¨å¾®é™åˆ¶é¸æ“‡ç¯„åœ
                .withFrequencyPenalty(0.5) // é¿å…é‡è¤‡
                .withPresencePenalty(0.3)  // é¼“å‹µæ–°è©±é¡Œ
                .build();
    }

    /**
     * ç¨‹å¼ç¢¼ç”Ÿæˆå°ˆç”¨é…ç½®
     */
    @Bean("codeChatOptions")
    public OpenAiChatOptions codeChatOptions() {
        return OpenAiChatOptions.builder()
                .withModel(OpenAiApi.ChatModel.GPT_4_O.getValue())
                .withTemperature(0.2)      // ä½å‰µæ„åº¦ï¼Œæ›´ç²¾ç¢º
                .withMaxTokens(1500)       // é©ä¸­è¼¸å‡ºé•·åº¦
                .withTopP(0.95)           // è¼ƒä¿å®ˆçš„é¸æ“‡
                .withFrequencyPenalty(0.0) // ä¸æ‡²ç½°é‡è¤‡ï¼ˆç¨‹å¼ç¢¼å¯èƒ½éœ€è¦é‡è¤‡çµæ§‹ï¼‰
                .withPresencePenalty(0.0)
                .build();
    }
}
```

### åƒæ•¸è©³ç´°èªªæ˜

| åƒæ•¸ | ç¯„åœ | èªªæ˜ | ä½¿ç”¨å»ºè­° |
|------|------|------|----------|
| **Temperature** | 0.0-2.0 | æ§åˆ¶å›æ‡‰çš„éš¨æ©Ÿæ€§å’Œå‰µæ„åº¦ | 0.2ï¼ˆç²¾ç¢ºï¼‰ã€0.7ï¼ˆå¹³è¡¡ï¼‰ã€1.2ï¼ˆå‰µæ„ï¼‰ |
| **Max Tokens** | 1-4096+ | é™åˆ¶å›æ‡‰çš„æœ€å¤§é•·åº¦ | æ ¹æ“šéœ€æ±‚è¨­å®šï¼Œæ³¨æ„æˆæœ¬æ§åˆ¶ |
| **Top P** | 0.0-1.0 | æ ¸å¿ƒæ¡æ¨£ï¼Œæ§åˆ¶è©å½™é¸æ“‡ç¯„åœ | 0.9-1.0 è¼ƒå¸¸ç”¨ |
| **Frequency Penalty** | -2.0-2.0 | æ‡²ç½°é‡è¤‡å‡ºç¾çš„è©å½™ | 0.0-0.5 é¿å…éåº¦é‡è¤‡ |
| **Presence Penalty** | -2.0-2.0 | é¼“å‹µè«‡è«–æ–°è©±é¡Œ | 0.0-0.3 å¢åŠ è©±é¡Œå¤šæ¨£æ€§ |

---

## 4.4.4 å¤šæ¨¡å‹æ”¯æ´æ¶æ§‹

Spring AI å…è¨±æ‚¨é…ç½®å’Œä½¿ç”¨å¤šå€‹ AI æ¨¡å‹ã€‚åœ¨ `AiConfig` ä¸­ï¼Œæ‚¨å¯ä»¥å®šç¾©ä¸åŒæ€§èƒ½å’Œæˆæœ¬æ•ˆç›Šçš„æ¨¡å‹ Beanï¼Œä¸¦åœ¨æ‡‰ç”¨ç¨‹å¼ä¸­éˆæ´»é¸æ“‡ä½¿ç”¨ï¼š

```java
// ä¾†è‡ª code-examples/chapter4-spring-ai-intro/src/main/java/com/example/springai/config/AiConfig.java
@Configuration
public class AiConfig {
    
    @Value("${spring.ai.openai.api-key}")
    private String openaiApiKey;
    
    @Value("${spring.ai.groq.api-key:}")
    private String groqApiKey;
    
    /**
     * é«˜æ€§èƒ½æ¨¡å‹ - GPT-4o
     */
    @Bean("highPerformanceModel")
    public ChatModel highPerformanceModel() {
        var openAiApi = new OpenAiApi(openaiApiKey);
        var options = OpenAiChatOptions.builder()
            .withModel(OpenAiApi.ChatModel.GPT_4_O.getValue())
            .withTemperature(0.7)
            .withMaxTokens(2000)
            .build();
        return new OpenAiChatModel(openAiApi, options);
    }
    
    /**
     * ç¶“æ¿Ÿå‹æ¨¡å‹ - GPT-4o mini (é è¨­)
     */
    @Bean("economicModel")
    @Primary
    public ChatModel economicModel() {
        var openAiApi = new OpenAiApi(openaiApiKey);
        var options = OpenAiChatOptions.builder()
            .withModel(OpenAiApi.ChatModel.GPT_4_O_MINI.getValue())
            .withTemperature(0.7)
            .withMaxTokens(1000)
            .build();
        return new OpenAiChatModel(openAiApi, options);
    }
    
    /**
     * é«˜é€Ÿæ¨¡å‹ - Groq
     */
    @Bean("speedModel")
    public ChatModel speedModel() {
        if (groqApiKey == null || groqApiKey.isEmpty()) {
            return economicModel(); // é™ç´šåˆ°ç¶“æ¿Ÿå‹æ¨¡å‹
        }
        
        var groqApi = new OpenAiApi("https://api.groq.com/openai/v1", groqApiKey);
        var options = OpenAiChatOptions.builder()
            .withModel("llama-3.1-70b-versatile")
            .withTemperature(0.7)
            .withMaxTokens(1000)
            .build();
        return new OpenAiChatModel(groqApi, options);
    }
}
```

### æ™ºèƒ½æ¨¡å‹è·¯ç”±

æ‚¨å¯ä»¥å¯¦ä½œä¸€å€‹æœå‹™ä¾†æ ¹æ“šä¸åŒçš„æ¥­å‹™é‚è¼¯ï¼ˆä¾‹å¦‚ä»»å‹™è¤‡é›œåº¦ã€ä½¿ç”¨è€…ç­‰ç´šï¼‰å‹•æ…‹é¸æ“‡åˆé©çš„ AI æ¨¡å‹ã€‚

---

## ğŸ“ æœ¬ç« é‡é»å›é¡§

### Spring AI æ¶æ§‹åˆ†å±¤
âœ… ChatClient - é«˜ç´š Fluent API å±¤
âœ… ChatModel - æ ¸å¿ƒæŠ½è±¡ä»‹é¢å±¤
âœ… Provider Implementations - AI æœå‹™å¯¦ç¾å±¤
âœ… ä¸‰å±¤æ¶æ§‹ç¢ºä¿éˆæ´»æ€§å’Œå¯ç¶­è­·æ€§

### AI æ¨¡å‹åƒæ•¸èª¿æ ¡

| åƒæ•¸ | ç¯„åœ | å»ºè­°å€¼ | èªªæ˜ |
|------|------|--------|------|
| **temperature** | 0.0-2.0 | 0.2ï¼ˆç²¾ç¢ºï¼‰<br>0.7ï¼ˆå¹³è¡¡ï¼‰<br>1.2ï¼ˆå‰µæ„ï¼‰ | æ§åˆ¶è¼¸å‡ºéš¨æ©Ÿæ€§ |
| **max-tokens** | 1-âˆ | æ ¹æ“šéœ€æ±‚è¨­å®š | é™åˆ¶è¼¸å‡ºé•·åº¦ |
| **top-p** | 0.0-1.0 | 0.9-1.0 | æ ¸å¿ƒæ¡æ¨£åƒæ•¸ |
| **frequency-penalty** | -2.0-2.0 | 0.0-0.5 | é¿å…é‡è¤‡è©å½™ |
| **presence-penalty** | -2.0-2.0 | 0.0-0.3 | é¼“å‹µæ–°è©±é¡Œ |

### å¤šæ¨¡å‹æ”¯æ´ç­–ç•¥
```java
// å®šç¾©ä¸åŒæ€§èƒ½ç´šåˆ¥çš„æ¨¡å‹
@Bean("highPerformanceModel")  // GPT-5 - æœ€å¼·æ€§èƒ½
@Bean("economicModel")          // GPT-4o-mini - ç¶“æ¿Ÿå¯¦æƒ 
@Bean("speedModel")             // Groq - é«˜é€Ÿå…è²»
```

### ChatClient vs ChatModel é¸æ“‡

| å ´æ™¯ | æ¨è–¦é¸æ“‡ | ç†ç”± |
|------|----------|------|
| **ä¸€èˆ¬æ‡‰ç”¨** | ChatClient | Fluent APIï¼Œæ˜“ç”¨æ€§é«˜ |
| **æµå¼è¼¸å‡º** | ChatClient | ç°¡æ½”çš„ stream() API |
| **åº•å±¤æ§åˆ¶** | ChatModel | ç›´æ¥å­˜å– Prompt ç‰©ä»¶ |
| **æ•ˆèƒ½é—œéµ** | ChatModel | æ›´å°‘çš„æŠ½è±¡å±¤ç´š |

### å¯¦ä½œé‡é»
- ä½¿ç”¨ `@Primary` è¨­å®šé è¨­æ¨¡å‹
- ä½¿ç”¨ `@Qualifier` åˆ‡æ›ç‰¹å®šæ¨¡å‹
- å¯¦ç¾æ™ºèƒ½æ¨¡å‹è·¯ç”±é™ç´šç­–ç•¥
- é…ç½®ä¸åŒå ´æ™¯çš„åƒæ•¸çµ„åˆ

---

## ğŸš€ ä¸‹ä¸€æ­¥

ğŸ‘‰ [4.5 å‰ç«¯è™•ç†æµå¼è¼¸å‡º](./4.5.md) - å»ºç«‹å®Œæ•´å‰å¾Œç«¯æ•´åˆ

---

**ç›¸é—œç« ç¯€**:
- â† ä¸Šä¸€ç« : [4.3 æµå¼è¼¸å‡º](./4.3.md)
- â†’ ä¸‹ä¸€ç« : [4.5 å‰ç«¯è™•ç†æµå¼è¼¸å‡º](./4.5.md)

**åƒè€ƒè³‡æ–™ï¼š**
- [Spring AI ChatModel Documentation](https://docs.spring.io/spring-ai/reference/api/chatmodel.html)
- [OpenAI API Parameters](https://platform.openai.com/docs/api-reference/chat/create)
- [Spring Boot Caching](https://docs.spring.io/spring-boot/docs/current/reference/html/io.html#io.caching)
- [Micrometer Metrics](https://micrometer.io/docs)
