# 5.4 èªéŸ³è½‰æ–‡å­— - AI å­—å¹•ç”Ÿæˆç³»çµ±

> **å°æ‡‰ç« ç¯€**: Day12
> **å°æ‡‰ç¯„ä¾‹**: `chapter5-spring-ai-advanced`
> **é›£åº¦**: â­â­â­â˜†â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

èªéŸ³è½‰æ–‡å­— (Speech-to-Text, STT) æ˜¯å°‡éŸ³è¨Šå…§å®¹è½‰æ›ç‚ºæ–‡å­—çš„æŠ€è¡“ã€‚é€é Spring AI æ•´åˆ OpenAI Whisper æ¨¡å‹,å¯ä»¥å¿«é€Ÿå»ºç«‹å°ˆæ¥­çš„å­—å¹•ç”Ÿæˆç³»çµ±,å¤§å¹…æå‡å½±ç‰‡è£½ä½œå’Œå…§å®¹è™•ç†æ•ˆç‡ã€‚

**å­¸ç¿’ç›®æ¨™**:
- ç†è§£èªéŸ³è½‰æ–‡å­—æŠ€è¡“åŸç†
- æŒæ¡ Spring AI AudioTranscriptionModel
- å¯¦ç¾å¤šæ ¼å¼å­—å¹•ç”Ÿæˆ (SRTã€VTTã€JSON)
- å»ºç«‹ä¼æ¥­ç´šå­—å¹•ç”Ÿæˆæœå‹™

---

## ğŸ¯ ç‚ºä»€éº¼éœ€è¦ AI å­—å¹•ç”Ÿæˆ?

### æ‰‹å‹•å­—å¹•çš„ç—›é»

**å‚³çµ±å­—å¹•è£½ä½œæµç¨‹**:
1. ğŸ‘‚ åè¦†æ’­æ”¾éŸ³è¨Šè½å…§å®¹
2. âŒ¨ï¸ æ‰‹å‹•è¼¸å…¥æ–‡å­—
3. â±ï¸ èª¿æ•´æ™‚é–“è»¸å°é½Š
4. ğŸ”„ æ ¡å°å’Œä¿®æ­£éŒ¯èª¤
5. ğŸ’¾ è¼¸å‡ºå¤šç¨®æ ¼å¼

**æ™‚é–“æˆæœ¬**: 1 å°æ™‚å½±ç‰‡éœ€è¦ 4-6 å°æ™‚è£½ä½œå­—å¹•

### AI vs å‚³çµ±å°æ¯”

| æ¯”è¼ƒé …ç›® | å‚³çµ±äººå·¥ | AI è‡ªå‹•ç”Ÿæˆ | å„ªå‹¢ |
|----------|----------|-------------|------|
| **é€Ÿåº¦** | 4-6 å°æ™‚/å°æ™‚å½±ç‰‡ | 2-5 åˆ†é˜/å°æ™‚å½±ç‰‡ | å¿« 50-100 å€ |
| **æˆæœ¬** | $50-100/å°æ™‚ | $0.36/å°æ™‚ | ç¯€çœ 80%+ |
| **æº–ç¢ºåº¦** | 95-98% | 90-95% | éœ€äººå·¥æ ¡å° |
| **æ”¯æ´èªè¨€** | æœ‰é™ | 99+ èªè¨€ | å»£æ³›æ”¯æ´ |
| **æ™‚é–“æˆ³è¨˜** | æ‰‹å‹•èª¿æ•´ | è‡ªå‹•ç”Ÿæˆ | ç²¾ç¢ºå°é½Š |

### æ‡‰ç”¨å ´æ™¯

```mermaid
graph TD
    A[èªéŸ³è½‰æ–‡å­—æŠ€è¡“] --> B[å½±ç‰‡å­—å¹•]
    A --> C[æœƒè­°ç´€éŒ„]
    A --> D[æ’­å®¢æ–‡å­—ç¨¿]
    A --> E[å®¢æœè¨˜éŒ„]
    A --> F[ç„¡éšœç¤™è¼”åŠ©]

    B --> G[YouTube å­—å¹•]
    B --> H[æ•™å­¸å½±ç‰‡]
    C --> I[æœƒè­°æ‘˜è¦]
    D --> J[SEO å„ªåŒ–]
    E --> K[å“è³ªåˆ†æ]
    F --> L[è½éšœè¼”åŠ©]

    style A fill:#e1f5ff
    style B fill:#c8e6c9
    style C fill:#c8e6c9
    style D fill:#c8e6c9
    style E fill:#c8e6c9
    style F fill:#c8e6c9
```

---

## ğŸ—ï¸ Spring AI èªéŸ³è½‰æ–‡å­—æ¶æ§‹

### AudioTranscriptionModel ä»‹é¢

```java
// Spring AI èªéŸ³è½‰æ–‡å­—æ ¸å¿ƒä»‹é¢
public interface AudioTranscriptionModel {

    // è½‰è­¯éŸ³è¨Š
    AudioTranscriptionResponse call(AudioTranscriptionPrompt prompt);

    // ä¸²æµè½‰è­¯ï¼ˆéƒ¨åˆ†æ¨¡å‹æ”¯æ´ï¼‰
    Flux<AudioTranscriptionResponse> stream(AudioTranscriptionPrompt prompt);
}

// è½‰è­¯é¸é …é…ç½®
public class OpenAiAudioTranscriptionOptions {
    private String model;              // æ¨¡å‹: whisper-1
    private String language;           // èªè¨€: zh, en, ja, etc.
    private String responseFormat;     // æ ¼å¼: json, verbose_json, text, srt, vtt
    private Float temperature;         // æº«åº¦: 0.0 ~ 1.0
    private List<String> timestampGranularities; // æ™‚é–“æˆ³è¨˜ç²’åº¦
}
```

### å·¥ä½œæµç¨‹

```mermaid
sequenceDiagram
    participant C as Controller
    participant S as SubtitleService
    participant AI as TranscriptionModel
    participant F as FormatterService

    C->>S: generateSubtitle(file, options)
    S->>S: é©—è­‰æª”æ¡ˆæ ¼å¼å’Œå¤§å°
    S->>S: å»ºç«‹ AudioPrompt

    S->>AI: call(prompt)

    rect rgb(225, 245, 254)
    Note over AI: OpenAI Whisper API
    AI->>AI: éŸ³è¨Šé è™•ç†
    AI->>AI: èªéŸ³è­˜åˆ¥
    AI->>AI: ç”Ÿæˆæ™‚é–“æˆ³è¨˜
    end

    AI-->>S: TranscriptionResponse
    S->>F: formatSubtitle(text, format)
    F->>F: ç”Ÿæˆ SRT/VTT æ ¼å¼
    F-->>S: æ ¼å¼åŒ–å­—å¹•
    S-->>C: SubtitleResponse
```

---

## ğŸ¤ Whisper æ¨¡å‹ä»‹ç´¹

### æ¨¡å‹ç‰¹æ€§

**OpenAI Whisper** æ˜¯ç›®å‰æœ€å…ˆé€²çš„é–‹æºèªéŸ³è­˜åˆ¥æ¨¡å‹:

- âœ… **å¤šèªè¨€æ”¯æ´**: 99+ ç¨®èªè¨€
- âœ… **é«˜æº–ç¢ºåº¦**: è‹±æ–‡ WER < 3%, ä¸­æ–‡ç´„ 5-10%
- âœ… **æ™‚é–“æˆ³è¨˜**: ç²¾ç¢ºåˆ°å­—è©ç´šåˆ¥
- âœ… **é›œè¨ŠæŠ‘åˆ¶**: è‰¯å¥½çš„æŠ—å™ªèƒ½åŠ›
- âœ… **å£éŸ³è­˜åˆ¥**: æ”¯æ´å„ç¨®å£éŸ³

### æœå‹™å•†æ¯”è¼ƒ

| æœå‹™å•† | æ¨¡å‹ | æˆæœ¬ | æ™‚é–“æˆ³è¨˜ | é©ç”¨å ´æ™¯ |
|--------|------|------|----------|----------|
| **OpenAI** | whisper-1 | $0.006/åˆ†é˜ | âœ… å®Œæ•´ | å•†æ¥­æ‡‰ç”¨ã€é«˜å“è³ª |
| **Azure** | whisper-1 | $0.006/åˆ†é˜ | âœ… å®Œæ•´ | ä¼æ¥­éƒ¨ç½²ã€åˆè¦ |
| **Groq** | whisper-large | å…è²» | âŒ ç„¡ | ç´”æ–‡å­—è½‰éŒ„ |
| **æœ¬åœ°éƒ¨ç½²** | whisper-* | ç¡¬é«”æˆæœ¬ | âœ… å®Œæ•´ | éš±ç§æ•æ„Ÿã€é›¢ç·š |

**æˆæœ¬è¨ˆç®—**:
```
30 åˆ†é˜å½±ç‰‡ = $0.18
1 å°æ™‚å½±ç‰‡ = $0.36
100 å°æ™‚å½±ç‰‡ = $36
```

### é›²ç«¯ vs æœ¬åœ°éƒ¨ç½²

```mermaid
graph LR
    A[é¸æ“‡éƒ¨ç½²æ–¹å¼] --> B{ä¸»è¦è€ƒé‡?}
    B -->|é€Ÿåº¦å„ªå…ˆ| C[é›²ç«¯ OpenAI]
    B -->|æˆæœ¬å„ªå…ˆ| D[é›²ç«¯ Groq<br/>ç´”æ–‡å­—]
    B -->|éš±ç§å„ªå…ˆ| E[æœ¬åœ°éƒ¨ç½²]
    B -->|ä¼æ¥­åˆè¦| F[Azure OpenAI]

    style A fill:#e1f5ff
    style C fill:#c8e6c9
    style D fill:#fff4e6
    style E fill:#ffccbc
    style F fill:#c8e6c9
```

---

## ğŸ’» é…ç½®èˆ‡å¯¦ç¾

### æ‡‰ç”¨é…ç½®

```yaml
# å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/src/main/resources/application.yml

spring:
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      audio:
        transcription:
          options:
            model: whisper-1
            response-format: verbose_json  # åŒ…å«æ™‚é–“æˆ³è¨˜
            temperature: 0.0               # æœ€ç¢ºå®šçš„çµæœ
            language: zh                   # æŒ‡å®šèªè¨€æå‡æº–ç¢ºåº¦

  # æª”æ¡ˆä¸Šå‚³é…ç½®
  servlet:
    multipart:
      max-file-size: 25MB     # Whisper API é™åˆ¶
      max-request-size: 25MB
      enabled: true

# è‡ªè¨‚é…ç½®
app:
  subtitle:
    output-directory: ./subtitles
    supported-formats:
      - srt
      - vtt
      - json
      - txt
    max-duration: 3600  # æœ€å¤§è™•ç†æ™‚é•·ï¼ˆç§’ï¼‰
```

### åŸºç¤å­—å¹•ç”Ÿæˆ

```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../service/SubtitleGenerationService.java:28

@Service
@RequiredArgsConstructor
@Slf4j
public class SubtitleGenerationService {

    private final AudioTranscriptionModel transcriptionModel;

    /**
     * åŸºç¤å­—å¹•ç”Ÿæˆ
     */
    public SubtitleResponse generateSubtitle(
            MultipartFile file,
            String format,
            String language) {

        // å»ºç«‹è½‰è­¯é¸é …
        OpenAiAudioTranscriptionOptions options =
            OpenAiAudioTranscriptionOptions.builder()
                .withModel("whisper-1")
                .withResponseFormat("verbose_json")
                .withTemperature(0.0f)
                .withLanguage(language != null ? language : "zh")
                .withTimestampGranularities(List.of("word", "segment"))
                .build();

        // å»ºç«‹éŸ³è¨Šè³‡æº
        Resource audioResource = createAudioResource(file);

        // å»ºç«‹è½‰è­¯è«‹æ±‚
        AudioTranscriptionPrompt prompt =
            new AudioTranscriptionPrompt(audioResource, options);

        // åŸ·è¡Œè½‰è­¯
        AudioTranscriptionResponse response =
            transcriptionModel.call(prompt);

        String transcriptionResult = response.getResult().getOutput();

        // æ ¼å¼åŒ–å­—å¹•
        String formattedSubtitle =
            formatterService.formatSubtitle(transcriptionResult, format);

        return SubtitleResponse.builder()
                .success(true)
                .fileName(file.getOriginalFilename())
                .format(format)
                .language(language)
                .content(formattedSubtitle)
                .fileSize(file.getSize())
                .timestamp(LocalDateTime.now())
                .build();
    }

    /**
     * å°‡ MultipartFile è½‰æ›ç‚º Resource
     */
    private Resource createAudioResource(MultipartFile file) throws IOException {
        Path tempFile = Files.createTempFile("audio-", ".tmp");
        file.transferTo(tempFile.toFile());
        return new FileSystemResource(tempFile.toFile());
    }
}
```

**å¯¦ç¾è¦é»**:
1. âœ… ä½¿ç”¨ `AudioTranscriptionModel` é€²è¡Œè½‰è­¯
2. âœ… `verbose_json` æ ¼å¼åŒ…å«æ™‚é–“æˆ³è¨˜è³‡è¨Š
3. âœ… æŒ‡å®šèªè¨€å¯æå‡ 10-15% æº–ç¢ºåº¦
4. âœ… æº«åº¦è¨­ç‚º 0.0 ç²å¾—æœ€ç©©å®šçµæœ

### å­—å¹•æ ¼å¼åŒ–æœå‹™

```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../service/SubtitleFormatterService.java:15

@Service
@Slf4j
public class SubtitleFormatterService {

    /**
     * å°‡è½‰è­¯çµæœæ ¼å¼åŒ–ç‚ºæŒ‡å®šå­—å¹•æ ¼å¼
     */
    public String formatSubtitle(String transcriptionJson, String format) {
        try {
            ObjectMapper mapper = new ObjectMapper();
            WhisperResponse whisperResponse =
                mapper.readValue(transcriptionJson, WhisperResponse.class);

            return switch (format.toLowerCase()) {
                case "srt" -> formatToSRT(whisperResponse);
                case "vtt" -> formatToVTT(whisperResponse);
                case "json" -> transcriptionJson;
                case "txt" -> formatToPlainText(whisperResponse);
                default -> throw new IllegalArgumentException(
                    "ä¸æ”¯æ´çš„æ ¼å¼: " + format);
            };

        } catch (Exception e) {
            log.error("å­—å¹•æ ¼å¼åŒ–å¤±æ•—", e);
            throw new RuntimeException("å­—å¹•æ ¼å¼åŒ–å¤±æ•—: " + e.getMessage());
        }
    }

    /**
     * æ ¼å¼åŒ–ç‚º SRT æ ¼å¼
     */
    private String formatToSRT(WhisperResponse response) {
        StringBuilder srt = new StringBuilder();
        List<Segment> segments = response.getSegments();

        for (int i = 0; i < segments.size(); i++) {
            Segment segment = segments.get(i);

            // åºè™Ÿ
            srt.append(i + 1).append("\n");

            // æ™‚é–“è»¸
            srt.append(formatTime(segment.getStart()))
               .append(" --> ")
               .append(formatTime(segment.getEnd()))
               .append("\n");

            // æ–‡å­—å…§å®¹
            srt.append(segment.getText().trim()).append("\n\n");
        }

        return srt.toString();
    }

    /**
     * æ ¼å¼åŒ–ç‚º VTT æ ¼å¼
     */
    private String formatToVTT(WhisperResponse response) {
        StringBuilder vtt = new StringBuilder();
        vtt.append("WEBVTT\n\n");

        List<Segment> segments = response.getSegments();

        for (Segment segment : segments) {
            vtt.append(formatTime(segment.getStart()))
               .append(" --> ")
               .append(formatTime(segment.getEnd()))
               .append("\n");

            vtt.append(segment.getText().trim()).append("\n\n");
        }

        return vtt.toString();
    }

    /**
     * æ ¼å¼åŒ–æ™‚é–“æˆ³è¨˜
     * å°‡ç§’æ•¸è½‰æ›ç‚º HH:MM:SS,mmm æ ¼å¼
     */
    private String formatTime(double seconds) {
        int hours = (int) (seconds / 3600);
        int minutes = (int) ((seconds % 3600) / 60);
        int secs = (int) (seconds % 60);
        int millis = (int) ((seconds % 1) * 1000);

        return String.format("%02d:%02d:%02d,%03d",
            hours, minutes, secs, millis);
    }

    /**
     * æ ¼å¼åŒ–ç‚ºç´”æ–‡å­—
     */
    private String formatToPlainText(WhisperResponse response) {
        return response.getText();
    }
}
```

### REST API å¯¦ç¾

```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../controller/SubtitleController.java:22

@RestController
@RequestMapping("/api/subtitle")
@RequiredArgsConstructor
@Slf4j
public class SubtitleController {

    private final SubtitleGenerationService subtitleService;

    /**
     * åŸºç¤å­—å¹•ç”Ÿæˆ
     */
    @PostMapping(value = "/generate",
                 consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public ResponseEntity<SubtitleResponse> generateSubtitle(
            @RequestParam("file") MultipartFile file,
            @RequestParam(value = "format", defaultValue = "srt") String format,
            @RequestParam(value = "language", required = false) String language) {

        try {
            // é©—è­‰æª”æ¡ˆ
            validateAudioFile(file);

            log.info("é–‹å§‹ç”Ÿæˆå­—å¹•: {}, æ ¼å¼: {}", file.getOriginalFilename(), format);

            SubtitleResponse response =
                subtitleService.generateSubtitle(file, format, language);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            log.error("å­—å¹•ç”Ÿæˆå¤±æ•—", e);

            return ResponseEntity.badRequest().body(
                SubtitleResponse.builder()
                    .success(false)
                    .error(e.getMessage())
                    .fileName(file.getOriginalFilename())
                    .build()
            );
        }
    }

    /**
     * æ‰¹æ¬¡å­—å¹•ç”Ÿæˆ
     */
    @PostMapping(value = "/batch-generate",
                 consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public ResponseEntity<List<SubtitleResponse>> batchGenerate(
            @RequestParam("files") MultipartFile[] files,
            @RequestParam(value = "format", defaultValue = "srt") String format) {

        try {
            log.info("æ‰¹æ¬¡ç”Ÿæˆå­—å¹•: {} å€‹æª”æ¡ˆ", files.length);

            List<SubtitleResponse> responses =
                subtitleService.batchGenerateSubtitles(
                    Arrays.asList(files), format);

            return ResponseEntity.ok(responses);

        } catch (Exception e) {
            log.error("æ‰¹æ¬¡ç”Ÿæˆå¤±æ•—", e);
            return ResponseEntity.badRequest().build();
        }
    }

    /**
     * é©—è­‰éŸ³è¨Šæª”æ¡ˆ
     */
    private void validateAudioFile(MultipartFile file) {
        if (file.isEmpty()) {
            throw new IllegalArgumentException("æª”æ¡ˆä¸èƒ½ç‚ºç©º");
        }

        // æª¢æŸ¥æª”æ¡ˆå¤§å°ï¼ˆ25MB é™åˆ¶ï¼‰
        if (file.getSize() > 25 * 1024 * 1024) {
            throw new IllegalArgumentException(
                "æª”æ¡ˆå¤§å°è¶…é 25MB é™åˆ¶");
        }

        // æª¢æŸ¥æª”æ¡ˆé¡å‹
        String contentType = file.getContentType();
        if (contentType == null || !isAudioFile(contentType)) {
            throw new IllegalArgumentException(
                "ä¸æ”¯æ´çš„æª”æ¡ˆé¡å‹: " + contentType);
        }
    }

    private boolean isAudioFile(String contentType) {
        return contentType.startsWith("audio/") ||
               contentType.startsWith("video/");
    }
}
```

---

## ğŸ“Š å­—å¹•æ ¼å¼èªªæ˜

### SRT æ ¼å¼

```
1
00:00:00,000 --> 00:00:03,500
æ­¡è¿ä¾†åˆ° Spring AI æ•™å­¸

2
00:00:03,500 --> 00:00:07,200
ä»Šå¤©æˆ‘å€‘è¦å­¸ç¿’èªéŸ³è½‰æ–‡å­—æŠ€è¡“

3
00:00:07,200 --> 00:00:11,000
ä½¿ç”¨ OpenAI Whisper æ¨¡å‹ç”Ÿæˆå­—å¹•
```

**ç‰¹é»**:
- âœ… æœ€å»£æ³›æ”¯æ´çš„å­—å¹•æ ¼å¼
- âœ… çµæ§‹ç°¡å–®æ˜“è§£æ
- âœ… æ”¯æ´æ‰€æœ‰ä¸»æµæ’­æ”¾å™¨

### VTT æ ¼å¼

```
WEBVTT

00:00:00.000 --> 00:00:03.500
æ­¡è¿ä¾†åˆ° Spring AI æ•™å­¸

00:00:03.500 --> 00:00:07.200
ä»Šå¤©æˆ‘å€‘è¦å­¸ç¿’èªéŸ³è½‰æ–‡å­—æŠ€è¡“

00:00:07.200 --> 00:00:11.000
ä½¿ç”¨ OpenAI Whisper æ¨¡å‹ç”Ÿæˆå­—å¹•
```

**ç‰¹é»**:
- âœ… HTML5 æ¨™æº–æ ¼å¼
- âœ… æ”¯æ´æ¨£å¼å’Œå®šä½
- âœ… ç¶²é æ’­æ”¾å™¨é¦–é¸

### JSON æ ¼å¼

```json
{
  "task": "transcribe",
  "language": "zh",
  "duration": 180.5,
  "text": "å®Œæ•´è½‰è­¯æ–‡å­—...",
  "segments": [
    {
      "id": 0,
      "start": 0.0,
      "end": 3.5,
      "text": "æ­¡è¿ä¾†åˆ° Spring AI æ•™å­¸",
      "words": [...]
    }
  ]
}
```

**ç‰¹é»**:
- âœ… åŒ…å«å®Œæ•´è©³ç´°è³‡è¨Š
- âœ… æ”¯æ´å­—è©ç´šåˆ¥æ™‚é–“æˆ³è¨˜
- âœ… ä¾¿æ–¼ç¨‹å¼åŒ–è™•ç†

---

## ğŸ’¡ æœ€ä½³å¯¦è¸

### 1. éŸ³è¨Šé è™•ç†

```java
/**
 * éŸ³è¨Šå“è³ªå„ªåŒ–
 */
public Resource preprocessAudio(MultipartFile file) {
    try {
        // è½‰æ›ç‚º WAV æ ¼å¼ï¼ˆå¯é¸ï¼‰
        // é™å™ªè™•ç†ï¼ˆå¯é¸ï¼‰
        // æ¨™æº–åŒ–éŸ³é‡ï¼ˆå¯é¸ï¼‰

        // ç°¡åŒ–å¯¦ç¾ï¼šç›´æ¥ä½¿ç”¨åŸæª”æ¡ˆ
        return file.getResource();

    } catch (Exception e) {
        throw new RuntimeException("éŸ³è¨Šé è™•ç†å¤±æ•—", e);
    }
}
```

**å»ºè­°**:
- âœ… ä½¿ç”¨é«˜å“è³ªéŸ³è¨Šï¼ˆ128kbps+ï¼‰
- âœ… ç§»é™¤èƒŒæ™¯éŸ³æ¨‚å’Œå™ªéŸ³
- âœ… æ¨™æº–åŒ–éŸ³é‡åˆ° -3dB ~ 0dB
- âŒ é¿å…éåº¦å£“ç¸®å’Œå¤±çœŸ

### 2. èªè¨€è¨­å®šå„ªåŒ–

```java
/**
 * æ™ºèƒ½èªè¨€æª¢æ¸¬
 */
public String detectLanguage(MultipartFile file) {
    // æ–¹æ¡ˆ1: ä½¿ç”¨çŸ­ç‰‡æ®µæª¢æ¸¬
    // å…ˆç”¨ç„¡èªè¨€åƒæ•¸è½‰è­¯ä¸€å°æ®µ,æ ¹æ“šçµæœåˆ¤æ–·

    // æ–¹æ¡ˆ2: æ ¹æ“šæª”æ¡ˆåç¨±æ¨æ¸¬
    String filename = file.getOriginalFilename();
    if (filename != null) {
        if (filename.contains("_zh") || filename.contains("ä¸­æ–‡")) {
            return "zh";
        } else if (filename.contains("_en")) {
            return "en";
        }
    }

    // é è¨­è¿”å›ä¸­æ–‡
    return "zh";
}
```

**èªè¨€ä»£ç¢¼**:
- `zh` - ä¸­æ–‡ï¼ˆç°¡ç¹é€šç”¨ï¼‰
- `en` - è‹±æ–‡
- `ja` - æ—¥æ–‡
- `ko` - éŸ“æ–‡
- `es` - è¥¿ç­ç‰™æ–‡

### 3. éŒ¯èª¤è™•ç†èˆ‡é‡è©¦

```java
/**
 * å¸¶é‡è©¦æ©Ÿåˆ¶çš„å­—å¹•ç”Ÿæˆ
 */
public SubtitleResponse generateWithRetry(
        MultipartFile file,
        String format,
        int maxRetries) {

    int attempts = 0;
    Exception lastException = null;

    while (attempts < maxRetries) {
        try {
            return generateSubtitle(file, format, null);

        } catch (Exception e) {
            lastException = e;
            attempts++;

            if (attempts < maxRetries) {
                log.warn("å­—å¹•ç”Ÿæˆå¤±æ•—ï¼Œé‡è©¦ {}/{}", attempts, maxRetries);

                try {
                    Thread.sleep(2000 * attempts); // æŒ‡æ•¸é€€é¿
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    break;
                }
            }
        }
    }

    throw new RuntimeException("å­—å¹•ç”Ÿæˆå¤±æ•—", lastException);
}
```

### 4. æ‰¹æ¬¡è™•ç†å„ªåŒ–

```java
/**
 * éåŒæ­¥æ‰¹æ¬¡å­—å¹•ç”Ÿæˆ
 */
@Async
public CompletableFuture<SubtitleResponse> generateAsync(
        MultipartFile file, String format) {

    return CompletableFuture.supplyAsync(() ->
        generateSubtitle(file, format, null)
    );
}

/**
 * ä¸¦è¡Œè™•ç†å¤šå€‹æª”æ¡ˆ
 */
public List<SubtitleResponse> batchGenerateParallel(
        List<MultipartFile> files, String format) {

    List<CompletableFuture<SubtitleResponse>> futures =
        files.stream()
            .map(file -> generateAsync(file, format))
            .collect(Collectors.toList());

    // ç­‰å¾…æ‰€æœ‰ä»»å‹™å®Œæˆ
    CompletableFuture.allOf(
        futures.toArray(new CompletableFuture[0])
    ).join();

    // æ”¶é›†çµæœ
    return futures.stream()
            .map(CompletableFuture::join)
            .collect(Collectors.toList());
}
```

---

## ğŸ“ é‡é»å›é¡§

### èªéŸ³è½‰æ–‡å­—çš„åƒ¹å€¼
âœ… **æ•ˆç‡æå‡**: æ¯”æ‰‹å‹•å¿« 50-100 å€
âœ… **æˆæœ¬é™ä½**: ç¯€çœ 80%+ æˆæœ¬
âœ… **å¤šèªè¨€**: æ”¯æ´ 99+ ç¨®èªè¨€
âœ… **é«˜æº–ç¢ºåº¦**: ä¸­æ–‡è­˜åˆ¥ç‡ 90-95%
âœ… **è‡ªå‹•æ™‚é–“è»¸**: ç²¾ç¢ºåˆ°å­—è©ç´šåˆ¥

### æŠ€è¡“è¦é»
- **AudioTranscriptionModel**: Spring AI è½‰è­¯æ ¸å¿ƒ
- **Whisper æ¨¡å‹**: OpenAI æœ€å…ˆé€²çš„ STT æ¨¡å‹
- **æ ¼å¼æ”¯æ´**: SRTã€VTTã€JSONã€TXT
- **èªè¨€å„ªåŒ–**: æŒ‡å®šèªè¨€æå‡æº–ç¢ºåº¦
- **æ‰¹æ¬¡è™•ç†**: éåŒæ­¥è™•ç†æå‡æ•ˆç‡

### æ‡‰ç”¨å ´æ™¯
- ğŸ¬ å½±ç‰‡å­—å¹•ç”Ÿæˆ
- ğŸ“ æœƒè­°è¨˜éŒ„è½‰éŒ„
- ğŸ™ï¸ æ’­å®¢æ–‡å­—ç¨¿
- ğŸ“ å®¢æœè¨˜éŒ„åˆ†æ
- â™¿ ç„¡éšœç¤™è¼”åŠ©æœå‹™

---

## ğŸš€ ä¸‹ä¸€æ­¥

ğŸ‘‰ [5.5 æ–‡å­—è½‰èªéŸ³](./5.5.md) - å­¸ç¿’ AI é…éŸ³æŠ€è¡“
ğŸ‘‰ [5.6 Function Calling åŸºç¤](./5.6.md) - AI å·¥å…·èª¿ç”¨å…¥é–€

---

**ç›¸é—œç« ç¯€**:
- â† ä¸Šä¸€ç« : [5.3 åœ–ç‰‡ç”Ÿæˆ](./5.3.md)
- â†’ ä¸‹ä¸€ç« : [5.5 æ–‡å­—è½‰èªéŸ³](./5.5.md)

**åƒè€ƒè³‡æ–™**:
- [Spring AI Audio Transcription](https://docs.spring.io/spring-ai/reference/api/audio/transcriptions/)
- [OpenAI Whisper API](https://platform.openai.com/docs/guides/speech-to-text)
- [SRT Format Specification](https://en.wikipedia.org/wiki/SubRip)
- [WebVTT Standard](https://www.w3.org/TR/webvtt1/)
