# 5.4 做一個字幕產生器

> **本章重點**：學習使用 Spring AI 的語音轉文字功能，建立完整的字幕產生系統，掌握音訊處理和多格式字幕輸出技術，為多媒體內容處理提供專業解決方案。

## 🎯 學習目標

完成本章學習後，您將能夠：

- 🎯 **理解語音轉文字技術**：掌握 Whisper 模型的工作原理和應用場景
- 🎯 **實現音訊檔案處理**：建立完整的音訊上傳和轉譯功能
- 🎯 **生成多格式字幕**：支援 SRT、VTT、JSON 等多種字幕格式
- 🎯 **優化轉譯品質**：掌握語言設定、溫度調整等優化技巧
- 🎯 **企業級應用設計**：建立可商用的字幕生成服務系統

---

## 5.4.1 語音轉文字技術革命

### 上字幕不再痛苦

![字幕產生器](https://ithelp.ithome.com.tw/upload/images/20240810/20161290jCx3iLQjtI.jpg)

相信很多人知道 OpenAI 開源了 Whisper 模型，網路上也很多人製作本機端的字幕產生程式，凱文大叔試過，只能說慘不忍睹，由於電腦沒有獨立顯卡，不到 30 分鐘的影片竟然一個小時還沒完成。

這時就很適合用平台的算力來協助了！

### 雲端 vs 本地處理對比

| 處理方式 | 優勢 | 劣勢 | 適用場景 |
|----------|------|------|----------|
| **雲端處理** | 速度快、品質高、無硬體要求 | 需要網路、有使用成本 | 商業應用、大量處理 |
| **本地處理** | 隱私保護、無網路依賴 | 速度慢、硬體要求高 | 敏感內容、離線環境 |

**成本效益分析**：
- 🕐 **時間成本**：雲端處理 30 分鐘影片約 2-3 分鐘，本地可能需要 1-2 小時
- 💰 **金錢成本**：OpenAI Whisper 約 $0.006/分鐘，22MB 四分多鐘影片約 $0.03
- 🔧 **硬體成本**：雲端無需投資 GPU，本地需要高階顯卡

### Spring AI 音訊轉譯支援

![Spring AI 音訊支援](https://ithelp.ithome.com.tw/upload/images/20240807/201612904zZn4fPMwh.png)

音頻轉譯在 Spring AI 的文件中主要支援：
- **OpenAI Whisper**：功能完整，支援時間戳記
- **Azure OpenAI**：企業級部署，合規性佳
- **Groq**：速度快但功能受限（無時間戳記）

**重要提醒**：原本想說可以用 Groq 省錢，不過凱文大叔實際測試發現 Groq 閹割了很多功能，只能產生純文字，字幕最重要的時間戳記卻無法產生，若單純產生文字稿還是能用，需要時間戳記就只能花點小錢了。

---
### 應用程式配置

```yaml
# application.yml
spring:
  application:
    name: subtitle-generator
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      base-url: https://api.openai.com
      audio:
        transcription:
          options:
            model: whisper-1
            response-format: verbose_json  # 包含時間戳記的詳細格式
            temperature: 0.0  # 最確定的結果
            language: zh  # 指定中文可提升準確度
            # timestamp-granularities 參數需在程式碼中設定
  
  # 檔案上傳配置
  servlet:
    multipart:
      max-file-size: 25MB  # Whisper 的檔案大小限制
      max-request-size: 25MB
      enabled: true

# 應用程式配置
app:
  subtitle:
    output-directory: ./subtitles
    supported-formats: ["srt", "vtt", "json", "txt"]
    max-duration: 3600  # 最大處理時長（秒）
    default-language: zh

# 伺服器配置
server:
  port: 8080
  servlet:
    context-path: /api

# 日誌配置
logging:
  level:
    org.springframework.ai: DEBUG
    com.example: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
```

---

## 5.4.2 基礎字幕生成功能

### 音訊轉譯控制器

```java

@RestController
@RequestMapping("/subtitle")
@RequiredArgsConstructor
@Slf4j
public class SubtitleController {
    
    private final SubtitleGenerationService subtitleService;
    
    /**
     * 基礎字幕生成
     * @param file 音訊或影片檔案
     * @param format 輸出格式（srt, vtt, json, txt）
     * @param language 語言代碼（可選）
     * @return 字幕內容
     */
    @PostMapping(value = "/generate", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public ResponseEntity<SubtitleResponse> generateSubtitle(
            @RequestParam("file") MultipartFile file,
            @RequestParam(value = "format", defaultValue = "srt") String format,
            @RequestParam(value = "language", required = false) String language) {
        
        try {
            // 驗證檔案
            validateAudioFile(file);
            
            log.info("開始處理字幕生成：檔案={}, 格式={}, 語言={}", 
                    file.getOriginalFilename(), format, language);
            
            // 生成字幕
            SubtitleResponse response = subtitleService.generateSubtitle(
                    file, format, language
            );
            
            log.info("字幕生成完成：{}", file.getOriginalFilename());
            
            return ResponseEntity.ok(response);
            
        } catch (Exception e) {
            log.error("字幕生成失敗：{}", file.getOriginalFilename(), e);
            
            SubtitleResponse errorResponse = SubtitleResponse.builder()
                    .success(false)
                    .error(e.getMessage())
                    .fileName(file.getOriginalFilename())
                    .build();
            
            return ResponseEntity.badRequest().body(errorResponse);
        }
    }
    
    /**
     * 進階字幕生成（支援更多選項）
     * @param file 音訊檔案
     * @param request 生成選項
     * @return 字幕回應
     */
    @PostMapping(value = "/generate-advanced", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public ResponseEntity<SubtitleResponse> generateAdvancedSubtitle(
            @RequestParam("file") MultipartFile file,
            @ModelAttribute SubtitleRequest request) {
        
        try {
            validateAudioFile(file);
            
            log.info("開始進階字幕生成：{}", request);
            
            SubtitleResponse response = subtitleService.generateAdvancedSubtitle(
                    file, request
            );
            
            return ResponseEntity.ok(response);
            
        } catch (Exception e) {
            log.error("進階字幕生成失敗", e);
            
            SubtitleResponse errorResponse = SubtitleResponse.builder()
                    .success(false)
                    .error(e.getMessage())
                    .fileName(file.getOriginalFilename())
                    .build();
            
            return ResponseEntity.badRequest().body(errorResponse);
        }
    }
    
    /**
     * 批次字幕生成
     * @param files 多個音訊檔案
     * @param format 輸出格式
     * @return 批次處理結果
     */
    @PostMapping(value = "/batch-generate", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public ResponseEntity<List<SubtitleResponse>> batchGenerateSubtitles(
            @RequestParam("files") MultipartFile[] files,
            @RequestParam(value = "format", defaultValue = "srt") String format) {
        
        try {
            log.info("開始批次字幕生成：{} 個檔案", files.length);
            
            List<SubtitleResponse> responses = subtitleService.batchGenerateSubtitles(
                    Arrays.asList(files), format
            );
            
            return ResponseEntity.ok(responses);
            
        } catch (Exception e) {
            log.error("批次字幕生成失敗", e);
            return ResponseEntity.badRequest().build();
        }
    }
}
```

### 字幕生成服務

```java
@Service
@RequiredArgsConstructor
@Slf4j
public class SubtitleGenerationService {
    
    private final AudioTranscriptionModel transcriptionModel;
    private final SubtitleFormatterService formatterService;
    
    /**
     * 基礎字幕生成
     * @param file 音訊檔案
     * @param format 輸出格式
     * @param language 語言（可選）
     * @return 字幕回應
     */
    public SubtitleResponse generateSubtitle(
            MultipartFile file, 
            String format, 
            String language) {
        
        try {
            // 建立轉譯選項
            OpenAiAudioTranscriptionOptions options = OpenAiAudioTranscriptionOptions.builder()
                    .withModel("whisper-1")
                    .withResponseFormat("verbose_json")  // 包含時間戳記
                    .withTemperature(0.0f)
                    .withLanguage(language != null ? language : "zh")
                    .withTimestampGranularities(List.of("word", "segment"))
                    .build();
            
            // 建立音訊資源
            Resource audioResource = createAudioResource(file);
            
            // 建立轉譯請求
            AudioTranscriptionPrompt prompt = new AudioTranscriptionPrompt(
                    audioResource, options
            );
            
            // 執行轉譯
            AudioTranscriptionResponse response = transcriptionModel.call(prompt);
            String transcriptionResult = response.getResult().getOutput();
            
            // 格式化字幕
            String formattedSubtitle = formatterService.formatSubtitle(
                    transcriptionResult, format
            );
            
            return SubtitleResponse.builder()
                    .success(true)
                    .fileName(file.getOriginalFilename())
                    .format(format)
                    .language(language != null ? language : "zh")
                    .content(formattedSubtitle)
                    .fileSize(file.getSize())
                    .processingTime(calculateProcessingTime())
                    .timestamp(LocalDateTime.now())
                    .build();
            
        } catch (Exception e) {
            log.error("字幕生成失敗：{}", file.getOriginalFilename(), e);
            throw new RuntimeException("字幕生成失敗：" + e.getMessage(), e);
        }
    }
}
```
---
## 📝 本章重點回顧

1. **語音轉文字技術**：掌握了 Whisper 模型的工作原理和雲端處理優勢
2. **多格式字幕輸出**：實現了 SRT、VTT、JSON、TXT 等多種字幕格式

### 成本效益分析

**OpenAI Whisper 定價**：
- 💰 **成本**：$0.006 per minute
- ⏱️ **速度**：通常比音訊時長快 5-10 倍
- 🎯 **準確度**：中文識別準確率 > 95%
- 📊 **性價比**：相比人工字幕製作節省 80% 成本

### 最佳實踐建議

1. **檔案預處理**：確保音訊品質，移除背景噪音
2. **語言設定**：正確設定語言可提升 10-15% 準確度
3. **溫度調整**：使用 0.0 溫度獲得最穩定結果
4. **批次處理**：大量檔案使用非同步處理提升效率
5. **品質檢查**：實施自動品質評估和人工校對流程

### 下一步學習方向

在下一章中，我們將學習文字轉語音技術，探索如何讓 AI 幫你配音，建立完整的語音合成應用。

---

**參考資料：**
- [Spring AI Audio Transcription Documentation](https://docs.spring.io/spring-ai/reference/api/audio.html)
- [OpenAI Whisper API](https://platform.openai.com/docs/guides/speech-to-text)
- [SRT Subtitle Format Specification](https://en.wikipedia.org/wiki/SubRip)
- [WebVTT Specification](https://www.w3.org/TR/webvtt1/)