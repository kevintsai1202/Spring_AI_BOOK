# 5.4 åšä¸€å€‹å­—å¹•ç”¢ç”Ÿå™¨

> **æœ¬ç« é‡é»**ï¼šå­¸ç¿’ä½¿ç”¨ Spring AI çš„èªéŸ³è½‰æ–‡å­—åŠŸèƒ½ï¼Œå»ºç«‹å®Œæ•´çš„å­—å¹•ç”¢ç”Ÿç³»çµ±ï¼ŒæŒæ¡éŸ³è¨Šè™•ç†å’Œå¤šæ ¼å¼å­—å¹•è¼¸å‡ºæŠ€è¡“ï¼Œç‚ºå¤šåª’é«”å…§å®¹è™•ç†æä¾›å°ˆæ¥­è§£æ±ºæ–¹æ¡ˆã€‚

## ğŸ¯ å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬ç« å­¸ç¿’å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š

- ğŸ¯ **ç†è§£èªéŸ³è½‰æ–‡å­—æŠ€è¡“**ï¼šæŒæ¡ Whisper æ¨¡å‹çš„å·¥ä½œåŸç†å’Œæ‡‰ç”¨å ´æ™¯
- ğŸ¯ **å¯¦ç¾éŸ³è¨Šæª”æ¡ˆè™•ç†**ï¼šå»ºç«‹å®Œæ•´çš„éŸ³è¨Šä¸Šå‚³å’Œè½‰è­¯åŠŸèƒ½
- ğŸ¯ **ç”Ÿæˆå¤šæ ¼å¼å­—å¹•**ï¼šæ”¯æ´ SRTã€VTTã€JSON ç­‰å¤šç¨®å­—å¹•æ ¼å¼
- ğŸ¯ **å„ªåŒ–è½‰è­¯å“è³ª**ï¼šæŒæ¡èªè¨€è¨­å®šã€æº«åº¦èª¿æ•´ç­‰å„ªåŒ–æŠ€å·§
- ğŸ¯ **ä¼æ¥­ç´šæ‡‰ç”¨è¨­è¨ˆ**ï¼šå»ºç«‹å¯å•†ç”¨çš„å­—å¹•ç”Ÿæˆæœå‹™ç³»çµ±

---

## 5.4.1 èªéŸ³è½‰æ–‡å­—æŠ€è¡“é©å‘½

### ä¸Šå­—å¹•ä¸å†ç—›è‹¦

![å­—å¹•ç”¢ç”Ÿå™¨](https://ithelp.ithome.com.tw/upload/images/20240810/20161290jCx3iLQjtI.jpg)

ç›¸ä¿¡å¾ˆå¤šäººçŸ¥é“ OpenAI é–‹æºäº† Whisper æ¨¡å‹ï¼Œç¶²è·¯ä¸Šä¹Ÿå¾ˆå¤šäººè£½ä½œæœ¬æ©Ÿç«¯çš„å­—å¹•ç”¢ç”Ÿç¨‹å¼ï¼Œå‡±æ–‡å¤§å”è©¦éï¼Œåªèƒ½èªªæ…˜ä¸å¿ç¹ï¼Œç”±æ–¼é›»è…¦æ²’æœ‰ç¨ç«‹é¡¯å¡ï¼Œä¸åˆ° 30 åˆ†é˜çš„å½±ç‰‡ç«Ÿç„¶ä¸€å€‹å°æ™‚é‚„æ²’å®Œæˆã€‚

é€™æ™‚å°±å¾ˆé©åˆç”¨å¹³å°çš„ç®—åŠ›ä¾†å”åŠ©äº†ï¼

### é›²ç«¯ vs æœ¬åœ°è™•ç†å°æ¯”

| è™•ç†æ–¹å¼ | å„ªå‹¢ | åŠ£å‹¢ | é©ç”¨å ´æ™¯ |
|----------|------|------|----------|
| **é›²ç«¯è™•ç†** | é€Ÿåº¦å¿«ã€å“è³ªé«˜ã€ç„¡ç¡¬é«”è¦æ±‚ | éœ€è¦ç¶²è·¯ã€æœ‰ä½¿ç”¨æˆæœ¬ | å•†æ¥­æ‡‰ç”¨ã€å¤§é‡è™•ç† |
| **æœ¬åœ°è™•ç†** | éš±ç§ä¿è­·ã€ç„¡ç¶²è·¯ä¾è³´ | é€Ÿåº¦æ…¢ã€ç¡¬é«”è¦æ±‚é«˜ | æ•æ„Ÿå…§å®¹ã€é›¢ç·šç’°å¢ƒ |

**æˆæœ¬æ•ˆç›Šåˆ†æ**ï¼š
- ğŸ• **æ™‚é–“æˆæœ¬**ï¼šé›²ç«¯è™•ç† 30 åˆ†é˜å½±ç‰‡ç´„ 2-3 åˆ†é˜ï¼Œæœ¬åœ°å¯èƒ½éœ€è¦ 1-2 å°æ™‚
- ğŸ’° **é‡‘éŒ¢æˆæœ¬**ï¼šOpenAI Whisper ç´„ $0.006/åˆ†é˜ï¼Œ22MB å››åˆ†å¤šé˜å½±ç‰‡ç´„ $0.03
- ğŸ”§ **ç¡¬é«”æˆæœ¬**ï¼šé›²ç«¯ç„¡éœ€æŠ•è³‡ GPUï¼Œæœ¬åœ°éœ€è¦é«˜éšé¡¯å¡

### Spring AI éŸ³è¨Šè½‰è­¯æ”¯æ´

![Spring AI éŸ³è¨Šæ”¯æ´](https://ithelp.ithome.com.tw/upload/images/20240807/201612904zZn4fPMwh.png)

éŸ³é »è½‰è­¯åœ¨ Spring AI çš„æ–‡ä»¶ä¸­ä¸»è¦æ”¯æ´ï¼š
- **OpenAI Whisper**ï¼šåŠŸèƒ½å®Œæ•´ï¼Œæ”¯æ´æ™‚é–“æˆ³è¨˜
- **Azure OpenAI**ï¼šä¼æ¥­ç´šéƒ¨ç½²ï¼Œåˆè¦æ€§ä½³
- **Groq**ï¼šé€Ÿåº¦å¿«ä½†åŠŸèƒ½å—é™ï¼ˆç„¡æ™‚é–“æˆ³è¨˜ï¼‰

**é‡è¦æé†’**ï¼šåŸæœ¬æƒ³èªªå¯ä»¥ç”¨ Groq çœéŒ¢ï¼Œä¸éå‡±æ–‡å¤§å”å¯¦éš›æ¸¬è©¦ç™¼ç¾ Groq é–¹å‰²äº†å¾ˆå¤šåŠŸèƒ½ï¼Œåªèƒ½ç”¢ç”Ÿç´”æ–‡å­—ï¼Œå­—å¹•æœ€é‡è¦çš„æ™‚é–“æˆ³è¨˜å»ç„¡æ³•ç”¢ç”Ÿï¼Œè‹¥å–®ç´”ç”¢ç”Ÿæ–‡å­—ç¨¿é‚„æ˜¯èƒ½ç”¨ï¼Œéœ€è¦æ™‚é–“æˆ³è¨˜å°±åªèƒ½èŠ±é»å°éŒ¢äº†ã€‚

---
### æ‡‰ç”¨ç¨‹å¼é…ç½®

```yaml
# application.yml
spring:
  application:
    name: subtitle-generator
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      base-url: https://api.openai.com
      audio:
        transcription:
          options:
            model: whisper-1
            response-format: verbose_json  # åŒ…å«æ™‚é–“æˆ³è¨˜çš„è©³ç´°æ ¼å¼
            temperature: 0.0  # æœ€ç¢ºå®šçš„çµæœ
            language: zh  # æŒ‡å®šä¸­æ–‡å¯æå‡æº–ç¢ºåº¦
            # timestamp-granularities åƒæ•¸éœ€åœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®š
  
  # æª”æ¡ˆä¸Šå‚³é…ç½®
  servlet:
    multipart:
      max-file-size: 25MB  # Whisper çš„æª”æ¡ˆå¤§å°é™åˆ¶
      max-request-size: 25MB
      enabled: true

# æ‡‰ç”¨ç¨‹å¼é…ç½®
app:
  subtitle:
    output-directory: ./subtitles
    supported-formats: ["srt", "vtt", "json", "txt"]
    max-duration: 3600  # æœ€å¤§è™•ç†æ™‚é•·ï¼ˆç§’ï¼‰
    default-language: zh

# ä¼ºæœå™¨é…ç½®
server:
  port: 8080
  servlet:
    context-path: /api

# æ—¥èªŒé…ç½®
logging:
  level:
    org.springframework.ai: DEBUG
    com.example: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
```

---

## 5.4.2 åŸºç¤å­—å¹•ç”ŸæˆåŠŸèƒ½

### éŸ³è¨Šè½‰è­¯æ§åˆ¶å™¨

```java

@RestController
@RequestMapping("/subtitle")
@RequiredArgsConstructor
@Slf4j
public class SubtitleController {
    
    private final SubtitleGenerationService subtitleService;
    
    /**
     * åŸºç¤å­—å¹•ç”Ÿæˆ
     * @param file éŸ³è¨Šæˆ–å½±ç‰‡æª”æ¡ˆ
     * @param format è¼¸å‡ºæ ¼å¼ï¼ˆsrt, vtt, json, txtï¼‰
     * @param language èªè¨€ä»£ç¢¼ï¼ˆå¯é¸ï¼‰
     * @return å­—å¹•å…§å®¹
     */
    @PostMapping(value = "/generate", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public ResponseEntity<SubtitleResponse> generateSubtitle(
            @RequestParam("file") MultipartFile file,
            @RequestParam(value = "format", defaultValue = "srt") String format,
            @RequestParam(value = "language", required = false) String language) {
        
        try {
            // é©—è­‰æª”æ¡ˆ
            validateAudioFile(file);
            
            log.info("é–‹å§‹è™•ç†å­—å¹•ç”Ÿæˆï¼šæª”æ¡ˆ={}, æ ¼å¼={}, èªè¨€={}", 
                    file.getOriginalFilename(), format, language);
            
            // ç”Ÿæˆå­—å¹•
            SubtitleResponse response = subtitleService.generateSubtitle(
                    file, format, language
            );
            
            log.info("å­—å¹•ç”Ÿæˆå®Œæˆï¼š{}", file.getOriginalFilename());
            
            return ResponseEntity.ok(response);
            
        } catch (Exception e) {
            log.error("å­—å¹•ç”Ÿæˆå¤±æ•—ï¼š{}", file.getOriginalFilename(), e);
            
            SubtitleResponse errorResponse = SubtitleResponse.builder()
                    .success(false)
                    .error(e.getMessage())
                    .fileName(file.getOriginalFilename())
                    .build();
            
            return ResponseEntity.badRequest().body(errorResponse);
        }
    }
    
    /**
     * é€²éšå­—å¹•ç”Ÿæˆï¼ˆæ”¯æ´æ›´å¤šé¸é …ï¼‰
     * @param file éŸ³è¨Šæª”æ¡ˆ
     * @param request ç”Ÿæˆé¸é …
     * @return å­—å¹•å›æ‡‰
     */
    @PostMapping(value = "/generate-advanced", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public ResponseEntity<SubtitleResponse> generateAdvancedSubtitle(
            @RequestParam("file") MultipartFile file,
            @ModelAttribute SubtitleRequest request) {
        
        try {
            validateAudioFile(file);
            
            log.info("é–‹å§‹é€²éšå­—å¹•ç”Ÿæˆï¼š{}", request);
            
            SubtitleResponse response = subtitleService.generateAdvancedSubtitle(
                    file, request
            );
            
            return ResponseEntity.ok(response);
            
        } catch (Exception e) {
            log.error("é€²éšå­—å¹•ç”Ÿæˆå¤±æ•—", e);
            
            SubtitleResponse errorResponse = SubtitleResponse.builder()
                    .success(false)
                    .error(e.getMessage())
                    .fileName(file.getOriginalFilename())
                    .build();
            
            return ResponseEntity.badRequest().body(errorResponse);
        }
    }
    
    /**
     * æ‰¹æ¬¡å­—å¹•ç”Ÿæˆ
     * @param files å¤šå€‹éŸ³è¨Šæª”æ¡ˆ
     * @param format è¼¸å‡ºæ ¼å¼
     * @return æ‰¹æ¬¡è™•ç†çµæœ
     */
    @PostMapping(value = "/batch-generate", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public ResponseEntity<List<SubtitleResponse>> batchGenerateSubtitles(
            @RequestParam("files") MultipartFile[] files,
            @RequestParam(value = "format", defaultValue = "srt") String format) {
        
        try {
            log.info("é–‹å§‹æ‰¹æ¬¡å­—å¹•ç”Ÿæˆï¼š{} å€‹æª”æ¡ˆ", files.length);
            
            List<SubtitleResponse> responses = subtitleService.batchGenerateSubtitles(
                    Arrays.asList(files), format
            );
            
            return ResponseEntity.ok(responses);
            
        } catch (Exception e) {
            log.error("æ‰¹æ¬¡å­—å¹•ç”Ÿæˆå¤±æ•—", e);
            return ResponseEntity.badRequest().build();
        }
    }
}
```

### å­—å¹•ç”Ÿæˆæœå‹™

```java
@Service
@RequiredArgsConstructor
@Slf4j
public class SubtitleGenerationService {
    
    private final AudioTranscriptionModel transcriptionModel;
    private final SubtitleFormatterService formatterService;
    
    /**
     * åŸºç¤å­—å¹•ç”Ÿæˆ
     * @param file éŸ³è¨Šæª”æ¡ˆ
     * @param format è¼¸å‡ºæ ¼å¼
     * @param language èªè¨€ï¼ˆå¯é¸ï¼‰
     * @return å­—å¹•å›æ‡‰
     */
    public SubtitleResponse generateSubtitle(
            MultipartFile file, 
            String format, 
            String language) {
        
        try {
            // å»ºç«‹è½‰è­¯é¸é …
            OpenAiAudioTranscriptionOptions options = OpenAiAudioTranscriptionOptions.builder()
                    .withModel("whisper-1")
                    .withResponseFormat("verbose_json")  // åŒ…å«æ™‚é–“æˆ³è¨˜
                    .withTemperature(0.0f)
                    .withLanguage(language != null ? language : "zh")
                    .withTimestampGranularities(List.of("word", "segment"))
                    .build();
            
            // å»ºç«‹éŸ³è¨Šè³‡æº
            Resource audioResource = createAudioResource(file);
            
            // å»ºç«‹è½‰è­¯è«‹æ±‚
            AudioTranscriptionPrompt prompt = new AudioTranscriptionPrompt(
                    audioResource, options
            );
            
            // åŸ·è¡Œè½‰è­¯
            AudioTranscriptionResponse response = transcriptionModel.call(prompt);
            String transcriptionResult = response.getResult().getOutput();
            
            // æ ¼å¼åŒ–å­—å¹•
            String formattedSubtitle = formatterService.formatSubtitle(
                    transcriptionResult, format
            );
            
            return SubtitleResponse.builder()
                    .success(true)
                    .fileName(file.getOriginalFilename())
                    .format(format)
                    .language(language != null ? language : "zh")
                    .content(formattedSubtitle)
                    .fileSize(file.getSize())
                    .processingTime(calculateProcessingTime())
                    .timestamp(LocalDateTime.now())
                    .build();
            
        } catch (Exception e) {
            log.error("å­—å¹•ç”Ÿæˆå¤±æ•—ï¼š{}", file.getOriginalFilename(), e);
            throw new RuntimeException("å­—å¹•ç”Ÿæˆå¤±æ•—ï¼š" + e.getMessage(), e);
        }
    }
}
```
---
## ğŸ“ æœ¬ç« é‡é»å›é¡§

1. **èªéŸ³è½‰æ–‡å­—æŠ€è¡“**ï¼šæŒæ¡äº† Whisper æ¨¡å‹çš„å·¥ä½œåŸç†å’Œé›²ç«¯è™•ç†å„ªå‹¢
2. **å¤šæ ¼å¼å­—å¹•è¼¸å‡º**ï¼šå¯¦ç¾äº† SRTã€VTTã€JSONã€TXT ç­‰å¤šç¨®å­—å¹•æ ¼å¼

### æˆæœ¬æ•ˆç›Šåˆ†æ

**OpenAI Whisper å®šåƒ¹**ï¼š
- ğŸ’° **æˆæœ¬**ï¼š$0.006 per minute
- â±ï¸ **é€Ÿåº¦**ï¼šé€šå¸¸æ¯”éŸ³è¨Šæ™‚é•·å¿« 5-10 å€
- ğŸ¯ **æº–ç¢ºåº¦**ï¼šä¸­æ–‡è­˜åˆ¥æº–ç¢ºç‡ > 95%
- ğŸ“Š **æ€§åƒ¹æ¯”**ï¼šç›¸æ¯”äººå·¥å­—å¹•è£½ä½œç¯€çœ 80% æˆæœ¬

### æœ€ä½³å¯¦è¸å»ºè­°

1. **æª”æ¡ˆé è™•ç†**ï¼šç¢ºä¿éŸ³è¨Šå“è³ªï¼Œç§»é™¤èƒŒæ™¯å™ªéŸ³
2. **èªè¨€è¨­å®š**ï¼šæ­£ç¢ºè¨­å®šèªè¨€å¯æå‡ 10-15% æº–ç¢ºåº¦
3. **æº«åº¦èª¿æ•´**ï¼šä½¿ç”¨ 0.0 æº«åº¦ç²å¾—æœ€ç©©å®šçµæœ
4. **æ‰¹æ¬¡è™•ç†**ï¼šå¤§é‡æª”æ¡ˆä½¿ç”¨éåŒæ­¥è™•ç†æå‡æ•ˆç‡
5. **å“è³ªæª¢æŸ¥**ï¼šå¯¦æ–½è‡ªå‹•å“è³ªè©•ä¼°å’Œäººå·¥æ ¡å°æµç¨‹

### ä¸‹ä¸€æ­¥å­¸ç¿’æ–¹å‘

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘å€‘å°‡å­¸ç¿’æ–‡å­—è½‰èªéŸ³æŠ€è¡“ï¼Œæ¢ç´¢å¦‚ä½•è®“ AI å¹«ä½ é…éŸ³ï¼Œå»ºç«‹å®Œæ•´çš„èªéŸ³åˆæˆæ‡‰ç”¨ã€‚

---

**åƒè€ƒè³‡æ–™ï¼š**
- [Spring AI Audio Transcription Documentation](https://docs.spring.io/spring-ai/reference/api/audio.html)
- [OpenAI Whisper API](https://platform.openai.com/docs/guides/speech-to-text)
- [SRT Subtitle Format Specification](https://en.wikipedia.org/wiki/SubRip)
- [WebVTT Specification](https://www.w3.org/TR/webvtt1/)