# 5.1 æ‡¶å¾—æ‰“å­—å• AIï¼Ÿç”¨æç¤ºè©ç¯„æœ¬å§

> **æœ¬ç« é‡é»**ï¼šå­¸ç¿’ä½¿ç”¨æç¤ºè©ç¯„æœ¬ï¼ˆPrompt Templateï¼‰ä¾†æ¨™æº–åŒ–å’Œå„ªåŒ– AI äº’å‹•ï¼Œæå‡æç¤ºè©çš„å“è³ªå’Œä¸€è‡´æ€§ï¼Œç‚ºå€‹æ€§åŒ– ChatBot å¥ å®šåŸºç¤ã€‚

## ğŸ¯ å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬ç« å­¸ç¿’å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š

- ğŸ¯ **ç†è§£æç¤ºè©ç¯„æœ¬çš„é‡è¦æ€§**ï¼šæŒæ¡ã€ŒGarbage in, Garbage outã€åŸå‰‡åœ¨ AI ä¸­çš„æ‡‰ç”¨
- ğŸ¯ **ä½¿ç”¨ PromptTemplate é¡åˆ¥**ï¼šå­¸æœƒå»ºç«‹å’Œä½¿ç”¨å‹•æ…‹æç¤ºè©ç¯„æœ¬
- ğŸ¯ **æ•´åˆ ChatClient API**ï¼šå°‡ç¯„æœ¬èˆ‡ç¾ä»£åŒ–çš„ ChatClient æµæš¢ API çµåˆ
- ğŸ¯ **å»ºç«‹ç¯„æœ¬åº«**ï¼šè¨­è¨ˆå¯é‡è¤‡ä½¿ç”¨çš„æç¤ºè©ç¯„æœ¬ç³»çµ±
- ğŸ¯ **å„ªåŒ–æç¤ºè©å“è³ª**ï¼šæŒæ¡æç¤ºè©è¨­è¨ˆçš„æœ€ä½³å¯¦è¸

---

## 5.1.1 ç‚ºä»€éº¼éœ€è¦æç¤ºè©ç¯„æœ¬ï¼Ÿ

### Garbage in, Garbage out

![æç¤ºè©ç¯„æœ¬](https://ithelp.ithome.com.tw/upload/images/20240810/201612907PBWefpaFK.jpg)

**Garbage in, Garbage out** ä¹Ÿé©ç”¨åœ¨ AI é ˜åŸŸã€‚æœ‰äº›äººå°±æ˜¯ä¸çŸ¥å¦‚ä½•å• AIï¼Œå¾—åˆ°çš„è§£ç­”è‡ªç„¶ä¹Ÿä¸å…·åƒè€ƒåƒ¹å€¼ï¼Œé€™æ™‚æç¤ºè©ç¯„æœ¬å°±æ´¾ä¸Šç”¨å ´äº†ã€‚

### æç¤ºè©ç¯„æœ¬çš„æ ¸å¿ƒåƒ¹å€¼

**1. æ¨™æº–åŒ–äº’å‹•æ¨¡å¼**
```
âŒ ä¸è‰¯æç¤ºè©ï¼š
"å‘Šè¨´æˆ‘é—œæ–¼ Spring Boot"

âœ… å„ªè³ªæç¤ºè©ç¯„æœ¬ï¼š
"ä½œç‚ºä¸€å€‹è³‡æ·±çš„ Java é–‹ç™¼å°ˆå®¶ï¼Œè«‹è©³ç´°èªªæ˜ {topic} çš„æ ¸å¿ƒæ¦‚å¿µã€
ä¸»è¦ç‰¹æ€§ã€ä½¿ç”¨å ´æ™¯ï¼Œä¸¦æä¾›ä¸€å€‹å¯¦éš›çš„ç¨‹å¼ç¢¼ç¯„ä¾‹ã€‚
è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œä¸¦ç¢ºä¿å…§å®¹é©åˆ {experience_level} é–‹ç™¼è€…ã€‚"
```

**2. æå‡å›æ‡‰å“è³ª**
- ğŸ¯ **æ˜ç¢ºçš„è§’è‰²è¨­å®š**ï¼šè®“ AI æ‰®æ¼”ç‰¹å®šå°ˆæ¥­è§’è‰²
- ğŸ“‹ **çµæ§‹åŒ–è¦æ±‚**ï¼šæŒ‡å®šå›æ‡‰çš„æ ¼å¼å’Œå…§å®¹çµæ§‹
- ğŸŒ **èªè¨€å’Œé¢¨æ ¼**ï¼šçµ±ä¸€å›æ‡‰çš„èªè¨€å’Œè¡¨é”é¢¨æ ¼
- ğŸšï¸ **é›£åº¦æ§åˆ¶**ï¼šæ ¹æ“šä½¿ç”¨è€…ç¨‹åº¦èª¿æ•´å…§å®¹æ·±åº¦

**3. æé«˜é–‹ç™¼æ•ˆç‡**
- ğŸ”„ **å¯é‡è¤‡ä½¿ç”¨**ï¼šä¸€æ¬¡è¨­è¨ˆï¼Œå¤šæ¬¡ä½¿ç”¨
- ğŸ› ï¸ **åƒæ•¸åŒ–è¨­è¨ˆ**ï¼šé€éè®Šæ•¸å‹•æ…‹èª¿æ•´å…§å®¹
- ğŸ“š **ç¯„æœ¬åº«ç®¡ç†**ï¼šå»ºç«‹ä¼æ¥­ç´šæç¤ºè©è³‡ç”¢
- ğŸš€ **å¿«é€Ÿéƒ¨ç½²**ï¼šæ¸›å°‘é‡è¤‡çš„æç¤ºè©è¨­è¨ˆå·¥ä½œ

---

## 5.1.2 PromptTemplate åŸºç¤ä½¿ç”¨

### åŸºæœ¬ç¯„æœ¬èªæ³•

ä½¿ç”¨ä½”ä½ç¬¦ `{è®Šæ•¸å}` å®šç¾©å‹•æ…‹å…§å®¹ï¼š

```java
// å®šç¾©ç¯„æœ¬å­—ä¸²
String template = """
    ä½œç‚ºä¸€å€‹è³‡æ·±çš„æŠ€è¡“å°ˆå®¶ï¼Œè«‹è©³ç´°èªªæ˜ {topic} çš„ç›¸é—œçŸ¥è­˜ã€‚

    è«‹åŒ…å«ï¼š
    1. æ ¸å¿ƒæ¦‚å¿µ
    2. ä¸»è¦ç‰¹æ€§
    3. å¯¦éš›æ‡‰ç”¨å ´æ™¯

    ç›®æ¨™å—çœ¾ï¼š{level} é–‹ç™¼è€…
    """;

// å»ºç«‹ PromptTemplate ä¸¦å¡«å…¥è®Šæ•¸
PromptTemplate promptTemplate = new PromptTemplate(template);
Map<String, Object> variables = Map.of("topic", "Spring Boot", "level", "ä¸­ç´š");
Prompt prompt = promptTemplate.create(variables);
```

### èˆ‡ ChatClient æ•´åˆ

```java
// ç°¡åŒ–çš„ç¯„æœ¬ä½¿ç”¨æ–¹å¼
return chatClient.prompt("è«‹å• {framework} ç›®å‰æœ‰å“ªäº›ç‰ˆæœ¬ï¼Ÿ")
    .user(Map.of("framework", "Spring Boot"))
    .call()
    .content();
```

> ğŸ’¡ **å®Œæ•´ç¯„ä¾‹**ï¼šè©³è¦‹ `code-examples/chapter5-spring-ai-advanced/src/main/java/com/example/service/PromptTemplateService.java`

---

## 5.1.3 é€²éšç¯„æœ¬è¨­è¨ˆ

### å¤šåƒæ•¸ç¯„æœ¬

æ ¹æ“šä¸åŒå ´æ™¯å‰µå»ºç‰¹å®šç”¨é€”çš„ç¯„æœ¬ï¼š

```java
// ç¨‹å¼ç¢¼ç”Ÿæˆç¯„æœ¬
String codeTemplate = """
    ä½ æ˜¯ {language} é–‹ç™¼å°ˆå®¶ã€‚
    è«‹ç”Ÿæˆ {functionality} çš„ç¨‹å¼ç¢¼å¯¦ç¾ã€‚
    """;

// éŒ¯èª¤è¨ºæ–·ç¯„æœ¬
String diagTemplate = """
    ä½ æ˜¯ {technology} å°ˆå®¶ã€‚
    åˆ†æä»¥ä¸‹éŒ¯èª¤ï¼š{errorMessage}
    è«‹æä¾›åŸå› å’Œè§£æ±ºæ–¹æ³•ã€‚
    """;
```

### æ¢ä»¶å¼ç¯„æœ¬

æ ¹æ“šä½¿ç”¨è€…ç¨‹åº¦å‹•æ…‹é¸æ“‡ç¯„æœ¬ï¼š

```java
String template = switch (level) {
    case "åˆç´š" -> "ä½ æ˜¯è€å¿ƒçš„å°å¸«ã€‚è«‹ç”¨ç°¡å–®èªè¨€èªªæ˜ {topic}";
    case "ä¸­ç´š" -> "ä½ æ˜¯æŠ€è¡“å°ˆå®¶ã€‚è«‹èªªæ˜ {topic} çš„æ ¸å¿ƒåŸç†å’Œæ‡‰ç”¨";
    default -> "ä½ æ˜¯è³‡æ·±æ¶æ§‹å¸«ã€‚è«‹æ·±åº¦åˆ†æ {topic} çš„å¯¦ç¾åŸç†";
};
```

> ğŸ’¡ **æ›´å¤šç¯„æœ¬è¨­è¨ˆ**ï¼šè©³è¦‹ `code-examples/chapter5-spring-ai-advanced/` ä¸­çš„å·¥å…·é¡

---

## 5.1.4 ç¯„æœ¬åº«ç®¡ç†ç³»çµ±

### é å®šç¾©ç¯„æœ¬åº«

åœ¨é…ç½®æ–‡ä»¶ä¸­å®šç¾©å¸¸ç”¨ç¯„æœ¬ï¼š

```java
@ConfigurationProperties(prefix = "app.prompt.templates")
public class PromptTemplateConfig {
    private Map<String, String> library = Map.of(
        "explain", "ä½œç‚º {role} å°ˆå®¶ï¼Œè«‹è©³ç´°èªªæ˜ {topic}ã€‚åŒ…æ‹¬æ ¸å¿ƒæ¦‚å¿µã€ç‰¹æ€§å’Œç¯„ä¾‹ã€‚",
        "code-review", "ä½ æ˜¯ {language} ç¨‹å¼ç¢¼å¯©æŸ¥å°ˆå®¶ã€‚å¯©æŸ¥ä»£ç¢¼ï¼š{code}ï¼Œæä¾›å“è³ªè©•ä¼°å’Œæ”¹é€²å»ºè­°ã€‚",
        "troubleshoot", "ä½ æ˜¯ {technology} æ•…éšœæ’é™¤å°ˆå®¶ã€‚åˆ†æå•é¡Œï¼š{problem}ï¼Œæä¾›è§£æ±ºæ–¹æ¡ˆã€‚"
    );
}
```

### ç¯„æœ¬ç®¡ç†æœå‹™

æ ¸å¿ƒæ–¹æ³•ï¼š

```java
@Service
public class PromptTemplateManager {
    // æ ¹æ“šåç¨±å‰µå»º Prompt
    public Prompt createPrompt(String templateName, Map<String, Object> variables) { ... }

    // å‹•æ…‹è¨»å†Šæ–°ç¯„æœ¬
    public void registerTemplate(String name, String template) { ... }

    // é©—è­‰ç¯„æœ¬èªæ³•
    public boolean validateTemplate(String template, Map<String, Object> variables) { ... }
}
```

> è©³è¦‹ `code-examples/chapter5-spring-ai-advanced/src/main/java/com/example/service/PromptTemplateManager.java`

---

## 5.1.5 å¯¦éš›æ‡‰ç”¨ç¯„ä¾‹

### å®¢æœæ”¯æ´ç¯„æœ¬

```java
// æŠ€è¡“æ”¯æ´ç¯„æœ¬
String supportTemplate = """
    ä½ æ˜¯ {product} çš„æŠ€è¡“æ”¯æ´å°ˆå®¶ã€‚

    å•é¡Œï¼š{issue}
    åš´é‡ç¨‹åº¦ï¼š{severity}

    è«‹æä¾›ï¼š
    ## ğŸ” å•é¡Œç†è§£
    ## ğŸ› ï¸ è§£æ±ºæ–¹æ¡ˆ
    ## ğŸ“‹ å¾ŒçºŒè¿½è¹¤
    """;

// åœ¨ Controller ä¸­ä½¿ç”¨
Prompt prompt = templateManager.createPrompt("technical-support",
    Map.of("product", "Spring Boot", "issue", "å•Ÿå‹•å¤±æ•—", "severity", "high"));
```

### æ•™è‚²è¨“ç·´ç¯„æœ¬

```java
// èª²ç¨‹è¨­è¨ˆç¯„æœ¬
String lessonTemplate = """
    ä½ æ˜¯ç¶“é©—è±å¯Œçš„ {subject} æ•™å¸«ã€‚
    ç‚º {level} å­¸ç”Ÿè¨­è¨ˆ {duration} åˆ†é˜èª²ç¨‹ã€‚

    åŒ…å«ï¼šèª²ç¨‹ç›®æ¨™ã€å¤§ç¶±ã€æ•™å­¸æ´»å‹•ã€è©•é‡æ–¹å¼ã€èª²å¾Œä½œæ¥­
    """;
```

> ğŸ’¡ **å®Œæ•´æ‡‰ç”¨ç¯„ä¾‹**ï¼šè©³è¦‹ `code-examples/chapter5-spring-ai-advanced/src/main/java/com/example/controller/TemplateController.java`

---

## 5.1.6 ç¯„æœ¬è¨­è¨ˆæœ€ä½³å¯¦è¸

### è¨­è¨ˆåŸå‰‡

**1. æ¸…æ™°çš„è§’è‰²å®šç¾©**
```java
// âœ… å¥½çš„ç¯„æœ¬ï¼šæ˜ç¢ºçš„èº«ä»½å’ŒèƒŒæ™¯
String template = """
    ä½ æ˜¯æ“æœ‰10å¹´ç¶“é©—çš„ Spring Boot æ¶æ§‹å¸«ã€‚
    è«‹é‡å° {question} æä¾›å°ˆæ¥­å»ºè­°ã€‚
    """;

// âŒ ä¸å¥½çš„ç¯„æœ¬ï¼šæ¨¡ç³Šä¸æ¸…
String template = "è«‹å›ç­” {question}";
```

**2. çµæ§‹åŒ–è¼¸å‡ºæ ¼å¼**
```java
String template = """
    è«‹æŒ‰ç…§ä»¥ä¸‹æ ¼å¼å›ç­”ï¼š
    ## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ
    ## ğŸ”§ å¯¦ä½œæ–¹æ³•
    ## ğŸ’¡ æœ€ä½³å¯¦è¸
    ## âš ï¸ æ³¨æ„äº‹é …
    """;
```

**3. åƒæ•¸é©—è­‰å’Œé è¨­å€¼**
```java
// é©—è­‰å¿…è¦åƒæ•¸
validateRequiredParameters(template, variables);

// è¨­å®šé è¨­å€¼
result.putIfAbsent("language", "ç¹é«”ä¸­æ–‡");
result.putIfAbsent("style", "å°ˆæ¥­ä¸”å‹å–„");
```

### æ•ˆèƒ½å„ªåŒ–

**å¿«å–ç·¨è­¯å¾Œçš„ç¯„æœ¬**ï¼š
```java
// ä½¿ç”¨ ConcurrentHashMap å¿«å–å·²ç·¨è­¯çš„ç¯„æœ¬
private final Map<String, PromptTemplate> templateCache = new ConcurrentHashMap<>();

PromptTemplate template = templateCache.computeIfAbsent(templateKey,
    key -> new PromptTemplate(templateContent));
```

**æ‰¹æ¬¡è™•ç†**ï¼š
```java
// ä¸¦è¡Œè™•ç†å¤šå€‹ç¯„æœ¬
variablesList.parallelStream()
    .map(template::create)
    .collect(Collectors.toList());
```

---

## ğŸ“ æœ¬ç« é‡é»å›é¡§

1. **æç¤ºè©ç¯„æœ¬çš„åƒ¹å€¼**ï¼šç†è§£äº†ã€ŒGarbage in, Garbage outã€åŸå‰‡å’Œç¯„æœ¬çš„é‡è¦æ€§
2. **PromptTemplate ä½¿ç”¨**ï¼šæŒæ¡äº†åŸºæœ¬å’Œé€²éšçš„ç¯„æœ¬å»ºç«‹æ–¹æ³•
3. **ChatClient æ•´åˆ**ï¼šå­¸æœƒäº†å°‡ç¯„æœ¬èˆ‡ç¾ä»£åŒ–çš„ ChatClient API çµåˆ
4. **ç¯„æœ¬åº«ç®¡ç†**ï¼šå»ºç«‹äº†ä¼æ¥­ç´šçš„ç¯„æœ¬ç®¡ç†ç³»çµ±
5. **æœ€ä½³å¯¦è¸**ï¼šæŒæ¡äº†ç¯„æœ¬è¨­è¨ˆã€é©—è­‰å’Œå„ªåŒ–çš„æœ€ä½³å¯¦è¸

### é—œéµæŠ€è¡“è¦é»

| æŠ€è¡“é» | é‡è¦æ€§ | å¯¦ç¾é›£åº¦ | ä½¿ç”¨å ´æ™¯ |
|--------|--------|----------|----------|
| **åŸºç¤ç¯„æœ¬** | â­â­â­ | ä½ | æ‰€æœ‰ AI æ‡‰ç”¨ |
| **åƒæ•¸åŒ–è¨­è¨ˆ** | â­â­â­ | ä¸­ | å‹•æ…‹å…§å®¹ç”Ÿæˆ |
| **ç¯„æœ¬åº«ç®¡ç†** | â­â­ | ä¸­ | ä¼æ¥­ç´šæ‡‰ç”¨ |
| **æ¢ä»¶å¼ç¯„æœ¬** | â­â­ | é«˜ | è¤‡é›œæ¥­å‹™é‚è¼¯ |
| **æ•ˆèƒ½å„ªåŒ–** | â­ | ä¸­ | é«˜ä½µç™¼å ´æ™¯ |

### ä¸‹ä¸€æ­¥å­¸ç¿’æ–¹å‘

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘å€‘å°‡å­¸ç¿’å¦‚ä½•è™•ç†å¤šæ¨¡æ…‹è³‡æ–™ï¼Œè®“ AI ä¸åƒ…èƒ½ç†è§£æ–‡å­—ï¼Œé‚„èƒ½è™•ç†åœ–ç‰‡ã€éŸ³è¨Šç­‰å¤šç¨®åª’é«”æ ¼å¼ï¼Œé€²ä¸€æ­¥æå‡ ChatBot çš„æ™ºèƒ½åŒ–ç¨‹åº¦ã€‚

---

**åƒè€ƒè³‡æ–™ï¼š**
- [Spring AI Prompt Template Documentation](https://docs.spring.io/spring-ai/reference/api/prompt.html)
- [ChatClient API Reference](https://docs.spring.io/spring-ai/reference/api/chatclient.html)
- [Prompt Engineering Best Practices](https://platform.openai.com/docs/guides/prompt-engineering)