# 5.1 æ‡¶å¾—æ‰“å­—å• AIï¼Ÿç”¨æç¤ºè©ç¯„æœ¬å§

> **å°æ‡‰ç« ç¯€**: Day11
> **å°æ‡‰ç¯„ä¾‹**: `chapter5-spring-ai-advanced`
> **é›£åº¦**: â­â­â˜†â˜†â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

æç¤ºè©ç¯„æœ¬ï¼ˆPrompt Templateï¼‰æ˜¯ Spring AI æä¾›çš„æ¨™æº–åŒ– AI äº’å‹•æ–¹å¼ã€‚é€éåƒæ•¸åŒ–çš„ç¯„æœ¬è¨­è¨ˆï¼Œæˆ‘å€‘å¯ä»¥å»ºç«‹å¯é‡è¤‡ä½¿ç”¨ã€å“è³ªä¸€è‡´çš„æç¤ºè©ç³»çµ±ï¼Œé¿å…ã€ŒGarbage in, Garbage outã€çš„å•é¡Œã€‚

**å­¸ç¿’ç›®æ¨™**ï¼š
- ç†è§£æç¤ºè©ç¯„æœ¬çš„æ ¸å¿ƒåƒ¹å€¼
- æŒæ¡ PromptTemplate é¡åˆ¥çš„ä½¿ç”¨æ–¹å¼
- å­¸æœƒèˆ‡ ChatClient API æ•´åˆ
- å»ºç«‹ä¼æ¥­ç´šç¯„æœ¬åº«ç®¡ç†ç³»çµ±

---

## 5.1.1 ç‚ºä»€éº¼éœ€è¦æç¤ºè©ç¯„æœ¬ï¼Ÿ

### Garbage in, Garbage out

![æç¤ºè©ç¯„æœ¬](https://ithelp.ithome.com.tw/upload/images/20240810/201612907PBWefpaFK.jpg)

**Garbage in, Garbage out** ä¹Ÿé©ç”¨åœ¨ AI é ˜åŸŸã€‚æœ‰äº›äººå°±æ˜¯ä¸çŸ¥å¦‚ä½•å• AIï¼Œå¾—åˆ°çš„è§£ç­”è‡ªç„¶ä¹Ÿä¸å…·åƒè€ƒåƒ¹å€¼ï¼Œé€™æ™‚æç¤ºè©ç¯„æœ¬å°±æ´¾ä¸Šç”¨å ´äº†ã€‚

### æç¤ºè©ç¯„æœ¬çš„æ ¸å¿ƒåƒ¹å€¼

**1. æ¨™æº–åŒ–äº’å‹•æ¨¡å¼**

```
âŒ ä¸è‰¯æç¤ºè©ï¼š
"å‘Šè¨´æˆ‘é—œæ–¼ Spring Boot"

âœ… å„ªè³ªæç¤ºè©ç¯„æœ¬ï¼š
"ä½œç‚ºä¸€å€‹è³‡æ·±çš„ Java é–‹ç™¼å°ˆå®¶ï¼Œè«‹è©³ç´°èªªæ˜ {topic} çš„æ ¸å¿ƒæ¦‚å¿µã€
ä¸»è¦ç‰¹æ€§ã€ä½¿ç”¨å ´æ™¯ï¼Œä¸¦æä¾›ä¸€å€‹å¯¦éš›çš„ç¨‹å¼ç¢¼ç¯„ä¾‹ã€‚
è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œä¸¦ç¢ºä¿å…§å®¹é©åˆ {experience_level} é–‹ç™¼è€…ã€‚"
```

**å°æ¯”èªªæ˜**ï¼š
- **ä¸è‰¯æç¤ºè©**éæ–¼ç°¡ç•¥ï¼ŒAI ç„¡æ³•ç†è§£æ‚¨éœ€è¦ä»€éº¼æ·±åº¦ã€é¢¨æ ¼çš„å›ç­”
- **å„ªè³ªç¯„æœ¬**æ˜ç¢ºå®šç¾©äº†è§’è‰²ã€è¼¸å‡ºæ ¼å¼ã€èªè¨€é¢¨æ ¼å’Œç›®æ¨™å—çœ¾
- é€é `{è®Šæ•¸}` èªæ³•ï¼ŒåŒä¸€å€‹ç¯„æœ¬å¯ä»¥é‡è¤‡ä½¿ç”¨æ–¼ä¸åŒä¸»é¡Œ

**2. æå‡å›æ‡‰å“è³ª**
- ğŸ¯ **æ˜ç¢ºçš„è§’è‰²è¨­å®š**ï¼šè®“ AI æ‰®æ¼”ç‰¹å®šå°ˆæ¥­è§’è‰²
- ğŸ“‹ **çµæ§‹åŒ–è¦æ±‚**ï¼šæŒ‡å®šå›æ‡‰çš„æ ¼å¼å’Œå…§å®¹çµæ§‹
- ğŸŒ **èªè¨€å’Œé¢¨æ ¼**ï¼šçµ±ä¸€å›æ‡‰çš„èªè¨€å’Œè¡¨é”é¢¨æ ¼
- ğŸšï¸ **é›£åº¦æ§åˆ¶**ï¼šæ ¹æ“šä½¿ç”¨è€…ç¨‹åº¦èª¿æ•´å…§å®¹æ·±åº¦

**3. æé«˜é–‹ç™¼æ•ˆç‡**
- ğŸ”„ **å¯é‡è¤‡ä½¿ç”¨**ï¼šä¸€æ¬¡è¨­è¨ˆï¼Œå¤šæ¬¡ä½¿ç”¨
- ğŸ› ï¸ **åƒæ•¸åŒ–è¨­è¨ˆ**ï¼šé€éè®Šæ•¸å‹•æ…‹èª¿æ•´å…§å®¹
- ğŸ“š **ç¯„æœ¬åº«ç®¡ç†**ï¼šå»ºç«‹ä¼æ¥­ç´šæç¤ºè©è³‡ç”¢
- ğŸš€ **å¿«é€Ÿéƒ¨ç½²**ï¼šæ¸›å°‘é‡è¤‡çš„æç¤ºè©è¨­è¨ˆå·¥ä½œ

### ç¯„æœ¬ç³»çµ±æ¶æ§‹

```mermaid
graph TD
    A[ç”¨æˆ¶è«‹æ±‚] --> B[PromptTemplate]
    B --> C{è®Šæ•¸æ›¿æ›}
    C --> D[ç”Ÿæˆ Prompt]
    D --> E[ChatClient]
    E --> F[AI æ¨¡å‹]
    F --> G[çµæ§‹åŒ–å›æ‡‰]

    H[PromptTemplateManager] --> B
    I[ç¯„æœ¬åº« Config] --> H

    style B fill:#e1f5ff
    style H fill:#fff4e6
    style I fill:#e8f5e9
```

**æ¶æ§‹èªªæ˜**ï¼š
1. **PromptTemplate**ï¼šæ ¸å¿ƒç¯„æœ¬é¡åˆ¥ï¼Œè² è²¬è®Šæ•¸æ›¿æ›
2. **PromptTemplateManager**ï¼šç¯„æœ¬ç®¡ç†æœå‹™ï¼Œçµ±ä¸€ç®¡ç†æ‰€æœ‰ç¯„æœ¬
3. **ç¯„æœ¬åº« Config**ï¼šé›†ä¸­é…ç½®æ‰€æœ‰é å®šç¾©ç¯„æœ¬
4. **ChatClient**ï¼šåŸ·è¡Œ AI å°è©±çš„å®¢æˆ¶ç«¯

---

## 5.1.2 PromptTemplate åŸºç¤ä½¿ç”¨

### åŸºæœ¬ç¯„æœ¬èªæ³•

```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../PromptTemplateService.java:71

// å®šç¾©ç¯„æœ¬å­—ä¸²ï¼Œä½¿ç”¨ {è®Šæ•¸å} ä½œç‚ºä½”ä½ç¬¦
String template = """
    ä½œç‚ºä¸€å€‹è³‡æ·±çš„æŠ€è¡“å°ˆå®¶ï¼Œè«‹è©³ç´°èªªæ˜ {topic} çš„ç›¸é—œçŸ¥è­˜ã€‚

    è«‹åŒ…å«ä»¥ä¸‹å…§å®¹ï¼š
    1. æ ¸å¿ƒæ¦‚å¿µå’Œå®šç¾©
    2. ä¸»è¦ç‰¹æ€§å’Œå„ªå‹¢
    3. å¯¦éš›æ‡‰ç”¨å ´æ™¯

    ç›®æ¨™å—çœ¾ï¼š{level} é–‹ç™¼è€…
    å›ç­”èªè¨€ï¼šç¹é«”ä¸­æ–‡
    """;

// å»ºç«‹ PromptTemplate å¯¦ä¾‹
PromptTemplate promptTemplate = new PromptTemplate(template);

// æä¾›è®Šæ•¸å€¼
Map<String, Object> variables = Map.of(
    "topic", "Spring Boot",
    "level", "ä¸­ç´š"
);

// ç”Ÿæˆæœ€çµ‚çš„ Prompt
Prompt prompt = promptTemplate.create(variables);
```

**å¯¦ç¾ç´°ç¯€èªªæ˜**ï¼š
- **ä½”ä½ç¬¦èªæ³•**ï¼šä½¿ç”¨ `{è®Šæ•¸å}` å®šç¾©éœ€è¦å‹•æ…‹æ›¿æ›çš„éƒ¨åˆ†
- **è®Šæ•¸æ˜ å°„**ï¼šä½¿ç”¨ `Map<String, Object>` æä¾›å¯¦éš›çš„è®Šæ•¸å€¼
- **é¡å‹å®‰å…¨**ï¼šè®Šæ•¸å€¼æœƒè‡ªå‹•è½‰æ›ç‚ºå­—ä¸²é€²è¡Œæ›¿æ›
- **ç¯„æœ¬è¤‡ç”¨**ï¼šåŒä¸€å€‹ `PromptTemplate` å¯¦ä¾‹å¯ä»¥å¤šæ¬¡ä½¿ç”¨ï¼Œåªéœ€å‚³å…¥ä¸åŒçš„è®Šæ•¸

### èˆ‡ ChatClient æ•´åˆ

```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../controller/TemplateController.java:128

@GetMapping("/explain")
public String explainTopic(
        @RequestParam String topic,
        @RequestParam(defaultValue = "ä¸­ç´š") String level) {

    // ä½¿ç”¨ç¯„æœ¬æœå‹™å»ºç«‹ Prompt
    Prompt prompt = promptTemplateService.createBasicPrompt(topic, level);

    // ä½¿ç”¨ ChatClient åŸ·è¡Œå°è©±
    return chatClient.prompt(prompt)
            .call()
            .content();
}

// ç°¡åŒ–çš„ç¯„æœ¬ä½¿ç”¨æ–¹å¼ - ChatClient å…§å»ºæ”¯æ´
@GetMapping("/framework")
public String explainFramework(@RequestParam String framework) {
    return chatClient.prompt("è«‹å• {framework} ç›®å‰æœ‰å“ªäº›ç‰ˆæœ¬ï¼Ÿ")
            .user(Map.of("framework", framework))
            .call()
            .content();
}
```

**æ•´åˆæ–¹å¼å°æ¯”**ï¼š
1. **æ¨™æº–æ–¹å¼**ï¼šå…ˆå»ºç«‹ `PromptTemplate`ï¼Œå†å‚³çµ¦ `ChatClient`
   - é©åˆï¼šè¤‡é›œç¯„æœ¬ã€éœ€è¦é©—è­‰ã€ç¯„æœ¬é‡è¤‡ä½¿ç”¨çš„å ´æ™¯
2. **ç°¡åŒ–æ–¹å¼**ï¼šç›´æ¥åœ¨ `ChatClient.prompt()` ä¸­ä½¿ç”¨è®Šæ•¸
   - é©åˆï¼šç°¡å–®çš„ä¸€æ¬¡æ€§ç¯„æœ¬ä½¿ç”¨

> ğŸ’¡ **å®Œæ•´ç¯„ä¾‹**ï¼šè©³è¦‹ `code-examples/chapter5-spring-ai-advanced/src/main/java/com/example/service/PromptTemplateService.java`

---

## 5.1.3 é€²éšç¯„æœ¬è¨­è¨ˆ

### å¤šåƒæ•¸ç¯„æœ¬

æ ¹æ“šä¸åŒå ´æ™¯å‰µå»ºç‰¹å®šç”¨é€”çš„ç¯„æœ¬ï¼š

```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../AdvancedPromptService.java:169

/**
 * ç¨‹å¼ç¢¼ç”Ÿæˆç¯„æœ¬
 */
public Prompt createCodeGenerationPrompt(String language, String functionality) {
    String template = """
        ä½ æ˜¯ {language} é–‹ç™¼å°ˆå®¶ã€‚

        è«‹ç”Ÿæˆ {functionality} çš„ç¨‹å¼ç¢¼ï¼š
        1. å®Œæ•´ç¨‹å¼ç¢¼å¯¦ç¾
        2. ç°¡å–®ä½¿ç”¨èªªæ˜
        """;

    PromptTemplate promptTemplate = new PromptTemplate(template);
    return promptTemplate.create(Map.of(
        "language", language,
        "functionality", functionality
    ));
}

/**
 * éŒ¯èª¤è¨ºæ–·ç¯„æœ¬
 */
public Prompt createDiagnosisPrompt(String technology, String errorMessage) {
    String template = """
        ä½ æ˜¯ {technology} å°ˆå®¶ï¼Œè«‹åˆ†æéŒ¯èª¤ï¼š

        éŒ¯èª¤è¨Šæ¯ï¼š{errorMessage}

        è«‹æä¾›ï¼š
        1. éŒ¯èª¤åŸå› 
        2. è§£æ±ºæ–¹æ³•
        """;

    PromptTemplate promptTemplate = new PromptTemplate(template);
    return promptTemplate.create(Map.of(
        "technology", technology,
        "errorMessage", errorMessage
    ));
}
```

**ç¯„æœ¬è¨­è¨ˆåŸå‰‡**ï¼š
- **å–®ä¸€è·è²¬**ï¼šæ¯å€‹ç¯„æœ¬å°ˆæ³¨æ–¼ä¸€å€‹ç‰¹å®šä»»å‹™
- **åƒæ•¸åŒ–**ï¼šå°‡å¯è®Šéƒ¨åˆ†æŠ½å–ç‚ºåƒæ•¸
- **çµæ§‹åŒ–è¼¸å‡º**ï¼šæ˜ç¢ºæŒ‡å®šæœŸæœ›çš„è¼¸å‡ºæ ¼å¼
- **ä¸Šä¸‹æ–‡å®Œæ•´**ï¼šæä¾›è¶³å¤ çš„èƒŒæ™¯è³‡è¨Šè®“ AI ç†è§£ä»»å‹™

### æ¢ä»¶å¼ç¯„æœ¬

æ ¹æ“šä¸åŒæ¢ä»¶å‹•æ…‹é¸æ“‡ç¯„æœ¬ï¼š

```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../ConditionalPromptService.java:214

public Prompt createUserSpecificPrompt(String topic, String level) {
    String template = switch (level) {
        case "åˆç´š" -> """
            ä½ æ˜¯è€å¿ƒçš„å°å¸«ã€‚è«‹ç”¨ç°¡å–®èªè¨€èªªæ˜ {topic}ï¼š
            1. åŸºæœ¬æ¦‚å¿µ
            2. ç‚ºä»€éº¼é‡è¦
            3. å­¸ç¿’å»ºè­°
            """;
        case "ä¸­ç´š" -> """
            ä½ æ˜¯æŠ€è¡“å°ˆå®¶ã€‚è«‹èªªæ˜ {topic}ï¼š
            1. æ ¸å¿ƒåŸç†
            2. æ‡‰ç”¨å ´æ™¯
            3. ç¨‹å¼ç¢¼ç¯„ä¾‹
            """;
        default -> """
            ä½ æ˜¯è³‡æ·±æ¶æ§‹å¸«ã€‚è«‹æ·±åº¦åˆ†æ {topic}ï¼š
            1. å¯¦ç¾åŸç†
            2. æ¶æ§‹è¨­è¨ˆ
            3. æœ€ä½³å¯¦è¸
            """;
    };

    return new PromptTemplate(template).create(Map.of("topic", topic));
}
```

**æ¢ä»¶ç¯„æœ¬çš„æ‡‰ç”¨å ´æ™¯**ï¼š
- **ä½¿ç”¨è€…åˆ†å±¤**ï¼šæ ¹æ“šä½¿ç”¨è€…ç¨‹åº¦æä¾›ä¸åŒæ·±åº¦çš„å›ç­”
- **å¤šèªè¨€æ”¯æ´**ï¼šæ ¹æ“šèªè¨€åå¥½é¸æ“‡ä¸åŒç¯„æœ¬
- **æ¥­å‹™å ´æ™¯**ï¼šæ ¹æ“šä¸åŒæ¥­å‹™æµç¨‹ä½¿ç”¨å°ˆå±¬ç¯„æœ¬

---

## 5.1.4 ç¯„æœ¬åº«ç®¡ç†ç³»çµ±

### ç¯„æœ¬é…ç½®é¡

```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../PromptTemplateConfig.java:258

@Data
@Component
@ConfigurationProperties(prefix = "app.prompt.templates")
public class PromptTemplateConfig {

    /**
     * é å®šç¾©ç¯„æœ¬åº«
     */
    private Map<String, String> library = Map.of(
        "explain", """
            ä½œç‚ºä¸€å€‹ {role} å°ˆå®¶ï¼Œè«‹è©³ç´°èªªæ˜ {topic}ã€‚

            è«‹åŒ…å«ï¼š
            1. æ ¸å¿ƒæ¦‚å¿µ
            2. ä¸»è¦ç‰¹æ€§
            3. ä½¿ç”¨å ´æ™¯
            4. å¯¦éš›ç¯„ä¾‹

            ç›®æ¨™å—çœ¾ï¼š{audience}
            å›ç­”èªè¨€ï¼š{language}
            """,

        "code-review", """
            ä½ æ˜¯ä¸€å€‹è³‡æ·±çš„ {language} ç¨‹å¼ç¢¼å¯©æŸ¥å°ˆå®¶ã€‚

            è«‹å¯©æŸ¥ä»¥ä¸‹ç¨‹å¼ç¢¼ï¼š
            ```{language}
            {code}
            ```

            è«‹æä¾›ï¼š
            1. ç¨‹å¼ç¢¼å“è³ªè©•ä¼°
            2. æ½›åœ¨å•é¡Œè­˜åˆ¥
            3. æ”¹é€²å»ºè­°
            4. æœ€ä½³å¯¦è¸å»ºè­°
            """
    );

    /**
     * é è¨­åƒæ•¸å€¼
     */
    private Map<String, String> defaults = Map.of(
        "language", "ç¹é«”ä¸­æ–‡",
        "role", "æŠ€è¡“å°ˆå®¶",
        "audience", "ä¸­ç´šé–‹ç™¼è€…"
    );
}
```

**é…ç½®è¨­è¨ˆèªªæ˜**ï¼š
- **é›†ä¸­ç®¡ç†**ï¼šæ‰€æœ‰ç¯„æœ¬åœ¨ä¸€å€‹é…ç½®é¡ä¸­çµ±ä¸€ç®¡ç†
- **é è¨­å€¼**ï¼šæä¾›å¸¸ç”¨åƒæ•¸çš„é è¨­å€¼ï¼Œç°¡åŒ–ä½¿ç”¨
- **å¤–éƒ¨åŒ–é…ç½®**ï¼šå¯ä»¥é€é `application.yml` è¦†å¯«ç¯„æœ¬
- **é¡å‹å®‰å…¨**ï¼šä½¿ç”¨ `@ConfigurationProperties` æä¾›é¡å‹æª¢æŸ¥

### ç¯„æœ¬ç®¡ç†æœå‹™

```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../PromptTemplateManager.java:350

@Service
@RequiredArgsConstructor
@Slf4j
public class PromptTemplateManager {

    private final PromptTemplateConfig config;

    /**
     * æ ¹æ“šç¯„æœ¬åç¨±å»ºç«‹ Prompt
     */
    public Prompt createPrompt(String templateName, Map<String, Object> variables) {
        String template = config.getLibrary().get(templateName);
        if (template == null) {
            throw new IllegalArgumentException("ç¯„æœ¬ä¸å­˜åœ¨: " + templateName);
        }

        // åˆä½µé è¨­å€¼å’Œä½¿ç”¨è€…æä¾›çš„è®Šæ•¸
        Map<String, Object> mergedVariables = new HashMap<>(config.getDefaults());
        mergedVariables.putAll(variables);

        log.debug("ä½¿ç”¨ç¯„æœ¬ '{}' å»ºç«‹ Promptï¼Œè®Šæ•¸ï¼š{}", templateName, mergedVariables);

        PromptTemplate promptTemplate = new PromptTemplate(template);
        return promptTemplate.create(mergedVariables);
    }

    /**
     * å‹•æ…‹è¨»å†Šæ–°ç¯„æœ¬
     */
    public void registerTemplate(String name, String template) {
        config.getLibrary().put(name, template);
        log.info("è¨»å†Šæ–°ç¯„æœ¬ï¼š{}", name);
    }

    /**
     * ç²å–æ‰€æœ‰å¯ç”¨ç¯„æœ¬åç¨±
     */
    public Set<String> getAvailableTemplates() {
        return config.getLibrary().keySet();
    }
}
```

**ç®¡ç†æœå‹™çš„æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. **ç¯„æœ¬æŸ¥è©¢**ï¼šæ ¹æ“šåç¨±å¿«é€Ÿç²å–ç¯„æœ¬
2. **è®Šæ•¸åˆä½µ**ï¼šè‡ªå‹•åˆä½µé è¨­å€¼å’Œä½¿ç”¨è€…è®Šæ•¸
3. **å‹•æ…‹è¨»å†Š**ï¼šæ”¯æ´åŸ·è¡ŒæœŸå‹•æ…‹æ–°å¢ç¯„æœ¬
4. **ç¯„æœ¬é©—è­‰**ï¼šæª¢æŸ¥ç¯„æœ¬èªæ³•æ˜¯å¦æ­£ç¢º

### ç¯„æœ¬ç®¡ç†æµç¨‹

```mermaid
sequenceDiagram
    participant C as Controller
    participant M as PromptTemplateManager
    participant CF as PromptTemplateConfig
    participant PT as PromptTemplate
    participant CC as ChatClient

    C->>M: createPrompt(name, variables)
    M->>CF: getLibrary().get(name)
    CF-->>M: template string
    M->>M: mergeVariables()
    M->>PT: new PromptTemplate(template)
    M->>PT: create(mergedVariables)
    PT-->>M: Prompt
    M-->>C: Prompt
    C->>CC: prompt(prompt).call()
    CC-->>C: response
```

---

## 5.1.5 å¯¦éš›æ‡‰ç”¨ç¯„ä¾‹

### æ™ºèƒ½å®¢æœç¯„æœ¬ç³»çµ±

```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../CustomerServiceController.java:435

@PostMapping("/technical-support")
public String technicalSupport(
        @RequestParam String product,
        @RequestParam String issue,
        @RequestParam(defaultValue = "medium") String severity) {

    // è¨»å†ŠæŠ€è¡“æ”¯æ´ç¯„æœ¬
    String supportTemplate = """
        ä½ æ˜¯ {product} çš„è³‡æ·±æŠ€è¡“æ”¯æ´å°ˆå®¶ã€‚

        **å®¢æˆ¶å•é¡Œ**ï¼š{issue}
        **åš´é‡ç¨‹åº¦**ï¼š{severity}

        è«‹æä¾›å°ˆæ¥­çš„æŠ€è¡“æ”¯æ´å›æ‡‰ï¼š

        ## ğŸ” å•é¡Œç†è§£
        é‡è¿°ä¸¦ç¢ºèªå•é¡Œçš„æ ¸å¿ƒ

        ## ğŸ› ï¸ è§£æ±ºæ–¹æ¡ˆ
        æä¾›å…·é«”çš„è§£æ±ºæ­¥é©Ÿ

        ## ğŸ“‹ å¾ŒçºŒè¿½è¹¤
        å»ºè­°çš„å¾ŒçºŒè¡Œå‹•

        è«‹ä¿æŒå°ˆæ¥­ã€å‹å–„çš„èªèª¿ï¼Œç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚
        """;

    templateManager.registerTemplate("technical-support", supportTemplate);

    // å»ºç«‹ä¸¦åŸ·è¡Œ Prompt
    Prompt prompt = templateManager.createPrompt("technical-support", Map.of(
        "product", product,
        "issue", issue,
        "severity", severity
    ));

    return chatClient.prompt(prompt).call().content();
}
```

**æ‡‰ç”¨å ´æ™¯èªªæ˜**ï¼š
- **å‹•æ…‹ç¯„æœ¬è¨»å†Š**ï¼šæ ¹æ“šæ¥­å‹™éœ€æ±‚å‹•æ…‹å»ºç«‹ç¯„æœ¬
- **çµæ§‹åŒ–è¼¸å‡º**ï¼šä½¿ç”¨ Markdown æ ¼å¼åŒ–è¼¸å‡º
- **åƒæ•¸åŒ–å•é¡Œè™•ç†**ï¼šå°‡å®¢æˆ¶å•é¡Œæ¨™æº–åŒ–è™•ç†

### æ•™è‚²è¨“ç·´ç¯„æœ¬ç³»çµ±

```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../EducationController.java:546

@PostMapping("/generate-lesson")
public String generateLesson(
        @RequestParam String subject,
        @RequestParam String level,
        @RequestParam int duration) {

    String lessonTemplate = """
        ä½ æ˜¯ä¸€å€‹ç¶“é©—è±å¯Œçš„ {subject} æ•™å¸«ã€‚

        è«‹ç‚º {level} å­¸ç”Ÿè¨­è¨ˆä¸€å ‚ {duration} åˆ†é˜çš„èª²ç¨‹ï¼š

        ## ğŸ“š èª²ç¨‹ç›®æ¨™
        æ˜ç¢ºçš„å­¸ç¿’ç›®æ¨™ï¼ˆ3-5å€‹ï¼‰

        ## ğŸ• èª²ç¨‹å¤§ç¶±
        è©³ç´°çš„æ™‚é–“åˆ†é…å’Œå…§å®¹å®‰æ’

        ## ğŸ’¡ æ•™å­¸æ´»å‹•
        äº’å‹•å¼çš„æ•™å­¸æ´»å‹•è¨­è¨ˆ

        ## ğŸ“ è©•é‡æ–¹å¼
        æª¢é©—å­¸ç¿’æˆæ•ˆçš„æ–¹æ³•

        è«‹ç¢ºä¿å…§å®¹é©åˆç›®æ¨™å­¸ç”Ÿç¨‹åº¦ï¼Œä¸¦å…·æœ‰å¯¦ç”¨æ€§ã€‚
        """;

    templateManager.registerTemplate("lesson-plan", lessonTemplate);

    Prompt prompt = templateManager.createPrompt("lesson-plan", Map.of(
        "subject", subject,
        "level", level,
        "duration", String.valueOf(duration)
    ));

    return chatClient.prompt(prompt).call().content();
}
```

---

## 5.1.6 ç¯„æœ¬è¨­è¨ˆæœ€ä½³å¯¦è¸

### è¨­è¨ˆåŸå‰‡

**1. æ¸…æ™°çš„è§’è‰²å®šç¾©**
```java
// âœ… å¥½çš„ç¯„æœ¬
String template = """
    ä½ æ˜¯ä¸€å€‹æ“æœ‰10å¹´ç¶“é©—çš„ Spring Boot æ¶æ§‹å¸«ï¼Œ
    å°ˆç²¾æ–¼å¾®æœå‹™æ¶æ§‹è¨­è¨ˆå’Œæ•ˆèƒ½å„ªåŒ–ã€‚

    è«‹é‡å° {question} æä¾›å°ˆæ¥­å»ºè­°...
    """;

// âŒ ä¸å¥½çš„ç¯„æœ¬
String template = "è«‹å›ç­” {question}";
```

**2. çµæ§‹åŒ–è¼¸å‡ºæ ¼å¼**
```java
String template = """
    è«‹æŒ‰ç…§ä»¥ä¸‹æ ¼å¼å›ç­”ï¼š

    ## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ
    [ç°¡æ½”çš„æ¦‚å¿µèªªæ˜]

    ## ğŸ”§ å¯¦ä½œæ–¹æ³•
    [å…·é«”çš„å¯¦ä½œæ­¥é©Ÿ]

    ## ğŸ’¡ æœ€ä½³å¯¦è¸
    [ç›¸é—œçš„æœ€ä½³å¯¦è¸å»ºè­°]

    ## âš ï¸ æ³¨æ„äº‹é …
    [é‡è¦çš„æ³¨æ„äº‹é …]
    """;
```

**3. åƒæ•¸é©—è­‰å’Œé è¨­å€¼**
```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../ValidatedPromptService.java:633

public Prompt createValidatedPrompt(String template, Map<String, Object> variables) {
    // é©—è­‰å¿…è¦åƒæ•¸
    validateRequiredParameters(template, variables);

    // è¨­å®šé è¨­å€¼
    Map<String, Object> mergedVariables = applyDefaults(variables);

    // æ¸…ç†å’Œæ ¼å¼åŒ–åƒæ•¸
    Map<String, Object> cleanedVariables = cleanParameters(mergedVariables);

    PromptTemplate promptTemplate = new PromptTemplate(template);
    return promptTemplate.create(cleanedVariables);
}

private Map<String, Object> applyDefaults(Map<String, Object> variables) {
    Map<String, Object> result = new HashMap<>(variables);
    result.putIfAbsent("language", "ç¹é«”ä¸­æ–‡");
    result.putIfAbsent("style", "å°ˆæ¥­ä¸”å‹å–„");
    return result;
}
```

### æ•ˆèƒ½å„ªåŒ–ç­–ç•¥

```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../OptimizedPromptService.java:701

@Service
public class OptimizedPromptService {

    // å¿«å–ç·¨è­¯å¾Œçš„ç¯„æœ¬
    private final Map<String, PromptTemplate> templateCache = new ConcurrentHashMap<>();

    /**
     * å¿«å–ç¯„æœ¬ä»¥æå‡æ•ˆèƒ½
     */
    public Prompt createCachedPrompt(
            String templateKey,
            String templateContent,
            Map<String, Object> variables) {

        PromptTemplate template = templateCache.computeIfAbsent(templateKey, key -> {
            log.debug("ç·¨è­¯ä¸¦å¿«å–ç¯„æœ¬ï¼š{}", key);
            return new PromptTemplate(templateContent);
        });

        return template.create(variables);
    }

    /**
     * æ‰¹æ¬¡è™•ç†å¤šå€‹ç¯„æœ¬
     */
    public List<Prompt> createBatchPrompts(
            String templateContent,
            List<Map<String, Object>> variablesList) {

        PromptTemplate template = new PromptTemplate(templateContent);

        return variablesList.parallelStream()
            .map(template::create)
            .collect(Collectors.toList());
    }
}
```

**æ•ˆèƒ½å„ªåŒ–æŠ€å·§**ï¼š
1. **ç¯„æœ¬å¿«å–**ï¼šç·¨è­¯å¾Œçš„ç¯„æœ¬å¯ä»¥é‡è¤‡ä½¿ç”¨
2. **ä¸¦è¡Œè™•ç†**ï¼šä½¿ç”¨ `parallelStream()` æ‰¹æ¬¡è™•ç†
3. **è®Šæ•¸é è™•ç†**ï¼šåœ¨é€å…¥ç¯„æœ¬å‰å…ˆé©—è­‰å’Œæ¸…ç†è®Šæ•¸
4. **æŒ‰éœ€è¼‰å…¥**ï¼šåªè¼‰å…¥ä½¿ç”¨åˆ°çš„ç¯„æœ¬

---

## ğŸ“ æœ¬ç« é‡é»å›é¡§

1. **æç¤ºè©ç¯„æœ¬çš„åƒ¹å€¼**ï¼šç†è§£äº†ã€ŒGarbage in, Garbage outã€åŸå‰‡å’Œç¯„æœ¬çš„é‡è¦æ€§
2. **PromptTemplate ä½¿ç”¨**ï¼šæŒæ¡äº†åŸºæœ¬å’Œé€²éšçš„ç¯„æœ¬å»ºç«‹æ–¹æ³•
3. **ChatClient æ•´åˆ**ï¼šå­¸æœƒäº†å°‡ç¯„æœ¬èˆ‡ç¾ä»£åŒ–çš„ ChatClient API çµåˆ
4. **ç¯„æœ¬åº«ç®¡ç†**ï¼šå»ºç«‹äº†ä¼æ¥­ç´šçš„ç¯„æœ¬ç®¡ç†ç³»çµ±
5. **æœ€ä½³å¯¦è¸**ï¼šæŒæ¡äº†ç¯„æœ¬è¨­è¨ˆã€é©—è­‰å’Œå„ªåŒ–çš„æœ€ä½³å¯¦è¸

### é—œéµæŠ€è¡“è¦é»

| æŠ€è¡“é» | é‡è¦æ€§ | å¯¦ç¾é›£åº¦ | ä½¿ç”¨å ´æ™¯ |
|--------|--------|----------|----------|
| **åŸºç¤ç¯„æœ¬** | â­â­â­ | ä½ | æ‰€æœ‰ AI æ‡‰ç”¨ |
| **åƒæ•¸åŒ–è¨­è¨ˆ** | â­â­â­ | ä¸­ | å‹•æ…‹å…§å®¹ç”Ÿæˆ |
| **ç¯„æœ¬åº«ç®¡ç†** | â­â­ | ä¸­ | ä¼æ¥­ç´šæ‡‰ç”¨ |
| **æ¢ä»¶å¼ç¯„æœ¬** | â­â­ | é«˜ | è¤‡é›œæ¥­å‹™é‚è¼¯ |
| **æ•ˆèƒ½å„ªåŒ–** | â­ | ä¸­ | é«˜ä½µç™¼å ´æ™¯ |

### å¯¦å‹™å»ºè­°

**ä½•æ™‚ä½¿ç”¨æç¤ºè©ç¯„æœ¬**ï¼š
- âœ… éœ€è¦é‡è¤‡åŸ·è¡Œç›¸åŒé¡å‹çš„ AI ä»»å‹™
- âœ… éœ€è¦ç¢ºä¿ AI å›æ‡‰çš„ä¸€è‡´æ€§å’Œå“è³ª
- âœ… æœ‰å¤šå€‹é–‹ç™¼äººå“¡ä½¿ç”¨ç›¸åŒçš„ AI åŠŸèƒ½
- âœ… éœ€è¦æ ¹æ“šä¸åŒæ¢ä»¶å‹•æ…‹èª¿æ•´æç¤ºè©

**ä½•æ™‚ä¸éœ€è¦ç¯„æœ¬**ï¼š
- âŒ ç°¡å–®çš„ä¸€æ¬¡æ€§å•ç­”
- âŒ æ¢ç´¢æ€§çš„ AI å¯¦é©—
- âŒ ä½¿ç”¨è€…è‡ªç”±è¼¸å…¥çš„å ´æ™¯

### ä¸‹ä¸€æ­¥å­¸ç¿’æ–¹å‘

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘å€‘å°‡å­¸ç¿’å¦‚ä½•è™•ç†å¤šæ¨¡æ…‹è³‡æ–™ï¼Œè®“ AI ä¸åƒ…èƒ½ç†è§£æ–‡å­—ï¼Œé‚„èƒ½è™•ç†åœ–ç‰‡ã€éŸ³è¨Šç­‰å¤šç¨®åª’é«”æ ¼å¼ï¼Œé€²ä¸€æ­¥æå‡ ChatBot çš„æ™ºèƒ½åŒ–ç¨‹åº¦ã€‚

---

**åƒè€ƒè³‡æ–™ï¼š**
- [Spring AI Prompt Template Documentation](https://docs.spring.io/spring-ai/reference/api/prompt.html)
- [ChatClient API Reference](https://docs.spring.io/spring-ai/reference/api/chatclient.html)
- [Prompt Engineering Best Practices](https://platform.openai.com/docs/guides/prompt-engineering)
- å®Œæ•´ç¯„ä¾‹ç¨‹å¼ç¢¼ï¼š`code-examples/chapter5-spring-ai-advanced`
