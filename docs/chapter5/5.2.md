# 5.2 å¦‚ä½•è·Ÿ ChatGPT ä¸€æ¨£è™•ç†å¤šæ¨¡æ…‹è³‡æ–™

> **å°æ‡‰ç« ç¯€**: Day12
> **å°æ‡‰ç¯„ä¾‹**: `chapter5-spring-ai-advanced`
> **é›£åº¦**: â­â­â­â˜†â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

å¤šæ¨¡æ…‹ï¼ˆMultimodalityï¼‰æ˜¯æŒ‡ AI ç³»çµ±èƒ½å¤ åŒæ™‚è™•ç†å¤šç¨®é¡å‹çš„è³‡æ–™è¼¸å…¥ï¼Œå¦‚æ–‡å­—ã€åœ–ç‰‡ã€éŸ³è¨Šã€å½±ç‰‡ç­‰ã€‚Spring AI é€éçµ±ä¸€çš„ API è¨­è¨ˆï¼Œè®“é–‹ç™¼è€…èƒ½å¤ è¼•é¬†å»ºç«‹å¦‚åŒ ChatGPT èˆ¬å¼·å¤§çš„å¤šæ¨¡æ…‹æ‡‰ç”¨ã€‚

**å­¸ç¿’ç›®æ¨™**ï¼š
- ç†è§£å¤šæ¨¡æ…‹ AI çš„æ ¸å¿ƒæ¦‚å¿µå’Œåƒ¹å€¼
- æŒæ¡ Spring AI çš„å¤šæ¨¡æ…‹æ¶æ§‹è¨­è¨ˆ
- å­¸æœƒé¸æ“‡å’Œä½¿ç”¨æ”¯æ´å¤šæ¨¡æ…‹çš„ AI æ¨¡å‹
- å¯¦ç¾åœ–ç‰‡ã€éŸ³è¨Šç­‰å¤šåª’é«”æª”æ¡ˆçš„åˆ†æåŠŸèƒ½
- å»ºç«‹ä¼æ¥­ç´šçš„å¤šæ¨¡æ…‹è™•ç†ç³»çµ±

---

## 5.2.1 ä»€éº¼æ˜¯å¤šæ¨¡æ…‹ AIï¼Ÿ

### å¤šæ¨¡æ…‹å°±æ˜¯åŒæ™‚æä¾›å…©ç¨®ä»¥ä¸Šè³‡æ–™æº

![å¤šæ¨¡æ…‹ AI](https://ithelp.ithome.com.tw/upload/images/20240810/201612905TZ6mYSAy1.jpg)

**å¤šæ¨¡æ…‹ï¼ˆMultimodalityï¼‰** æ˜¯æŒ‡ AI ç³»çµ±èƒ½å¤ åŒæ™‚è™•ç†å’Œç†è§£å¤šç¨®ä¸åŒé¡å‹çš„è³‡æ–™è¼¸å…¥ï¼Œå¦‚æ–‡å­—ã€åœ–ç‰‡ã€éŸ³è¨Šã€å½±ç‰‡ç­‰ã€‚é€™ç¨®èƒ½åŠ›è®“ AI æ›´æ¥è¿‘äººé¡çš„æ„ŸçŸ¥æ–¹å¼ï¼Œèƒ½å¤ ç¶œåˆå¤šç¨®æ„Ÿå®˜è³‡è¨Šä¾†ç†è§£å’Œå›æ‡‰ã€‚

### Spring AI ä¸­çš„å¤šæ¨¡æ…‹æ¶æ§‹

é‚„è¨˜å¾— Message é€™å¼µ UML åœ–ç‰‡å—ï¼Ÿåœ¨ UserMessage ä¸­å…¶å¯¦æ˜¯å¯ä»¥åŒ…å«å¤šåª’é«”æª”æ¡ˆçš„ï¼š

```mermaid
classDiagram
    class Message {
        <<abstract>>
        +String content
        +Map~String,Object~ metadata
    }

    class UserMessage {
        +String content
        +List~Media~ media
        +UserMessage(String text)
        +UserMessage(String text, List~Media~ media)
    }

    class AssistantMessage {
        +String content
        +List~ToolCall~ toolCalls
    }

    class SystemMessage {
        +String content
    }

    class Media {
        +MimeType mimeType
        +Resource data
    }

    Message <|-- UserMessage
    Message <|-- AssistantMessage
    Message <|-- SystemMessage
    UserMessage o-- Media

    note for UserMessage "æ”¯æ´æ–‡å­— + å¤šåª’é«”"
    note for Media "å°è£åª’é«”è³‡æ–™"
```

**æ¶æ§‹èªªæ˜**ï¼š
- **UserMessage** å¯ä»¥åŒ…å«æ–‡å­—å…§å®¹å’Œå¤šå€‹ Media ç‰©ä»¶
- **Media** å°è£äº†åª’é«”é¡å‹ï¼ˆMimeTypeï¼‰å’Œè³‡æ–™ï¼ˆResourceï¼‰
- Spring AI è‡ªå‹•è™•ç†ä¸åŒåª’é«”æ ¼å¼çš„åºåˆ—åŒ–å’Œå‚³è¼¸

**é‡è¦èªªæ˜**ï¼šé›–ç„¶ UserMessage é¡åˆ¥æ”¯æ´ç›´æ¥å‚³å…¥ Media ç‰©ä»¶ï¼Œä½†åœ¨å¯¦éš›é–‹ç™¼ä¸­ï¼Œ**å»ºè­°ä½¿ç”¨ ChatClient çš„ fluent API**ï¼Œå› ç‚ºå®ƒæä¾›äº†æ›´å¥½çš„é–‹ç™¼é«”é©—å’ŒéŒ¯èª¤è™•ç†ã€‚

### å¤šæ¨¡æ…‹çš„æ ¸å¿ƒåƒ¹å€¼

**1. æ›´è±å¯Œçš„äº’å‹•é«”é©—**
- ğŸ“¸ **è¦–è¦ºç†è§£**ï¼šåˆ†æåœ–ç‰‡å…§å®¹ã€è­˜åˆ¥ç‰©é«”ã€ç†è§£å ´æ™¯
- ğŸµ **è½è¦ºè™•ç†**ï¼šèªéŸ³è½‰æ–‡å­—ã€éŸ³æ¨‚åˆ†æã€è²éŸ³è­˜åˆ¥
- ğŸ¬ **å½±ç‰‡åˆ†æ**ï¼šå‹•ä½œè­˜åˆ¥ã€å ´æ™¯ç†è§£ã€å…§å®¹æ‘˜è¦
- ğŸ“„ **æ–‡ä»¶è™•ç†**ï¼šOCR æ–‡å­—è­˜åˆ¥ã€è¡¨æ ¼åˆ†æã€ç‰ˆé¢ç†è§£

**2. æ›´æº–ç¢ºçš„ç†è§£èƒ½åŠ›**
- ğŸ” **ä¸Šä¸‹æ–‡å¢å¼·**ï¼šçµåˆå¤šç¨®è³‡è¨Šæºæä¾›æ›´æº–ç¢ºçš„åˆ†æ
- ğŸ§  **èªç¾©ç†è§£**ï¼šé€éè¦–è¦ºå’Œæ–‡å­—çš„çµåˆæå‡ç†è§£æ·±åº¦
- ğŸ¯ **ç²¾ç¢ºå›æ‡‰**ï¼šåŸºæ–¼å¤šæ¨¡æ…‹è³‡è¨Šæä¾›æ›´ç²¾ç¢ºçš„ç­”æ¡ˆ

**3. æ›´å»£æ³›çš„æ‡‰ç”¨å ´æ™¯**
- ğŸ¥ **é†«ç™‚è¨ºæ–·**ï¼šçµåˆå½±åƒå’Œç—…æ­·è³‡æ–™é€²è¡Œè¼”åŠ©è¨ºæ–·
- ğŸ›’ **é›»å•†æ‡‰ç”¨**ï¼šå•†å“åœ–ç‰‡åˆ†æå’Œæ¨è–¦
- ğŸ“š **æ•™è‚²åŸ¹è¨“**ï¼šå¤šåª’é«”æ•™æçš„æ™ºèƒ½åˆ†æå’Œå•ç­”
- ğŸ­ **å·¥æ¥­æª¢æ¸¬**ï¼šè¨­å‚™åœ–ç‰‡åˆ†æå’Œæ•…éšœè¨ºæ–·

### å¤šæ¨¡æ…‹è™•ç†æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ¶
    participant C as Controller
    participant CC as ChatClient
    participant AI as AI æ¨¡å‹

    U->>C: ä¸Šå‚³æ–‡å­— + åœ–ç‰‡
    C->>C: é©—è­‰æª”æ¡ˆæ ¼å¼
    C->>C: å»ºç«‹ Resource
    C->>CC: .user(text).media(type, resource)
    CC->>AI: ç™¼é€å¤šæ¨¡æ…‹è«‹æ±‚
    AI->>AI: ç†è§£æ–‡å­—å’Œåœ–ç‰‡
    AI-->>CC: è¿”å›åˆ†æçµæœ
    CC-->>C: å›æ‡‰å…§å®¹
    C-->>U: é¡¯ç¤ºçµæœ

    Note over AI: æ”¯æ´å¤šæ¨¡æ…‹çš„æ¨¡å‹<br/>å¦‚ GPT-4o, Claude 3.5
```

---

## 5.2.2 æ”¯æ´å¤šæ¨¡æ…‹çš„ AI æ¨¡å‹

### ä¸»æµæ¨¡å‹èƒ½åŠ›å°æ¯”

ç›®å‰æœ‰æ”¯æ´å¤šæ¨¡æ…‹çš„æ¨¡å‹å¦‚ä¸‹ï¼Œå…¶ä»–æ¨¡å‹é€å‡ºå¤šåª’é«”æª”æ¡ˆæ™‚å¯æ˜¯æœƒå‡ºç¾éŒ¯èª¤çš„ï¼š

| æ¨¡å‹æä¾›å•† | æ¨¡å‹åç¨± | åœ–åƒ | éŸ³é » | è¦–é » | æ–‡ä»¶ | æˆæœ¬æ•ˆç›Š | æ¨è–¦å ´æ™¯ |
|-----------|---------|------|------|------|------|----------|----------|
| **OpenAI** | GPT-4o | âœ… | âœ… | âœ… | âœ… | é«˜ | å…¨æ–¹ä½å¤šæ¨¡æ…‹æ‡‰ç”¨ |
| **OpenAI** | GPT-4o mini | âœ… | âŒ | âŒ | âœ… | æ¥µé«˜ | åœ–ç‰‡åˆ†æã€æ–‡ä»¶è™•ç† |
| **OpenAI** | GPT-4 Vision | âœ… | âŒ | âŒ | âœ… | ä¸­ | åœ–ç‰‡åˆ†æå°ˆç”¨ |
| **Anthropic** | Claude 3.5 Sonnet | âœ… | âŒ | âŒ | âœ… | é«˜ | åœ–ç‰‡+æ–‡å­—åˆ†æ |
| **Anthropic** | Claude 3 Opus | âœ… | âŒ | âŒ | âœ… | ä¸­ | è¤‡é›œåœ–ç‰‡ç†è§£ |
| **Google** | Gemini 1.5 Pro | âœ… | âœ… | âœ… | âœ… | ä¸­ | å¤šåª’é«”å…§å®¹åˆ†æ |
| **Google** | Gemini Pro Vision | âœ… | âŒ | âŒ | âœ… | é«˜ | åœ–ç‰‡è­˜åˆ¥ |
| **Ollama** | LlaVa | âœ… | âŒ | âŒ | âŒ | æ¥µé«˜(æœ¬åœ°) | æœ¬åœ°åœ–ç‰‡åˆ†æ |
| **Ollama** | Bakllava | âœ… | âŒ | âŒ | âŒ | æ¥µé«˜(æœ¬åœ°) | æœ¬åœ°å¤šæ¨¡æ…‹ |

### è¼¸å…¥è¼¸å‡ºæ ¼å¼æ”¯æ´è¡¨

| Input | Output | Examples | é©ç”¨å ´æ™¯ |
|-------|--------|----------|----------|
| **Language/Code/Images** | Language/Code | GPT-4o, Gemini 1.5 Pro | å¤šæ¨¡æ…‹å•ç­”ã€ç¨‹å¼ç¢¼åˆ†æ |
| **Language/Code** | Language/Code | GPT-3.5, Claude 3 Haiku | ç´”æ–‡å­—å°è©± |
| **Language** | Image | DALL-E 3, Midjourney | æ–‡å­—ç”Ÿæˆåœ–ç‰‡ |
| **Language/Image** | Image | Stable Diffusion | åœ–ç‰‡ç·¨è¼¯ã€é¢¨æ ¼è½‰æ› |
| **Language** | Audio | OpenAI TTS, ElevenLabs | æ–‡å­—è½‰èªéŸ³ |
| **Audio** | Language | OpenAI Whisper | èªéŸ³è½‰æ–‡å­— |
| **Text** | Numbers | Embedding Models | å‘é‡åŒ–ã€ç›¸ä¼¼åº¦è¨ˆç®— |

### æ¨¡å‹é¸æ“‡å»ºè­°

```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../config/MultimodalModelConfig.java

@Configuration
public class MultimodalModelConfig {

    @Value("${spring.ai.openai.api-key}")
    private String openaiApiKey;

    /**
     * æ ¹æ“šä½¿ç”¨å ´æ™¯é¸æ“‡åˆé©çš„æ¨¡å‹
     */
    @Bean
    @Primary
    public ChatModel primaryMultimodalModel() {
        // GPT-4o miniï¼šæ€§åƒ¹æ¯”æœ€é«˜çš„åœ–ç‰‡åˆ†ææ¨¡å‹
        return OpenAiChatModel.builder()
            .apiKey(openaiApiKey)
            .modelName("gpt-4o-mini")
            .temperature(0.3)  // è¼ƒä½æº«åº¦ç¢ºä¿åˆ†ææº–ç¢ºæ€§
            .maxTokens(1500)
            .build();
    }

    /**
     * é«˜ç²¾åº¦åœ–ç‰‡åˆ†ææ¨¡å‹
     */
    @Bean("highAccuracyModel")
    public ChatModel highAccuracyModel() {
        // GPT-4oï¼šæœ€å¼·å¤šæ¨¡æ…‹èƒ½åŠ›
        return OpenAiChatModel.builder()
            .apiKey(openaiApiKey)
            .modelName("gpt-4o")
            .temperature(0.2)
            .maxTokens(2000)
            .build();
    }

    /**
     * æœ¬åœ°å¤šæ¨¡æ…‹æ¨¡å‹ï¼ˆç¯€çœæˆæœ¬ï¼‰
     */
    @Bean("localModel")
    @ConditionalOnProperty(name = "app.ai.local.enabled", havingValue = "true")
    public ChatModel localMultimodalModel() {
        // Ollama LlaVaï¼šæœ¬åœ°å…è²»æ–¹æ¡ˆ
        return OllamaChatModel.builder()
            .baseUrl("http://localhost:11434")
            .model("llava")
            .build();
    }
}
```

**æ¨¡å‹é¸æ“‡æ±ºç­–æ¨¹**ï¼š

```mermaid
graph TD
    A[é¸æ“‡å¤šæ¨¡æ…‹æ¨¡å‹] --> B{éœ€è¦è™•ç†ä»€éº¼åª’é«”?}
    B -->|åœ–ç‰‡ + æ–‡å­—| C{é ç®—è€ƒé‡?}
    B -->|éŸ³è¨Š + æ–‡å­—| D[GPT-4o / Gemini 1.5 Pro]
    B -->|å½±ç‰‡ + æ–‡å­—| D

    C -->|æˆæœ¬å„ªå…ˆ| E[GPT-4o mini]
    C -->|å“è³ªå„ªå…ˆ| F[GPT-4o / Claude 3.5]
    C -->|æœ¬åœ°éƒ¨ç½²| G[Ollama LlaVa]

    style E fill:#e8f5e9
    style F fill:#e3f2fd
    style G fill:#fff9c4
```

---

## 5.2.3 åœ–ç‰‡åˆ†æåŠŸèƒ½å¯¦ç¾

### åŸºç¤åœ–ç‰‡ä¸Šå‚³å’Œåˆ†æ

```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../MultimodalController.java:175

@RestController
@RequestMapping("/api/multimodal")
@RequiredArgsConstructor
@Slf4j
public class MultimodalController {

    private final ChatClient chatClient;

    /**
     * åŸºç¤åœ–ç‰‡åˆ†æ
     */
    @PostMapping(value = "/image-analysis", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public String analyzeImage(
            @RequestParam("file") MultipartFile file,
            @RequestParam("message") String message) {

        try {
            // 1. é©—è­‰æª”æ¡ˆé¡å‹
            if (!isValidImageFile(file)) {
                return "âŒ ä¸æ”¯æ´çš„åœ–ç‰‡æ ¼å¼ã€‚æ”¯æ´ï¼šJPEG, PNG, GIF, WebP";
            }

            // 2. å»ºç«‹ Resource å’Œ MimeType
            Resource imageResource = file.getResource();
            MimeType mimeType = MimeTypeUtils.parseMimeType(file.getContentType());

            log.info("åˆ†æåœ–ç‰‡ï¼š{}ï¼Œå¤§å°ï¼š{} bytes",
                    file.getOriginalFilename(), file.getSize());

            // 3. ä½¿ç”¨ ChatClient é€²è¡Œå¤šæ¨¡æ…‹åˆ†æ
            String response = chatClient.prompt()
                    .user(u -> u.text(message)
                            .media(mimeType, imageResource))
                    .call()
                    .content();

            return response;

        } catch (Exception e) {
            log.error("åœ–ç‰‡åˆ†æå¤±æ•—", e);
            return "âŒ AI åˆ†æå¤±æ•—ï¼š" + e.getMessage();
        }
    }

    /**
     * é©—è­‰åœ–ç‰‡æª”æ¡ˆæ ¼å¼
     */
    private boolean isValidImageFile(MultipartFile file) {
        String contentType = file.getContentType();
        return contentType != null && (
            contentType.equals("image/jpeg") ||
            contentType.equals("image/png") ||
            contentType.equals("image/gif") ||
            contentType.equals("image/webp")
        );
    }
}
```

**å¯¦ç¾è¦é»**ï¼š
1. **æª”æ¡ˆé©—è­‰**ï¼šæª¢æŸ¥æª”æ¡ˆé¡å‹å’Œå¤§å°ï¼Œé¿å…è™•ç†ç„¡æ•ˆæª”æ¡ˆ
2. **Resource å»ºç«‹**ï¼šä½¿ç”¨ Spring çš„ Resource æŠ½è±¡è™•ç†æª”æ¡ˆ
3. **MimeType è§£æ**ï¼šæ­£ç¢ºè¨­å®šåª’é«”é¡å‹ï¼Œè®“ AI è­˜åˆ¥æª”æ¡ˆæ ¼å¼
4. **éŒ¯èª¤è™•ç†**ï¼šæä¾›æ¸…æ™°çš„éŒ¯èª¤è¨Šæ¯å’Œæ—¥èªŒè¨˜éŒ„

### é€²éšåœ–ç‰‡åˆ†æåŠŸèƒ½

```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../MultimodalController.java:220

/**
 * æ‰¹æ¬¡åœ–ç‰‡åˆ†æ
 */
@PostMapping(value = "/batch-analysis", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
public List<ImageAnalysisResult> batchAnalyzeImages(
        @RequestParam("files") List<MultipartFile> files,
        @RequestParam("analysisType") String analysisType) {

    return files.parallelStream()
            .map(file -> {
                try {
                    Resource imageResource = file.getResource();
                    MimeType mimeType = MimeTypeUtils.parseMimeType(
                            file.getContentType());

                    String prompt = buildAnalysisPrompt(analysisType);

                    String result = chatClient.prompt()
                            .user(u -> u.text(prompt)
                                    .media(mimeType, imageResource))
                            .call()
                            .content();

                    return new ImageAnalysisResult(
                            file.getOriginalFilename(),
                            true,
                            result
                    );

                } catch (Exception e) {
                    log.error("æ‰¹æ¬¡åˆ†æå¤±æ•—ï¼š{}", file.getOriginalFilename(), e);
                    return new ImageAnalysisResult(
                            file.getOriginalFilename(),
                            false,
                            "åˆ†æå¤±æ•—ï¼š" + e.getMessage()
                    );
                }
            })
            .collect(Collectors.toList());
}

/**
 * æ ¹æ“šåˆ†æé¡å‹å»ºç«‹æç¤ºè©
 */
private String buildAnalysisPrompt(String analysisType) {
    return switch (analysisType.toLowerCase()) {
        case "object-detection" ->
            "è«‹è­˜åˆ¥åœ–ç‰‡ä¸­çš„æ‰€æœ‰ç‰©é«”ï¼Œä¸¦åˆ—å‡ºå®ƒå€‘çš„ä½ç½®å’Œé¡å‹ã€‚";
        case "scene-understanding" ->
            "è«‹æè¿°åœ–ç‰‡çš„å ´æ™¯ï¼ŒåŒ…æ‹¬ç’°å¢ƒã€æ°›åœå’Œä¸»è¦å…ƒç´ ã€‚";
        case "text-extraction" ->
            "è«‹æå–åœ–ç‰‡ä¸­çš„æ‰€æœ‰æ–‡å­—å…§å®¹ï¼Œä¿æŒåŸæœ‰æ ¼å¼ã€‚";
        case "quality-assessment" ->
            "è«‹è©•ä¼°åœ–ç‰‡çš„å“è³ªï¼ŒåŒ…æ‹¬æ¸…æ™°åº¦ã€æ§‹åœ–å’Œè‰²å½©ã€‚";
        default ->
            "è«‹è©³ç´°åˆ†æé€™å¼µåœ–ç‰‡çš„å…§å®¹ã€‚";
    };
}
```

**æ‰¹æ¬¡è™•ç†çš„é—œéµæŠ€è¡“**ï¼š
1. **ä¸¦è¡Œè™•ç†**ï¼šä½¿ç”¨ `parallelStream()` æå‡è™•ç†æ•ˆç‡
2. **éŒ¯èª¤éš”é›¢**ï¼šå–®å€‹æª”æ¡ˆå¤±æ•—ä¸å½±éŸ¿å…¶ä»–æª”æ¡ˆ
3. **çµæœè¿½è¹¤**ï¼šè¨˜éŒ„æ¯å€‹æª”æ¡ˆçš„è™•ç†ç‹€æ…‹
4. **å‹•æ…‹æç¤ºè©**ï¼šæ ¹æ“šåˆ†æé¡å‹èª¿æ•´æç¤ºè©

---

## 5.2.4 å¤šåª’é«”æª”æ¡ˆè™•ç†

### éŸ³è¨Šæª”æ¡ˆåˆ†æ

```java
// å°æ‡‰ç¯„ä¾‹: chapter5-spring-ai-advanced/.../AudioAnalysisController.java

@RestController
@RequestMapping("/api/audio")
@RequiredArgsConstructor
public class AudioAnalysisController {

    private final ChatClient chatClient;

    /**
     * éŸ³è¨Šå…§å®¹åˆ†æï¼ˆéœ€è¦æ”¯æ´éŸ³è¨Šçš„æ¨¡å‹å¦‚ GPT-4oï¼‰
     */
    @PostMapping("/analyze")
    public String analyzeAudio(
            @RequestParam("file") MultipartFile file,
            @RequestParam(value = "message", defaultValue = "è«‹åˆ†æé€™å€‹éŸ³è¨Š") String message) {

        try {
            // é©—è­‰éŸ³è¨Šæª”æ¡ˆæ ¼å¼
            if (!isValidAudioFile(file)) {
                return "âŒ ä¸æ”¯æ´çš„éŸ³è¨Šæ ¼å¼ã€‚æ”¯æ´ï¼šMP3, WAV, MP4, OGG";
            }

            // å»ºç«‹ Resource å’Œ MimeType
            Resource audioResource = file.getResource();
            MimeType mimeType = MimeTypeUtils.parseMimeType(file.getContentType());

            log.info("åˆ†æéŸ³è¨Šï¼š{}ï¼Œå¤§å°ï¼š{} bytes",
                    file.getOriginalFilename(), file.getSize());

            // ä½¿ç”¨ ChatClient é€²è¡ŒéŸ³è¨Šåˆ†æ
            return chatClient.prompt()
                    .user(u -> u.text(message)
                            .media(mimeType, audioResource))
                    .call()
                    .content();

        } catch (Exception e) {
            log.error("éŸ³è¨Šåˆ†æå¤±æ•—", e);
            return "âŒ éŸ³è¨Šåˆ†æå¤±æ•—ï¼š" + e.getMessage();
        }
    }

    private boolean isValidAudioFile(MultipartFile file) {
        String contentType = file.getContentType();
        return contentType != null && (
            contentType.equals("audio/mpeg") ||
            contentType.equals("audio/wav") ||
            contentType.equals("audio/mp4") ||
            contentType.equals("audio/ogg")
        );
    }
}
```

### æ–‡ä»¶æ™ºèƒ½åˆ†æ

```java
/**
 * PDF æ–‡ä»¶åˆ†æ
 */
@PostMapping("/document-analysis")
public DocumentAnalysisResult analyzeDocument(
        @RequestParam("file") MultipartFile file,
        @RequestParam(value = "task", defaultValue = "summarize") String task) {

    try {
        Resource documentResource = file.getResource();
        MimeType mimeType = MimeTypeUtils.parseMimeType(file.getContentType());

        String prompt = switch (task) {
            case "summarize" -> "è«‹ç¸½çµé€™ä»½æ–‡ä»¶çš„é‡é»å…§å®¹ã€‚";
            case "extract-data" -> "è«‹æå–æ–‡ä»¶ä¸­çš„é—œéµè³‡æ–™å’Œæ•¸æ“šã€‚";
            case "qa" -> "è«‹åˆ—å‡ºæ–‡ä»¶ä¸­çš„å¸¸è¦‹å•é¡Œå’Œç­”æ¡ˆã€‚";
            default -> "è«‹åˆ†æé€™ä»½æ–‡ä»¶ã€‚";
        };

        String analysis = chatClient.prompt()
                .user(u -> u.text(prompt)
                        .media(mimeType, documentResource))
                .call()
                .content();

        return new DocumentAnalysisResult(
                file.getOriginalFilename(),
                task,
                analysis,
                LocalDateTime.now()
        );

    } catch (Exception e) {
        log.error("æ–‡ä»¶åˆ†æå¤±æ•—", e);
        throw new RuntimeException("æ–‡ä»¶åˆ†æå¤±æ•—ï¼š" + e.getMessage());
    }
}
```

---

## 5.2.5 ä¼æ¥­ç´šæ‡‰ç”¨å ´æ™¯

### æ™ºèƒ½å®¢æœåœ–ç‰‡å•ç­”

```java
@Service
@RequiredArgsConstructor
@Slf4j
public class CustomerServiceMultimodalService {

    private final ChatClient chatClient;

    /**
     * å®¢æœåœ–ç‰‡å•é¡Œè™•ç†
     */
    public CustomerServiceResponse handleImageQuery(
            MultipartFile productImage,
            String customerQuestion) {

        try {
            Resource imageResource = productImage.getResource();
            MimeType mimeType = MimeTypeUtils.parseMimeType(
                    productImage.getContentType());

            String systemPrompt = """
                ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„å®¢æœäººå“¡ã€‚å®¢æˆ¶ä¸Šå‚³äº†ç”¢å“åœ–ç‰‡ä¸¦æå‡ºå•é¡Œã€‚
                è«‹æ ¹æ“šåœ–ç‰‡å…§å®¹å’Œå•é¡Œæä¾›å°ˆæ¥­ã€å‹å–„çš„å›ç­”ã€‚

                å›ç­”æ ¼å¼ï¼š
                1. å•é¡Œç†è§£
                2. åœ–ç‰‡åˆ†æ
                3. è§£æ±ºæ–¹æ¡ˆ
                4. å¾ŒçºŒå»ºè­°
                """;

            String response = chatClient.prompt()
                    .system(systemPrompt)
                    .user(u -> u.text(customerQuestion)
                            .media(mimeType, imageResource))
                    .call()
                    .content();

            log.info("å®¢æœåœ–ç‰‡å•ç­”å®Œæˆï¼š{}", customerQuestion);

            return new CustomerServiceResponse(
                    true,
                    response,
                    "image-analysis",
                    LocalDateTime.now()
            );

        } catch (Exception e) {
            log.error("å®¢æœåœ–ç‰‡å•ç­”å¤±æ•—", e);
            return new CustomerServiceResponse(
                    false,
                    "æŠ±æ­‰ï¼Œåœ–ç‰‡åˆ†æå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–è¯ç¹«äººå·¥å®¢æœã€‚",
                    "error",
                    LocalDateTime.now()
            );
        }
    }
}
```

---

## ğŸ“ æœ¬ç« é‡é»å›é¡§

1. **å¤šæ¨¡æ…‹æ¦‚å¿µç†è§£**ï¼šæŒæ¡äº†å¤šæ¨¡æ…‹ AI çš„æ ¸å¿ƒåƒ¹å€¼å’Œæ‡‰ç”¨å ´æ™¯
2. **æ¨¡å‹é¸æ“‡ç­–ç•¥**ï¼šäº†è§£äº†å„ç¨® AI æ¨¡å‹çš„å¤šæ¨¡æ…‹èƒ½åŠ›å’Œé©ç”¨å ´æ™¯
3. **åœ–ç‰‡åˆ†æå¯¦ç¾**ï¼šå»ºç«‹äº†å®Œæ•´çš„åœ–ç‰‡ä¸Šå‚³ã€åˆ†æå’Œæ‰¹æ¬¡è™•ç†åŠŸèƒ½
4. **å¤šåª’é«”è™•ç†**ï¼šå¯¦ç¾äº†éŸ³è¨Šã€æ–‡ä»¶ç­‰å¤šç¨®åª’é«”æ ¼å¼çš„åˆ†æåŠŸèƒ½
5. **ä¼æ¥­ç´šæ‡‰ç”¨**ï¼šè¨­è¨ˆäº†å®¢æœç­‰å¯¦éš›æ¥­å‹™å ´æ™¯çš„è§£æ±ºæ–¹æ¡ˆ

### æŠ€è¡“è¦é»ç¸½çµ

| æŠ€è¡“é» | é‡è¦æ€§ | å¯¦ç¾é›£åº¦ | ä½¿ç”¨å ´æ™¯ |
|--------|--------|----------|----------|
| **åœ–ç‰‡åˆ†æ** | â­â­â­ | ä¸­ | æ‰€æœ‰è¦–è¦º AI æ‡‰ç”¨ |
| **æ–‡ä»¶ OCR** | â­â­â­ | ä¸­ | ä¼æ¥­æ–‡ä»¶è™•ç† |
| **éŸ³è¨Šè™•ç†** | â­â­ | é«˜ | èªéŸ³æ‡‰ç”¨ã€å…§å®¹åˆ†æ |
| **æ‰¹æ¬¡è™•ç†** | â­â­ | ä¸­ | å¤§é‡æª”æ¡ˆè™•ç† |
| **éŒ¯èª¤è™•ç†** | â­â­â­ | ä¸­ | ç”Ÿç”¢ç’°å¢ƒç©©å®šæ€§ |

### æœ€ä½³å¯¦è¸å»ºè­°

**1. æª”æ¡ˆè™•ç†**
- âœ… å§‹çµ‚é©—è­‰æª”æ¡ˆæ ¼å¼ã€å¤§å°å’Œå…§å®¹
- âœ… ä½¿ç”¨ Spring çš„ Resource æŠ½è±¡
- âœ… æ­£ç¢ºè¨­å®š MimeType
- âœ… å¯¦ç¾å®Œå–„çš„éŒ¯èª¤è™•ç†

**2. æ•ˆèƒ½å„ªåŒ–**
- âœ… æ‰¹æ¬¡è™•ç†ä½¿ç”¨ä¸¦è¡Œæµ
- âœ… é™åˆ¶å–®æ¬¡ä¸Šå‚³æª”æ¡ˆå¤§å°
- âœ… ä½¿ç”¨éåŒæ­¥è™•ç†å¤§æª”æ¡ˆ
- âœ… å¯¦ç¾æª”æ¡ˆå¿«å–æ©Ÿåˆ¶

**3. å®‰å…¨è€ƒé‡**
- âœ… é©—è­‰æª”æ¡ˆé¡å‹å’Œå¤§å°
- âœ… é˜²æ­¢è·¯å¾‘éæ­·æ”»æ“Š
- âœ… æ¸…ç†æš«å­˜æª”æ¡ˆ
- âœ… æ³¨æ„éš±ç§ä¿è­·

### å¯¦å‹™æŠ€å·§

```java
// âœ… å¥½çš„å¯¦è¸ï¼šå®Œæ•´çš„éŒ¯èª¤è™•ç†
try {
    Resource resource = file.getResource();
    MimeType mimeType = MimeTypeUtils.parseMimeType(file.getContentType());

    return chatClient.prompt()
        .user(u -> u.text(message).media(mimeType, resource))
        .call()
        .content();

} catch (IOException e) {
    log.error("æª”æ¡ˆè®€å–å¤±æ•—", e);
    return "æª”æ¡ˆè™•ç†å¤±æ•—";
} catch (Exception e) {
    log.error("AI åˆ†æå¤±æ•—", e);
    return "åˆ†æå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
}

// âŒ ä¸å¥½çš„å¯¦è¸ï¼šç¼ºå°‘éŒ¯èª¤è™•ç†
return chatClient.prompt()
    .user(u -> u.text(message).media(mimeType, file.getResource()))
    .call()
    .content();  // å¯èƒ½æ‹‹å‡ºç•°å¸¸å°è‡´ç³»çµ±å´©æ½°
```

### ä¸‹ä¸€æ­¥å­¸ç¿’æ–¹å‘

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘å€‘å°‡å­¸ç¿’å¦‚ä½•ä½¿ç”¨ Spring AI ç”Ÿæˆåœ–ç‰‡ï¼Œæ¢ç´¢ AI çš„å‰µä½œèƒ½åŠ›ï¼Œå»ºç«‹å®Œæ•´çš„åœ–ç‰‡ç”Ÿæˆå’Œç·¨è¼¯åŠŸèƒ½ã€‚

---

**åƒè€ƒè³‡æ–™ï¼š**
- [Spring AI Multimodality Documentation](https://docs.spring.io/spring-ai/reference/api/multimodality.html)
- [OpenAI Vision API](https://platform.openai.com/docs/guides/vision)
- [Anthropic Claude Vision](https://docs.anthropic.com/claude/docs/vision)
- [Google Gemini Multimodal](https://ai.google.dev/docs/multimodal_concepts)
- å®Œæ•´ç¯„ä¾‹ç¨‹å¼ç¢¼ï¼š`code-examples/chapter5-spring-ai-advanced`
