# 5.2 如何跟 ChatGPT 一樣處理多模態資料

> **本章重點**：學習使用 Spring AI 處理多模態資料，讓 AI 不僅能理解文字，還能分析圖片、音訊、影片等多種媒體格式，實現如同 ChatGPT 般的多模態互動體驗。

## 🎯 學習目標

完成本章學習後，您將能夠：

- 🎯 **理解多模態概念**：掌握多模態 AI 的核心原理和應用場景
- 🎯 **選擇合適的 AI 模型**：了解各種 AI 模型的多模態能力和限制
- 🎯 **實現圖片分析功能**：建立圖片上傳和分析的完整功能
- 🎯 **處理多種媒體格式**：支援圖片、音訊、影片等多種媒體類型
- 🎯 **優化多模態應用**：掌握效能優化和錯誤處理的最佳實踐

---

## 5.2.1 什麼是多模態 AI？

### 多模態就是同時提供兩種以上資料源

![多模態 AI](https://ithelp.ithome.com.tw/upload/images/20240810/201612905TZ6mYSAy1.jpg)

**多模態（Multimodality）** 是指 AI 系統能夠同時處理和理解多種不同類型的資料輸入，如文字、圖片、音訊、影片等。這種能力讓 AI 更接近人類的感知方式，能夠綜合多種感官資訊來理解和回應。

### Spring AI 中的多模態架構

還記得 Message 這張 UML 圖片嗎？在 UserMessage 中其實是可以包含多媒體檔案的：

![Spring AI Message 架構](https://ithelp.ithome.com.tw/upload/images/20240806/2016129049tSDbXBcM.jpg)

**重要說明**：雖然 UserMessage 類別支援直接傳入 Media 物件，但在實際開發中，**建議使用 ChatClient 的 fluent API**，因為它提供了更好的開發體驗和錯誤處理。

```java
// Spring AI 的多模態實現方式 - 使用 ChatClient fluent API
String response = chatClient.prompt()
    .user(u -> u.text("請分析這張圖片的內容")  // 文字部分
        .media(MimeTypeUtils.IMAGE_JPEG, imageResource))   // 圖片
    .call()
    .content();

// 也可以添加多個媒體檔案
String response = chatClient.prompt()
    .user(u -> u.text("請分析這些檔案")
        .media(MimeTypeUtils.IMAGE_JPEG, imageResource)
        .media(MimeTypeUtils.parseMediaType("audio/mp3"), audioResource))
    .call()
    .content();

// 💡 最佳實踐：建議將 Resource 和 MimeType 分開宣告，便於錯誤處理
Resource imageResource = new ClassPathResource("image.jpg");
MimeType mimeType = MimeTypeUtils.IMAGE_JPEG;

String response = chatClient.prompt()
    .user(u -> u.text("分析這張圖片")
        .media(mimeType, imageResource))
    .call()
    .content();
```

### 多模態的核心價值

**1. 更豐富的互動體驗**
- 📸 **視覺理解**：分析圖片內容、識別物體、理解場景
- 🎵 **聽覺處理**：語音轉文字、音樂分析、聲音識別
- 🎬 **影片分析**：動作識別、場景理解、內容摘要
- 📄 **文件處理**：OCR 文字識別、表格分析、版面理解

**2. 更準確的理解能力**
- 🔍 **上下文增強**：結合多種資訊源提供更準確的分析
- 🧠 **語義理解**：透過視覺和文字的結合提升理解深度
- 🎯 **精確回應**：基於多模態資訊提供更精確的答案

**3. 更廣泛的應用場景**
- 🏥 **醫療診斷**：結合影像和病歷資料進行輔助診斷
- 🛒 **電商應用**：商品圖片分析和推薦
- 📚 **教育培訓**：多媒體教材的智能分析和問答
- 🏭 **工業檢測**：設備圖片分析和故障診斷

---

## 5.2.2 支援多模態的 AI 模型

### 主流模型能力對比

目前有支援多模態的模型如下，其他模型送出多媒體檔案時可是會出現錯誤的：

| 模型提供商 | 模型名稱 | 圖像 | 音頻 | 視頻 | 文件 | 成本效益 | 推薦場景 |
|-----------|---------|------|------|------|------|----------|----------|
| **OpenAI** | GPT-4o | ✅ | ✅ | ✅ | ✅ | 高 | 全方位多模態應用 |
| **OpenAI** | GPT-4o mini | ✅ | ❌ | ❌ | ✅ | 極高 | 圖片分析、文件處理 |
| **OpenAI** | GPT-4 Vision | ✅ | ❌ | ❌ | ✅ | 中 | 圖片分析專用 |
| **Anthropic** | Claude 3.5 Sonnet | ✅ | ❌ | ❌ | ✅ | 高 | 圖片+文字分析 |
| **Anthropic** | Claude 3 Opus | ✅ | ❌ | ❌ | ✅ | 中 | 複雜圖片理解 |
| **Google** | Gemini 1.5 Pro | ✅ | ✅ | ✅ | ✅ | 中 | 多媒體內容分析 |
| **Google** | Gemini Pro Vision | ✅ | ❌ | ❌ | ✅ | 高 | 圖片識別 |
| **Ollama** | LlaVa | ✅ | ❌ | ❌ | ❌ | 極高(本地) | 本地圖片分析 |
| **Ollama** | Bakllava | ✅ | ❌ | ❌ | ❌ | 極高(本地) | 本地多模態 |

### 輸入輸出格式支援表

| Input | Output | Examples | 適用場景 |
|-------|--------|----------|----------|
| **Language/Code/Images** | Language/Code | GPT-4o, Gemini 1.5 Pro | 多模態問答、程式碼分析 |
| **Language/Code** | Language/Code | GPT-3.5, Claude 3 Haiku | 純文字對話 |
| **Language** | Image | DALL-E 3, Midjourney | 文字生成圖片 |
| **Language/Image** | Image | Stable Diffusion | 圖片編輯、風格轉換 |
| **Language** | Audio | OpenAI TTS, ElevenLabs | 文字轉語音 |
| **Audio** | Language | OpenAI Whisper | 語音轉文字 |
| **Text** | Numbers | Embedding Models | 向量化、相似度計算 |

### 模型選擇建議

```java
@Configuration
public class MultimodalModelConfig {
    
    @Value("${spring.ai.openai.api-key}")
    private String openaiApiKey;
    
    /**
     * 根據使用場景選擇合適的模型
     */
    @Bean
    @Primary
    public ChatModel primaryMultimodalModel() {
        // GPT-4o mini：性價比最高的圖片分析模型
        return OpenAiChatModel.builder()
            .apiKey(openaiApiKey)
            .modelName("gpt-4o-mini")
            .temperature(0.3)  // 較低溫度確保分析準確性
            .maxTokens(1500)
            .build();
    }
    
    /**
     * 高精度圖片分析模型
     */
    @Bean("highAccuracyModel")
    public ChatModel highAccuracyModel() {
        // GPT-4o：最強多模態能力
        return OpenAiChatModel.builder()
            .apiKey(openaiApiKey)
            .modelName("gpt-4o")
            .temperature(0.2)
            .maxTokens(2000)
            .build();
    }
    
    /**
     * 本地多模態模型（節省成本）
     */
    @Bean("localModel")
    @ConditionalOnProperty(name = "app.ai.local.enabled", havingValue = "true")
    public ChatModel localMultimodalModel() {
        // Ollama LlaVa：本地免費方案
        return OllamaChatModel.builder()
            .baseUrl("http://localhost:11434")
            .model("llava")
            .build();
    }
}
```

---

## 5.2.3 圖片分析功能實現

### 基礎圖片上傳和分析

```java
@RestController
@RequestMapping("/api/multimodal")
@RequiredArgsConstructor
@Slf4j
public class MultimodalController {

    private final ChatClient chatClient;

    /**
     * 基礎圖片分析
     */
    @PostMapping(value = "/image-analysis", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public String analyzeImage(
            @RequestParam("file") MultipartFile file,
            @RequestParam("message") String message) {

        try {
            // 驗證檔案類型
            if (!isValidImageFile(file)) {
                return "❌ 不支援的圖片格式";
            }

            // 建立 Resource 和 MimeType
            Resource imageResource = file.getResource();
            MimeType mimeType = MimeTypeUtils.parseMimeType(file.getContentType());

            // 使用 ChatClient 進行多模態分析
            String response = chatClient.prompt()
                    .user(u -> u.text(message)
                            .media(mimeType, imageResource))
                    .call()
                    .content();

            return response;

        } catch (Exception e) {
            log.error("圖片分析失敗", e);
            return "❌ AI 分析失敗：" + e.getMessage();
        }
    }

    /**
     * 驗證圖片檔案格式
     */
    private boolean isValidImageFile(MultipartFile file) {
        String contentType = file.getContentType();
        return contentType != null && (
            contentType.equals("image/jpeg") ||
            contentType.equals("image/png") ||
            contentType.equals("image/gif") ||
            contentType.equals("image/webp")
        );
    }
}
```

---

## 5.2.4 多媒體檔案處理

### 音訊檔案分析

```java
@RestController
@RequestMapping("/api/audio")
@RequiredArgsConstructor
public class AudioAnalysisController {

    private final ChatClient chatClient;

    /**
     * 音訊內容分析（需要支援音訊的模型如 GPT-4o）
     */
    @PostMapping("/analyze")
    public String analyzeAudio(
            @RequestParam("file") MultipartFile file,
            @RequestParam(value = "message", defaultValue = "請分析這個音訊") String message) {

        try {
            // 驗證音訊檔案格式
            if (!isValidAudioFile(file)) {
                return "❌ 不支援的音訊格式";
            }

            // 建立 Resource 和 MimeType
            Resource audioResource = file.getResource();
            MimeType mimeType = MimeTypeUtils.parseMimeType(file.getContentType());

            // 使用 ChatClient 進行音訊分析
            return chatClient.prompt()
                    .user(u -> u.text(message)
                            .media(mimeType, audioResource))
                    .call()
                    .content();

        } catch (Exception e) {
            log.error("音訊分析失敗", e);
            return "❌ 音訊分析失敗：" + e.getMessage();
        }
    }

    private boolean isValidAudioFile(MultipartFile file) {
        String contentType = file.getContentType();
        return contentType != null && (
            contentType.equals("audio/mpeg") ||
            contentType.equals("audio/wav") ||
            contentType.equals("audio/mp4") ||
            contentType.equals("audio/ogg")
        );
    }
}
```

---

## 📝 本章重點回顧

1. **多模態概念理解**：掌握了多模態 AI 的核心價值和應用場景
2. **模型選擇策略**：了解了各種 AI 模型的多模態能力和適用場景
3. **圖片分析實現**：建立了完整的圖片上傳、分析和批次處理功能
4. **多媒體處理**：實現了音訊、影片等多種媒體格式的分析功能
5. **企業級應用**：設計了文件智能分析等實際業務場景的解決方案

### 技術要點總結

| 技術點 | 重要性 | 實現難度 | 使用場景 |
|--------|--------|----------|----------|
| **圖片分析** | ⭐⭐⭐ | 中 | 所有視覺 AI 應用 |
| **文件 OCR** | ⭐⭐⭐ | 中 | 企業文件處理 |
| **音訊處理** | ⭐⭐ | 高 | 語音應用、內容分析 |
| **影片分析** | ⭐⭐ | 高 | 影片內容理解 |
| **批次處理** | ⭐⭐ | 中 | 大量檔案處理 |
| **效能優化** | ⭐⭐ | 高 | 生產環境部署 |

### 最佳實踐建議

1. **檔案驗證**：始終驗證檔案格式、大小和內容
2. **錯誤處理**：提供友善的錯誤訊息和降級方案
3. **效能優化**：使用快取、壓縮和非同步處理
4. **成本控制**：監控 API 使用量，特別是多模態請求成本較高
5. **安全考量**：注意檔案上傳的安全性和隱私保護

### 下一步學習方向

在下一章中，我們將學習如何使用 Spring AI 生成圖片，探索 AI 的創作能力，建立完整的圖片生成和編輯功能。

---

**參考資料：**
- [Spring AI Multimodality Documentation](https://docs.spring.io/spring-ai/reference/api/multimodality.html)
- [OpenAI Vision API](https://platform.openai.com/docs/guides/vision)
- [Anthropic Claude Vision](https://docs.anthropic.com/claude/docs/vision)
- [Google Gemini Multimodal](https://ai.google.dev/docs/multimodal_concepts)