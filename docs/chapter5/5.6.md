# 5.6 Function Calling (ä¸Š) - è«‹æ”¯æ´ AI

> **æœ¬ç« é‡é»**ï¼šå­¸ç¿’ Spring AI çš„ Tool Calling æŠ€è¡“ï¼Œè®“ AI èƒ½å¤ èª¿ç”¨å¤–éƒ¨å·¥å…·å’Œæœå‹™ï¼Œçªç ´ AI çš„å›ºæœ‰é™åˆ¶ï¼Œå¯¦ç¾æ›´å¼·å¤§çš„åŠŸèƒ½æ•´åˆå’Œå³æ™‚è³‡æ–™å­˜å–ã€‚

## ğŸ¯ å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬ç« å­¸ç¿’å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š

- ğŸ¯ **ç†è§£ Tool Calling åŸç†**ï¼šæŒæ¡ AI å·¥å…·èª¿ç”¨çš„æ ¸å¿ƒæ¦‚å¿µå’Œå·¥ä½œæµç¨‹
- ğŸ¯ **è­˜åˆ¥ AI çš„é™åˆ¶**ï¼šäº†è§£ LLM çš„å¼±é»å’Œ Tool Calling çš„è§£æ±ºæ–¹æ¡ˆ
- ğŸ¯ **å¯¦ç¾åŸºç¤å·¥å…·èª¿ç”¨**ï¼šå»ºç«‹ç¬¬ä¸€å€‹ Tool Calling åŠŸèƒ½
- ğŸ¯ **è¨­è¨ˆå·¥å…·ä»‹é¢**ï¼šæŒæ¡ @Tool è¨»è§£çš„ä½¿ç”¨å’Œæœ€ä½³å¯¦è¸
- ğŸ¯ **æ•´åˆ ChatClient API**ï¼šä½¿ç”¨æœ€æ–°çš„ Spring AI 1.1 API é€²è¡Œå·¥å…·æ•´åˆ

---

## 5.6.1 AI çš„å¼±é»èˆ‡æŒ‘æˆ°

### AI ä¸æ˜¯è¬èƒ½çš„

![AI çš„å¼±é»](https://ithelp.ithome.com.tw/upload/images/20240811/20161290wKqFOXe5Jy.jpg)

é›–ç„¶ AI å¾ˆç¥å¥‡ï¼Œä¸éå®ƒä¸æ˜¯è¬èƒ½çš„ï¼Œé‡åˆ°ä»¥ä¸‹å¹¾ç¨®å•é¡Œ AI å°±æ²’è½ï¼š

### LLM çš„å››å¤§é™åˆ¶

**1. è¨˜æ†¶é™åˆ¶**
- ğŸ§  **ç„¡ç‹€æ…‹æ¨è«–**ï¼šLLM æ˜¯ä¸€ç¨®ç„¡ç‹€æ…‹æ¨è«–æ¨¡å‹
- ğŸ’­ **å½è¨˜æ†¶ç¾è±¡**ï¼šé›–ç„¶è·Ÿ ChatGPT å°è©±ä¼¼ä¹èƒ½è¨˜ä½å°è©±å…§å®¹ï¼Œå¯¦éš›ä¸Šå®ƒæ˜¯æ ¹æ“šä½ é€å‡ºçš„è³‡æ–™ä¾†æ¨è«–çµæœ
- ğŸ”„ **ä¸Šä¸‹æ–‡ä¾è³´**ï¼šæ¯æ¬¡å°è©±éƒ½éœ€è¦é‡æ–°æä¾›å®Œæ•´çš„ä¸Šä¸‹æ–‡è³‡è¨Š
- ğŸ“ **æœƒè©±ç®¡ç†**ï¼šéœ€è¦å¤–éƒ¨ç³»çµ±ä¾†ç®¡ç†å°è©±æ­·å²å’Œç‹€æ…‹

**2. å³æ™‚è³‡æ–™é™åˆ¶**
- â° **è¨“ç·´è³‡æ–™æˆªæ­¢é»**ï¼šLLM é è¨“ç·´è³‡æ–™æœƒåœ¨ä¸€å€‹æ™‚é–“é»å¾Œé—œé–‰
- ğŸ“° **ç„¡æ³•ç²å–æœ€æ–°è³‡è¨Š**ï¼šä¹‹å¾Œæ‰€ç™¼ç”Ÿçš„äº‹æƒ… AI å°±ç„¡æ³•å›ç­”
- ğŸ… **å¯¦ä¾‹èªªæ˜**ï¼šå• AIã€Œ2024 å·´é»å¥§é‹ä¸­è¯éšŠå¾—äº†å¹¾é¢é‡‘ç‰Œã€ï¼ŒAI ä¸æ˜¯ä¸çŸ¥é“å°±æ˜¯éš¨ä¾¿ç·¨ä¸€å€‹ç­”æ¡ˆ
- ğŸ” **è§£æ±ºæ–¹æ¡ˆ**ï¼šéœ€è¦é€é API èª¿ç”¨ç²å–å³æ™‚è³‡æ–™

**3. æ•¸å­¸é‹ç®—é™åˆ¶**
- ğŸ”¢ **èªè¨€æ¨¡å‹æœ¬è³ª**ï¼šLLM é¡§åæ€ç¾©å°±æ˜¯ä¸€ç¨®èªè¨€æ¨¡å‹
- ğŸ“š **æ–‡ç§‘ç”Ÿç¾è±¡**ï¼šå°±è·Ÿæ–‡ç§‘ç”Ÿæ•¸ç†æ™®éä¸å¥½ä¸€æ¨£
- â• **åŸºç¤é‹ç®—éŒ¯èª¤**ï¼šæœ‰äº›ç°¡å–®çš„åŠ æ¸›æ³•ç”šè‡³æœƒç®—éŒ¯
- âš ï¸ **ä¸ä¿è­‰æº–ç¢ºæ€§**ï¼šå°±é€£ ChatGPT ä¹Ÿä¸æ•¢è·Ÿä½ ä¿è­‰ç®—å‡ºçš„ç­”æ¡ˆä¸€å®šæ˜¯å°çš„

**4. ä¼æ¥­å…§éƒ¨è³‡æ–™é™åˆ¶**
- ğŸ¢ **ç§æœ‰è³‡æ–™ç„¡æ³•è¨“ç·´**ï¼šé è¨“ç·´åªèƒ½å–å¾—å…¬é–‹è³‡æ–™
- ğŸ”’ **ä¼æ¥­è³‡è¨Šä¿å¯†**ï¼šä¼æ¥­ä¸å¯èƒ½å…¬é–‹è‡ªå·±çš„å…§éƒ¨è³‡è¨Š
- ğŸ› ï¸ **Fine-tuning æˆæœ¬é«˜**ï¼šå¸¸è¦‹ä½œæ³•æ˜¯é€é fine tuningï¼Œä½†è€—æ™‚è²»åŠ›
- ğŸ’¡ **RAG è§£æ±ºæ–¹æ¡ˆ**ï¼šé€éæª¢ç´¢å¢å¼·ç”ŸæˆæŠ€è¡“æ•´åˆä¼æ¥­è³‡æ–™

### Tool Calling çš„è§£æ±ºæ–¹æ¡ˆ

| AI é™åˆ¶ | Tool Calling è§£æ±ºæ–¹æ¡ˆ | å¯¦ç¾æ–¹å¼ |
|---------|----------------------|----------|
| **è¨˜æ†¶é™åˆ¶** | å¤–éƒ¨è¨˜æ†¶ç³»çµ± | è³‡æ–™åº«ã€å¿«å–ç³»çµ± |
| **å³æ™‚è³‡æ–™** | API èª¿ç”¨ | REST APIã€WebSocket |
| **æ•¸å­¸é‹ç®—** | è¨ˆç®—å·¥å…· | è¨ˆç®—å™¨ã€æ•¸å­¸åº« |
| **ä¼æ¥­è³‡æ–™** | è³‡æ–™åº«æŸ¥è©¢ | SQLã€NoSQLã€æœå°‹å¼•æ“ |

---

## 5.6.2 Tool Calling æ ¸å¿ƒæ¦‚å¿µ

### ä»€éº¼æ˜¯ Tool Callingï¼Ÿ

**Tool Calling**ï¼ˆä¹Ÿç¨±ç‚º Function Callingï¼‰å°±åƒæ˜¯ AI çš„å¤–æ›ç³»çµ±ï¼Œé™¤äº†èƒ½é€é Tool å–å¾—å³æ™‚è³‡æ–™å¤–ï¼Œä¸€äº›è¤‡é›œçš„é‹ç®—æˆ–æ˜¯éœ€è¦åˆ†æçš„éƒ¨åˆ†ï¼Œä¹Ÿå¯ä»¥é€é Tool ä¾†å‘¼å«å¤–éƒ¨å‡½å¼å–å¾—çµæœã€‚

### Tool Calling èª¿ç”¨æµç¨‹

![Tool Calling æµç¨‹](https://ithelp.ithome.com.tw/upload/images/20240811/20161290o7GvM9RvQN.jpg)

**å®Œæ•´èª¿ç”¨æµç¨‹**ï¼š

```mermaid
sequenceDiagram
    participant User as ä½¿ç”¨è€…
    participant Client as ChatClient
    participant AI as AI æ¨¡å‹
    participant Tool as å¤–éƒ¨å·¥å…·
    
    User->>Client: 1. ç™¼é€æç¤ºè© + è¨»å†Šå·¥å…·
    Client->>AI: 2. å‚³é€æç¤ºè©å’Œå·¥å…·æè¿°
    AI->>AI: 3. åˆ†ææ˜¯å¦éœ€è¦èª¿ç”¨å·¥å…·
    AI->>Client: 4. è¿”å›å·¥å…·èª¿ç”¨è«‹æ±‚
    Client->>Tool: 5. åŸ·è¡Œå·¥å…·å‡½å¼
    Tool->>Client: 6. è¿”å›å·¥å…·åŸ·è¡Œçµæœ
    Client->>AI: 7. å°‡çµæœå‚³å› AI
    AI->>Client: 8. ç”Ÿæˆæœ€çµ‚å›æ‡‰
    Client->>User: 9. è¿”å›å®Œæ•´ç­”æ¡ˆ
```

**å„æ­¥é©Ÿè©³ç´°èªªæ˜**ï¼š

1. **è¨»å†Šå·¥å…·**ï¼šç™¼é€æç¤ºè©æ™‚å‘Šè¨´ AI æœ‰å“ªäº› Tool å¯ä»¥èª¿ç”¨
```java
return ChatClient.create(chatModel)
    .prompt(prompt)
    .tools(new DateTimeTools())  // è¨»å†Šå¯ç”¨å·¥å…·
    .call()
    .content();
```

2. **å·¥å…·åŒ¹é…**ï¼šAI æŸ¥çœ‹æ˜¯å¦æœ‰èˆ‡æç¤ºè©ç›¸é—œçš„ Tool æè¿°
```java
@Tool(description = "Get the current date and time")
String getCurrentDateTime() {
    return LocalDateTime.now().toString();
}
```

3. **åŸ·è¡Œå·¥å…·**ï¼šæ‰¾åˆ°åŒ¹é…çš„ Tool å¾ŒåŸ·è¡Œä¸¦èª¿ç”¨å…¶è³‡è¨Š
4. **çµæœæ•´åˆ**ï¼šå°‡ Tool å›å‚³çš„è³‡æ–™ä»¥å…§éƒ¨è¨Šæ¯æ ¼å¼å‚³é€çµ¦ AI
5. **ç”Ÿæˆå›æ‡‰**ï¼šAI æ ¹æ“šæç¤ºè©ä»¥åŠ Tool å›å‚³çµæœç”Ÿæˆæœ€çµ‚ç­”æ¡ˆ

### Spring AI 1.1 çš„é‡å¤§æ›´æ–°

**æ–°èˆŠ API å°æ¯”**ï¼š

| æ¯”è¼ƒé …ç›® | èˆŠç‰ˆ Function Calling | æ–°ç‰ˆ Tool Calling |
|----------|----------------------|-------------------|
| **API åç¨±** | Function Calling | Tool Calling |
| **è¨»è§£** | `@Function` | `@Tool` |
| **è¨»å†Šæ–¹å¼** | è¤‡é›œçš„é…ç½® | ç›´æ¥å‚³å…¥å¯¦ä¾‹ |
| **é¡å‹å®‰å…¨** | è¼ƒå¼± | æ›´å¼· |
| **æ˜“ç”¨æ€§** | è¤‡é›œ | ç°¡åŒ– |
| **æ•ˆèƒ½** | ä¸€èˆ¬ | å„ªåŒ– |

**é·ç§»å»ºè­°**ï¼š
- âœ… **æ–°å°ˆæ¡ˆ**ï¼šç›´æ¥ä½¿ç”¨ Tool Calling API
- ğŸ”„ **èˆŠå°ˆæ¡ˆ**ï¼šé€æ­¥é·ç§»åˆ°æ–° API
- ğŸ“š **å­¸ç¿’é‡é»**ï¼šæŒæ¡ @Tool è¨»è§£å’Œ ChatClient æ•´åˆ

---

## 5.6.3 ç¬¬ä¸€å€‹ Tool Calling å¯¦ç¾

### å°ˆæ¡ˆå»ºç«‹èˆ‡é…ç½®

**Maven ä¾è³´**ï¼š

```xml
<!-- ä½¿ç”¨ Spring AI BOM ç®¡ç†ç‰ˆæœ¬ -->
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-bom</artifactId>
            <version>1.0.0</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>

<dependencies>
    <!-- Spring AI OpenAI Starter -->
    <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-openai-spring-boot-starter</artifactId>
        </dependency>
    
    <!-- Spring Boot Web -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    
    <!-- Lombok -->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>
</dependencies>
```

**æ‡‰ç”¨ç¨‹å¼é…ç½®**ï¼š

```yaml
# application.yml
spring:
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      chat:
        options:
          model: gpt-4o-mini  # æ”¯æ´ Tool Calling çš„æ¨¡å‹
          temperature: 0.1

# æ—¥èªŒé…ç½®
logging:
  level:
    org.springframework.ai: DEBUG
```

### åŸºç¤å·¥å…·é¡åˆ¥å¯¦ç¾

**ç¨‹å¼ç›®æ¨™**ï¼šè©¢å•ç›®å‰æ™‚é–“ï¼Œè¿”å›çœŸå¯¦çš„æ—¥æœŸåŠæ™‚é–“

**æ­¥é©Ÿ 1ï¼šæ’°å¯« Tool é¡åˆ¥**

```java
/**
 * æ—¥æœŸæ™‚é–“å·¥å…·é¡åˆ¥
 * æä¾›ç•¶å‰æ™‚é–“æŸ¥è©¢åŠŸèƒ½
 */
@Component
public class DateTimeTools {
    
    /**
     * ç²å–ç•¶å‰æ—¥æœŸå’Œæ™‚é–“
     * @return æ ¼å¼åŒ–çš„ç•¶å‰æ—¥æœŸæ™‚é–“å­—ä¸²
     */
    @Tool(description = "Get the current date and time in Taiwan (Asia/Taipei timezone)")
    public String getCurrentDateTime() {
        LocalDateTime now = LocalDateTime.now();
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyyå¹´MMæœˆddæ—¥ HH:mm:ss");
        
        return String.format("ç•¶å‰æ™‚é–“ï¼š%sï¼ˆå°ç£æ™‚é–“ï¼‰", now.format(formatter));
    }
    
    /**
     * ç²å–æŒ‡å®šæ ¼å¼çš„ç•¶å‰æ™‚é–“
     * @param format æ™‚é–“æ ¼å¼ï¼ˆå¦‚ï¼šyyyy-MM-dd HH:mm:ssï¼‰
     * @return æ ¼å¼åŒ–çš„æ™‚é–“å­—ä¸²
     */
    @Tool(description = "Get current time in specified format")
    public String getCurrentTimeWithFormat(String format) {
        try {
            LocalDateTime now = LocalDateTime.now();
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern(format);
            return now.format(formatter);
        } catch (Exception e) {
            return "æ™‚é–“æ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨æ­£ç¢ºçš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼šyyyy-MM-dd HH:mm:ss";
        }
    }
    
    /**
     * ç²å–ç•¶å‰æ™‚é–“æˆ³
     * @return Unix æ™‚é–“æˆ³
     */
    @Tool(description = "Get current Unix timestamp")
    public String getCurrentTimestamp() {
        long timestamp = System.currentTimeMillis() / 1000;
        return String.format("ç•¶å‰æ™‚é–“æˆ³ï¼š%d", timestamp);
    }
    
    /**
     * ç²å–ç•¶å‰æ˜¯æ˜ŸæœŸå¹¾
     * @return æ˜ŸæœŸè³‡è¨Š
     */
    @Tool(description = "Get current day of week")
    public String getCurrentDayOfWeek() {
        LocalDateTime now = LocalDateTime.now();
        String[] weekDays = {"æ˜ŸæœŸä¸€", "æ˜ŸæœŸäºŒ", "æ˜ŸæœŸä¸‰", "æ˜ŸæœŸå››", "æ˜ŸæœŸäº”", "æ˜ŸæœŸå…­", "æ˜ŸæœŸæ—¥"};
        int dayOfWeek = now.getDayOfWeek().getValue() - 1;
        
        return String.format("ä»Šå¤©æ˜¯%s", weekDays[dayOfWeek]);
    }
}
```

**æ­¥é©Ÿ 2ï¼šå»ºç«‹ ChatClient æ§åˆ¶å™¨**

```java
package com.example.controller;

import com.example.tools.DateTimeTools;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.model.ChatModel;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.List;

@RestController
@RequestMapping("/api/tool-calling")
@RequiredArgsConstructor
@Slf4j
public class ToolCallingController {
    
    private final ChatModel chatModel;
    private final DateTimeTools dateTimeTools;
    
    /**
     * åŸºç¤ Tool Calling ç¤ºä¾‹
     * @param prompt ä½¿ç”¨è€…æç¤ºè©
     * @return AI å›æ‡‰ï¼ˆå¯èƒ½åŒ…å«å·¥å…·èª¿ç”¨çµæœï¼‰
     */
    @GetMapping("/basic")
    public String basicToolCalling(@RequestParam String prompt) {
        try {
            log.info("æ”¶åˆ° Tool Calling è«‹æ±‚ï¼š{}", prompt);
            
            // ä½¿ç”¨æ–°çš„ ChatClient API æ•´åˆå·¥å…·
            String response = ChatClient.create(chatModel)
                    .prompt(prompt)
                    .tools(dateTimeTools)  // ç›´æ¥å‚³å…¥ Tool å¯¦ä¾‹
                    .call()
                    .content();
            
            log.info("Tool Calling å›æ‡‰ï¼š{}", response);
            return response;
            
        } catch (Exception e) {
            log.error("Tool Calling åŸ·è¡Œå¤±æ•—", e);
            return "Tool Calling åŸ·è¡Œå¤±æ•—ï¼š" + e.getMessage();
        }
    }
    
    /**
     * å¤šå·¥å…·æ•´åˆç¤ºä¾‹
     * @param prompt ä½¿ç”¨è€…æç¤ºè©
     * @return AI å›æ‡‰
     */
    @GetMapping("/multi-tools")
    public String multiToolCalling(@RequestParam String prompt) {
        try {
            // å¯ä»¥åŒæ™‚è¨»å†Šå¤šå€‹å·¥å…·
            String response = ChatClient.create(chatModel)
                    .prompt(prompt)
                    .tools(dateTimeTools)  // å¯ä»¥æ·»åŠ æ›´å¤šå·¥å…·
                    .call()
                    .content();
            
            return response;
            
        } catch (Exception e) {
            log.error("å¤šå·¥å…·èª¿ç”¨å¤±æ•—", e);
            return "å¤šå·¥å…·èª¿ç”¨å¤±æ•—ï¼š" + e.getMessage();
        }
    }
    
    /**
     * å·¥å…·èª¿ç”¨è©³ç´°è³‡è¨Š
     * @param prompt ä½¿ç”¨è€…æç¤ºè©
     * @return åŒ…å«èª¿ç”¨è©³æƒ…çš„å›æ‡‰
     */
    @PostMapping("/detailed")
    public ToolCallingResponse detailedToolCalling(@RequestBody ToolCallingRequest request) {
        try {
            long startTime = System.currentTimeMillis();
            
            String response = ChatClient.create(chatModel)
                    .prompt(request.getPrompt())
                    .tools(dateTimeTools)
                    .call()
                    .content();
            
            long endTime = System.currentTimeMillis();
            
            return ToolCallingResponse.builder()
                    .success(true)
                    .prompt(request.getPrompt())
                    .response(response)
                    .executionTime(endTime - startTime)
                    .toolsUsed(List.of("DateTimeTools"))
                    .timestamp(LocalDateTime.now())
                    .build();
            
        } catch (Exception e) {
            log.error("è©³ç´°å·¥å…·èª¿ç”¨å¤±æ•—", e);
            
            return ToolCallingResponse.builder()
                    .success(false)
                    .prompt(request.getPrompt())
                    .error(e.getMessage())
                    .timestamp(LocalDateTime.now())
                    .build();
        }
    }
}
```

### è«‹æ±‚å’Œå›æ‡‰ DTO

```java
package com.example.dto;

import lombok.Data;
import lombok.Builder;
import java.time.LocalDateTime;
import java.util.List;

@Data
public class ToolCallingRequest {
    private String prompt;
    private List<String> enabledTools;
    private boolean includeDetails;
}

@Data
@Builder
public class ToolCallingResponse {
    private boolean success;
    private String prompt;
    private String response;
    private Long executionTime;
    private List<String> toolsUsed;
    private String error;
    private LocalDateTime timestamp;
}
```

---
## 5.6.4 Tool è¨­è¨ˆæœ€ä½³å¯¦è¸

### @Tool è¨»è§£è©³è§£

**åŸºæœ¬èªæ³•**ï¼š

```java
@Tool(description = "å·¥å…·åŠŸèƒ½æè¿°")
public String toolMethod(åƒæ•¸åˆ—è¡¨) {
    // å·¥å…·å¯¦ç¾é‚è¼¯
    return "çµæœ";
}
```

**é‡è¦åŸå‰‡**ï¼š

1. **æè¿°è¦æ¸…æ™°**ï¼šAI æ ¹æ“šæè¿°æ±ºå®šæ˜¯å¦èª¿ç”¨å·¥å…·
2. **åƒæ•¸è¦æ˜ç¢º**ï¼šæ”¯æ´åŸºæœ¬é¡å‹å’Œç°¡å–®ç‰©ä»¶
3. **è¿”å›å€¼è¦æœ‰æ„ç¾©**ï¼šAI æœƒå°‡è¿”å›å€¼æ•´åˆåˆ°å›æ‡‰ä¸­
4. **ç•°å¸¸è¦è™•ç†**ï¼šé¿å…å·¥å…·èª¿ç”¨å¤±æ•—å½±éŸ¿æ•´é«”æµç¨‹

### é€²éšå·¥å…·è¨­è¨ˆ

**å¸¶åƒæ•¸çš„å·¥å…·**ï¼š

```java
@Component
public class CalculatorTools {
    
    /**
     * åŸºæœ¬æ•¸å­¸é‹ç®—
     * @param operation é‹ç®—é¡å‹ï¼ˆadd, subtract, multiply, divideï¼‰
     * @param a ç¬¬ä¸€å€‹æ•¸å­—
     * @param b ç¬¬äºŒå€‹æ•¸å­—
     * @return é‹ç®—çµæœ
     */
    @Tool(description = "Perform basic mathematical operations: add, subtract, multiply, divide")
    public String calculate(String operation, double a, double b) {
        try {
            double result = switch (operation.toLowerCase()) {
                case "add" -> a + b;
                case "subtract" -> a - b;
                case "multiply" -> a * b;
                case "divide" -> {
                    if (b == 0) {
                        yield Double.NaN;
                    }
                    yield a / b;
                }
                default -> throw new IllegalArgumentException("ä¸æ”¯æ´çš„é‹ç®—ï¼š" + operation);
            };
            
            if (Double.isNaN(result)) {
                return "éŒ¯èª¤ï¼šé™¤æ•¸ä¸èƒ½ç‚ºé›¶";
            }
            
            return String.format("%.2f %s %.2f = %.2f", a, getOperationSymbol(operation), b, result);
            
        } catch (Exception e) {
            return "è¨ˆç®—éŒ¯èª¤ï¼š" + e.getMessage();
        }
    }
    
    /**
     * è¤‡é›œæ•¸å­¸é‹ç®—
     * @param expression æ•¸å­¸è¡¨é”å¼ï¼ˆå¦‚ï¼š"2 + 3 * 4"ï¼‰
     * @return è¨ˆç®—çµæœ
     */
    @Tool(description = "Evaluate complex mathematical expressions")
    public String evaluateExpression(String expression) {
        try {
            // é€™è£¡å¯ä»¥æ•´åˆæ•¸å­¸è¡¨é”å¼è§£æå™¨
            // ç‚ºäº†ç°¡åŒ–ï¼Œé€™è£¡åªåšåŸºæœ¬ç¤ºä¾‹
            return "è¡¨é”å¼ '" + expression + "' çš„è¨ˆç®—åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­";
        } catch (Exception e) {
            return "è¡¨é”å¼è¨ˆç®—éŒ¯èª¤ï¼š" + e.getMessage();
        }
    }
    
    private String getOperationSymbol(String operation) {
        return switch (operation.toLowerCase()) {
            case "add" -> "+";
            case "subtract" -> "-";
            case "multiply" -> "Ã—";
            case "divide" -> "Ã·";
            default -> "?";
        };
    }
}
```

**ç‰©ä»¶åƒæ•¸å·¥å…·**ï¼š

```java
@Component
public class WeatherTools {
    
    /**
     * æŸ¥è©¢å¤©æ°£è³‡è¨Š
     * @param location åœ°é»è³‡è¨Š
     * @return å¤©æ°£è³‡è¨Š
     */
    @Tool(description = "Get weather information for a specific location")
    public String getWeather(WeatherRequest location) {
        try {
            // æ¨¡æ“¬å¤©æ°£ API èª¿ç”¨
            return String.format("åœ°é»ï¼š%s\nå¤©æ°£ï¼š%s\næº«åº¦ï¼š%dÂ°C\næ¿•åº¦ï¼š%d%%",
                    location.getCity(),
                    "æ™´å¤©",
                    25,
                    60);
        } catch (Exception e) {
            return "å¤©æ°£æŸ¥è©¢å¤±æ•—ï¼š" + e.getMessage();
        }
    }
    
    @Data
    public static class WeatherRequest {
        private String city;
        private String country;
        private String unit = "celsius";  // celsius, fahrenheit
    }
}
```

### å·¥å…·çµ„åˆå’Œç®¡ç†

**å·¥å…·ç®¡ç†æœå‹™**ï¼š

```java

@Service
@RequiredArgsConstructor
public class ToolManagementService {
    
    private final DateTimeTools dateTimeTools;
    private final CalculatorTools calculatorTools;
    private final WeatherTools weatherTools;
    
    /**
     * æ ¹æ“šå ´æ™¯ç²å–å·¥å…·çµ„åˆ
     * @param scenario æ‡‰ç”¨å ´æ™¯
     * @return å·¥å…·åˆ—è¡¨
     */
    public List<Object> getToolsForScenario(String scenario) {
        return switch (scenario.toLowerCase()) {
            case "basic" -> List.of(dateTimeTools);
            case "math" -> List.of(dateTimeTools, calculatorTools);
            case "weather" -> List.of(dateTimeTools, weatherTools);
            case "all" -> List.of(dateTimeTools, calculatorTools, weatherTools);
            default -> List.of(dateTimeTools);
        };
    }
    
    /**
     * æ™ºèƒ½å·¥å…·é¸æ“‡
     * @param prompt ä½¿ç”¨è€…æç¤ºè©
     * @return æ¨è–¦çš„å·¥å…·åˆ—è¡¨
     */
    public List<Object> selectToolsForPrompt(String prompt) {
        List<Object> selectedTools = new ArrayList<>();
        
        // åŸºæ–¼é—œéµå­—é¸æ“‡å·¥å…·
        if (containsTimeKeywords(prompt)) {
            selectedTools.add(dateTimeTools);
        }
        
        if (containsMathKeywords(prompt)) {
            selectedTools.add(calculatorTools);
        }
        
        if (containsWeatherKeywords(prompt)) {
            selectedTools.add(weatherTools);
        }
        
        // å¦‚æœæ²’æœ‰åŒ¹é…çš„å·¥å…·ï¼Œè¿”å›åŸºç¤å·¥å…·
        if (selectedTools.isEmpty()) {
            selectedTools.add(dateTimeTools);
        }
        
        return selectedTools;
    }
    
    private boolean containsTimeKeywords(String prompt) {
        String[] timeKeywords = {"æ™‚é–“", "æ—¥æœŸ", "ç¾åœ¨", "ç•¶å‰", "ä»Šå¤©", "time", "date", "now"};
        return Arrays.stream(timeKeywords)
                .anyMatch(keyword -> prompt.toLowerCase().contains(keyword.toLowerCase()));
    }
    
    private boolean containsMathKeywords(String prompt) {
        String[] mathKeywords = {"è¨ˆç®—", "åŠ ", "æ¸›", "ä¹˜", "é™¤", "æ•¸å­¸", "é‹ç®—", "calculate", "math"};
        return Arrays.stream(mathKeywords)
                .anyMatch(keyword -> prompt.toLowerCase().contains(keyword.toLowerCase()));
    }
    
    private boolean containsWeatherKeywords(String prompt) {
        String[] weatherKeywords = {"å¤©æ°£", "æ°£æº«", "ä¸‹é›¨", "æ™´å¤©", "weather", "temperature"};
        return Arrays.stream(weatherKeywords)
                .anyMatch(keyword -> prompt.toLowerCase().contains(keyword.toLowerCase()));
    }
}
```
---

## ğŸ“ æœ¬ç« é‡é»å›é¡§

1. **AI é™åˆ¶ç†è§£**ï¼šæŒæ¡äº† LLM åœ¨è¨˜æ†¶ã€å³æ™‚è³‡æ–™ã€æ•¸å­¸é‹ç®—å’Œä¼æ¥­è³‡æ–™æ–¹é¢çš„é™åˆ¶
2. **Tool Calling åŸç†**ï¼šç†è§£äº†å·¥å…·èª¿ç”¨çš„å®Œæ•´æµç¨‹å’Œæ ¸å¿ƒæ¦‚å¿µ
3. **Spring AI 1.1 æ–°ç‰¹æ€§**ï¼šå­¸æœƒäº†ä½¿ç”¨æœ€æ–°çš„ @Tool è¨»è§£å’Œ ChatClient API
4. **åŸºç¤å·¥å…·å¯¦ç¾**ï¼šå»ºç«‹äº†ç¬¬ä¸€å€‹å¯ç”¨çš„ Tool Calling åŠŸèƒ½
5. **æœ€ä½³å¯¦è¸æŒæ¡**ï¼šäº†è§£äº†å·¥å…·è¨­è¨ˆã€ç®¡ç†å’Œæ¸¬è©¦çš„æœ€ä½³å¯¦è¸

### æŠ€è¡“è¦é»ç¸½çµ

| æŠ€è¡“é» | é‡è¦æ€§ | å¯¦ç¾é›£åº¦ | ä½¿ç”¨å ´æ™¯ |
|--------|--------|----------|----------|
| **@Tool è¨»è§£** | â­â­â­ | ä½ | æ‰€æœ‰å·¥å…·èª¿ç”¨ |
| **ChatClient æ•´åˆ** | â­â­â­ | ä½ | AI å°è©±ç³»çµ± |
| **åƒæ•¸è™•ç†** | â­â­ | ä¸­ | è¤‡é›œå·¥å…·åŠŸèƒ½ |
| **å·¥å…·çµ„åˆ** | â­â­ | ä¸­ | å¤šåŠŸèƒ½æ‡‰ç”¨ |
| **éŒ¯èª¤è™•ç†** | â­â­ | ä¸­ | ç”Ÿç”¢ç’°å¢ƒ |
| **æ•ˆèƒ½å„ªåŒ–** | â­ | é«˜ | é«˜ä½µç™¼å ´æ™¯ |

### å¸¸è¦‹å•é¡Œå’Œè§£æ±ºæ–¹æ¡ˆ

**Q1ï¼šå·¥å…·æ²’æœ‰è¢«èª¿ç”¨ï¼Ÿ**
- æª¢æŸ¥ @Tool æè¿°æ˜¯å¦æ¸…æ™°
- ç¢ºèªæ¨¡å‹æ”¯æ´ Tool Callingï¼ˆå¦‚ GPT-4o-miniï¼‰
- é©—è­‰å·¥å…·è¨»å†Šæ˜¯å¦æ­£ç¢º

**Q2ï¼šå·¥å…·èª¿ç”¨å¤±æ•—ï¼Ÿ**
- æª¢æŸ¥åƒæ•¸é¡å‹æ˜¯å¦æ”¯æ´
- ç¢ºèªç•°å¸¸è™•ç†æ˜¯å¦å®Œå–„
- æŸ¥çœ‹æ—¥èªŒè¼¸å‡ºçš„éŒ¯èª¤è³‡è¨Š

**Q3ï¼šå›æ‡‰ä¸åŒ…å«å·¥å…·çµæœï¼Ÿ**
- ç¢ºèªå·¥å…·è¿”å›å€¼æœ‰æ„ç¾©
- æª¢æŸ¥ AI æ˜¯å¦æ­£ç¢ºæ•´åˆäº†å·¥å…·çµæœ
- èª¿æ•´æç¤ºè©ä½¿å…¶æ›´æ˜ç¢º

### ä¸‹ä¸€æ­¥å­¸ç¿’æ–¹å‘

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘å€‘å°‡å­¸ç¿’æ›´é€²éšçš„ Function Calling æŠ€è¡“ï¼ŒåŒ…æ‹¬ä¼æ¥­è³‡æ–™æ•´åˆã€è¤‡é›œå·¥å…·éˆå’Œå¯¦éš›æ¥­å‹™å ´æ™¯æ‡‰ç”¨ã€‚

---

**åƒè€ƒè³‡æ–™ï¼š**
- [Spring AI Tool Calling Documentation](https://docs.spring.io/spring-ai/reference/api/tools.html)
- [OpenAI Function Calling Guide](https://platform.openai.com/docs/guides/function-calling)
- [Spring AI 1.1 Migration Guide](https://docs.spring.io/spring-ai/reference/upgrade-notes.html)
- [Tool Calling Best Practices](https://docs.spring.io/spring-ai/reference/concepts.html#_function_calling)