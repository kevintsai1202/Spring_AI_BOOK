# 9.2 MCP Client ä½¿ç”¨

> **å°æ‡‰ç« ç¯€**: Client æ‡‰ç”¨
> **å°æ‡‰ç¯„ä¾‹**: `chapter9-mcp-client-basic`
> **é›£åº¦**: â­â­â­â˜†â˜†
> **å­¸ç¿’æ™‚é–“**: 60 åˆ†é˜

---

## ğŸ“š æœ¬ç« æ¦‚è¦

å­¸ç¿’å¦‚ä½•åœ¨ Spring AI æ‡‰ç”¨ä¸­ä½¿ç”¨ MCP Client é€£æ¥å’Œèª¿ç”¨ MCP Serverï¼ŒæŒæ¡å·¥å…·ç™¼ç¾ã€èª¿ç”¨å’Œèˆ‡ ChatClient çš„æ•´åˆã€‚

**å­¸ç¿’ç›®æ¨™**:
- é…ç½® MCP Client é€£æ¥ï¼ˆSTDIO/SSEï¼‰
- ç™¼ç¾å’Œèª¿ç”¨ MCP å·¥å…·
- æ•´åˆåˆ° Spring AI ChatClient
- ç®¡ç†å¤šå€‹ MCP Server é€£æ¥

---

## ğŸ¯ å°ˆæ¡ˆæ¶æ§‹

### å®Œæ•´çš„ MCP Client æ‡‰ç”¨æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ¶è¼¸å…¥] --> B[ChatClient]
    B --> C[MCP Client Manager]
    C --> D{ç™¼ç¾å¯ç”¨å·¥å…·}
    D --> E[Context7 Server æ–‡æª”æª¢ç´¢]
    D --> F[Brave Search Server ç¶²é æœç´¢]
    E --> G[å·¥å…·å›èª¿é›†åˆ]
    F --> G
    G --> H[AI æ¨¡å‹]
    H --> I[ç”Ÿæˆå›ç­”]

    style A fill:#e1f5ff
    style B fill:#e8f5e9
    style E fill:#fff4e6
    style F fill:#fff4e6
    style I fill:#f3e5f5
```

**å°æ‡‰å°ˆæ¡ˆ**: `code-examples/chapter9-mcp-integration/chapter9-mcp-client-basic/`

---

## ğŸ”§ Maven ä¾è³´é…ç½®

### æ ¸å¿ƒä¾è³´

**ä½ç½®**: `pom.xml`

```xml
<dependencies>
    <!-- Spring AI MCP Client -->
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-starter-mcp-client</artifactId>
    </dependency>

    <!-- Spring AI OpenAI -->
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-openai-spring-boot-starter</artifactId>
    </dependency>

    <!-- Spring Boot Web -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
</dependencies>

<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.ai</groupId>
            <artifactId>spring-ai-bom</artifactId>
            <version>1.0.3</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

**ç‰ˆæœ¬èªªæ˜**:
- Spring AI: 1.0.3
- Spring Boot: 3.5.7
- Java: 21

---

## âš™ï¸ MCP Client é…ç½®

### SSE å‚³è¼¸é…ç½®

**ä½ç½®**: `src/main/resources/application.yml`

```yaml
spring:
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}

    mcp:
      client:
        # Client åŸºæœ¬é…ç½®
        enabled: true
        type: SYNC

        # SSE é€£æ¥ - Context7 æ–‡æª”æª¢ç´¢æœå‹™
        sse:
          connections:
            context7:
              url: https://mcp.context7.com
              sse-endpoint: /mcp
```

**é—œéµé…ç½®èªªæ˜**:
- `type: SYNC`: ä½¿ç”¨åŒæ­¥ Clientï¼ˆä¹Ÿå¯é¸æ“‡ ASYNCï¼‰
- `url`: MCP Server çš„ HTTP ç«¯é»
- `sse-endpoint`: Server-Sent Events ç«¯é»è·¯å¾‘

---

### STDIO å‚³è¼¸é…ç½®

é©ç”¨æ–¼æœ¬åœ° Node.js MCP Server

```yaml
spring:
  ai:
    mcp:
      client:
        stdio:
          connections:
            brave-search:
              command: npx
              args:
                - "-y"
                - "@modelcontextprotocol/server-brave-search"
              env:
                BRAVE_API_KEY: ${BRAVE_API_KEY}
```

**STDIO vs SSE**:

| ç‰¹æ€§ | STDIO | SSE |
|------|-------|-----|
| **é©ç”¨å ´æ™¯** | æœ¬åœ°é–‹ç™¼ã€CLI æ•´åˆ | é ç«¯æœå‹™ã€ç”Ÿç”¢ç’°å¢ƒ |
| **ç¶²çµ¡éœ€æ±‚** | âŒ ç„¡éœ€ç¶²çµ¡ | âœ… éœ€è¦ HTTP |
| **æ€§èƒ½** | âš¡ ä½å»¶é² | ğŸŒ ä¾è³´ç¶²çµ¡ |
| **éƒ¨ç½²** | æœ¬åœ°é€²ç¨‹ | é ç«¯ Server |

---

## ğŸ’» MCP Client æ ¸å¿ƒæœå‹™

### Client ç®¡ç†å™¨

**ä½ç½®**: `src/main/java/com/example/mcpclient/config/McpClientManager.java`

```java
@Configuration
@Slf4j
public class McpClientManager {

    private final List<McpSyncClient> syncClients;
    private final SyncMcpToolCallbackProvider toolCallbackProvider;

    public McpClientManager(List<McpSyncClient> syncClients,
                           SyncMcpToolCallbackProvider toolCallbackProvider) {
        this.syncClients = syncClients;
        this.toolCallbackProvider = toolCallbackProvider;

        logServerConnections();
    }

    /**
     * è¨˜éŒ„å·²é€£æ¥çš„ Server
     */
    private void logServerConnections() {
        log.info("=== MCP Client é€£æ¥ç‹€æ…‹ ===");
        log.info("å·²é€£æ¥ {} å€‹ MCP Server", syncClients.size());

        for (McpSyncClient client : syncClients) {
            log.info("  - Server: {}", client.getServerName());
        }
    }
}
```

**é—œéµçµ„ä»¶**:
- `List<McpSyncClient>`: Spring è‡ªå‹•æ³¨å…¥æ‰€æœ‰é…ç½®çš„ MCP Client
- `SyncMcpToolCallbackProvider`: è‡ªå‹•èšåˆæ‰€æœ‰ Server çš„å·¥å…·

---

## ğŸ”— èˆ‡ ChatClient æ•´åˆ

### é…ç½® ChatClient

**ä½ç½®**: `src/main/java/com/example/mcpclient/config/ChatClientConfig.java`

```java
@Configuration
@Slf4j
public class ChatClientConfig {

    /**
     * é…ç½®å¸¶æœ‰ MCP å·¥å…·çš„ ChatClient
     */
    @Bean
    public ChatClient chatClient(ChatClient.Builder builder,
                                SyncMcpToolCallbackProvider toolProvider) {

        ToolCallback[] mcpTools = toolProvider.getToolCallbacks();
        log.info("ChatClient è¨»å†Šäº† {} å€‹ MCP å·¥å…·", mcpTools.length);

        return builder
            .defaultSystem("""
                ä½ æ˜¯ä¸€å€‹æ™ºèƒ½åŠ©æ‰‹ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·å”åŠ©ç”¨æˆ¶ï¼š
                - æ–‡æª”æª¢ç´¢å·¥å…· (Context7)
                - ç¶²é æœç´¢å·¥å…· (Brave Search)

                è«‹æ ¹æ“šç”¨æˆ¶éœ€æ±‚é¸æ“‡åˆé©çš„å·¥å…·ã€‚
                """)
            .defaultFunctions(mcpTools)  // è¨»å†Šæ‰€æœ‰ MCP å·¥å…·
            .build();
    }
}
```

**æ•´åˆæµç¨‹**:

```mermaid
sequenceDiagram
    participant User
    participant ChatClient
    participant MCP Client
    participant MCP Server
    participant AI Model

    User->>ChatClient: ç™¼é€å•é¡Œ
    ChatClient->>MCP Client: ç²å–å¯ç”¨å·¥å…·
    MCP Client->>MCP Server: tools/list
    MCP Server-->>MCP Client: å·¥å…·åˆ—è¡¨
    MCP Client-->>ChatClient: ToolCallback[]
    ChatClient->>AI Model: å•é¡Œ + å·¥å…·å®šç¾©
    AI Model->>MCP Client: èª¿ç”¨å·¥å…·
    MCP Client->>MCP Server: tools/call
    MCP Server-->>MCP Client: å·¥å…·çµæœ
    MCP Client-->>AI Model: è¿”å›çµæœ
    AI Model-->>User: ç”Ÿæˆå›ç­”
```

---

## ğŸ¬ å‘½ä»¤è¡Œäº¤äº’æ‡‰ç”¨

### CLI Runner

**ä½ç½®**: `src/main/java/com/example/mcpclient/cli/CliRunner.java`

```java
@Component
@Slf4j
public class CliRunner implements CommandLineRunner {

    private final ChatClient chatClient;
    private final List<McpSyncClient> mcpClients;

    @Override
    public void run(String... args) {
        displayWelcomeMessage();
        displayAvailableTools();
        startChatLoop();
    }

    /**
     * é¡¯ç¤ºå¯ç”¨çš„ MCP å·¥å…·
     */
    private void displayAvailableTools() {
        log.info("\n=== å¯ç”¨çš„ MCP Server ===");

        for (McpSyncClient client : mcpClients) {
            var result = client.listTools(new McpSchema.ListToolsRequest());

            log.info("Server: {}", client.getServerName());
            result.tools().forEach(tool ->
                log.info("  - {}: {}", tool.name(), tool.description())
            );
        }
    }

    /**
     * èŠå¤©å¾ªç’°
     */
    private void startChatLoop() {
        Scanner scanner = new Scanner(System.in);

        while (true) {
            System.out.print("\nYou: ");
            String input = scanner.nextLine();

            if ("exit".equalsIgnoreCase(input)) {
                break;
            }

            // ä½¿ç”¨ ChatClient è™•ç†
            String response = chatClient.prompt()
                .user(input)
                .call()
                .content();

            System.out.println("AI: " + response);
        }
    }
}
```

**åƒè€ƒå®Œæ•´å¯¦ç¾**: `src/main/java/com/example/mcpclient/cli/CliRunner.java:15-80`

---

## ğŸ” å·¥å…·ç™¼ç¾èˆ‡èª¿ç”¨

### æ‰‹å‹•å·¥å…·èª¿ç”¨

é›–ç„¶ ChatClient æœƒè‡ªå‹•èª¿ç”¨å·¥å…·ï¼Œä½†ä½ ä¹Ÿå¯ä»¥æ‰‹å‹•èª¿ç”¨ï¼š

**ä½ç½®**: `src/main/java/com/example/mcpclient/service/McpToolService.java`

```java
@Service
@Slf4j
public class McpToolService {

    private final List<McpSyncClient> mcpClients;

    /**
     * æ‰‹å‹•åŸ·è¡ŒæŒ‡å®šå·¥å…·
     */
    public String executeTool(String toolName, Map<String, Object> arguments) {

        for (McpSyncClient client : mcpClients) {
            // æª¢æŸ¥å·¥å…·æ˜¯å¦å­˜åœ¨
            if (hasToolInClient(client, toolName)) {

                // èª¿ç”¨å·¥å…·
                var request = new McpSchema.CallToolRequest(toolName, arguments);
                var result = client.callTool(request);

                // æå–æ–‡æœ¬çµæœ
                return extractTextContent(result);
            }
        }

        throw new RuntimeException("å·¥å…·æœªæ‰¾åˆ°: " + toolName);
    }

    private boolean hasToolInClient(McpSyncClient client, String toolName) {
        var result = client.listTools(new McpSchema.ListToolsRequest());
        return result.tools().stream()
            .anyMatch(tool -> tool.name().equals(toolName));
    }
}
```

**åƒè€ƒå®Œæ•´å¯¦ç¾**: `src/main/java/com/example/mcpclient/service/McpToolService.java:25-65`

---

## ğŸ“– è³‡æºè®€å–

### è®€å– MCP è³‡æº

MCP Server ä¹Ÿå¯ä»¥æä¾›è³‡æºï¼ˆå¦‚æ–‡ä»¶ã€è³‡æ–™ï¼‰ï¼š

```java
@Service
@Slf4j
public class McpResourceService {

    private final List<McpSyncClient> mcpClients;

    /**
     * è®€å–è³‡æº
     */
    public String readResource(String resourceUri) {

        for (McpSyncClient client : mcpClients) {
            try {
                var request = new McpSchema.ReadResourceRequest(
                    URI.create(resourceUri)
                );

                var result = client.readResource(request);

                // æå–æ–‡æœ¬å…§å®¹
                return result.contents().stream()
                    .filter(c -> c instanceof McpSchema.TextResourceContents)
                    .map(c -> ((McpSchema.TextResourceContents) c).text())
                    .collect(Collectors.joining("\n"));

            } catch (Exception e) {
                log.debug("è³‡æºä¸åœ¨æ­¤ Server: {}", client.getServerName());
            }
        }

        throw new RuntimeException("è³‡æºæœªæ‰¾åˆ°: " + resourceUri);
    }
}
```

**åƒè€ƒå®Œæ•´å¯¦ç¾**: `src/main/java/com/example/mcpclient/service/McpResourceService.java:18-50`

---

## ğŸš€ å•Ÿå‹•å’Œæ¸¬è©¦

### å•Ÿå‹•æ‡‰ç”¨

1. **è¨­ç½®ç’°å¢ƒè®Šæ•¸**:
```bash
export OPENAI_API_KEY="your-openai-api-key"
export BRAVE_API_KEY="your-brave-api-key"  # å¯é¸
```

2. **å•Ÿå‹•æ‡‰ç”¨**:
```bash
cd code-examples/chapter9-mcp-integration/chapter9-mcp-client-basic
mvn spring-boot:run
```

3. **æŸ¥çœ‹å•Ÿå‹•æ—¥èªŒ**:
```
=== MCP Client é€£æ¥ç‹€æ…‹ ===
å·²é€£æ¥ 1 å€‹ MCP Server
  - Server: context7

=== å¯ç”¨çš„ MCP Server ===
Server: context7
  - resolve-library-id: è§£æç¨‹å¼åº«åç¨±åˆ° Context7 ID
  - get-library-docs: ç²å–ç¨‹å¼åº«æ–‡æª”
```

---

### æ¸¬è©¦å°è©±

**ç¯„ä¾‹ 1: æŸ¥è©¢ React æ–‡æª”**
```
You: How to use React hooks?

AI: [ä½¿ç”¨ get-library-docs å·¥å…·æŸ¥è©¢]
    React Hooks æ˜¯ React 16.8 å¼•å…¥çš„åŠŸèƒ½...
```

**ç¯„ä¾‹ 2: æœç´¢æœ€æ–°è³‡è¨Š**
```
You: What's the latest news about AI?

AI: [ä½¿ç”¨ brave_web_search å·¥å…·]
    æ ¹æ“šæœ€æ–°æœç´¢çµæœ...
```

---

## ğŸ”§ é€²éšé…ç½®

### è‡ªå®šç¾© Client è¡Œç‚º

**ä½ç½®**: `src/main/java/com/example/mcpclient/config/McpClientCustomizer.java`

```java
@Component
@Slf4j
public class McpClientCustomizer implements McpSyncClientCustomizer {

    @Override
    public void customize(String serverName, McpClient.SyncSpec spec) {
        log.info("è‡ªå®šç¾© MCP Client: {}", serverName);

        // è¨­ç½®è¶…æ™‚
        spec.requestTimeout(Duration.ofSeconds(30));

        // ç›£è½å·¥å…·è®Šæ›´
        spec.toolsChangeConsumer(tools -> {
            log.info("Server {} å·¥å…·å·²æ›´æ–°ï¼Œå…± {} å€‹",
                serverName, tools.size());
        });

        // ç›£è½è³‡æºè®Šæ›´
        spec.resourcesChangeConsumer(resources -> {
            log.info("Server {} è³‡æºå·²æ›´æ–°ï¼Œå…± {} å€‹",
                serverName, resources.size());
        });
    }
}
```

**åƒè€ƒå®Œæ•´å¯¦ç¾**: `src/main/java/com/example/mcpclient/config/McpClientManager.java:45-70`

---

## ğŸ“ é‡é»å›é¡§

### æ ¸å¿ƒæ¦‚å¿µ

| çµ„ä»¶ | èªªæ˜ | é‡è¦æ€§ |
|------|------|--------|
| **McpSyncClient** | MCP å®¢æˆ¶ç«¯å¯¦ä¾‹ | â­â­â­â­â­ |
| **ToolCallbackProvider** | å·¥å…·å›èª¿æä¾›è€… | â­â­â­â­â­ |
| **ChatClient æ•´åˆ** | èˆ‡ AI å°è©±æ•´åˆ | â­â­â­â­ |
| **å¤š Server ç®¡ç†** | åŒæ™‚é€£æ¥å¤šå€‹ Server | â­â­â­ |

---

### é…ç½®è¦é»

1. **SSE å‚³è¼¸**: ç”¨æ–¼é ç«¯ HTTP Server
2. **STDIO å‚³è¼¸**: ç”¨æ–¼æœ¬åœ°é€²ç¨‹ Server
3. **è‡ªå‹•æ³¨å…¥**: Spring è‡ªå‹•é…ç½®æ‰€æœ‰ Client
4. **å·¥å…·èšåˆ**: è‡ªå‹•åˆä½µå¤šå€‹ Server çš„å·¥å…·

---

### æ•´åˆæµç¨‹

```mermaid
graph LR
    A[application.yml] --> B[Spring Boot]
    B --> C[è‡ªå‹•é…ç½®]
    C --> D[McpSyncClient]
    C --> E[ToolCallbackProvider]
    D --> F[ChatClient]
    E --> F
    F --> G[ç”¨æˆ¶æ‡‰ç”¨]

    style A fill:#e1f5ff
    style D fill:#e8f5e9
    style E fill:#e8f5e9
    style G fill:#f3e5f5
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

ç¾åœ¨ä½ å·²ç¶“æŒæ¡äº† MCP Client çš„ä½¿ç”¨ï¼Œæ¥ä¸‹ä¾†æˆ‘å€‘å°‡å­¸ç¿’ï¼š

ğŸ‘‰ [9.3 MCP Server å·¥å…·é–‹ç™¼](./9.3-MCP-Server-å·¥å…·é–‹ç™¼.md) - å¦‚ä½•é–‹ç™¼è‡ªå·±çš„ MCP Server

---

## ğŸ“š å®Œæ•´ç¯„ä¾‹

æœ¬ç« æ¦‚å¿µçš„å®Œæ•´å¯¦ç¾è«‹åƒè€ƒ:

ğŸ“ **chapter9-mcp-client-basic**
- `src/main/resources/application.yml` - Client é…ç½®
- `src/main/java/.../config/ChatClientConfig.java` - ChatClient æ•´åˆ
- `src/main/java/.../cli/CliRunner.java` - å‘½ä»¤è¡Œæ‡‰ç”¨
- `src/main/java/.../service/McpToolService.java` - å·¥å…·æœå‹™

ğŸ”— **å•Ÿå‹•ç¯„ä¾‹**:
```bash
cd code-examples/chapter9-mcp-integration/chapter9-mcp-client-basic
export OPENAI_API_KEY="your-key"
mvn spring-boot:run
```

---

## â“ å¸¸è¦‹å•é¡Œ

### Q1: å¦‚ä½•é€£æ¥å¤šå€‹ MCP Server?

åœ¨ `application.yml` ä¸­æ·»åŠ å¤šå€‹é€£æ¥é…ç½®ï¼š

```yaml
spring:
  ai:
    mcp:
      client:
        sse:
          connections:
            server1:
              url: http://localhost:8080
            server2:
              url: http://localhost:8081
```

æ‰€æœ‰å·¥å…·æœƒè‡ªå‹•èšåˆåˆ° `ToolCallbackProvider`ã€‚

---

### Q2: STDIO Server ç„¡æ³•å•Ÿå‹•æ€éº¼è¾¦?

æª¢æŸ¥ä»¥ä¸‹é …ç›®ï¼š
1. Node.js æ˜¯å¦å·²å®‰è£
2. ç’°å¢ƒè®Šæ•¸æ˜¯å¦æ­£ç¢ºè¨­ç½®
3. Server å‘½ä»¤æ˜¯å¦æ­£ç¢º
4. æŸ¥çœ‹å•Ÿå‹•æ—¥èªŒä¸­çš„éŒ¯èª¤è¨Šæ¯

---

### Q3: å¦‚ä½•è™•ç†å·¥å…·èª¿ç”¨éŒ¯èª¤?

MCP Client æœƒè‡ªå‹•è™•ç†éŒ¯èª¤ï¼Œä½ ä¹Ÿå¯ä»¥æ·»åŠ è‡ªå®šç¾©è™•ç†ï¼š

```java
try {
    String result = mcpService.executeTool(toolName, params);
} catch (Exception e) {
    log.error("å·¥å…·èª¿ç”¨å¤±æ•—", e);
    return "å·¥å…·æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œå†è©¦";
}
```

---

**ç›¸é—œç« ç¯€**:
- â† ä¸Šä¸€ç« : [9.1 MCP å”è­°åŸºç¤](./9.1-MCP-å”è­°åŸºç¤.md)
- â†’ ä¸‹ä¸€ç« : [9.3 MCP Server å·¥å…·é–‹ç™¼](./9.3-MCP-Server-å·¥å…·é–‹ç™¼.md)
- â†‘ å›åˆ°: [ç¬¬9ç« ç¸½è¦½](./README.md)
