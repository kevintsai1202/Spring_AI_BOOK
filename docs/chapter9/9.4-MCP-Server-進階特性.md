# 9.4 MCP Server é€²éšç‰¹æ€§

> **å°æ‡‰ç« ç¯€**: é€²éšå¯¦æˆ°
> **é›£åº¦**: â­â­â­â­â˜†
> **å­¸ç¿’æ™‚é–“**: 90 åˆ†é˜

---

## ğŸ“š æœ¬ç« æ¦‚è¦

æ·±å…¥æŒæ¡ MCP Server çš„é€²éšåŠŸèƒ½ï¼ŒåŒ…æ‹¬æ™ºèƒ½æç¤ºç³»çµ±ï¼ˆPromptsï¼‰ã€è‡ªå‹•å®Œæˆï¼ˆCompletionsï¼‰ã€å‹•æ…‹å·¥å…·æ›´æ–°ã€å®¢æˆ¶ç«¯é€šçŸ¥ç­‰ä¼æ¥­ç´šç‰¹æ€§ã€‚æœ¬ç« å°‡ä½¿ç”¨ Spring AI çš„é«˜éšè¨»è§£å’Œ JPA æ•´åˆï¼Œå¯¦ç¾æ›´è¤‡é›œçš„ MCP æ‡‰ç”¨å ´æ™¯ã€‚

**å­¸ç¿’ç›®æ¨™**:
- ä½¿ç”¨ @McpPrompt é–‹ç™¼æ™ºèƒ½æç¤ºç³»çµ±
- ä½¿ç”¨ @McpComplete å¯¦ç¾è‡ªå‹•å®ŒæˆåŠŸèƒ½
- æŒæ¡å®¢æˆ¶ç«¯é€šçŸ¥æ©Ÿåˆ¶ï¼ˆLoggingã€Progressã€Samplingï¼‰
- æ•´åˆè³‡æ–™åº«å¯¦ç¾å‹•æ…‹åŠŸèƒ½
- ç†è§£ MCP Server çš„é€²éšéƒ¨ç½²ç­–ç•¥

**å°æ‡‰ç¯„ä¾‹å°ˆæ¡ˆ**: `code-examples/chapter9-mcp-integration/chapter9-mcp-server-advanced`

---

## âš ï¸ ç‰ˆæœ¬è¦æ±‚

**é‡è¦æç¤º**: æœ¬ç« åŠŸèƒ½éœ€è¦ **Spring AI 1.1.0-SNAPSHOT** æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚

é€²éš MCP åŠŸèƒ½ï¼ˆ`@McpPrompt`ã€`@McpComplete` ç­‰è¨»è§£ï¼‰åœ¨ Spring AI 1.0.3 ç©©å®šç‰ˆä¸­ä¸å¯ç”¨ã€‚å¦‚æœä½ å¸Œæœ›ä½¿ç”¨ç©©å®šç‰ˆæœ¬ï¼Œè«‹è·³éæœ¬ç« é€²éšåŠŸèƒ½ï¼Œå°ˆæ³¨æ–¼ 9.3 ç« çš„åŸºç¤å·¥å…·é–‹ç™¼ã€‚

```xml
<!-- ä½¿ç”¨ Spring AI 1.1.0-SNAPSHOT -->
<spring-ai.version>1.1.0-SNAPSHOT</spring-ai.version>
```

---

## ğŸ¯ é€²éšåŠŸèƒ½æ¶æ§‹

```mermaid
graph TB
    subgraph MCP_Advanced["MCP Server Advanced"]
        APP[McpServerAdvancedApplication]
        PROMPT[PromptProvider æ™ºèƒ½æç¤º]
        COMPLETE[CompletionProvider è‡ªå‹•å®Œæˆ]
        DYNAMIC[DynamicPromptProvider å‹•æ…‹æç¤º]
        PROMPT_ANNO[McpPrompt è¨»è§£]
        COMPLETE_ANNO[McpComplete è¨»è§£]
        REPO[JPA Repository]
        DB[(H2 Database è¨˜æ†¶é«”è³‡æ–™åº«)]

        APP --> PROMPT
        APP --> COMPLETE
        APP --> DYNAMIC
        PROMPT --> PROMPT_ANNO
        COMPLETE --> COMPLETE_ANNO
        DYNAMIC --> REPO
        REPO --> DB
    end

    subgraph Client_Notify["å®¢æˆ¶ç«¯é€šçŸ¥"]
        LOG[Logging Notification æ—¥èªŒé€šçŸ¥]
        PROG[Progress Notification é€²åº¦é€šçŸ¥]
        SAMPLE[Sampling æ¡æ¨£è«‹æ±‚]
    end

    APP --> LOG
    APP --> PROG
    APP --> SAMPLE

    style APP fill:#e1f5ff
    style PROMPT fill:#e8f5e9
    style COMPLETE fill:#fff4e6
    style DYNAMIC fill:#f3e5f5
    style DB fill:#ffe0b2
```

---

## ğŸ¨ æ™ºèƒ½æç¤ºç³»çµ± (Prompts)

### ä½¿ç”¨ @McpPrompt è¨»è§£

Spring AI æä¾› `@McpPrompt` è¨»è§£ä¾†å®šç¾©å¯é‡ç”¨çš„æ™ºèƒ½æç¤ºæ¨¡æ¿ã€‚

#### åŸºç¤æç¤ºç¯„ä¾‹

```java
@Service
@Slf4j
public class PromptProvider {

    @McpPrompt(
        name = "greeting",
        description = "Simple greeting prompt"
    )
    public McpSchema.GetPromptResult greeting(
            @McpArg(name = "name", required = true, description = "User's name")
            String name) {

        log.info("ç”Ÿæˆå•å€™æç¤º: name={}", name);

        String message = String.format("Hello, %s! How can I help you today?", name);

        return new McpSchema.GetPromptResult(
            "Greeting",
            List.of(new McpSchema.PromptMessage(
                McpSchema.Role.ASSISTANT,
                new McpSchema.TextContent(message)
            ))
        );
    }
}
```

**å°æ‡‰æª”æ¡ˆ**: `chapter9-mcp-server-advanced/src/main/java/com/example/mcp/server/advanced/provider/PromptProvider.java:28-46`

**é—œéµè¦é»**:
- `@McpPrompt` å®šç¾©æç¤ºåç¨±å’Œæè¿°
- `@McpArg` å®šç¾©æç¤ºåƒæ•¸ï¼ˆå¯æ¨™è¨˜å¿…å¡«é …ï¼‰
- å›å‚³ `GetPromptResult` åŒ…å«ä¸€å€‹æˆ–å¤šå€‹ `PromptMessage`
- æ”¯æ´ `Role.USER`ã€`Role.ASSISTANT`ã€`Role.SYSTEM`

---

#### é€²éšæç¤ºï¼šæ¢ä»¶é‚è¼¯

```java
@McpPrompt(
    name = "personalized-message",
    description = "Personalized message based on user info (name, age, interests)"
)
public McpSchema.GetPromptResult personalizedMessage(
        McpSyncServerExchange exchange,
        @McpArg(name = "name", required = true, description = "User's name") String name,
        @McpArg(name = "age", required = false, description = "User's age") Integer age,
        @McpArg(name = "interests", required = false, description = "User's interests") String interests) {

    StringBuilder message = new StringBuilder("Hello, " + name + "!\n\n");

    // æ ¹æ“šå¹´é½¡æ·»åŠ ä¸åŒå…§å®¹
    if (age != null) {
        if (age < 18) {
            message.append("You're young and full of potential! The world is yours to explore.\n");
        } else if (age < 30) {
            message.append("This is a great time to build your future.\n");
        } else {
            message.append("You have gained valuable life experience and wisdom.\n");
        }
    }

    // æ ¹æ“šèˆˆè¶£æ·»åŠ å…§å®¹
    if (interests != null && !interests.isEmpty()) {
        message.append("I see you're interested in ").append(interests).append(".\n");
    }

    return new McpSchema.GetPromptResult(
        "Personalized Message",
        List.of(new McpSchema.PromptMessage(
            McpSchema.Role.ASSISTANT,
            new McpSchema.TextContent(message.toString())
        ))
    );
}
```

**å°æ‡‰æª”æ¡ˆ**: `chapter9-mcp-server-advanced/src/main/java/com/example/mcp/server/advanced/provider/PromptProvider.java:58-112`

**æŠ€è¡“äº®é»**:
- æ”¯æ´å¯é¸åƒæ•¸ï¼ˆ`required = false`ï¼‰
- æ¢ä»¶é‚è¼¯æ ¹æ“šåƒæ•¸å‹•æ…‹ç”Ÿæˆå…§å®¹
- å¯æ³¨å…¥ `McpSyncServerExchange` ç™¼é€å®¢æˆ¶ç«¯é€šçŸ¥

---

#### å¤šè¨Šæ¯å°è©±æµç¨‹

```java
@McpPrompt(
    name = "conversation-starter",
    description = "Multi-message conversation flow for learning a topic"
)
public McpSchema.GetPromptResult conversationStarter(
        @McpArg(name = "topic", required = true, description = "Topic to learn about")
        String topic) {

    List<McpSchema.PromptMessage> messages = new ArrayList<>();

    // ç”¨æˆ¶åˆå§‹è«‹æ±‚
    messages.add(new McpSchema.PromptMessage(
        McpSchema.Role.USER,
        new McpSchema.TextContent("I want to learn about " + topic)
    ));

    // åŠ©æ‰‹å›æ‡‰
    messages.add(new McpSchema.PromptMessage(
        McpSchema.Role.ASSISTANT,
        new McpSchema.TextContent(
            "Great! Let's start with the basics of " + topic + ". " +
            "I'll guide you through the fundamental concepts step by step."
        )
    ));

    // ç”¨æˆ¶å¾ŒçºŒå•é¡Œ
    messages.add(new McpSchema.PromptMessage(
        McpSchema.Role.USER,
        new McpSchema.TextContent("What are the key concepts I should understand?")
    ));

    return new McpSchema.GetPromptResult("Conversation Starter", messages);
}
```

**å°æ‡‰æª”æ¡ˆ**: `chapter9-mcp-server-advanced/src/main/java/com/example/mcp/server/advanced/provider/PromptProvider.java:121-168`

**æ‡‰ç”¨å ´æ™¯**:
- å»ºç«‹é è¨­å°è©±æµç¨‹
- å¼•å°ç”¨æˆ¶é€²å…¥ç‰¹å®šä¸»é¡Œ
- æä¾›å­¸ç¿’è·¯å¾‘æ¨¡æ¿

---

### å‹•æ…‹æç¤ºï¼ˆè³‡æ–™åº«é©…å‹•ï¼‰

ä½¿ç”¨ JPA å¾è³‡æ–™åº«è¼‰å…¥æç¤ºæ¨¡æ¿ï¼Œå¯¦ç¾é‹è¡Œæ™‚å‹•æ…‹ç®¡ç†ã€‚

#### è³‡æ–™æ¨¡å‹

```java
@Entity
@Table(name = "prompt_template")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class PromptTemplate {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false, unique = true)
    private String name;  // æç¤ºåç¨±

    @Column(length = 1000)
    private String description;  // æç¤ºæè¿°

    @Column(length = 5000)
    private String template;  // æç¤ºæ¨¡æ¿

    @Column(length = 500)
    private String parameters;  // åƒæ•¸åˆ—è¡¨ï¼ˆJSON æ ¼å¼ï¼‰
}
```

**å¯¦ä½œä½ç½®**: `chapter9-mcp-server-advanced/src/main/java/com/example/mcp/server/advanced/entity/PromptTemplate.java`

---

#### å‹•æ…‹æç¤ºæä¾›è€…

```java
@Service
@Slf4j
public class DynamicPromptProvider {

    @Autowired
    private PromptTemplateRepository promptTemplateRepository;

    @McpPrompt(
        name = "template-prompt",
        description = "Dynamic prompt loaded from database by template name"
    )
    public McpSchema.GetPromptResult getTemplatePrompt(
            @McpArg(name = "template_name", required = true) String templateName,
            @McpArg(name = "variables", required = false) String variablesJson) {

        log.info("è¼‰å…¥å‹•æ…‹æç¤ºæ¨¡æ¿: template={}", templateName);

        // å¾è³‡æ–™åº«è¼‰å…¥æ¨¡æ¿
        Optional<PromptTemplate> templateOpt = promptTemplateRepository.findByName(templateName);

        if (templateOpt.isEmpty()) {
            return new McpSchema.GetPromptResult(
                "Error",
                List.of(new McpSchema.PromptMessage(
                    McpSchema.Role.ASSISTANT,
                    new McpSchema.TextContent("æ‰¾ä¸åˆ°æç¤ºæ¨¡æ¿: " + templateName)
                ))
            );
        }

        PromptTemplate template = templateOpt.get();
        String content = template.getTemplate();

        // æ›¿æ›è®Šæ•¸ï¼ˆå¦‚æœæœ‰æä¾›ï¼‰
        if (variablesJson != null) {
            content = replaceVariables(content, variablesJson);
        }

        return new McpSchema.GetPromptResult(
            template.getDescription(),
            List.of(new McpSchema.PromptMessage(
                McpSchema.Role.ASSISTANT,
                new McpSchema.TextContent(content)
            ))
        );
    }
}
```

**å¯¦ä½œä½ç½®**: `chapter9-mcp-server-advanced/src/main/java/com/example/mcp/server/advanced/provider/DynamicPromptProvider.java`

---

## âœ¨ è‡ªå‹•å®ŒæˆåŠŸèƒ½ (Completions)

### URI è£œå…¨

ç‚º MCP è³‡æº URI æä¾›è‡ªå‹•å®Œæˆå»ºè­°ã€‚

```java
@Service
@Slf4j
public class CompletionProvider {

    @McpComplete(uri = "user-profile://{username}")
    public List<String> completeUsername(String usernamePrefix) {
        log.info("ç”¨æˆ¶å URI è£œå…¨: prefix={}", usernamePrefix);

        if (usernamePrefix == null || usernamePrefix.isEmpty()) {
            return List.of("Enter a username (e.g., alice, bob, charlie)");
        }

        // å¾å¿«å–æˆ–è³‡æ–™åº«è¼‰å…¥ç”¨æˆ¶ååˆ—è¡¨
        List<String> usernames = loadUsernames();

        // éæ¿¾åŒ¹é…çš„ç”¨æˆ¶å
        return usernames.stream()
            .filter(u -> u.toLowerCase().startsWith(usernamePrefix.toLowerCase()))
            .sorted()
            .limit(10)
            .toList();
    }
}
```

**å°æ‡‰æª”æ¡ˆ**: `chapter9-mcp-server-advanced/src/main/java/com/example/mcp/server/advanced/provider/CompletionProvider.java:115-137`

**ä½¿ç”¨å ´æ™¯**:
- ç”¨æˆ¶è¼¸å…¥ `user-profile://a` æ™‚ï¼Œè‡ªå‹•å»ºè­° `alice`, `andrew`, `amanda`
- æ”¯æ´å‹•æ…‹è¼‰å…¥å€™é¸æ¸…å–®ï¼ˆå¾è³‡æ–™åº«æˆ– APIï¼‰

---

### Prompt åƒæ•¸è£œå…¨

ç‚ºæç¤ºçš„åƒæ•¸æä¾›è‡ªå‹•å®Œæˆã€‚

```java
@McpComplete(prompt = "travel-plan")
public McpSchema.CompleteResult completeCountryName(McpSchema.CompleteRequest request) {
    log.info("åœ‹å®¶å Prompt è£œå…¨: request={}", request);

    // å–å¾—ç•¶å‰è¼¸å…¥çš„åƒæ•¸å€¼
    String prefix = extractPrefix(request.argument());

    // å¾è³‡æ–™åº«è¼‰å…¥åœ‹å®¶æ¸…å–®
    List<String> countries = loadCountries(prefix);

    // å»ºç«‹è£œå…¨çµæœ
    List<CompleteCompletion> completions = countries.stream()
        .map(country -> new CompleteCompletion(country, "country", false))
        .toList();

    return new McpSchema.CompleteResult(completions, false);
}
```

**å¯¦ä½œä½ç½®**: `chapter9-mcp-server-advanced/src/main/java/com/example/mcp/server/advanced/provider/CompletionProvider.java:146`

**è£œå…¨æ ¼å¼**:
- `CompleteCompletion(value, type, hasMore)`
- `value`: è£œå…¨å€¼
- `type`: è£œå…¨é¡å‹ï¼ˆå¯é¸ï¼‰
- `hasMore`: æ˜¯å¦é‚„æœ‰æ›´å¤šçµæœ

---

### è³‡æ–™åº«é©…å‹•çš„è£œå…¨

ä½¿ç”¨ JPA ç®¡ç†è£œå…¨æ•¸æ“šï¼Œæ”¯æ´å‹•æ…‹æ›´æ–°ã€‚

#### è³‡æ–™æ¨¡å‹

```java
@Entity
@Table(name = "completion_data")
@Data
@NoArgsConstructor
public class CompletionData {

    @Id
    private String category;  // é¡åˆ¥ï¼ˆusername, country, languageï¼‰

    @Convert(converter = StringListConverter.class)
    @Column(length = 5000)
    private List<String> values;  // è£œå…¨å€¼åˆ—è¡¨

    private String description;  // æè¿°

    private boolean enabled = true;  // æ˜¯å¦å•Ÿç”¨
}
```

**å¯¦ä½œä½ç½®**: `chapter9-mcp-server-advanced/src/main/java/com/example/mcp/server/advanced/entity/CompletionData.java`

#### åˆå§‹åŒ–è£œå…¨å¿«å–

```java
@PostConstruct
public void initializeCache() {
    log.info("åˆå§‹åŒ–è£œå…¨æ•¸æ“šå¿«å–");

    // å¾è³‡æ–™åº«è¼‰å…¥æ•¸æ“šåˆ°è¨˜æ†¶é«”å¿«å–
    loadCacheFromDatabase("username");
    loadCacheFromDatabase("country");
    loadCacheFromDatabase("language");
}

private void loadCacheFromDatabase(String category) {
    Optional<CompletionData> dataOpt = completionDataRepository.findByCategory(category);
    if (dataOpt.isPresent()) {
        List<String> values = dataOpt.get().getValues();
        // æŒ‰é¦–å­—æ¯åˆ†çµ„ï¼ŒåŠ é€ŸæŸ¥è©¢
        cache.put(category, groupByFirstLetter(values));
    }
}
```

**å°æ‡‰æª”æ¡ˆ**: `chapter9-mcp-server-advanced/src/main/java/com/example/mcp/server/advanced/provider/CompletionProvider.java:39-69`

---

## ğŸ”” å®¢æˆ¶ç«¯é€šçŸ¥æ©Ÿåˆ¶

MCP Server å¯ä»¥ä¸»å‹•å‘å®¢æˆ¶ç«¯ç™¼é€é€šçŸ¥ï¼Œå¢å¼·äº’å‹•æ€§ã€‚

### Logging Notificationï¼ˆæ—¥èªŒé€šçŸ¥ï¼‰

```java
@McpPrompt(name = "personalized-message", description = "...")
public McpSchema.GetPromptResult personalizedMessage(
        McpSyncServerExchange exchange,
        @McpArg(name = "name", required = true) String name,
        ...) {

    // ç™¼é€ INFO æ—¥èªŒ
    exchange.loggingNotification(McpSchema.LoggingMessageNotification.builder()
        .level(McpSchema.LoggingLevel.INFO)
        .data("Generating personalized message for: " + name)
        .build());

    // è™•ç†é‚è¼¯...

    // ç™¼é€å®Œæˆé€šçŸ¥
    exchange.loggingNotification(McpSchema.LoggingMessageNotification.builder()
        .level(McpSchema.LoggingLevel.INFO)
        .data("Personalized message generated successfully")
        .build());

    return result;
}
```

**å°æ‡‰æª”æ¡ˆ**: `chapter9-mcp-server-advanced/src/main/java/com/example/mcp/server/advanced/provider/PromptProvider.java:71-103`

**æ—¥èªŒç´šåˆ¥**:
- `DEBUG`: èª¿è©¦è³‡è¨Š
- `INFO`: ä¸€èˆ¬è³‡è¨Š
- `WARNING`: è­¦å‘Š
- `ERROR`: éŒ¯èª¤

---

### Progress Notificationï¼ˆé€²åº¦é€šçŸ¥ï¼‰

å°æ–¼é•·æ™‚é–“é‹è¡Œçš„æ“ä½œï¼Œå¯ç™¼é€é€²åº¦æ›´æ–°ã€‚

```java
public void processLongRunningTask(McpSyncServerExchange exchange) {
    int totalSteps = 5;

    for (int i = 1; i <= totalSteps; i++) {
        // ç™¼é€é€²åº¦é€šçŸ¥
        exchange.progressNotification(McpSchema.ProgressNotification.builder()
            .progressToken("task-123")
            .progress(i)
            .total(totalSteps)
            .build());

        // åŸ·è¡Œæ­¥é©Ÿ...
        performStep(i);
    }
}
```

**æ‡‰ç”¨å ´æ™¯**:
- å¤§æª”æ¡ˆè™•ç†
- æ‰¹æ¬¡è³‡æ–™åˆ†æ
- é•·æ™‚é–“é‹ç®—

---

### Sampling Requestï¼ˆæ¡æ¨£è«‹æ±‚ï¼‰

MCP Server å¯ä»¥è«‹æ±‚å®¢æˆ¶ç«¯çš„ LLM ç”Ÿæˆå…§å®¹ã€‚

```java
@Tool(description = "Generate content using client's LLM")
public String generateWithSampling(McpSyncServerExchange exchange, String prompt) {

    // ç™¼é€ Sampling è«‹æ±‚
    McpSchema.CreateMessageRequest samplingRequest = McpSchema.CreateMessageRequest.builder()
        .messages(List.of(new McpSchema.SamplingMessage(
            McpSchema.Role.USER,
            new McpSchema.TextContent(prompt)
        )))
        .maxTokens(1000)
        .build();

    McpSchema.CreateMessageResult result = exchange.createMessage(samplingRequest);

    return extractContent(result);
}
```

**ä½¿ç”¨å ´æ™¯**:
- åˆ©ç”¨å®¢æˆ¶ç«¯çš„ LLM èƒ½åŠ›
- æ¸›å°‘ Server ç«¯çš„æ¨¡å‹è² æ“”
- è®“å®¢æˆ¶ç«¯æ§åˆ¶ç”Ÿæˆç­–ç•¥

---

## ğŸ—„ï¸ è³‡æ–™åº«æ•´åˆ

### H2 è¨˜æ†¶é«”è³‡æ–™åº«é…ç½®

```yaml
spring:
  datasource:
    url: jdbc:h2:mem:mcpdb
    driver-class-name: org.h2.Driver
    username: sa
    password:

  jpa:
    hibernate:
      ddl-auto: create-drop  # æ¯æ¬¡å•Ÿå‹•é‡å»ºè³‡æ–™åº«
    show-sql: true           # é¡¯ç¤º SQL èªå¥

  h2:
    console:
      enabled: true          # å•Ÿç”¨ H2 Console
      path: /h2-console      # Console è·¯å¾‘

  sql:
    init:
      mode: always
      data-locations: classpath:data.sql  # åˆå§‹åŒ–æ•¸æ“šè…³æœ¬
```

**å°æ‡‰æª”æ¡ˆ**: `chapter9-mcp-server-advanced/src/main/resources/application.yml:31-58`

---

### è³‡æ–™åˆå§‹åŒ–è…³æœ¬

```sql
-- data.sql
-- æ’å…¥æç¤ºæ¨¡æ¿
INSERT INTO prompt_template (name, description, template, parameters) VALUES
('code-review', 'Code review template',
 'Please review the following {{language}} code:\n\n{{code}}\n\nProvide feedback on:',
 '["language", "code"]');

-- æ’å…¥è£œå…¨æ•¸æ“š
INSERT INTO completion_data (category, values, description, enabled) VALUES
('username', '["alice", "bob", "charlie", "david"]', 'User names', true),
('country', '["Japan", "Taiwan", "United States"]', 'Country names', true),
('language', '["Java", "Python", "JavaScript"]', 'Programming languages', true);
```

**å¯¦ä½œä½ç½®**: `chapter9-mcp-server-advanced/src/main/resources/data.sql`

---

## ğŸ“ é…ç½®å’Œå•Ÿå‹•

### application.yml æ ¸å¿ƒé…ç½®

```yaml
spring:
  ai:
    mcp:
      server:
        name: advanced-server
        version: 1.0.0
        type: SYNC

        # å•Ÿç”¨è®Šæ›´é€šçŸ¥
        prompt-change-notification: true
        tool-change-notification: true
        resource-change-notification: true

server:
  port: 8081  # é¿å…èˆ‡ 8080 è¡çª
```

**å°æ‡‰æª”æ¡ˆ**: `chapter9-mcp-server-advanced/src/main/resources/application.yml:1-23`

---

### ç·¨è­¯å’Œå•Ÿå‹•

```powershell
# è¨­å®šç’°å¢ƒ
$env:JAVA_HOME="D:\java\jdk-21"
$env:Path="D:\java\jdk-21\bin;$env:Path"

# ç·¨è­¯
cd E:\Spring_AI_BOOK\code-examples\chapter9-mcp-integration\chapter9-mcp-server-advanced
mvn clean compile

# å•Ÿå‹•
mvn spring-boot:run
```

**å•Ÿå‹•å¾Œè¨ªå•**:
- æ‡‰ç”¨ç¨‹å¼: http://localhost:8081
- H2 Console: http://localhost:8081/h2-console
  - JDBC URL: `jdbc:h2:mem:mcpdb`
  - Username: `sa`
  - Password: (ç©ºç™½)

---

## ğŸš€ æ¸¬è©¦é€²éšåŠŸèƒ½

### æ¸¬è©¦ Prompts

ä½¿ç”¨ MCP Client èª¿ç”¨æç¤ºï¼š

```java
// èª¿ç”¨ç°¡å–®å•å€™æç¤º
McpSchema.GetPromptRequest request = new McpSchema.GetPromptRequest(
    "greeting",
    Map.of("name", "Alice")
);
McpSchema.GetPromptResult result = mcpClient.getPrompt(request);

// èª¿ç”¨å€‹æ€§åŒ–è¨Šæ¯
request = new McpSchema.GetPromptRequest(
    "personalized-message",
    Map.of("name", "Bob", "age", 25, "interests", "programming")
);
result = mcpClient.getPrompt(request);
```

---

### æ¸¬è©¦ Completions

```java
// æ¸¬è©¦ URI è£œå…¨
McpSchema.CompleteRequest completeRequest = new McpSchema.CompleteRequest(
    new McpSchema.ResourceReference("user-profile://a"),
    new McpSchema.CompleteArgument("username", "a")
);
McpSchema.CompleteResult completions = mcpClient.complete(completeRequest);

// çµæœ: ["alice", "andrew", "amanda"]
```

---

## ğŸ“Š é‡é»å›é¡§

### åŠŸèƒ½å°ç…§è¡¨

| åŠŸèƒ½ | è¨»è§£ | ç”¨é€” | é‡è¦æ€§ |
|------|------|------|--------|
| **æ™ºèƒ½æç¤º** | `@McpPrompt` | å¯é‡ç”¨æç¤ºæ¨¡æ¿ | â­â­â­â­â­ |
| **è‡ªå‹•å®Œæˆ** | `@McpComplete` | URI å’Œåƒæ•¸è£œå…¨ | â­â­â­â­ |
| **Logging é€šçŸ¥** | `exchange.loggingNotification` | æ—¥èªŒç™¼é€ | â­â­â­ |
| **Progress é€šçŸ¥** | `exchange.progressNotification` | é€²åº¦æ›´æ–° | â­â­â­ |
| **Sampling** | `exchange.createMessage` | è«‹æ±‚ LLM ç”Ÿæˆ | â­â­â­â­ |
| **è³‡æ–™åº«æ•´åˆ** | JPA + H2 | å‹•æ…‹ç®¡ç† | â­â­â­â­ |

---

### é€²éšç‰¹æ€§æµç¨‹

```mermaid
graph LR
    A[å®šç¾© @McpPrompt æ–¹æ³•] --> B[æä¾›åƒæ•¸ @McpArg]
    B --> C[å›å‚³ GetPromptResult]

    D[å®šç¾© @McpComplete æ–¹æ³•] --> E[æŒ‡å®š URI æˆ– Prompt]
    E --> F[å›å‚³è£œå…¨æ¸…å–®]

    G[ä½¿ç”¨ McpSyncServerExchange] --> H[ç™¼é€ Logging é€šçŸ¥]
    G --> I[ç™¼é€ Progress é€šçŸ¥]
    G --> J[è«‹æ±‚ Sampling]

    K[JPA Repository] --> L[å‹•æ…‹è¼‰å…¥æç¤º]
    K --> M[å‹•æ…‹è¼‰å…¥è£œå…¨æ•¸æ“š]

    style A fill:#e8f5e9
    style D fill:#fff4e6
    style G fill:#e1f5ff
    style K fill:#f3e5f5
```

---

### æœ€ä½³å¯¦è¸

1. **æç¤ºè¨­è¨ˆ**
   - æ¸…æ™°çš„åƒæ•¸æè¿°ï¼ˆ`@McpArg description`ï¼‰
   - åˆç†çš„é è¨­å€¼è™•ç†
   - æ”¯æ´å¯é¸åƒæ•¸å¢å¼·éˆæ´»æ€§

2. **è£œå…¨å„ªåŒ–**
   - ä½¿ç”¨å¿«å–æ¸›å°‘è³‡æ–™åº«æŸ¥è©¢
   - é™åˆ¶å›å‚³æ•¸é‡ï¼ˆé¿å…éè¼‰ï¼‰
   - æŒ‰éœ€è¼‰å…¥ï¼ˆlazy loadingï¼‰

3. **é€šçŸ¥ä½¿ç”¨**
   - é©ç•¶çš„æ—¥èªŒç´šåˆ¥ï¼ˆé¿å…éå¤š DEBUGï¼‰
   - é•·æ™‚é–“ä»»å‹™å¿…é ˆç™¼é€é€²åº¦
   - Sampling è«‹æ±‚è¦è¨­å®šåˆç†çš„ token é™åˆ¶

4. **è³‡æ–™åº«ç®¡ç†**
   - ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨æŒä¹…åŒ–è³‡æ–™åº«
   - å®šæœŸå‚™ä»½æç¤ºæ¨¡æ¿
   - ç‰ˆæœ¬æ§åˆ¶æç¤ºå…§å®¹è®Šæ›´

---

## ğŸ”— èˆ‡å…¶ä»–ç« ç¯€æ•´åˆ

### èˆ‡ 9.3 çš„é—œä¿‚

| ç« ç¯€ | åŠŸèƒ½å±¤ç´š | é©ç”¨å ´æ™¯ |
|------|----------|----------|
| **9.3 åŸºç¤å·¥å…·** | @Tool è¨»è§£ | ç°¡å–®åŠŸèƒ½èª¿ç”¨ |
| **9.4 é€²éšç‰¹æ€§** | @McpPrompt + @McpComplete | è¤‡é›œäº’å‹•å ´æ™¯ |

**æ•´åˆç¯„ä¾‹**:

```java
// çµåˆ @Tool å’Œ @McpPrompt
@Service
public class EnhancedService {

    // åŸºç¤å·¥å…·ï¼ˆ9.3ï¼‰
    @Tool(description = "Search documents")
    public String searchDocuments(String query) {
        return performSearch(query);
    }

    // é€²éšæç¤ºï¼ˆ9.4ï¼‰
    @McpPrompt(name = "search-guide", description = "Guide for effective searching")
    public McpSchema.GetPromptResult searchGuide(
            @McpArg(name = "domain") String domain) {

        return new McpSchema.GetPromptResult(
            "Search Guide",
            List.of(new McpSchema.PromptMessage(
                McpSchema.Role.ASSISTANT,
                new McpSchema.TextContent(
                    "To search effectively in " + domain + ", consider..."
                )
            ))
        );
    }
}
```

---

## ğŸŒŸ ä¼æ¥­æ‡‰ç”¨å ´æ™¯

### å ´æ™¯ 1: æ™ºèƒ½å®¢æœæç¤ºç³»çµ±

```java
@McpPrompt(name = "customer-service", description = "Customer service response template")
public McpSchema.GetPromptResult customerServicePrompt(
        @McpArg(name = "issue_type", required = true) String issueType,
        @McpArg(name = "customer_level", required = false) String customerLevel) {

    // å¾è³‡æ–™åº«è¼‰å…¥å°æ‡‰å•é¡Œé¡å‹çš„å›æ‡‰æ¨¡æ¿
    String template = loadTemplateByIssueType(issueType);

    // æ ¹æ“šå®¢æˆ¶ç­‰ç´šèª¿æ•´èªæ°£
    if ("VIP".equals(customerLevel)) {
        template = enhanceForVIP(template);
    }

    return buildPromptResult(template);
}
```

---

### å ´æ™¯ 2: ç¨‹å¼ç¢¼å¯©æŸ¥åŠ©æ‰‹

```java
@McpPrompt(name = "code-review", description = "Code review assistant")
public McpSchema.GetPromptResult codeReviewPrompt(
        @McpArg(name = "language", required = true) String language,
        @McpArg(name = "code", required = true) String code,
        @McpArg(name = "focus", required = false) String focus) {

    String systemMessage = "You are an expert code reviewer for " + language;
    String userMessage = "Please review this code";

    if (focus != null) {
        userMessage += " focusing on " + focus;
    }

    userMessage += ":\n\n" + code;

    return new McpSchema.GetPromptResult("Code Review", List.of(
        new McpSchema.PromptMessage(McpSchema.Role.SYSTEM, new McpSchema.TextContent(systemMessage)),
        new McpSchema.PromptMessage(McpSchema.Role.USER, new McpSchema.TextContent(userMessage))
    ));
}
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

æ­å–œï¼ä½ å·²ç¶“å®Œæˆäº†ç¬¬9ç« çš„æ‰€æœ‰å…§å®¹ï¼ŒæŒæ¡äº†å¾åŸºç¤åˆ°é€²éšçš„å®Œæ•´ MCP é–‹ç™¼æŠ€èƒ½ã€‚

**æ¥ä¸‹ä¾†å¯ä»¥**:
1. æ•´åˆå‰é¢ç« ç¯€çš„ RAGã€Memory åŠŸèƒ½åˆ° MCP Server
2. éƒ¨ç½² MCP Server åˆ°ç”Ÿç”¢ç’°å¢ƒ
3. é–‹ç™¼è‡ªå·±çš„ MCP å·¥å…·ç”Ÿæ…‹ç³»çµ±
4. è²¢ç»åˆ° Spring AI ç¤¾ç¾¤

---

## ğŸ“š åƒè€ƒè³‡æº

### å®˜æ–¹æ–‡æª”
- [Spring AI MCP Documentation](https://docs.spring.io/spring-ai/reference/api/mcp/)
- [MCP Prompts Specification](https://spec.modelcontextprotocol.io/specification/basic/prompts/)
- [MCP Completions Specification](https://spec.modelcontextprotocol.io/specification/basic/completions/)

### ç¯„ä¾‹å°ˆæ¡ˆ
- [æœ¬ç« ç¯„ä¾‹: chapter9-mcp-server-advanced](../../code-examples/chapter9-mcp-integration/chapter9-mcp-server-advanced/)
- [Spring AI Examples - MCP Annotations](https://github.com/spring-projects/spring-ai-examples/tree/main/model-context-protocol/mcp-annotations)

---

**ç›¸é—œç« ç¯€**:
- â† ä¸Šä¸€ç« : [9.3 MCP Server å·¥å…·é–‹ç™¼](./9.3-MCP-Server-å·¥å…·é–‹ç™¼.md)
- â† å›åˆ°: [ç¬¬9ç« ç¸½è¦½](./README.md)
