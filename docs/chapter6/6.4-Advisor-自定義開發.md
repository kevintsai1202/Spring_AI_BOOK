# 6.4 Advisor è‡ªå®šç¾©é–‹ç™¼

> **å°æ‡‰ç« ç¯€**: Day19, Day20
> **å°æ‡‰ç¯„ä¾‹**: `chapter6-memory-core`
> **é›£åº¦**: â­â­â­â­â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

Advisor æ˜¯ Spring AI çš„æ’ä»¶ç³»çµ±,æ¡ç”¨è²¬ä»»éˆæ¨¡å¼è®“é–‹ç™¼è€…èƒ½å¤ åœ¨ AI èª¿ç”¨å‰å¾Œæ’å…¥è‡ªå®šç¾©é‚è¼¯ã€‚æœ¬ç« å°‡æ·±å…¥æ¢è¨å¦‚ä½•é–‹ç™¼è‡ªå·±çš„ Advisorã€‚

**å­¸ç¿’ç›®æ¨™**:
- ç†è§£ Advisor è²¬ä»»éˆæ¨¡å¼
- æŒæ¡ CallAdvisor å’Œ StreamAdvisor çš„å·®ç•°
- å­¸æœƒé–‹ç™¼è‡ªå®šç¾© Advisor
- äº†è§£ Advisor åŸ·è¡Œé †åºæ§åˆ¶

---

## ğŸ¯ ä»€éº¼æ˜¯ Advisor?

### AOP åœ¨ AI é ˜åŸŸçš„æ‡‰ç”¨

```mermaid
graph LR
    A[ç”¨æˆ¶è«‹æ±‚] --> B[Security Advisor]
    B --> C[Logging Advisor]
    C --> D[Memory Advisor]
    D --> E[Content Filter]
    E --> F[LLM èª¿ç”¨]
    F --> G[Response Processing]
    G --> H[è¿”å›çµæœ]

    style A fill:#e1f5ff
    style F fill:#f3e5f5
    style H fill:#e8f5e9
```

Advisor å°±åƒ Spring AOP,å¯ä»¥åœ¨ä¸ä¿®æ”¹æ¥­å‹™ä»£ç¢¼çš„æƒ…æ³ä¸‹å¢å¼·åŠŸèƒ½:
- ğŸ”’ **å®‰å…¨æª¢æŸ¥**: éæ¿¾æ•æ„Ÿè©
- ğŸ“ **æ—¥èªŒè¨˜éŒ„**: è¨˜éŒ„è«‹æ±‚å’Œå›æ‡‰
- ğŸ’¾ **è¨˜æ†¶ç®¡ç†**: è‡ªå‹•è¼‰å…¥å°è©±æ­·å²
- ğŸ“Š **ç›£æ§çµ±è¨ˆ**: Token ä½¿ç”¨é‡è¿½è¹¤

---

## ğŸ†• Spring AI 1.0+ æ–°ç‰ˆ API

### æ ¸å¿ƒä»‹é¢

```java
// åŸºç¤ä»‹é¢
public interface Advisor extends Ordered {
    String getName();     // Advisor åç¨±
    int getOrder();       // åŸ·è¡Œé †åº
}

// éä¸²æµå ´æ™¯
public interface CallAdvisor extends Advisor {
    ChatClientResponse adviseCall(
        ChatClientRequest request,
        CallAdvisorChain chain
    );
}

// ä¸²æµå ´æ™¯
public interface StreamAdvisor extends Advisor {
    Flux<ChatClientResponse> adviseStream(
        ChatClientRequest request,
        StreamAdvisorChain chain
    );
}
```

### æ–°èˆŠ API å°æ¯”

| é …ç›® | èˆŠç‰ˆ API (å·²å»¢æ£„) | æ–°ç‰ˆ API (ç•¶å‰) |
|------|------------------|----------------|
| ä»‹é¢ | RequestResponseAdvisor | CallAdvisor / StreamAdvisor |
| è«‹æ±‚ç‰©ä»¶ | AdvisedRequest | ChatClientRequest |
| å›æ‡‰ç‰©ä»¶ | ChatResponse | ChatClientResponse |
| ä¸Šä¸‹æ–‡ | Map<String, Object> | adviseContext() |
| éˆè™•ç† | éš±å¼ | æ˜ç¢ºçš„ chain.nextCall() |

---

## ğŸ’» å¯¦æˆ°: TokenUsageLogAdvisor

### éœ€æ±‚åˆ†æ

æˆ‘å€‘è¦é–‹ç™¼ä¸€å€‹ Advisor ä¾†:
1. è¨˜éŒ„æ¯æ¬¡å°è©±çš„è¼¸å…¥è¼¸å‡º
2. çµ±è¨ˆ Token ä½¿ç”¨é‡
3. åŒæ™‚æ”¯æ´ä¸²æµå’Œéä¸²æµ

### å®Œæ•´å¯¦ç¾

```java
// å°æ‡‰ç¯„ä¾‹: chapter6-memory-core/.../advisor/LoggingAdvisor.java (æ¦‚å¿µ)

@Slf4j
public class TokenUsageLogAdvisor implements CallAdvisor, StreamAdvisor {

    @Override
    public String getName() {
        return "TokenUsageLogAdvisor";
    }

    @Override
    public int getOrder() {
        return 0; // æ•¸å€¼è¶Šå°è¶Šå…ˆåŸ·è¡Œ
    }

    /**
     * è™•ç†éä¸²æµèª¿ç”¨
     */
    @Override
    public ChatClientResponse adviseCall(
            ChatClientRequest request,
            CallAdvisorChain chain) {

        // èª¿ç”¨å‰: è¨˜éŒ„è«‹æ±‚
        String conversationId = (String) request.adviseContext()
            .get("conversationId");
        String userMessage = request.userText();

        log.info("=== Request Start ===");
        log.info("Conversation: {}", conversationId);
        log.info("User Message: {}", userMessage);

        // èª¿ç”¨ LLM
        long startTime = System.currentTimeMillis();
        ChatClientResponse response = chain.nextCall(request);
        long duration = System.currentTimeMillis() - startTime;

        // èª¿ç”¨å¾Œ: è¨˜éŒ„å›æ‡‰å’Œ Token ä½¿ç”¨
        String aiMessage = response.chatResponse()
            .getResult()
            .getOutput()
            .getContent();

        log.info("AI Response: {}", aiMessage);
        log.info("Duration: {}ms", duration);

        // è¨˜éŒ„ Token ä½¿ç”¨é‡
        Usage usage = response.chatResponse()
            .getMetadata()
            .getUsage();

        if (usage != null) {
            log.info("Token Usage:");
            log.info("  - Prompt: {}", usage.getPromptTokens());
            log.info("  - Generation: {}", usage.getGenerationTokens());
            log.info("  - Total: {}", usage.getTotalTokens());
        }

        log.info("=== Request End ===");

        return response;
    }

    /**
     * è™•ç†ä¸²æµèª¿ç”¨
     */
    @Override
    public Flux<ChatClientResponse> adviseStream(
            ChatClientRequest request,
            StreamAdvisorChain chain) {

        String conversationId = (String) request.adviseContext()
            .get("conversationId");

        log.info("=== Stream Start === Conversation: {}", conversationId);

        return chain.nextStream(request)
            .doOnNext(response -> {
                // æ¯å€‹ä¸²æµç‰‡æ®µéƒ½å¯ä»¥è™•ç†
                String chunk = response.chatResponse()
                    .getResult()
                    .getOutput()
                    .getContent();
                log.debug("Stream chunk: {}", chunk);
            })
            .doOnComplete(() -> {
                log.info("=== Stream Complete === Conversation: {}",
                    conversationId);
            })
            .doOnError(error -> {
                log.error("Stream error: {}", error.getMessage());
            });
    }
}
```

### ä½¿ç”¨æ–¹å¼

**æ–¹å¼1: åŸ·è¡Œæ™‚æ·»åŠ **
```java
@Service
public class ChatService {

    @Autowired
    private ChatClient chatClient;

    public String chat(String conversationId, String message) {
        return chatClient.prompt()
            .advisors(
                new TokenUsageLogAdvisor(),  // è‡ªå®šç¾© Advisor
                MessageChatMemoryAdvisor.builder(chatMemory).build()
            )
            .advisors(a -> a.param("conversationId", conversationId))
            .user(message)
            .call()
            .content();
    }
}
```

**æ–¹å¼2: å»ºæ§‹æ™‚é è¨­** (æ¨è–¦)
```java
@Configuration
public class ChatConfig {

    @Bean
    public ChatClient chatClient(ChatModel chatModel) {
        return ChatClient.builder(chatModel)
            .defaultAdvisors(
                new TokenUsageLogAdvisor(),
                MessageChatMemoryAdvisor.builder(chatMemory).build()
            )
            .build();
    }
}
```

---

## ğŸ”¢ Advisor åŸ·è¡Œé †åº

### Order å€¼çš„æ„ç¾©

```java
public class AdvisorOrderExample {

    // Order å€¼è¶Šå°è¶Šå…ˆåŸ·è¡Œ
    public static final int SECURITY = Ordered.HIGHEST_PRECEDENCE;      // -2147483648
    public static final int LOGGING = Ordered.HIGHEST_PRECEDENCE + 100; // -2147483548
    public static final int MEMORY = 0;                                  // 0
    public static final int RAG = 100;                                   // 100
    public static final int FILTER = Ordered.LOWEST_PRECEDENCE;          // 2147483647
}
```

### åŸ·è¡Œæµç¨‹

```mermaid
graph TD
    A[Request] --> B[SecurityAdvisor -2147483648]
    B --> C[LoggingAdvisor -2147483548]
    C --> D[MemoryAdvisor 0]
    D --> E[RAGAdvisor 100]
    E --> F[LLM Call]
    F --> G[RAGAdvisor è™•ç†å›æ‡‰]
    G --> H[MemoryAdvisor å„²å­˜]
    H --> I[LoggingAdvisor è¨˜éŒ„]
    I --> J[SecurityAdvisor éæ¿¾]
    J --> K[Response]

    style A fill:#e1f5ff
    style F fill:#f3e5f5
    style K fill:#e8f5e9
```

### é…ç½®ç¯„ä¾‹

```java
@Bean
public ChatClient enterpriseChatClient(ChatModel chatModel) {
    return ChatClient.builder(chatModel)
        .defaultAdvisors(
            // é †åº1: å®‰å…¨æª¢æŸ¥
            new SecurityAdvisor() {
                @Override
                public int getOrder() {
                    return Ordered.HIGHEST_PRECEDENCE;
                }
            },
            // é †åº2: æ—¥èªŒè¨˜éŒ„
            new TokenUsageLogAdvisor() {
                @Override
                public int getOrder() {
                    return Ordered.HIGHEST_PRECEDENCE + 100;
                }
            },
            // é †åº3: è¨˜æ†¶è¼‰å…¥
            MessageChatMemoryAdvisor.builder(chatMemory)
                .order(0)
                .build(),
            // é †åº4: RAG æª¢ç´¢
            QuestionAnswerAdvisor.builder(vectorStore)
                .order(100)
                .build()
        )
        .build();
}
```

---

## ğŸ¬ é€²éšç¯„ä¾‹

### 1. å…§å®¹éæ¿¾ Advisor

```java
public class ContentFilterAdvisor implements CallAdvisor, StreamAdvisor {

    private final List<String> bannedWords = List.of("æ•æ„Ÿè©1", "æ•æ„Ÿè©2");

    @Override
    public ChatClientResponse adviseCall(
            ChatClientRequest request,
            CallAdvisorChain chain) {

        String userMessage = request.userText();

        // æª¢æŸ¥æ•æ„Ÿè©
        if (containsBannedWords(userMessage)) {
            throw new IllegalArgumentException("å…§å®¹åŒ…å«æ•æ„Ÿè©");
        }

        // ç¹¼çºŒéˆ
        ChatClientResponse response = chain.nextCall(request);

        // æª¢æŸ¥å›æ‡‰
        String aiResponse = response.chatResponse()
            .getResult()
            .getOutput()
            .getContent();

        if (containsBannedWords(aiResponse)) {
            // æ›¿æ›æ•æ„Ÿå…§å®¹
            String filtered = filterContent(aiResponse);
            // å‰µå»ºæ–°çš„å›æ‡‰ (ç°¡åŒ–ç¤ºæ„)
            return response; // å¯¦éš›éœ€è¦æ§‹é€ æ–°çš„ ChatClientResponse
        }

        return response;
    }

    private boolean containsBannedWords(String text) {
        return bannedWords.stream()
            .anyMatch(word -> text.contains(word));
    }

    @Override
    public String getName() {
        return "ContentFilterAdvisor";
    }

    @Override
    public int getOrder() {
        return Ordered.HIGHEST_PRECEDENCE; // æœ€é«˜å„ªå…ˆç´š
    }
}
```

### 2. è²»ç”¨è¿½è¹¤ Advisor

```java
@Component
public class CostTrackingAdvisor implements CallAdvisor {

    @Autowired
    private MeterRegistry meterRegistry;

    private final Counter requestCounter;
    private final Timer responseTimer;

    public CostTrackingAdvisor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.requestCounter = Counter.builder("ai.requests")
            .description("Total AI requests")
            .register(meterRegistry);

        this.responseTimer = Timer.builder("ai.response.time")
            .description("AI response time")
            .register(meterRegistry);
    }

    @Override
    public ChatClientResponse adviseCall(
            ChatClientRequest request,
            CallAdvisorChain chain) {

        requestCounter.increment();

        Timer.Sample sample = Timer.start(meterRegistry);
        ChatClientResponse response = chain.nextCall(request);
        sample.stop(responseTimer);

        // è¨˜éŒ„ Token æˆæœ¬
        Usage usage = response.chatResponse().getMetadata().getUsage();
        if (usage != null) {
            Gauge.builder("ai.tokens.total", usage, Usage::getTotalTokens)
                .register(meterRegistry);
        }

        return response;
    }

    @Override
    public String getName() {
        return "CostTrackingAdvisor";
    }

    @Override
    public int getOrder() {
        return 1000;
    }
}
```

### 3. å¿«å– Advisor

```java
@Component
public class CacheAdvisor implements CallAdvisor {

    private final Map<String, ChatClientResponse> cache
        = new ConcurrentHashMap<>();

    @Override
    public ChatClientResponse adviseCall(
            ChatClientRequest request,
            CallAdvisorChain chain) {

        String cacheKey = generateCacheKey(request);

        // æª¢æŸ¥å¿«å–
        if (cache.containsKey(cacheKey)) {
            log.info("Cache hit for key: {}", cacheKey);
            return cache.get(cacheKey);
        }

        // èª¿ç”¨ LLM
        ChatClientResponse response = chain.nextCall(request);

        // å„²å­˜åˆ°å¿«å–
        cache.put(cacheKey, response);

        return response;
    }

    private String generateCacheKey(ChatClientRequest request) {
        return request.userText().hashCode() + "";
    }

    @Override
    public String getName() {
        return "CacheAdvisor";
    }

    @Override
    public int getOrder() {
        return -100; // åœ¨è¨˜æ†¶è¼‰å…¥ä¹‹å‰
    }
}
```

---

## ğŸ“ é‡é»å›é¡§

### Advisor æ ¸å¿ƒæ¦‚å¿µ
âœ… æ¡ç”¨è²¬ä»»éˆæ¨¡å¼,å¯ä¸²æ¥å¤šå€‹ Advisor
âœ… åˆ†ç‚º CallAdvisor (éä¸²æµ) å’Œ StreamAdvisor (ä¸²æµ)
âœ… é€é Order æ§åˆ¶åŸ·è¡Œé †åº

### é–‹ç™¼è¦é»
1. **å¯¦ç¾ä»‹é¢**: CallAdvisor å’Œ/æˆ– StreamAdvisor
2. **è¨­å®šé †åº**: é€é getOrder() æ–¹æ³•
3. **å‘¼å«éˆ**: ä½¿ç”¨ chain.nextCall() ç¹¼çºŒåŸ·è¡Œ
4. **ä¸Šä¸‹æ–‡**: é€é adviseContext å…±äº«è³‡æ–™

### å¸¸è¦‹æ‡‰ç”¨
- ğŸ”’ å®‰å…¨éæ¿¾
- ğŸ“ æ—¥èªŒè¨˜éŒ„
- ğŸ’° æˆæœ¬è¿½è¹¤
- ğŸ—„ï¸ å¿«å–æ©Ÿåˆ¶
- ğŸ“Š ç›£æ§çµ±è¨ˆ

---

## ğŸš€ ä¸‹ä¸€æ­¥

ğŸ‘‰ [6.5 å‘é‡è³‡æ–™åº«é¸æ“‡æŒ‡å—](./6.5-å‘é‡è³‡æ–™åº«é¸æ“‡æŒ‡å—.md) - RAG åŸºç¤è¨­æ–½
ğŸ‘‰ [6.8 æ™ºèƒ½è¨˜æ†¶æ‘˜è¦ç³»çµ±](./6.8-æ™ºèƒ½è¨˜æ†¶æ‘˜è¦ç³»çµ±.md) - é€²éš Advisor æ‡‰ç”¨

---

**ç›¸é—œç« ç¯€**:
- â† ä¸Šä¸€ç« : [6.3 ChatMemory çŸ­æœŸè¨˜æ†¶ç³»çµ±](./6.3-ChatMemory-çŸ­æœŸè¨˜æ†¶ç³»çµ±.md)
- â†’ ä¸‹ä¸€ç« : [6.5 å‘é‡è³‡æ–™åº«é¸æ“‡æŒ‡å—](./6.5-å‘é‡è³‡æ–™åº«é¸æ“‡æŒ‡å—.md)
