# 6.6 Neo4j é…ç½®èˆ‡éƒ¨ç½²

> **å°æ‡‰ç« ç¯€**: Day21, Day22
> **å°æ‡‰ç¯„ä¾‹**: `chapter6-memory-vector`
> **é›£åº¦**: â­â­â­â˜†â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

Neo4j æ˜¯ä¸€å€‹å¼·å¤§çš„åœ–å½¢è³‡æ–™åº«,å¾ 5.x ç‰ˆæœ¬é–‹å§‹æ”¯æ´å‘é‡æœå°‹åŠŸèƒ½,éå¸¸é©åˆç”¨æ–¼çŸ¥è­˜åœ–è­œå’Œ AI è¨˜æ†¶ç³»çµ±ã€‚

**å­¸ç¿’ç›®æ¨™**:
- äº†è§£ Neo4j å‘é‡æœå°‹åŠŸèƒ½
- æŒæ¡ Docker éƒ¨ç½² Neo4j
- å­¸æœƒé…ç½®å‘é‡ç´¢å¼•
- äº†è§£æ•ˆèƒ½å„ªåŒ–æŠ€å·§

---

## ğŸ¯ ç‚ºä»€éº¼é¸æ“‡ Neo4j?

### Neo4j çš„å„ªå‹¢

```mermaid
graph LR
    A[Neo4j] --> B[åœ–å½¢è³‡æ–™åº«]
    A --> C[å‘é‡æœå°‹]
    A --> D[é—œä¿‚æŸ¥è©¢]

    B --> E[çŸ¥è­˜åœ–è­œ]
    C --> F[èªç¾©æœå°‹]
    D --> G[é—œè¯æ¨è–¦]

    style A fill:#e1f5ff
    style E fill:#e8f5e9
    style F fill:#fff4e6
    style G fill:#f3e5f5
```

**æ ¸å¿ƒå„ªå‹¢**:
- âœ… **åœ–è­œ + å‘é‡**: æ—¢èƒ½è¡¨ç¤ºé—œä¿‚,åˆèƒ½åšèªç¾©æœå°‹
- âœ… **çµ±ä¸€å„²å­˜**: ä¸éœ€è¦å¤šå€‹è³‡æ–™åº«
- âœ… **å¼·å¤§æŸ¥è©¢**: Cypher èªè¨€éˆæ´»å¼·å¤§
- âœ… **ä¼æ¥­ç´š**: æˆç†Ÿç©©å®š,å»£æ³›æ‡‰ç”¨

---

## ğŸ³ Docker éƒ¨ç½²

### åŸºæœ¬éƒ¨ç½²

```yaml
# docker-compose.yml
version: '3.8'

services:
  neo4j:
    image: neo4j:5.13-community
    container_name: neo4j-vector
    ports:
      - "7474:7474"  # HTTP (ç€è¦½å™¨ä»‹é¢)
      - "7687:7687"  # Bolt (æ‡‰ç”¨é€£ç·š)
    environment:
      # èªè­‰è¨­å®š
      NEO4J_AUTH: neo4j/your-password

      # è¨˜æ†¶é«”è¨­å®š
      NEO4J_dbms_memory_heap_initial__size: 512m
      NEO4J_dbms_memory_heap_max__size: 2G
      NEO4J_dbms_memory_pagecache_size: 1G

      # å•Ÿç”¨ APOC æ’ä»¶
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_apoc_export_file_enabled: 'true'
      NEO4J_apoc_import_file_enabled: 'true'

    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import

    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "your-password", "RETURN 1"]
      interval: 30s
      timeout: 10s
      retries: 5

volumes:
  neo4j_data:
  neo4j_logs:
  neo4j_import:
```

### å•Ÿå‹•èˆ‡é©—è­‰

```bash
# å•Ÿå‹•æœå‹™
docker-compose up -d neo4j

# æª¢æŸ¥ç‹€æ…‹
docker-compose ps
docker-compose logs -f neo4j

# ç­‰å¾…å•Ÿå‹•å®Œæˆ (ç´„ 30 ç§’)
sleep 30

# è¨ªå• Web ä»‹é¢
open http://localhost:7474
# ç™»å…¥: neo4j / your-password
```

---

## ğŸ”§ å‘é‡ç´¢å¼•é…ç½®

### å‰µå»ºå‘é‡ç´¢å¼•

```cypher
-- å‰µå»ºå‘é‡ç´¢å¼•
CREATE VECTOR INDEX documentEmbeddings IF NOT EXISTS
FOR (d:Document)
ON (d.embedding)
OPTIONS {
  indexConfig: {
    `vector.dimensions`: 1536,
    `vector.similarity_function`: 'cosine'
  }
};

-- æŸ¥çœ‹ç´¢å¼•ç‹€æ…‹
SHOW INDEXES;

-- ç­‰å¾…ç´¢å¼•å»ºç«‹å®Œæˆ
CALL db.awaitIndexes();
```

### ç›¸ä¼¼åº¦å‡½æ•¸é¸æ“‡

```cypher
-- Cosine ç›¸ä¼¼åº¦ (æ¨è–¦)
OPTIONS { `vector.similarity_function`: 'cosine' }

-- æ­æ°è·é›¢
OPTIONS { `vector.similarity_function`: 'euclidean' }
```

**é¸æ“‡å»ºè­°**:
- âœ… **Cosine**: é©åˆå¤§å¤šæ•¸å ´æ™¯,ä¸å—å‘é‡é•·åº¦å½±éŸ¿
- âš ï¸ **Euclidean**: é©åˆçµ•å°è·é›¢æœ‰æ„ç¾©çš„å ´æ™¯

---

## ğŸ’» Spring AI é…ç½®

### application.yml

```yaml
spring:
  neo4j:
    uri: bolt://localhost:7687
    authentication:
      username: neo4j
      password: your-password

  ai:
    vectorstore:
      neo4j:
        # å‘é‡ç´¢å¼•åç¨±
        index-name: documentEmbeddings
        # æ¨™ç±¤åç¨±
        label: Document
        # åµŒå…¥å±¬æ€§åç¨±
        embedding-property: embedding
        # å‘é‡ç¶­åº¦
        dimensions: 1536
        # ç›¸ä¼¼åº¦å‡½æ•¸
        distance-type: COSINE
```

### Java é…ç½®

```java
@Configuration
public class Neo4jVectorStoreConfig {

    @Bean
    public VectorStore neo4jVectorStore(
            Driver neo4jDriver,
            EmbeddingModel embeddingModel) {

        return Neo4jVectorStore.builder()
            .driver(neo4jDriver)
            .embeddingModel(embeddingModel)
            .indexName("documentEmbeddings")
            .label("Document")
            .embeddingProperty("embedding")
            .dimensions(1536)
            .distanceType(Neo4jVectorStore.Neo4jDistanceType.COSINE)
            .initializeSchema(true)  // è‡ªå‹•å‰µå»ºç´¢å¼•
            .build();
    }
}
```

---

## ğŸ“Š è³‡æ–™æ“ä½œ

### æ–°å¢æ–‡æª”

```java
@Service
public class DocumentService {

    @Autowired
    private VectorStore vectorStore;

    public void addDocuments(List<String> texts) {
        List<Document> documents = texts.stream()
            .map(text -> new Document(
                text,
                Map.of(
                    "source", "knowledge-base",
                    "timestamp", LocalDateTime.now().toString()
                )
            ))
            .collect(Collectors.toList());

        vectorStore.add(documents);
    }
}
```

**å°æ‡‰çš„ Cypher æŸ¥è©¢**:
```cypher
-- Spring AI è‡ªå‹•åŸ·è¡Œçš„æ“ä½œ
CREATE (d:Document {
  id: randomUUID(),
  content: $content,
  embedding: $embedding,
  source: $source,
  timestamp: $timestamp
})
```

### èªç¾©æœå°‹

```java
public List<Document> search(String query, int topK) {
    return vectorStore.similaritySearch(
        SearchRequest.query(query)
            .withTopK(topK)
            .withSimilarityThreshold(0.75)
    );
}
```

**å°æ‡‰çš„ Cypher æŸ¥è©¢**:
```cypher
-- å‘é‡ç›¸ä¼¼åº¦æœå°‹
CALL db.index.vector.queryNodes(
  'documentEmbeddings',
  $topK,
  $queryEmbedding
)
YIELD node, score
WHERE score >= $threshold
RETURN node.content, score
ORDER BY score DESC
```

---

## ğŸ¯ æ•ˆèƒ½å„ªåŒ–

### 1. è¨˜æ†¶é«”é…ç½®

```yaml
# docker-compose.yml
environment:
  # Heap è¨˜æ†¶é«” (ç”¨æ–¼æŸ¥è©¢è™•ç†)
  NEO4J_dbms_memory_heap_initial__size: 2G
  NEO4J_dbms_memory_heap_max__size: 4G

  # Page Cache (ç”¨æ–¼è³‡æ–™å¿«å–)
  NEO4J_dbms_memory_pagecache_size: 2G
```

**é…ç½®å»ºè­°**:
- **å°å‹** (<10è¬æ–‡æª”): Heap 2G, PageCache 1G
- **ä¸­å‹** (<100è¬): Heap 4G, PageCache 2G
- **å¤§å‹** (>100è¬): Heap 8G, PageCache 4G+

### 2. ç´¢å¼•å„ªåŒ–

```cypher
-- å‰µå»ºè¤‡åˆç´¢å¼•
CREATE INDEX document_metadata IF NOT EXISTS
FOR (d:Document)
ON (d.source, d.timestamp);

-- æª¢æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…æ³
PROFILE
MATCH (d:Document)
WHERE d.source = 'knowledge-base'
RETURN d;
```

### 3. æ‰¹æ¬¡æ“ä½œ

```java
public void addDocumentsBatch(List<String> texts) {
    // æ‰¹æ¬¡å¤§å°
    int batchSize = 100;

    for (int i = 0; i < texts.size(); i += batchSize) {
        List<String> batch = texts.subList(
            i,
            Math.min(i + batchSize, texts.size())
        );

        List<Document> docs = batch.stream()
            .map(text -> new Document(text))
            .collect(Collectors.toList());

        vectorStore.add(docs);

        // é¿å…è¨˜æ†¶é«”çˆ†ç‚¸
        if (i % 1000 == 0) {
            log.info("Processed {} documents", i);
        }
    }
}
```

---

## ğŸ” å¯¦ç”¨ Cypher æŸ¥è©¢

### è³‡æ–™çµ±è¨ˆ

```cypher
-- æ–‡æª”æ•¸é‡
MATCH (d:Document)
RETURN count(d) as totalDocuments;

-- æŒ‰ä¾†æºåˆ†çµ„çµ±è¨ˆ
MATCH (d:Document)
RETURN d.source, count(d) as count
ORDER BY count DESC;
```

### æ¸…ç†è³‡æ–™

```cypher
-- åˆªé™¤æ‰€æœ‰æ–‡æª”
MATCH (d:Document)
DELETE d;

-- åˆªé™¤ç‰¹å®šä¾†æº
MATCH (d:Document)
WHERE d.source = 'old-data'
DELETE d;
```

### å‚™ä»½èˆ‡é‚„åŸ

```bash
# å‚™ä»½
docker exec neo4j-vector neo4j-admin database dump neo4j \
  --to-path=/backups/neo4j-backup.dump

# é‚„åŸ
docker exec neo4j-vector neo4j-admin database load neo4j \
  --from-path=/backups/neo4j-backup.dump
```

---

## ğŸ› å¸¸è¦‹å•é¡Œ

### Q1: é€£ç·šå¤±æ•—

```
Error: Unable to connect to bolt://localhost:7687
```

**è§£æ±ºæ–¹æ¡ˆ**:
```bash
# æª¢æŸ¥æœå‹™ç‹€æ…‹
docker-compose ps

# æŸ¥çœ‹æ—¥èªŒ
docker-compose logs neo4j

# ç­‰å¾…æœå‹™å®Œå…¨å•Ÿå‹•
sleep 30
```

### Q2: è¨˜æ†¶é«”ä¸è¶³

```
Error: OutOfMemoryError: Java heap space
```

**è§£æ±ºæ–¹æ¡ˆ**:
```yaml
environment:
  NEO4J_dbms_memory_heap_max__size: 4G  # å¢åŠ  Heap
```

### Q3: ç´¢å¼•å»ºç«‹å¤±æ•—

```
Error: Index already exists
```

**è§£æ±ºæ–¹æ¡ˆ**:
```cypher
-- åˆªé™¤èˆŠç´¢å¼•
DROP INDEX documentEmbeddings IF EXISTS;

-- é‡æ–°å‰µå»º
CREATE VECTOR INDEX documentEmbeddings ...
```

---

## ğŸ“ é‡é»å›é¡§

### Neo4j å‘é‡æœå°‹
âœ… åœ–å½¢è³‡æ–™åº« + å‘é‡æœå°‹
âœ… çµ±ä¸€å„²å­˜,ç°¡åŒ–æ¶æ§‹
âœ… Cypher æŸ¥è©¢èªè¨€å¼·å¤§

### éƒ¨ç½²è¦é»
- Docker Compose å¿«é€Ÿéƒ¨ç½²
- è¨˜æ†¶é«”é…ç½®å¾ˆé‡è¦
- å‘é‡ç´¢å¼•éœ€æ‰‹å‹•å‰µå»º

### æ•ˆèƒ½å„ªåŒ–
1. åˆç†é…ç½® Heap å’Œ PageCache
2. ä½¿ç”¨æ‰¹æ¬¡æ“ä½œ
3. å‰µå»ºå¿…è¦çš„ç´¢å¼•

---

## ğŸš€ ä¸‹ä¸€æ­¥

ğŸ‘‰ [6.7 VectorStoreChatMemoryAdvisor](./6.7-VectorStoreChatMemoryAdvisor.md) - å‘é‡è¨˜æ†¶å¯¦æˆ°

---

**ç›¸é—œç« ç¯€**:
- â† ä¸Šä¸€ç« : [6.5 å‘é‡è³‡æ–™åº«é¸æ“‡æŒ‡å—](./6.5-å‘é‡è³‡æ–™åº«é¸æ“‡æŒ‡å—.md)
- â†’ ä¸‹ä¸€ç« : [6.7 VectorStoreChatMemoryAdvisor](./6.7-VectorStoreChatMemoryAdvisor.md)
