# 6.7 VectorStoreChatMemoryAdvisor

> **å°æ‡‰ç« ç¯€**: Day22
> **å°æ‡‰ç¯„ä¾‹**: `chapter6-memory-vector`
> **é›£åº¦**: â­â­â­â­â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

VectorStoreChatMemoryAdvisor å°‡å°è©±æ­·å²å„²å­˜åˆ°å‘é‡è³‡æ–™åº«,å¯¦ç¾é•·æœŸè¨˜æ†¶å’Œèªç¾©æœå°‹åŠŸèƒ½,è®“ AI èƒ½å¤ è¨˜ä½æ›´é•·æ™‚é–“ã€æ›´å¤šå…§å®¹çš„å°è©±ã€‚

**å­¸ç¿’ç›®æ¨™**:
- ç†è§£å‘é‡è¨˜æ†¶ vs å‚³çµ±è¨˜æ†¶çš„å·®ç•°
- æŒæ¡ VectorStoreChatMemoryAdvisor é…ç½®
- å­¸æœƒå¯¦ç¾æ··åˆè¨˜æ†¶æ¶æ§‹
- äº†è§£é©ç”¨å ´æ™¯èˆ‡é™åˆ¶

---

## ğŸ¯ å‘é‡è¨˜æ†¶ vs å‚³çµ±è¨˜æ†¶

### å‚³çµ±è¨˜æ†¶çš„é™åˆ¶

```java
// MessageChatMemoryAdvisor - å‚³çµ±çŸ­æœŸè¨˜æ†¶
âœ… ä¿ç•™å®Œæ•´å°è©±çµæ§‹
âœ… é †åºæ˜ç¢º
âŒ å®¹é‡é™åˆ¶ (é€šå¸¸ 20-50 æ¢)
âŒ ç„¡æ³•è·¨æœƒè©±æœå°‹
âŒ ç„¡èªç¾©æœå°‹
```

**å•é¡Œå ´æ™¯**:
```
ç”¨æˆ¶åœ¨ç¬¬1æ¬¡å°è©±: "æˆ‘å–œæ­¡åƒæŠ«è–©"
ç”¨æˆ¶åœ¨ç¬¬100æ¬¡å°è©±: "æ¨è–¦é©åˆæˆ‘çš„é¤å»³"

å‚³çµ±è¨˜æ†¶: ç¬¬1æ¬¡å°è©±å·²è¢«æ¸…é™¤,ç„¡æ³•æ¨è–¦æŠ«è–©é¤å»³
```

### å‘é‡è¨˜æ†¶çš„å„ªå‹¢

```java
// VectorStoreChatMemoryAdvisor - é•·æœŸè¨˜æ†¶
âœ… ç„¡å®¹é‡é™åˆ¶
âœ… èªç¾©æœå°‹
âœ… è·¨æœƒè©±è¨˜æ†¶
âŒ é †åºå¯èƒ½ä¸æº–ç¢º
```

**è§£æ±ºæ–¹æ¡ˆ**:
```
æ‰€æœ‰å°è©±éƒ½å„²å­˜åœ¨å‘é‡è³‡æ–™åº«
å•: "æ¨è–¦é©åˆæˆ‘çš„é¤å»³"
â†’ èªç¾©æœå°‹æ‰¾åˆ°: "æˆ‘å–œæ­¡åƒæŠ«è–©"
â†’ AI: "æ¨è–¦æŠ«è–©é¤å»³..."
```

---

## ğŸ’» åŸºæœ¬é…ç½®

### Spring AI é…ç½®

```java
@Configuration
public class VectorMemoryConfig {

    @Bean
    public ChatClient vectorMemoryChatClient(
            ChatClient.Builder builder,
            VectorStore vectorStore) {

        return builder
            .defaultAdvisors(
                VectorStoreChatMemoryAdvisor.builder(vectorStore)
                    .maxRetrievalSize(10)  // æª¢ç´¢æœ€å¤š10æ¢ç›¸é—œå°è©±
                    .build()
            )
            .build();
    }
}
```

### ä½¿ç”¨æ–¹å¼

```java
@Service
public class VectorMemoryService {

    @Autowired
    private ChatClient vectorMemoryChatClient;

    public String chat(String conversationId, String message) {
        return vectorMemoryChatClient.prompt()
            .advisors(a -> a.param(
                VectorStoreChatMemoryAdvisor.CONVERSATION_ID,
                conversationId
            ))
            .user(message)
            .call()
            .content();
    }
}
```

---

## ğŸ”€ æ··åˆè¨˜æ†¶æ¶æ§‹

### çŸ­æœŸ + é•·æœŸè¨˜æ†¶

æœ€ä½³å¯¦è¸æ˜¯çµåˆå…©ç¨®è¨˜æ†¶:

```mermaid
graph LR
    A[ç”¨æˆ¶å•é¡Œ] --> B[MessageChatMemoryAdvisor]
    A --> C[VectorStoreChatMemoryAdvisor]

    B --> D[æœ€è¿‘20æ¢å°è©±]
    C --> E[èªç¾©ç›¸é—œçš„10æ¢æ­·å²]

    D --> F[çµ„åˆä¸Šä¸‹æ–‡]
    E --> F
    F --> G[AI å›æ‡‰]

    style A fill:#e1f5ff
    style D fill:#e8f5e9
    style E fill:#fff4e6
    style G fill:#f3e5f5
```

### å¯¦ç¾æ–¹å¼

```java
@Configuration
public class HybridMemoryConfig {

    @Bean
    public ChatClient hybridMemoryChatClient(
            ChatClient.Builder builder,
            ChatMemory chatMemory,
            VectorStore vectorStore) {

        return builder
            .defaultAdvisors(
                // é †åº1: çŸ­æœŸè¨˜æ†¶ (æœ€è¿‘å°è©±)
                MessageChatMemoryAdvisor.builder(chatMemory)
                    .order(1)
                    .build(),

                // é †åº2: é•·æœŸè¨˜æ†¶ (èªç¾©ç›¸é—œ)
                VectorStoreChatMemoryAdvisor.builder(vectorStore)
                    .maxRetrievalSize(5)
                    .order(2)
                    .build()
            )
            .build();
    }
}
```

### é…ç½®èªªæ˜

```yaml
app:
  memory:
    # çŸ­æœŸè¨˜æ†¶
    short-term:
      enabled: true
      max-messages: 20

    # é•·æœŸè¨˜æ†¶
    long-term:
      enabled: true
      vector-store: neo4j
      max-retrieval: 10
      similarity-threshold: 0.75
```

---

## ğŸ¬ å¯¦æˆ°ç¯„ä¾‹

### 1. å®¢æˆ¶æœå‹™åŠ©æ‰‹

```java
@Service
public class CustomerSupportService {

    @Autowired
    private ChatClient hybridMemoryChatClient;

    public SupportResponse handleQuery(String customerId, String query) {
        // æ··åˆè¨˜æ†¶: æœ€è¿‘å°è©± + æ­·å²ç›¸é—œå•é¡Œ
        String response = hybridMemoryChatClient.prompt()
            .system("""
                ä½ æ˜¯å®¢æœåŠ©æ‰‹,è«‹æ ¹æ“š:
                1. æœ€è¿‘çš„å°è©±è¨˜éŒ„
                2. æ­·å²ç›¸é—œçš„æœå‹™è¨˜éŒ„
                æä¾›å°ˆæ¥­çš„å›ç­”ã€‚
                """)
            .advisors(a -> a.param(
                VectorStoreChatMemoryAdvisor.CONVERSATION_ID,
                customerId
            ))
            .user(query)
            .call()
            .content();

        return SupportResponse.builder()
            .answer(response)
            .customerId(customerId)
            .timestamp(LocalDateTime.now())
            .build();
    }
}
```

### 2. å€‹äººçŸ¥è­˜åŠ©æ‰‹

```java
@Service
public class PersonalAssistantService {

    public String askPersonalQuestion(String userId, String question) {
        return hybridMemoryChatClient.prompt()
            .system("""
                ä½ æ˜¯å€‹äººåŠ©æ‰‹,äº†è§£ç”¨æˆ¶çš„:
                - èˆˆè¶£æ„›å¥½
                - å·¥ä½œç¿’æ…£
                - å€‹äººåå¥½

                è«‹æ ¹æ“šé€™äº›è³‡è¨Šæä¾›å€‹æ€§åŒ–å»ºè­°ã€‚
                """)
            .advisors(a -> a.param(
                VectorStoreChatMemoryAdvisor.CONVERSATION_ID,
                userId
            ))
            .user(question)
            .call()
            .content();
    }
}
```

### 3. å­¸ç¿’é€²åº¦è¿½è¹¤

```java
@Service
public class LearningTrackerService {

    public String provideLearningGuidance(String studentId, String topic) {
        return hybridMemoryChatClient.prompt()
            .system("""
                ä½ æ˜¯å­¸ç¿’å°å¸«,è«‹æ ¹æ“šå­¸ç”Ÿçš„:
                1. æœ€è¿‘å­¸ç¿’çš„å…§å®¹
                2. æ­·å²å•éçš„å•é¡Œ
                3. é‡åˆ°çš„å›°é›£

                æä¾›æœ‰é‡å°æ€§çš„æŒ‡å°ã€‚
                """)
            .advisors(a -> a.param(
                VectorStoreChatMemoryAdvisor.CONVERSATION_ID,
                studentId
            ))
            .user(topic)
            .call()
            .content();
    }
}
```

---

## ğŸ”§ é€²éšé…ç½®

### è‡ªå®šç¾©è¨˜æ†¶æ¨¡æ¿

```java
@Bean
public ChatClient customTemplateChatClient(
        ChatClient.Builder builder,
        VectorStore vectorStore) {

    PromptTemplate customTemplate = new PromptTemplate("""
        {instructions}

        ã€ç›¸é—œæ­·å²è¨˜éŒ„ã€‘
        {long_term_memory}

        ã€æœ€è¿‘å°è©±ã€‘
        {short_term_memory}

        è«‹ç¶œåˆè€ƒæ…®ä»¥ä¸Šè³‡è¨Šå›ç­”å•é¡Œã€‚
        """);

    return builder
        .defaultAdvisors(
            VectorStoreChatMemoryAdvisor.builder(vectorStore)
                .promptTemplate(customTemplate)
                .build()
        )
        .build();
}
```

### ç›¸ä¼¼åº¦é–¾å€¼èª¿æ•´

```java
@Bean
public VectorStoreChatMemoryAdvisor customThresholdAdvisor(
        VectorStore vectorStore) {

    return VectorStoreChatMemoryAdvisor.builder(vectorStore)
        .maxRetrievalSize(10)
        .searchRequest(SearchRequest.defaults()
            .withSimilarityThreshold(0.80)  // æé«˜ç›¸ä¼¼åº¦è¦æ±‚
            .withTopK(10))
        .build();
}
```

---

## âš ï¸ é©ç”¨å ´æ™¯èˆ‡é™åˆ¶

### âœ… é©åˆçš„å ´æ™¯

1. **é•·æœŸå®¢æˆ¶é—œä¿‚**
   - è¨˜ä½å®¢æˆ¶åå¥½
   - è¿½è¹¤æœå‹™æ­·å²

2. **å€‹äººåŒ–æœå‹™**
   - å­¸ç¿’é€²åº¦è¿½è¹¤
   - å€‹äººçŸ¥è­˜ç®¡ç†

3. **çŸ¥è­˜åº«æ•´åˆ**
   - ä¼æ¥­FAQ
   - æŠ€è¡“æ”¯æ´

### âŒ ä¸é©åˆçš„å ´æ™¯

1. **åš´æ ¼é †åºè¦æ±‚**
   - å‘é‡æœå°‹å¯èƒ½æ‰“äº‚é †åº
   - ä½¿ç”¨ MessageChatMemoryAdvisor

2. **å³æ™‚ä¸Šä¸‹æ–‡ä¾è³´**
   - ç•¶å‰å°è©±çš„ç«‹å³å›æ‡‰
   - ä½¿ç”¨çŸ­æœŸè¨˜æ†¶

3. **ç²¾ç¢ºæŒ‡ä»¤è¨˜æ†¶**
   - éœ€è¦ç²¾ç¢ºè¨˜ä½æ¯å€‹ç´°ç¯€
   - è€ƒæ…®çµæ§‹åŒ–å„²å­˜

---

## ğŸ”„ è¨˜æ†¶åŒæ­¥æ©Ÿåˆ¶

### è‡ªå‹•åŒæ­¥

```java
@Service
public class MemorySyncService {

    @Autowired
    private ChatMemory shortTermMemory;

    @Autowired
    private VectorStore longTermMemory;

    @Scheduled(fixedDelay = 60000)  // æ¯åˆ†é˜åŒæ­¥
    public void syncMemories() {
        // ç²å–æ‰€æœ‰å°è©±ID
        Set<String> conversationIds = getActiveConversations();

        for (String id : conversationIds) {
            // ç²å–çŸ­æœŸè¨˜æ†¶
            List<Message> messages = shortTermMemory.get(id);

            // è½‰æ›ç‚ºæ–‡æª”
            List<Document> docs = messages.stream()
                .map(msg -> new Document(
                    msg.getContent(),
                    Map.of(
                        "conversationId", id,
                        "timestamp", LocalDateTime.now().toString(),
                        "type", msg.getClass().getSimpleName()
                    )
                ))
                .collect(Collectors.toList());

            // å„²å­˜åˆ°å‘é‡è³‡æ–™åº«
            longTermMemory.add(docs);
        }
    }
}
```

---

## ğŸ“ é‡é»å›é¡§

### å‘é‡è¨˜æ†¶å„ªå‹¢
âœ… ç„¡å®¹é‡é™åˆ¶,å¯å­˜å¤§é‡æ­·å²
âœ… èªç¾©æœå°‹,æ‰¾åˆ°ç›¸é—œå°è©±
âœ… è·¨æœƒè©±è¨˜æ†¶,é•·æœŸè¿½è¹¤

### æ··åˆæ¶æ§‹
- **çŸ­æœŸ**: MessageChatMemoryAdvisor
- **é•·æœŸ**: VectorStoreChatMemoryAdvisor
- **æœ€ä½³**: å…©è€…çµåˆ

### é…ç½®è¦é»
1. è¨­å®š maxRetrievalSize
2. èª¿æ•´ similarityThreshold
3. è‡ªå®šç¾©è¨˜æ†¶æ¨¡æ¿

---

## ğŸš€ ä¸‹ä¸€æ­¥

ğŸ‘‰ [6.8 æ™ºèƒ½è¨˜æ†¶æ‘˜è¦ç³»çµ±](./6.8-æ™ºèƒ½è¨˜æ†¶æ‘˜è¦ç³»çµ±.md) - é€²éšè¨˜æ†¶å„ªåŒ–

---

**ç›¸é—œç« ç¯€**:
- â† ä¸Šä¸€ç« : [6.6 Neo4j é…ç½®èˆ‡éƒ¨ç½²](./6.6-Neo4j-é…ç½®èˆ‡éƒ¨ç½².md)
- â†’ ä¸‹ä¸€ç« : [6.8 æ™ºèƒ½è¨˜æ†¶æ‘˜è¦ç³»çµ±](./6.8-æ™ºèƒ½è¨˜æ†¶æ‘˜è¦ç³»çµ±.md)
