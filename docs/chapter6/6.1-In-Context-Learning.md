# 6.1 In-Context Learning (æƒ…å¢ƒå­¸ç¿’)

> **å°æ‡‰ç« ç¯€**: Day16
> **å°æ‡‰ç¯„ä¾‹**: `chapter6-memory-core`
> **é›£åº¦**: â­â­â˜†â˜†â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

In-Context Learning (ICL) æ˜¯ç†è§£ AI è¨˜æ†¶ç³»çµ±çš„åŸºç¤ã€‚æœ¬ç« å°‡å¸¶ä½ ç†è§£ AI å¦‚ä½•åœ¨ä¸æ›´æ–°æ¨¡å‹åƒæ•¸çš„æƒ…æ³ä¸‹,é€éä¸Šä¸‹æ–‡è³‡è¨Šä¾†é©æ‡‰æ–°ä»»å‹™,ä»¥åŠå¦‚ä½•åœ¨ Spring AI ä¸­å¯¦ç¾é€™å€‹æ©Ÿåˆ¶ã€‚

**å­¸ç¿’ç›®æ¨™**:
- ç†è§£ In-Context Learning çš„æ ¸å¿ƒæ¦‚å¿µ
- æŒæ¡ä¸Šä¸‹æ–‡æ³¨å…¥çš„ä¸‰ç¨®æ–¹å¼
- å­¸æœƒä½¿ç”¨ System Message æä¾›èƒŒæ™¯çŸ¥è­˜
- äº†è§£ Spring AI 1.1 çš„æ”¹é€²

---

## ğŸ¯ ç‚ºä»€éº¼éœ€è¦ In-Context Learning?

### AI çš„ç„¡ç‹€æ…‹ç‰¹æ€§

AI æ¨¡å‹æœ¬èº«æ˜¯**ç„¡ç‹€æ…‹æ¨è«–**å¼•æ“,é€™æ„å‘³è‘—:

```
ç¬¬ä¸€æ¬¡å°è©±: "æˆ‘å«Kevin"      â†’ AI: "ä½ å¥½,Kevin!"
ç¬¬äºŒæ¬¡å°è©±: "æˆ‘å«ä»€éº¼åå­—?"   â†’ AI: "æŠ±æ­‰,æˆ‘ä¸çŸ¥é“ä½ çš„åå­—"
```

æ¯æ¬¡å°è©±éƒ½æ˜¯ç¨ç«‹çš„,AI ä¸æœƒè¨˜ä½ä¹‹å‰èªªéçš„è©±ã€‚é€™å°±åƒä¸€å€‹å¤±æ†¶ç—‡æ‚£è€…,æ¯æ¬¡è¦‹é¢éƒ½éœ€è¦é‡æ–°ä»‹ç´¹è‡ªå·±ã€‚

### In-Context Learning çš„è§£æ±ºæ–¹æ¡ˆ

In-Context Learning é€é**åœ¨æ¯æ¬¡è«‹æ±‚ä¸­æ”œå¸¶ç›¸é—œä¸Šä¸‹æ–‡**ä¾†è§£æ±ºé€™å€‹å•é¡Œ:

```
è«‹æ±‚å…§å®¹:
  ä¸Šä¸‹æ–‡: "æˆ‘å«Kevin"
  å•é¡Œ: "æˆ‘å«ä»€éº¼åå­—?"

AIå›æ‡‰: "ä½ å«Kevin"
```

---

## ğŸ” In-Context Learning æ ¸å¿ƒæ¦‚å¿µ

### ä»€éº¼æ˜¯ In-Context Learning?

In-Context Learning æœ€åˆåœ¨ GPT-3 è«–æ–‡ä¸­è¢«æå‡º,å®ƒæ˜¯ä¸€ç¨®è®“èªè¨€æ¨¡å‹æ ¹æ“šçµ¦å®šå¯¦ä¾‹ç†è§£ä»»å‹™çš„æ–¹å¼ã€‚

**æ ¸å¿ƒç‰¹é»**:

1. **ç„¡éœ€åƒæ•¸æ›´æ–°**: ä¸æ”¹è®Šæ¨¡å‹å…§éƒ¨åƒæ•¸,ç›´æ¥åˆ©ç”¨å·²æœ‰çŸ¥è­˜
2. **ä¸Šä¸‹æ–‡ç†è§£**: ç†è§£è¼¸å…¥çš„ä¸Šä¸‹æ–‡(è©å½™ã€èªæ³•ã€èªç¾©é—œä¿‚)
3. **å¿«é€Ÿé©æ‡‰**: åªéœ€å°‘é‡ç¤ºä¾‹å°±èƒ½é©æ‡‰æ–°ä»»å‹™
4. **éˆæ´»æ€§**: é©ç”¨æ–¼å„ç¨®è¤‡é›œçš„èªè¨€ä»»å‹™

### å·¥ä½œåŸç†

```mermaid
graph LR
    A[ç”¨æˆ¶å•é¡Œ] --> B[ä¸Šä¸‹æ–‡æ³¨å…¥]
    B --> C[èƒŒæ™¯çŸ¥è­˜]
    B --> D[æ­·å²å°è©±]
    B --> E[ä¼æ¥­è³‡æ–™]
    C --> F[çµ„åˆ Prompt]
    D --> F
    E --> F
    F --> G[AI æ¨¡å‹]
    G --> H[å›æ‡‰]
```

### In-Context Learning vs Fine-tuning

| æ¯”è¼ƒé …ç›® | In-Context Learning | Fine-tuning |
|---------|---------------------|-------------|
| åƒæ•¸æ›´æ–° | âŒ ä¸éœ€è¦ | âœ… éœ€è¦ |
| è¨“ç·´æˆæœ¬ | ğŸ’° æ¥µä½ | ğŸ’°ğŸ’°ğŸ’° å¾ˆé«˜ |
| é©æ‡‰é€Ÿåº¦ | âš¡ å³æ™‚ | ğŸŒ éœ€è¦æ•¸å°æ™‚/æ•¸å¤© |
| è³‡æ–™éœ€æ±‚ | ğŸ“„ å°‘é‡ç¤ºä¾‹å³å¯ | ğŸ“š éœ€è¦å¤§é‡æ¨™è¨»è³‡æ–™ |
| é©ç”¨å ´æ™¯ | å¿«é€ŸåŸå‹ã€ä¼æ¥­çŸ¥è­˜åº« | ç‰¹å®šé ˜åŸŸã€é•·æœŸå„ªåŒ– |

---

## ğŸ’» å¯¦ç¾æ–¹å¼

### æ–¹å¼ 1: åŸºç¤ä¸Šä¸‹æ–‡æ³¨å…¥

æœ€ç°¡å–®çš„æ–¹å¼æ˜¯åœ¨ç”¨æˆ¶å•é¡Œå‰åŠ å…¥èƒŒæ™¯è³‡è¨Š:

```java
// å°æ‡‰ç¯„ä¾‹: chapter6-memory-core/src/main/java/.../service/ChatMemoryService.java:116

@Service
public class ChatMemoryService {

    @Autowired
    private ChatClient chatClient;

    public String chatWithContext(String userQuestion) {
        // æ³¨å…¥ä¸Šä¸‹æ–‡è³‡è¨Š
        String contextualPrompt = """
            èƒŒæ™¯è³‡è¨Š: Spring AI æ˜¯ Spring ç”Ÿæ…‹ç³»çµ±ä¸­ç”¨æ–¼é–‹ç™¼ AI æ‡‰ç”¨çš„æ¡†æ¶

            ç”¨æˆ¶å•é¡Œ: %s
            """.formatted(userQuestion);

        return chatClient.prompt()
            .user(contextualPrompt)
            .call()
            .content();
    }
}
```

**å„ªé»**: ç°¡å–®ç›´æ¥,å®¹æ˜“ç†è§£
**ç¼ºé»**: æ¯æ¬¡éƒ½è¦æ‰‹å‹•çµ„è£,ä¸å¤ å„ªé›…

---

### æ–¹å¼ 2: ä½¿ç”¨ System Message

System Message æ˜¯æ›´å°ˆæ¥­çš„åšæ³•,å¯ä»¥è¨­å®š AI çš„ã€Œäººè¨­ã€å’ŒèƒŒæ™¯çŸ¥è­˜:

```java
// å°æ‡‰ç¯„ä¾‹: chapter6-memory-core/src/main/java/.../config/ChatClientConfig.java:29

@Configuration
public class ChatClientConfig {

    @Bean
    public ChatClient enterpriseChatClient(ChatModel chatModel) {
        return ChatClient.builder(chatModel)
            .defaultSystem("""
                ä½ æ˜¯ä¸€å€‹ä¼æ¥­å…§éƒ¨ AI åŠ©æ‰‹,å…·å‚™ä»¥ä¸‹çŸ¥è­˜:

                æŠ€è¡“å°ˆå®¶:
                - Spring AI å°ˆå®¶: Kevin,æ“æœ‰20å¹´Javaé–‹ç™¼ç¶“é©—
                - å‰ç«¯å°ˆå®¶: å¼µå°ç¾,Reactèˆ‡Vue.jså°ˆå®¶

                å…¬å¸æŠ€è¡“æ£§:
                - å¾Œç«¯: Spring Boot 3.2
                - å‰ç«¯: React 18
                - è³‡æ–™åº«: PostgreSQL

                è«‹æ ¹æ“šé€™äº›è³‡è¨Šå›ç­”å•é¡Œ,ä¿æŒå°ˆæ¥­å’Œæº–ç¢ºã€‚
                """)
            .build();
    }
}
```

**ä½¿ç”¨æ–¹å¼**:
```java
@Service
public class EnterpriseService {

    @Autowired
    private ChatClient enterpriseChatClient;

    public String askQuestion(String question) {
        // System Message æœƒè‡ªå‹•åŠ å…¥åˆ°æ¯æ¬¡å°è©±ä¸­
        return enterpriseChatClient.prompt()
            .user(question)
            .call()
            .content();
    }
}
```

**å„ªé»**:
- âœ… ä¸€æ¬¡è¨­å®š,å…¨å±€ç”Ÿæ•ˆ
- âœ… è§’è‰²èˆ‡çŸ¥è­˜åˆ†é›¢æ¸…æ™°
- âœ… Spring AI æ¨è–¦çš„æœ€ä½³å¯¦è¸

---

### æ–¹å¼ 3: å‹•æ…‹ä¸Šä¸‹æ–‡æ³¨å…¥

æ ¹æ“šå•é¡Œå…§å®¹å‹•æ…‹é¸æ“‡ç›¸é—œä¸Šä¸‹æ–‡:

```java
// å°æ‡‰ç¯„ä¾‹: chapter6-memory-core (æ¦‚å¿µç¯„ä¾‹)

@Service
public class SmartContextService {

    private final Map<String, String> knowledgeBase = Map.of(
        "spring-ai", "Spring AI æ˜¯ç”¨æ–¼é–‹ç™¼ AI æ‡‰ç”¨çš„ Spring æ¡†æ¶...",
        "chatclient", "ChatClient æ˜¯ Spring AI 1.1 å¼•å…¥çš„æ–° API...",
        "advisor", "Advisor æ˜¯ Spring AI çš„æ’ä»¶ç³»çµ±..."
    );

    public String chatWithSmartContext(String question) {
        // 1. æ ¹æ“šå•é¡Œé—œéµå­—æ‰¾åˆ°ç›¸é—œçŸ¥è­˜
        String relevantContext = findRelevantContext(question);

        // 2. çµ„åˆä¸Šä¸‹æ–‡èˆ‡å•é¡Œ
        String prompt = """
            åƒè€ƒè³‡è¨Š: %s

            å•é¡Œ: %s

            è«‹æ ¹æ“šåƒè€ƒè³‡è¨Šå›ç­”å•é¡Œã€‚
            """.formatted(relevantContext, question);

        // 3. èª¿ç”¨ AI
        return chatClient.prompt()
            .user(prompt)
            .call()
            .content();
    }

    private String findRelevantContext(String question) {
        // ç°¡å–®çš„é—œéµå­—åŒ¹é…(å¯¦éš›æ‡‰ç”¨ä¸­å¯ä½¿ç”¨å‘é‡æœå°‹)
        return knowledgeBase.entrySet().stream()
            .filter(entry -> question.toLowerCase()
                .contains(entry.getKey()))
            .map(Map.Entry::getValue)
            .findFirst()
            .orElse("æ²’æœ‰æ‰¾åˆ°ç›¸é—œè³‡è¨Š");
    }
}
```

**å„ªé»**:
- âœ… åªæä¾›ç›¸é—œè³‡è¨Š,ç¯€çœ Token
- âœ… å¯æ“´å±•æ€§é«˜
- âœ… ç‚º RAG ç³»çµ±æ‰“ä¸‹åŸºç¤

---

## ğŸ†• Spring AI 1.1 çš„æ”¹é€²

### æ›´ç°¡æ½”çš„ API

```java
// âŒ èˆŠç‰ˆæœ¬ (Spring AI 1.0)
ChatResponse response = chatModel.call(new Prompt(List.of(
    new SystemMessage("ä½ æ˜¯å°ˆå®¶"),
    new UserMessage("å•é¡Œ")
)));
String answer = response.getResult().getOutput().getContent();

// âœ… æ–°ç‰ˆæœ¬ (Spring AI 1.1+)
String answer = chatClient.prompt()
    .system("ä½ æ˜¯å°ˆå®¶")
    .user("å•é¡Œ")
    .call()
    .content();
```

**æ”¹é€²é»**:
- ğŸ”„ æµæš¢çš„éˆå¼ API
- ğŸ“ æ›´ç›´è§€çš„æ–¹æ³•å‘½å
- ğŸ¯ æ¸›å°‘æ¨£æ¿ä»£ç¢¼

### å…§å»º Advisor æ”¯æ´

Spring AI 1.1 å¼•å…¥äº† Advisor æ©Ÿåˆ¶,å¯ä»¥è‡ªå‹•è™•ç†ä¸Šä¸‹æ–‡æ³¨å…¥:

```java
@Bean
public ChatClient smartChatClient(ChatModel chatModel) {
    return ChatClient.builder(chatModel)
        .defaultAdvisors(
            // è‡ªå‹•è™•ç†ä¸Šä¸‹æ–‡æ³¨å…¥çš„ Advisor
            new ContextEnhancementAdvisor(knowledgeBase)
        )
        .build();
}
```

æˆ‘å€‘å°‡åœ¨ [6.4 Advisor è‡ªå®šç¾©é–‹ç™¼](./6.4-Advisor-è‡ªå®šç¾©é–‹ç™¼.md) æ·±å…¥æ¢è¨ã€‚

---

## ğŸ¬ å¯¦éš›æ‡‰ç”¨å ´æ™¯

### 1. ä¼æ¥­çŸ¥è­˜åº«åŠ©æ‰‹

```java
@Bean
public ChatClient companyAssistant(ChatModel chatModel) {
    return ChatClient.builder(chatModel)
        .defaultSystem("""
            ä½ æ˜¯XXå…¬å¸çš„AIåŠ©æ‰‹,äº†è§£ä»¥ä¸‹è³‡è¨Š:

            å…¬å¸è¦ç« :
            - å¹´å‡åˆ¶åº¦: å…¥è·æ»¿ä¸€å¹´äº«æœ‰7å¤©å¹´å‡
            - é ç«¯å·¥ä½œ: æ¯é€±æœ€å¤š2å¤©

            ç¦åˆ©åˆ¶åº¦:
            - å¥åº·æª¢æŸ¥: æ¯å¹´ä¸€æ¬¡
            - å­¸ç¿’è£œåŠ©: æ¯äººæ¯å¹´$10,000

            è«‹æ ¹æ“šé€™äº›è³‡è¨Šå›ç­”å“¡å·¥å•é¡Œã€‚
            """)
        .build();
}
```

### 2. æŠ€è¡“æ”¯æ´æ©Ÿå™¨äºº

```java
@Bean
public ChatClient techSupportBot(ChatModel chatModel) {
    return ChatClient.builder(chatModel)
        .defaultSystem("""
            ä½ æ˜¯æŠ€è¡“æ”¯æ´æ©Ÿå™¨äºº,å°ˆç²¾æ–¼:

            æ•…éšœæ’é™¤:
            - Spring Boot æ‡‰ç”¨å•Ÿå‹•å¤±æ•—
            - è³‡æ–™åº«é€£ç·šå•é¡Œ
            - API å‘¼å«éŒ¯èª¤

            å¸¸è¦‹è§£æ±ºæ–¹æ¡ˆ:
            - æª¢æŸ¥ application.yml é…ç½®
            - ç¢ºèªè³‡æ–™åº«æœå‹™å•Ÿå‹•
            - æŸ¥çœ‹æ—¥èªŒæª”æ¡ˆ

            è«‹æä¾›æ¸…æ™°çš„æ­¥é©ŸæŒ‡å¼•ã€‚
            """)
        .build();
}
```

### 3. å®¢æœå°è©±ç³»çµ±

çµåˆæ­·å²å°è©±çš„ä¸Šä¸‹æ–‡:

```java
public String customerService(String conversationId, String question) {
    // 1. ç²å–æ­·å²å°è©±
    List<Message> history = chatMemory.get(conversationId);

    // 2. çµ„åˆä¸Šä¸‹æ–‡
    String context = history.stream()
        .map(msg -> msg.getContent())
        .collect(Collectors.joining("\n"));

    // 3. ç™¼é€å®Œæ•´ä¸Šä¸‹æ–‡çµ¦ AI
    return chatClient.prompt()
        .system("ä½ æ˜¯å®¢æœäººå“¡,è«‹æ ¹æ“šå°è©±æ­·å²æä¾›å”åŠ©")
        .user("""
            å°è©±æ­·å²:
            %s

            æ–°å•é¡Œ: %s
            """.formatted(context, question))
        .call()
        .content();
}
```

---

## ğŸ”— èˆ‡å…¶ä»–æ¦‚å¿µçš„é—œä¿‚

```mermaid
graph TD
    A[In-Context Learning] --> B[RAG ç³»çµ±]
    A --> C[å°è©±è¨˜æ†¶]
    A --> D[å·¥å…·èª¿ç”¨]
    B --> E[å‘é‡è³‡æ–™åº«]
    C --> F[ChatMemory]
    D --> G[Function Calling]

    style A fill:#e1f5ff
    style B fill:#fff4e6
    style C fill:#e8f5e9
```

- **RAG ç³»çµ±** ([6.2 RAG åŸºç¤æ¦‚å¿µ](./6.2-RAG-åŸºç¤æ¦‚å¿µ.md)): é€éå‘é‡æª¢ç´¢è‡ªå‹•æ‰¾åˆ°ç›¸é—œä¸Šä¸‹æ–‡
- **å°è©±è¨˜æ†¶** ([6.3 ChatMemory çŸ­æœŸè¨˜æ†¶ç³»çµ±](./6.3-ChatMemory-çŸ­æœŸè¨˜æ†¶ç³»çµ±.md)): å°‡æ­·å²å°è©±ä½œç‚ºä¸Šä¸‹æ–‡
- **å·¥å…·èª¿ç”¨**: AI æ ¹æ“šä¸Šä¸‹æ–‡æ±ºå®šæ˜¯å¦èª¿ç”¨å¤–éƒ¨å·¥å…·

---

## ğŸ“ é‡é»å›é¡§

### æ ¸å¿ƒæ¦‚å¿µ
âœ… AI æœ¬èº«æ˜¯ç„¡ç‹€æ…‹çš„,æ¯æ¬¡å°è©±éƒ½æ˜¯ç¨ç«‹çš„
âœ… In-Context Learning é€éæ”œå¸¶ä¸Šä¸‹æ–‡è®“ AI å…·å‚™ã€Œè¨˜æ†¶ã€
âœ… ä¸éœ€è¦æ›´æ–°æ¨¡å‹åƒæ•¸,åªéœ€æä¾›ç›¸é—œè³‡è¨Š

### ä¸‰ç¨®å¯¦ç¾æ–¹å¼
1. **åŸºç¤æ³¨å…¥**: æ‰‹å‹•çµ„è£ä¸Šä¸‹æ–‡å’Œå•é¡Œ
2. **System Message**: è¨­å®šå…¨å±€èƒŒæ™¯çŸ¥è­˜(æ¨è–¦)
3. **å‹•æ…‹æ³¨å…¥**: æ ¹æ“šå•é¡Œé¸æ“‡ç›¸é—œä¸Šä¸‹æ–‡

### Spring AI 1.1 å„ªå‹¢
- ğŸ”„ æ›´ç°¡æ½”çš„ Fluent API
- ğŸ¯ å…§å»º Advisor æ©Ÿåˆ¶
- ğŸ“¦ é–‹ç®±å³ç”¨çš„æœ€ä½³å¯¦è¸

---

## ğŸš€ ä¸‹ä¸€æ­¥

ç¾åœ¨ä½ å·²ç¶“ç†è§£äº† In-Context Learning çš„åŸºæœ¬æ¦‚å¿µ,æ¥ä¸‹ä¾†æˆ‘å€‘å°‡å­¸ç¿’:

ğŸ‘‰ [6.2 RAG åŸºç¤æ¦‚å¿µ](./6.2-RAG-åŸºç¤æ¦‚å¿µ.md) - å¦‚ä½•è‡ªå‹•æª¢ç´¢ç›¸é—œä¸Šä¸‹æ–‡
ğŸ‘‰ [6.3 ChatMemory çŸ­æœŸè¨˜æ†¶ç³»çµ±](./6.3-ChatMemory-çŸ­æœŸè¨˜æ†¶ç³»çµ±.md) - å¦‚ä½•ç®¡ç†å°è©±æ­·å²

---

## ğŸ“š å®Œæ•´ç¯„ä¾‹

æœ¬ç« æ¦‚å¿µçš„å®Œæ•´å¯¦ç¾è«‹åƒè€ƒ:

ğŸ“ **chapter6-memory-core**
- `src/main/java/com/example/memory/config/ChatClientConfig.java` - ChatClient é…ç½®
- `src/main/java/com/example/memory/service/ChatMemoryService.java` - å°è©±æœå‹™
- `src/main/java/com/example/memory/controller/ChatController.java` - REST API

ğŸ”— **å•Ÿå‹•ç¯„ä¾‹**:
```bash
cd code-examples/chapter6-ai-memory/chapter6-memory-core
mvn spring-boot:run
```

ğŸ§ª **æ¸¬è©¦ API**:
```bash
curl http://localhost:8080/api/chat/health
```

---

**ç›¸é—œç« ç¯€**:
- â† ä¸Šä¸€ç« : [ç¬¬5ç«  Spring AI é€²éšåŠŸèƒ½](../../chapter5/README.md)
- â†’ ä¸‹ä¸€ç« : [6.2 RAG åŸºç¤æ¦‚å¿µ](./6.2-RAG-åŸºç¤æ¦‚å¿µ.md)
