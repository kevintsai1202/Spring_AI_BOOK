# 6.3 ChatMemory çŸ­æœŸè¨˜æ†¶ç³»çµ±

> **å°æ‡‰ç« ç¯€**: Day17
> **å°æ‡‰ç¯„ä¾‹**: `chapter6-memory-core`
> **é›£åº¦**: â­â­â­â˜†â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

ChatMemory æ˜¯ Spring AI æä¾›çš„ä¼æ¥­ç´šå°è©±è¨˜æ†¶ç®¡ç†ç³»çµ±ã€‚å®ƒè§£æ±ºäº†å‚³çµ±ã€ŒåœŸç‚®è¨˜æ†¶ã€çš„è«¸å¤šå•é¡Œ,æä¾›å°è©±éš”é›¢ã€å®¹é‡ç®¡ç†ã€æŒä¹…åŒ–å„²å­˜ç­‰ä¼æ¥­ç´šåŠŸèƒ½ã€‚

**å­¸ç¿’ç›®æ¨™**:
- ç†è§£ ChatMemory æ¶æ§‹è¨­è¨ˆ
- æŒæ¡ MessageChatMemoryAdvisor å’Œ PromptChatMemoryAdvisor çš„å·®ç•°
- å­¸æœƒé…ç½®ä¸åŒçš„å„²å­˜å¾Œç«¯
- äº†è§£è¨˜æ†¶å®¹é‡ç®¡ç†ç­–ç•¥

---

## ğŸ¯ ç‚ºä»€éº¼éœ€è¦ ChatMemory?

### åœŸç‚®è¨˜æ†¶çš„å•é¡Œ

æœ€ç°¡å–®çš„åšæ³•æ˜¯ç”¨ List å„²å­˜å°è©±:

```java
// âŒ åœŸç‚®åšæ³•çš„å•é¡Œ
@RestController
public class BadMemoryController {

    private List<Message> memMessage = new ArrayList<>(); // å•é¡Œå¤šå¤š!

    @GetMapping("/chat")
    public String chat(@RequestParam String prompt) {
        memMessage.add(new UserMessage(prompt));

        String response = chatClient.prompt()
            .messages(memMessage)
            .call()
            .content();

        memMessage.add(new AssistantMessage(response));
        return response;
    }
}
```

**å•é¡Œæ¸…å–®**:
1. âŒ **ç„¡å°è©±éš”é›¢**: æ‰€æœ‰ç”¨æˆ¶å…±ç”¨åŒä¸€å€‹ List
2. âŒ **ç„¡å®¹é‡ç®¡ç†**: List æœƒç„¡é™å¢é•·,æœ€çµ‚è¨˜æ†¶é«”çˆ†ç‚¸
3. âŒ **ç„¡æŒä¹…åŒ–**: æ‡‰ç”¨é‡å•Ÿå¾Œè¨˜æ†¶å…¨éƒ¨ä¸Ÿå¤±
4. âŒ **ä½µç™¼ä¸å®‰å…¨**: å¤šç”¨æˆ¶åŒæ™‚è«‹æ±‚æœƒé€ æˆè³‡æ–™æ··äº‚
5. âŒ **ç„¡å¯è§€æ¸¬æ€§**: ç„¡æ³•ç›£æ§è¨˜æ†¶ä½¿ç”¨ç‹€æ³

### ChatMemory çš„è§£æ±ºæ–¹æ¡ˆ

```java
// âœ… Spring AI ä¼æ¥­ç´šæ–¹æ¡ˆ
@Service
public class ProperMemoryService {

    @Autowired
    private ChatMemory chatMemory; // ä¼æ¥­ç´šè¨˜æ†¶ç®¡ç†

    public String chat(String conversationId, String message) {
        return chatClient.prompt()
            .advisors(MessageChatMemoryAdvisor.builder(chatMemory)
                .conversationId(conversationId)    // å°è©±éš”é›¢
                .lastN(20)                         // å®¹é‡ç®¡ç†
                .build())
            .user(message)
            .call()
            .content();
    }
}
```

---

## ğŸ—ï¸ ChatMemory æ¶æ§‹è¨­è¨ˆ

### æ ¸å¿ƒä»‹é¢

```java
// Spring AI ChatMemory ä»‹é¢
public interface ChatMemory {
    // æ–°å¢è¨Šæ¯
    void add(String conversationId, Message message);
    void addAll(String conversationId, List<Message> messages);

    // å–å¾—è¨Šæ¯
    List<Message> get(String conversationId);
    List<Message> getRecent(String conversationId, int limit);

    // ç®¡ç†å°è©±
    void clear(String conversationId);
    boolean exists(String conversationId);
    long count(String conversationId);
}
```

### æ¶æ§‹åˆ†å±¤

```mermaid
graph TD
    A[ChatController] --> B[ChatMemoryService]
    B --> C[ChatMemory Interface]
    C --> D[InMemoryChatMemory]
    C --> E[MessageWindowChatMemory]
    C --> F[JdbcChatMemory]
    C --> G[RedisChatMemory]

    style C fill:#e1f5ff
    style D fill:#e8f5e9
    style E fill:#fff4e6
    style F fill:#f3e5f5
    style G fill:#ffe0b2
```

---

## ğŸ’» InMemoryChatMemory å¯¦ç¾

### åŸºæœ¬å¯¦ç¾

```java
// å°æ‡‰ç¯„ä¾‹: chapter6-memory-core/.../memory/InMemoryChatMemory.java:17

@Component
public class InMemoryChatMemory implements ChatMemory {

    // ä½¿ç”¨ ConcurrentHashMap ç¢ºä¿ç·šç¨‹å®‰å…¨
    private final Map<String, List<Message>> conversations
        = new ConcurrentHashMap<>();

    @Override
    public void add(String conversationId, Message message) {
        conversations
            .computeIfAbsent(conversationId, k -> new ArrayList<>())
            .add(message);
    }

    @Override
    public List<Message> get(String conversationId) {
        return conversations.getOrDefault(
            conversationId,
            Collections.emptyList()
        );
    }

    @Override
    public List<Message> getRecent(String conversationId, int limit) {
        List<Message> messages = get(conversationId);
        int start = Math.max(0, messages.size() - limit);
        return new ArrayList<>(messages.subList(start, messages.size()));
    }

    @Override
    public void clear(String conversationId) {
        conversations.remove(conversationId);
    }
}
```

**ç‰¹é»**:
- âœ… ç·šç¨‹å®‰å…¨ (ConcurrentHashMap)
- âœ… å°è©±éš”é›¢ (conversationId ä½œç‚º key)
- âœ… é–‹ç™¼ç’°å¢ƒé¦–é¸
- âš ï¸ ç„¡æŒä¹…åŒ– (é‡å•Ÿä¸Ÿå¤±)

---

## ğŸªŸ MessageWindowChatMemory (æ»‘å‹•è¦–çª—)

### ç‚ºä»€éº¼éœ€è¦æ»‘å‹•è¦–çª—?

```
å•é¡Œ: å°è©±å¤ªé•·æœƒæ€æ¨£?

ç¬¬1è¼ª: "ä½ å¥½" â†’ 2 tokens
ç¬¬2è¼ª: "ä»‹ç´¹Spring AI" â†’ 100 tokens
...
ç¬¬50è¼ª: ç¸½è¨ˆ 5000 tokens â† æˆæœ¬é«˜ã€å›æ‡‰æ…¢
ç¬¬100è¼ª: ç¸½è¨ˆ 10000 tokens â† è¶…éæ¨¡å‹é™åˆ¶!
```

### æ»‘å‹•è¦–çª—ç­–ç•¥

```java
// å°æ‡‰ç¯„ä¾‹: chapter6-memory-core/.../memory/MessageWindowChatMemory.java

public class MessageWindowChatMemory implements ChatMemory {

    private final ChatMemory delegate;
    private final int maxMessages; // æœ€å¤§ä¿ç•™è¨Šæ¯æ•¸

    public MessageWindowChatMemory(ChatMemory delegate, int maxMessages) {
        this.delegate = delegate;
        this.maxMessages = maxMessages;
    }

    @Override
    public List<Message> get(String conversationId) {
        List<Message> allMessages = delegate.get(conversationId);

        // åªè¿”å›æœ€è¿‘çš„ N æ¢è¨Šæ¯
        if (allMessages.size() <= maxMessages) {
            return allMessages;
        }

        int start = allMessages.size() - maxMessages;
        return new ArrayList<>(allMessages.subList(start, allMessages.size()));
    }

    @Override
    public void add(String conversationId, Message message) {
        delegate.add(conversationId, message);

        // è‡ªå‹•æ¸…ç†èˆŠè¨Šæ¯
        List<Message> messages = delegate.get(conversationId);
        if (messages.size() > maxMessages * 2) { // è¶…é2å€æ™‚æ¸…ç†
            List<Message> recentMessages = messages.subList(
                messages.size() - maxMessages,
                messages.size()
            );
            delegate.clear(conversationId);
            delegate.addAll(conversationId, recentMessages);
        }
    }
}
```

**é…ç½®æ–¹å¼**:
```java
// å°æ‡‰ç¯„ä¾‹: chapter6-memory-core/.../config/ChatMemoryConfig.java:64

@Bean
public ChatMemory chatMemory(InMemoryChatMemory inMemory) {
    return new MessageWindowChatMemory(
        inMemory,
        50  // ä¿ç•™æœ€è¿‘50æ¢è¨Šæ¯
    );
}
```

---

## ğŸ­ å…©ç¨® Advisor çš„å·®ç•°

### MessageChatMemoryAdvisor

å°‡å°è©±æ­·å²ä½œç‚º **Message é›†åˆ** åŠ å…¥:

```java
// å¯¦éš›ç™¼é€çµ¦ AI çš„å…§å®¹
List<Message> messages = [
    UserMessage("æˆ‘å«Kevin"),
    AssistantMessage("ä½ å¥½,Kevin!"),
    UserMessage("æˆ‘å«ä»€éº¼åå­—?")  // â† æ–°å•é¡Œ
];

// AI èƒ½çœ‹åˆ°å®Œæ•´çš„å°è©±çµæ§‹
```

**å„ªé»**:
- âœ… ä¿ç•™å®Œæ•´å°è©±çµæ§‹
- âœ… AI èƒ½å€åˆ†ç”¨æˆ¶å’ŒåŠ©æ‰‹çš„è¨Šæ¯
- âœ… Spring AI æ¨è–¦æ–¹æ¡ˆ

**ä½¿ç”¨æ–¹å¼**:
```java
@Service
public class ChatService {

    public String chat(String conversationId, String message) {
        return chatClient.prompt()
            .advisors(MessageChatMemoryAdvisor.builder(chatMemory)
                .conversationId(conversationId)
                .build())
            .user(message)
            .call()
            .content();
    }
}
```

### PromptChatMemoryAdvisor

å°‡å°è©±æ­·å²ä½œç‚º **æ–‡å­—** åŠ å…¥ System Message:

```java
// å¯¦éš›ç™¼é€çµ¦ AI çš„å…§å®¹
SystemMessage: """
å°è©±æ­·å²:
ç”¨æˆ¶: æˆ‘å«Kevin
åŠ©æ‰‹: ä½ å¥½,Kevin!
"""

UserMessage: "æˆ‘å«ä»€éº¼åå­—?"
```

**å„ªé»**:
- âœ… æ›´ç¯€çœ tokens
- âœ… å¯è‡ªå®šç¾©æ ¼å¼

**ä½¿ç”¨æ–¹å¼**:
```java
@Service
public class ChatService {

    public String chat(String conversationId, String message) {
        return chatClient.prompt()
            .advisors(PromptChatMemoryAdvisor.builder(chatMemory)
                .conversationId(conversationId)
                .promptTemplate("""
                    æ­·å²å°è©±:
                    {history}

                    è«‹æ ¹æ“šæ­·å²å›ç­”å•é¡Œã€‚
                    """)
                .build())
            .user(message)
            .call()
            .content();
    }
}
```

---

## ğŸ—„ï¸ å¤šç¨®å„²å­˜å¾Œç«¯

### 1. InMemory (é–‹ç™¼ç’°å¢ƒ)

```yaml
# application.yml
memory:
  storage-type: memory
```

**ç‰¹é»**:
- âœ… æœ€ç°¡å–®
- âœ… é€Ÿåº¦æœ€å¿«
- âŒ é‡å•Ÿä¸Ÿå¤±

### 2. Window + InMemory (é–‹ç™¼ç’°å¢ƒ)

```yaml
memory:
  storage-type: window
  window-size: 50
```

**ç‰¹é»**:
- âœ… è‡ªå‹•å®¹é‡ç®¡ç†
- âœ… é–‹ç™¼ç’°å¢ƒæ¨è–¦
- âŒ é‡å•Ÿä¸Ÿå¤±

### 3. JDBC (ç”Ÿç”¢ç’°å¢ƒ)

```java
@Bean
@ConditionalOnProperty(name = "memory.storage-type", havingValue = "jdbc")
public ChatMemory jdbcChatMemory(DataSource dataSource) {
    return new JdbcChatMemory(dataSource);
}
```

```yaml
memory:
  storage-type: jdbc

spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/chatdb
    username: postgres
    password: password
```

**ç‰¹é»**:
- âœ… æŒä¹…åŒ–å„²å­˜
- âœ… å¯è·¨å¯¦ä¾‹å…±äº«
- âœ… ç”Ÿç”¢ç’°å¢ƒæ¨è–¦

### 4. Redis (é«˜ä½µç™¼)

```java
@Bean
@ConditionalOnProperty(name = "memory.storage-type", havingValue = "redis")
public ChatMemory redisChatMemory(RedisTemplate<String, Object> redis) {
    return new RedisChatMemory(redis);
}
```

```yaml
memory:
  storage-type: redis

spring:
  redis:
    host: localhost
    port: 6379
```

**ç‰¹é»**:
- âœ… é«˜æ€§èƒ½
- âœ… æ”¯æ´åˆ†æ•£å¼
- âœ… å¤§è¦æ¨¡æ‡‰ç”¨æ¨è–¦

---

## ğŸ¬ å®Œæ•´ä½¿ç”¨ç¯„ä¾‹

### é…ç½® ChatClient

```java
@Configuration
public class ChatConfig {

    @Bean
    public ChatClient memoryChatClient(
            ChatModel chatModel,
            ChatMemory chatMemory) {

        return ChatClient.builder(chatModel)
            .defaultAdvisors(
                MessageChatMemoryAdvisor.builder(chatMemory)
                    .order(1)  // æœ€é«˜å„ªå…ˆç´š
                    .build()
            )
            .build();
    }
}
```

### æœå‹™å±¤ä½¿ç”¨

```java
@Service
public class ConversationService {

    @Autowired
    private ChatClient memoryChatClient;

    @Autowired
    private ChatMemory chatMemory;

    /**
     * ç™¼é€è¨Šæ¯
     */
    public String sendMessage(String conversationId, String message) {
        return memoryChatClient.prompt()
            .advisors(a -> a.param(CONVERSATION_ID, conversationId))
            .user(message)
            .call()
            .content();
    }

    /**
     * ç²å–å°è©±æ­·å²
     */
    public List<Message> getHistory(String conversationId) {
        return chatMemory.get(conversationId);
    }

    /**
     * æ¸…é™¤å°è©±
     */
    public void clearConversation(String conversationId) {
        chatMemory.clear(conversationId);
    }
}
```

### Controller å±¤

```java
// å°æ‡‰ç¯„ä¾‹: chapter6-memory-core/.../controller/ChatController.java:38

@RestController
@RequestMapping("/api/chat")
public class ChatController {

    @Autowired
    private ConversationService conversationService;

    @PostMapping("/conversation/{conversationId}")
    public ChatResponse chat(
            @PathVariable String conversationId,
            @RequestBody ChatRequest request) {

        String response = conversationService.sendMessage(
            conversationId,
            request.getMessage()
        );

        return ChatResponse.success(conversationId, response);
    }

    @GetMapping("/conversation/{conversationId}/history")
    public List<Message> getHistory(@PathVariable String conversationId) {
        return conversationService.getHistory(conversationId);
    }

    @DeleteMapping("/conversation/{conversationId}")
    public void clearConversation(@PathVariable String conversationId) {
        conversationService.clearConversation(conversationId);
    }
}
```

---

## ğŸ“ é‡é»å›é¡§

### ChatMemory è§£æ±ºçš„å•é¡Œ
âœ… å°è©±éš”é›¢ - æ¯å€‹ conversationId ç¨ç«‹
âœ… å®¹é‡ç®¡ç† - MessageWindowChatMemory è‡ªå‹•æ¸…ç†
âœ… æŒä¹…åŒ– - æ”¯æ´ JDBCã€Redis ç­‰å¾Œç«¯
âœ… ä½µç™¼å®‰å…¨ - ä½¿ç”¨ ConcurrentHashMap
âœ… å¯è§€æ¸¬æ€§ - å…§å»ºç›£æ§å’Œæ—¥èªŒ

### å…©ç¨® Advisor
- **MessageChatMemoryAdvisor**: ä¿ç•™å®Œæ•´å°è©±çµæ§‹(æ¨è–¦)
- **PromptChatMemoryAdvisor**: ç¯€çœ tokens,å¯è‡ªå®šç¾©æ ¼å¼

### å„²å­˜å¾Œç«¯é¸æ“‡
- **é–‹ç™¼**: InMemory æˆ– Window
- **ç”Ÿç”¢**: JDBC æˆ– Redis
- **å¤§è¦æ¨¡**: Redis + Cluster

---

## ğŸš€ ä¸‹ä¸€æ­¥

ğŸ‘‰ [6.4 Advisor è‡ªå®šç¾©é–‹ç™¼](./6.4-Advisor-è‡ªå®šç¾©é–‹ç™¼.md) - æ·±å…¥äº†è§£ Advisor æ©Ÿåˆ¶
ğŸ‘‰ [6.7 VectorStoreChatMemoryAdvisor](./6.7-VectorStoreChatMemoryAdvisor.md) - å‘é‡è¨˜æ†¶ç³»çµ±

---

**ç›¸é—œç« ç¯€**:
- â† ä¸Šä¸€ç« : [6.2 RAG åŸºç¤æ¦‚å¿µ](./6.2-RAG-åŸºç¤æ¦‚å¿µ.md)
- â†’ ä¸‹ä¸€ç« : [6.4 Advisor è‡ªå®šç¾©é–‹ç™¼](./6.4-Advisor-è‡ªå®šç¾©é–‹ç™¼.md)
