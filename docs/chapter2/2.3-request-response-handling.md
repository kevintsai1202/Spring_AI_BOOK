# 2.3 API è«‹æ±‚èˆ‡å›æ‡‰è™•ç†

> **å°æ‡‰ç¯„ä¾‹**: `chapter2-spring-mvc-api`
> **é›£åº¦**: â­â­â­â˜†â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

åœ¨ RESTful API é–‹ç™¼ä¸­ï¼Œæ­£ç¢ºè™•ç†è«‹æ±‚åƒæ•¸å’Œçµ±ä¸€å›æ‡‰æ ¼å¼è‡³é—œé‡è¦ã€‚æœ¬ç« å°‡æ·±å…¥æ¢è¨ Spring MVC æä¾›çš„å„ç¨®åƒæ•¸ç¶å®šè¨»è§£ï¼Œä»¥åŠå¦‚ä½•è¨­è¨ˆçµ±ä¸€çš„ API å›æ‡‰çµæ§‹å’Œå…¨åŸŸéŒ¯èª¤è™•ç†æ©Ÿåˆ¶ã€‚

**å­¸ç¿’ç›®æ¨™**:
- æŒæ¡ Spring MVC çš„åƒæ•¸ç¶å®šè¨»è§£
- ç†è§£ä¸åŒåƒæ•¸ä¾†æºçš„ä½¿ç”¨å ´æ™¯
- è¨­è¨ˆçµ±ä¸€çš„ API å›æ‡‰æ ¼å¼
- å¯¦ç¾ä¼æ¥­ç´šçš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
- æ­£ç¢ºä½¿ç”¨ HTTP ç‹€æ…‹ç¢¼

---

## ğŸ¯ è«‹æ±‚åƒæ•¸è™•ç†

### Spring MVC åƒæ•¸ç¶å®šæ©Ÿåˆ¶

Spring MVC æä¾›äº†å¤šç¨®åƒæ•¸ç¶å®šè¨»è§£ï¼Œç”¨æ–¼å¾ä¸åŒä¾†æºç²å–è«‹æ±‚è³‡æ–™ï¼š

```mermaid
graph TB
    Request[HTTP è«‹æ±‚]

    Request --> Path[URL è·¯å¾‘<br/>/api/users/123]
    Request --> Query[æŸ¥è©¢å­—ä¸²<br/>?page=1&size=20]
    Request --> Body[è«‹æ±‚é«”<br/>JSON è³‡æ–™]
    Request --> Header[è«‹æ±‚æ¨™é ­<br/>Authorization: Bearer xxx]

    Path --> PathVariable[PathVariable<br/>è·¯å¾‘è®Šæ•¸]
    Query --> RequestParam[RequestParam<br/>æŸ¥è©¢åƒæ•¸]
    Body --> RequestBody[RequestBody<br/>è«‹æ±‚é«”]
    Header --> RequestHeader[RequestHeader<br/>è«‹æ±‚æ¨™é ­]

    PathVariable --> Controller[Controller æ–¹æ³•]
    RequestParam --> Controller
    RequestBody --> Controller
    RequestHeader --> Controller

    style Path fill:#e3f2fd
    style Query fill:#fff9c4
    style Body fill:#e8f5e9
    style Header fill:#f3e5f5
```

### åƒæ•¸è¨»è§£æ¦‚è¦½

| è¨»è§£ | ç”¨é€” | è³‡æ–™ä¾†æº | æ˜¯å¦å¿…éœ€ | é©ç”¨å ´æ™¯ |
|------|------|----------|----------|----------|
| **@PathVariable** | è·¯å¾‘åƒæ•¸ | URL è·¯å¾‘ | é è¨­å¿…éœ€ | RESTful è³‡æºè­˜åˆ¥ |
| **@RequestParam** | æŸ¥è©¢åƒæ•¸ | URL æŸ¥è©¢å­—ä¸² | å¯è¨­å®šç‚ºé¸å¡« | æœå°‹æ¢ä»¶ã€åˆ†é åƒæ•¸ |
| **@RequestBody** | è«‹æ±‚é«”åƒæ•¸ | HTTP è«‹æ±‚é«” | é è¨­å¿…éœ€ | JSON ç‰©ä»¶ã€è¤‡é›œè³‡æ–™ |
| **@RequestHeader** | è«‹æ±‚æ¨™é ­ | HTTP æ¨™é ­ | å¯è¨­å®šç‚ºé¸å¡« | èªè­‰è³‡è¨Šã€å®¢æˆ¶ç«¯è³‡è¨Š |
| **@CookieValue** | Cookie å€¼ | HTTP Cookie | å¯è¨­å®šç‚ºé¸å¡« | Session IDã€è¿½è¹¤è³‡è¨Š |

---

## ğŸ”— @PathVariable - è·¯å¾‘åƒæ•¸

### åŸºæœ¬ç”¨æ³•

`@PathVariable` ç”¨æ–¼å¾ URL è·¯å¾‘ä¸­æå–è®Šæ•¸å€¼ï¼Œæ˜¯ RESTful API è¨­è¨ˆçš„æ ¸å¿ƒè¨»è§£ã€‚

```java
// å°æ‡‰ç¯„ä¾‹: chapter2-spring-mvc-api/.../api/UserRestController.java:25

@RestController
@RequestMapping("/api/v1/users")
public class UserRestController {

    private final UserService userService;

    /**
     * å–®ä¸€è·¯å¾‘åƒæ•¸
     * GET /api/v1/users/123
     */
    @GetMapping("/{id}")
    public ResponseEntity<UserDto> getUser(@PathVariable Long id) {
        User user = userService.findById(id);
        return ResponseEntity.ok(UserDto.from(user));
    }

    /**
     * å¤šå€‹è·¯å¾‘åƒæ•¸
     * GET /api/v1/users/123/orders/456
     */
    @GetMapping("/{userId}/orders/{orderId}")
    public ResponseEntity<OrderDto> getUserOrder(
            @PathVariable Long userId,
            @PathVariable Long orderId) {

        Order order = orderService.findByUserIdAndOrderId(userId, orderId);
        return ResponseEntity.ok(OrderDto.from(order));
    }

    /**
     * è·¯å¾‘åƒæ•¸åç¨±ä¸åŒæ™‚ï¼ŒæŒ‡å®šåƒæ•¸åç¨±
     * GET /api/v1/users/john-doe
     */
    @GetMapping("/{username}")
    public ResponseEntity<UserDto> getUserByUsername(
            @PathVariable("username") String name) {

        User user = userService.findByUsername(name);
        return ResponseEntity.ok(UserDto.from(user));
    }

    /**
     * ä½¿ç”¨ Map æ¥æ”¶æ‰€æœ‰è·¯å¾‘åƒæ•¸
     * GET /api/v1/categories/tech/products/123
     */
    @GetMapping("/categories/{category}/products/{productId}")
    public ResponseEntity<ProductDto> getProduct(
            @PathVariable Map<String, String> pathVars) {

        String category = pathVars.get("category");
        Long productId = Long.parseLong(pathVars.get("productId"));

        Product product = productService.findByCategoryAndId(category, productId);
        return ResponseEntity.ok(ProductDto.from(product));
    }
}
```

**ä½¿ç”¨å ´æ™¯**:
- ğŸ” **è­˜åˆ¥ç‰¹å®šè³‡æº**: `/users/123` è­˜åˆ¥ ID ç‚º 123 çš„ä½¿ç”¨è€…
- ğŸ”— **è¡¨é”è³‡æºé—œè¯**: `/users/123/orders/456` è¡¨ç¤ºä½¿ç”¨è€… 123 çš„è¨‚å–® 456
- ğŸ“¦ **RESTful è·¯ç”±è¨­è¨ˆ**: éµå¾ª REST è³‡æºå°å‘åŸå‰‡

**æ³¨æ„äº‹é …**:
- âš ï¸ é è¨­æƒ…æ³ä¸‹ï¼Œè·¯å¾‘åƒæ•¸æ˜¯å¿…éœ€çš„ï¼Œç¼ºå°‘æœƒè¿”å› 404
- âš ï¸ è·¯å¾‘åƒæ•¸æœƒè‡ªå‹•é€²è¡Œå‹åˆ¥è½‰æ›ï¼ˆå¦‚ String è½‰ Longï¼‰
- âš ï¸ å‹åˆ¥è½‰æ›å¤±æ•—æœƒæ‹‹å‡º `MethodArgumentTypeMismatchException`

---

## ğŸ” @RequestParam - æŸ¥è©¢åƒæ•¸

### åŸºæœ¬ç”¨æ³•

`@RequestParam` ç”¨æ–¼å¾ URL æŸ¥è©¢å­—ä¸²ä¸­ç²å–åƒæ•¸ï¼Œå¸¸ç”¨æ–¼æœå°‹ã€éæ¿¾ã€åˆ†é ç­‰å ´æ™¯ã€‚

```java
// å°æ‡‰ç¯„ä¾‹: chapter2-spring-mvc-api/.../api/ProductRestController.java:30

@RestController
@RequestMapping("/api/v1/products")
public class ProductRestController {

    private final ProductService productService;

    /**
     * æœå°‹èˆ‡åˆ†é 
     * GET /api/v1/products?keyword=spring&page=0&size=10&sort=price
     */
    @GetMapping
    public ResponseEntity<PagedResponse<ProductDto>> searchProducts(
            @RequestParam(required = false) String keyword,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size,
            @RequestParam(defaultValue = "id") String sort) {

        Pageable pageable = PageRequest.of(
            page,
            size,
            Sort.by(sort).descending()
        );

        Page<Product> products = productService.search(keyword, pageable);

        return ResponseEntity.ok(
            PagedResponse.of(products, ProductDto::from)
        );
    }

    /**
     * è¤‡é›œæŸ¥è©¢æ¢ä»¶
     * GET /api/v1/products/filter?category=book&minPrice=100&maxPrice=500
     */
    @GetMapping("/filter")
    public ResponseEntity<List<ProductDto>> filterProducts(
            @RequestParam String category,
            @RequestParam(required = false) Integer minPrice,
            @RequestParam(required = false) Integer maxPrice,
            @RequestParam(required = false) Boolean inStock) {

        ProductFilter filter = ProductFilter.builder()
            .category(category)
            .minPrice(minPrice)
            .maxPrice(maxPrice)
            .inStock(inStock)
            .build();

        List<Product> products = productService.filter(filter);

        return ResponseEntity.ok(
            products.stream()
                .map(ProductDto::from)
                .collect(Collectors.toList())
        );
    }

    /**
     * æ¥æ”¶é™£åˆ—åƒæ•¸
     * GET /api/v1/products?ids=1,2,3
     */
    @GetMapping("/batch")
    public ResponseEntity<List<ProductDto>> getProductsByIds(
            @RequestParam List<Long> ids) {

        List<Product> products = productService.findAllById(ids);

        return ResponseEntity.ok(
            products.stream()
                .map(ProductDto::from)
                .collect(Collectors.toList())
        );
    }

    /**
     * ä½¿ç”¨ Map æ¥æ”¶æ‰€æœ‰æŸ¥è©¢åƒæ•¸
     * GET /api/v1/products/search?q=spring&category=book&tag=java
     */
    @GetMapping("/search")
    public ResponseEntity<List<ProductDto>> dynamicSearch(
            @RequestParam Map<String, String> params) {

        List<Product> products = productService.dynamicSearch(params);

        return ResponseEntity.ok(
            products.stream()
                .map(ProductDto::from)
                .collect(Collectors.toList())
        );
    }
}
```

**ä½¿ç”¨å ´æ™¯**:
- ğŸ” **æœå°‹éæ¿¾**: `?keyword=æ‰‹æ©Ÿ&category=é›»å­`
- ğŸ“„ **åˆ†é æ’åº**: `?page=1&size=10&sort=price`
- ğŸ¯ **å¯é¸åƒæ•¸**: ä½¿ç”¨ `required = false` å’Œ `defaultValue`

**åƒæ•¸é…ç½®**:
- `required = true/false`: æ˜¯å¦å¿…éœ€ï¼Œé è¨­ç‚º true
- `defaultValue = "é è¨­å€¼"`: åƒæ•¸ç¼ºå°‘æ™‚çš„é è¨­å€¼
- `name = "åƒæ•¸å"`: åƒæ•¸åç¨±èˆ‡è®Šæ•¸åä¸åŒæ™‚æŒ‡å®š

---

## ğŸ“¦ @RequestBody - è«‹æ±‚é«”åƒæ•¸

### åŸºæœ¬ç”¨æ³•

`@RequestBody` ç”¨æ–¼æ¥æ”¶ HTTP è«‹æ±‚é«”ä¸­çš„ JSON è³‡æ–™ï¼Œè‡ªå‹•ååºåˆ—åŒ–ç‚º Java ç‰©ä»¶ã€‚

```java
// å°æ‡‰ç¯„ä¾‹: chapter2-spring-mvc-api/.../api/UserRestController.java:40

@RestController
@RequestMapping("/api/v1/users")
public class UserRestController {

    /**
     * å»ºç«‹ä½¿ç”¨è€…
     * POST /api/v1/users
     *
     * è«‹æ±‚é«”:
     * {
     *   "username": "john",
     *   "email": "john@example.com",
     *   "password": "password123"
     * }
     */
    @PostMapping
    public ResponseEntity<UserDto> createUser(
            @RequestBody @Valid CreateUserRequest request) {

        User user = userService.create(request);

        URI location = ServletUriComponentsBuilder
            .fromCurrentRequest()
            .path("/{id}")
            .buildAndExpand(user.getId())
            .toUri();

        return ResponseEntity
            .created(location)
            .body(UserDto.from(user));
    }

    /**
     * æ›´æ–°ä½¿ç”¨è€…
     * PUT /api/v1/users/123
     *
     * è«‹æ±‚é«”:
     * {
     *   "username": "john_updated",
     *   "email": "john_updated@example.com"
     * }
     */
    @PutMapping("/{id}")
    public ResponseEntity<UserDto> updateUser(
            @PathVariable Long id,
            @RequestBody @Valid UpdateUserRequest request) {

        User user = userService.update(id, request);
        return ResponseEntity.ok(UserDto.from(user));
    }

    /**
     * éƒ¨åˆ†æ›´æ–°ä½¿ç”¨è€…
     * PATCH /api/v1/users/123
     *
     * è«‹æ±‚é«”:
     * {
     *   "email": "newemail@example.com"
     * }
     */
    @PatchMapping("/{id}")
    public ResponseEntity<UserDto> patchUser(
            @PathVariable Long id,
            @RequestBody Map<String, Object> updates) {

        User user = userService.patch(id, updates);
        return ResponseEntity.ok(UserDto.from(user));
    }
}
```

**DTO è¨­è¨ˆç¯„ä¾‹**:

```java
// å°æ‡‰ç¯„ä¾‹: chapter2-spring-mvc-api/.../dto/CreateUserRequest.java

/**
 * å»ºç«‹ä½¿ç”¨è€…è«‹æ±‚ DTO
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class CreateUserRequest {

    @NotBlank(message = "ä½¿ç”¨è€…åç¨±ä¸èƒ½ç‚ºç©º")
    @Size(min = 3, max = 20, message = "ä½¿ç”¨è€…åç¨±é•·åº¦å¿…é ˆåœ¨ 3-20 ä¹‹é–“")
    private String username;

    @NotBlank(message = "ä¿¡ç®±ä¸èƒ½ç‚ºç©º")
    @Email(message = "ä¿¡ç®±æ ¼å¼ä¸æ­£ç¢º")
    private String email;

    @NotBlank(message = "å¯†ç¢¼ä¸èƒ½ç‚ºç©º")
    @Size(min = 6, message = "å¯†ç¢¼é•·åº¦è‡³å°‘ 6 ä½")
    private String password;

    @Pattern(regexp = "^09\\d{8}$", message = "æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼ä¸æ­£ç¢º")
    private String phone;
}
```

**ä½¿ç”¨å ´æ™¯**:
- ğŸ“ **å»ºç«‹è³‡æº**: POST è«‹æ±‚æ”œå¸¶å®Œæ•´ç‰©ä»¶
- âœï¸ **æ›´æ–°è³‡æº**: PUT/PATCH è«‹æ±‚æ”œå¸¶æ›´æ–°è³‡æ–™
- ğŸ”„ **è¤‡é›œæ“ä½œ**: éœ€è¦å‚³éçµæ§‹åŒ–è³‡æ–™æ™‚

> ğŸ’¡ **é‡é»**: `@RequestBody` æœƒè‡ªå‹•èª¿ç”¨ Jackson å°‡ JSON è½‰æ›ç‚º Java ç‰©ä»¶ï¼Œä¸¦æ”¯æ´ `@Valid` é€²è¡Œè³‡æ–™é©—è­‰ã€‚

---

## ğŸ” @RequestHeader - è«‹æ±‚æ¨™é ­

### åŸºæœ¬ç”¨æ³•

`@RequestHeader` ç”¨æ–¼ç²å– HTTP è«‹æ±‚æ¨™é ­ä¸­çš„è³‡è¨Šï¼Œå¸¸ç”¨æ–¼èªè­‰ã€è¿½è¹¤ç­‰å ´æ™¯ã€‚

```java
// å°æ‡‰ç¯„ä¾‹: chapter2-spring-mvc-api/.../api/AuthController.java

@RestController
@RequestMapping("/api/v1")
public class AuthController {

    /**
     * ç²å–ç•¶å‰ä½¿ç”¨è€…è³‡è¨Š
     * GET /api/v1/me
     * Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
     */
    @GetMapping("/me")
    public ResponseEntity<UserDto> getCurrentUser(
            @RequestHeader("Authorization") String authorization) {

        // æå– JWT Token
        String token = authorization.replace("Bearer ", "");
        Long userId = jwtService.getUserIdFromToken(token);

        User user = userService.findById(userId);
        return ResponseEntity.ok(UserDto.from(user));
    }

    /**
     * ç²å–å¤šå€‹æ¨™é ­è³‡è¨Š
     * ç”¨æ–¼è¿½è¹¤å’Œæ—¥èªŒè¨˜éŒ„
     */
    @PostMapping("/api/v1/logs")
    public ResponseEntity<Void> logRequest(
            @RequestHeader("User-Agent") String userAgent,
            @RequestHeader(value = "X-Request-ID", required = false) String requestId,
            @RequestHeader(value = "X-Forwarded-For", required = false) String clientIp,
            @RequestBody LogRequest request) {

        logService.log(
            LogEntry.builder()
                .requestId(requestId)
                .userAgent(userAgent)
                .clientIp(clientIp)
                .request(request)
                .build()
        );

        return ResponseEntity.ok().build();
    }

    /**
     * ä½¿ç”¨ Map æ¥æ”¶æ‰€æœ‰æ¨™é ­
     */
    @GetMapping("/debug/headers")
    public ResponseEntity<Map<String, String>> getAllHeaders(
            @RequestHeader Map<String, String> headers) {

        return ResponseEntity.ok(headers);
    }
}
```

**å¸¸ç”¨è«‹æ±‚æ¨™é ­**:
- `Authorization`: èªè­‰è³‡è¨Šï¼ˆå¦‚ JWT Tokenï¼‰
- `Content-Type`: è«‹æ±‚é«”é¡å‹ï¼ˆå¦‚ `application/json`ï¼‰
- `Accept`: æœŸæœ›çš„å›æ‡‰é¡å‹
- `User-Agent`: å®¢æˆ¶ç«¯è³‡è¨Š
- `X-Request-ID`: è«‹æ±‚è¿½è¹¤ ID

---

## ğŸ¨ çµ±ä¸€å›æ‡‰æ ¼å¼è¨­è¨ˆ

### ç‚ºä»€éº¼éœ€è¦çµ±ä¸€å›æ‡‰æ ¼å¼ï¼Ÿ

**å•é¡Œåˆ†æ**:

```mermaid
graph TB
    Problem[å›æ‡‰æ ¼å¼å•é¡Œ]

    Problem --> P1[æ ¼å¼ä¸ä¸€è‡´<br/>ä¸åŒ API å›æ‡‰çµæ§‹ä¸åŒ]
    Problem --> P2[éŒ¯èª¤è¨Šæ¯æ··äº‚<br/>éŒ¯èª¤æ ¼å¼ä¸çµ±ä¸€]
    Problem --> P3[å®¢æˆ¶ç«¯è™•ç†å›°é›£<br/>éœ€è¦é‡å°æ¯å€‹ API ç‰¹æ®Šè™•ç†]

    Solution[çµ±ä¸€å›æ‡‰æ ¼å¼]

    Solution --> S1[æ¨™æº–åŒ–çµæ§‹<br/>æ‰€æœ‰ API ä½¿ç”¨ç›¸åŒæ ¼å¼]
    Solution --> S2[çµ±ä¸€éŒ¯èª¤è™•ç†<br/>éŒ¯èª¤è¨Šæ¯çµæ§‹ä¸€è‡´]
    Solution --> S3[æ˜“æ–¼ç¶­è­·<br/>å®¢æˆ¶ç«¯çµ±ä¸€è™•ç†]

    style Problem fill:#ffebee
    style Solution fill:#e8f5e9
```

**å‚³çµ±åšæ³•çš„å•é¡Œ**:

```java
// âŒ ä¸åŒ API è¿”å›æ ¼å¼ä¸ä¸€è‡´

// API 1
@GetMapping("/users")
public List<User> getUsers() {
    return userService.findAll();  // ç›´æ¥è¿”å› List
}

// API 2
@GetMapping("/products")
public Map<String, Object> getProducts() {
    Map<String, Object> result = new HashMap<>();
    result.put("data", productService.findAll());
    result.put("count", productService.count());
    return result;  // è¿”å› Map
}

// API 3 - éŒ¯èª¤æ™‚
@ExceptionHandler(Exception.class)
public String handleError(Exception ex) {
    return ex.getMessage();  // ç›´æ¥è¿”å›å­—ä¸²
}
```

### çµ±ä¸€å›æ‡‰çµæ§‹è¨­è¨ˆ

```java
// å°æ‡‰ç¯„ä¾‹: chapter2-spring-mvc-api/.../dto/ApiResponse.java

/**
 * çµ±ä¸€ API å›æ‡‰æ ¼å¼
 *
 * @param <T> è³‡æ–™é¡å‹
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ApiResponse<T> {

    /**
     * HTTP ç‹€æ…‹ç¢¼
     */
    private int code;

    /**
     * å›æ‡‰è¨Šæ¯
     */
    private String message;

    /**
     * æ¥­å‹™è³‡æ–™
     */
    private T data;

    /**
     * éŒ¯èª¤è©³æƒ…ï¼ˆé©—è­‰éŒ¯èª¤æ™‚ä½¿ç”¨ï¼‰
     */
    private Map<String, String> errors;

    /**
     * æ™‚é–“æˆ³è¨˜
     */
    @Builder.Default
    private long timestamp = System.currentTimeMillis();

    /**
     * æˆåŠŸå›æ‡‰ï¼ˆæœ‰è³‡æ–™ï¼‰
     */
    public static <T> ApiResponse<T> success(T data) {
        return ApiResponse.<T>builder()
            .code(HttpStatus.OK.value())
            .message("æ“ä½œæˆåŠŸ")
            .data(data)
            .build();
    }

    /**
     * æˆåŠŸå›æ‡‰ï¼ˆè‡ªè¨‚è¨Šæ¯ï¼‰
     */
    public static <T> ApiResponse<T> success(String message, T data) {
        return ApiResponse.<T>builder()
            .code(HttpStatus.OK.value())
            .message(message)
            .data(data)
            .build();
    }

    /**
     * å¤±æ•—å›æ‡‰
     */
    public static <T> ApiResponse<T> error(int code, String message) {
        return ApiResponse.<T>builder()
            .code(code)
            .message(message)
            .build();
    }

    /**
     * é©—è­‰å¤±æ•—å›æ‡‰
     */
    public static <T> ApiResponse<T> validationError(
            String message,
            Map<String, String> errors) {

        return ApiResponse.<T>builder()
            .code(HttpStatus.UNPROCESSABLE_ENTITY.value())
            .message(message)
            .errors(errors)
            .build();
    }
}
```

### ä½¿ç”¨çµ±ä¸€å›æ‡‰

```java
// å°æ‡‰ç¯„ä¾‹: chapter2-spring-mvc-api/.../api/UserRestController.java:50

@RestController
@RequestMapping("/api/v1/users")
public class UserRestController {

    /**
     * æŸ¥è©¢ä½¿ç”¨è€…åˆ—è¡¨
     */
    @GetMapping
    public ApiResponse<List<UserDto>> getUsers() {
        List<User> users = userService.findAll();
        List<UserDto> dtos = users.stream()
            .map(UserDto::from)
            .collect(Collectors.toList());

        return ApiResponse.success("æŸ¥è©¢æˆåŠŸï¼Œå…± " + dtos.size() + " ç­†", dtos);
    }

    /**
     * æŸ¥è©¢å–®ä¸€ä½¿ç”¨è€…
     */
    @GetMapping("/{id}")
    public ApiResponse<UserDto> getUser(@PathVariable Long id) {
        User user = userService.findById(id);
        return ApiResponse.success(UserDto.from(user));
    }

    /**
     * å»ºç«‹ä½¿ç”¨è€…
     */
    @PostMapping
    public ApiResponse<UserDto> createUser(
            @RequestBody @Valid CreateUserRequest request) {

        User user = userService.create(request);
        return ApiResponse.success("å»ºç«‹æˆåŠŸ", UserDto.from(user));
    }
}
```

**å›æ‡‰ç¯„ä¾‹**:

**æˆåŠŸå›æ‡‰**:
```json
{
  "code": 200,
  "message": "æŸ¥è©¢æˆåŠŸ",
  "data": {
    "id": 1,
    "username": "john",
    "email": "john@example.com"
  },
  "errors": null,
  "timestamp": 1698123456789
}
```

**å¤±æ•—å›æ‡‰**:
```json
{
  "code": 404,
  "message": "ä½¿ç”¨è€…ä¸å­˜åœ¨",
  "data": null,
  "errors": {
    "userId": "æ‰¾ä¸åˆ° ID ç‚º 123 çš„ä½¿ç”¨è€…"
  },
  "timestamp": 1698123456789
}
```

**é©—è­‰å¤±æ•—å›æ‡‰**:
```json
{
  "code": 422,
  "message": "è³‡æ–™é©—è­‰å¤±æ•—",
  "data": null,
  "errors": {
    "username": "ä½¿ç”¨è€…åç¨±ä¸èƒ½ç‚ºç©º",
    "email": "ä¿¡ç®±æ ¼å¼ä¸æ­£ç¢º"
  },
  "timestamp": 1698123456789
}
```

---

## ğŸ›¡ï¸ å…¨åŸŸç•°å¸¸è™•ç†

### ç‚ºä»€éº¼éœ€è¦çµ±ä¸€çš„éŒ¯èª¤è™•ç†ï¼Ÿ

```mermaid
graph TB
    NoHandler[æ²’æœ‰çµ±ä¸€éŒ¯èª¤è™•ç†]
    WithHandler[çµ±ä¸€éŒ¯èª¤è™•ç†]

    NoHandler --> N1[æ¯å€‹ Controller<br/>é‡è¤‡è™•ç†ç•°å¸¸]
    NoHandler --> N2[éŒ¯èª¤æ ¼å¼<br/>ä¸ä¸€è‡´]
    NoHandler --> N3[ç¼ºå°‘éŒ¯èª¤æ—¥èªŒ]
    NoHandler --> N4[å®¢æˆ¶ç«¯é›£ä»¥<br/>çµ±ä¸€è™•ç†]

    WithHandler --> W1[é›†ä¸­å¼<br/>ç•°å¸¸è™•ç†]
    WithHandler --> W2[ä¸€è‡´çš„<br/>éŒ¯èª¤æ ¼å¼]
    WithHandler --> W3[è‡ªå‹•è¨˜éŒ„<br/>éŒ¯èª¤æ—¥èªŒ]
    WithHandler --> W4[æ˜“æ–¼ç¶­è­·<br/>å’Œæ“´å±•]

    style NoHandler fill:#ffebee
    style WithHandler fill:#e8f5e9
```

### å…¨åŸŸç•°å¸¸è™•ç†å™¨å¯¦ç¾

```java
// å°æ‡‰ç¯„ä¾‹: chapter2-spring-mvc-api/.../exception/GlobalExceptionHandler.java

/**
 * å…¨åŸŸç•°å¸¸è™•ç†å™¨
 *
 * çµ±ä¸€è™•ç†æ‰€æœ‰ Controller æ‹‹å‡ºçš„ç•°å¸¸
 */
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    /**
     * è™•ç†è³‡æºä¸å­˜åœ¨ç•°å¸¸
     * 404 Not Found
     */
    @ExceptionHandler(ResourceNotFoundException.class)
    @ResponseStatus(HttpStatus.NOT_FOUND)
    public ApiResponse<Void> handleResourceNotFound(
            ResourceNotFoundException ex) {

        log.error("è³‡æºä¸å­˜åœ¨: {}", ex.getMessage());

        return ApiResponse.error(
            HttpStatus.NOT_FOUND.value(),
            ex.getMessage()
        );
    }

    /**
     * è™•ç†è³‡æºé‡è¤‡ç•°å¸¸
     * 409 Conflict
     */
    @ExceptionHandler(DuplicateResourceException.class)
    @ResponseStatus(HttpStatus.CONFLICT)
    public ApiResponse<Void> handleDuplicateResource(
            DuplicateResourceException ex) {

        log.error("è³‡æºè¡çª: {}", ex.getMessage());

        return ApiResponse.error(
            HttpStatus.CONFLICT.value(),
            ex.getMessage()
        );
    }

    /**
     * è™•ç†è³‡æ–™é©—è­‰ç•°å¸¸
     * 422 Unprocessable Entity
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    @ResponseStatus(HttpStatus.UNPROCESSABLE_ENTITY)
    public ApiResponse<Void> handleValidationErrors(
            MethodArgumentNotValidException ex) {

        Map<String, String> errors = new HashMap<>();

        ex.getBindingResult().getFieldErrors().forEach(error ->
            errors.put(error.getField(), error.getDefaultMessage())
        );

        log.error("è³‡æ–™é©—è­‰å¤±æ•—: {}", errors);

        return ApiResponse.validationError("è³‡æ–™é©—è­‰å¤±æ•—", errors);
    }

    /**
     * è™•ç†è«‹æ±‚åƒæ•¸å‹åˆ¥éŒ¯èª¤
     * 400 Bad Request
     */
    @ExceptionHandler(MethodArgumentTypeMismatchException.class)
    @ResponseStatus(HttpStatus.BAD_REQUEST)
    public ApiResponse<Void> handleTypeMismatch(
            MethodArgumentTypeMismatchException ex) {

        String message = String.format(
            "åƒæ•¸ '%s' çš„å€¼ '%s' å‹åˆ¥éŒ¯èª¤ï¼ŒæœŸæœ›å‹åˆ¥ç‚º %s",
            ex.getName(),
            ex.getValue(),
            ex.getRequiredType().getSimpleName()
        );

        log.error("åƒæ•¸å‹åˆ¥éŒ¯èª¤: {}", message);

        return ApiResponse.error(
            HttpStatus.BAD_REQUEST.value(),
            message
        );
    }

    /**
     * è™•ç†ç¼ºå°‘è«‹æ±‚åƒæ•¸ç•°å¸¸
     * 400 Bad Request
     */
    @ExceptionHandler(MissingServletRequestParameterException.class)
    @ResponseStatus(HttpStatus.BAD_REQUEST)
    public ApiResponse<Void> handleMissingParams(
            MissingServletRequestParameterException ex) {

        String message = String.format(
            "ç¼ºå°‘å¿…éœ€åƒæ•¸: %s (é¡å‹: %s)",
            ex.getParameterName(),
            ex.getParameterType()
        );

        log.error("ç¼ºå°‘è«‹æ±‚åƒæ•¸: {}", message);

        return ApiResponse.error(
            HttpStatus.BAD_REQUEST.value(),
            message
        );
    }

    /**
     * è™•ç† JSON è§£æç•°å¸¸
     * 400 Bad Request
     */
    @ExceptionHandler(HttpMessageNotReadableException.class)
    @ResponseStatus(HttpStatus.BAD_REQUEST)
    public ApiResponse<Void> handleJsonParseError(
            HttpMessageNotReadableException ex) {

        log.error("JSON è§£æå¤±æ•—", ex);

        return ApiResponse.error(
            HttpStatus.BAD_REQUEST.value(),
            "è«‹æ±‚è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è§£æ JSON"
        );
    }

    /**
     * è™•ç†æ¥­å‹™é‚è¼¯ç•°å¸¸
     * 400 Bad Request
     */
    @ExceptionHandler(BusinessException.class)
    @ResponseStatus(HttpStatus.BAD_REQUEST)
    public ApiResponse<Void> handleBusinessException(
            BusinessException ex) {

        log.error("æ¥­å‹™ç•°å¸¸: {}", ex.getMessage());

        return ApiResponse.error(
            ex.getCode(),
            ex.getMessage()
        );
    }

    /**
     * è™•ç†é€šç”¨ç•°å¸¸
     * 500 Internal Server Error
     *
     * æ³¨æ„ï¼šä¸è¦æ´©æ¼ç³»çµ±å…§éƒ¨è³‡è¨Š
     */
    @ExceptionHandler(Exception.class)
    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
    public ApiResponse<Void> handleGenericException(Exception ex) {
        log.error("ç³»çµ±ç•°å¸¸", ex);

        // ç”Ÿç”¢ç’°å¢ƒä¸è¦è¿”å›å…·é«”éŒ¯èª¤è¨Šæ¯
        String message = "ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦";

        // é–‹ç™¼ç’°å¢ƒå¯ä»¥è¿”å›è©³ç´°è¨Šæ¯
        if (isDevelopmentMode()) {
            message = ex.getMessage();
        }

        return ApiResponse.error(
            HttpStatus.INTERNAL_SERVER_ERROR.value(),
            message
        );
    }

    private boolean isDevelopmentMode() {
        // åˆ¤æ–·æ˜¯å¦ç‚ºé–‹ç™¼ç’°å¢ƒ
        return false;  // å¯¦éš›æ‡‰å¾é…ç½®ä¸­è®€å–
    }
}
```

### è‡ªè¨‚ç•°å¸¸é¡åˆ¥

```java
// å°æ‡‰ç¯„ä¾‹: chapter2-spring-mvc-api/.../exception/ResourceNotFoundException.java

/**
 * è³‡æºä¸å­˜åœ¨ç•°å¸¸
 */
public class ResourceNotFoundException extends RuntimeException {

    private final String resourceName;
    private final String fieldName;
    private final Object fieldValue;

    public ResourceNotFoundException(
            String resourceName,
            String fieldName,
            Object fieldValue) {

        super(String.format(
            "%s ä¸å­˜åœ¨ï¼Œ%s: %s",
            resourceName,
            fieldName,
            fieldValue
        ));

        this.resourceName = resourceName;
        this.fieldName = fieldName;
        this.fieldValue = fieldValue;
    }

    public ResourceNotFoundException(String message) {
        super(message);
        this.resourceName = null;
        this.fieldName = null;
        this.fieldValue = null;
    }
}
```

```java
// å°æ‡‰ç¯„ä¾‹: chapter2-spring-mvc-api/.../exception/BusinessException.java

/**
 * æ¥­å‹™é‚è¼¯ç•°å¸¸
 */
@Getter
public class BusinessException extends RuntimeException {

    private final int code;

    public BusinessException(String message) {
        super(message);
        this.code = HttpStatus.BAD_REQUEST.value();
    }

    public BusinessException(int code, String message) {
        super(message);
        this.code = code;
    }

    public BusinessException(HttpStatus status, String message) {
        super(message);
        this.code = status.value();
    }
}
```

---

## ğŸ“Š HTTP ç‹€æ…‹ç¢¼æœ€ä½³å¯¦è¸

### æ­£ç¢ºä½¿ç”¨ç¯„ä¾‹

```java
// å°æ‡‰ç¯„ä¾‹: chapter2-spring-mvc-api/.../api/ProductRestController.java

@RestController
@RequestMapping("/api/v1/products")
public class ProductRestController {

    // 200 OK - æŸ¥è©¢æˆåŠŸ
    @GetMapping("/{id}")
    public ResponseEntity<ProductDto> getProduct(@PathVariable Long id) {
        return ResponseEntity.ok(productService.findById(id));
    }

    // 201 Created - å»ºç«‹æˆåŠŸï¼Œè¿”å› Location æ¨™é ­
    @PostMapping
    public ResponseEntity<ProductDto> createProduct(
            @RequestBody @Valid CreateProductRequest request) {

        Product product = productService.create(request);

        URI location = ServletUriComponentsBuilder
            .fromCurrentRequest()
            .path("/{id}")
            .buildAndExpand(product.getId())
            .toUri();

        return ResponseEntity
            .status(HttpStatus.CREATED)
            .location(location)
            .body(ProductDto.from(product));
    }

    // 204 No Content - åˆªé™¤æˆåŠŸï¼Œç„¡å›æ‡‰é«”
    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteProduct(@PathVariable Long id) {
        productService.delete(id);
        return ResponseEntity.noContent().build();
    }

    // 400 Bad Request - é€é @Valid è‡ªå‹•è™•ç†
    // 404 Not Found - é€é GlobalExceptionHandler è™•ç†
    // 500 Internal Server Error - é€é GlobalExceptionHandler è™•ç†
}
```

### ç‹€æ…‹ç¢¼é¸æ“‡æµç¨‹

```mermaid
graph TD
    Start[é–‹å§‹]

    Start --> Success{æ“ä½œæˆåŠŸ?}

    Success -->|æ˜¯| GetOrUpdate{GET/PUT/PATCH?}
    Success -->|å¦| Error{éŒ¯èª¤é¡å‹?}

    GetOrUpdate -->|æ˜¯| Return200[200 OK]
    GetOrUpdate -->|å¦| Post{POST?}

    Post -->|æ˜¯| Return201[201 Created<br/>+ Location]
    Post -->|å¦| Delete{DELETE?}

    Delete -->|æ˜¯| Return204[204 No Content]
    Delete -->|å¦| Return200

    Error --> ClientError{å®¢æˆ¶ç«¯éŒ¯èª¤?}

    ClientError -->|åƒæ•¸éŒ¯èª¤| Return400[400 Bad Request]
    ClientError -->|é©—è­‰å¤±æ•—| Return422[422 Unprocessable Entity]
    ClientError -->|æœªèªè­‰| Return401[401 Unauthorized]
    ClientError -->|ç„¡æ¬Šé™| Return403[403 Forbidden]
    ClientError -->|è³‡æºä¸å­˜åœ¨| Return404[404 Not Found]
    ClientError -->|è³‡æºè¡çª| Return409[409 Conflict]
    ClientError -->|ç³»çµ±éŒ¯èª¤| Return500[500 Internal Server Error]

    style Return200 fill:#66bb6a,color:#fff
    style Return201 fill:#66bb6a,color:#fff
    style Return204 fill:#66bb6a,color:#fff
    style Return400 fill:#ff9800,color:#fff
    style Return401 fill:#ff9800,color:#fff
    style Return403 fill:#ff9800,color:#fff
    style Return404 fill:#ff9800,color:#fff
    style Return409 fill:#ff9800,color:#fff
    style Return422 fill:#ff9800,color:#fff
    style Return500 fill:#f44336,color:#fff
```

---

## ğŸ“ æœ¬ç¯€é‡é»å›é¡§

### æ ¸å¿ƒçŸ¥è­˜é»

1. **åƒæ•¸è¨»è§£** - æŒæ¡ @PathVariableã€@RequestParamã€@RequestBodyã€@RequestHeader çš„ä½¿ç”¨
2. **çµ±ä¸€å›æ‡‰** - è¨­è¨ˆæ¨™æº–åŒ–çš„ ApiResponse çµæ§‹
3. **ç•°å¸¸è™•ç†** - ä½¿ç”¨ @RestControllerAdvice çµ±ä¸€è™•ç†ç•°å¸¸
4. **ç‹€æ…‹ç¢¼** - æ­£ç¢ºä½¿ç”¨ HTTP ç‹€æ…‹ç¢¼è¡¨é”ä¸åŒæƒ…å¢ƒ
5. **æœ€ä½³å¯¦è¸** - å»ºç«‹ä¸€è‡´ã€å¯ç¶­è­·çš„ API è¨­è¨ˆè¦ç¯„

### æŠ€è¡“è¦é»

- âœ… @PathVariable ç”¨æ–¼ RESTful è³‡æºè­˜åˆ¥
- âœ… @RequestParam æ”¯æ´ required å’Œ defaultValue é…ç½®
- âœ… @RequestBody è‡ªå‹•èª¿ç”¨ Jackson ååºåˆ—åŒ– JSON
- âœ… çµ±ä¸€å›æ‡‰æ ¼å¼ä¾¿æ–¼å®¢æˆ¶ç«¯è™•ç†
- âœ… å…¨åŸŸç•°å¸¸è™•ç†é›†ä¸­ç®¡ç†éŒ¯èª¤
- âœ… è‡ªè¨‚ç•°å¸¸é¡åˆ¥æé«˜ç¨‹å¼ç¢¼å¯è®€æ€§
- âœ… æ­£ç¢ºä½¿ç”¨ HTTP ç‹€æ…‹ç¢¼è¡¨é”æ“ä½œçµæœ

---

## ğŸš€ ä¸‹ä¸€æ­¥

ğŸ‘‰ [ç¬¬3ç« ï¼šä¼æ¥­ç´šåŠŸèƒ½](../chapter3/3.1-validation-error-handling.md) - æ·±å…¥å­¸ç¿’è³‡æ–™é©—è­‰å’Œé€²éšéŒ¯èª¤è™•ç†

---

## ğŸ“š åƒè€ƒè³‡æº

**å®˜æ–¹æ–‡ä»¶**:
- [Spring MVC Request Mapping](https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-ann-requestmapping)
- [Spring Exception Handling](https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc-ann-exceptionhandler)

**ç¯„ä¾‹ç¨‹å¼ç¢¼**:
- [å®Œæ•´å°ˆæ¡ˆç¨‹å¼ç¢¼](../../code-examples/chapter2-spring-mvc-api)
- [UserRestController.java](../../code-examples/chapter2-spring-mvc-api/src/main/java/com/example/api/UserRestController.java)
- [ApiResponse.java](../../code-examples/chapter2-spring-mvc-api/src/main/java/com/example/dto/ApiResponse.java)
- [GlobalExceptionHandler.java](../../code-examples/chapter2-spring-mvc-api/src/main/java/com/example/exception/GlobalExceptionHandler.java)

---

**ç›¸é—œç« ç¯€**:
- â† ä¸Šä¸€ç« : [2.2 RESTful API è¨­è¨ˆåŸå‰‡](./2.2-restful-api-design.md)
- â†’ ä¸‹ä¸€ç« : [ç¬¬3ç« ï¼šä¼æ¥­ç´šåŠŸèƒ½](../chapter3/3.1-validation-error-handling.md)
