# 2.3 API è«‹æ±‚èˆ‡å›æ‡‰è™•ç†

> **å­¸ç¿’é‡é»**ï¼šæŒæ¡è«‹æ±‚åƒæ•¸è™•ç†ã€çµ±ä¸€å›æ‡‰æ ¼å¼è¨­è¨ˆå’ŒéŒ¯èª¤è™•ç†æ©Ÿåˆ¶

---

## 2.3.1 è«‹æ±‚åƒæ•¸è™•ç†

### Spring MVC åƒæ•¸è¨»è§£æ¦‚è¦½

| è¨»è§£ | ç”¨é€” | è³‡æ–™ä¾†æº | é©ç”¨å ´æ™¯ |
|------|------|----------|----------|
| **@PathVariable** | è·¯å¾‘åƒæ•¸ | URL è·¯å¾‘ | RESTful è³‡æºè­˜åˆ¥ |
| **@RequestParam** | æŸ¥è©¢åƒæ•¸ | URL æŸ¥è©¢å­—ä¸² | æœå°‹æ¢ä»¶ã€åˆ†é åƒæ•¸ |
| **@RequestBody** | è«‹æ±‚é«”åƒæ•¸ | HTTP è«‹æ±‚é«” | JSON ç‰©ä»¶ã€è¤‡é›œè³‡æ–™ |
| **@RequestHeader** | è«‹æ±‚æ¨™é ­ | HTTP æ¨™é ­ | èªè­‰è³‡è¨Šã€å®¢æˆ¶ç«¯è³‡è¨Š |

### @PathVariable - è·¯å¾‘åƒæ•¸

```java
@RestController
@RequestMapping("/api/users")
public class UserController {

    // å–®ä¸€è·¯å¾‘åƒæ•¸
    @GetMapping("/{id}")
    public ResponseEntity<User> getUser(@PathVariable Long id) {
        User user = userService.findById(id);
        return ResponseEntity.ok(user);
    }

    // å¤šå€‹è·¯å¾‘åƒæ•¸
    @GetMapping("/{userId}/orders/{orderId}")
    public ResponseEntity<Order> getUserOrder(
            @PathVariable Long userId,
            @PathVariable Long orderId) {
        Order order = orderService.findByUserIdAndOrderId(userId, orderId);
        return ResponseEntity.ok(order);
    }
}
```

**ä½¿ç”¨å ´æ™¯**ï¼š
- ğŸ” è­˜åˆ¥ç‰¹å®šè³‡æºï¼š`/users/123`
- ğŸ”— è¡¨é”è³‡æºé—œè¯ï¼š`/users/123/orders/456`
- ğŸ“¦ RESTful è·¯ç”±è¨­è¨ˆ

### @RequestParam - æŸ¥è©¢åƒæ•¸

```java
@RestController
@RequestMapping("/api/products")
public class ProductController {

    // æœå°‹èˆ‡åˆ†é 
    @GetMapping
    public ResponseEntity<Page<Product>> searchProducts(
            @RequestParam(required = false) String keyword,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size,
            @RequestParam(defaultValue = "id") String sort) {

        Pageable pageable = PageRequest.of(page, size, Sort.by(sort));
        Page<Product> products = productService.search(keyword, pageable);
        return ResponseEntity.ok(products);
    }

    // è¤‡é›œæŸ¥è©¢æ¢ä»¶
    @GetMapping("/filter")
    public ResponseEntity<List<Product>> filterProducts(
            @RequestParam String category,
            @RequestParam(required = false) Integer minPrice,
            @RequestParam(required = false) Integer maxPrice) {

        List<Product> products = productService.filter(category, minPrice, maxPrice);
        return ResponseEntity.ok(products);
    }
}
```

**ä½¿ç”¨å ´æ™¯**ï¼š
- ğŸ” æœå°‹éæ¿¾ï¼š`?keyword=æ‰‹æ©Ÿ&category=é›»å­`
- ğŸ“„ åˆ†é æ’åºï¼š`?page=1&size=10&sort=price`
- ğŸ¯ å¯é¸åƒæ•¸ï¼šä½¿ç”¨ `required = false` å’Œ `defaultValue`

### @RequestBody - è«‹æ±‚é«”åƒæ•¸

```java
@RestController
@RequestMapping("/api/users")
public class UserController {

    // å»ºç«‹ä½¿ç”¨è€…
    @PostMapping
    public ResponseEntity<User> createUser(@RequestBody CreateUserRequest request) {
        User user = userService.create(request);
        return ResponseEntity
                .created(URI.create("/api/users/" + user.getId()))
                .body(user);
    }

    // æ›´æ–°ä½¿ç”¨è€…
    @PutMapping("/{id}")
    public ResponseEntity<User> updateUser(
            @PathVariable Long id,
            @RequestBody UpdateUserRequest request) {
        User user = userService.update(id, request);
        return ResponseEntity.ok(user);
    }
}
```

**ä½¿ç”¨å ´æ™¯**ï¼š
- ğŸ“ å»ºç«‹è³‡æºï¼šPOST è«‹æ±‚æ”œå¸¶å®Œæ•´ç‰©ä»¶
- âœï¸ æ›´æ–°è³‡æºï¼šPUT/PATCH è«‹æ±‚æ”œå¸¶æ›´æ–°è³‡æ–™
- ğŸ”„ è¤‡é›œæ“ä½œï¼šéœ€è¦å‚³éçµæ§‹åŒ–è³‡æ–™æ™‚

> ğŸ’¡ **é‡é»**ï¼š@RequestBody æœƒè‡ªå‹•å°‡ JSON è½‰æ›ç‚º Java ç‰©ä»¶

> ğŸ“ **å®Œæ•´ç¯„ä¾‹**ï¼šåƒè€ƒ [code-examples/chapter2-spring-mvc-api/src/main/java/com/example/springmvc/controller/](../../code-examples/chapter2-spring-mvc-api/src/main/java/com/example/springmvc/controller/)

---

## 2.3.2 çµ±ä¸€å›æ‡‰æ ¼å¼è¨­è¨ˆ

### ç‚ºä»€éº¼éœ€è¦çµ±ä¸€å›æ‡‰æ ¼å¼ï¼Ÿ

**å•é¡Œ**ï¼š
- ä¸åŒ API å›æ‡‰æ ¼å¼ä¸ä¸€è‡´
- éŒ¯èª¤è¨Šæ¯çµæ§‹æ··äº‚
- å®¢æˆ¶ç«¯é›£ä»¥çµ±ä¸€è™•ç†

**è§£æ±ºæ–¹æ¡ˆ**ï¼šè¨­è¨ˆçµ±ä¸€çš„ API å›æ‡‰åŒ…è£é¡

### çµ±ä¸€å›æ‡‰çµæ§‹

```java
/**
 * çµ±ä¸€ API å›æ‡‰æ ¼å¼
 */
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class ApiResponse<T> {

    // HTTP ç‹€æ…‹ç¢¼
    private int code;

    // å›æ‡‰è¨Šæ¯
    private String message;

    // æ¥­å‹™è³‡æ–™
    private T data;

    // éŒ¯èª¤è©³æƒ…ï¼ˆå¯é¸ï¼‰
    private Map<String, String> errors;

    // æ™‚é–“æˆ³è¨˜
    private long timestamp;

    // éœæ…‹å·¥å» æ–¹æ³• - æˆåŠŸå›æ‡‰
    public static <T> ApiResponse<T> success(String message, T data) {
        return ApiResponse.<T>builder()
                .code(HttpStatus.OK.value())
                .message(message)
                .data(data)
                .timestamp(System.currentTimeMillis())
                .build();
    }

    // éœæ…‹å·¥å» æ–¹æ³• - éŒ¯èª¤å›æ‡‰
    public static <T> ApiResponse<T> error(int code, String message) {
        return ApiResponse.<T>builder()
                .code(code)
                .message(message)
                .timestamp(System.currentTimeMillis())
                .build();
    }
}
```

### ä½¿ç”¨çµ±ä¸€å›æ‡‰

```java
@RestController
@RequestMapping("/api/users")
public class UserController {

    // æˆåŠŸå›æ‡‰
    @GetMapping("/{id}")
    public ApiResponse<User> getUser(@PathVariable Long id) {
        User user = userService.findById(id);
        return ApiResponse.success("æŸ¥è©¢æˆåŠŸ", user);
    }

    // åˆ—è¡¨å›æ‡‰
    @GetMapping
    public ApiResponse<List<User>> getUsers() {
        List<User> users = userService.findAll();
        return ApiResponse.success("æŸ¥è©¢æˆåŠŸï¼Œå…± " + users.size() + " ç­†", users);
    }

    // å»ºç«‹å›æ‡‰
    @PostMapping
    public ApiResponse<User> createUser(@RequestBody CreateUserRequest request) {
        User user = userService.create(request);
        return ApiResponse.success("å»ºç«‹æˆåŠŸ", user);
    }
}
```

**å›æ‡‰ç¯„ä¾‹**ï¼š

æˆåŠŸå›æ‡‰ï¼š
```json
{
  "code": 200,
  "message": "æŸ¥è©¢æˆåŠŸ",
  "data": {
    "id": 1,
    "username": "john",
    "email": "john@example.com"
  },
  "timestamp": 1698123456789
}
```

éŒ¯èª¤å›æ‡‰ï¼š
```json
{
  "code": 404,
  "message": "ä½¿ç”¨è€…ä¸å­˜åœ¨",
  "data": null,
  "errors": {
    "userId": "æ‰¾ä¸åˆ° ID ç‚º 123 çš„ä½¿ç”¨è€…"
  },
  "timestamp": 1698123456789
}
```

> ğŸ“ **å®Œæ•´å¯¦ä½œ**ï¼šåƒè€ƒ [code-examples/chapter2-spring-mvc-api/src/main/java/com/example/springmvc/dto/](../../code-examples/chapter2-spring-mvc-api/src/main/java/com/example/springmvc/dto/)

---

## 2.3.3 éŒ¯èª¤è™•ç†æ¦‚è¿°

### ç‚ºä»€éº¼éœ€è¦çµ±ä¸€çš„éŒ¯èª¤è™•ç†ï¼Ÿ

åœ¨ API é–‹ç™¼ä¸­ï¼ŒéŒ¯èª¤è™•ç†å’Œæ­£å¸¸å›æ‡‰åŒæ¨£é‡è¦ï¼š

**æ²’æœ‰çµ±ä¸€éŒ¯èª¤è™•ç†çš„å•é¡Œ**ï¼š
- âŒ æ¯å€‹æ§åˆ¶å™¨éƒ½è¦é‡è¤‡è™•ç†ç•°å¸¸
- âŒ éŒ¯èª¤å›æ‡‰æ ¼å¼ä¸ä¸€è‡´
- âŒ ç¼ºå°‘éŒ¯èª¤æ—¥èªŒè¨˜éŒ„
- âŒ å®¢æˆ¶ç«¯é›£ä»¥çµ±ä¸€è™•ç†éŒ¯èª¤

**çµ±ä¸€éŒ¯èª¤è™•ç†çš„å„ªå‹¢**ï¼š
- âœ… é›†ä¸­å¼ç•°å¸¸è™•ç†é‚è¼¯
- âœ… ä¸€è‡´çš„éŒ¯èª¤å›æ‡‰æ ¼å¼
- âœ… è‡ªå‹•è¨˜éŒ„éŒ¯èª¤æ—¥èªŒ
- âœ… æ˜“æ–¼ç¶­è­·å’Œæ“´å±•

### @RestControllerAdvice æ ¸å¿ƒæ¦‚å¿µ

Spring æä¾› `@RestControllerAdvice` è¨»è§£ä¾†å¯¦ç¾å…¨åŸŸç•°å¸¸è™•ç†ï¼š

```java
/**
 * å…¨åŸŸç•°å¸¸è™•ç†å™¨ï¼ˆæ¦‚å¿µç¤ºç¯„ï¼‰
 */
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    // è™•ç†è³‡æºä¸å­˜åœ¨ç•°å¸¸
    @ExceptionHandler(ResourceNotFoundException.class)
    @ResponseStatus(HttpStatus.NOT_FOUND)
    public ApiResponse<Void> handleResourceNotFound(ResourceNotFoundException ex) {
        log.error("è³‡æºä¸å­˜åœ¨: {}", ex.getMessage());
        return ApiResponse.error(404, ex.getMessage());
    }

    // è™•ç†é€šç”¨ç•°å¸¸
    @ExceptionHandler(Exception.class)
    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
    public ApiResponse<Void> handleGenericException(Exception ex) {
        log.error("ç³»çµ±ç•°å¸¸", ex);
        return ApiResponse.error(500, "ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
    }
}
```

**æ ¸å¿ƒæ©Ÿåˆ¶**ï¼š
1. `@RestControllerAdvice` - æ¨™è¨˜å…¨åŸŸç•°å¸¸è™•ç†å™¨
2. `@ExceptionHandler` - æŒ‡å®šè¦è™•ç†çš„ç•°å¸¸é¡å‹
3. `@ResponseStatus` - è¨­å®š HTTP ç‹€æ…‹ç¢¼

### éŒ¯èª¤å›æ‡‰ç¯„ä¾‹

ä½¿ç”¨çµ±ä¸€çš„ ApiResponse æ ¼å¼å›å‚³éŒ¯èª¤ï¼š

```json
{
  "code": 404,
  "message": "ä½¿ç”¨è€…ä¸å­˜åœ¨",
  "data": null,
  "errors": {
    "userId": "æ‰¾ä¸åˆ° ID ç‚º 123 çš„ä½¿ç”¨è€…"
  },
  "timestamp": 1698123456789
}
```

> ğŸ’¡ **é€²éšå­¸ç¿’**ï¼šæœ¬ç¯€åªä»‹ç´¹éŒ¯èª¤è™•ç†çš„åŸºæœ¬æ¦‚å¿µã€‚å®Œæ•´çš„ä¼æ¥­ç´šéŒ¯èª¤è™•ç†å¯¦ä½œï¼ˆåŒ…å«è³‡æ–™é©—è­‰ã€è‡ªè¨‚ç•°å¸¸ã€è©³ç´°éŒ¯èª¤è™•ç†ç­‰ï¼‰è«‹åƒè€ƒ [ç¬¬3ç« ï¼š3.1 è³‡æ–™é©—è­‰èˆ‡éŒ¯èª¤è™•ç†](../chapter3/3.1-validation-error-handling.md)

> ğŸ“ **ç¨‹å¼ç¢¼åƒè€ƒ**ï¼šåŸºæœ¬å¯¦ä½œè«‹åƒè€ƒ [code-examples/chapter2-spring-mvc-api/src/main/java/com/example/springmvc/exception/](../../code-examples/chapter2-spring-mvc-api/src/main/java/com/example/springmvc/exception/)

---

## 2.3.4 HTTP ç‹€æ…‹ç¢¼æœ€ä½³å¯¦è¸

### å¸¸ç”¨ç‹€æ…‹ç¢¼å°ç…§

| ç‹€æ…‹ç¢¼ | èªªæ˜ | ä½¿ç”¨æ™‚æ©Ÿ |
|--------|------|----------|
| **200 OK** | æˆåŠŸ | GETã€PUTã€PATCH æˆåŠŸ |
| **201 Created** | å·²å»ºç«‹ | POST æˆåŠŸå»ºç«‹è³‡æº |
| **204 No Content** | ç„¡å…§å®¹ | DELETE æˆåŠŸã€PUT æˆåŠŸç„¡å›æ‡‰ |
| **400 Bad Request** | éŒ¯èª¤è«‹æ±‚ | è«‹æ±‚åƒæ•¸éŒ¯èª¤ã€é©—è­‰å¤±æ•— |
| **401 Unauthorized** | æœªæˆæ¬Š | éœ€è¦èº«ä»½é©—è­‰ |
| **403 Forbidden** | ç¦æ­¢è¨ªå• | å·²é©—è­‰ä½†æ¬Šé™ä¸è¶³ |
| **404 Not Found** | æ‰¾ä¸åˆ° | è³‡æºä¸å­˜åœ¨ |
| **409 Conflict** | è¡çª | è³‡æºç‹€æ…‹è¡çª |
| **500 Internal Server Error** | ä¼ºæœå™¨éŒ¯èª¤ | ç³»çµ±ç•°å¸¸ |

### æ­£ç¢ºä½¿ç”¨ç¯„ä¾‹

```java
@RestController
@RequestMapping("/api/products")
public class ProductController {

    // 200 OK - æŸ¥è©¢æˆåŠŸ
    @GetMapping("/{id}")
    public ResponseEntity<Product> getProduct(@PathVariable Long id) {
        return ResponseEntity.ok(productService.findById(id));
    }

    // 201 Created - å»ºç«‹æˆåŠŸ
    @PostMapping
    public ResponseEntity<Product> createProduct(@RequestBody Product product) {
        Product created = productService.create(product);
        return ResponseEntity
                .status(HttpStatus.CREATED)
                .location(URI.create("/api/products/" + created.getId()))
                .body(created);
    }

    // 204 No Content - åˆªé™¤æˆåŠŸ
    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteProduct(@PathVariable Long id) {
        productService.delete(id);
        return ResponseEntity.noContent().build();
    }

    // 400 Bad Request - åƒæ•¸éŒ¯èª¤è‡ªå‹•è™•ç†
    // 404 Not Found - é€é GlobalExceptionHandler è™•ç†
    // 500 Internal Server Error - é€é GlobalExceptionHandler è™•ç†
}
```

---

## ğŸ“ æœ¬ç¯€é‡é»

1. âœ… **åƒæ•¸è¨»è§£**ï¼šæŒæ¡ @PathVariableã€@RequestParamã€@RequestBody çš„ä½¿ç”¨
2. âœ… **çµ±ä¸€å›æ‡‰**ï¼šè¨­è¨ˆæ¨™æº–åŒ–çš„ ApiResponse çµæ§‹
3. âœ… **ç•°å¸¸è™•ç†**ï¼šä½¿ç”¨ @RestControllerAdvice çµ±ä¸€è™•ç†ç•°å¸¸
4. âœ… **ç‹€æ…‹ç¢¼**ï¼šæ­£ç¢ºä½¿ç”¨ HTTP ç‹€æ…‹ç¢¼è¡¨é”ä¸åŒæƒ…å¢ƒ
5. âœ… **æœ€ä½³å¯¦è¸**ï¼šå»ºç«‹ä¸€è‡´ã€å¯ç¶­è­·çš„ API è¨­è¨ˆè¦ç¯„

---

## ğŸ”— ç›¸é—œè³‡æº

- **å®Œæ•´ç¨‹å¼ç¢¼**ï¼š[code-examples/chapter2-spring-mvc-api/](../../code-examples/chapter2-spring-mvc-api/)
- **ç•°å¸¸è™•ç†å™¨**ï¼š[GlobalExceptionHandler.java](../../code-examples/chapter2-spring-mvc-api/src/main/java/com/example/springmvc/exception/GlobalExceptionHandler.java)
- **çµ±ä¸€å›æ‡‰é¡**ï¼š[ApiResponse.java](../../code-examples/chapter2-spring-mvc-api/src/main/java/com/example/springmvc/dto/ApiResponse.java)

---

**ä¸Šä¸€ç¯€**ï¼š[2.2 RESTful API è¨­è¨ˆåŸå‰‡](./2.2-restful-api-design.md)
**å›åˆ°ç›®éŒ„**ï¼š[ç¬¬2ç«  README](./README.md)
