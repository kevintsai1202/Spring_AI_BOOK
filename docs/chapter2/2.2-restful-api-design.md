# 2.2 RESTful API è¨­è¨ˆåŸå‰‡

> **å°æ‡‰ç¯„ä¾‹**: `chapter2-spring-mvc-api`
> **é›£åº¦**: â­â­â­â­â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

RESTï¼ˆRepresentational State Transferï¼‰æ˜¯ä¸€ç¨®è»Ÿé«”æ¶æ§‹é¢¨æ ¼ï¼Œå®šç¾©äº†ä¸€çµ„ç´„æŸæ¢ä»¶å’ŒåŸå‰‡ã€‚éµå¾ª RESTful è¨­è¨ˆåŸå‰‡å¯ä»¥å»ºç«‹å‡ºæ˜“æ–¼ç†è§£ã€ç¶­è­·å’Œæ“´å±•çš„ APIã€‚æœ¬ç« å°‡æ·±å…¥æ¢è¨ REST æ¶æ§‹çš„æ ¸å¿ƒåŸå‰‡å’Œå¯¦è¸æ–¹æ³•ã€‚

**å­¸ç¿’ç›®æ¨™**:
- ç†è§£ REST å…­å¤§æ ¸å¿ƒç´„æŸæ¢ä»¶
- æŒæ¡ HTTP æ–¹æ³•çš„èªç¾©åŒ–ä½¿ç”¨
- å­¸æœƒè³‡æºå°å‘çš„ URL è¨­è¨ˆ
- ç†è§£ HTTP ç‹€æ…‹ç¢¼çš„æ­£ç¢ºä½¿ç”¨
- å¯¦ç¾å®Œæ•´çš„ CRUD æ“ä½œ

---

## ğŸ¯ REST æ¶æ§‹ç´„æŸæ¢ä»¶

### REST å…­å¤§æ ¸å¿ƒåŸå‰‡

REST æ¶æ§‹ç”± Roy Fielding åœ¨å…¶åšå£«è«–æ–‡ä¸­æå‡ºï¼Œå®šç¾©äº†å…­å€‹æ ¸å¿ƒç´„æŸæ¢ä»¶ï¼š

```mermaid
graph TD
    REST[REST è¨­è¨ˆåŸå‰‡]

    REST --> P1[è³‡æºå°å‘<br/>Resource-Oriented]
    REST --> P2[çµ±ä¸€ä»‹é¢<br/>Uniform Interface]
    REST --> P3[ç„¡ç‹€æ…‹<br/>Stateless]
    REST --> P4[å¯å¿«å–<br/>Cacheable]
    REST --> P5[åˆ†å±¤ç³»çµ±<br/>Layered System]
    REST --> P6[è¶…åª’é«”é©…å‹•<br/>HATEOAS]

    P1 --> P1A[URI è­˜åˆ¥è³‡æº]
    P1 --> P1B[è³‡æºè¡¨ç¾å½¢å¼]
    P1 --> P1C[JSON/XML]

    P2 --> P2A[HTTP æ¨™æº–æ–¹æ³•]
    P2 --> P2B[GET POST PUT DELETE]
    P2 --> P2C[çµ±ä¸€çš„éŒ¯èª¤è™•ç†]

    P3 --> P3A[æ¯å€‹è«‹æ±‚ç¨ç«‹]
    P3 --> P3B[ä¸ä¾è³´ Session]
    P3 --> P3C[å¯æ“´å±•æ€§å¼·]

    P4 --> P4A[HTTP Cache-Control]
    P4 --> P4B[ETag æ©Ÿåˆ¶]
    P4 --> P4C[æå‡æ•ˆèƒ½]

    P5 --> P5A[å®¢æˆ¶ç«¯-ä¼ºæœå™¨åˆ†é›¢]
    P5 --> P5B[æ”¯æ´ä¸­ä»‹å±¤]
    P5 --> P5C[è² è¼‰å¹³è¡¡]

    P6 --> P6A[è¶…é€£çµå°èˆª]
    P6 --> P6B[API å¯æ¢ç´¢]
    P6 --> P6C[é¬†æ•£è€¦åˆ]

    style REST fill:#ff6b6b,color:#fff
    style P1 fill:#4ecdc4,color:#fff
    style P2 fill:#45b7d1,color:#fff
    style P3 fill:#f9ca24,color:#333
    style P4 fill:#6c5ce7,color:#fff
    style P5 fill:#a29bfe,color:#fff
    style P6 fill:#fd79a8,color:#fff
```

### æ ¸å¿ƒç´„æŸè©³è§£

| ç´„æŸæ¢ä»¶ | èªªæ˜ | å„ªå‹¢ | å¯¦è¸æ–¹å¼ |
|----------|------|------|----------|
| **å®¢æˆ¶ç«¯-ä¼ºæœå™¨** | åˆ†é›¢ä½¿ç”¨è€…ä»‹é¢å’Œè³‡æ–™å„²å­˜ | æé«˜å¯ç§»æ¤æ€§å’Œå¯æ“´å±•æ€§ | å‰å¾Œç«¯åˆ†é›¢æ¶æ§‹ |
| **ç„¡ç‹€æ…‹** | æ¯å€‹è«‹æ±‚åŒ…å«å®Œæ•´è³‡è¨Š | æé«˜å¯è¦‹æ€§ã€å¯é æ€§ã€å¯æ“´å±•æ€§ | ä½¿ç”¨ JWT Token |
| **å¯å¿«å–** | å›æ‡‰å¯æ¨™è¨˜ç‚ºå¯å¿«å– | æé«˜ç¶²è·¯æ•ˆç‡å’Œä½¿ç”¨è€…é«”é©— | Cache-Control æ¨™é ­ |
| **çµ±ä¸€ä»‹é¢** | ä½¿ç”¨çµ±ä¸€çš„ä»‹é¢ç´„æŸ | ç°¡åŒ–æ¶æ§‹ï¼Œæé«˜å¯è¦‹æ€§ | RESTful API è¨­è¨ˆ |
| **åˆ†å±¤ç³»çµ±** | æ¶æ§‹ç”±åˆ†å±¤çµ„æˆ | æé«˜å¯æ“´å±•æ€§å’Œå®‰å…¨æ€§ | è² è¼‰å‡è¡¡ã€API é–˜é“ |
| **è¶…åª’é«”é©…å‹•** | ä½¿ç”¨è¶…é€£çµå°èˆª API | é™ä½è€¦åˆåº¦ | HATEOAS å¯¦ç¾ |

**ç‚ºä»€éº¼è¦éµå¾ª REST åŸå‰‡ï¼Ÿ**
- âœ… **çµ±ä¸€æ¨™æº–**: é™ä½å­¸ç¿’æˆæœ¬å’Œæºé€šæˆæœ¬
- âœ… **å¯æ“´å±•æ€§**: æ”¯æ´å¤§è¦æ¨¡åˆ†æ•£å¼ç³»çµ±
- âœ… **å¯ç¶­è­·æ€§**: æ¸…æ™°çš„æ¶æ§‹å’Œè·è²¬åŠƒåˆ†
- âœ… **å¤šå¹³å°æ”¯æ´**: é©ç”¨æ–¼ Webã€Mobileã€IoT ç­‰å¤šç¨®å®¢æˆ¶ç«¯
- âœ… **å·¥å…·ç”Ÿæ…‹**: è±å¯Œçš„å·¥å…·å’Œæ¡†æ¶æ”¯æ´

> ğŸ’¡ **å¯¦å‹™å»ºè­°**: åœ¨å¯¦éš›é–‹ç™¼ä¸­ï¼Œæˆ‘å€‘é€šå¸¸å¯¦ç¾ REST çš„å‰å››å€‹ç´„æŸï¼ˆå®¢æˆ¶ç«¯-ä¼ºæœå™¨ã€ç„¡ç‹€æ…‹ã€å¯å¿«å–ã€çµ±ä¸€ä»‹é¢ï¼‰ï¼Œè€Œ HATEOASï¼ˆè¶…åª’é«”é©…å‹•ï¼‰åœ¨å¯¦å‹™ä¸­è¼ƒå°‘å®Œå…¨å¯¦ç¾ã€‚

---

## ğŸ”„ HTTP æ–¹æ³•èªç¾©åŒ–ä½¿ç”¨

### HTTP æ–¹æ³•èˆ‡ CRUD å°æ‡‰

HTTP æ–¹æ³•å®šç¾©äº†å°è³‡æºçš„æ“ä½œé¡å‹ã€‚æ­£ç¢ºä½¿ç”¨ HTTP æ–¹æ³•æ˜¯ RESTful API è¨­è¨ˆçš„é—œéµï¼š

```mermaid
flowchart LR
    subgraph "CRUD æ“ä½œ"
        CREATE["ğŸ“ CREATE<br/>(å»ºç«‹)"]
        READ["ğŸ“– READ<br/>(è®€å–)"]
        UPDATE["âœï¸ UPDATE<br/>(æ›´æ–°)"]
        DELETE["ğŸ—‘ï¸ DELETE<br/>(åˆªé™¤)"]
    end

    subgraph "HTTP æ–¹æ³•"
        POST["POST"]
        GET["GET"]
        PUT["PUT"]
        PATCH["PATCH"]
        DEL["DELETE"]
    end

    subgraph "URI ç¯„ä¾‹"
        EX1["/api/users<br/>æ–°å¢ä½¿ç”¨è€…"]
        EX2["/api/users<br/>æŸ¥è©¢æ‰€æœ‰ä½¿ç”¨è€…"]
        EX3["/api/users/1<br/>æŸ¥è©¢å–®ä¸€ä½¿ç”¨è€…"]
        EX4["/api/users/1<br/>å®Œæ•´æ›´æ–°"]
        EX5["/api/users/1<br/>éƒ¨åˆ†æ›´æ–°"]
        EX6["/api/users/1<br/>åˆªé™¤ä½¿ç”¨è€…"]
    end

    CREATE ==>|å°æ‡‰| POST
    READ ==>|å°æ‡‰| GET
    UPDATE ==>|å°æ‡‰| PUT
    UPDATE ==>|å°æ‡‰| PATCH
    DELETE ==>|å°æ‡‰| DEL

    POST --> EX1
    GET --> EX2
    GET --> EX3
    PUT --> EX4
    PATCH --> EX5
    DEL --> EX6

    style CREATE fill:#66bb6a,color:#fff,stroke:#2e7d32,stroke-width:3px
    style READ fill:#42a5f5,color:#fff,stroke:#1565c0,stroke-width:3px
    style UPDATE fill:#ffa726,color:#fff,stroke:#e65100,stroke-width:3px
    style DELETE fill:#ef5350,color:#fff,stroke:#c62828,stroke-width:3px

    style POST fill:#66bb6a,color:#fff
    style GET fill:#42a5f5,color:#fff
    style PUT fill:#ffa726,color:#fff
    style PATCH fill:#ffb74d,color:#fff
    style DEL fill:#ef5350,color:#fff
```

### HTTP æ–¹æ³•ç‰¹æ€§è©³è§£

| HTTP æ–¹æ³• | ç”¨é€” | å†ªç­‰æ€§ | å®‰å…¨æ€§ | è«‹æ±‚ Body | å…¸å‹ä½¿ç”¨å ´æ™¯ |
|-----------|------|--------|--------|-----------|--------------|
| **GET** | ç²å–è³‡æº | âœ… æ˜¯ | âœ… æ˜¯ | âŒ ç„¡ | æŸ¥è©¢è³‡æ–™ã€ç²å–åˆ—è¡¨ |
| **POST** | å»ºç«‹è³‡æº | âŒ å¦ | âŒ å¦ | âœ… æœ‰ | æ–°å¢è³‡æ–™ã€æäº¤è¡¨å–® |
| **PUT** | æ›´æ–°/æ›¿æ›è³‡æº | âœ… æ˜¯ | âŒ å¦ | âœ… æœ‰ | å®Œæ•´æ›´æ–°è³‡æº |
| **PATCH** | éƒ¨åˆ†æ›´æ–°è³‡æº | âŒ å¦* | âŒ å¦ | âœ… æœ‰ | éƒ¨åˆ†æ¬„ä½æ›´æ–° |
| **DELETE** | åˆªé™¤è³‡æº | âœ… æ˜¯ | âŒ å¦ | âŒ ç„¡ | åˆªé™¤è³‡æ–™ |

> **å†ªç­‰æ€§èªªæ˜**: å¤šæ¬¡åŸ·è¡Œç›¸åŒæ“ä½œï¼Œçµæœæ‡‰è©²ç›¸åŒã€‚ä¾‹å¦‚åˆªé™¤åŒä¸€è³‡æºå¤šæ¬¡ï¼Œç¬¬ä¸€æ¬¡æˆåŠŸï¼Œå¾ŒçºŒè¿”å› 404ï¼Œä½†ç³»çµ±ç‹€æ…‹ä¿æŒä¸€è‡´ã€‚

> **å®‰å…¨æ€§èªªæ˜**: ä¸æœƒä¿®æ”¹è³‡æºç‹€æ…‹çš„æ“ä½œç¨±ç‚ºå®‰å…¨æ“ä½œã€‚åªæœ‰ GET æ˜¯å®‰å…¨çš„ã€‚

**PUT vs PATCH çš„é—œéµå·®ç•°**:

```java
// PUT - å®Œæ•´æ›´æ–°ï¼ˆå¿…é ˆæä¾›æ‰€æœ‰æ¬„ä½ï¼‰
PUT /api/users/1
{
  "username": "john",
  "email": "john@example.com",
  "phone": "0912345678",
  "address": "å°åŒ—å¸‚ä¿¡ç¾©å€"
}
// å¦‚æœç¼ºå°‘æŸå€‹æ¬„ä½ï¼Œè©²æ¬„ä½æœƒè¢«è¨­ç‚º null æˆ–é è¨­å€¼

// PATCH - éƒ¨åˆ†æ›´æ–°ï¼ˆåªæ›´æ–°æŒ‡å®šæ¬„ä½ï¼‰
PATCH /api/users/1
{
  "email": "newemail@example.com"
}
// åªæ›´æ–° emailï¼Œå…¶ä»–æ¬„ä½ä¿æŒä¸è®Š
```

---

## ğŸ’» å®Œæ•´ CRUD æ“ä½œå¯¦ç¾

### æ¨™æº– RESTful API è¨­è¨ˆ

```java
// å°æ‡‰ç¯„ä¾‹: chapter2-spring-mvc-api/.../api/UserRestController.java:15

@RestController
@RequestMapping("/api/v1/users")
@RequiredArgsConstructor
public class UserRestController {

    private final UserService userService;
    private final UserMapper userMapper;

    /**
     * æŸ¥è©¢ä½¿ç”¨è€…åˆ—è¡¨ï¼ˆæ”¯æ´åˆ†é å’Œæœå°‹ï¼‰
     * GET /api/v1/users?page=0&size=20&keyword=john
     */
    @GetMapping
    public ResponseEntity<PagedResponse<UserDto>> getUsers(
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size,
            @RequestParam(required = false) String keyword) {

        Page<User> userPage = userService.search(
            keyword,
            PageRequest.of(page, size, Sort.by("createdAt").descending())
        );

        PagedResponse<UserDto> response = PagedResponse.of(
            userPage,
            UserDto::from
        );

        return ResponseEntity.ok(response);
    }

    /**
     * æŸ¥è©¢å–®ä¸€ä½¿ç”¨è€…
     * GET /api/v1/users/{id}
     */
    @GetMapping("/{id}")
    public ResponseEntity<UserDto> getUserById(@PathVariable Long id) {
        User user = userService.findById(id);
        return ResponseEntity.ok(UserDto.from(user));
    }

    /**
     * å»ºç«‹æ–°ä½¿ç”¨è€…
     * POST /api/v1/users
     *
     * è¿”å› 201 Created å’Œ Location æ¨™é ­
     */
    @PostMapping
    public ResponseEntity<UserDto> createUser(
            @RequestBody @Valid CreateUserRequest request) {

        User user = userService.create(request);
        UserDto dto = UserDto.from(user);

        // å»ºç«‹ Location æ¨™é ­ï¼ŒæŒ‡å‘æ–°å»ºç«‹çš„è³‡æº
        URI location = ServletUriComponentsBuilder
            .fromCurrentRequest()
            .path("/{id}")
            .buildAndExpand(user.getId())
            .toUri();

        return ResponseEntity
            .created(location)  // 201 Created
            .body(dto);
    }

    /**
     * å®Œæ•´æ›´æ–°ä½¿ç”¨è€…
     * PUT /api/v1/users/{id}
     *
     * å¿…é ˆæä¾›æ‰€æœ‰æ¬„ä½ï¼Œç¼ºå°‘çš„æ¬„ä½æœƒè¢«æ¸…ç©º
     */
    @PutMapping("/{id}")
    public ResponseEntity<UserDto> updateUser(
            @PathVariable Long id,
            @RequestBody @Valid UpdateUserRequest request) {

        User user = userService.update(id, request);
        return ResponseEntity.ok(UserDto.from(user));
    }

    /**
     * éƒ¨åˆ†æ›´æ–°ä½¿ç”¨è€…
     * PATCH /api/v1/users/{id}
     *
     * åªæ›´æ–°æä¾›çš„æ¬„ä½ï¼Œå…¶ä»–æ¬„ä½ä¿æŒä¸è®Š
     */
    @PatchMapping("/{id}")
    public ResponseEntity<UserDto> patchUser(
            @PathVariable Long id,
            @RequestBody Map<String, Object> updates) {

        User user = userService.patch(id, updates);
        return ResponseEntity.ok(UserDto.from(user));
    }

    /**
     * åˆªé™¤ä½¿ç”¨è€…
     * DELETE /api/v1/users/{id}
     *
     * è¿”å› 204 No Content
     */
    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteUser(@PathVariable Long id) {
        userService.delete(id);
        return ResponseEntity.noContent().build();  // 204 No Content
    }

    /**
     * æ‰¹æ¬¡åˆªé™¤ä½¿ç”¨è€…
     * DELETE /api/v1/users?ids=1,2,3
     */
    @DeleteMapping
    public ResponseEntity<Void> deleteUsers(
            @RequestParam List<Long> ids) {

        userService.deleteAll(ids);
        return ResponseEntity.noContent().build();
    }
}
```

**ç¨‹å¼ç¢¼é‡é»**:
- âœ… **GET ç”¨æ–¼æŸ¥è©¢**: æ”¯æ´åˆ†é ã€æ’åºå’Œæœå°‹
- âœ… **POST è¿”å› 201**: å»ºç«‹è³‡æºå¾Œè¿”å› Created ç‹€æ…‹å’Œ Location æ¨™é ­
- âœ… **PUT å®Œæ•´æ›´æ–°**: å¿…é ˆæä¾›æ‰€æœ‰æ¬„ä½
- âœ… **PATCH éƒ¨åˆ†æ›´æ–°**: åªæ›´æ–°æŒ‡å®šæ¬„ä½
- âœ… **DELETE è¿”å› 204**: åˆªé™¤æˆåŠŸå¾Œè¿”å› No Content
- âœ… **ä½¿ç”¨ @Valid**: è‡ªå‹•é©—è­‰è«‹æ±‚è³‡æ–™

### æœå‹™å±¤å¯¦ç¾ç¯„ä¾‹

```java
// å°æ‡‰ç¯„ä¾‹: chapter2-spring-mvc-api/.../service/UserService.java

@Service
@RequiredArgsConstructor
public class UserService {

    private final UserRepository userRepository;

    /**
     * å»ºç«‹ä½¿ç”¨è€…
     */
    @Transactional
    public User create(CreateUserRequest request) {
        // æª¢æŸ¥ä½¿ç”¨è€…åç¨±æ˜¯å¦å·²å­˜åœ¨
        if (userRepository.existsByUsername(request.getUsername())) {
            throw new DuplicateResourceException("ä½¿ç”¨è€…åç¨±å·²å­˜åœ¨");
        }

        User user = User.builder()
            .username(request.getUsername())
            .email(request.getEmail())
            .phone(request.getPhone())
            .build();

        return userRepository.save(user);
    }

    /**
     * å®Œæ•´æ›´æ–°ä½¿ç”¨è€…
     */
    @Transactional
    public User update(Long id, UpdateUserRequest request) {
        User user = findById(id);

        // PUT å¿…é ˆæ›´æ–°æ‰€æœ‰æ¬„ä½
        user.setUsername(request.getUsername());
        user.setEmail(request.getEmail());
        user.setPhone(request.getPhone());
        user.setAddress(request.getAddress());

        return userRepository.save(user);
    }

    /**
     * éƒ¨åˆ†æ›´æ–°ä½¿ç”¨è€…ï¼ˆä½¿ç”¨åå°„å‹•æ…‹æ›´æ–°ï¼‰
     */
    @Transactional
    public User patch(Long id, Map<String, Object> updates) {
        User user = findById(id);

        // åªæ›´æ–°æä¾›çš„æ¬„ä½
        updates.forEach((key, value) -> {
            switch (key) {
                case "email" -> user.setEmail((String) value);
                case "phone" -> user.setPhone((String) value);
                case "address" -> user.setAddress((String) value);
                // æ•æ„Ÿæ¬„ä½ä¸å…è¨±é€šé PATCH æ›´æ–°
                case "password" -> throw new IllegalArgumentException(
                    "å¯†ç¢¼ä¸èƒ½é€šé PATCH æ›´æ–°"
                );
            }
        });

        return userRepository.save(user);
    }
}
```

> ğŸ“ **å®Œæ•´å¯¦ä½œ**: åƒè€ƒ [code-examples/chapter2-spring-mvc-api/](../../code-examples/chapter2-spring-mvc-api/)

---

## ğŸ¨ URL è¨­è¨ˆè¦ç¯„

### è³‡æºå°å‘å‘½ååŸå‰‡

RESTful API çš„ URL æ‡‰è©²ä»¥**è³‡æº**ç‚ºä¸­å¿ƒï¼Œè€Œä¸æ˜¯å‹•ä½œã€‚

**âœ… å¥½çš„è¨­è¨ˆ**:
```
GET    /api/v1/users              # ä½¿ç”¨è¤‡æ•¸åè©
GET    /api/v1/users/123          # ä½¿ç”¨ ID è­˜åˆ¥è³‡æº
GET    /api/v1/users/123/orders   # ä½¿ç”¨éšå±¤è¡¨ç¤ºé—œè¯
POST   /api/v1/users              # å»ºç«‹ä½¿ç”¨ POST
GET    /api/v1/users?status=active  # ä½¿ç”¨æŸ¥è©¢åƒæ•¸éæ¿¾
```

**âŒ æ‡‰é¿å…çš„è¨­è¨ˆ**:
```
GET    /api/v1/getUsers           # âŒ é¿å…å‹•è©
GET    /api/v1/user               # âŒ é¿å…å–®æ•¸ï¼ˆé™¤éæ˜¯å–®ä¾‹è³‡æºï¼‰
GET    /api/v1/users?action=get   # âŒ é¿å…æŸ¥è©¢åƒæ•¸è¡¨ç¤ºå‹•ä½œ
POST   /api/v1/createUser         # âŒ é¿å…åœ¨ URL ä¸­ä½¿ç”¨å‹•ä½œ
DELETE /api/v1/users/123/delete   # âŒ HTTP æ–¹æ³•å·²è¡¨é”å‹•ä½œ
```

### URL è¨­è¨ˆæ¨¡å¼

**1. é›†åˆè³‡æº vs å–®ä¸€è³‡æº**:
```
/api/v1/users          # é›†åˆè³‡æºï¼ˆè¤‡æ•¸ï¼‰
/api/v1/users/123      # å–®ä¸€è³‡æºï¼ˆä½¿ç”¨ IDï¼‰
```

**2. éšå±¤é—œä¿‚è¡¨ç¤º**:
```
/api/v1/users/123/orders           # ä½¿ç”¨è€…çš„è¨‚å–®
/api/v1/users/123/orders/456       # ä½¿ç”¨è€…çš„ç‰¹å®šè¨‚å–®
/api/v1/categories/tech/products   # åˆ†é¡ä¸‹çš„ç”¢å“
```

**3. éæ¿¾ã€æ’åºã€åˆ†é **:
```
/api/v1/products?category=book&price_min=100&price_max=500   # éæ¿¾
/api/v1/products?sort=price&order=desc                        # æ’åº
/api/v1/products?page=1&size=20                               # åˆ†é 
```

**4. æœå°‹è³‡æº**:
```
/api/v1/search?q=spring boot       # å…¨ç«™æœå°‹
/api/v1/users/search?q=john        # ä½¿ç”¨è€…æœå°‹
```

**5. æ‰¹æ¬¡æ“ä½œ**:
```
POST   /api/v1/users/batch         # æ‰¹æ¬¡å»ºç«‹
DELETE /api/v1/users?ids=1,2,3     # æ‰¹æ¬¡åˆªé™¤
```

### ç‰ˆæœ¬æ§åˆ¶ç­–ç•¥

**æ–¹æ³•ä¸€ï¼šURL ç‰ˆæœ¬æ§åˆ¶ï¼ˆæ¨è–¦ï¼‰**:
```java
// å°æ‡‰ç¯„ä¾‹: chapter2-spring-mvc-api/.../api/v1/UserRestController.java

@RestController
@RequestMapping("/api/v1/users")  // ç‰ˆæœ¬ 1
public class UserRestControllerV1 { }

@RestController
@RequestMapping("/api/v2/users")  // ç‰ˆæœ¬ 2
public class UserRestControllerV2 { }
```

**æ–¹æ³•äºŒï¼šæ¨™é ­ç‰ˆæœ¬æ§åˆ¶**:
```java
@RestController
@RequestMapping("/api/users")
public class UserRestController {

    @GetMapping(headers = "API-Version=1")
    public ResponseEntity<List<UserDto>> getUsersV1() { }

    @GetMapping(headers = "API-Version=2")
    public ResponseEntity<List<UserDtoV2>> getUsersV2() { }
}
```

**æ–¹æ³•ä¸‰ï¼šAccept æ¨™é ­ç‰ˆæœ¬æ§åˆ¶**:
```java
@GetMapping(produces = "application/vnd.company.api-v1+json")
public ResponseEntity<List<UserDto>> getUsersV1() { }
```

> ğŸ’¡ **æ¨è–¦**: URL ç‰ˆæœ¬æ§åˆ¶æœ€ç›´è§€ï¼Œä¾¿æ–¼æ¸¬è©¦å’Œæ–‡ä»¶åŒ–ï¼Œæ˜¯æœ€å¸¸ç”¨çš„æ–¹æ¡ˆã€‚

---

## ğŸ“Š HTTP ç‹€æ…‹ç¢¼æœ€ä½³å¯¦è¸

### å¸¸ç”¨ç‹€æ…‹ç¢¼åˆ†é¡

```mermaid
graph TD
    HTTP[HTTP ç‹€æ…‹ç¢¼]

    HTTP --> S2XX[2xx æˆåŠŸ]
    HTTP --> S4XX[4xx å®¢æˆ¶ç«¯éŒ¯èª¤]
    HTTP --> S5XX[5xx ä¼ºæœå™¨éŒ¯èª¤]

    S2XX --> S200[200 OK<br/>è«‹æ±‚æˆåŠŸ]
    S2XX --> S201[201 Created<br/>è³‡æºå·²å»ºç«‹]
    S2XX --> S204[204 No Content<br/>æˆåŠŸä½†ç„¡å…§å®¹]

    S4XX --> S400[400 Bad Request<br/>è«‹æ±‚éŒ¯èª¤]
    S4XX --> S401[401 Unauthorized<br/>æœªæˆæ¬Š]
    S4XX --> S403[403 Forbidden<br/>ç¦æ­¢è¨ªå•]
    S4XX --> S404[404 Not Found<br/>è³‡æºä¸å­˜åœ¨]
    S4XX --> S409[409 Conflict<br/>è³‡æºè¡çª]
    S4XX --> S422[422 Unprocessable Entity<br/>é©—è­‰å¤±æ•—]

    S5XX --> S500[500 Internal Server Error<br/>ä¼ºæœå™¨éŒ¯èª¤]
    S5XX --> S503[503 Service Unavailable<br/>æœå‹™ä¸å¯ç”¨]

    style S2XX fill:#66bb6a,color:#fff
    style S4XX fill:#ff9800,color:#fff
    style S5XX fill:#f44336,color:#fff
```

### ç‹€æ…‹ç¢¼ä½¿ç”¨æŒ‡å—

| ç‹€æ…‹ç¢¼ | èªªæ˜ | ä½¿ç”¨æ™‚æ©Ÿ | å›æ‡‰ Body |
|--------|------|----------|-----------|
| **200 OK** | è«‹æ±‚æˆåŠŸ | GETã€PUTã€PATCH æˆåŠŸ | è³‡æºè³‡æ–™ |
| **201 Created** | å·²å»ºç«‹è³‡æº | POST æˆåŠŸå»ºç«‹è³‡æº | æ–°è³‡æºè³‡æ–™ + Location |
| **204 No Content** | æˆåŠŸä½†ç„¡å…§å®¹ | DELETE æˆåŠŸã€PUT ä¸è¿”å›å…§å®¹ | ç„¡ |
| **400 Bad Request** | éŒ¯èª¤è«‹æ±‚ | è«‹æ±‚æ ¼å¼éŒ¯èª¤ | éŒ¯èª¤è©³æƒ… |
| **401 Unauthorized** | æœªæˆæ¬Š | ç¼ºå°‘æˆ–ç„¡æ•ˆçš„èªè­‰è³‡è¨Š | éŒ¯èª¤è¨Šæ¯ |
| **403 Forbidden** | ç¦æ­¢è¨ªå• | å·²èªè­‰ä½†æ¬Šé™ä¸è¶³ | éŒ¯èª¤è¨Šæ¯ |
| **404 Not Found** | è³‡æºä¸å­˜åœ¨ | æ‰¾ä¸åˆ°æŒ‡å®šè³‡æº | éŒ¯èª¤è¨Šæ¯ |
| **409 Conflict** | è³‡æºè¡çª | è³‡æºç‹€æ…‹è¡çªï¼ˆå¦‚é‡è¤‡å»ºç«‹ï¼‰ | è¡çªè©³æƒ… |
| **422 Unprocessable Entity** | ç„¡æ³•è™•ç† | è³‡æ–™é©—è­‰å¤±æ•— | é©—è­‰éŒ¯èª¤è©³æƒ… |
| **500 Internal Server Error** | ä¼ºæœå™¨éŒ¯èª¤ | ç³»çµ±ç•°å¸¸ | éŒ¯èª¤è¨Šæ¯ï¼ˆä¸æ´©æ¼ç´°ç¯€ï¼‰ |

### ç‹€æ…‹ç¢¼ä½¿ç”¨ç¯„ä¾‹

```java
// å°æ‡‰ç¯„ä¾‹: chapter2-spring-mvc-api/.../api/ProductRestController.java:20

@RestController
@RequestMapping("/api/v1/products")
public class ProductRestController {

    // 200 OK - æŸ¥è©¢æˆåŠŸ
    @GetMapping("/{id}")
    public ResponseEntity<ProductDto> getProduct(@PathVariable Long id) {
        Product product = productService.findById(id);
        return ResponseEntity.ok(product);  // 200 OK
    }

    // 201 Created - å»ºç«‹æˆåŠŸ
    @PostMapping
    public ResponseEntity<ProductDto> createProduct(
            @RequestBody @Valid CreateProductRequest request) {

        Product product = productService.create(request);

        URI location = ServletUriComponentsBuilder
            .fromCurrentRequest()
            .path("/{id}")
            .buildAndExpand(product.getId())
            .toUri();

        return ResponseEntity
            .created(location)  // 201 Created + Location æ¨™é ­
            .body(ProductDto.from(product));
    }

    // 204 No Content - åˆªé™¤æˆåŠŸ
    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteProduct(@PathVariable Long id) {
        productService.delete(id);
        return ResponseEntity.noContent().build();  // 204 No Content
    }

    // 400 Bad Request - é€é @Valid è‡ªå‹•è§¸ç™¼
    // 422 Unprocessable Entity - æ¥­å‹™é©—è­‰å¤±æ•—
    @PostMapping("/validate")
    public ResponseEntity<ProductDto> validateAndCreate(
            @RequestBody @Valid CreateProductRequest request) {

        // æ¥­å‹™è¦å‰‡é©—è­‰
        if (productService.existsByName(request.getName())) {
            throw new BusinessException(
                "ç”¢å“åç¨±å·²å­˜åœ¨",
                HttpStatus.UNPROCESSABLE_ENTITY
            );
        }

        Product product = productService.create(request);
        return ResponseEntity.ok(ProductDto.from(product));
    }
}
```

### å…¨åŸŸç•°å¸¸è™•ç†

```java
// å°æ‡‰ç¯„ä¾‹: chapter2-spring-mvc-api/.../exception/GlobalExceptionHandler.java

@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    // 404 Not Found - è³‡æºä¸å­˜åœ¨
    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<ErrorResponse> handleNotFound(
            ResourceNotFoundException ex) {

        log.error("è³‡æºä¸å­˜åœ¨: {}", ex.getMessage());

        ErrorResponse error = ErrorResponse.builder()
            .code(HttpStatus.NOT_FOUND.value())
            .message(ex.getMessage())
            .timestamp(LocalDateTime.now())
            .build();

        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(error);
    }

    // 409 Conflict - è³‡æºè¡çª
    @ExceptionHandler(DuplicateResourceException.class)
    public ResponseEntity<ErrorResponse> handleDuplicate(
            DuplicateResourceException ex) {

        log.error("è³‡æºè¡çª: {}", ex.getMessage());

        ErrorResponse error = ErrorResponse.builder()
            .code(HttpStatus.CONFLICT.value())
            .message(ex.getMessage())
            .timestamp(LocalDateTime.now())
            .build();

        return ResponseEntity.status(HttpStatus.CONFLICT).body(error);
    }

    // 422 Unprocessable Entity - é©—è­‰å¤±æ•—
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ErrorResponse> handleValidation(
            MethodArgumentNotValidException ex) {

        Map<String, String> errors = new HashMap<>();
        ex.getBindingResult().getFieldErrors().forEach(error ->
            errors.put(error.getField(), error.getDefaultMessage())
        );

        ErrorResponse error = ErrorResponse.builder()
            .code(HttpStatus.UNPROCESSABLE_ENTITY.value())
            .message("è³‡æ–™é©—è­‰å¤±æ•—")
            .errors(errors)
            .timestamp(LocalDateTime.now())
            .build();

        return ResponseEntity
            .status(HttpStatus.UNPROCESSABLE_ENTITY)
            .body(error);
    }

    // 500 Internal Server Error - ç³»çµ±ç•°å¸¸
    @ExceptionHandler(Exception.class)
    public ResponseEntity<ErrorResponse> handleGeneric(Exception ex) {
        log.error("ç³»çµ±ç•°å¸¸", ex);

        ErrorResponse error = ErrorResponse.builder()
            .code(HttpStatus.INTERNAL_SERVER_ERROR.value())
            .message("ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦")
            .timestamp(LocalDateTime.now())
            .build();

        return ResponseEntity
            .status(HttpStatus.INTERNAL_SERVER_ERROR)
            .body(error);
    }
}
```

> ğŸ“ **å®Œæ•´éŒ¯èª¤è™•ç†**: åƒè€ƒ [code-examples/chapter2-spring-mvc-api/src/main/java/com/example/exception/](../../code-examples/chapter2-spring-mvc-api/src/main/java/com/example/exception/)

---

## ğŸ“ æœ¬ç¯€é‡é»å›é¡§

### æ ¸å¿ƒçŸ¥è­˜é»

1. **REST ç´„æŸ** - ç†è§£ REST å…­å¤§æ ¸å¿ƒåŸå‰‡åŠå…¶å„ªå‹¢
2. **HTTP æ–¹æ³•** - æŒæ¡ GETã€POSTã€PUTã€PATCHã€DELETE çš„æ­£ç¢ºç”¨æ³•å’Œèªç¾©
3. **URL è¨­è¨ˆ** - å­¸æœƒè³‡æºå°å‘çš„ URL å‘½åè¦ç¯„å’Œéšå±¤è¨­è¨ˆ
4. **ç‹€æ…‹ç¢¼** - æ­£ç¢ºä½¿ç”¨ HTTP ç‹€æ…‹ç¢¼å›æ‡‰ä¸åŒæƒ…å¢ƒ
5. **ç‰ˆæœ¬æ§åˆ¶** - äº†è§£ API ç‰ˆæœ¬ç®¡ç†çš„å¤šç¨®ç­–ç•¥
6. **ç•°å¸¸è™•ç†** - å¯¦ç¾çµ±ä¸€çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶

### æŠ€è¡“è¦é»

- âœ… URL ä½¿ç”¨åè©ï¼ˆè³‡æºï¼‰ï¼ŒHTTP æ–¹æ³•è¡¨é”å‹•ä½œ
- âœ… GET æ˜¯å®‰å…¨ä¸”å†ªç­‰çš„ï¼Œä¸æ‡‰ä¿®æ”¹è³‡æºç‹€æ…‹
- âœ… POST ç”¨æ–¼å»ºç«‹è³‡æºï¼Œè¿”å› 201 Created å’Œ Location æ¨™é ­
- âœ… PUT ç”¨æ–¼å®Œæ•´æ›´æ–°ï¼ŒPATCH ç”¨æ–¼éƒ¨åˆ†æ›´æ–°
- âœ… DELETE æˆåŠŸå¾Œè¿”å› 204 No Content
- âœ… ä½¿ç”¨æ­£ç¢ºçš„ HTTP ç‹€æ…‹ç¢¼è¡¨é”æ“ä½œçµæœ
- âœ… å¯¦ç¾å…¨åŸŸç•°å¸¸è™•ç†ï¼Œçµ±ä¸€éŒ¯èª¤å›æ‡‰æ ¼å¼

---

## ğŸš€ ä¸‹ä¸€æ­¥

ğŸ‘‰ [2.3 API è«‹æ±‚èˆ‡å›æ‡‰è™•ç†](./2.3-request-response-handling.md) - æŒæ¡è«‹æ±‚åƒæ•¸ç¶å®šå’Œçµ±ä¸€å›æ‡‰æ ¼å¼

---

## ğŸ“š åƒè€ƒè³‡æº

**å®˜æ–¹æ–‡ä»¶**:
- [RESTful API Design Best Practices](https://restfulapi.net/)
- [HTTP Status Codes](https://httpstatuses.com/)
- [RFC 7231 - HTTP/1.1 Semantics](https://tools.ietf.org/html/rfc7231)

**ç¯„ä¾‹ç¨‹å¼ç¢¼**:
- [å®Œæ•´å°ˆæ¡ˆç¨‹å¼ç¢¼](../../code-examples/chapter2-spring-mvc-api)
- [UserRestController.java](../../code-examples/chapter2-spring-mvc-api/src/main/java/com/example/api/UserRestController.java)
- [ProductRestController.java](../../code-examples/chapter2-spring-mvc-api/src/main/java/com/example/api/ProductRestController.java)
- [GlobalExceptionHandler.java](../../code-examples/chapter2-spring-mvc-api/src/main/java/com/example/exception/GlobalExceptionHandler.java)

---

**ç›¸é—œç« ç¯€**:
- â† ä¸Šä¸€ç« : [2.1 Spring MVC API é–‹ç™¼åŸºç¤](./2.1-spring-mvc-basics.md)
- â†’ ä¸‹ä¸€ç« : [2.3 API è«‹æ±‚èˆ‡å›æ‡‰è™•ç†](./2.3-request-response-handling.md)
