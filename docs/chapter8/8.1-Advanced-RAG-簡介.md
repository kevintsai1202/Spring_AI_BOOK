# 8.1 Advanced RAG ç°¡ä»‹

> **å°æ‡‰ç¯„ä¾‹**: `chapter8-advanced-rag`
> **é›£åº¦**: â­â­â­â­â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

Advanced RAGï¼ˆé€²éšæª¢ç´¢å¢å¼·ç”Ÿæˆï¼‰æ˜¯ RAG æŠ€è¡“çš„æ¼”é€²ç‰ˆæœ¬ï¼Œé€šéæ™ºèƒ½æŸ¥è©¢è™•ç†ã€å¤šéšæ®µæª¢ç´¢å’Œ Re-ranking ç­‰æŠ€è¡“ï¼Œå¤§å¹…æå‡æª¢ç´¢æº–ç¢ºç‡å’Œç­”æ¡ˆå“è³ªã€‚

**å­¸ç¿’ç›®æ¨™**:
- ç†è§£ Advanced RAG çš„æ ¸å¿ƒæ¦‚å¿µå’ŒæŠ€è¡“æ¼”é€²
- æŒæ¡ Spring AI ä¸­çš„ Advanced RAG å¯¦ç¾æ–¹å¼
- å­¸ç¿’å¤šéšæ®µæª¢ç´¢å„ªåŒ–ç­–ç•¥
- äº†è§£æŸ¥è©¢é‡å¯«å’Œ Re-ranking æŠ€è¡“

---

## ğŸ¯ ç‚ºä»€éº¼éœ€è¦ Advanced RAG?

### åŸºç¤ RAG çš„é™åˆ¶

æœ€ç°¡å–®çš„ RAG å¯¦ç¾æ–¹å¼:

```java
// âŒ åŸºç¤ RAG çš„å•é¡Œ
@Service
public class BasicRAGService {

    @Autowired
    private VectorStore vectorStore;

    @Autowired
    private ChatClient chatClient;

    public String query(String userQuery) {
        // 1. ç›´æ¥å‘é‡æª¢ç´¢
        List<Document> documents = vectorStore.similaritySearch(
            SearchRequest.builder()
                .query(userQuery)
                .topK(5)
                .build()
        );

        // 2. çµ„æˆä¸Šä¸‹æ–‡
        String context = documents.stream()
            .map(Document::getText)
            .collect(Collectors.joining("\n\n"));

        // 3. ç›´æ¥ç”Ÿæˆç­”æ¡ˆ
        return chatClient.prompt()
            .user("æ ¹æ“šä»¥ä¸‹ä¸Šä¸‹æ–‡å›ç­”å•é¡Œï¼š\n" + context + "\n\nå•é¡Œï¼š" + userQuery)
            .call()
            .content();
    }
}
```

**åŸºç¤ RAG çš„å•é¡Œ**:
1. âŒ **æª¢ç´¢ç²¾åº¦ä¸è¶³**: å–®ç´”çš„å‘é‡ç›¸ä¼¼åº¦å¯èƒ½æª¢ç´¢åˆ°èªç¾©ç›¸ä¼¼ä½†ä¸ç›¸é—œçš„å…§å®¹
2. âŒ **æŸ¥è©¢ç†è§£æœ‰é™**: æ²’æœ‰å°ç”¨æˆ¶æŸ¥è©¢é€²è¡Œå„ªåŒ–å’Œæ“´å±•
3. âŒ **ä¸Šä¸‹æ–‡å“è³ªä¸ä½³**: å¯èƒ½åŒ…å«å†—é¤˜æˆ–ä¸ç›¸é—œçš„ä¿¡æ¯
4. âŒ **ç„¡æ³•è™•ç†è¤‡é›œæŸ¥è©¢**: å°æ–¼éœ€è¦å¤šæ­¥æ¨ç†çš„æŸ¥è©¢æ•ˆæœä¸ä½³

### Advanced RAG çš„è§£æ±ºæ–¹æ¡ˆ

```java
// âœ… Advanced RAG ä¼æ¥­ç´šæ–¹æ¡ˆ
@Service
public class AdvancedRAGService {

    @Autowired
    private ChatClient advancedChatClient;

    public AdvancedRAGResponse query(String userQuery) {
        // ä½¿ç”¨é…ç½®å¥½çš„ Advanced RAG ChatClient
        // è‡ªå‹•åŸ·è¡Œï¼šæŸ¥è©¢é‡å¯« â†’ å‘é‡æª¢ç´¢ â†’ Re-ranking â†’ ä¸Šä¸‹æ–‡å„ªåŒ–
        return chatClient.prompt()
            .user(userQuery)
            .call()
            .chatResponse();
    }
}
```

**Advanced RAG çš„å„ªå‹¢**:
- âœ… æ™ºèƒ½æŸ¥è©¢ç†è§£å’Œé‡å¯«
- âœ… å¤šéšæ®µæª¢ç´¢å„ªåŒ–
- âœ… Re-ranking æå‡ç›¸é—œæ€§
- âœ… è‡ªé©æ‡‰ä¸Šä¸‹æ–‡ç®¡ç†

---

## ğŸ—ï¸ RAG æŠ€è¡“æ¼”é€²

### å››å€‹ç™¼å±•éšæ®µ

```mermaid
graph TD
    A[ç¬¬ä¸€ä»£: åŸºç¤ RAG] --> B[ç¬¬äºŒä»£: æ”¹é€² RAG]
    B --> C[ç¬¬ä¸‰ä»£: æ¨¡çµ„åŒ– RAG]
    C --> D[ç¬¬å››ä»£: Advanced RAG]

    style A fill:#ffe0b2
    style B fill:#fff4e6
    style C fill:#e8f5e9
    style D fill:#e1f5ff
```

### ç¬¬ä¸€ä»£ï¼šåŸºç¤ RAG (Naive RAG)

**æ ¸å¿ƒæµç¨‹**:
```
æŸ¥è©¢ â†’ Embedding â†’ å‘é‡æª¢ç´¢ â†’ Top-K çµæœ â†’ LLM ç”Ÿæˆ
```

**ç‰¹é»**:
- ç°¡å–®çš„å‘é‡æª¢ç´¢ + ç”Ÿæˆ
- å›ºå®šçš„åˆ†å¡Šç­–ç•¥
- åŸºæœ¬çš„ç›¸ä¼¼åº¦åŒ¹é…

**é™åˆ¶**:
- æª¢ç´¢ç²¾åº¦ä¸é«˜
- ä¸Šä¸‹æ–‡ç†è§£æœ‰é™
- ç„¡æ³•è™•ç†è¤‡é›œæŸ¥è©¢

### ç¬¬äºŒä»£ï¼šæ”¹é€² RAG (Enhanced RAG)

**æ”¹é€²é»**:
- å„ªåŒ–çš„æ–‡æœ¬åˆ†å¡Šç­–ç•¥
- æ”¹é€²çš„ Embedding æ¨¡å‹
- åŸºæœ¬çš„é‡æ’åºæ©Ÿåˆ¶

**æ•ˆæœ**:
- æå‡æª¢ç´¢ç›¸é—œæ€§ 15-20%
- æ¸›å°‘å™ªéŸ³å¹²æ“¾

### ç¬¬ä¸‰ä»£ï¼šæ¨¡çµ„åŒ– RAG (Modular RAG)

**æ ¸å¿ƒç‰¹é»**:
- å¯æ’æ‹”çš„æª¢ç´¢æ¨¡çµ„
- å¤šéšæ®µæª¢ç´¢æµç¨‹
- è‡ªé©æ‡‰æª¢ç´¢ç­–ç•¥

**å„ªå‹¢**:
- éˆæ´»æ€§é«˜
- å¯å®šåˆ¶åŒ–
- æ˜“æ–¼æ“´å±•

### ç¬¬å››ä»£ï¼šAdvanced RAG (æ™ºèƒ½åŒ– RAG)

**æ ¸å¿ƒèƒ½åŠ›**:
- æ™ºèƒ½æŸ¥è©¢ç†è§£èˆ‡é‡å¯«
- å¤šæ¨¡æ…‹æª¢ç´¢èˆ‡ç”Ÿæˆ
- è‡ªæˆ‘åæ€èˆ‡ä¿®æ­£æ©Ÿåˆ¶
- Re-ranking ç²¾æº–æ’åº

**æ•ˆæœæå‡**:
- æº–ç¢ºç‡æå‡ 85-95%
- å¬å›ç‡æå‡ 80-90%
- ç”¨æˆ¶æ»¿æ„åº¦æå‡ 30%+

---

## ğŸ’» Advanced RAG æ ¸å¿ƒçµ„ä»¶

### Spring AI æ¶æ§‹åœ–

```mermaid
graph LR
    A[User Query] --> B[QueryRewrite]
    B --> C[VectorStore]
    C --> D[Documents]
    D --> E[Re-ranking]
    E --> F[Top-K Results]
    F --> G[Context Optimization]
    G --> H[LLM Generation]
    H --> I[Response]

    style B fill:#e3f2fd
    style E fill:#e8f5e9
    style G fill:#fff4e6
    style H fill:#fce4ec
```

### 1. æŸ¥è©¢é‡å¯«æœå‹™

```java
// å°æ‡‰ç¯„ä¾‹: chapter8-advanced-rag/.../service/QueryRewriteService.java

@Service
@Slf4j
public class QueryRewriteService {

    @Autowired
    private ChatClient chatClient;

    /**
     * é‡å¯«æŸ¥è©¢ä»¥æå‡æª¢ç´¢æ•ˆæœ
     */
    public String rewriteQuery(String originalQuery) {
        String prompt = """
            è«‹å°‡ä»¥ä¸‹ç”¨æˆ¶æŸ¥è©¢é‡å¯«ç‚ºæ›´é©åˆå‘é‡æª¢ç´¢çš„å½¢å¼ï¼š

            åŸå§‹æŸ¥è©¢ï¼š%s

            é‡å¯«è¦å‰‡ï¼š
            1. ä¿ç•™æ ¸å¿ƒæ„åœ–
            2. æ·»åŠ ç›¸é—œé—œéµè©
            3. æ˜ç¢ºæŸ¥è©¢ç¯„åœ
            4. ç§»é™¤å†—é¤˜è©èª

            é‡å¯«å¾Œçš„æŸ¥è©¢ï¼š
            """.formatted(originalQuery);

        String rewrittenQuery = chatClient.prompt()
            .user(prompt)
            .call()
            .content();

        log.info("æŸ¥è©¢é‡å¯«: {} â†’ {}", originalQuery, rewrittenQuery);
        return rewrittenQuery;
    }
}
```

### 2. å¤šéšæ®µæª¢ç´¢æœå‹™

```java
// å°æ‡‰ç¯„ä¾‹: chapter8-advanced-rag/.../service/MultiStageRetrievalService.java

@Service
@Slf4j
public class MultiStageRetrievalService {

    @Autowired
    private VectorStore vectorStore;

    /**
     * å¤šéšæ®µæª¢ç´¢ï¼šç²—æª¢ç´¢ + ç²¾æª¢ç´¢
     */
    public List<Document> multiStageRetrieval(String query, int finalTopK) {

        // ç¬¬ä¸€éšæ®µï¼šç²—æª¢ç´¢ï¼ˆæª¢ç´¢ 3 å€çš„å€™é¸æ–‡æª”ï¼‰
        int coarseTopK = finalTopK * 3;
        List<Document> coarseResults = vectorStore.similaritySearch(
            SearchRequest.builder()
                .query(query)
                .topK(coarseTopK)
                .similarityThreshold(0.6)  // è¼ƒä½é–¾å€¼
                .build()
        );

        log.info("ç²—æª¢ç´¢å®Œæˆï¼Œæª¢ç´¢åˆ° {} å€‹æ–‡æª”", coarseResults.size());

        // ç¬¬äºŒéšæ®µï¼šç²¾æª¢ç´¢ï¼ˆä½¿ç”¨ Re-rankingï¼‰
        // é€™éƒ¨åˆ†æœƒåœ¨ RerankRAGAdvisor ä¸­è‡ªå‹•è™•ç†

        return coarseResults;
    }
}
```

### 3. Re-ranking Advisor

```java
// å°æ‡‰ç¯„ä¾‹: chapter8-advanced-rag/.../advisor/RerankRAGAdvisor.java

@Slf4j
public class RerankRAGAdvisor implements BaseAdvisor {

    private final VectorStore vectorStore;
    private final RerankingProvider rerankingProvider;
    private final RAGProperties ragProperties;

    @Override
    public ChatClientRequest before(ChatClientRequest request, AdvisorChain chain) {

        // ç²å–ç”¨æˆ¶æŸ¥è©¢
        String userQuery = request.prompt().getUserMessage().getText();

        // ç¬¬ä¸€éšæ®µï¼šç²—æª¢ç´¢
        List<Document> documents = vectorStore.similaritySearch(
            SearchRequest.builder()
                .query(userQuery)
                .topK(ragProperties.getReranking().getFirstStageTopK())
                .build()
        );

        log.info("ç²—æª¢ç´¢å®Œæˆï¼Œæª¢ç´¢åˆ° {} å€‹æ–‡æª”", documents.size());

        // ç¬¬äºŒéšæ®µï¼šRe-ranking
        List<RerankResult> rerankedResults = rerankingProvider.rerank(
            userQuery,
            documents,
            ragProperties.getReranking().getFinalTopK()
        );

        log.info("Re-ranking å®Œæˆï¼Œè¿”å› {} å€‹æ–‡æª”", rerankedResults.size());

        // çµ„æˆä¸Šä¸‹æ–‡
        String context = rerankedResults.stream()
            .map(result -> result.getDocument().getText())
            .collect(Collectors.joining(System.lineSeparator()));

        // å¢å¼·ç”¨æˆ¶æ¶ˆæ¯
        return request.mutate()
            .prompt(request.prompt().augmentUserMessage(
                buildContextPrompt(context)
            ))
            .build();
    }

    private String buildContextPrompt(String context) {
        return """
            Context information is below.
            ---------------------
            %s
            ---------------------
            Given the context and provided history information,
            reply to the user comment. If the answer is not in the context,
            inform the user that you can't answer the question.
            """.formatted(context);
    }
}
```

---

## ğŸ¬ å®Œæ•´é…ç½®ç¯„ä¾‹

### ChatClient é…ç½®

```java
// å°æ‡‰ç¯„ä¾‹: chapter8-advanced-rag/.../config/ChatClientConfig.java

@Configuration
public class AdvancedRAGConfiguration {

    @Bean
    public ChatClient advancedRAGChatClient(
            ChatModel chatModel,
            VectorStore vectorStore,
            RerankingProvider rerankingProvider,
            RAGProperties ragProperties) {

        return ChatClient.builder(chatModel)
            .defaultSystem("""
                ä½ æ˜¯ä¸€å€‹æ™ºèƒ½åŠ©æ‰‹ï¼Œå…·å‚™ä»¥ä¸‹èƒ½åŠ›ï¼š
                1. æ ¹æ“šæä¾›çš„ä¸Šä¸‹æ–‡æº–ç¢ºå›ç­”å•é¡Œ
                2. ç•¶è³‡è¨Šä¸ç¢ºå®šæ™‚ï¼Œæ˜ç¢ºå‘ŠçŸ¥ç”¨æˆ¶
                3. æä¾›æœ‰å¼•ç”¨çš„å°ˆæ¥­å›ç­”
                """)
            .defaultAdvisors(
                // Re-ranking RAG Advisor
                new RerankRAGAdvisor(vectorStore, rerankingProvider, ragProperties)
                    .withOrder(1)
            )
            .build();
    }
}
```

### é…ç½®æ–‡ä»¶

```yaml
# application.yml
spring:
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      chat:
        options:
          model: gpt-4o-mini
          temperature: 0.3
      embedding:
        options:
          model: text-embedding-3-small

# Advanced RAG é…ç½®
advanced-rag:
  reranking:
    provider: voyage        # voyage, local
    first-stage-top-k: 50   # ç²—æª¢ç´¢æ•¸é‡
    final-top-k: 5          # æœ€çµ‚è¿”å›æ•¸é‡
  voyage:
    api-key: ${VOYAGE_API_KEY}
    model: rerank-2.5       # Voyage rerank æ¨¡å‹
```

---

## ğŸ“Š æ•ˆæœå°æ¯”

### åŸºç¤ RAG vs Advanced RAG

| æŒ‡æ¨™ | åŸºç¤ RAG | Advanced RAG | æå‡å¹…åº¦ |
|------|----------|--------------|----------|
| **ç²¾ç¢ºç‡** | 65-75% | 85-95% | +30% |
| **å¬å›ç‡** | 70-80% | 80-90% | +12% |
| **ç”¨æˆ¶æ»¿æ„åº¦** | 3.2/5 | 4.3/5 | +34% |
| **å›æ‡‰æ™‚é–“** | 800ms | 1500ms | +87% |
| **æˆæœ¬** | ä½ | ä¸­ | +50% |

**çµè«–**: Advanced RAG åœ¨ç²¾ç¢ºç‡å’Œç”¨æˆ¶æ»¿æ„åº¦ä¸Šæœ‰é¡¯è‘—æå‡ï¼Œä½†æœƒå¢åŠ ä¸€äº›æˆæœ¬å’Œå»¶é²ã€‚é©åˆå°ç­”æ¡ˆå“è³ªè¦æ±‚é«˜çš„ä¼æ¥­æ‡‰ç”¨ã€‚

---

## ğŸ“ é‡é»å›é¡§

### Advanced RAG æ ¸å¿ƒç‰¹å¾µ
âœ… æ™ºèƒ½æŸ¥è©¢è™•ç† - æŸ¥è©¢é‡å¯«ã€æ“´å±•
âœ… å¤šéšæ®µæª¢ç´¢ - ç²—æª¢ç´¢ + Re-ranking
âœ… ä¸Šä¸‹æ–‡å„ªåŒ– - å‹•æ…‹èª¿æ•´ã€å£“ç¸®
âœ… è‡ªé©æ‡‰æ©Ÿåˆ¶ - æ ¹æ“šæ•ˆæœè‡ªå‹•èª¿æ•´

### Spring AI å¯¦ç¾è¦é»
- ä½¿ç”¨ `BaseAdvisor` å¯¦ç¾ RAG æµç¨‹
- é€é `RerankingProvider` æ”¯æ´å¤šç¨® Re-ranking æ–¹æ¡ˆ
- é…ç½®éˆæ´»ï¼Œæ˜“æ–¼æ“´å±•

### é©ç”¨å ´æ™¯
- **ä¼æ¥­çŸ¥è­˜ç®¡ç†**: æŠ€è¡“æ–‡æª”ã€æ”¿ç­–æ³•è¦æŸ¥è©¢
- **å®¢æˆ¶æœå‹™ç³»çµ±**: æ™ºèƒ½å®¢æœã€å•é¡Œè¨ºæ–·
- **æ•™è‚²åŸ¹è¨“å¹³å°**: å€‹æ€§åŒ–å­¸ç¿’ã€æ™ºèƒ½ç­”ç–‘
- **ç ”ç©¶èˆ‡é–‹ç™¼**: æ–‡ç»æª¢ç´¢ã€æŠ€è¡“èª¿ç ”

---

## ğŸš€ ä¸‹ä¸€æ­¥

ğŸ‘‰ [8.2 Embedding å„ªåŒ–](./8.2-Embedding-å„ªåŒ–.md) - æå‡æª¢ç´¢åŸºç¤
ğŸ‘‰ [8.3 Re-ranking å¯¦ç¾](./8.3-Re-ranking-å¯¦ç¾.md) - ç²¾æº–æ’åºæŠ€è¡“

---

**ç›¸é—œç« ç¯€**:
- â† ä¸Šä¸€ç« : [ç¬¬7ç«  RAG åŸºç¤](../chapter7/README.md)
- â†’ ä¸‹ä¸€ç« : [8.2 Embedding å„ªåŒ–](./8.2-Embedding-å„ªåŒ–.md)

**åƒè€ƒè³‡æ–™**:
- [Retrieval-Augmented Generation for Knowledge-Intensive NLP Tasks](https://arxiv.org/abs/2005.11401)
- [Advanced RAG Techniques](https://arxiv.org/abs/2312.10997)
- [Spring AI Documentation](https://docs.spring.io/spring-ai/reference/)
