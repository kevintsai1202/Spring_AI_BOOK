# 8.4 å…§å®¹å¯©æ ¸èˆ‡è©•ä¼°æ¸¬è©¦

> **å°æ‡‰ç¯„ä¾‹**: `chapter8-advanced-rag`
> **é›£åº¦**: â­â­â­â­â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

åœ¨ä¼æ¥­ç´š AI æ‡‰ç”¨ä¸­ï¼Œå…§å®¹å®‰å…¨å’Œå“è³ªä¿è­‰è‡³é—œé‡è¦ã€‚æœ¬ç« å°‡ä»‹ç´¹å¦‚ä½•å»ºç«‹å®Œæ•´çš„å…§å®¹å¯©æ ¸å’Œè©•ä¼°æ¸¬è©¦ç³»çµ±ã€‚

**å­¸ç¿’ç›®æ¨™**:
- ç†è§£ AI å…§å®¹å®‰å…¨çš„é‡è¦æ€§
- æŒæ¡å¤šå±¤å¯©æ ¸ç­–ç•¥
- å­¸æœƒå»ºç«‹ RAG è©•ä¼°æ¸¬è©¦æ¡†æ¶
- äº†è§£æŒçºŒç›£æ§å’Œå„ªåŒ–æ–¹æ³•

---

## ğŸ¯ ç‚ºä»€éº¼éœ€è¦å…§å®¹å¯©æ ¸èˆ‡è©•ä¼°ï¼Ÿ

### AI ç³»çµ±çš„é¢¨éšª

```mermaid
graph TD
    A[AI å›ç­”] --> B{å…§å®¹æª¢æŸ¥}
    B -->|æœªå¯©æ ¸| C[æ½›åœ¨é¢¨éšª]
    C --> D[âŒ æœ‰å®³å…§å®¹]
    C --> E[âŒ éŒ¯èª¤ä¿¡æ¯]
    C --> F[âŒ éš±ç§æ´©éœ²]
    C --> G[âŒ åè¦‹æ­§è¦–]

    B -->|å·²å¯©æ ¸| H[âœ… å®‰å…¨å›ç­”]

    style C fill:#ffcccc
    style D fill:#ffcccc
    style E fill:#ffcccc
    style F fill:#ffcccc
    style G fill:#ffcccc
    style H fill:#c8e6c9
```

**ä¸»è¦é¢¨éšª**:
1. âŒ **æœ‰å®³å…§å®¹**: æš´åŠ›ã€è‰²æƒ…ã€ä»‡æ¨è¨€è«–
2. âŒ **éŒ¯èª¤ä¿¡æ¯**: äº‹å¯¦éŒ¯èª¤ã€èª¤å°æ€§å…§å®¹
3. âŒ **éš±ç§æ´©éœ²**: å€‹äººä¿¡æ¯ã€å•†æ¥­æ©Ÿå¯†
4. âŒ **åè¦‹æ­§è¦–**: æ€§åˆ¥ã€ç¨®æ—ã€å¹´é½¡æ­§è¦–

---

## ğŸ’» å¤šå±¤å…§å®¹å¯©æ ¸ç³»çµ±

### å¯©æ ¸æ¶æ§‹

```mermaid
graph LR
    A[AI å›ç­”] --> B[OpenAI<br/>Moderation]
    B --> C[Mistral AI<br/>Moderation]
    C --> D[è‡ªå®šç¾©<br/>è¦å‰‡æª¢æŸ¥]
    D --> E{ç¶œåˆè©•åˆ†}
    E -->|å®‰å…¨| F[âœ… é€šé]
    E -->|é¢¨éšª| G[âŒ é˜»æ“‹/å‘Šè­¦]

    style B fill:#e3f2fd
    style C fill:#fff4e6
    style D fill:#e8f5e9
    style F fill:#c8e6c9
    style G fill:#ffcccc
```

### 1. OpenAI Moderation

```java
// å°æ‡‰ç¯„ä¾‹: chapter8-advanced-rag/.../service/ContentModerationService.java

@Service
@RequiredArgsConstructor
public class ContentModerationService {

    private final OpenAiModerationModel openAiModerationModel;

    /**
     * OpenAI å…§å®¹å¯©æ ¸
     */
    public ModerationResult moderateWithOpenAI(String content) {

        // èª¿ç”¨ OpenAI Moderation API
        ModerationPrompt prompt = new ModerationPrompt(content);
        ModerationResponse response = openAiModerationModel.call(prompt);

        Moderation moderation = response.getResult().getOutput();
        ModerationResult result = moderation.getResults().get(0);

        // æª¢æŸ¥å„é¡åˆ¥
        boolean isFlagged = result.isFlagged();
        Map<String, Boolean> categories = extractCategories(result);
        Map<String, Double> scores = extractScores(result);

        log.info("OpenAI å¯©æ ¸å®Œæˆï¼Œæ˜¯å¦æ¨™è¨˜: {}", isFlagged);

        return ModerationResult.builder()
            .provider("OpenAI")
            .flagged(isFlagged)
            .categories(categories)
            .scores(scores)
            .build();
    }

    private Map<String, Boolean> extractCategories(ModerationResult result) {
        Categories cat = result.getCategories();
        return Map.of(
            "sexual", cat.isSexual(),
            "hate", cat.isHate(),
            "harassment", cat.isHarassment(),
            "self_harm", cat.isSelfHarm(),
            "violence", cat.isViolence()
        );
    }

    private Map<String, Double> extractScores(ModerationResult result) {
        CategoryScores scores = result.getCategoryScores();
        return Map.of(
            "sexual", scores.getSexual(),
            "hate", scores.getHate(),
            "harassment", scores.getHarassment(),
            "self_harm", scores.getSelfHarm(),
            "violence", scores.getViolence()
        );
    }
}
```

**OpenAI Moderation æª¢æŸ¥é¡åˆ¥**:
- `sexual` - è‰²æƒ…å…§å®¹
- `hate` - ä»‡æ¨è¨€è«–
- `harassment` - é¨·æ“¾å…§å®¹
- `self-harm` - è‡ªæ®˜å…§å®¹
- `violence` - æš´åŠ›å…§å®¹

### 2. è‡ªå®šç¾©è¦å‰‡æª¢æŸ¥

```java
// å°æ‡‰ç¯„ä¾‹: chapter8-advanced-rag/.../service/CustomRuleModerationService.java

@Service
public class CustomRuleModerationService {

    /**
     * è‡ªå®šç¾©è¦å‰‡å¯©æ ¸
     */
    public ModerationResult customModeration(String content) {

        Map<String, Boolean> violations = new HashMap<>();

        // 1. æ•æ„Ÿè©æª¢æŸ¥
        boolean hasSensitiveWords = checkSensitiveWords(content);
        violations.put("sensitive_words", hasSensitiveWords);

        // 2. å€‹äººä¿¡æ¯æª¢æŸ¥ï¼ˆPIIï¼‰
        boolean containsPII = checkPersonalInfo(content);
        violations.put("personal_info", containsPII);

        // 3. ä¼æ¥­æ”¿ç­–æª¢æŸ¥
        boolean violatesPolicy = checkEnterprisePolicy(content);
        violations.put("enterprise_policy", violatesPolicy);

        boolean isFlagged = violations.values().stream().anyMatch(v -> v);

        return ModerationResult.builder()
            .provider("CustomRules")
            .flagged(isFlagged)
            .categories(violations)
            .build();
    }

    /**
     * æª¢æŸ¥æ•æ„Ÿè©
     */
    private boolean checkSensitiveWords(String content) {
        List<String> sensitiveWords = List.of(
            "æ©Ÿå¯†", "å…§éƒ¨è³‡æ–™", "å¯†ç¢¼", "å€‹è³‡"
        );

        return sensitiveWords.stream()
            .anyMatch(word -> content.toLowerCase().contains(word.toLowerCase()));
    }

    /**
     * æª¢æŸ¥å€‹äººä¿¡æ¯ï¼ˆå°ç£ï¼‰
     */
    private boolean checkPersonalInfo(String content) {

        // èº«ä»½è­‰è™Ÿç¢¼ï¼ˆå°ç£ï¼‰
        Pattern idPattern = Pattern.compile("[A-Z]\\d{9}");
        if (idPattern.matcher(content).find()) {
            return true;
        }

        // é›»è©±è™Ÿç¢¼
        Pattern phonePattern = Pattern.compile("\\b\\d{4}-\\d{6}\\b|\\b09\\d{8}\\b");
        if (phonePattern.matcher(content).find()) {
            return true;
        }

        // é›»å­éƒµä»¶
        Pattern emailPattern = Pattern.compile("\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}\\b");
        if (emailPattern.matcher(content).find()) {
            return true;
        }

        return false;
    }

    private boolean checkEnterprisePolicy(String content) {
        // æ ¹æ“šä¼æ¥­æ”¿ç­–é€²è¡Œæª¢æŸ¥
        return false;
    }
}
```

### 3. ç¶œåˆå¯©æ ¸æœå‹™

```java
@Service
@RequiredArgsConstructor
public class ComprehensiveModerationService {

    private final ContentModerationService openAIModeration;
    private final CustomRuleModerationService customModeration;

    /**
     * å¤šå±¤å¯©æ ¸
     */
    public FinalModerationResult comprehensiveModerate(String content) {

        List<ModerationResult> results = new ArrayList<>();

        // 1. OpenAI å¯©æ ¸
        try {
            results.add(openAIModeration.moderateWithOpenAI(content));
        } catch (Exception e) {
            log.warn("OpenAI å¯©æ ¸å¤±æ•—: {}", e.getMessage());
        }

        // 2. è‡ªå®šç¾©è¦å‰‡å¯©æ ¸
        results.add(customModeration.customModeration(content));

        // 3. ç¶œåˆè©•ä¼°
        return evaluateResults(results);
    }

    private FinalModerationResult evaluateResults(List<ModerationResult> results) {

        // è¨ˆç®—é¢¨éšªåˆ†æ•¸ï¼ˆåŠ æ¬Šå¹³å‡ï¼‰
        double totalRiskScore = 0.0;
        double openAIWeight = 0.6;
        double customWeight = 0.4;

        for (ModerationResult result : results) {
            if (result.isFlagged()) {
                double weight = "OpenAI".equals(result.getProvider()) ?
                    openAIWeight : customWeight;
                totalRiskScore += weight;
            }
        }

        // åˆ¤æ–·æ˜¯å¦é˜»æ“‹
        boolean shouldBlock = totalRiskScore >= 0.5;

        return FinalModerationResult.builder()
            .passed(!shouldBlock)
            .riskScore(totalRiskScore)
            .results(results)
            .recommendation(shouldBlock ? "å»ºè­°é˜»æ“‹" : "å…§å®¹å®‰å…¨")
            .build();
    }
}
```

---

## ğŸ“Š RAG ç³»çµ±è©•ä¼°æ¸¬è©¦

### è©•ä¼°æ¶æ§‹

```mermaid
graph LR
    A[æ¸¬è©¦æ¡ˆä¾‹] --> B[RAG æŸ¥è©¢]
    B --> C[è©•ä¼°å™¨]
    C --> D[ç›¸é—œæ€§è©•ä¼°]
    C --> E[äº‹å¯¦æº–ç¢ºæ€§]
    C --> F[å®Œæ•´æ€§è©•ä¼°]
    D --> G[è©•ä¼°å ±å‘Š]
    E --> G
    F --> G

    style C fill:#e8f5e9
    style G fill:#e1f5ff
```

### 1. è©•ä¼°æ¸¬è©¦æœå‹™

```java
// å°æ‡‰ç¯„ä¾‹: chapter8-advanced-rag/.../service/RAGEvaluationService.java

@Service
@RequiredArgsConstructor
public class RAGEvaluationService {

    private final ChatClient ragChatClient;
    private final VectorStore vectorStore;

    /**
     * è©•ä¼° RAG ç³»çµ±
     */
    public EvaluationReport evaluateRagSystem(List<TestCase> testCases) {

        List<EvaluationResult> results = new ArrayList<>();

        for (TestCase testCase : testCases) {
            try {
                // åŸ·è¡ŒæŸ¥è©¢
                String response = ragChatClient.prompt()
                    .user(testCase.getQuestion())
                    .call()
                    .content();

                // è©•ä¼°çµæœ
                EvaluationResult result = evaluateResponse(
                    testCase,
                    response
                );

                results.add(result);

            } catch (Exception e) {
                log.error("è©•ä¼°æ¸¬è©¦æ¡ˆä¾‹å¤±æ•—: {}", testCase.getId(), e);
            }
        }

        return generateReport(results);
    }

    /**
     * è©•ä¼°å–®ä¸€å›æ‡‰
     */
    private EvaluationResult evaluateResponse(TestCase testCase, String response) {

        // 1. ç›¸é—œæ€§è©•ä¼°
        double relevancyScore = evaluateRelevancy(
            testCase.getQuestion(),
            response
        );

        // 2. å®Œæ•´æ€§è©•ä¼°
        double completenessScore = evaluateCompleteness(
            testCase.getExpectedKeywords(),
            response
        );

        // 3. é€£è²«æ€§è©•ä¼°
        double coherenceScore = evaluateCoherence(response);

        return EvaluationResult.builder()
            .testCaseId(testCase.getId())
            .question(testCase.getQuestion())
            .response(response)
            .relevancyScore(relevancyScore)
            .completenessScore(completenessScore)
            .coherenceScore(coherenceScore)
            .build();
    }

    /**
     * ç›¸é—œæ€§è©•ä¼°
     */
    private double evaluateRelevancy(String question, String response) {
        // ç°¡å–®çš„é—œéµè©åŒ¹é…
        String[] queryWords = question.toLowerCase().split("\\s+");
        String lowerResponse = response.toLowerCase();

        long matchCount = Arrays.stream(queryWords)
            .filter(lowerResponse::contains)
            .count();

        return (double) matchCount / queryWords.length;
    }

    /**
     * å®Œæ•´æ€§è©•ä¼°
     */
    private double evaluateCompleteness(List<String> keywords, String response) {
        if (keywords.isEmpty()) {
            return 1.0;
        }

        long matchCount = keywords.stream()
            .filter(keyword -> response.toLowerCase().contains(keyword.toLowerCase()))
            .count();

        return (double) matchCount / keywords.size();
    }

    /**
     * é€£è²«æ€§è©•ä¼°
     */
    private double evaluateCoherence(String response) {
        String[] sentences = response.split("\\.");

        if (sentences.length <= 1) {
            return 1.0;
        }

        // ç°¡å–®çš„å¥å­é•·åº¦è®Šç•°åº¦æª¢æŸ¥
        double avgLength = Arrays.stream(sentences)
            .mapToInt(String::length)
            .average()
            .orElse(0.0);

        double variance = Arrays.stream(sentences)
            .mapToDouble(s -> Math.pow(s.length() - avgLength, 2))
            .average()
            .orElse(0.0);

        return Math.max(0.0, 1.0 - (variance / (avgLength * avgLength)));
    }

    /**
     * ç”Ÿæˆè©•ä¼°å ±å‘Š
     */
    private EvaluationReport generateReport(List<EvaluationResult> results) {

        double avgRelevancy = results.stream()
            .mapToDouble(EvaluationResult::getRelevancyScore)
            .average()
            .orElse(0.0);

        double avgCompleteness = results.stream()
            .mapToDouble(EvaluationResult::getCompletenessScore)
            .average()
            .orElse(0.0);

        double avgCoherence = results.stream()
            .mapToDouble(EvaluationResult::getCoherenceScore)
            .average()
            .orElse(0.0);

        double overallScore = (avgRelevancy + avgCompleteness + avgCoherence) / 3.0;

        return EvaluationReport.builder()
            .totalTests(results.size())
            .avgRelevancyScore(avgRelevancy)
            .avgCompletenessScore(avgCompleteness)
            .avgCoherenceScore(avgCoherence)
            .overallScore(overallScore)
            .results(results)
            .timestamp(Instant.now())
            .build();
    }
}
```

### 2. æ¸¬è©¦æ¡ˆä¾‹å®šç¾©

```java
/**
 * æ¸¬è©¦æ¡ˆä¾‹
 */
@Data
@Builder
public class TestCase {
    private String id;
    private String question;                    // æ¸¬è©¦å•é¡Œ
    private List<String> expectedKeywords;      // æœŸæœ›åŒ…å«çš„é—œéµè©
    private String expectedAnswer;              // æœŸæœ›ç­”æ¡ˆï¼ˆå¯é¸ï¼‰
    private String category;                    // é¡åˆ¥
}
```

### 3. æ¸¬è©¦æ¡ˆä¾‹ç¯„ä¾‹

```json
// test-cases/basic-qa.json
[
  {
    "id": "test-1",
    "question": "ä»€éº¼æ˜¯ Spring AIï¼Ÿ",
    "expectedKeywords": ["Spring", "AI", "æ¡†æ¶", "äººå·¥æ™ºæ…§"],
    "category": "basic"
  },
  {
    "id": "test-2",
    "question": "å¦‚ä½•é…ç½® OpenAIï¼Ÿ",
    "expectedKeywords": ["OpenAI", "é…ç½®", "API", "application.yml"],
    "category": "configuration"
  },
  {
    "id": "test-3",
    "question": "RAG æ˜¯ä»€éº¼æ„æ€ï¼Ÿ",
    "expectedKeywords": ["RAG", "æª¢ç´¢", "å¢å¼·", "ç”Ÿæˆ"],
    "category": "concept"
  }
]
```

---

## ğŸ”„ æŒçºŒç›£æ§èˆ‡è‡ªå‹•åŒ–

### å®šæœŸè©•ä¼°æœå‹™

```java
@Service
@RequiredArgsConstructor
public class ContinuousEvaluationService {

    private final RAGEvaluationService evaluationService;
    private final TestCaseRepository testCaseRepository;

    /**
     * å®šæœŸåŸ·è¡Œè©•ä¼°ï¼ˆæ¯å°æ™‚ï¼‰
     */
    @Scheduled(fixedRate = 3600000)
    public void performContinuousEvaluation() {

        log.info("é–‹å§‹å®šæœŸè©•ä¼°...");

        // è¼‰å…¥æ¸¬è©¦æ¡ˆä¾‹
        List<TestCase> testCases = testCaseRepository.findActiveTestCases();

        // åŸ·è¡Œè©•ä¼°
        EvaluationReport report = evaluationService.evaluateRagSystem(testCases);

        // æª¢æŸ¥å“è³ªé–¾å€¼
        checkQualityThresholds(report);

        // å„²å­˜å ±å‘Š
        saveReport(report);

        log.info("å®šæœŸè©•ä¼°å®Œæˆï¼Œç¸½é«”åˆ†æ•¸: {}", report.getOverallScore());
    }

    private void checkQualityThresholds(EvaluationReport report) {

        // ç›¸é—œæ€§é–¾å€¼
        if (report.getAvgRelevancyScore() < 0.8) {
            log.warn("ç›¸é—œæ€§åˆ†æ•¸éä½: {}", report.getAvgRelevancyScore());
            // ç™¼é€å‘Šè­¦
        }

        // å®Œæ•´æ€§é–¾å€¼
        if (report.getAvgCompletenessScore() < 0.7) {
            log.warn("å®Œæ•´æ€§åˆ†æ•¸éä½: {}", report.getAvgCompletenessScore());
        }

        // ç¸½é«”åˆ†æ•¸é–¾å€¼
        if (report.getOverallScore() < 0.75) {
            log.error("ç¸½é«”å“è³ªåˆ†æ•¸éä½: {}", report.getOverallScore());
            // ç™¼é€ç·Šæ€¥å‘Šè­¦
        }
    }

    private void saveReport(EvaluationReport report) {
        // å„²å­˜åˆ°è³‡æ–™åº«æˆ–æ–‡ä»¶ç³»çµ±
        try {
            ObjectMapper mapper = new ObjectMapper();
            String json = mapper.writeValueAsString(report);

            Path reportPath = Paths.get("reports",
                "evaluation-" + Instant.now().toString() + ".json");

            Files.createDirectories(reportPath.getParent());
            Files.writeString(reportPath, json);

        } catch (Exception e) {
            log.error("å„²å­˜å ±å‘Šå¤±æ•—", e);
        }
    }
}
```

---

## ğŸ“ˆ ç›£æ§é¢æ¿

### Prometheus æŒ‡æ¨™

```java
@Component
public class RAGMetricsService {

    @Autowired
    private MeterRegistry meterRegistry;

    /**
     * è¨˜éŒ„è©•ä¼°æŒ‡æ¨™
     */
    public void recordEvaluation(EvaluationReport report) {

        // ç›¸é—œæ€§åˆ†æ•¸
        Gauge.builder("rag.evaluation.relevancy", () -> report.getAvgRelevancyScore())
            .register(meterRegistry);

        // å®Œæ•´æ€§åˆ†æ•¸
        Gauge.builder("rag.evaluation.completeness", () -> report.getAvgCompletenessScore())
            .register(meterRegistry);

        // é€£è²«æ€§åˆ†æ•¸
        Gauge.builder("rag.evaluation.coherence", () -> report.getAvgCoherenceScore())
            .register(meterRegistry);

        // ç¸½é«”åˆ†æ•¸
        Gauge.builder("rag.evaluation.overall", () -> report.getOverallScore())
            .register(meterRegistry);
    }
}
```

---

## ğŸ“ é‡é»å›é¡§

### å…§å®¹å¯©æ ¸
âœ… å¤šå±¤å¯©æ ¸ç­–ç•¥ï¼ˆOpenAI + è‡ªå®šç¾©ï¼‰
âœ… é¢¨éšªåˆ†æ•¸è¨ˆç®—
âœ… è‡ªå‹•åŒ–é˜»æ“‹/å‘Šè­¦
âœ… å€‹äººä¿¡æ¯ä¿è­·

### RAG è©•ä¼°
âœ… ç›¸é—œæ€§è©•ä¼°
âœ… å®Œæ•´æ€§è©•ä¼°
âœ… é€£è²«æ€§è©•ä¼°
âœ… æŒçºŒç›£æ§

### å“è³ªä¿è­‰
âœ… è‡ªå‹•åŒ–æ¸¬è©¦
âœ… å®šæœŸè©•ä¼°
âœ… é–¾å€¼å‘Šè­¦
âœ… å ±å‘Šå­˜æª”

---

## ğŸš€ ä¸‹ä¸€æ­¥

ğŸ‘‰ è¿”å› [ç¬¬8ç« ç¸½è¦½](./README.md)

---

**ç›¸é—œç« ç¯€**:
- â† ä¸Šä¸€ç« : [8.3 Re-ranking å¯¦ç¾](./8.3-Re-ranking-å¯¦ç¾.md)
- â†‘ è¿”å›: [ç¬¬8ç« ç¸½è¦½](./README.md)

**åƒè€ƒè³‡æ–™**:
- [OpenAI Moderation API](https://platform.openai.com/docs/guides/moderation)
- [Content Moderation Best Practices](https://openai.com/blog/using-gpt-3-for-content-moderation)
- [Spring AI Advisors](https://docs.spring.io/spring-ai/reference/api/advisors.html)
