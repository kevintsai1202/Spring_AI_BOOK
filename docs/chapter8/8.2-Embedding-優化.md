# 8.2 Embedding å„ªåŒ– - æå‡æª¢ç´¢åŸºç¤

> **å°æ‡‰ç¯„ä¾‹**: `chapter8-advanced-rag`
> **é›£åº¦**: â­â­â­â­â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

Embeddingï¼ˆå‘é‡åµŒå…¥ï¼‰æ˜¯ RAG ç³»çµ±çš„åŸºç¤ã€‚é¸æ“‡åˆé©çš„ Embedding æ¨¡å‹èƒ½ç›´æ¥å½±éŸ¿æª¢ç´¢çš„æº–ç¢ºç‡å’Œæ•ˆæœã€‚æœ¬ç« å°‡æ·±å…¥æ¢è¨å¦‚ä½•å„ªåŒ– Embedding é…ç½®ã€‚

**å­¸ç¿’ç›®æ¨™**:
- ç†è§£ Embedding åœ¨ RAG ä¸­çš„é—œéµä½œç”¨
- æŒæ¡ä¸åŒ Embedding æ¨¡å‹çš„ç‰¹æ€§
- å­¸æœƒé…ç½®å’Œå„ªåŒ– Embedding æœå‹™
- äº†è§£æ•ˆèƒ½ç›£æ§å’Œå¿«å–ç­–ç•¥

---

## ğŸ¯ ç‚ºä»€éº¼ Embedding æ˜¯ RAG çš„é—œéµï¼Ÿ

### RAG ç³»çµ±æ ¸å¿ƒæµç¨‹

```mermaid
graph LR
    A[ç”¨æˆ¶æŸ¥è©¢:<br/>'ä»€éº¼æ˜¯ Spring AI?'] -->|Embedding| B[æŸ¥è©¢å‘é‡<br/>1536 ç¶­]
    C[æ–‡æª”åº«] -->|Embedding| D[æ–‡æª”å‘é‡<br/>1536 ç¶­]
    B -->|é¤˜å¼¦ç›¸ä¼¼åº¦| E[ç›¸ä¼¼åº¦è¨ˆç®—]
    D -->|é¤˜å¼¦ç›¸ä¼¼åº¦| E
    E --> F[Top-K æ–‡æª”]
    F --> G[LLM ç”Ÿæˆç­”æ¡ˆ]

    style B fill:#e3f2fd
    style D fill:#e3f2fd
    style E fill:#e8f5e9
```

**Embedding çš„æ ¸å¿ƒä½œç”¨**:
1. **èªç¾©ç†è§£**: å°‡æ–‡å­—è½‰æ›ç‚ºæ•¸å­¸å‘é‡ï¼Œæ•æ‰èªç¾©ä¿¡æ¯
2. **ç›¸ä¼¼åº¦è¨ˆç®—**: é€šéå‘é‡è·é›¢åˆ¤æ–·æ–‡æª”ç›¸é—œæ€§
3. **æª¢ç´¢åŸºç¤**: å‘é‡å“è³ªç›´æ¥æ±ºå®šæª¢ç´¢æ•ˆæœ

---

## ğŸ’» Embedding æ¨¡å‹æ¯”è¼ƒ

### OpenAI Embedding æ¨¡å‹

| æ¨¡å‹ | ç¶­åº¦ | æº–ç¢ºç‡ | åƒ¹æ ¼ | é©ç”¨å ´æ™¯ |
|------|------|--------|------|----------|
| **text-embedding-ada-002** | 1536 | ~83% | $0.0001/1K tokens | èˆŠç‰ˆï¼Œä¸æ¨è–¦ |
| **text-embedding-3-small** | 512-1536 | ~84% | $0.00002/1K tokens | **æ¨è–¦**ï¼Œæ€§åƒ¹æ¯”æœ€é«˜ |
| **text-embedding-3-large** | 256-3072 | ~90% | $0.00013/1K tokens | é«˜ç²¾åº¦éœ€æ±‚ |

### ç¹é«”ä¸­æ–‡ Embedding è©•æ¸¬

æ ¹æ“š MTEBï¼ˆMassive Text Embedding Benchmarkï¼‰è©•æ¸¬ï¼š

| æ¨¡å‹ | æ’å | æº–ç¢ºç‡ | ç‰¹é» |
|------|------|--------|------|
| **voyage-multilingual-2** | 1 | ~97% | å¤šèªè¨€æœ€ä½³ |
| **multilingual-e5-large** | 6 | ~94% | é–‹æºï¼Œ1024 ç¶­ |
| **multilingual-e5-small** | 4 | ~92% | é–‹æºï¼Œ384 ç¶­ |
| **text-embedding-3-large** | 13 | ~90% | OpenAI é«˜ç²¾åº¦ |
| **text-embedding-3-small** | 23 | ~84% | OpenAI æ€§åƒ¹æ¯” |

> **é‡è¦è§€å¿µ**: ç¶­åº¦ä¸æ˜¯è¶Šé«˜è¶Šå¥½ï¼æ›´é«˜çš„ç¶­åº¦æ„å‘³è‘—æ›´å¤šçš„è¨ˆç®—æˆæœ¬å’Œå­˜å„²ç©ºé–“ã€‚

---

## ğŸ”§ Spring AI Embedding é…ç½®

### 1. åŸºæœ¬é…ç½®

```yaml
# application.yml
spring:
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      embedding:
        options:
          model: text-embedding-3-small  # æ¨è–¦ä½¿ç”¨
          dimensions: 1024               # å¯é¸ï¼Œèª¿æ•´ç¶­åº¦
```

### 2. è‡ªå‹•é…ç½®ä½¿ç”¨

```java
// å°æ‡‰ç¯„ä¾‹: chapter8-advanced-rag/.../service/SmartEmbeddingService.java

@Service
@RequiredArgsConstructor
public class EmbeddingService {

    // Spring AI è‡ªå‹•é…ç½®çš„ EmbeddingModel
    private final EmbeddingModel embeddingModel;

    /**
     * åŸºæœ¬ Embedding æ“ä½œ
     */
    public float[] embed(String text) {
        return embeddingModel.embed(text);
    }

    /**
     * æ‰¹é‡ Embedding
     */
    public List<float[]> batchEmbed(List<String> texts) {
        return embeddingModel.embed(texts);
    }
}
```

### 3. å‹•æ…‹æ¨¡å‹é¸æ“‡

```java
// å°æ‡‰ç¯„ä¾‹: chapter8-advanced-rag/.../service/SmartEmbeddingService.java

@Service
@RequiredArgsConstructor
public class SmartEmbeddingService {

    private final EmbeddingModel embeddingModel;

    /**
     * æ ¹æ“šå ´æ™¯é¸æ“‡ Embedding é…ç½®
     */
    public float[] smartEmbed(String text, EmbeddingContext context) {

        // æ ¹æ“šéœ€æ±‚å‹•æ…‹èª¿æ•´é…ç½®
        OpenAiEmbeddingOptions options;

        if (context.isHighAccuracyRequired()) {
            // é«˜ç²¾åº¦å ´æ™¯
            options = OpenAiEmbeddingOptions.builder()
                .model("text-embedding-3-large")
                .dimensions(3072)
                .build();
        } else if (context.isCostSensitive()) {
            // æˆæœ¬æ•æ„Ÿå ´æ™¯
            options = OpenAiEmbeddingOptions.builder()
                .model("text-embedding-3-small")
                .dimensions(512)
                .build();
        } else {
            // æ¨™æº–å ´æ™¯
            options = OpenAiEmbeddingOptions.builder()
                .model("text-embedding-3-small")
                .dimensions(1024)
                .build();
        }

        // åŸ·è¡Œ Embedding
        EmbeddingResponse response = embeddingModel.call(
            new EmbeddingRequest(List.of(text), options)
        );

        return response.getResults().get(0).getOutput();
    }
}

/**
 * Embedding ä¸Šä¸‹æ–‡é…ç½®
 */
@Data
@Builder
public class EmbeddingContext {
    private boolean highAccuracyRequired;  // æ˜¯å¦éœ€è¦é«˜ç²¾åº¦
    private boolean costSensitive;         // æ˜¯å¦æˆæœ¬æ•æ„Ÿ
    private boolean batchProcessing;       // æ˜¯å¦æ‰¹é‡è™•ç†
}
```

---

## ğŸš€ æ•ˆèƒ½å„ªåŒ–ç­–ç•¥

### 1. å¿«å–æ©Ÿåˆ¶

```java
@Service
public class CachedEmbeddingService {

    @Autowired
    private EmbeddingModel embeddingModel;

    @Autowired
    private RedisTemplate<String, float[]> redisTemplate;

    /**
     * å¸¶å¿«å–çš„ Embedding
     */
    public float[] embedWithCache(String text) {

        // 1. ç”Ÿæˆå¿«å–éµ
        String cacheKey = "emb:" + DigestUtils.md5DigestAsHex(text.getBytes());

        // 2. æª¢æŸ¥å¿«å–
        float[] cached = redisTemplate.opsForValue().get(cacheKey);
        if (cached != null) {
            log.debug("å‘½ä¸­ Embedding å¿«å–");
            return cached;
        }

        // 3. è¨ˆç®— Embedding
        float[] embedding = embeddingModel.embed(text);

        // 4. å­˜å…¥å¿«å–ï¼ˆ24å°æ™‚éæœŸï¼‰
        redisTemplate.opsForValue().set(
            cacheKey,
            embedding,
            Duration.ofHours(24)
        );

        return embedding;
    }
}
```

**å¿«å–å„ªå‹¢**:
- âœ… æ¸›å°‘ API èª¿ç”¨ï¼Œé™ä½æˆæœ¬
- âœ… æå‡å›æ‡‰é€Ÿåº¦ 80%+
- âœ… æ¸›è¼• API é™æµå£“åŠ›

### 2. æ‰¹é‡è™•ç†

```java
@Service
public class BatchEmbeddingService {

    @Autowired
    private EmbeddingModel embeddingModel;

    /**
     * æ‰¹é‡è™•ç†ä»¥æå‡æ•ˆç‡
     */
    public Map<String, float[]> batchEmbed(List<String> texts) {

        // æ‰¹é‡èª¿ç”¨ Embedding API
        List<float[]> embeddings = embeddingModel.embed(texts);

        // å»ºç«‹æ–‡æœ¬åˆ°å‘é‡çš„æ˜ å°„
        Map<String, float[]> result = new HashMap<>();
        for (int i = 0; i < texts.size(); i++) {
            result.put(texts.get(i), embeddings.get(i));
        }

        return result;
    }
}
```

**æ‰¹é‡è™•ç†å„ªå‹¢**:
- âœ… æ¸›å°‘ç¶²è·¯å¾€è¿”æ¬¡æ•¸
- âœ… æå‡è™•ç†é€Ÿåº¦ 50%+
- âœ… æ›´é«˜æ•ˆåˆ©ç”¨ API é…é¡

### 3. æ–‡æœ¬é è™•ç†

```java
@Service
public class TextPreprocessor {

    /**
     * é è™•ç†æ–‡æœ¬ä»¥æå‡ Embedding å“è³ª
     */
    public String preprocess(String text) {

        // 1. æ¸…ç†ç‰¹æ®Šå­—ç¬¦
        String cleaned = text.replaceAll("[^\\u4e00-\\u9fffa-zA-Z0-9\\s.,!?;:()\\[\\]{}\"'-]", " ");

        // 2. æ­£è¦åŒ–ç©ºç™½å­—ç¬¦
        cleaned = cleaned.replaceAll("\\s+", " ").trim();

        // 3. é•·åº¦æ§åˆ¶ï¼ˆé¿å…è¶…éæ¨¡å‹é™åˆ¶ï¼‰
        if (cleaned.length() > 8000) {
            cleaned = cleaned.substring(0, 8000) + "...";
        }

        return cleaned;
    }

    /**
     * æª¢æŸ¥æ–‡æœ¬å“è³ª
     */
    public boolean isQualityText(String text) {

        // æª¢æŸ¥é•·åº¦
        if (text.length() < 10 || text.length() > 10000) {
            return false;
        }

        // æª¢æŸ¥é‡è¤‡å­—ç¬¦
        if (text.matches(".*(.)\\1{10,}.*")) {
            return false;
        }

        // æª¢æŸ¥å­—ç¬¦å¤šæ¨£æ€§
        Set<Character> uniqueChars = text.chars()
            .mapToObj(c -> (char) c)
            .collect(Collectors.toSet());

        double diversity = (double) uniqueChars.size() / text.length();
        return diversity > 0.1;
    }
}
```

---

## ğŸ“Š æ•ˆèƒ½ç›£æ§

### ç›£æ§æŒ‡æ¨™

```java
// å°æ‡‰ç¯„ä¾‹: chapter8-advanced-rag/.../service/RAGMetricsService.java

@Service
public class EmbeddingMetricsService {

    @Autowired
    private MeterRegistry meterRegistry;

    /**
     * è¨˜éŒ„ Embedding æŒ‡æ¨™
     */
    public void recordEmbedding(String model, int textLength, long duration) {

        // è¨˜éŒ„è™•ç†æ™‚é–“
        Timer.builder("embedding.processing.time")
            .tag("model", model)
            .register(meterRegistry)
            .record(duration, TimeUnit.MILLISECONDS);

        // è¨˜éŒ„æ–‡æœ¬é•·åº¦
        Counter.builder("embedding.text.length")
            .tag("model", model)
            .register(meterRegistry)
            .increment(textLength);

        // è¨˜éŒ„è™•ç†é€Ÿåº¦ï¼ˆå­—ç¬¦/ç§’ï¼‰
        double speed = textLength / (duration / 1000.0);
        Gauge.builder("embedding.processing.speed", () -> speed)
            .tag("model", model)
            .register(meterRegistry);
    }
}
```

### Prometheus ç›£æ§é¢æ¿

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'spring-ai-rag'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['localhost:8080']
```

**é—œéµæŒ‡æ¨™**:
- `embedding.processing.time` - è™•ç†æ™‚é–“
- `embedding.cache.hit.rate` - å¿«å–å‘½ä¸­ç‡
- `embedding.api.calls` - API èª¿ç”¨æ¬¡æ•¸
- `embedding.cost.total` - ç¸½æˆæœ¬

---

## ğŸ¯ æ¨¡å‹é¸æ“‡å»ºè­°

### å ´æ™¯æ¨è–¦

```mermaid
graph TD
    A[é¸æ“‡ Embedding æ¨¡å‹] --> B{é ç®—å……è¶³?}
    B -->|æ˜¯| C{éœ€è¦æ¥µé«˜ç²¾åº¦?}
    B -->|å¦| D[text-embedding-3-small]
    C -->|æ˜¯| E[text-embedding-3-large]
    C -->|å¦| F[voyage-multilingual-2]
    D --> G[ç¶­åº¦: 512-1024]
    E --> H[ç¶­åº¦: 3072]
    F --> I[å¤šèªè¨€æœ€ä½³]

    style D fill:#c8e6c9
    style E fill:#fff4e6
    style F fill:#e1f5ff
```

### æ±ºç­–çŸ©é™£

| å ´æ™¯ | æ¨è–¦æ¨¡å‹ | ç¶­åº¦ | ç†ç”± |
|------|----------|------|------|
| **é–‹ç™¼æ¸¬è©¦** | text-embedding-3-small | 512 | å¿«é€Ÿã€ä¾¿å®œ |
| **ç”Ÿç”¢ç’°å¢ƒ** | text-embedding-3-small | 1024 | æ€§åƒ¹æ¯”æœ€é«˜ |
| **é«˜ç²¾åº¦éœ€æ±‚** | text-embedding-3-large | 3072 | æœ€é«˜æº–ç¢ºç‡ |
| **å¤šèªè¨€æ‡‰ç”¨** | voyage-multilingual-2 | 1024 | ä¸­æ–‡å‹å¥½ |
| **é–‹æºéœ€æ±‚** | multilingual-e5-large | 1024 | ç„¡ API æˆæœ¬ |

---

## ğŸ’¡ æœ€ä½³å¯¦è¸

### 1. åˆç†è¨­ç½®ç¶­åº¦

```yaml
# æ¨è–¦é…ç½®
spring:
  ai:
    openai:
      embedding:
        options:
          model: text-embedding-3-small
          dimensions: 1024  # å¹³è¡¡ç²¾åº¦å’Œæˆæœ¬
```

**åŸå‰‡**:
- é–‹ç™¼ç’°å¢ƒï¼š512 ç¶­ï¼ˆå¿«é€Ÿæ¸¬è©¦ï¼‰
- ç”Ÿç”¢ç’°å¢ƒï¼š1024 ç¶­ï¼ˆæ¨™æº–é…ç½®ï¼‰
- é«˜ç²¾åº¦å ´æ™¯ï¼š3072 ç¶­ï¼ˆtext-embedding-3-largeï¼‰

### 2. å¯¦ç¾å¿«å–ç­–ç•¥

```java
@Configuration
public class CacheConfiguration {

    @Bean
    public CacheManager cacheManager(RedisConnectionFactory factory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofHours(24))  // 24å°æ™‚éæœŸ
            .serializeValuesWith(
                RedisSerializationContext.SerializationPair.fromSerializer(
                    new GenericJackson2JsonRedisSerializer()
                )
            );

        return RedisCacheManager.builder(factory)
            .cacheDefaults(config)
            .build();
    }
}
```

### 3. ç›£æ§å’Œå‘Šè­¦

```yaml
# application.yml
management:
  endpoints:
    web:
      exposure:
        include: health,metrics,prometheus
  metrics:
    export:
      prometheus:
        enabled: true
```

---

## ğŸ“ é‡é»å›é¡§

### Embedding æ ¸å¿ƒåƒ¹å€¼
âœ… æ±ºå®šæª¢ç´¢åŸºç¤å“è³ª
âœ… å½±éŸ¿æ•´é«” RAG æ•ˆæœ
âœ… æˆæœ¬å’Œæ•ˆèƒ½çš„å¹³è¡¡é»
âœ… æ”¯æ´å¤šèªè¨€æ‡‰ç”¨

### å„ªåŒ–ç­–ç•¥
âœ… é¸æ“‡åˆé©çš„æ¨¡å‹å’Œç¶­åº¦
âœ… å¯¦ç¾å¿«å–æ©Ÿåˆ¶
âœ… æ‰¹é‡è™•ç†æå‡æ•ˆç‡
âœ… æ–‡æœ¬é è™•ç†æå‡å“è³ª

### ç›£æ§è¦é»
âœ… è™•ç†æ™‚é–“å’Œé€Ÿåº¦
âœ… å¿«å–å‘½ä¸­ç‡
âœ… API èª¿ç”¨æ¬¡æ•¸
âœ… æˆæœ¬æ§åˆ¶

---

## ğŸš€ ä¸‹ä¸€æ­¥

ğŸ‘‰ [8.3 Re-ranking å¯¦ç¾](./8.3-Re-ranking-å¯¦ç¾.md) - ç²¾æº–æ’åºæŠ€è¡“

---

**ç›¸é—œç« ç¯€**:
- â† ä¸Šä¸€ç« : [8.1 Advanced RAG ç°¡ä»‹](./8.1-Advanced-RAG-ç°¡ä»‹.md)
- â†’ ä¸‹ä¸€ç« : [8.3 Re-ranking å¯¦ç¾](./8.3-Re-ranking-å¯¦ç¾.md)

**åƒè€ƒè³‡æ–™**:
- [OpenAI Embeddings Guide](https://platform.openai.com/docs/guides/embeddings)
- [MTEB: Massive Text Embedding Benchmark](https://arxiv.org/abs/2210.07316)
- [Spring AI Embeddings API](https://docs.spring.io/spring-ai/reference/api/embeddings.html)
