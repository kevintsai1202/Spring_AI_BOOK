# 8.3 Re-ranking å¯¦ç¾ - Voyage AI

> **å°æ‡‰ç¯„ä¾‹**: `chapter8-advanced-rag`
> **é›£åº¦**: â­â­â­â­â˜†
> **ä½¿ç”¨æ¨¡å‹**: Voyage AI rerank-2.5

---

## ğŸ“š æœ¬ç« æ¦‚è¦

Re-rankingï¼ˆé‡æ’åºï¼‰æ˜¯ Advanced RAG ä¸­æœ€é—œéµçš„æŠ€è¡“ä¹‹ä¸€ã€‚æœ¬ç« å°‡ä»‹ç´¹å¦‚ä½•ä½¿ç”¨ Voyage AI çš„ rerank-2.5 æ¨¡å‹ä¾†å¯¦ç¾é«˜ç²¾åº¦çš„æ–‡æª”é‡æ’åºã€‚

**å­¸ç¿’ç›®æ¨™**:
- ç†è§£ Re-ranking çš„å·¥ä½œåŸç†
- æŒæ¡ Voyage AI rerank-2.5 çš„ä½¿ç”¨æ–¹æ³•
- å­¸æœƒå¯¦ç¾ Re-ranking RAG Advisor
- äº†è§£å¤šéšæ®µæª¢ç´¢æµç¨‹

---

## ğŸ¯ ç‚ºä»€éº¼éœ€è¦ Re-ranking?

### å‘é‡æª¢ç´¢çš„é™åˆ¶

```mermaid
graph LR
    A[ç”¨æˆ¶æŸ¥è©¢:<br/>'Spring AI RAG'] -->|Embedding| B[å‘é‡<br/>768ç¶­]
    B -->|é¤˜å¼¦ç›¸ä¼¼åº¦| C[Top 10 æ–‡æª”]
    C --> D{å•é¡Œ}
    D -->|èªç¾©ç›¸ä¼¼<br/>ä½†ä¸ç›¸é—œ| E[âŒ éŒ¯èª¤çµæœ]
    D -->|é—œéµè©åŒ¹é…<br/>ä½†èªç¾©ä¸åŒ| F[âŒ éŒ¯èª¤çµæœ]

    style E fill:#ffcccc
    style F fill:#ffcccc
```

**å‘é‡æª¢ç´¢çš„å•é¡Œ**:
1. âŒ **èªç¾©æ¼‚ç§»**: "Spring AI" å¯èƒ½åŒ¹é…åˆ° "Spring Framework"
2. âŒ **é—œéµè©è¿·æƒ‘**: åŒ¹é…åˆ°å«æœ‰é—œéµè©ä½†ä¸»é¡Œä¸ç›¸é—œçš„æ–‡æª”
3. âŒ **æ’åºä¸æº–**: ç›¸ä¼¼åº¦åˆ†æ•¸ä¸ç­‰æ–¼ç›¸é—œåº¦åˆ†æ•¸

### Re-ranking çš„è§£æ±ºæ–¹æ¡ˆ

```mermaid
graph LR
    A[ç²—æª¢ç´¢<br/>Top 50] -->|Re-ranking<br/>Model| B[ç²¾ç¢ºè©•åˆ†]
    B --> C[ç²¾æ’ Top 5]
    C --> D[âœ… é«˜å“è³ªçµæœ]

    style A fill:#fff4e6
    style B fill:#e8f5e9
    style C fill:#e1f5ff
    style D fill:#c8e6c9
```

**Re-ranking çš„å„ªå‹¢**:
- âœ… ç²¾ç¢ºç†è§£æŸ¥è©¢èˆ‡æ–‡æª”çš„ç›¸é—œæ€§
- âœ… è€ƒæ…®ä¸Šä¸‹æ–‡å’Œèªç¾©ç´°ç¯€
- âœ… å¤§å¹…æå‡æª¢ç´¢ç²¾åº¦ï¼ˆ+20-30%ï¼‰

---

## ğŸ’» Voyage AI Re-ranking å¯¦ç¾

### 1. ä¾è³´é…ç½®

```xml
<dependencies>
    <!-- Spring AI OpenAI -->
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-openai-spring-boot-starter</artifactId>
    </dependency>

    <!-- Spring AI Vector Store -->
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-pgvector-store-spring-boot-starter</artifactId>
    </dependency>

    <!-- HTTP Client for Voyage API -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
</dependencies>
```

### 2. Voyage Re-ranking Provider

```java
// å°æ‡‰ç¯„ä¾‹: chapter8-advanced-rag/.../reranking/VoyageRerankingProvider.java

/**
 * Voyage AI Re-ranking æä¾›è€…
 * ä½¿ç”¨ Voyage AI çš„ rerank-2.5 æ¨¡å‹é€²è¡Œæ–‡æª”é‡æ’
 *
 * å„ªé»ï¼š
 * - æ”¯æ´å¤šèªè¨€ï¼ˆåŒ…æ‹¬ä¸­æ–‡ï¼‰
 * - ç²¾ç¢ºåº¦é«˜
 * - API ç©©å®š
 */
@Slf4j
public class VoyageRerankingProvider implements RerankingProvider {

    private static final String VOYAGE_API_URL = "https://api.voyageai.com/v1/rerank";
    private static final String DEFAULT_MODEL = "rerank-2.5";

    private final RestClient restClient;
    private final String apiKey;
    private final String model;

    /**
     * Voyage AI Re-ranking API éŸ¿æ‡‰
     */
    @JsonInclude(JsonInclude.Include.NON_NULL)
    public record VoyageRerankResponse(
            @JsonProperty("object") String object,
            @JsonProperty("data") List<VoyageRerankItem> data,
            @JsonProperty("model") String model,
            @JsonProperty("usage") VoyageUsage usage
    ) {}

    /**
     * Re-ranking é …ç›®
     */
    @JsonInclude(JsonInclude.Include.NON_NULL)
    public record VoyageRerankItem(
            @JsonProperty("index") Integer index,
            @JsonProperty("relevance_score") Double relevanceScore,
            @JsonProperty("document") String document
    ) {}

    @Override
    public List<RerankResult> rerank(String query, List<Document> documents, int topK) {

        log.info("é–‹å§‹ Voyage AI Re-rankingï¼Œæ–‡æª”æ•¸: {}, topK: {}", documents.size(), topK);

        // æº–å‚™ API è«‹æ±‚
        Map<String, Object> requestBody = new HashMap<>();
        requestBody.put("query", query);
        requestBody.put("model", model);
        requestBody.put("top_k", Math.min(topK, documents.size()));
        requestBody.put("return_documents", true);
        requestBody.put("documents", documents.stream()
                .map(Document::getText)
                .collect(Collectors.toList()));

        // èª¿ç”¨ Voyage API
        ResponseEntity<VoyageRerankResponse> response = restClient.post()
                .uri(VOYAGE_API_URL)
                .contentType(MediaType.APPLICATION_JSON)
                .header("Authorization", "Bearer " + apiKey)
                .body(requestBody)
                .retrieve()
                .toEntity(new ParameterizedTypeReference<VoyageRerankResponse>() {});

        // è§£æçµæœ
        VoyageRerankResponse body = response.getBody();
        List<RerankResult> results = new ArrayList<>();

        for (int i = 0; i < body.data().size(); i++) {
            VoyageRerankItem item = body.data().get(i);
            Document originalDoc = documents.get(item.index());

            results.add(RerankResult.builder()
                    .document(originalDoc)
                    .originalIndex(item.index())
                    .newIndex(i)
                    .relevanceScore(item.relevanceScore())
                    .providerName("voyage-ai")
                    .build());
        }

        log.info("Voyage AI Re-ranking å®Œæˆï¼Œè¿”å› {} å€‹çµæœ", results.size());
        return results;
    }
}
```

### 3. Re-ranking RAG Advisor

```java
// å°æ‡‰ç¯„ä¾‹: chapter8-advanced-rag/.../advisor/RerankRAGAdvisor.java

/**
 * Re-ranking RAG Advisor
 * å¯¦ç¾å…©éšæ®µæª¢ç´¢æµç¨‹ï¼š
 * 1. ç²—æª¢ç´¢ï¼šå‘é‡æª¢ç´¢ Top 50
 * 2. ç²¾æª¢ç´¢ï¼šRe-ranking Top 5
 */
@Slf4j
public class RerankRAGAdvisor implements BaseAdvisor {

    private final VectorStore vectorStore;
    private final RerankingProvider rerankingProvider;
    private final RAGProperties ragProperties;

    @Override
    public ChatClientRequest before(ChatClientRequest request, AdvisorChain chain) {

        // ç²å–ç”¨æˆ¶æŸ¥è©¢
        String userQuery = request.prompt().getUserMessage().getText();
        log.info("é–‹å§‹ RAG è™•ç†ï¼ŒæŸ¥è©¢: {}", userQuery);

        // ===== ç¬¬ä¸€éšæ®µï¼šç²—æª¢ç´¢ =====
        int firstStageTopK = ragProperties.getReranking().getFirstStageTopK(); // 50
        List<Document> retrievedDocuments = vectorStore.similaritySearch(
            SearchRequest.builder()
                .query(userQuery)
                .topK(firstStageTopK)
                .build()
        );
        log.info("ç²—æª¢ç´¢å®Œæˆï¼Œæª¢ç´¢åˆ° {} å€‹æ–‡æª”", retrievedDocuments.size());

        // ===== ç¬¬äºŒéšæ®µï¼šRe-ranking =====
        int finalTopK = ragProperties.getReranking().getFinalTopK(); // 5
        List<RerankResult> rerankedResults = rerankingProvider.rerank(
            userQuery,
            retrievedDocuments,
            finalTopK
        );
        log.info("Re-ranking å®Œæˆï¼Œè¿”å› {} å€‹æ–‡æª”", rerankedResults.size());

        // ===== çµ„æˆä¸Šä¸‹æ–‡ =====
        String documentContext = rerankedResults.stream()
                .map(result -> result.getDocument().getText())
                .collect(Collectors.joining(System.lineSeparator()));

        // ===== æ§‹å»º Prompt =====
        String contextPrompt = """
            Context information is below.
            ---------------------
            %s
            ---------------------
            Given the context information, answer the question.
            If the answer is not in the context, say so.
            """.formatted(documentContext);

        // å¢å¼·ç”¨æˆ¶æ¶ˆæ¯
        return request.mutate()
                .prompt(request.prompt().augmentUserMessage(contextPrompt))
                .build();
    }
}
```

---

## ğŸ”§ é…ç½®å’Œä½¿ç”¨

### 1. é…ç½®æ–‡ä»¶

```yaml
# application.yml
spring:
  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      chat:
        options:
          model: gpt-4o-mini
      embedding:
        options:
          model: text-embedding-3-small
    vectorstore:
      pgvector:
        host: localhost
        port: 5432
        database: vector_db
        username: postgres
        password: password

# Advanced RAG é…ç½®
advanced-rag:
  reranking:
    provider: voyage        # ä½¿ç”¨ Voyage AI
    first-stage-top-k: 50   # ç²—æª¢ç´¢ï¼šå– 50 å€‹å€™é¸
    final-top-k: 5          # Re-rankingï¼šç²¾é¸ 5 å€‹

  voyage:
    api-key: ${VOYAGE_API_KEY}
    model: rerank-2.5       # Voyage rerank æ¨¡å‹ç‰ˆæœ¬
```

### 2. Bean é…ç½®

```java
@Configuration
public class RerankingConfiguration {

    @Bean
    public RerankingProvider voyageRerankingProvider(
            RestClient.Builder restClientBuilder,
            @Value("${advanced-rag.voyage.api-key}") String apiKey,
            @Value("${advanced-rag.voyage.model}") String model) {

        return new VoyageRerankingProvider(
            restClientBuilder.build(),
            apiKey,
            model
        );
    }

    @Bean
    public RerankRAGAdvisor rerankRAGAdvisor(
            VectorStore vectorStore,
            RerankingProvider rerankingProvider,
            RAGProperties ragProperties) {

        return new RerankRAGAdvisor(
            vectorStore,
            rerankingProvider,
            ragProperties
        );
    }

    @Bean
    public ChatClient advancedRAGChatClient(
            ChatModel chatModel,
            RerankRAGAdvisor rerankRAGAdvisor) {

        return ChatClient.builder(chatModel)
            .defaultAdvisors(rerankRAGAdvisor)
            .build();
    }
}
```

### 3. ä½¿ç”¨ç¯„ä¾‹

```java
@RestController
@RequestMapping("/api/rag")
@RequiredArgsConstructor
public class RAGController {

    private final ChatClient advancedRAGChatClient;

    /**
     * Advanced RAG æŸ¥è©¢ï¼ˆè‡ªå‹•åŸ·è¡Œ Re-rankingï¼‰
     */
    @PostMapping("/query")
    public AdvancedRAGResponse query(@RequestBody String userQuery) {

        String response = advancedRAGChatClient.prompt()
            .user(userQuery)
            .call()
            .content();

        return AdvancedRAGResponse.builder()
            .query(userQuery)
            .answer(response)
            .success(true)
            .build();
    }
}
```

---

## ğŸ“Š æ•ˆæœå°æ¯”

### æ¸¬è©¦çµæœ

```
æ¸¬è©¦æŸ¥è©¢ï¼š"å¦‚ä½•åœ¨ Spring AI ä¸­å¯¦ç¾ RAGï¼Ÿ"

=== ç²—æª¢ç´¢ï¼ˆå‘é‡æª¢ç´¢ Top 50ï¼‰===
1. [0.82] Spring AI æ¡†æ¶ä»‹ç´¹
2. [0.81] RAG åŸºç¤æ¦‚å¿µ
3. [0.80] Spring Boot é…ç½®
4. [0.79] Spring Framework æ ¸å¿ƒ
5. [0.78] Spring AI RAG å¯¦ç¾  âœ“ (æœ€ç›¸é—œ)

=== Re-rankingï¼ˆVoyage rerank-2.5 Top 5ï¼‰===
1. [0.95] Spring AI RAG å¯¦ç¾  âœ“ (æå‡åˆ°ç¬¬ä¸€!)
2. [0.89] RAG åŸºç¤æ¦‚å¿µ
3. [0.84] Spring AI æ¡†æ¶ä»‹ç´¹
4. [0.76] VectorStore é…ç½®
5. [0.72] Advisor é–‹ç™¼æŒ‡å—
```

**æ•ˆæœåˆ†æ**:
- âœ… æœ€ç›¸é—œçš„æ–‡æª”å¾ç¬¬5ä½æå‡åˆ°ç¬¬1ä½
- âœ… Relevance Score å¾ 0.78 æå‡åˆ° 0.95
- âœ… æº–ç¢ºç‡æå‡ç´„ 30%

---

## ğŸ¯ æœ€ä½³å¯¦è¸

### 1. åˆç†è¨­ç½®æª¢ç´¢æ•¸é‡

```yaml
# æ¨è–¦é…ç½®
advanced-rag:
  reranking:
    first-stage-top-k: 50   # ç²—æª¢ç´¢ï¼šå€™é¸æ•¸é‡è¦è¶³å¤ å¤š
    final-top-k: 5          # Re-rankingï¼šç²¾é¸å°‘é‡é«˜è³ªé‡æ–‡æª”
```

**åŸå‰‡**:
- ç²—æª¢ç´¢è¦å¤šï¼ˆ30-100ï¼‰ï¼Œç¢ºä¿å¬å›ç‡
- Re-rankingè¦å°‘ï¼ˆ3-10ï¼‰ï¼Œç¢ºä¿ç²¾ç¢ºç‡
- æ¯”ä¾‹å»ºè­° 10:1

### 2. éŒ¯èª¤è™•ç†å’Œé™ç´š

```java
@Override
public ChatClientRequest before(ChatClientRequest request, AdvisorChain chain) {
    try {
        // å˜—è©¦ Re-ranking
        List<RerankResult> results = rerankingProvider.rerank(...);
        return enhanceRequest(request, results);

    } catch (Exception e) {
        log.error("Re-ranking å¤±æ•—ï¼Œä½¿ç”¨åŸå§‹æª¢ç´¢çµæœ", e);

        // é™ç´šè™•ç†ï¼šç›´æ¥ä½¿ç”¨ç²—æª¢ç´¢çµæœ
        return enhanceRequest(request, retrievedDocuments.subList(0, finalTopK));
    }
}
```

### 3. ç›£æ§å’ŒæŒ‡æ¨™

```java
@Component
public class RerankingMetrics {

    @Autowired
    private MeterRegistry meterRegistry;

    public void recordReranking(int originalCount, int finalCount, long duration) {

        // è¨˜éŒ„è™•ç†æ™‚é–“
        Timer.builder("reranking.processing.time")
            .register(meterRegistry)
            .record(duration, TimeUnit.MILLISECONDS);

        // è¨˜éŒ„å£“ç¸®æ¯”
        double compressionRatio = (double) finalCount / originalCount;
        Gauge.builder("reranking.compression.ratio", () -> compressionRatio)
            .register(meterRegistry);
    }
}
```

---

## ğŸ“ é‡é»å›é¡§

### Re-ranking æ ¸å¿ƒåƒ¹å€¼
âœ… æå‡æª¢ç´¢ç²¾åº¦ +20-30%
âœ… æ”¹å–„ç”¨æˆ¶é«”é©—
âœ… é™ä½éŒ¯èª¤ç­”æ¡ˆç‡
âœ… æé«˜æ–‡æª”ç›¸é—œæ€§

### Voyage AI rerank-2.5 å„ªå‹¢
âœ… å¤šèªè¨€æ”¯æ´ï¼ˆä¸­æ–‡å‹å¥½ï¼‰
âœ… é«˜ç²¾ç¢ºåº¦
âœ… API ç©©å®šå¯é 
âœ… åƒ¹æ ¼åˆç†

### å¯¦ç¾è¦é»
âœ… å…©éšæ®µæª¢ç´¢ï¼šç²—æª¢ç´¢ + Re-ranking
âœ… åˆç†é…ç½®æ•¸é‡æ¯”ä¾‹
âœ… éŒ¯èª¤è™•ç†å’Œé™ç´šç­–ç•¥
âœ… æ€§èƒ½ç›£æ§å’Œå„ªåŒ–

---

## ğŸš€ ä¸‹ä¸€æ­¥

ğŸ‘‰ [8.4 å…§å®¹å¯©æ ¸èˆ‡è©•ä¼°](./8.4-å…§å®¹å¯©æ ¸èˆ‡è©•ä¼°.md) - ç¢ºä¿ç­”æ¡ˆå“è³ª

---

**ç›¸é—œç« ç¯€**:
- â† ä¸Šä¸€ç« : [8.2 Embedding å„ªåŒ–](./8.2-Embedding-å„ªåŒ–.md)
- â†’ ä¸‹ä¸€ç« : [8.4 å…§å®¹å¯©æ ¸èˆ‡è©•ä¼°](./8.4-å…§å®¹å¯©æ ¸èˆ‡è©•ä¼°.md)

**åƒè€ƒè³‡æ–™**:
- [Voyage AI Rerank Documentation](https://docs.voyageai.com/docs/reranker)
- [RankGPT: Listwise Passage Re-ranking](https://arxiv.org/abs/2304.09542)
- [Learning to Rank for Information Retrieval](https://link.springer.com/book/10.1007/978-3-642-14267-3)
