# 3.2 æª”æ¡ˆä¸Šå‚³èˆ‡ä¸‹è¼‰

> **å°æ‡‰ç« ç¯€**: ç¬¬3ç«  - ä¼æ¥­ç´šåŠŸèƒ½
> **å°æ‡‰ç¯„ä¾‹**: `chapter3-enterprise-features`
> **é›£åº¦**: â­â­â­â˜†â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

æª”æ¡ˆè™•ç†æ˜¯ç¾ä»£ Web æ‡‰ç”¨çš„åŸºç¤åŠŸèƒ½ï¼Œç‰¹åˆ¥æ˜¯åœ¨ AI æ‡‰ç”¨ä¸­ï¼Œå¤šæ¨¡æ…‹è¼¸å…¥ï¼ˆåœ–ç‰‡ã€éŸ³è¨Šã€æ–‡ä»¶ï¼‰çš„è™•ç†è‡³é—œé‡è¦ã€‚æœ¬ç« å°‡å¸¶ä½ æŒæ¡ Spring Boot çš„æª”æ¡ˆè™•ç†æ©Ÿåˆ¶ã€å®‰å…¨æ€§è€ƒé‡å’Œæœ€ä½³å¯¦è¸ã€‚

**å­¸ç¿’ç›®æ¨™**:
- ç†è§£ HTTP æª”æ¡ˆä¸Šå‚³çš„å·¥ä½œåŸç†
- æŒæ¡ MultipartFile çš„ä½¿ç”¨æ–¹æ³•
- å¯¦ç¾å®‰å…¨çš„æª”æ¡ˆä¸Šå‚³èˆ‡ä¸‹è¼‰åŠŸèƒ½
- å»ºç«‹å®Œæ•´çš„æª”æ¡ˆå…ƒè³‡æ–™ç®¡ç†
- ç‚º AI æ‡‰ç”¨çš„å¤šæ¨¡æ…‹è¼¸å…¥åšæº–å‚™

---

## 3.2.1 æª”æ¡ˆè™•ç†çš„é‡è¦æ€§

åœ¨ç¾ä»£ Web æ‡‰ç”¨ä¸­ï¼Œæª”æ¡ˆè™•ç†æ˜¯ä¸€é …åŸºç¤ä¸”é‡è¦çš„åŠŸèƒ½ï¼š

### å¸¸è¦‹æ‡‰ç”¨å ´æ™¯

```mermaid
graph TB
    FileAPI[Spring Boot æª”æ¡ˆ API<br/>æ ¸å¿ƒè™•ç†æ¨¡çµ„]

    subgraph Scene1["ğŸ“± ä½¿ç”¨è€…å…§å®¹ç®¡ç†"]
        direction TB
        UC1[å€‹äººé ­åƒä¸Šå‚³]
        UC2[æ–‡ä»¶é™„ä»¶è™•ç†]
        UC3[å¤šåª’é«”åˆ†äº«]
    end

    subgraph Scene2["ğŸ¢ ä¼æ¥­æ–‡ä»¶ç³»çµ±"]
        direction TB
        ED1[åˆç´„æ–‡ä»¶ä¸Šå‚³]
        ED2[å ±è¡¨æª”æ¡ˆä¸‹è¼‰]
        ED3[å‚™ä»½æª”æ¡ˆç®¡ç†]
    end

    subgraph Scene3["ğŸ›’ é›»å•†æ‡‰ç”¨"]
        direction TB
        EC1[å•†å“åœ–ç‰‡ä¸Šå‚³]
        EC2[ç”¢å“ç›®éŒ„åŒ¯å…¥]
        EC3[è¨‚å–®é™„ä»¶è™•ç†]
    end

    subgraph Scene4["ğŸ¤– AI æ‡‰ç”¨å ´æ™¯ â­"]
        direction TB
        AI1[åœ–ç‰‡åˆ†æè™•ç†]
        AI2[éŸ³è¨Šè½‰æ–‡å­—]
        AI3[PDF æ–‡ä»¶è§£æ]
        AI4[è¨“ç·´è³‡æ–™ä¸Šå‚³]
    end

    FileAPI --> Scene1
    FileAPI --> Scene2
    FileAPI --> Scene3
    FileAPI --> Scene4

    Scene1 --> UC1
    Scene1 --> UC2
    Scene1 --> UC3

    Scene2 --> ED1
    Scene2 --> ED2
    Scene2 --> ED3

    Scene3 --> EC1
    Scene3 --> EC2
    Scene3 --> EC3

    Scene4 --> AI1
    Scene4 --> AI2
    Scene4 --> AI3
    Scene4 --> AI4

    style FileAPI fill:#4CAF50,color:#fff,stroke:#2E7D32,stroke-width:3px
    style Scene1 fill:#E3F2FD,stroke:#1976D2,stroke-width:2px
    style Scene2 fill:#FFF3E0,stroke:#F57C00,stroke-width:2px
    style Scene3 fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px
    style Scene4 fill:#FFEBEE,stroke:#C62828,stroke-width:3px
    style AI1 fill:#FF9800,color:#fff
    style AI2 fill:#FF9800,color:#fff
    style AI3 fill:#FF9800,color:#fff
    style AI4 fill:#FF9800,color:#fff
```

### å ´æ™¯è©³ç´°èªªæ˜

| å ´æ™¯é¡å‹ | å…·é«”æ‡‰ç”¨ | æŠ€è¡“è¦æ±‚ | Spring AI æ•´åˆ |
|---------|---------|---------|---------------|
| **ä½¿ç”¨è€…å…§å®¹** | å€‹äººé ­åƒã€ç°¡æ­·é™„ä»¶ | æª”æ¡ˆå¤§å°é™åˆ¶ã€æ ¼å¼é©—è­‰ | åœ–ç‰‡å£“ç¸®ã€å…§å®¹å¯©æ ¸ |
| **ä¼æ¥­æ–‡ä»¶** | åˆç´„ã€å ±è¡¨ã€å‚™ä»½ | å®‰å…¨æ€§ã€æ¬Šé™æ§åˆ¶ | æ–‡ä»¶æ‘˜è¦ã€æ™ºèƒ½åˆ†é¡ |
| **é›»å•†æ‡‰ç”¨** | å•†å“åœ–ç‰‡ã€æ‰¹æ¬¡åŒ¯å…¥ | æ•ˆèƒ½å„ªåŒ–ã€æ‰¹æ¬¡è™•ç† | åœ–ç‰‡æ¨™ç±¤ã€å•†å“æè¿°ç”Ÿæˆ |
| **AI æ‡‰ç”¨** | è¨“ç·´è³‡æ–™ã€å¤šæ¨¡æ…‹è¼¸å…¥ | å¤§æª”æ¡ˆè™•ç†ã€æ ¼å¼è½‰æ› | å‘é‡åŒ–ã€RAG çŸ¥è­˜åº« â­ |

> ğŸ’¡ **é‡é»**ï¼šè‰¯å¥½çš„æª”æ¡ˆè™•ç†æ©Ÿåˆ¶ä¸åƒ…è¦è€ƒæ…®åŠŸèƒ½å¯¦ç¾ï¼Œé‚„è¦é‡è¦–å®‰å…¨æ€§ã€æ•ˆèƒ½å’Œä½¿ç”¨è€…é«”é©—ã€‚ç‰¹åˆ¥æ˜¯åœ¨ AI æ‡‰ç”¨ä¸­ï¼Œæª”æ¡ˆè™•ç†æ˜¯å¯¦ç¾å¤šæ¨¡æ…‹ AI åŠŸèƒ½çš„åŸºç¤ã€‚

---

## 3.2.2 HTTP æª”æ¡ˆä¸Šå‚³åŸç†

æª”æ¡ˆä¸Šå‚³é€é HTTP çš„ `multipart/form-data` ç·¨ç¢¼æ–¹å¼å¯¦ç¾ã€‚

### æª”æ¡ˆä¸Šå‚³å®Œæ•´æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ¶ç«¯<br/>(ç€è¦½å™¨/å‰ç«¯)
    participant Controller as Spring Controller
    participant Validator as æª”æ¡ˆé©—è­‰å™¨
    participant Storage as æª”æ¡ˆå„²å­˜æœå‹™
    participant DB as è³‡æ–™åº«
    participant FileSystem as æª”æ¡ˆç³»çµ±

    Client->>Controller: 1. POST /api/files/upload<br/>multipart/form-data
    activate Controller

    Controller->>Controller: 2. æ¥æ”¶ MultipartFile

    Controller->>Validator: 3. é©—è­‰æª”æ¡ˆ
    activate Validator
    Validator->>Validator: æª¢æŸ¥æª”æ¡ˆé¡å‹
    Validator->>Validator: æª¢æŸ¥æª”æ¡ˆå¤§å°
    Validator->>Validator: æª¢æŸ¥æª”æ¡ˆå…§å®¹
    Validator-->>Controller: é©—è­‰çµæœ
    deactivate Validator

    alt é©—è­‰å¤±æ•—
        Controller-->>Client: 400 Bad Request<br/>éŒ¯èª¤è¨Šæ¯
    else é©—è­‰æˆåŠŸ
        Controller->>Storage: 4. å„²å­˜æª”æ¡ˆ
        activate Storage

        Storage->>Storage: 5. ç”¢ç”Ÿå”¯ä¸€æª”å
        Storage->>FileSystem: 6. å¯«å…¥æª”æ¡ˆç³»çµ±
        activate FileSystem
        FileSystem-->>Storage: æª”æ¡ˆè·¯å¾‘
        deactivate FileSystem

        Storage->>DB: 7. å„²å­˜æª”æ¡ˆå…ƒè³‡æ–™
        activate DB
        DB-->>Storage: å…ƒè³‡æ–™ ID
        deactivate DB

        Storage-->>Controller: æª”æ¡ˆè³‡è¨Š
        deactivate Storage

        Controller-->>Client: 8. 200 OK<br/>æª”æ¡ˆä¸Šå‚³æˆåŠŸ
    end

    deactivate Controller

    Note over Client,FileSystem: æ•´å€‹æµç¨‹éœ€è¦è™•ç†ï¼šå®‰å…¨æ€§ã€æ•ˆèƒ½ã€éŒ¯èª¤è™•ç†
```

### HTML è¡¨å–®ç¯„ä¾‹

```html
<!-- æª”æ¡ˆä¸Šå‚³è¡¨å–® -->
<form method="post" action="/upload" enctype="multipart/form-data">
    <input type="file" name="file" />
    <input type="submit" value="ä¸Šå‚³" />
</form>
```

### MultipartFile æ ¸å¿ƒæ–¹æ³•

```java
public interface MultipartFile {
    String getOriginalFilename(); // å–å¾—åŸå§‹æª”æ¡ˆåç¨±
    String getContentType();      // å–å¾—æª”æ¡ˆé¡å‹
    long getSize();              // å–å¾—æª”æ¡ˆå¤§å°
    byte[] getBytes();           // å–å¾—æª”æ¡ˆå…§å®¹
    InputStream getInputStream(); // å–å¾—è¼¸å…¥ä¸²æµ
    void transferTo(File dest);  // å„²å­˜æª”æ¡ˆåˆ°æŒ‡å®šä½ç½®
}
```

> ğŸ’¡ **æµç¨‹é‡é»**ï¼šå¾æ¥æ”¶æª”æ¡ˆåˆ°å„²å­˜å®Œæˆï¼Œéœ€è¦ç¶“éé©—è­‰ã€ç”¢ç”Ÿå”¯ä¸€æª”åã€å¯«å…¥æª”æ¡ˆç³»çµ±ã€è¨˜éŒ„å…ƒè³‡æ–™ç­‰å¤šå€‹æ­¥é©Ÿï¼Œç¢ºä¿æª”æ¡ˆè™•ç†çš„å®Œæ•´æ€§å’Œå®‰å…¨æ€§ã€‚

---

## 3.2.3 æª”æ¡ˆä¸Šå‚³é…ç½®

### 1. application.yml é…ç½®

```yaml
spring:
  servlet:
    multipart:
      enabled: true                  # å•Ÿç”¨æª”æ¡ˆä¸Šå‚³
      max-file-size: 10MB           # å–®æª”æ¡ˆæœ€å¤§ 10MB
      max-request-size: 50MB        # è«‹æ±‚æœ€å¤§ 50MB
      file-size-threshold: 2KB      # è¨˜æ†¶é«”æš«å­˜é–¾å€¼

# è‡ªè¨‚é…ç½®
app:
  upload:
    path: ./uploads                 # æª”æ¡ˆå„²å­˜è·¯å¾‘
```

### 2. é…ç½®èªªæ˜

| é…ç½®é …ç›® | èªªæ˜ | é è¨­å€¼ | å»ºè­°å€¼ |
|---------|------|--------|--------|
| `max-file-size` | å–®æª”æ¡ˆæœ€å¤§å¤§å° | 1MB | 10MB |
| `max-request-size` | è«‹æ±‚æœ€å¤§å¤§å° | 10MB | 50MB |
| `file-size-threshold` | è¨˜æ†¶é«”æš«å­˜é–¾å€¼ | 0 | 2KB |

---

## ğŸ’» æª”æ¡ˆä¸Šå‚³å¯¦ä½œ

### æ§åˆ¶å™¨å±¤ï¼šæ¥æ”¶æª”æ¡ˆ

```java
// å°æ‡‰ç¯„ä¾‹: chapter3-enterprise-features/src/main/java/com/example/enterprise/controller/FileStorageController.java:41

/**
 * æª”æ¡ˆä¸Šå‚³ API
 */
@PostMapping("/upload")
@ResponseStatus(HttpStatus.CREATED)
@Operation(summary = "ä¸Šå‚³æª”æ¡ˆ", description = "ä¸Šå‚³å–®ä¸€æª”æ¡ˆï¼Œæ”¯æ´åœ–ç‰‡ã€æ–‡ä»¶ç­‰å¤šç¨®æ ¼å¼")
public ApiResponse<FileUploadResponse> uploadFile(
        @Parameter(description = "è¦ä¸Šå‚³çš„æª”æ¡ˆ", required = true)
        @RequestParam("file") MultipartFile file) {

    // å‘¼å«æœå‹™å±¤è™•ç†æª”æ¡ˆ
    FileUploadResponse response = fileStorageService.storeFile(file);
    return ApiResponse.success("æª”æ¡ˆä¸Šå‚³æˆåŠŸ", response);
}
```

**é—œéµé»**ï¼š
- ğŸ”‘ `@RequestParam("file")`: æ¥æ”¶è¡¨å–®ä¸­çš„æª”æ¡ˆ
- ğŸ”‘ `MultipartFile`: Spring æä¾›çš„æª”æ¡ˆè™•ç†ä»‹é¢
- ğŸ”‘ `@ResponseStatus(HttpStatus.CREATED)`: ä¸Šå‚³æˆåŠŸè¿”å› 201
- ğŸ”‘ æ§åˆ¶å™¨åªè² è²¬æ¥æ”¶ï¼Œå…·é«”è™•ç†é‚è¼¯åœ¨æœå‹™å±¤

---

### æœå‹™å±¤ï¼šæª”æ¡ˆå„²å­˜é‚è¼¯

```java
// å°æ‡‰ç¯„ä¾‹: chapter3-enterprise-features/src/main/java/com/example/enterprise/service/FileStorageService.java:51

/**
 * å„²å­˜æª”æ¡ˆåˆ°æª”æ¡ˆç³»çµ±ä¸¦è¨˜éŒ„å…ƒè³‡æ–™
 */
@Transactional
public FileUploadResponse storeFile(MultipartFile file) {
    // 1. é©—è­‰æª”æ¡ˆ
    validateFile(file);

    try {
        // 2. å»ºç«‹ä¸Šå‚³ç›®éŒ„
        Path uploadDir = Paths.get(uploadPath);
        if (!Files.exists(uploadDir)) {
            Files.createDirectories(uploadDir);
        }

        // 3. ç”¢ç”Ÿå”¯ä¸€æª”æ¡ˆåç¨±ï¼ˆUUID + åŸå§‹å‰¯æª”åï¼‰
        String originalFilename = StringUtils.cleanPath(file.getOriginalFilename());
        String fileExtension = getFileExtension(originalFilename);
        String storedFilename = UUID.randomUUID().toString() + fileExtension;

        // 4. å„²å­˜æª”æ¡ˆåˆ°æª”æ¡ˆç³»çµ±
        Path targetLocation = uploadDir.resolve(storedFilename);
        Files.copy(file.getInputStream(), targetLocation, StandardCopyOption.REPLACE_EXISTING);

        // 5. å„²å­˜æª”æ¡ˆå…ƒè³‡æ–™åˆ°è³‡æ–™åº«
        FileMetadata metadata = FileMetadata.builder()
                .originalFilename(originalFilename)
                .storedFilename(storedFilename)
                .contentType(file.getContentType())
                .fileSize(file.getSize())
                .filePath(targetLocation.toString())
                .build();

        FileMetadata savedMetadata = fileMetadataRepository.save(metadata);

        log.info("æª”æ¡ˆä¸Šå‚³æˆåŠŸï¼š{} -> {}", originalFilename, storedFilename);

        // 6. å»ºç«‹å›æ‡‰
        return buildFileUploadResponse(savedMetadata);

    } catch (IOException e) {
        throw new FileStorageException("æª”æ¡ˆå„²å­˜å¤±æ•—ï¼š" + file.getOriginalFilename(), e);
    }
}
```

**è™•ç†æµç¨‹**ï¼š
1. âœ… é©—è­‰æª”æ¡ˆï¼ˆæª”æ¡ˆé¡å‹ã€å¤§å°ï¼‰
2. âœ… å»ºç«‹ä¸Šå‚³ç›®éŒ„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
3. âœ… ç”¢ç”Ÿå”¯ä¸€æª”æ¡ˆåç¨±ï¼ˆé¿å…è¡çªï¼‰
4. âœ… å„²å­˜æª”æ¡ˆåˆ°æª”æ¡ˆç³»çµ±
5. âœ… è¨˜éŒ„æª”æ¡ˆå…ƒè³‡æ–™åˆ°è³‡æ–™åº«
6. âœ… è¿”å›ä¸‹è¼‰å’Œé è¦½ URL

**ç‚ºä»€éº¼ä½¿ç”¨ UUIDï¼Ÿ**
```
ä½¿ç”¨æ™‚é–“æˆ³:
  file1.jpg â†’ 1704067200000_file1.jpg  âœ… å”¯ä¸€
  file2.jpg â†’ 1704067200001_file2.jpg  âœ… å”¯ä¸€
  å•é¡Œ: å¯é æ¸¬ã€æª”æ¡ˆåç¨±éé•·

ä½¿ç”¨ UUID:
  file1.jpg â†’ a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg  âœ… å”¯ä¸€
  file2.jpg â†’ b2c3d4e5-f6g7-8901-bcde-fg2345678901.jpg  âœ… å”¯ä¸€
  å„ªé»: ä¸å¯é æ¸¬ã€æ›´å®‰å…¨ã€å›ºå®šé•·åº¦
```

---

### æª”æ¡ˆé©—è­‰

```java
// å°æ‡‰ç¯„ä¾‹: chapter3-enterprise-features/src/main/java/com/example/enterprise/service/FileStorageService.java:107

/**
 * é©—è­‰æª”æ¡ˆåˆæ³•æ€§
 */
private void validateFile(MultipartFile file) {
    // æª¢æŸ¥æª”æ¡ˆæ˜¯å¦ç‚ºç©º
    if (file.isEmpty()) {
        throw new FileStorageException("è«‹é¸æ“‡è¦ä¸Šå‚³çš„æª”æ¡ˆ");
    }

    // æª¢æŸ¥æª”æ¡ˆé¡å‹
    String contentType = file.getContentType();
    if (contentType == null || !allowedTypes.contains(contentType)) {
        throw new FileStorageException("ä¸æ”¯æ´çš„æª”æ¡ˆé¡å‹ï¼š" + contentType);
    }
}
```

**é…ç½®å…è¨±çš„æª”æ¡ˆé¡å‹**ï¼š

```yaml
# application.yml
app:
  upload:
    path: ./uploads
    allowed-types: image/jpeg,image/png,image/gif,application/pdf,text/plain
```

**é©—è­‰é …ç›®**ï¼š
- âœ… æª”æ¡ˆä¸èƒ½ç‚ºç©º
- âœ… æª”æ¡ˆé¡å‹å¿…é ˆåœ¨å…è¨±æ¸…å–®ä¸­
- âœ… æª”æ¡ˆå¤§å°ï¼ˆSpring é…ç½®æ§åˆ¶ï¼‰

---

### å¤šæª”æ¡ˆä¸Šå‚³

```java
/**
 * å¤šæª”æ¡ˆä¸Šå‚³
 */
@PostMapping("/upload-multiple")
public ResponseEntity<ApiResponse<List<String>>> uploadMultipleFiles(
        @RequestParam("files") MultipartFile[] files) {

    List<String> uploadedFiles = new ArrayList<>();

    for (MultipartFile file : files) {
        if (!file.isEmpty()) {
            try {
                String fileName = System.currentTimeMillis() + "_" + file.getOriginalFilename();
                Path filePath = Paths.get(uploadPath).resolve(fileName);
                file.transferTo(filePath.toFile());
                uploadedFiles.add(fileName);
            } catch (IOException e) {
                log.error("æª”æ¡ˆä¸Šå‚³å¤±æ•—: {}", file.getOriginalFilename(), e);
            }
        }
    }

    return ResponseEntity.ok(ApiResponse.success("ä¸Šå‚³å®Œæˆ", uploadedFiles));
}
```

---

## ğŸ“¥ æª”æ¡ˆä¸‹è¼‰å¯¦ä½œ

### ä¸‹è¼‰ vs é è¦½çš„å·®ç•°

| åŠŸèƒ½ | HTTP Header | ç€è¦½å™¨è¡Œç‚º | é©ç”¨å ´æ™¯ |
|------|------------|-----------|---------|
| **ä¸‹è¼‰** | `attachment; filename="..."` | ç›´æ¥ä¸‹è¼‰åˆ°æœ¬æ©Ÿ | æ–‡ä»¶ã€å£“ç¸®æª” |
| **é è¦½** | `inline; filename="..."` | åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿ | åœ–ç‰‡ã€PDF |

### æª”æ¡ˆä¸‹è¼‰å¯¦ä½œ

```java
// å°æ‡‰ç¯„ä¾‹: chapter3-enterprise-features/src/main/java/com/example/enterprise/controller/FileStorageController.java:78

/**
 * æª”æ¡ˆä¸‹è¼‰
 */
@GetMapping("/download/{filename:.+}")
@Operation(summary = "ä¸‹è¼‰æª”æ¡ˆ", description = "æ ¹æ“šæª”æ¡ˆåç¨±ä¸‹è¼‰æª”æ¡ˆ")
public ResponseEntity<Resource> downloadFile(
        @PathVariable String filename,
        HttpServletRequest request) {

    // 1. è¼‰å…¥æª”æ¡ˆè³‡æº
    Resource resource = fileStorageService.loadFileAsResource(filename);

    // 2. åµæ¸¬æª”æ¡ˆçš„ MIME é¡å‹
    String contentType = null;
    try {
        contentType = request.getServletContext().getMimeType(resource.getFile().getAbsolutePath());
    } catch (IOException ex) {
        log.info("ç„¡æ³•åµæ¸¬æª”æ¡ˆé¡å‹");
    }

    // 3. é è¨­é¡å‹
    if (contentType == null) {
        contentType = "application/octet-stream";
    }

    // 4. è¿”å›æª”æ¡ˆï¼ˆä¸‹è¼‰æ¨¡å¼ï¼‰
    return ResponseEntity.ok()
            .contentType(MediaType.parseMediaType(contentType))
            .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=\"" + resource.getFilename() + "\"")
            .body(resource);
}
```

**é—œéµé»**ï¼š
- ğŸ”‘ `attachment`: å‘Šè¨´ç€è¦½å™¨ä¸‹è¼‰æª”æ¡ˆ
- ğŸ”‘ `Resource`: Spring çš„è³‡æºæŠ½è±¡ï¼Œæ”¯æ´å¤šç¨®ä¾†æº
- ğŸ”‘ Content-Type: æ­£ç¢ºè¨­å®š MIME é¡å‹

---

### æª”æ¡ˆé è¦½å¯¦ä½œ

```java
// å°æ‡‰ç¯„ä¾‹: chapter3-enterprise-features/src/main/java/com/example/enterprise/controller/FileStorageController.java:116

/**
 * æª”æ¡ˆé è¦½ï¼ˆåœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿï¼‰
 */
@GetMapping("/preview/{filename:.+}")
@Operation(summary = "é è¦½æª”æ¡ˆ", description = "åœ¨ç€è¦½å™¨ä¸­é è¦½æª”æ¡ˆï¼ˆé©ç”¨æ–¼åœ–ç‰‡ã€PDF ç­‰ï¼‰")
public ResponseEntity<Resource> previewFile(
        @PathVariable String filename,
        HttpServletRequest request) {

    Resource resource = fileStorageService.loadFileAsResource(filename);

    String contentType = null;
    try {
        contentType = request.getServletContext().getMimeType(resource.getFile().getAbsolutePath());
    } catch (IOException ex) {
        log.info("ç„¡æ³•åµæ¸¬æª”æ¡ˆé¡å‹");
    }

    if (contentType == null) {
        contentType = "application/octet-stream";
    }

    // ä½¿ç”¨ inline è®“ç€è¦½å™¨é è¦½
    return ResponseEntity.ok()
            .contentType(MediaType.parseMediaType(contentType))
            .header(HttpHeaders.CONTENT_DISPOSITION, "inline; filename=\"" + resource.getFilename() + "\"")
            .body(resource);
}
```

**ä¸‹è¼‰ vs é è¦½**ï¼š
```
ä¸‹è¼‰æª”æ¡ˆï¼š
  Content-Disposition: attachment; filename="report.pdf"
  â†’ ç€è¦½å™¨ï¼šå„²å­˜åˆ°ä¸‹è¼‰è³‡æ–™å¤¾

é è¦½æª”æ¡ˆï¼š
  Content-Disposition: inline; filename="report.pdf"
  â†’ ç€è¦½å™¨ï¼šç›´æ¥åœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿ PDF
```

---

### è¼‰å…¥æª”æ¡ˆè³‡æº

```java
// å°æ‡‰ç¯„ä¾‹: chapter3-enterprise-features/src/main/java/com/example/enterprise/service/FileStorageService.java:92

/**
 * è¼‰å…¥æª”æ¡ˆç‚º Resource
 */
public Resource loadFileAsResource(String filename) {
    try {
        // 1. è§£ææª”æ¡ˆè·¯å¾‘ä¸¦æ­£è¦åŒ–ï¼ˆé˜²æ­¢è·¯å¾‘éæ­·æ”»æ“Šï¼‰
        Path filePath = Paths.get(uploadPath).resolve(filename).normalize();

        // 2. å»ºç«‹ Resource
        Resource resource = new UrlResource(filePath.toUri());

        // 3. æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨ä¸”å¯è®€å–
        if (resource.exists() && resource.isReadable()) {
            return resource;
        } else {
            throw new ResourceNotFoundException("æª”æ¡ˆä¸å­˜åœ¨æˆ–ç„¡æ³•è®€å–ï¼š" + filename);
        }
    } catch (MalformedURLException e) {
        throw new FileStorageException("æª”æ¡ˆè¼‰å…¥å¤±æ•—ï¼š" + filename, e);
    }
}
```

**å®‰å…¨æ€§è€ƒé‡**ï¼š
- âœ… `normalize()`: é˜²æ­¢è·¯å¾‘éæ­·æ”»æ“Šï¼ˆå¦‚ `../../etc/passwd`ï¼‰
- âœ… `isReadable()`: æª¢æŸ¥æª”æ¡ˆæ¬Šé™
- âœ… ç•°å¸¸è™•ç†ï¼šæª”æ¡ˆä¸å­˜åœ¨æˆ–ç„¡æ³•è®€å–æ™‚æ‹‹å‡ºç•°å¸¸

---

## ğŸ”’ å®‰å…¨æ€§è€ƒé‡

### å¸¸è¦‹å®‰å…¨é¢¨éšª

| é¢¨éšªé¡å‹ | å…·é«”å¨è„… | é˜²è­·æªæ–½ |
|---------|---------|---------|
| **è·¯å¾‘éæ­·** | `../../etc/passwd` | ä½¿ç”¨ `normalize()` æ¸…ç†è·¯å¾‘ |
| **æª”æ¡ˆé¡å‹å½é€ ** | ä¸Šå‚³ `.exe` å½è£æˆ `.jpg` | æª¢æŸ¥ Content-Type å’Œæª”æ¡ˆå…§å®¹ |
| **æª”æ¡ˆå¤§å°æ”»æ“Š** | ä¸Šå‚³ GB ç´šæª”æ¡ˆè€—ç›¡ç£ç¢Ÿ | è¨­å®š `max-file-size` é™åˆ¶ |
| **æª”æ¡ˆåæ³¨å…¥** | `test;rm -rf /.jpg` | ä½¿ç”¨ UUID é‡æ–°å‘½å |
| **æƒ¡æ„æª”æ¡ˆ** | ä¸Šå‚³ç—…æ¯’æˆ–æƒ¡æ„è…³æœ¬ | æ•´åˆç—…æ¯’æƒææœå‹™ |

### å®‰å…¨æª¢æŸ¥æ¸…å–®

```java
/**
 * å®Œæ•´çš„å®‰å…¨æª”æ¡ˆé©—è­‰
 */
private void secureValidateFile(MultipartFile file) {
    // 1. æª¢æŸ¥æª”æ¡ˆæ˜¯å¦ç‚ºç©º
    if (file.isEmpty()) {
        throw new FileStorageException("è«‹é¸æ“‡è¦ä¸Šå‚³çš„æª”æ¡ˆ");
    }

    // 2. æª¢æŸ¥æª”æ¡ˆå¤§å°ï¼ˆSpring é…ç½®æœƒå…ˆæª¢æŸ¥ï¼Œé€™æ˜¯é›™é‡ä¿éšªï¼‰
    long maxSize = 10 * 1024 * 1024; // 10MB
    if (file.getSize() > maxSize) {
        throw new FileStorageException("æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 10MB");
    }

    // 3. æª¢æŸ¥æª”æ¡ˆé¡å‹ï¼ˆContent-Typeï¼‰
    String contentType = file.getContentType();
    if (contentType == null || !allowedTypes.contains(contentType)) {
        throw new FileStorageException("ä¸æ”¯æ´çš„æª”æ¡ˆé¡å‹ï¼š" + contentType);
    }

    // 4. æ¸…ç†æª”æ¡ˆåç¨±ï¼ˆé˜²æ­¢è·¯å¾‘æ³¨å…¥ï¼‰
    String filename = StringUtils.cleanPath(file.getOriginalFilename());
    if (filename.contains("..")) {
        throw new FileStorageException("æª”æ¡ˆåç¨±åŒ…å«éæ³•å­—å…ƒ");
    }

    // 5. æª¢æŸ¥æª”æ¡ˆå‰¯æª”å
    String extension = getFileExtension(filename);
    List<String> allowedExtensions = Arrays.asList(".jpg", ".jpeg", ".png", ".pdf");
    if (!allowedExtensions.contains(extension.toLowerCase())) {
        throw new FileStorageException("ä¸æ”¯æ´çš„æª”æ¡ˆå‰¯æª”åï¼š" + extension);
    }
}
```

**å®‰å…¨æœ€ä½³å¯¦è¸**ï¼š
- âœ… æ°¸é é‡æ–°å‘½åä¸Šå‚³çš„æª”æ¡ˆï¼ˆä½¿ç”¨ UUIDï¼‰
- âœ… å°‡ä¸Šå‚³ç›®éŒ„è¨­å®šåœ¨ Web æ ¹ç›®éŒ„ä¹‹å¤–
- âœ… ä¸è¦ç›´æ¥ä½¿ç”¨ä½¿ç”¨è€…æä¾›çš„æª”æ¡ˆå
- âœ… å¯¦ä½œå¤šå±¤é©—è­‰ï¼ˆContent-Type + å‰¯æª”å + æª”æ¡ˆå…§å®¹ï¼‰
- âœ… å®šæœŸæƒæä¸Šå‚³çš„æª”æ¡ˆ

---

## ğŸ¬ å¯¦éš›æ‡‰ç”¨å ´æ™¯

### å ´æ™¯ 1: ä½¿ç”¨è€…é ­åƒä¸Šå‚³

```bash
# ä¸Šå‚³é ­åƒ
curl -X POST http://localhost:8080/api/files/upload \
  -F "file=@avatar.jpg"

# å›æ‡‰ï¼š
# {
#   "code": 201,
#   "message": "æª”æ¡ˆä¸Šå‚³æˆåŠŸ",
#   "data": {
#     "id": 1,
#     "originalFilename": "avatar.jpg",
#     "storedFilename": "a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg",
#     "contentType": "image/jpeg",
#     "fileSize": 102400,
#     "downloadUrl": "http://localhost:8080/api/files/download/a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg",
#     "previewUrl": "http://localhost:8080/api/files/preview/a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg"
#   }
# }

# é è¦½é ­åƒï¼ˆåœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿï¼‰
http://localhost:8080/api/files/preview/a1b2c3d4-e5f6-7890-abcd-ef1234567890.jpg
```

---

### å ´æ™¯ 2: AI åœ–ç‰‡åˆ†æ

```java
/**
 * AI åœ–ç‰‡åˆ†æç«¯é»
 * çµåˆæª”æ¡ˆä¸Šå‚³å’Œ AI è™•ç†
 */
@PostMapping("/ai/analyze-image")
public ApiResponse<ImageAnalysisResult> analyzeImage(
        @RequestParam("file") MultipartFile file,
        @RequestParam("prompt") String prompt) {

    // 1. å„²å­˜æª”æ¡ˆ
    FileUploadResponse uploadResponse = fileStorageService.storeFile(file);

    // 2. ä½¿ç”¨ Spring AI åˆ†æåœ–ç‰‡
    // ImageAnalysisResult result = aiService.analyzeImage(
    //     uploadResponse.getFilePath(),
    //     prompt
    // );

    // 3. è¿”å›åˆ†æçµæœ
    return ApiResponse.success("åˆ†æå®Œæˆ", result);
}
```

**æ¸¬è©¦ç¯„ä¾‹**ï¼š
```bash
curl -X POST http://localhost:8080/api/ai/analyze-image \
  -F "file=@product.jpg" \
  -F "prompt=æè¿°é€™å€‹ç”¢å“çš„ç‰¹å¾µå’Œç”¨é€”"
```

---

## ğŸ“ é‡é»å›é¡§

### æ ¸å¿ƒæ¦‚å¿µ

âœ… **HTTP æª”æ¡ˆä¸Šå‚³**ï¼šä½¿ç”¨ `multipart/form-data` ç·¨ç¢¼å‚³è¼¸æª”æ¡ˆ
âœ… **MultipartFile**ï¼šSpring æä¾›çš„æª”æ¡ˆè™•ç†ä»‹é¢ï¼Œç°¡åŒ–æª”æ¡ˆæ“ä½œ
âœ… **æª”æ¡ˆå…ƒè³‡æ–™**ï¼šè¨˜éŒ„æª”æ¡ˆè³‡è¨Šåˆ°è³‡æ–™åº«ï¼Œä¾¿æ–¼ç®¡ç†å’Œè¿½è¹¤
âœ… **å®‰å…¨æ€§å„ªå…ˆ**ï¼šå¤šå±¤é©—è­‰ç¢ºä¿ç³»çµ±å®‰å…¨
âœ… **AI æ‡‰ç”¨åŸºç¤**ï¼šç‚ºå¤šæ¨¡æ…‹ AI è¼¸å…¥åšæº–å‚™

### å®Œæ•´æµç¨‹å›é¡§

```mermaid
graph LR
    A[ä¸Šå‚³æª”æ¡ˆ] --> B[é©—è­‰æª”æ¡ˆ]
    B --> C[ç”¢ç”Ÿ UUID]
    C --> D[å„²å­˜æª”æ¡ˆç³»çµ±]
    D --> E[è¨˜éŒ„å…ƒè³‡æ–™]
    E --> F[è¿”å› URL]

    F --> G[ä¸‹è¼‰/é è¦½]
    G --> H[è¼‰å…¥ Resource]
    H --> I[è¨­å®š Header]
    I --> J[è¿”å›æª”æ¡ˆ]

    style A fill:#E3F2FD
    style B fill:#FFF3E0
    style C fill:#FFF3E0
    style D fill:#E8F5E9
    style E fill:#E8F5E9
    style F fill:#C8E6C9

    style G fill:#E3F2FD
    style H fill:#FFF3E0
    style I fill:#FFF3E0
    style J fill:#C8E6C9
```

### æœ€ä½³å¯¦è¸

| å¯¦è¸é …ç›® | èªªæ˜ | ç¯„ä¾‹ |
|---------|------|------|
| **æª”æ¡ˆå‘½å** | ä½¿ç”¨ UUID é¿å…è¡çªå’Œå®‰å…¨é¢¨éšª | `UUID.randomUUID() + extension` |
| **è·¯å¾‘æ¸…ç†** | é˜²æ­¢è·¯å¾‘éæ­·æ”»æ“Š | `StringUtils.cleanPath()` + `normalize()` |
| **é¡å‹é©—è­‰** | æª¢æŸ¥ Content-Type å’Œå‰¯æª”å | ç™½åå–®æ©Ÿåˆ¶ |
| **å¤§å°é™åˆ¶** | Spring é…ç½® + ç¨‹å¼ç¢¼é›™é‡æª¢æŸ¥ | `max-file-size: 10MB` |
| **å…ƒè³‡æ–™è¨˜éŒ„** | è¨˜éŒ„åˆ°è³‡æ–™åº«ä¾¿æ–¼ç®¡ç† | `FileMetadata` å¯¦é«” |
| **ä¸‹è¼‰å®‰å…¨** | ä½¿ç”¨ `Resource` è€Œéç›´æ¥è®€å– | `UrlResource` |

### MultipartFile æ ¸å¿ƒæ–¹æ³•é€ŸæŸ¥

```java
MultipartFile file;

file.getOriginalFilename()  // å–å¾—åŸå§‹æª”æ¡ˆåç¨±
file.getContentType()        // å–å¾—æª”æ¡ˆ MIME é¡å‹
file.getSize()              // å–å¾—æª”æ¡ˆå¤§å°ï¼ˆbytesï¼‰
file.isEmpty()              // æª¢æŸ¥æª”æ¡ˆæ˜¯å¦ç‚ºç©º
file.getInputStream()        // å–å¾—æª”æ¡ˆè¼¸å…¥ä¸²æµ
file.transferTo(dest)        // å„²å­˜åˆ°æŒ‡å®šä½ç½®
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

ç¾åœ¨ä½ å·²ç¶“æŒæ¡äº†æª”æ¡ˆä¸Šå‚³èˆ‡ä¸‹è¼‰ï¼Œæ¥ä¸‹ä¾†æˆ‘å€‘å°‡å­¸ç¿’ï¼š

ğŸ‘‰ [3.3 API æ–‡ä»¶åŒ–èˆ‡æ¸¬è©¦](./3.3-api-documentation.md) - ä½¿ç”¨ Swagger è‡ªå‹•ç”Ÿæˆ API æ–‡ä»¶

---

## ğŸ“š å®Œæ•´ç¯„ä¾‹

æœ¬ç« æ¦‚å¿µçš„å®Œæ•´å¯¦ç¾è«‹åƒè€ƒï¼š

ğŸ“ **chapter3-enterprise-features**
- `src/main/java/com/example/enterprise/controller/FileStorageController.java` - æª”æ¡ˆä¸Šå‚³ä¸‹è¼‰ API
- `src/main/java/com/example/enterprise/service/FileStorageService.java` - æª”æ¡ˆè™•ç†æœå‹™
- `src/main/java/com/example/enterprise/entity/FileMetadata.java` - æª”æ¡ˆå…ƒè³‡æ–™å¯¦é«”
- `src/main/resources/application.yml` - æª”æ¡ˆä¸Šå‚³é…ç½®

ğŸ”— **å•Ÿå‹•ç¯„ä¾‹**:
```bash
cd code-examples/chapter3-enterprise-features
mvn spring-boot:run
```

ğŸ§ª **æ¸¬è©¦ API**:
```bash
# Swagger UI
http://localhost:8080/swagger-ui.html

# ä¸Šå‚³æª”æ¡ˆ
curl -X POST http://localhost:8080/api/files/upload \
  -F "file=@test-image.jpg"

# ä¸‹è¼‰æª”æ¡ˆ
curl -O http://localhost:8080/api/files/download/æª”æ¡ˆåç¨±.jpg

# é è¦½æª”æ¡ˆï¼ˆåœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿï¼‰
http://localhost:8080/api/files/preview/æª”æ¡ˆåç¨±.jpg
```

---

## ğŸ”— åƒè€ƒè³‡æº

- **Spring Boot å®˜æ–¹æŒ‡å—**: [Uploading Files](https://spring.io/guides/gs/uploading-files/)
- **Servlet 3.1 è¦ç¯„**: [Multipart Support](https://javaee.github.io/servlet-spec/downloads/servlet-3.1/Final/servlet-3_1-final.pdf)
- **OWASP æª”æ¡ˆä¸Šå‚³å®‰å…¨**: [File Upload Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/File_Upload_Cheat_Sheet.html)

---

**ç›¸é—œç« ç¯€**:
- â† ä¸Šä¸€ç¯€: [3.1 è³‡æ–™é©—è­‰èˆ‡éŒ¯èª¤è™•ç†](./3.1-validation-error-handling.md)
- â†’ ä¸‹ä¸€ç¯€: [3.3 API æ–‡ä»¶åŒ–èˆ‡æ¸¬è©¦](./3.3-api-documentation.md)
- ğŸ“– å›åˆ°ç›®éŒ„: [ç¬¬3ç«  README](./README.md)
