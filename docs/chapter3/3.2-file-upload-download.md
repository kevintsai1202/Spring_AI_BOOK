# 3.2 æª”æ¡ˆä¸Šå‚³èˆ‡ä¸‹è¼‰

> **å­¸ç¿’é‡é»**ï¼šæŒæ¡ Spring Boot æª”æ¡ˆè™•ç†æ©Ÿåˆ¶ã€MultipartFile ä½¿ç”¨å’Œå®‰å…¨æ€§è€ƒé‡

---

## 3.2.1 æª”æ¡ˆè™•ç†çš„é‡è¦æ€§

åœ¨ç¾ä»£ Web æ‡‰ç”¨ä¸­ï¼Œæª”æ¡ˆè™•ç†æ˜¯ä¸€é …åŸºç¤ä¸”é‡è¦çš„åŠŸèƒ½ï¼š

### å¸¸è¦‹æ‡‰ç”¨å ´æ™¯

```mermaid
graph TB
    FileAPI[Spring Boot æª”æ¡ˆ API<br/>æ ¸å¿ƒè™•ç†æ¨¡çµ„]

    subgraph Scene1["ğŸ“± ä½¿ç”¨è€…å…§å®¹ç®¡ç†"]
        direction TB
        UC1[å€‹äººé ­åƒä¸Šå‚³]
        UC2[æ–‡ä»¶é™„ä»¶è™•ç†]
        UC3[å¤šåª’é«”åˆ†äº«]
    end

    subgraph Scene2["ğŸ¢ ä¼æ¥­æ–‡ä»¶ç³»çµ±"]
        direction TB
        ED1[åˆç´„æ–‡ä»¶ä¸Šå‚³]
        ED2[å ±è¡¨æª”æ¡ˆä¸‹è¼‰]
        ED3[å‚™ä»½æª”æ¡ˆç®¡ç†]
    end

    subgraph Scene3["ğŸ›’ é›»å•†æ‡‰ç”¨"]
        direction TB
        EC1[å•†å“åœ–ç‰‡ä¸Šå‚³]
        EC2[ç”¢å“ç›®éŒ„åŒ¯å…¥]
        EC3[è¨‚å–®é™„ä»¶è™•ç†]
    end

    subgraph Scene4["ğŸ¤– AI æ‡‰ç”¨å ´æ™¯ â­"]
        direction TB
        AI1[åœ–ç‰‡åˆ†æè™•ç†]
        AI2[éŸ³è¨Šè½‰æ–‡å­—]
        AI3[PDF æ–‡ä»¶è§£æ]
        AI4[è¨“ç·´è³‡æ–™ä¸Šå‚³]
    end

    FileAPI --> Scene1
    FileAPI --> Scene2
    FileAPI --> Scene3
    FileAPI --> Scene4

    Scene1 --> UC1
    Scene1 --> UC2
    Scene1 --> UC3

    Scene2 --> ED1
    Scene2 --> ED2
    Scene2 --> ED3

    Scene3 --> EC1
    Scene3 --> EC2
    Scene3 --> EC3

    Scene4 --> AI1
    Scene4 --> AI2
    Scene4 --> AI3
    Scene4 --> AI4

    style FileAPI fill:#4CAF50,color:#fff,stroke:#2E7D32,stroke-width:3px
    style Scene1 fill:#E3F2FD,stroke:#1976D2,stroke-width:2px
    style Scene2 fill:#FFF3E0,stroke:#F57C00,stroke-width:2px
    style Scene3 fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px
    style Scene4 fill:#FFEBEE,stroke:#C62828,stroke-width:3px
    style AI1 fill:#FF9800,color:#fff
    style AI2 fill:#FF9800,color:#fff
    style AI3 fill:#FF9800,color:#fff
    style AI4 fill:#FF9800,color:#fff
```

### å ´æ™¯è©³ç´°èªªæ˜

| å ´æ™¯é¡å‹ | å…·é«”æ‡‰ç”¨ | æŠ€è¡“è¦æ±‚ | Spring AI æ•´åˆ |
|---------|---------|---------|---------------|
| **ä½¿ç”¨è€…å…§å®¹** | å€‹äººé ­åƒã€ç°¡æ­·é™„ä»¶ | æª”æ¡ˆå¤§å°é™åˆ¶ã€æ ¼å¼é©—è­‰ | åœ–ç‰‡å£“ç¸®ã€å…§å®¹å¯©æ ¸ |
| **ä¼æ¥­æ–‡ä»¶** | åˆç´„ã€å ±è¡¨ã€å‚™ä»½ | å®‰å…¨æ€§ã€æ¬Šé™æ§åˆ¶ | æ–‡ä»¶æ‘˜è¦ã€æ™ºèƒ½åˆ†é¡ |
| **é›»å•†æ‡‰ç”¨** | å•†å“åœ–ç‰‡ã€æ‰¹æ¬¡åŒ¯å…¥ | æ•ˆèƒ½å„ªåŒ–ã€æ‰¹æ¬¡è™•ç† | åœ–ç‰‡æ¨™ç±¤ã€å•†å“æè¿°ç”Ÿæˆ |
| **AI æ‡‰ç”¨** | è¨“ç·´è³‡æ–™ã€å¤šæ¨¡æ…‹è¼¸å…¥ | å¤§æª”æ¡ˆè™•ç†ã€æ ¼å¼è½‰æ› | å‘é‡åŒ–ã€RAG çŸ¥è­˜åº« â­ |

> ğŸ’¡ **é‡é»**ï¼šè‰¯å¥½çš„æª”æ¡ˆè™•ç†æ©Ÿåˆ¶ä¸åƒ…è¦è€ƒæ…®åŠŸèƒ½å¯¦ç¾ï¼Œé‚„è¦é‡è¦–å®‰å…¨æ€§ã€æ•ˆèƒ½å’Œä½¿ç”¨è€…é«”é©—ã€‚ç‰¹åˆ¥æ˜¯åœ¨ AI æ‡‰ç”¨ä¸­ï¼Œæª”æ¡ˆè™•ç†æ˜¯å¯¦ç¾å¤šæ¨¡æ…‹ AI åŠŸèƒ½çš„åŸºç¤ã€‚

---

## 3.2.2 HTTP æª”æ¡ˆä¸Šå‚³åŸç†

æª”æ¡ˆä¸Šå‚³é€é HTTP çš„ `multipart/form-data` ç·¨ç¢¼æ–¹å¼å¯¦ç¾ã€‚

### æª”æ¡ˆä¸Šå‚³å®Œæ•´æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ¶ç«¯<br/>(ç€è¦½å™¨/å‰ç«¯)
    participant Controller as Spring Controller
    participant Validator as æª”æ¡ˆé©—è­‰å™¨
    participant Storage as æª”æ¡ˆå„²å­˜æœå‹™
    participant DB as è³‡æ–™åº«
    participant FileSystem as æª”æ¡ˆç³»çµ±

    Client->>Controller: 1. POST /api/files/upload<br/>multipart/form-data
    activate Controller

    Controller->>Controller: 2. æ¥æ”¶ MultipartFile

    Controller->>Validator: 3. é©—è­‰æª”æ¡ˆ
    activate Validator
    Validator->>Validator: æª¢æŸ¥æª”æ¡ˆé¡å‹
    Validator->>Validator: æª¢æŸ¥æª”æ¡ˆå¤§å°
    Validator->>Validator: æª¢æŸ¥æª”æ¡ˆå…§å®¹
    Validator-->>Controller: é©—è­‰çµæœ
    deactivate Validator

    alt é©—è­‰å¤±æ•—
        Controller-->>Client: 400 Bad Request<br/>éŒ¯èª¤è¨Šæ¯
    else é©—è­‰æˆåŠŸ
        Controller->>Storage: 4. å„²å­˜æª”æ¡ˆ
        activate Storage

        Storage->>Storage: 5. ç”¢ç”Ÿå”¯ä¸€æª”å
        Storage->>FileSystem: 6. å¯«å…¥æª”æ¡ˆç³»çµ±
        activate FileSystem
        FileSystem-->>Storage: æª”æ¡ˆè·¯å¾‘
        deactivate FileSystem

        Storage->>DB: 7. å„²å­˜æª”æ¡ˆå…ƒè³‡æ–™
        activate DB
        DB-->>Storage: å…ƒè³‡æ–™ ID
        deactivate DB

        Storage-->>Controller: æª”æ¡ˆè³‡è¨Š
        deactivate Storage

        Controller-->>Client: 8. 200 OK<br/>æª”æ¡ˆä¸Šå‚³æˆåŠŸ
    end

    deactivate Controller

    Note over Client,FileSystem: æ•´å€‹æµç¨‹éœ€è¦è™•ç†ï¼šå®‰å…¨æ€§ã€æ•ˆèƒ½ã€éŒ¯èª¤è™•ç†
```

### HTML è¡¨å–®ç¯„ä¾‹

```html
<!-- æª”æ¡ˆä¸Šå‚³è¡¨å–® -->
<form method="post" action="/upload" enctype="multipart/form-data">
    <input type="file" name="file" />
    <input type="submit" value="ä¸Šå‚³" />
</form>
```

### MultipartFile æ ¸å¿ƒæ–¹æ³•

```java
public interface MultipartFile {
    String getOriginalFilename(); // å–å¾—åŸå§‹æª”æ¡ˆåç¨±
    String getContentType();      // å–å¾—æª”æ¡ˆé¡å‹
    long getSize();              // å–å¾—æª”æ¡ˆå¤§å°
    byte[] getBytes();           // å–å¾—æª”æ¡ˆå…§å®¹
    InputStream getInputStream(); // å–å¾—è¼¸å…¥ä¸²æµ
    void transferTo(File dest);  // å„²å­˜æª”æ¡ˆåˆ°æŒ‡å®šä½ç½®
}
```

> ğŸ’¡ **æµç¨‹é‡é»**ï¼šå¾æ¥æ”¶æª”æ¡ˆåˆ°å„²å­˜å®Œæˆï¼Œéœ€è¦ç¶“éé©—è­‰ã€ç”¢ç”Ÿå”¯ä¸€æª”åã€å¯«å…¥æª”æ¡ˆç³»çµ±ã€è¨˜éŒ„å…ƒè³‡æ–™ç­‰å¤šå€‹æ­¥é©Ÿï¼Œç¢ºä¿æª”æ¡ˆè™•ç†çš„å®Œæ•´æ€§å’Œå®‰å…¨æ€§ã€‚

---

## 3.2.3 æª”æ¡ˆä¸Šå‚³é…ç½®

### 1. application.yml é…ç½®

```yaml
spring:
  servlet:
    multipart:
      enabled: true                  # å•Ÿç”¨æª”æ¡ˆä¸Šå‚³
      max-file-size: 10MB           # å–®æª”æ¡ˆæœ€å¤§ 10MB
      max-request-size: 50MB        # è«‹æ±‚æœ€å¤§ 50MB
      file-size-threshold: 2KB      # è¨˜æ†¶é«”æš«å­˜é–¾å€¼

# è‡ªè¨‚é…ç½®
app:
  upload:
    path: ./uploads                 # æª”æ¡ˆå„²å­˜è·¯å¾‘
```

### 2. é…ç½®èªªæ˜

| é…ç½®é …ç›® | èªªæ˜ | é è¨­å€¼ | å»ºè­°å€¼ |
|---------|------|--------|--------|
| `max-file-size` | å–®æª”æ¡ˆæœ€å¤§å¤§å° | 1MB | 10MB |
| `max-request-size` | è«‹æ±‚æœ€å¤§å¤§å° | 10MB | 50MB |
| `file-size-threshold` | è¨˜æ†¶é«”æš«å­˜é–¾å€¼ | 0 | 2KB |

---

## 3.2.4 æª”æ¡ˆä¸Šå‚³å¯¦ä½œ

### å–®æª”æ¡ˆä¸Šå‚³

```java
/**
 * æª”æ¡ˆä¸Šå‚³æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api/files")
@Slf4j
public class FileUploadController {

    @Value("${app.upload.path:./uploads}")
    private String uploadPath;

    /**
     * å–®æª”æ¡ˆä¸Šå‚³
     */
    @PostMapping("/upload")
    public ResponseEntity<ApiResponse<FileUploadResponse>> uploadFile(
            @RequestParam("file") MultipartFile file) {

        if (file.isEmpty()) {
            return ResponseEntity.badRequest()
                    .body(ApiResponse.error(400, "è«‹é¸æ“‡è¦ä¸Šå‚³çš„æª”æ¡ˆ"));
        }

        try {
            // å»ºç«‹ä¸Šå‚³ç›®éŒ„
            Path uploadDir = Paths.get(uploadPath);
            if (!Files.exists(uploadDir)) {
                Files.createDirectories(uploadDir);
            }

            // ç”¢ç”Ÿå”¯ä¸€æª”æ¡ˆåç¨±
            String fileName = System.currentTimeMillis() + "_" + file.getOriginalFilename();
            Path filePath = uploadDir.resolve(fileName);

            // å„²å­˜æª”æ¡ˆ
            file.transferTo(filePath.toFile());

            log.info("æª”æ¡ˆä¸Šå‚³æˆåŠŸ: {}", fileName);

            FileUploadResponse response = new FileUploadResponse(
                fileName,
                file.getOriginalFilename(),
                file.getSize()
            );

            return ResponseEntity.ok(ApiResponse.success("ä¸Šå‚³æˆåŠŸ", response));

        } catch (IOException e) {
            log.error("æª”æ¡ˆä¸Šå‚³å¤±æ•—", e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body(ApiResponse.error(500, "æª”æ¡ˆä¸Šå‚³å¤±æ•—"));
        }
    }
}
```

### å¤šæª”æ¡ˆä¸Šå‚³

```java
/**
 * å¤šæª”æ¡ˆä¸Šå‚³
 */
@PostMapping("/upload-multiple")
public ResponseEntity<ApiResponse<List<String>>> uploadMultipleFiles(
        @RequestParam("files") MultipartFile[] files) {

    List<String> uploadedFiles = new ArrayList<>();

    for (MultipartFile file : files) {
        if (!file.isEmpty()) {
            try {
                String fileName = System.currentTimeMillis() + "_" + file.getOriginalFilename();
                Path filePath = Paths.get(uploadPath).resolve(fileName);
                file.transferTo(filePath.toFile());
                uploadedFiles.add(fileName);
            } catch (IOException e) {
                log.error("æª”æ¡ˆä¸Šå‚³å¤±æ•—: {}", file.getOriginalFilename(), e);
            }
        }
    }

    return ResponseEntity.ok(ApiResponse.success("ä¸Šå‚³å®Œæˆ", uploadedFiles));
}
```

---

## 3.2.5 æª”æ¡ˆä¸‹è¼‰å¯¦ä½œ

### æª”æ¡ˆä¸‹è¼‰

```java
/**
 * æª”æ¡ˆä¸‹è¼‰
 */
@GetMapping("/download/{fileName}")
public ResponseEntity<Resource> downloadFile(@PathVariable String fileName) {

    try {
        Path filePath = Paths.get(uploadPath).resolve(fileName);
        Resource resource = new UrlResource(filePath.toUri());

        if (resource.exists() && resource.isReadable()) {
            return ResponseEntity.ok()
                    .header(HttpHeaders.CONTENT_DISPOSITION,
                           "attachment; filename=\"" + fileName + "\"")
                    .body(resource);
        } else {
            return ResponseEntity.notFound().build();
        }

    } catch (MalformedURLException e) {
        log.error("æª”æ¡ˆä¸‹è¼‰å¤±æ•—: {}", fileName, e);
        return ResponseEntity.badRequest().build();
    }
}
```

### æª”æ¡ˆé è¦½

```java
/**
 * æª”æ¡ˆé è¦½ï¼ˆé©ç”¨æ–¼åœ–ç‰‡ç­‰åª’é«”æª”æ¡ˆï¼‰
 */
@GetMapping("/preview/{fileName}")
public ResponseEntity<Resource> previewFile(@PathVariable String fileName) {

    try {
        Path filePath = Paths.get(uploadPath).resolve(fileName);
        Resource resource = new UrlResource(filePath.toUri());

        if (resource.exists() && resource.isReadable()) {
            // æ ¹æ“šæª”æ¡ˆå‰¯æª”åè¨­å®š Content-Type
            String contentType = Files.probeContentType(filePath);

            return ResponseEntity.ok()
                    .header(HttpHeaders.CONTENT_TYPE, contentType)
                    .body(resource);
        } else {
            return ResponseEntity.notFound().build();
        }

    } catch (Exception e) {
        log.error("æª”æ¡ˆé è¦½å¤±æ•—: {}", fileName, e);
        return ResponseEntity.badRequest().build();
    }
}
```

---

## 3.2.6 å®‰å…¨æ€§è€ƒé‡

### æª”æ¡ˆé¡å‹é©—è­‰

```java
/**
 * æª¢æŸ¥æª”æ¡ˆé¡å‹æ˜¯å¦å…è¨±
 */
private boolean isAllowedFileType(MultipartFile file) {
    String contentType = file.getContentType();
    return contentType != null && (
        contentType.startsWith("image/") ||
        contentType.equals("application/pdf") ||
        contentType.equals("text/plain")
    );
}

/**
 * æª¢æŸ¥æª”æ¡ˆå¤§å°
 */
private boolean isValidFileSize(MultipartFile file) {
    long maxSize = 10 * 1024 * 1024; // 10MB
    return file.getSize() <= maxSize;
}
```

### éŒ¯èª¤è™•ç†

```java
/**
 * æª”æ¡ˆè™•ç†ç•°å¸¸è™•ç†å™¨
 */
@ControllerAdvice
public class FileExceptionHandler {

    @ExceptionHandler(MaxUploadSizeExceededException.class)
    public ResponseEntity<String> handleMaxSizeException(MaxUploadSizeExceededException e) {
        return ResponseEntity.status(HttpStatus.PAYLOAD_TOO_LARGE)
                .body("æª”æ¡ˆå¤§å°è¶…éé™åˆ¶");
    }

    @ExceptionHandler(MultipartException.class)
    public ResponseEntity<String> handleMultipartException(MultipartException e) {
        return ResponseEntity.badRequest()
                .body("æª”æ¡ˆä¸Šå‚³æ ¼å¼éŒ¯èª¤");
    }
}
```

---

## ğŸ“ æœ¬ç¯€é‡é»

1. âœ… **æª”æ¡ˆè™•ç†åŸç†**ï¼šç†è§£ multipart/form-data ç·¨ç¢¼æ–¹å¼
2. âœ… **MultipartFile**ï¼šæŒæ¡ Spring Boot æª”æ¡ˆè™•ç† API
3. âœ… **é…ç½®ç®¡ç†**ï¼šæ­£ç¢ºé…ç½®æª”æ¡ˆå¤§å°å’Œè·¯å¾‘
4. âœ… **ä¸Šå‚³ä¸‹è¼‰**ï¼šå¯¦ä½œå–®æª”æ¡ˆå’Œå¤šæª”æ¡ˆè™•ç†
5. âœ… **å®‰å…¨æ€§**ï¼šæª”æ¡ˆé¡å‹é©—è­‰å’Œå¤§å°é™åˆ¶

**æœ€ä½³å¯¦è¸**ï¼š
- ä½¿ç”¨ä¸²æµè™•ç†å¤§æª”æ¡ˆ
- å¯¦ä½œæª”æ¡ˆé¡å‹å’Œå¤§å°é©—è­‰
- ä½¿ç”¨å”¯ä¸€æª”æ¡ˆåç¨±é¿å…è¡çª
- å®šæœŸæ¸…ç†æš«å­˜æª”æ¡ˆ

---

## ğŸ”— ç›¸é—œè³‡æº

- **å®Œæ•´ç¨‹å¼ç¢¼**ï¼š[code-examples/chapter3-enterprise-features/](../../code-examples/chapter3-enterprise-features/)
- **æª”æ¡ˆæ§åˆ¶å™¨**ï¼š[FileStorageController.java](../../code-examples/chapter3-enterprise-features/src/main/java/com/example/enterprise/controller/)
- **æª”æ¡ˆæœå‹™**ï¼š[FileStorageService.java](../../code-examples/chapter3-enterprise-features/src/main/java/com/example/enterprise/service/)
- **å®˜æ–¹æ–‡ä»¶**ï¼š[Spring Boot File Upload](https://spring.io/guides/gs/uploading-files/)

---

**ä¸Šä¸€ç¯€**ï¼š[3.1 è³‡æ–™é©—è­‰èˆ‡éŒ¯èª¤è™•ç†](./3.1-validation-error-handling.md)
**ä¸‹ä¸€ç¯€**ï¼š[3.3 API æ–‡ä»¶åŒ–](./3.3-api-documentation.md)
**å›åˆ°ç›®éŒ„**ï¼š[ç¬¬3ç«  README](./README.md)
