# 3.1 è³‡æ–™é©—è­‰èˆ‡éŒ¯èª¤è™•ç†

> **å°æ‡‰ç« ç¯€**: ç¬¬3ç«  - ä¼æ¥­ç´šåŠŸèƒ½
> **å°æ‡‰ç¯„ä¾‹**: `chapter3-enterprise-features`
> **é›£åº¦**: â­â­â­â˜†â˜†

---

## ğŸ“š æœ¬ç« æ¦‚è¦

è³‡æ–™é©—è­‰æ˜¯ç¢ºä¿ç³»çµ±å®‰å…¨æ€§å’Œè³‡æ–™å®Œæ•´æ€§çš„ç¬¬ä¸€é“é˜²ç·šã€‚æœ¬ç« å°‡å¸¶ä½ æŒæ¡ Spring Boot çš„ Bean Validation æ©Ÿåˆ¶ã€è‡ªè¨‚é©—è­‰å™¨é–‹ç™¼å’Œå…¨åŸŸç•°å¸¸è™•ç†ç­–ç•¥ã€‚

**å­¸ç¿’ç›®æ¨™**:
- ç†è§£è³‡æ–™é©—è­‰åœ¨ Web æ‡‰ç”¨ä¸­çš„é‡è¦æ€§
- æŒæ¡ Bean Validation æ¨™æº–é©—è­‰è¨»è§£
- å­¸æœƒå»ºç«‹è‡ªè¨‚é©—è­‰å™¨
- å¯¦ç¾çµ±ä¸€çš„å…¨åŸŸç•°å¸¸è™•ç†æ©Ÿåˆ¶
- ç‚º AI æ‡‰ç”¨å»ºç«‹ç‰¹æ®Šçš„é©—è­‰ç­–ç•¥

> ğŸ“Œ **èˆ‡ç¬¬2ç« çš„é—œè¯**ï¼šåœ¨ [2.3 ç¯€](../chapter2/2.3-request-response-handling.md#233-éŒ¯èª¤è™•ç†æ¦‚è¿°)ä¸­ï¼Œæˆ‘å€‘ä»‹ç´¹äº†éŒ¯èª¤è™•ç†çš„åŸºæœ¬æ¦‚å¿µã€‚æœ¬ç¯€å°‡æ·±å…¥æ¢è¨ä¼æ¥­ç´šçš„å®Œæ•´å¯¦ä½œã€‚

---

## ğŸ¯ ç‚ºä»€éº¼éœ€è¦è³‡æ–™é©—è­‰ï¼Ÿ

### çœŸå¯¦å ´æ™¯æ€è€ƒ

æƒ³åƒä½ æ­£åœ¨é–‹ç™¼ä¸€å€‹ AI é©…å‹•çš„ä½¿ç”¨è€…è¨»å†Šç³»çµ±ï¼š

```
å ´æ™¯ 1: æ²’æœ‰é©—è­‰çš„æƒ…æ³
ç”¨æˆ¶è¼¸å…¥: username=""  email="invalid"  age=-5
ç³»çµ±è¡Œç‚º: ç›´æ¥å„²å­˜åˆ°è³‡æ–™åº« â†’ ğŸ’¥ è³‡æ–™åº«éŒ¯èª¤ã€æ¥­å‹™é‚è¼¯éŒ¯èª¤

å ´æ™¯ 2: æœ‰å®Œå–„é©—è­‰
ç”¨æˆ¶è¼¸å…¥: username=""  email="invalid"  age=-5
ç³»çµ±è¡Œç‚º: ç«‹å³æ””æˆªä¸¦å›å‚³æ¸…æ™°çš„éŒ¯èª¤è¨Šæ¯ â†’ âœ… ä¿è­·è³‡æ–™å®Œæ•´æ€§
```

### è³‡æ–™é©—è­‰çš„åƒ¹å€¼

| é©—è­‰é¡å‹ | å•é¡Œç¯„ä¾‹ | å¾Œæœ | è§£æ±ºæ–¹æ¡ˆ |
|---------|---------|------|---------|
| **å®Œæ•´æ€§é©—è­‰** | username ç‚º null | è³‡æ–™åº«éŒ¯èª¤ | `@NotBlank` |
| **æ ¼å¼é©—è­‰** | email æ ¼å¼éŒ¯èª¤ | ç„¡æ³•ç™¼é€éƒµä»¶ | `@Email` |
| **ç¯„åœé©—è­‰** | age = -5 | æ¥­å‹™é‚è¼¯éŒ¯èª¤ | `@Min` `@Max` |
| **å®‰å…¨æ€§é©—è­‰** | å¯†ç¢¼å¤ªç°¡å–® | å¸³è™Ÿæ˜“è¢«ç ´è§£ | è‡ªè¨‚ `@StrongPassword` |
| **AI ç‰¹æ®Šé©—è­‰** | æç¤ºè©åŒ…å«æƒ¡æ„å…§å®¹ | AI è¼¸å‡ºä¸ç•¶å…§å®¹ | è‡ªè¨‚å…§å®¹éæ¿¾å™¨ |

---

## ğŸ” è³‡æ–™é©—è­‰å®Œæ•´æµç¨‹

### é©—è­‰æ©Ÿåˆ¶é‹ä½œåŸç†

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ¶ç«¯<br/>(å‰ç«¯/API)
    participant Controller as Spring Controller
    participant Validator as Bean Validator
    participant Handler as å…¨åŸŸç•°å¸¸è™•ç†å™¨
    participant Service as æ¥­å‹™æœå‹™å±¤
    participant DB as è³‡æ–™åº«

    Client->>Controller: 1. POST /api/users/register<br/>@Valid è§¸ç™¼é©—è­‰
    activate Controller

    Controller->>Validator: 2. åŸ·è¡Œé©—è­‰è¦å‰‡
    activate Validator
    Validator->>Validator: æª¢æŸ¥ @NotBlank
    Validator->>Validator: æª¢æŸ¥ @Email
    Validator->>Validator: æª¢æŸ¥ @StrongPassword
    Validator->>Validator: æª¢æŸ¥ @Min @Max

    alt é©—è­‰å¤±æ•—
        Validator-->>Controller: MethodArgumentNotValidException
        Controller->>Handler: 3. æ‹‹å‡ºç•°å¸¸
        activate Handler
        Handler->>Handler: 4. æ•´ç†éŒ¯èª¤è¨Šæ¯
        Handler-->>Client: 5. 400 Bad Request<br/>{"username": "ä¸èƒ½ç‚ºç©º", "email": "æ ¼å¼ä¸æ­£ç¢º"}
        deactivate Handler
    else é©—è­‰æˆåŠŸ
        Validator-->>Controller: é©—è­‰é€šé
        Controller->>Service: 6. å‘¼å«æ¥­å‹™é‚è¼¯
        activate Service
        Service->>DB: 7. å„²å­˜ä½¿ç”¨è€…
        activate DB
        DB-->>Service: å„²å­˜æˆåŠŸ
        deactivate DB
        Service-->>Controller: ä½¿ç”¨è€…ç‰©ä»¶
        deactivate Service
        Controller-->>Client: 8. 201 Created<br/>è¨»å†ŠæˆåŠŸ
    end

    deactivate Validator
    deactivate Controller

    Note over Client,DB: é©—è­‰åœ¨é€²å…¥æ¥­å‹™é‚è¼¯å‰å°±å®Œæˆï¼Œç¢ºä¿è³‡æ–™å®‰å…¨
```

### æµç¨‹é—œéµé»èªªæ˜

| æ­¥é©Ÿ | èªªæ˜ | æŠ€è¡“ç´°ç¯€ |
|-----|------|---------|
| **1. è§¸ç™¼é©—è­‰** | `@Valid` è¨»è§£å•Ÿå‹•é©—è­‰ | Spring AOP æ””æˆªè«‹æ±‚ |
| **2. åŸ·è¡Œé©—è­‰** | Bean Validator æª¢æŸ¥æ‰€æœ‰è¦å‰‡ | JSR-303/380 æ¨™æº– |
| **3. ç•°å¸¸è™•ç†** | é©—è­‰å¤±æ•—æ‹‹å‡ºç•°å¸¸ | `MethodArgumentNotValidException` |
| **4. éŒ¯èª¤æ•´ç†** | å…¨åŸŸè™•ç†å™¨çµ±ä¸€æ ¼å¼ | `@RestControllerAdvice` |
| **5. å›æ‡‰å®¢æˆ¶ç«¯** | è¿”å›æ¸…æ™°çš„éŒ¯èª¤è¨Šæ¯ | çµ±ä¸€ `ApiResponse` æ ¼å¼ |

---

## ğŸ’» Bean Validation å¯¦ä½œ

### æ¨™æº–é©—è­‰è¨»è§£ç¸½è¦½

| è¨»è§£ | é©ç”¨é¡å‹ | é©—è­‰è¦å‰‡ | ç¯„ä¾‹ |
|------|----------|---------|------|
| **@NotNull** | ä»»ä½•é¡å‹ | å€¼ä¸èƒ½ç‚º null | `@NotNull Integer age` |
| **@NotBlank** | String | ä¸èƒ½ç‚º nullã€ç©ºå­—ä¸²æˆ–åªæœ‰ç©ºç™½å­—å…ƒ | `@NotBlank String name` |
| **@NotEmpty** | Collection, Map, Array | ä¸èƒ½ç‚º null æˆ–ç©ºé›†åˆ | `@NotEmpty List<String> tags` |
| **@Size** | String, Collection, Map, Array | é•·åº¦æˆ–å¤§å°é™åˆ¶ | `@Size(min=2, max=50)` |
| **@Min/@Max** | æ•¸å€¼é¡å‹ | æ•¸å€¼ç¯„åœé™åˆ¶ | `@Min(18) @Max(120)` |
| **@Email** | String | é›»å­éƒµä»¶æ ¼å¼é©—è­‰ | `@Email String email` |
| **@Pattern** | String | æ­£è¦è¡¨é”å¼é©—è­‰ | `@Pattern(regexp="^[A-Z].*")` |
| **@Positive/@Negative** | æ•¸å€¼é¡å‹ | æ­£æ•¸æˆ–è² æ•¸é©—è­‰ | `@Positive BigDecimal amount` |
| **@Past/@Future** | Date, LocalDate ç­‰ | éå»æˆ–æœªä¾†æ™‚é–“é©—è­‰ | `@Past LocalDate birthday` |

### ä½¿ç”¨é©—è­‰è¨»è§£

```java
// å°æ‡‰ç¯„ä¾‹: chapter3-enterprise-features/src/main/java/com/example/enterprise/dto/UserRegistrationRequest.java:24

/**
 * ä½¿ç”¨è€…è¨»å†Šè«‹æ±‚ DTO
 * å±•ç¤ºå®Œæ•´çš„è³‡æ–™é©—è­‰åŠŸèƒ½
 */
@Data
public class UserRegistrationRequest {

    @NotBlank(message = "ä½¿ç”¨è€…åç¨±ä¸èƒ½ç‚ºç©º")
    @Size(min = 2, max = 50, message = "ä½¿ç”¨è€…åç¨±é•·åº¦å¿…é ˆåœ¨ 2-50 å­—å…ƒä¹‹é–“")
    private String username;

    @NotBlank(message = "é›»å­éƒµä»¶ä¸èƒ½ç‚ºç©º")
    @Email(message = "é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢º")
    private String email;

    @StrongPassword(minLength = 8, requireSpecialChar = true,
            message = "å¯†ç¢¼å¿…é ˆè‡³å°‘ 8 å­—å…ƒï¼ŒåŒ…å«å¤§å°å¯«å­—æ¯ã€æ•¸å­—å’Œç‰¹æ®Šå­—å…ƒ")
    private String password;

    @NotNull(message = "å¹´é½¡ä¸èƒ½ç‚ºç©º")
    @Min(value = 18, message = "å¹´é½¡å¿…é ˆå¤§æ–¼ç­‰æ–¼ 18 æ­²")
    @Max(value = 120, message = "å¹´é½¡å¿…é ˆå°æ–¼ç­‰æ–¼ 120 æ­²")
    private Integer age;
}
```

**é©—è­‰è¦å‰‡èªªæ˜**ï¼š
- âœ… `username`: ä¸èƒ½ç‚ºç©ºï¼Œé•·åº¦ 2-50 å­—å…ƒ
- âœ… `email`: å¿…é ˆç¬¦åˆé›»å­éƒµä»¶æ ¼å¼
- âœ… `password`: è‡ªè¨‚å¼·å¯†ç¢¼è¦å‰‡ï¼ˆç¨å¾Œèªªæ˜ï¼‰
- âœ… `age`: 18-120 æ­²ä¹‹é–“

---

### åœ¨æ§åˆ¶å™¨ä¸­å•Ÿç”¨é©—è­‰

```java
// å°æ‡‰ç¯„ä¾‹: chapter3-enterprise-features/src/main/java/com/example/enterprise/controller/UserController.java:87

@RestController
@RequestMapping("/api/users")
public class UserController {

    /**
     * ä½¿ç”¨è€…è¨»å†Š
     * @Valid è¨»è§£è§¸ç™¼é©—è­‰ï¼Œé©—è­‰å¤±æ•—æœƒæ‹‹å‡º MethodArgumentNotValidException
     */
    @PostMapping("/register")
    @ResponseStatus(HttpStatus.CREATED)
    public ApiResponse<User> registerUser(
            @Valid @RequestBody UserRegistrationRequest request) {
        User user = userService.registerUser(request);
        return ApiResponse.success("ä½¿ç”¨è€…è¨»å†ŠæˆåŠŸ", user);
    }
}
```

**é—œéµé»**ï¼š
- ğŸ”‘ `@Valid`: å•Ÿå‹•é©—è­‰æ©Ÿåˆ¶
- ğŸ”‘ é©—è­‰å¤±æ•—è‡ªå‹•æ‹‹å‡º `MethodArgumentNotValidException`
- ğŸ”‘ å…¨åŸŸç•°å¸¸è™•ç†å™¨çµ±ä¸€è™•ç†éŒ¯èª¤

**å„ªé»**ï¼š
- âœ… ç„¡éœ€æ‰‹å‹•æª¢æŸ¥æ¯å€‹æ¬„ä½
- âœ… é©—è­‰é‚è¼¯èˆ‡æ¥­å‹™é‚è¼¯åˆ†é›¢
- âœ… çµ±ä¸€çš„éŒ¯èª¤å›æ‡‰æ ¼å¼
- âœ… æ˜“æ–¼ç¶­è­·å’Œæ“´å±•

---

## ğŸ› ï¸ è‡ªè¨‚é©—è­‰è¨»è§£

### ç‚ºä»€éº¼éœ€è¦è‡ªè¨‚é©—è­‰å™¨ï¼Ÿ

æ¨™æº–é©—è­‰è¨»è§£ç„¡æ³•æ¶µè“‹æ‰€æœ‰æ¥­å‹™å ´æ™¯ï¼Œä¾‹å¦‚ï¼š

| æ¥­å‹™éœ€æ±‚ | æ¨™æº–è¨»è§£ | å•é¡Œ | è§£æ±ºæ–¹æ¡ˆ |
|---------|---------|------|---------|
| **å¼·å¯†ç¢¼é©—è­‰** | `@Pattern` | æ­£è¦è¡¨é”å¼è¤‡é›œé›£ç¶­è­· | `@StrongPassword` |
| **é›»è©±è™Ÿç¢¼æ ¼å¼** | `@Pattern` | ä¸åŒåœ‹å®¶æ ¼å¼ä¸åŒ | `@PhoneNumber(region="TW")` |
| **èº«åˆ†è­‰é©—è­‰** | ç„¡ | éœ€è¦æª¢æŸ¥ç¢¼æ¼”ç®—æ³• | `@NationalId` |
| **AI å…§å®¹éæ¿¾** | ç„¡ | éœ€è¦é—œéµå­—æª¢æŸ¥ | `@SafeContent` |

---

### å»ºç«‹è‡ªè¨‚é©—è­‰è¨»è§£

```java
// å°æ‡‰ç¯„ä¾‹: chapter3-enterprise-features/src/main/java/com/example/enterprise/validation/StrongPassword.java

/**
 * å¼·å¯†ç¢¼é©—è­‰è¨»è§£
 * ç”¨æ–¼é©—è­‰å¯†ç¢¼å¼·åº¦ï¼Œç¢ºä¿å¯†ç¢¼åŒ…å«å¤§å°å¯«å­—æ¯ã€æ•¸å­—å’Œç‰¹æ®Šå­—å…ƒ
 */
@Target({ElementType.FIELD, ElementType.PARAMETER})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = StrongPasswordValidator.class)  // æŒ‡å®šé©—è­‰å™¨
@Documented
public @interface StrongPassword {

    // é©—è­‰å¤±æ•—æ™‚çš„éŒ¯èª¤è¨Šæ¯
    String message() default "å¯†ç¢¼å¼·åº¦ä¸è¶³";

    // é©—è­‰åˆ†çµ„ï¼ˆé€²éšåŠŸèƒ½ï¼‰
    Class<?>[] groups() default {};

    // è¼‰è·ï¼ˆé€²éšåŠŸèƒ½ï¼‰
    Class<? extends Payload>[] payload() default {};

    // è‡ªè¨‚åƒæ•¸ï¼šæ˜¯å¦è¦æ±‚ç‰¹æ®Šå­—å…ƒ
    boolean requireSpecialChar() default true;

    // è‡ªè¨‚åƒæ•¸ï¼šæœ€å°é•·åº¦
    int minLength() default 8;
}
```

**è¨»è§£çµæ§‹èªªæ˜**ï¼š
- ğŸ”¸ `@Target`: æŒ‡å®šå¯ä»¥æ¨™è¨»çš„ä½ç½®ï¼ˆæ¬„ä½ã€åƒæ•¸ï¼‰
- ğŸ”¸ `@Constraint`: æŒ‡å®šé©—è­‰å™¨é¡åˆ¥
- ğŸ”¸ `message()`: å¿…é ˆå®šç¾©ï¼Œé©—è­‰å¤±æ•—çš„éŒ¯èª¤è¨Šæ¯
- ğŸ”¸ `groups()` å’Œ `payload()`: JSR-303 æ¨™æº–è¦æ±‚ï¼ˆé€šå¸¸ä½¿ç”¨é è¨­å€¼ï¼‰
- ğŸ”¸ è‡ªè¨‚åƒæ•¸: å¯ä»¥éˆæ´»é…ç½®é©—è­‰è¦å‰‡

---

### å¯¦ç¾é©—è­‰é‚è¼¯

```java
// å°æ‡‰ç¯„ä¾‹: chapter3-enterprise-features/src/main/java/com/example/enterprise/validation/StrongPasswordValidator.java:25

/**
 * å¼·å¯†ç¢¼é©—è­‰å™¨
 * å¯¦ç¾å¯†ç¢¼å¼·åº¦æª¢æŸ¥é‚è¼¯
 */
public class StrongPasswordValidator implements ConstraintValidator<StrongPassword, String> {

    private boolean requireSpecialChar;
    private int minLength;

    /**
     * åˆå§‹åŒ–ï¼šè®€å–è¨»è§£åƒæ•¸
     */
    @Override
    public void initialize(StrongPassword annotation) {
        this.requireSpecialChar = annotation.requireSpecialChar();
        this.minLength = annotation.minLength();
    }

    /**
     * é©—è­‰é‚è¼¯
     */
    @Override
    public boolean isValid(String password, ConstraintValidatorContext context) {
        if (password == null) {
            return false;
        }

        // æª¢æŸ¥é•·åº¦
        if (password.length() < minLength) {
            return false;
        }

        // æª¢æŸ¥æ˜¯å¦åŒ…å«å¤§å¯«å­—æ¯
        if (!password.matches(".*[A-Z].*")) {
            return false;
        }

        // æª¢æŸ¥æ˜¯å¦åŒ…å«å°å¯«å­—æ¯
        if (!password.matches(".*[a-z].*")) {
            return false;
        }

        // æª¢æŸ¥æ˜¯å¦åŒ…å«æ•¸å­—
        if (!password.matches(".*\\d.*")) {
            return false;
        }

        // æª¢æŸ¥æ˜¯å¦åŒ…å«ç‰¹æ®Šå­—å…ƒï¼ˆå¦‚æœéœ€è¦ï¼‰
        if (requireSpecialChar && !password.matches(".*[!@#$%^&*()_+\\-=\\[\\]{};':,.<>?].*")) {
            return false;
        }

        return true;
    }
}
```

**é©—è­‰è¦å‰‡**ï¼š
1. âœ… æª¢æŸ¥å¯†ç¢¼é•·åº¦
2. âœ… æª¢æŸ¥æ˜¯å¦åŒ…å«å¤§å¯«å­—æ¯
3. âœ… æª¢æŸ¥æ˜¯å¦åŒ…å«å°å¯«å­—æ¯
4. âœ… æª¢æŸ¥æ˜¯å¦åŒ…å«æ•¸å­—
5. âœ… æª¢æŸ¥æ˜¯å¦åŒ…å«ç‰¹æ®Šå­—å…ƒï¼ˆå¯é¸ï¼‰

---

### ä½¿ç”¨è‡ªè¨‚é©—è­‰è¨»è§£

```java
// åœ¨ DTO ä¸­ä½¿ç”¨
public class ChangePasswordRequest {

    @NotBlank(message = "èˆŠå¯†ç¢¼ä¸èƒ½ç‚ºç©º")
    private String oldPassword;

    @StrongPassword(
        minLength = 10,              // æœ€å°é•·åº¦ 10
        requireSpecialChar = true,   // å¿…é ˆåŒ…å«ç‰¹æ®Šå­—å…ƒ
        message = "æ–°å¯†ç¢¼å¿…é ˆè‡³å°‘ 10 å­—å…ƒï¼ŒåŒ…å«å¤§å°å¯«å­—æ¯ã€æ•¸å­—å’Œç‰¹æ®Šå­—å…ƒ"
    )
    private String newPassword;
}
```

**å„ªå‹¢**ï¼š
- âœ… å¯é‡è¤‡ä½¿ç”¨
- âœ… åƒæ•¸åŒ–é…ç½®
- âœ… èªç¾©æ¸…æ™°
- âœ… æ˜“æ–¼ç¶­è­·

---

## ğŸ¯ å…¨åŸŸç•°å¸¸è™•ç†

### ç‚ºä»€éº¼éœ€è¦å…¨åŸŸç•°å¸¸è™•ç†ï¼Ÿ

**æ²’æœ‰çµ±ä¸€ç•°å¸¸è™•ç†çš„å•é¡Œ**ï¼š

```java
// âŒ æ¯å€‹æ§åˆ¶å™¨éƒ½è¦è™•ç†ç•°å¸¸
@PostMapping("/register")
public ResponseEntity<?> registerUser(@RequestBody UserRequest request) {
    try {
        // æ¥­å‹™é‚è¼¯
    } catch (ValidationException e) {
        return ResponseEntity.badRequest().body(e.getMessage());
    } catch (DuplicateException e) {
        return ResponseEntity.status(409).body(e.getMessage());
    } catch (Exception e) {
        return ResponseEntity.status(500).body("ç³»çµ±éŒ¯èª¤");
    }
}
// å•é¡Œï¼šä»£ç¢¼é‡è¤‡ã€æ ¼å¼ä¸ä¸€è‡´ã€é›£ä»¥ç¶­è­·
```

**ä½¿ç”¨å…¨åŸŸç•°å¸¸è™•ç†**ï¼š

```java
// âœ… æ¥­å‹™é‚è¼¯ä¹¾æ·¨ç°¡æ½”
@PostMapping("/register")
public ApiResponse<User> registerUser(@Valid @RequestBody UserRequest request) {
    return ApiResponse.success("è¨»å†ŠæˆåŠŸ", userService.register(request));
}
// å„ªé»ï¼šç•°å¸¸è‡ªå‹•è™•ç†ã€æ ¼å¼çµ±ä¸€ã€æ˜“æ–¼ç¶­è­·
```

---

### å…¨åŸŸç•°å¸¸è™•ç†å™¨å¯¦ä½œ

```java
// å°æ‡‰ç¯„ä¾‹: chapter3-enterprise-features/src/main/java/com/example/enterprise/exception/GlobalExceptionHandler.java:30

/**
 * å…¨åŸŸç•°å¸¸è™•ç†å™¨
 * ä½¿ç”¨ @RestControllerAdvice çµ±ä¸€è™•ç†æ‰€æœ‰æ§åˆ¶å™¨çš„ç•°å¸¸
 */
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    /**
     * è™•ç†è³‡æ–™é©—è­‰ç•°å¸¸
     * ç•¶ @Valid é©—è­‰å¤±æ•—æ™‚è§¸ç™¼
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    @ResponseStatus(HttpStatus.BAD_REQUEST)
    public ApiResponse<Void> handleValidationExceptions(
            MethodArgumentNotValidException ex,
            WebRequest request) {

        // æ”¶é›†æ‰€æœ‰é©—è­‰éŒ¯èª¤
        Map<String, String> errors = new HashMap<>();
        ex.getBindingResult().getAllErrors().forEach(error -> {
            String fieldName = ((FieldError) error).getField();
            String errorMessage = error.getDefaultMessage();
            errors.put(fieldName, errorMessage);
        });

        log.warn("è³‡æ–™é©—è­‰å¤±æ•—ï¼š{}", errors);

        return ApiResponse.<Void>builder()
                .code(HttpStatus.BAD_REQUEST.value())
                .message("è³‡æ–™é©—è­‰å¤±æ•—")
                .errors(errors)
                .build();
    }

    /**
     * è™•ç†è³‡æºä¸å­˜åœ¨ç•°å¸¸
     */
    @ExceptionHandler(ResourceNotFoundException.class)
    @ResponseStatus(HttpStatus.NOT_FOUND)
    public ApiResponse<Void> handleResourceNotFoundException(
            ResourceNotFoundException ex,
            WebRequest request) {

        log.warn("è³‡æºä¸å­˜åœ¨ï¼š{}", ex.getMessage());

        return ApiResponse.<Void>builder()
                .code(HttpStatus.NOT_FOUND.value())
                .message(ex.getMessage())
                .build();
    }

    /**
     * è™•ç†æ¥­å‹™é‚è¼¯ç•°å¸¸
     */
    @ExceptionHandler(BusinessException.class)
    public ApiResponse<Void> handleBusinessException(
            BusinessException ex,
            WebRequest request) {

        log.warn("æ¥­å‹™é‚è¼¯ç•°å¸¸ï¼š{}", ex.getMessage());

        return ApiResponse.<Void>builder()
                .code(ex.getCode())
                .message(ex.getMessage())
                .build();
    }

    /**
     * è™•ç†å…¶ä»–æœªé æœŸçš„ç•°å¸¸
     */
    @ExceptionHandler(Exception.class)
    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
    public ApiResponse<Void> handleGlobalException(
            Exception ex,
            WebRequest request) {

        log.error("æœªé æœŸçš„ç•°å¸¸ï¼š{}", ex.getMessage(), ex);

        return ApiResponse.<Void>builder()
                .code(HttpStatus.INTERNAL_SERVER_ERROR.value())
                .message("ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦")
                .build();
    }
}
```

### ç•°å¸¸è™•ç†æµç¨‹

```mermaid
graph TB
    A[æ§åˆ¶å™¨æ–¹æ³•æ‹‹å‡ºç•°å¸¸] --> B{ç•°å¸¸é¡å‹åˆ¤æ–·}
    B -->|MethodArgumentNotValidException| C[handleValidationExceptions]
    B -->|ResourceNotFoundException| D[handleResourceNotFoundException]
    B -->|BusinessException| E[handleBusinessException]
    B -->|å…¶ä»– Exception| F[handleGlobalException]

    C --> G[æ•´ç†é©—è­‰éŒ¯èª¤]
    D --> H[è¨˜éŒ„æ—¥èªŒ]
    E --> H
    F --> H

    G --> I[è¿”å›çµ±ä¸€æ ¼å¼çš„ ApiResponse]
    H --> I

    I --> J[å®¢æˆ¶ç«¯æ”¶åˆ°æ¸…æ™°çš„éŒ¯èª¤è¨Šæ¯]

    style A fill:#FFE6E6
    style B fill:#FFF4E6
    style C fill:#E8F5E9
    style D fill:#E8F5E9
    style E fill:#E8F5E9
    style F fill:#E8F5E9
    style I fill:#E3F2FD
    style J fill:#C8E6C9
```

**è™•ç†å™¨èªªæ˜**ï¼š

| ç•°å¸¸é¡å‹ | HTTP ç‹€æ…‹ç¢¼ | è§¸ç™¼å ´æ™¯ | å›æ‡‰å…§å®¹ |
|---------|-----------|---------|---------|
| `MethodArgumentNotValidException` | 400 | `@Valid` é©—è­‰å¤±æ•— | è©³ç´°çš„æ¬„ä½éŒ¯èª¤è¨Šæ¯ |
| `ResourceNotFoundException` | 404 | è³‡æºä¸å­˜åœ¨ | è³‡æºåç¨±å’Œ ID |
| `BusinessException` | è‡ªè¨‚ | æ¥­å‹™é‚è¼¯éŒ¯èª¤ | æ¥­å‹™éŒ¯èª¤è¨Šæ¯ |
| `Exception` | 500 | æœªé æœŸéŒ¯èª¤ | é€šç”¨éŒ¯èª¤è¨Šæ¯ |

**å„ªé»**ï¼š
- âœ… çµ±ä¸€ç•°å¸¸è™•ç†é‚è¼¯
- âœ… ä¸€è‡´çš„éŒ¯èª¤å›æ‡‰æ ¼å¼
- âœ… é›†ä¸­å¼éŒ¯èª¤æ—¥èªŒè¨˜éŒ„
- âœ… æ§åˆ¶å™¨ä»£ç¢¼ç°¡æ½”
- âœ… æ˜“æ–¼ç¶­è­·å’Œæ“´å±•

---

## ğŸ“¦ è‡ªè¨‚æ¥­å‹™ç•°å¸¸

### ç•°å¸¸å±¤æ¬¡çµæ§‹

```mermaid
classDiagram
    RuntimeException <|-- BusinessException
    BusinessException <|-- ResourceNotFoundException
    BusinessException <|-- FileStorageException

    class RuntimeException {
        <<Java å…§å»º>>
    }

    class BusinessException {
        -int code
        -String message
        +getCode()
    }

    class ResourceNotFoundException {
        +ResourceNotFoundException(resource, id)
    }

    class FileStorageException {
        +FileStorageException(message)
    }

    style RuntimeException fill:#607D8B,stroke:#37474F,stroke-width:2px,color:#fff
    style BusinessException fill:#2196F3,stroke:#1565C0,stroke-width:3px,color:#fff
    style ResourceNotFoundException fill:#4CAF50,stroke:#2E7D32,stroke-width:2px,color:#fff
    style FileStorageException fill:#FF9800,stroke:#E65100,stroke-width:2px,color:#fff
```

### æ¥­å‹™ç•°å¸¸åŸºé¡

```java
// å°æ‡‰ç¯„ä¾‹: chapter3-enterprise-features/src/main/java/com/example/enterprise/exception/BusinessException.java

/**
 * æ¥­å‹™ç•°å¸¸åŸºé¡
 * æ‰€æœ‰æ¥­å‹™ç•°å¸¸éƒ½ç¹¼æ‰¿æ­¤é¡
 */
public class BusinessException extends RuntimeException {

    private final int code;

    public BusinessException(int code, String message) {
        super(message);
        this.code = code;
    }

    public BusinessException(String message) {
        this(400, message);
    }

    public int getCode() {
        return code;
    }
}
```

### å…·é«”æ¥­å‹™ç•°å¸¸

```java
// å°æ‡‰ç¯„ä¾‹: chapter3-enterprise-features/src/main/java/com/example/enterprise/exception/ResourceNotFoundException.java

/**
 * è³‡æºä¸å­˜åœ¨ç•°å¸¸
 */
public class ResourceNotFoundException extends BusinessException {

    public ResourceNotFoundException(String resource, Object id) {
        super(404, String.format("%s (ID: %s) ä¸å­˜åœ¨", resource, id));
    }
}

/**
 * æª”æ¡ˆå„²å­˜ç•°å¸¸
 */
public class FileStorageException extends BusinessException {

    public FileStorageException(String message) {
        super(500, message);
    }

    public FileStorageException(String message, Throwable cause) {
        super(500, message);
        initCause(cause);
    }
}
```

### ä½¿ç”¨æ¥­å‹™ç•°å¸¸

```java
// åœ¨æœå‹™å±¤ä½¿ç”¨
@Service
public class UserService {

    public User findById(Long id) {
        return userRepository.findById(id)
            .orElseThrow(() -> new ResourceNotFoundException("ä½¿ç”¨è€…", id));
    }

    public void uploadAvatar(MultipartFile file) {
        try {
            // ä¸Šå‚³é‚è¼¯
        } catch (IOException e) {
            throw new FileStorageException("æª”æ¡ˆä¸Šå‚³å¤±æ•—", e);
        }
    }
}
```

---

## ğŸ¬ å¯¦éš›æ‡‰ç”¨å ´æ™¯

### å ´æ™¯ 1: ä½¿ç”¨è€…è¨»å†Šç³»çµ±

```java
// å®Œæ•´çš„ä½¿ç”¨è€…è¨»å†Šæµç¨‹
@PostMapping("/register")
public ApiResponse<User> registerUser(@Valid @RequestBody UserRegistrationRequest request) {
    // 1. é©—è­‰è‡ªå‹•å®Œæˆï¼ˆ@Validï¼‰
    // 2. é©—è­‰å¤±æ•—è‡ªå‹•è¿”å›éŒ¯èª¤è¨Šæ¯ï¼ˆGlobalExceptionHandlerï¼‰
    // 3. é©—è­‰æˆåŠŸæ‰åŸ·è¡Œæ¥­å‹™é‚è¼¯
    User user = userService.registerUser(request);
    return ApiResponse.success("è¨»å†ŠæˆåŠŸ", user);
}
```

**API æ¸¬è©¦ç¯„ä¾‹**ï¼š
```bash
# æ¸¬è©¦é©—è­‰æˆåŠŸ
curl -X POST http://localhost:8080/api/users/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "kevin123",
    "email": "kevin@example.com",
    "password": "SecurePass123!",
    "fullName": "Kevin Tsai",
    "age": 25
  }'

# å›æ‡‰ï¼š
# {
#   "code": 201,
#   "message": "ä½¿ç”¨è€…è¨»å†ŠæˆåŠŸ",
#   "data": { "id": 1, "username": "kevin123", ... }
# }

# æ¸¬è©¦é©—è­‰å¤±æ•—
curl -X POST http://localhost:8080/api/users/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "",
    "email": "invalid-email",
    "password": "123",
    "age": 15
  }'

# å›æ‡‰ï¼š
# {
#   "code": 400,
#   "message": "è³‡æ–™é©—è­‰å¤±æ•—",
#   "errors": {
#     "username": "ä½¿ç”¨è€…åç¨±ä¸èƒ½ç‚ºç©º",
#     "email": "é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢º",
#     "password": "å¯†ç¢¼å¿…é ˆè‡³å°‘ 8 å­—å…ƒï¼ŒåŒ…å«å¤§å°å¯«å­—æ¯ã€æ•¸å­—å’Œç‰¹æ®Šå­—å…ƒ",
#     "age": "å¹´é½¡å¿…é ˆå¤§æ–¼ç­‰æ–¼ 18 æ­²"
#   }
# }
```

---

### å ´æ™¯ 2: AI æœå‹™çš„ç‰¹æ®Šé©—è­‰

ç‚º AI æ‡‰ç”¨å»ºç«‹è‡ªè¨‚çš„å…§å®¹å®‰å…¨é©—è­‰ï¼š

```java
/**
 * AI æç¤ºè©å®‰å…¨é©—è­‰
 */
@Target({ElementType.FIELD})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = SafeContentValidator.class)
public @interface SafeContent {
    String message() default "å…§å®¹åŒ…å«ä¸ç•¶è³‡è¨Š";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};
}

/**
 * å…§å®¹å®‰å…¨é©—è­‰å™¨
 */
public class SafeContentValidator implements ConstraintValidator<SafeContent, String> {

    private static final List<String> FORBIDDEN_KEYWORDS = Arrays.asList(
        "æš´åŠ›", "ä»‡æ¨è¨€è«–", "æ•æ„Ÿæ”¿æ²»"
    );

    @Override
    public boolean isValid(String content, ConstraintValidatorContext context) {
        if (content == null) return true;

        String lowerContent = content.toLowerCase();
        return FORBIDDEN_KEYWORDS.stream()
                .noneMatch(lowerContent::contains);
    }
}

/**
 * AI å°è©±è«‹æ±‚
 */
public class ChatRequest {

    @NotBlank(message = "è¨Šæ¯ä¸èƒ½ç‚ºç©º")
    @Size(max = 4000, message = "è¨Šæ¯é•·åº¦ä¸èƒ½è¶…é 4000 å­—å…ƒ")
    @SafeContent(message = "è¨Šæ¯åŒ…å«ä¸ç•¶å…§å®¹")
    private String message;

    @Min(value = 0, message = "æº«åº¦å€¼å¿…é ˆå¤§æ–¼ç­‰æ–¼ 0")
    @Max(value = 2, message = "æº«åº¦å€¼å¿…é ˆå°æ–¼ç­‰æ–¼ 2")
    private Double temperature = 0.7;
}
```

---

## ğŸ“ é‡é»å›é¡§

### æ ¸å¿ƒæ¦‚å¿µ

âœ… **è³‡æ–™é©—è­‰çš„åƒ¹å€¼**ï¼šåœ¨é€²å…¥æ¥­å‹™é‚è¼¯å‰å°±æ””æˆªç„¡æ•ˆè³‡æ–™ï¼Œä¿è­·ç³»çµ±å®‰å…¨
âœ… **Bean Validation**ï¼šä½¿ç”¨ JSR-303/380 æ¨™æº–è¨»è§£é€²è¡Œè²æ˜å¼é©—è­‰
âœ… **è‡ªè¨‚é©—è­‰å™¨**ï¼šé‡å°ç‰¹æ®Šæ¥­å‹™éœ€æ±‚å»ºç«‹å¯é‡ç”¨çš„é©—è­‰é‚è¼¯
âœ… **å…¨åŸŸç•°å¸¸è™•ç†**ï¼šä½¿ç”¨ `@RestControllerAdvice` çµ±ä¸€è™•ç†æ‰€æœ‰ç•°å¸¸
âœ… **æ¥­å‹™ç•°å¸¸å±¤æ¬¡**ï¼šå»ºç«‹æ¸…æ™°çš„ç•°å¸¸ç¹¼æ‰¿çµæ§‹ï¼Œä¾¿æ–¼ç®¡ç†å’Œæ“´å±•

### æœ€ä½³å¯¦è¸

| å¯¦è¸é …ç›® | èªªæ˜ | ç¯„ä¾‹ |
|---------|------|------|
| **é©—è­‰å‰ç§»** | åœ¨æ§åˆ¶å™¨å±¤å°±å®Œæˆé©—è­‰ | `@Valid @RequestBody` |
| **è¨Šæ¯æ¸…æ™°** | æä¾›æ˜ç¢ºçš„éŒ¯èª¤è¨Šæ¯ | `message = "ä½¿ç”¨è€…åç¨±ä¸èƒ½ç‚ºç©º"` |
| **çµ±ä¸€æ ¼å¼** | ä½¿ç”¨çµ±ä¸€çš„å›æ‡‰æ ¼å¼ | `ApiResponse<T>` |
| **åˆ†å±¤ç•°å¸¸** | å»ºç«‹æ¸…æ™°çš„ç•°å¸¸å±¤æ¬¡ | `BusinessException` åŸºé¡ |
| **æ—¥èªŒè¨˜éŒ„** | è¨˜éŒ„æ‰€æœ‰ç•°å¸¸è¨Šæ¯ | `log.warn()` / `log.error()` |

### é©—è­‰è¨»è§£é€ŸæŸ¥è¡¨

```java
// å­—ä¸²é©—è­‰
@NotBlank          // ä¸èƒ½ç‚º nullã€ç©ºå­—ä¸²æˆ–åªæœ‰ç©ºç™½
@Email             // é›»å­éƒµä»¶æ ¼å¼
@Pattern(regexp)   // æ­£è¦è¡¨é”å¼

// æ•¸å€¼é©—è­‰
@NotNull           // ä¸èƒ½ç‚º null
@Min(18)           // æœ€å°å€¼
@Max(120)          // æœ€å¤§å€¼
@Positive          // å¿…é ˆç‚ºæ­£æ•¸

// é›†åˆé©—è­‰
@NotEmpty          // ä¸èƒ½ç‚ºç©ºé›†åˆ
@Size(min, max)    // å¤§å°ç¯„åœ

// æ™‚é–“é©—è­‰
@Past              // å¿…é ˆæ˜¯éå»æ™‚é–“
@Future            // å¿…é ˆæ˜¯æœªä¾†æ™‚é–“

// è‡ªè¨‚é©—è­‰
@StrongPassword    // è‡ªè¨‚å¼·å¯†ç¢¼é©—è­‰
@SafeContent       // è‡ªè¨‚å…§å®¹å®‰å…¨é©—è­‰
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

ç¾åœ¨ä½ å·²ç¶“æŒæ¡äº†è³‡æ–™é©—è­‰å’Œç•°å¸¸è™•ç†ï¼Œæ¥ä¸‹ä¾†æˆ‘å€‘å°‡å­¸ç¿’ï¼š

ğŸ‘‰ [3.2 æª”æ¡ˆä¸Šå‚³èˆ‡ä¸‹è¼‰](./3.2-file-upload-download.md) - è™•ç†å¤šåª’é«”æª”æ¡ˆ
ğŸ‘‰ [3.3 API æ–‡ä»¶åŒ–èˆ‡æ¸¬è©¦](./3.3-api-documentation.md) - ä½¿ç”¨ Swagger è‡ªå‹•ç”Ÿæˆæ–‡ä»¶

---

## ğŸ“š å®Œæ•´ç¯„ä¾‹

æœ¬ç« æ¦‚å¿µçš„å®Œæ•´å¯¦ç¾è«‹åƒè€ƒï¼š

ğŸ“ **chapter3-enterprise-features**
- `src/main/java/com/example/enterprise/dto/UserRegistrationRequest.java` - é©—è­‰è¨»è§£ä½¿ç”¨
- `src/main/java/com/example/enterprise/validation/StrongPasswordValidator.java` - è‡ªè¨‚é©—è­‰å™¨
- `src/main/java/com/example/enterprise/exception/GlobalExceptionHandler.java` - å…¨åŸŸç•°å¸¸è™•ç†
- `src/main/java/com/example/enterprise/controller/UserController.java` - æ§åˆ¶å™¨å¯¦ä½œ

ğŸ”— **å•Ÿå‹•ç¯„ä¾‹**:
```bash
cd code-examples/chapter3-enterprise-features
mvn spring-boot:run
```

ğŸ§ª **æ¸¬è©¦ API**:
```bash
# Swagger UI
http://localhost:8080/swagger-ui.html

# æ¸¬è©¦ä½¿ç”¨è€…è¨»å†Š
curl -X POST http://localhost:8080/api/users/register \
  -H "Content-Type: application/json" \
  -d '{"username": "test", "email": "test@example.com", "password": "Pass123!", "fullName": "Test User", "age": 25}'
```

---

## ğŸ”— åƒè€ƒè³‡æº

- **Bean Validation å®˜æ–¹æ–‡ä»¶**: [beanvalidation.org](https://beanvalidation.org/)
- **Spring Validation æ–‡ä»¶**: [Spring Boot Validation](https://docs.spring.io/spring-boot/docs/current/reference/html/web.html#web.servlet.spring-mvc.validation)
- **Hibernate Validator**: [hibernate.org/validator](https://hibernate.org/validator/)

---

**ç›¸é—œç« ç¯€**:
- â† ä¸Šä¸€ç« : [2.3 è«‹æ±‚èˆ‡å›æ‡‰è™•ç†](../chapter2/2.3-request-response-handling.md)
- â†’ ä¸‹ä¸€ç¯€: [3.2 æª”æ¡ˆä¸Šå‚³èˆ‡ä¸‹è¼‰](./3.2-file-upload-download.md)
- ğŸ“– å›åˆ°ç›®éŒ„: [ç¬¬3ç«  README](./README.md)
