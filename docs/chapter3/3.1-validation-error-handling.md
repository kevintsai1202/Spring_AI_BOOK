# 3.1 資料驗證與錯誤處理

> **學習重點**：掌握 Bean Validation、自訂驗證器和全域異常處理

> 📌 **與第2章的關聯**：在 [2.3 節](../chapter2/2.3-request-response-handling.md#233-錯誤處理概述)中，我們介紹了錯誤處理的基本概念。本節將深入探討企業級的完整實作，包含資料驗證、自訂驗證器和詳細的異常處理機制。

---

## 3.1.1 為什麼需要資料驗證？

在 Web 應用開發中，資料驗證是確保系統安全性和資料完整性的第一道防線。特別是在 AI 應用中，輸入資料的品質直接影響 AI 模型的表現。

**常見問題**：
- 資料完整性問題（null 或空值、格式錯誤）
- 安全性問題（SQL 注入、XSS 攻擊、AI 提示注入）
- 業務邏輯問題（不符合業務規則）

---

## 3.1.2 Spring Boot Bean Validation

### 常用驗證註解

| 註解 | 適用類型 | 說明 | 範例 |
|------|----------|------|------|
| **@NotNull** | 任何類型 | 不能為 null | `@NotNull Integer age` |
| **@NotBlank** | String | 不能為 null、空字串或只有空白字元 | `@NotBlank String name` |
| **@NotEmpty** | Collection, Map, Array | 不能為 null 或空集合 | `@NotEmpty List<String> tags` |
| **@Size** | String, Collection, Map, Array | 長度或大小限制 | `@Size(min=2, max=50)` |
| **@Min/@Max** | 數值類型 | 數值範圍限制 | `@Min(18) @Max(120)` |
| **@Email** | String | 電子郵件格式驗證 | `@Email String email` |
| **@Pattern** | String | 正規表達式驗證 | `@Pattern(regexp="...")` |

### 基本驗證註解使用

```java
/**
 * 使用者註冊請求 DTO
 */
public class UserRegistrationRequest {

    @NotBlank(message = "使用者名稱不能為空")
    @Size(min = 2, max = 50, message = "使用者名稱長度必須在 2-50 字元之間")
    private String username;

    @NotBlank(message = "電子郵件不能為空")
    @Email(message = "電子郵件格式不正確")
    private String email;

    @NotBlank(message = "密碼不能為空")
    @Size(min = 8, max = 128, message = "密碼長度必須在 8-128 字元之間")
    private String password;

    @NotNull(message = "年齡不能為空")
    @Min(value = 18, message = "年齡必須大於等於 18 歲")
    @Max(value = 120, message = "年齡必須小於等於 120 歲")
    private Integer age;

    // Getters and Setters
}
```

### 在控制器中使用驗證

```java
@RestController
@RequestMapping("/api/users")
public class UserController {

    /**
     * 使用者註冊
     * @Valid 註解觸發驗證
     */
    @PostMapping("/register")
    public ResponseEntity<ApiResponse<User>> registerUser(
            @Valid @RequestBody UserRegistrationRequest request) {
        User user = userService.registerUser(request);
        return ResponseEntity.status(HttpStatus.CREATED)
                .body(ApiResponse.success("註冊成功", user));
    }
}
```

> 💡 **重點**：使用 `@Valid` 註解自動觸發驗證，搭配全域異常處理器統一處理驗證錯誤

---

## 3.1.3 自訂驗證註解

當內建驗證註解無法滿足業務需求時，可以建立自訂驗證器：

### 建立自訂驗證註解

```java
/**
 * 自訂驗證註解：檢查密碼強度
 */
@Target({ElementType.FIELD, ElementType.PARAMETER})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = StrongPasswordValidator.class)
public @interface StrongPassword {

    String message() default "密碼強度不足";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};

    boolean requireSpecialChar() default true;
    int minLength() default 8;
}
```

### 實現驗證邏輯

```java
/**
 * 密碼強度驗證器
 */
public class StrongPasswordValidator implements ConstraintValidator<StrongPassword, String> {

    private boolean requireSpecialChar;
    private int minLength;

    @Override
    public void initialize(StrongPassword annotation) {
        this.requireSpecialChar = annotation.requireSpecialChar();
        this.minLength = annotation.minLength();
    }

    @Override
    public boolean isValid(String password, ConstraintValidatorContext context) {
        if (password == null || password.length() < minLength) {
            return false;
        }

        // 檢查大小寫字母、數字和特殊字元
        return password.matches(".*[A-Z].*") &&
               password.matches(".*[a-z].*") &&
               password.matches(".*\\d.*") &&
               (!requireSpecialChar || password.matches(".*[!@#$%^&*()_+\\-=\\[\\]{};':,.<>?].*"));
    }
}
```

---

## 3.1.4 全域異常處理

### 建立全域異常處理器

```java
/**
 * 全域異常處理器
 */
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    /**
     * 處理參數驗證異常
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ApiResponse<Void>> handleValidationException(
            MethodArgumentNotValidException e) {

        log.warn("參數驗證失敗：{}", e.getMessage());

        Map<String, String> errors = new HashMap<>();
        e.getBindingResult().getFieldErrors().forEach(error ->
            errors.put(error.getField(), error.getDefaultMessage())
        );

        ApiResponse<Void> response = ApiResponse.error(400, "參數驗證失敗", errors);
        return ResponseEntity.badRequest().body(response);
    }

    /**
     * 處理資源不存在異常
     */
    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<ApiResponse<Void>> handleResourceNotFoundException(
            ResourceNotFoundException e) {
        log.warn("資源不存在：{}", e.getMessage());

        ApiResponse<Void> response = ApiResponse.error(404, e.getMessage());
        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(response);
    }

    /**
     * 處理業務邏輯異常
     */
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ApiResponse<Void>> handleBusinessException(
            BusinessException e) {
        log.warn("業務邏輯異常：{}", e.getMessage());

        ApiResponse<Void> response = ApiResponse.error(e.getCode(), e.getMessage());
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
    }
}
```

**優點**：
- ✅ 統一異常處理邏輯
- ✅ 一致的錯誤回應格式
- ✅ 集中式錯誤日誌記錄
- ✅ 易於維護和擴展

---

## 3.1.5 自訂業務異常

```java
/**
 * 業務異常基類
 */
public class BusinessException extends RuntimeException {
    private final int code;

    public BusinessException(int code, String message) {
        super(message);
        this.code = code;
    }

    public int getCode() {
        return code;
    }
}

/**
 * 資源不存在異常
 */
public class ResourceNotFoundException extends BusinessException {
    public ResourceNotFoundException(String resource, Object id) {
        super(404, String.format("%s (ID: %s) 不存在", resource, id));
    }
}
```

---

## 📝 本節重點

1. ✅ **Bean Validation**：掌握標準驗證註解的使用
2. ✅ **自訂驗證器**：建立符合業務需求的驗證邏輯
3. ✅ **全域異常處理**：使用 @RestControllerAdvice 統一處理異常
4. ✅ **業務異常**：設計清晰的異常層次結構
5. ✅ **最佳實踐**：建立一致的驗證和錯誤處理機制

---

## 🔗 相關資源

- **完整程式碼**：[code-examples/chapter3-enterprise-features/](../../code-examples/chapter3-enterprise-features/)
- **驗證器實作**：[StrongPasswordValidator.java](../../code-examples/chapter3-enterprise-features/src/main/java/com/example/enterprise/validation/)
- **異常處理**：[GlobalExceptionHandler.java](../../code-examples/chapter3-enterprise-features/src/main/java/com/example/enterprise/exception/)
- **官方文件**：[Bean Validation Specification](https://beanvalidation.org/)

---

**下一節**：[3.2 檔案上傳與下載](./3.2-file-upload-download.md)
**回到目錄**：[第3章 README](./README.md)
