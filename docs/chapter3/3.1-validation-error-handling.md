# 3.1 è³‡æ–™é©—è­‰èˆ‡éŒ¯èª¤è™•ç†

> **å­¸ç¿’é‡é»**ï¼šæŒæ¡ Bean Validationã€è‡ªè¨‚é©—è­‰å™¨å’Œå…¨åŸŸç•°å¸¸è™•ç†

> ğŸ“Œ **èˆ‡ç¬¬2ç« çš„é—œè¯**ï¼šåœ¨ [2.3 ç¯€](../chapter2/2.3-request-response-handling.md#233-éŒ¯èª¤è™•ç†æ¦‚è¿°)ä¸­ï¼Œæˆ‘å€‘ä»‹ç´¹äº†éŒ¯èª¤è™•ç†çš„åŸºæœ¬æ¦‚å¿µã€‚æœ¬ç¯€å°‡æ·±å…¥æ¢è¨ä¼æ¥­ç´šçš„å®Œæ•´å¯¦ä½œï¼ŒåŒ…å«è³‡æ–™é©—è­‰ã€è‡ªè¨‚é©—è­‰å™¨å’Œè©³ç´°çš„ç•°å¸¸è™•ç†æ©Ÿåˆ¶ã€‚

---

## 3.1.1 ç‚ºä»€éº¼éœ€è¦è³‡æ–™é©—è­‰ï¼Ÿ

åœ¨ Web æ‡‰ç”¨é–‹ç™¼ä¸­ï¼Œè³‡æ–™é©—è­‰æ˜¯ç¢ºä¿ç³»çµ±å®‰å…¨æ€§å’Œè³‡æ–™å®Œæ•´æ€§çš„ç¬¬ä¸€é“é˜²ç·šã€‚ç‰¹åˆ¥æ˜¯åœ¨ AI æ‡‰ç”¨ä¸­ï¼Œè¼¸å…¥è³‡æ–™çš„å“è³ªç›´æ¥å½±éŸ¿ AI æ¨¡å‹çš„è¡¨ç¾ã€‚

**å¸¸è¦‹å•é¡Œ**ï¼š
- è³‡æ–™å®Œæ•´æ€§å•é¡Œï¼ˆnull æˆ–ç©ºå€¼ã€æ ¼å¼éŒ¯èª¤ï¼‰
- å®‰å…¨æ€§å•é¡Œï¼ˆSQL æ³¨å…¥ã€XSS æ”»æ“Šã€AI æç¤ºæ³¨å…¥ï¼‰
- æ¥­å‹™é‚è¼¯å•é¡Œï¼ˆä¸ç¬¦åˆæ¥­å‹™è¦å‰‡ï¼‰

---

## 3.1.2 Spring Boot Bean Validation

### å¸¸ç”¨é©—è­‰è¨»è§£

| è¨»è§£ | é©ç”¨é¡å‹ | èªªæ˜ | ç¯„ä¾‹ |
|------|----------|------|------|
| **@NotNull** | ä»»ä½•é¡å‹ | ä¸èƒ½ç‚º null | `@NotNull Integer age` |
| **@NotBlank** | String | ä¸èƒ½ç‚º nullã€ç©ºå­—ä¸²æˆ–åªæœ‰ç©ºç™½å­—å…ƒ | `@NotBlank String name` |
| **@NotEmpty** | Collection, Map, Array | ä¸èƒ½ç‚º null æˆ–ç©ºé›†åˆ | `@NotEmpty List<String> tags` |
| **@Size** | String, Collection, Map, Array | é•·åº¦æˆ–å¤§å°é™åˆ¶ | `@Size(min=2, max=50)` |
| **@Min/@Max** | æ•¸å€¼é¡å‹ | æ•¸å€¼ç¯„åœé™åˆ¶ | `@Min(18) @Max(120)` |
| **@Email** | String | é›»å­éƒµä»¶æ ¼å¼é©—è­‰ | `@Email String email` |
| **@Pattern** | String | æ­£è¦è¡¨é”å¼é©—è­‰ | `@Pattern(regexp="...")` |

### åŸºæœ¬é©—è­‰è¨»è§£ä½¿ç”¨

```java
/**
 * ä½¿ç”¨è€…è¨»å†Šè«‹æ±‚ DTO
 */
public class UserRegistrationRequest {

    @NotBlank(message = "ä½¿ç”¨è€…åç¨±ä¸èƒ½ç‚ºç©º")
    @Size(min = 2, max = 50, message = "ä½¿ç”¨è€…åç¨±é•·åº¦å¿…é ˆåœ¨ 2-50 å­—å…ƒä¹‹é–“")
    private String username;

    @NotBlank(message = "é›»å­éƒµä»¶ä¸èƒ½ç‚ºç©º")
    @Email(message = "é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢º")
    private String email;

    @NotBlank(message = "å¯†ç¢¼ä¸èƒ½ç‚ºç©º")
    @Size(min = 8, max = 128, message = "å¯†ç¢¼é•·åº¦å¿…é ˆåœ¨ 8-128 å­—å…ƒä¹‹é–“")
    private String password;

    @NotNull(message = "å¹´é½¡ä¸èƒ½ç‚ºç©º")
    @Min(value = 18, message = "å¹´é½¡å¿…é ˆå¤§æ–¼ç­‰æ–¼ 18 æ­²")
    @Max(value = 120, message = "å¹´é½¡å¿…é ˆå°æ–¼ç­‰æ–¼ 120 æ­²")
    private Integer age;

    // Getters and Setters
}
```

### åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨é©—è­‰

```java
@RestController
@RequestMapping("/api/users")
public class UserController {

    /**
     * ä½¿ç”¨è€…è¨»å†Š
     * @Valid è¨»è§£è§¸ç™¼é©—è­‰
     */
    @PostMapping("/register")
    public ResponseEntity<ApiResponse<User>> registerUser(
            @Valid @RequestBody UserRegistrationRequest request) {
        User user = userService.registerUser(request);
        return ResponseEntity.status(HttpStatus.CREATED)
                .body(ApiResponse.success("è¨»å†ŠæˆåŠŸ", user));
    }
}
```

> ğŸ’¡ **é‡é»**ï¼šä½¿ç”¨ `@Valid` è¨»è§£è‡ªå‹•è§¸ç™¼é©—è­‰ï¼Œæ­é…å…¨åŸŸç•°å¸¸è™•ç†å™¨çµ±ä¸€è™•ç†é©—è­‰éŒ¯èª¤

---

## 3.1.3 è‡ªè¨‚é©—è­‰è¨»è§£

ç•¶å…§å»ºé©—è­‰è¨»è§£ç„¡æ³•æ»¿è¶³æ¥­å‹™éœ€æ±‚æ™‚ï¼Œå¯ä»¥å»ºç«‹è‡ªè¨‚é©—è­‰å™¨ï¼š

### å»ºç«‹è‡ªè¨‚é©—è­‰è¨»è§£

```java
/**
 * è‡ªè¨‚é©—è­‰è¨»è§£ï¼šæª¢æŸ¥å¯†ç¢¼å¼·åº¦
 */
@Target({ElementType.FIELD, ElementType.PARAMETER})
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = StrongPasswordValidator.class)
public @interface StrongPassword {

    String message() default "å¯†ç¢¼å¼·åº¦ä¸è¶³";
    Class<?>[] groups() default {};
    Class<? extends Payload>[] payload() default {};

    boolean requireSpecialChar() default true;
    int minLength() default 8;
}
```

### å¯¦ç¾é©—è­‰é‚è¼¯

```java
/**
 * å¯†ç¢¼å¼·åº¦é©—è­‰å™¨
 */
public class StrongPasswordValidator implements ConstraintValidator<StrongPassword, String> {

    private boolean requireSpecialChar;
    private int minLength;

    @Override
    public void initialize(StrongPassword annotation) {
        this.requireSpecialChar = annotation.requireSpecialChar();
        this.minLength = annotation.minLength();
    }

    @Override
    public boolean isValid(String password, ConstraintValidatorContext context) {
        if (password == null || password.length() < minLength) {
            return false;
        }

        // æª¢æŸ¥å¤§å°å¯«å­—æ¯ã€æ•¸å­—å’Œç‰¹æ®Šå­—å…ƒ
        return password.matches(".*[A-Z].*") &&
               password.matches(".*[a-z].*") &&
               password.matches(".*\\d.*") &&
               (!requireSpecialChar || password.matches(".*[!@#$%^&*()_+\\-=\\[\\]{};':,.<>?].*"));
    }
}
```

---

## 3.1.4 å…¨åŸŸç•°å¸¸è™•ç†

### å»ºç«‹å…¨åŸŸç•°å¸¸è™•ç†å™¨

```java
/**
 * å…¨åŸŸç•°å¸¸è™•ç†å™¨
 */
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {

    /**
     * è™•ç†åƒæ•¸é©—è­‰ç•°å¸¸
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ApiResponse<Void>> handleValidationException(
            MethodArgumentNotValidException e) {

        log.warn("åƒæ•¸é©—è­‰å¤±æ•—ï¼š{}", e.getMessage());

        Map<String, String> errors = new HashMap<>();
        e.getBindingResult().getFieldErrors().forEach(error ->
            errors.put(error.getField(), error.getDefaultMessage())
        );

        ApiResponse<Void> response = ApiResponse.error(400, "åƒæ•¸é©—è­‰å¤±æ•—", errors);
        return ResponseEntity.badRequest().body(response);
    }

    /**
     * è™•ç†è³‡æºä¸å­˜åœ¨ç•°å¸¸
     */
    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<ApiResponse<Void>> handleResourceNotFoundException(
            ResourceNotFoundException e) {
        log.warn("è³‡æºä¸å­˜åœ¨ï¼š{}", e.getMessage());

        ApiResponse<Void> response = ApiResponse.error(404, e.getMessage());
        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(response);
    }

    /**
     * è™•ç†æ¥­å‹™é‚è¼¯ç•°å¸¸
     */
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ApiResponse<Void>> handleBusinessException(
            BusinessException e) {
        log.warn("æ¥­å‹™é‚è¼¯ç•°å¸¸ï¼š{}", e.getMessage());

        ApiResponse<Void> response = ApiResponse.error(e.getCode(), e.getMessage());
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(response);
    }
}
```

**å„ªé»**ï¼š
- âœ… çµ±ä¸€ç•°å¸¸è™•ç†é‚è¼¯
- âœ… ä¸€è‡´çš„éŒ¯èª¤å›æ‡‰æ ¼å¼
- âœ… é›†ä¸­å¼éŒ¯èª¤æ—¥èªŒè¨˜éŒ„
- âœ… æ˜“æ–¼ç¶­è­·å’Œæ“´å±•

---

## 3.1.5 è‡ªè¨‚æ¥­å‹™ç•°å¸¸

```java
/**
 * æ¥­å‹™ç•°å¸¸åŸºé¡
 */
public class BusinessException extends RuntimeException {
    private final int code;

    public BusinessException(int code, String message) {
        super(message);
        this.code = code;
    }

    public int getCode() {
        return code;
    }
}

/**
 * è³‡æºä¸å­˜åœ¨ç•°å¸¸
 */
public class ResourceNotFoundException extends BusinessException {
    public ResourceNotFoundException(String resource, Object id) {
        super(404, String.format("%s (ID: %s) ä¸å­˜åœ¨", resource, id));
    }
}
```

---

## ğŸ“ æœ¬ç¯€é‡é»

1. âœ… **Bean Validation**ï¼šæŒæ¡æ¨™æº–é©—è­‰è¨»è§£çš„ä½¿ç”¨
2. âœ… **è‡ªè¨‚é©—è­‰å™¨**ï¼šå»ºç«‹ç¬¦åˆæ¥­å‹™éœ€æ±‚çš„é©—è­‰é‚è¼¯
3. âœ… **å…¨åŸŸç•°å¸¸è™•ç†**ï¼šä½¿ç”¨ @RestControllerAdvice çµ±ä¸€è™•ç†ç•°å¸¸
4. âœ… **æ¥­å‹™ç•°å¸¸**ï¼šè¨­è¨ˆæ¸…æ™°çš„ç•°å¸¸å±¤æ¬¡çµæ§‹
5. âœ… **æœ€ä½³å¯¦è¸**ï¼šå»ºç«‹ä¸€è‡´çš„é©—è­‰å’ŒéŒ¯èª¤è™•ç†æ©Ÿåˆ¶

---

## ğŸ”— ç›¸é—œè³‡æº

- **å®Œæ•´ç¨‹å¼ç¢¼**ï¼š[code-examples/chapter3-enterprise-features/](../../code-examples/chapter3-enterprise-features/)
- **é©—è­‰å™¨å¯¦ä½œ**ï¼š[StrongPasswordValidator.java](../../code-examples/chapter3-enterprise-features/src/main/java/com/example/enterprise/validation/)
- **ç•°å¸¸è™•ç†**ï¼š[GlobalExceptionHandler.java](../../code-examples/chapter3-enterprise-features/src/main/java/com/example/enterprise/exception/)
- **å®˜æ–¹æ–‡ä»¶**ï¼š[Bean Validation Specification](https://beanvalidation.org/)

---

**ä¸‹ä¸€ç¯€**ï¼š[3.2 æª”æ¡ˆä¸Šå‚³èˆ‡ä¸‹è¼‰](./3.2-file-upload-download.md)
**å›åˆ°ç›®éŒ„**ï¼š[ç¬¬3ç«  README](./README.md)
