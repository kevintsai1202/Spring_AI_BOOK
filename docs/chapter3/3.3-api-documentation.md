# 3.3 API 文件化與測試

> **學習重點**：掌握 Swagger/OpenAPI 自動文件生成和 API 測試工具使用

---

## 3.3.1 為什麼需要 API 文件？

API 文件就像是「使用指南」，對於開發團隊協作和第三方整合至關重要：

**沒有文件的痛點**：
- ❌ API 做什麼功能不清楚
- ❌ 參數格式不明確
- ❌ 回傳資料結構未知
- ❌ 錯誤碼和處理方式不明

**有文件的優勢**：
- ✅ 前後端協作效率提升
- ✅ 減少溝通成本
- ✅ 新成員快速上手
- ✅ 支援第三方整合

---

## 3.3.2 整合 Swagger/OpenAPI

> ⚠️ **重要說明**：Swagger/OpenAPI **並非** Spring Boot 內建功能，而是**第三方套件**。需要手動添加依賴並指定版本號。

### SpringDoc vs Springfox

目前主流的 Spring Boot OpenAPI 整合方案有兩種：

| 方案 | 狀態 | 適用版本 | 推薦度 |
|------|------|----------|--------|
| **SpringDoc** | ✅ 活躍維護 | Spring Boot 3.x | ⭐⭐⭐⭐⭐ 推薦 |
| **Springfox** | ❌ 停止維護 | Spring Boot 2.x | 不推薦 |

> 💡 **本書使用 SpringDoc**：因為它是目前唯一支援 Spring Boot 3.x 的活躍專案，並且符合最新的 OpenAPI 3.0 規範。

### 1. 添加依賴

```xml
<!-- pom.xml -->
<!-- ⚠️ 必須明確指定版本號，SpringDoc 不在 Spring Boot 的依賴管理中 -->
<dependency>
    <groupId>org.springdoc</groupId>
    <artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
    <version>2.2.0</version>  <!-- 明確指定版本，非 Spring Boot 內建套件 -->
</dependency>
```

**版本選擇建議**：

| Spring Boot 版本 | SpringDoc 版本 | 說明 |
|------------------|----------------|------|
| 3.0.x - 3.2.x | 2.2.0+ | 本書使用版本 |
| 2.x | 1.7.0 | 舊版本，不建議新專案使用 |

> 📦 **為什麼要指定版本？**
> - SpringDoc 是第三方套件，不包含在 Spring Boot 的 `spring-boot-dependencies` BOM 中
> - 如果不指定版本號，Maven 將無法解析依賴
> - 不同版本的 SpringDoc 支援不同的 Spring Boot 版本

### 2. 基本配置

```java
@Configuration
public class OpenApiConfig {

    @Bean
    public OpenAPI customOpenAPI() {
        return new OpenAPI()
                .info(new Info()
                        .title("企業級功能 API")
                        .version("1.0.0")
                        .description("資料驗證、檔案處理與 API 文件化範例")
                        .contact(new Contact()
                                .name("開發團隊")
                                .email("dev@example.com")
                                .url("https://example.com"))
                        .license(new License()
                                .name("MIT License")
                                .url("https://opensource.org/licenses/MIT")))
                .servers(Arrays.asList(
                        new Server().url("http://localhost:8080").description("開發環境"),
                        new Server().url("https://api.example.com").description("生產環境")
                ));
    }
}
```

### 3. 訪問 Swagger UI

應用程式啟動後：
- **Swagger UI**: http://localhost:8080/swagger-ui.html
- **API 文件**: http://localhost:8080/v3/api-docs

---

## 3.3.3 使用 Swagger 註解

### 控制器文件化

```java
/**
 * 使用者管理控制器
 * 展示如何使用 Swagger 註解為 API 生成文件
 */
@RestController
@RequestMapping("/api/users")
@Tag(name = "使用者管理", description = "使用者相關的 CRUD 操作")
public class UserController {

    // 📝 API 方法文件化
    @Operation(
        summary = "獲取所有使用者",
        description = "獲取系統中所有使用者的列表，支援分頁和排序"
    )
    @ApiResponses(value = {
        @ApiResponse(responseCode = "200", description = "成功獲取使用者列表"),
        @ApiResponse(responseCode = "500", description = "伺服器內部錯誤")
    })
    @GetMapping
    public ResponseEntity<ApiResponse<List<User>>> getAllUsers(
            @Parameter(description = "頁碼，從 0 開始", example = "0")
            @RequestParam(defaultValue = "0") int page,

            @Parameter(description = "每頁大小", example = "10")
            @RequestParam(defaultValue = "10") int size) {
        // 實作略...
        return ResponseEntity.ok(ApiResponse.success("獲取成功", users));
    }

    // 📝 POST 請求文件化
    @Operation(summary = "建立新使用者", description = "建立一個新的使用者帳號")
    @ApiResponse(responseCode = "201", description = "使用者建立成功")
    @PostMapping
    public ResponseEntity<ApiResponse<User>> createUser(
            @Parameter(description = "使用者建立請求", required = true)
            @Valid @RequestBody CreateUserRequest request) {
        // 實作略...
        return ResponseEntity.status(HttpStatus.CREATED).body(ApiResponse.success("建立成功", user));
    }
}
```

### 資料模型文件化

```java
/**
 * 📝 使用 @Schema 註解為資料模型添加文件
 */
@Schema(description = "使用者資訊")
public class User {

    @Schema(description = "使用者 ID", example = "1", accessMode = Schema.AccessMode.READ_ONLY)
    private Long id;

    @Schema(description = "使用者名稱", example = "張小明", requiredMode = Schema.RequiredMode.REQUIRED)
    private String name;

    @Schema(description = "電子郵件地址", example = "ming@example.com")
    private String email;

    // Getters and Setters
}

/**
 * 📝 結合驗證註解和文件註解
 */
@Schema(description = "建立使用者請求")
public class CreateUserRequest {

    @Schema(description = "使用者名稱", example = "張小明", requiredMode = Schema.RequiredMode.REQUIRED)
    @NotBlank(message = "使用者名稱不能為空")
    private String name;

    @Schema(description = "電子郵件地址", example = "ming@example.com", requiredMode = Schema.RequiredMode.REQUIRED)
    @Email(message = "電子郵件格式不正確")
    private String email;

    // Getters and Setters
}
```

> 💡 **重點**：Swagger 註解與業務邏輯分離，只需在類別和方法上添加文件標註，文件會自動生成

---

## 3.3.4 API 測試工具

### 使用 curl 測試

```bash
# GET 請求
curl -X GET "http://localhost:8080/api/users?page=0&size=10"

# POST 請求（JSON）
curl -X POST "http://localhost:8080/api/users" \
     -H "Content-Type: application/json" \
     -d '{"name": "測試使用者", "email": "test@example.com"}'

# 檔案上傳
curl -X POST "http://localhost:8080/api/files/upload" -F "file=@test.jpg"
```

### 使用 Postman 或 Swagger UI 測試

**推薦方式**：
- ✅ **Swagger UI**：內建測試介面（http://localhost:8080/swagger-ui.html）
- ✅ **Postman**：功能完整的 API 測試工具
- ✅ **curl**：命令列快速測試

> 💡 **提示**：Swagger UI 提供即時測試功能，可直接在文件頁面測試 API

---

## 3.3.5 API 測試類型

| 測試類型 | 目的 | 測試範圍 | 適用場景 |
|----------|------|----------|----------|
| **功能測試** | 驗證 API 功能正確性 | 單一 API 端點 | 基本 CRUD 操作 |
| **整合測試** | 驗證系統間協作 | 多個 API 端點 | 業務流程測試 |
| **效能測試** | 驗證回應時間和吞吐量 | 系統負載能力 | 高併發場景 |
| **安全測試** | 驗證安全機制 | 認證授權機制 | 敏感資料保護 |

---

## 📝 本節重點

1. ✅ **API 文件重要性**：理解文件對團隊協作的價值
2. ✅ **Swagger 整合**：掌握 SpringDoc OpenAPI 配置
3. ✅ **註解使用**：學會使用 @Operation、@Schema 等註解
4. ✅ **測試工具**：熟練使用 curl、Postman 和 Swagger UI

**Swagger 註解速查表**：

| 註解 | 用途 | 適用範圍 |
|------|------|----------|
| `@Tag` | API 分組 | 控制器類別 |
| `@Operation` | API 描述 | 控制器方法 |
| `@Parameter` | 參數說明 | 方法參數 |
| `@Schema` | 資料模型 | 類別、欄位 |
| `@ApiResponse` | 回應說明 | 控制器方法 |

---

## 🔗 相關資源

- **完整程式碼**：[code-examples/chapter3-enterprise-features/](../../code-examples/chapter3-enterprise-features/)
- **Swagger 配置**：[OpenApiConfig.java](../../code-examples/chapter3-enterprise-features/src/main/java/com/example/enterprise/config/)
- **控制器範例**：[UserController.java](../../code-examples/chapter3-enterprise-features/src/main/java/com/example/enterprise/controller/)
- **官方文件**：[SpringDoc OpenAPI](https://springdoc.org/)

---

**上一節**：[3.2 檔案上傳與下載](./3.2-file-upload-download.md)
**回到目錄**：[第3章 README](./README.md)
