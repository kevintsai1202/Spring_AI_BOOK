# 8.1 ç°¡è¿° Advanced RAG

> **æœ¬ç« é‡é»**ï¼šæ·±å…¥äº†è§£ Advanced RAG æŠ€è¡“çš„æ ¸å¿ƒæ¦‚å¿µï¼ŒæŒæ¡å¾åŸºç¤ RAG åˆ°é€²éš RAG çš„æŠ€è¡“æ¼”é€²è·¯ç·šï¼Œå»ºç«‹å®Œæ•´çš„ Advanced RAG çŸ¥è­˜é«”ç³»ã€‚

## ğŸ¯ å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬ç« å­¸ç¿’å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š

- ğŸ¯ **ç†è§£ Advanced RAG æ¦‚å¿µ**ï¼šæŒæ¡ Advanced RAG çš„æ ¸å¿ƒç†å¿µå’ŒæŠ€è¡“ç‰¹é»
- ğŸ¯ **æŒæ¡æŠ€è¡“æ¼”é€²è·¯ç·š**ï¼šäº†è§£å¾åŸºç¤ RAG åˆ° Advanced RAG çš„ç™¼å±•æ­·ç¨‹
- ğŸ¯ **è­˜åˆ¥é—œéµæŠ€è¡“è¦ç´ **ï¼šèªè­˜ Advanced RAG çš„æ ¸å¿ƒæŠ€è¡“çµ„ä»¶
- ğŸ¯ **è©•ä¼°æŠ€è¡“é¸å‹**ï¼šèƒ½å¤ æ ¹æ“šæ¥­å‹™éœ€æ±‚é¸æ“‡åˆé©çš„ Advanced RAG æŠ€è¡“
- ğŸ¯ **è¦åŠƒå¯¦æ–½ç­–ç•¥**ï¼šåˆ¶å®š Advanced RAG ç³»çµ±çš„å¯¦æ–½è¨ˆåŠƒ

---

## 8.1.1 ä»€éº¼æ˜¯ Advanced RAGï¼Ÿ

### RAG æŠ€è¡“æ¼”é€²æ­·ç¨‹

**RAG ç™¼å±•çš„å››å€‹éšæ®µ**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RAG Technology Evolution                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬ä¸€ä»£ï¼šåŸºç¤ RAG (Naive RAG)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â€¢ ç°¡å–®çš„å‘é‡æª¢ç´¢ + ç”Ÿæˆ                               â”‚ â”‚
â”‚  â”‚  â€¢ å›ºå®šçš„åˆ†å¡Šç­–ç•¥                                       â”‚ â”‚
â”‚  â”‚  â€¢ åŸºæœ¬çš„ç›¸ä¼¼åº¦åŒ¹é…                                     â”‚ â”‚
â”‚  â”‚  â€¢ é™åˆ¶ï¼šæª¢ç´¢ç²¾åº¦ä¸é«˜ã€ä¸Šä¸‹æ–‡ç†è§£æœ‰é™                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â†“                                â”‚
â”‚  ç¬¬äºŒä»£ï¼šæ”¹é€² RAG (Enhanced RAG)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â€¢ å„ªåŒ–çš„æ–‡æœ¬åˆ†å¡Šç­–ç•¥                                   â”‚ â”‚
â”‚  â”‚  â€¢ æ”¹é€²çš„ Embedding æ¨¡å‹                               â”‚ â”‚
â”‚  â”‚  â€¢ åŸºæœ¬çš„é‡æ’åºæ©Ÿåˆ¶                                     â”‚ â”‚
â”‚  â”‚  â€¢ æ”¹é€²ï¼šæå‡æª¢ç´¢ç›¸é—œæ€§ã€æ¸›å°‘å™ªéŸ³                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â†“                                â”‚
â”‚  ç¬¬ä¸‰ä»£ï¼šæ¨¡çµ„åŒ– RAG (Modular RAG)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â€¢ å¯æ’æ‹”çš„æª¢ç´¢æ¨¡çµ„                                     â”‚ â”‚
â”‚  â”‚  â€¢ å¤šéšæ®µæª¢ç´¢æµç¨‹                                       â”‚ â”‚
â”‚  â”‚  â€¢ è‡ªé©æ‡‰æª¢ç´¢ç­–ç•¥                                       â”‚ â”‚
â”‚  â”‚  â€¢ ç‰¹é»ï¼šéˆæ´»æ€§é«˜ã€å¯å®šåˆ¶åŒ–                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â†“                                â”‚
â”‚  ç¬¬å››ä»£ï¼šAdvanced RAG (æ™ºèƒ½åŒ– RAG)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  â€¢ æ™ºèƒ½æŸ¥è©¢ç†è§£èˆ‡é‡å¯«                                   â”‚ â”‚
â”‚  â”‚  â€¢ å¤šæ¨¡æ…‹æª¢ç´¢èˆ‡ç”Ÿæˆ                                     â”‚ â”‚
â”‚  â”‚  â€¢ è‡ªæˆ‘åæ€èˆ‡ä¿®æ­£æ©Ÿåˆ¶                                   â”‚ â”‚
â”‚  â”‚  â€¢ çŸ¥è­˜åœ–è­œå¢å¼·æª¢ç´¢                                     â”‚ â”‚
â”‚  â”‚  â€¢ å„ªå‹¢ï¼šé«˜ç²¾åº¦ã€å¼·é©æ‡‰æ€§ã€æ™ºèƒ½åŒ–                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Advanced RAG çš„æ ¸å¿ƒç‰¹å¾µ

#### 1. æ™ºèƒ½æŸ¥è©¢è™•ç†
- **æŸ¥è©¢ç†è§£**ï¼šæ·±åº¦ç†è§£ç”¨æˆ¶æ„åœ–å’ŒæŸ¥è©¢èªç¾©
- **æŸ¥è©¢é‡å¯«**ï¼šè‡ªå‹•å„ªåŒ–æŸ¥è©¢è¡¨é”ä»¥æå‡æª¢ç´¢æ•ˆæœ
- **æŸ¥è©¢æ“´å±•**ï¼šåŸºæ–¼ä¸Šä¸‹æ–‡å’ŒçŸ¥è­˜åº«æ“´å±•æŸ¥è©¢ç¯„åœ
- **å¤šè¼ªå°è©±**ï¼šæ”¯æŒé€£çºŒå°è©±ä¸­çš„ä¸Šä¸‹æ–‡ç†è§£

#### 2. å¤šéšæ®µæª¢ç´¢ç­–ç•¥
- **ç²—æª¢ç´¢**ï¼šå¿«é€Ÿç¯©é¸å¤§é‡å€™é¸æ–‡æª”
- **ç²¾æª¢ç´¢**ï¼šæ·±åº¦åˆ†æå€™é¸æ–‡æª”çš„ç›¸é—œæ€§
- **é‡æ’åº**ï¼šåŸºæ–¼å¤šç¶­åº¦æŒ‡æ¨™é‡æ–°æ’åºçµæœ
- **å¾Œè™•ç†**ï¼šå»é‡ã€éæ¿¾å’Œå“è³ªæ§åˆ¶

#### 3. å¢å¼·çš„ä¸Šä¸‹æ–‡ç®¡ç†
- **å‹•æ…‹ä¸Šä¸‹æ–‡**ï¼šæ ¹æ“šæŸ¥è©¢å‹•æ…‹èª¿æ•´ä¸Šä¸‹æ–‡çª—å£
- **ä¸Šä¸‹æ–‡å£“ç¸®**ï¼šæ™ºèƒ½å£“ç¸®å†—é¤˜ä¿¡æ¯
- **ä¸Šä¸‹æ–‡èåˆ**ï¼šå¤šä¾†æºä¿¡æ¯çš„æ™ºèƒ½æ•´åˆ
- **ä¸Šä¸‹æ–‡é©—è­‰**ï¼šç¢ºä¿ä¸Šä¸‹æ–‡çš„æº–ç¢ºæ€§å’Œç›¸é—œæ€§

#### 4. è‡ªé©æ‡‰å„ªåŒ–æ©Ÿåˆ¶
- **æ•ˆæœç›£æ§**ï¼šå¯¦æ™‚ç›£æ§æª¢ç´¢å’Œç”Ÿæˆæ•ˆæœ
- **ç­–ç•¥èª¿æ•´**ï¼šåŸºæ–¼æ•ˆæœåé¥‹è‡ªå‹•èª¿æ•´ç­–ç•¥
- **å­¸ç¿’å„ªåŒ–**ï¼šå¾ç”¨æˆ¶åé¥‹ä¸­æŒçºŒå­¸ç¿’æ”¹é€²
- **å€‹æ€§åŒ–**ï¼šæ ¹æ“šç”¨æˆ¶åå¥½å®šåˆ¶æª¢ç´¢ç­–ç•¥

---

## 8.1.2 Advanced RAG æ ¸å¿ƒæŠ€è¡“çµ„ä»¶

### Spring AI ä¾è³´é…ç½®

åœ¨å¯¦ç¾ Advanced RAG ä¹‹å‰ï¼Œéœ€è¦æ·»åŠ ç›¸é—œçš„ Spring AI ä¾è³´ï¼š

```xml
<dependencies>
    <!-- Spring AI Core -->
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-spring-boot-starter</artifactId>
    </dependency>
    
    <!-- Spring AI OpenAI -->
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-openai-spring-boot-starter</artifactId>
    </dependency>
    
    <!-- Spring AI Vector Store Advisors -->
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-advisors-vector-store</artifactId>
    </dependency>
    
    <!-- Spring AI Vector Store (é¸æ“‡åˆé©çš„å¯¦ç¾) -->
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-pgvector-store-spring-boot-starter</artifactId>
    </dependency>
</dependencies>
```

### å¿…è¦çš„ Import è²æ˜

```java
// Spring AI æ ¸å¿ƒé¡
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.client.advisor.Advisor;
import org.springframework.ai.chat.model.ChatModel;
import org.springframework.ai.document.Document;
import org.springframework.ai.retrieval.search.DocumentRetriever;
import org.springframework.ai.retrieval.search.VectorStoreDocumentRetriever;
import org.springframework.ai.vectorstore.VectorStore;

// RAG ç›¸é—œé¡
import org.springframework.ai.chat.client.advisor.retrieval.RetrievalAugmentationAdvisor;
import org.springframework.ai.chat.client.advisor.retrieval.ContextualQueryAugmenter;
import org.springframework.ai.retrieval.search.DocumentJoiner;
import org.springframework.ai.retrieval.search.ConcatenationDocumentJoiner;

// æŸ¥è©¢è™•ç†ç›¸é—œé¡
import org.springframework.ai.retrieval.query.Query;
import org.springframework.ai.retrieval.query.QueryTransformer;
import org.springframework.ai.retrieval.query.RewriteQueryTransformer;
import org.springframework.ai.retrieval.query.CompressionQueryTransformer;
import org.springframework.ai.retrieval.query.TranslationQueryTransformer;
import org.springframework.ai.retrieval.query.QueryExpander;
import org.springframework.ai.retrieval.query.MultiQueryExpander;

// Prompt ç›¸é—œé¡
import org.springframework.ai.chat.prompt.PromptTemplate;
import org.springframework.ai.openai.OpenAiChatOptions;
```

### Spring AI Advanced RAG æ¶æ§‹

**åŸºæ–¼ Spring AI æ¨¡çµ„åŒ–æ¶æ§‹**ï¼š
```java
/**
 * Advanced RAG ç³»çµ±æ¶æ§‹ - åŸºæ–¼ Spring AI RetrievalAugmentationAdvisor
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class AdvancedRAGService {
    
    private final ChatClient chatClient;
    private final VectorStore vectorStore;
    private final ChatModel chatModel;
    
    /**
     * é…ç½® Advanced RAG ChatClient
     */
    @Bean
    public ChatClient advancedRAGChatClient(ChatModel chatModel, VectorStore vectorStore) {
        
        // 1. é…ç½®æŸ¥è©¢è½‰æ›å™¨ - æŸ¥è©¢é‡å¯«å’Œæ“´å±•
        QueryTransformer queryRewriter = RewriteQueryTransformer.builder()
            .chatClientBuilder(ChatClient.builder(chatModel))
            .build();
        
        QueryExpander queryExpander = MultiQueryExpander.builder()
            .chatClientBuilder(ChatClient.builder(chatModel))
            .numberOfQueries(3)
            .includeOriginal(true)
            .build();
        
        // 2. é…ç½®æ–‡æª”æª¢ç´¢å™¨ - å¤šéšæ®µæª¢ç´¢
        DocumentRetriever documentRetriever = VectorStoreDocumentRetriever.builder()
            .vectorStore(vectorStore)
            .similarityThreshold(0.75)
            .topK(10)
            .build();
        
        // 3. é…ç½®æŸ¥è©¢å¢å¼·å™¨ - ä¸Šä¸‹æ–‡å„ªåŒ–
        QueryAugmenter queryAugmenter = ContextualQueryAugmenter.builder()
            .allowEmptyContext(false)
            .build();
        
        // 4. æ§‹å»º Advanced RAG Advisor
        Advisor retrievalAugmentationAdvisor = RetrievalAugmentationAdvisor.builder()
            .queryTransformers(queryRewriter)
            .queryExpanders(queryExpander)
            .documentRetriever(documentRetriever)
            .queryAugmenter(queryAugmenter)
            .build();
        
        // 5. é…ç½® ChatClient
        return ChatClient.builder(chatModel)
            .defaultAdvisors(retrievalAugmentationAdvisor)
            .defaultOptions(OpenAiChatOptions.builder()
                .model("gpt-4")
                .temperature(0.3)
                .build())
            .build();
    }
    
    /**
     * Advanced RAG æŸ¥è©¢è™•ç†
     */
    public AdvancedRAGResponse processQuery(String query, Map<String, Object> context) {
        long startTime = System.currentTimeMillis();
        
        try {
            // ä½¿ç”¨ Advanced RAG ChatClient è™•ç†æŸ¥è©¢
            String response = chatClient.prompt()
                .user(query)
                .advisors(advisor -> {
                    // å‹•æ…‹è¨­ç½®éæ¿¾æ¢ä»¶
                    if (context.containsKey("filter")) {
                        advisor.param(VectorStoreDocumentRetriever.FILTER_EXPRESSION, 
                                     context.get("filter").toString());
                    }
                })
                .call()
                .content();
            
            long processingTime = System.currentTimeMillis() - startTime;
            
            return AdvancedRAGResponse.builder()
                .answer(response)
                .query(query)
                .processingTime(processingTime)
                .success(true)
                .build();
                
        } catch (Exception e) {
            log.error("Advanced RAG processing failed for query: {}", query, e);
            return AdvancedRAGResponse.builder()
                .query(query)
                .error(e.getMessage())
                .success(false)
                .processingTime(System.currentTimeMillis() - startTime)
                .build();
        }
    }
}
```

### Spring AI æŸ¥è©¢è™•ç†çµ„ä»¶å¯¦ç¾

**åŸºæ–¼ Spring AI å®˜æ–¹ QueryTransformer**ï¼š
```java
/**
 * è‡ªå®šç¾©æŸ¥è©¢é‡å¯«è½‰æ›å™¨
 * åŸºæ–¼ Spring AI RewriteQueryTransformer
 */
@Component
@RequiredArgsConstructor
@Slf4j
public class AdvancedQueryRewriter {
    
    private final ChatClient.Builder chatClientBuilder;
    
    /**
     * å‰µå»ºæŸ¥è©¢é‡å¯«è½‰æ›å™¨
     */
    public QueryTransformer createRewriteTransformer() {
        return RewriteQueryTransformer.builder()
            .chatClientBuilder(chatClientBuilder)
            .promptTemplate(createCustomRewritePrompt())
            .build();
    }
    
    /**
     * è‡ªå®šç¾©é‡å¯«æç¤ºæ¨¡æ¿
     */
    private PromptTemplate createCustomRewritePrompt() {
        return PromptTemplate.builder()
            .template("""
                ä½ æ˜¯ä¸€å€‹æŸ¥è©¢å„ªåŒ–å°ˆå®¶ã€‚è«‹å°‡ç”¨æˆ¶æŸ¥è©¢é‡å¯«ç‚ºæ›´é©åˆå‘é‡æª¢ç´¢çš„å½¢å¼ã€‚
                
                é‡å¯«è¦å‰‡ï¼š
                1. ä¿ç•™é—œéµä¿¡æ¯å’Œæ„åœ–
                2. ä½¿ç”¨æ›´ç²¾ç¢ºçš„è¡“èª
                3. ç§»é™¤å†—é¤˜è©èª
                4. å¢åŠ ç›¸é—œé—œéµè©
                
                åŸå§‹æŸ¥è©¢ï¼š{query}
                
                è«‹æä¾›é‡å¯«å¾Œçš„æŸ¥è©¢ï¼š
                """)
            .build();
    }
    
    /**
     * å‰µå»ºå£“ç¸®æŸ¥è©¢è½‰æ›å™¨
     * ç”¨æ–¼è™•ç†å¤šè¼ªå°è©±ä¸Šä¸‹æ–‡
     */
    public QueryTransformer createCompressionTransformer() {
        return CompressionQueryTransformer.builder()
            .chatClientBuilder(chatClientBuilder)
            .promptTemplate(createCustomCompressionPrompt())
            .build();
    }
    
    /**
     * è‡ªå®šç¾©å£“ç¸®æç¤ºæ¨¡æ¿
     */
    private PromptTemplate createCustomCompressionPrompt() {
        return PromptTemplate.builder()
            .template("""
                åŸºæ–¼ä»¥ä¸‹å°è©±æ­·å²ï¼Œå°‡ç”¨æˆ¶çš„å¾ŒçºŒå•é¡Œé‡å¯«ç‚ºä¸€å€‹ç¨ç«‹çš„å•é¡Œã€‚
                
                å°è©±æ­·å²ï¼š
                {history}
                
                å¾ŒçºŒå•é¡Œï¼š{query}
                
                è«‹å°‡å¾ŒçºŒå•é¡Œé‡å¯«ç‚ºåŒ…å«å¿…è¦ä¸Šä¸‹æ–‡çš„ç¨ç«‹å•é¡Œï¼š
                """)
            .build();
    }
}

/**
 * å¤šæŸ¥è©¢æ“´å±•æœå‹™
 * åŸºæ–¼ Spring AI MultiQueryExpander
 */
@Component 
@RequiredArgsConstructor
@Slf4j
public class AdvancedQueryExpander {
    
    private final ChatClient.Builder chatClientBuilder;
    
    /**
     * å‰µå»ºå¤šæŸ¥è©¢æ“´å±•å™¨
     */
    public QueryExpander createMultiQueryExpander(int numberOfQueries) {
        return MultiQueryExpander.builder()
            .chatClientBuilder(chatClientBuilder)
            .numberOfQueries(numberOfQueries)
            .includeOriginal(true)
            .promptTemplate(createCustomExpansionPrompt())
            .build();
    }
    
    /**
     * è‡ªå®šç¾©æŸ¥è©¢æ“´å±•æç¤ºæ¨¡æ¿
     */
    private PromptTemplate createCustomExpansionPrompt() {
        return PromptTemplate.builder()
            .template("""
                è«‹åŸºæ–¼ä»¥ä¸‹æŸ¥è©¢ç”Ÿæˆ {numberOfQueries} å€‹èªç¾©ç›¸ä¼¼ä½†è¡¨é”ä¸åŒçš„æŸ¥è©¢è®Šé«”ã€‚
                é€™äº›è®Šé«”æ‡‰è©²ï¼š
                1. ä¿æŒç›¸åŒçš„æŸ¥è©¢æ„åœ–
                2. ä½¿ç”¨ä¸åŒçš„è©å½™å’Œè¡¨é”æ–¹å¼
                3. å¾ä¸åŒè§’åº¦æè¿°åŒä¸€å€‹å•é¡Œ
                4. æœ‰åŠ©æ–¼æª¢ç´¢æ›´å…¨é¢çš„ç›¸é—œæ–‡æª”
                
                åŸå§‹æŸ¥è©¢ï¼š{query}
                
                è«‹æä¾›æŸ¥è©¢è®Šé«”ï¼š
                """)
            .build();
    }
    
    /**
     * å‰µå»ºèªè¨€ç¿»è­¯è½‰æ›å™¨
     * ç”¨æ–¼å¤šèªè¨€æŸ¥è©¢è™•ç†
     */
    public QueryTransformer createTranslationTransformer(String targetLanguage) {
        return TranslationQueryTransformer.builder()
            .chatClientBuilder(chatClientBuilder)
            .targetLanguage(targetLanguage)
            .promptTemplate(createCustomTranslationPrompt())
            .build();
    }
    
    /**
     * è‡ªå®šç¾©ç¿»è­¯æç¤ºæ¨¡æ¿
     */
    private PromptTemplate createCustomTranslationPrompt() {
        return PromptTemplate.builder()
            .template("""
                è«‹å°‡ä»¥ä¸‹æŸ¥è©¢ç¿»è­¯ç‚º {targetLanguage}ã€‚
                ä¿æŒæŸ¥è©¢çš„èªç¾©å’Œæ„åœ–ä¸è®Šã€‚
                å¦‚æœæŸ¥è©¢å·²ç¶“æ˜¯ç›®æ¨™èªè¨€ï¼Œè«‹ç›´æ¥è¿”å›åŸæŸ¥è©¢ã€‚
                
                æŸ¥è©¢ï¼š{query}
                
                ç¿»è­¯çµæœï¼š
                """)
            .build();
    }
}
```

### Spring AI å¤šéšæ®µæª¢ç´¢å¯¦ç¾

**åŸºæ–¼ Spring AI DocumentRetriever å’Œ DocumentJoiner**ï¼š
```java
/**
 * Advanced RAG å¤šéšæ®µæª¢ç´¢æœå‹™
 * åŸºæ–¼ Spring AI å®˜æ–¹çµ„ä»¶
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class MultiStageRetrievalService {
    
    private final VectorStore vectorStore;
    private final ChatClient.Builder chatClientBuilder;
    
    /**
     * å‰µå»ºå¤šéšæ®µæª¢ç´¢é…ç½®
     */
    public MultiStageRetrievalConfig createMultiStageConfig() {
        
        // 1. ä¸»è¦æ–‡æª”æª¢ç´¢å™¨ - è¼ƒä½é–¾å€¼ç²å–æ›´å¤šå€™é¸
        DocumentRetriever primaryRetriever = VectorStoreDocumentRetriever.builder()
            .vectorStore(vectorStore)
            .similarityThreshold(0.6)  // è¼ƒä½é–¾å€¼
            .topK(20)                  // æ›´å¤šå€™é¸
            .build();
        
        // 2. ç²¾ç¢ºæ–‡æª”æª¢ç´¢å™¨ - è¼ƒé«˜é–¾å€¼ç²å–ç²¾ç¢ºåŒ¹é…
        DocumentRetriever precisionRetriever = VectorStoreDocumentRetriever.builder()
            .vectorStore(vectorStore)
            .similarityThreshold(0.8)  // è¼ƒé«˜é–¾å€¼
            .topK(10)                  // è¼ƒå°‘ç²¾ç¢ºçµæœ
            .build();
        
        // 3. æ–‡æª”é€£æ¥å™¨ - åˆä½µå¤šå€‹æª¢ç´¢çµæœ
        DocumentJoiner documentJoiner = new ConcatenationDocumentJoiner();
        
        return new MultiStageRetrievalConfig(primaryRetriever, precisionRetriever, documentJoiner);
    }
    
    /**
     * åŸ·è¡Œå¤šéšæ®µæª¢ç´¢
     */
    public List<Document> performMultiStageRetrieval(String queryText, Map<String, Object> filters) {
        
        // 1. å‰µå»ºæŸ¥è©¢å°è±¡
        Query.Builder queryBuilder = Query.builder().text(queryText);
        
        // 2. æ·»åŠ éæ¿¾æ¢ä»¶
        if (filters != null && !filters.isEmpty()) {
            queryBuilder.context(filters);
        }
        
        Query query = queryBuilder.build();
        
        // 3. å¤šéšæ®µæª¢ç´¢é…ç½®
        MultiStageRetrievalConfig config = createMultiStageConfig();
        
        // 4. ç¬¬ä¸€éšæ®µï¼šå»£æ³›æª¢ç´¢
        List<Document> primaryResults = config.getPrimaryRetriever().retrieve(query);
        log.debug("Primary retrieval returned {} documents", primaryResults.size());
        
        // 5. ç¬¬äºŒéšæ®µï¼šç²¾ç¢ºæª¢ç´¢
        List<Document> precisionResults = config.getPrecisionRetriever().retrieve(query);
        log.debug("Precision retrieval returned {} documents", precisionResults.size());
        
        // 6. åˆä½µçµæœ
        Map<Query, List<List<Document>>> documentsForQuery = Map.of(
            query, Arrays.asList(primaryResults, precisionResults)
        );
        
        List<Document> finalResults = config.getDocumentJoiner().join(documentsForQuery);
        log.debug("Final merged results: {} documents", finalResults.size());
        
        return finalResults;
    }
    
    /**
     * å¸¶æŸ¥è©¢æ“´å±•çš„å¤šéšæ®µæª¢ç´¢
     */
    public List<Document> performExpandedMultiStageRetrieval(String queryText, int numberOfExpansions) {
        
        // 1. å‰µå»ºæŸ¥è©¢æ“´å±•å™¨
        QueryExpander queryExpander = MultiQueryExpander.builder()
            .chatClientBuilder(chatClientBuilder)
            .numberOfQueries(numberOfExpansions)
            .includeOriginal(true)
            .build();
        
        // 2. æ“´å±•æŸ¥è©¢
        List<Query> expandedQueries = queryExpander.expand(new Query(queryText));
        log.debug("Expanded to {} queries", expandedQueries.size());
        
        // 3. ç‚ºæ¯å€‹æ“´å±•æŸ¥è©¢åŸ·è¡Œæª¢ç´¢
        List<List<Document>> allResults = new ArrayList<>();
        DocumentRetriever retriever = VectorStoreDocumentRetriever.builder()
            .vectorStore(vectorStore)
            .similarityThreshold(0.7)
            .topK(15)
            .build();
        
        for (Query query : expandedQueries) {
            List<Document> results = retriever.retrieve(query);
            allResults.add(results);
        }
        
        // 4. åˆä½µæ‰€æœ‰çµæœ
        Map<Query, List<List<Document>>> documentsForQuery = new HashMap<>();
        for (int i = 0; i < expandedQueries.size(); i++) {
            documentsForQuery.put(expandedQueries.get(i), Arrays.asList(allResults.get(i)));
        }
        
        DocumentJoiner documentJoiner = new ConcatenationDocumentJoiner();
        List<Document> finalResults = documentJoiner.join(documentsForQuery);
        
        log.debug("Expanded retrieval returned {} unique documents", finalResults.size());
        
        return finalResults;
    }
}

/**
 * å¤šéšæ®µæª¢ç´¢é…ç½®é¡
 */
@Data
@AllArgsConstructor
public class MultiStageRetrievalConfig {
    private final DocumentRetriever primaryRetriever;
    private final DocumentRetriever precisionRetriever;
    private final DocumentJoiner documentJoiner;
}

/**
 * Advanced RAG å›æ‡‰æ•¸æ“šé¡
 */
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class AdvancedRAGResponse {
    private String query;
    private String answer;
    private boolean success;
    private String error;
    private long processingTime;
    private List<String> sources;
    private Map<String, Object> metadata;
}
```

---

## 8.1.3 Advanced RAG æŠ€è¡“å°æ¯”

### æŠ€è¡“ç‰¹æ€§æ¯”è¼ƒ

| æŠ€è¡“ç‰¹æ€§ | åŸºç¤ RAG | Enhanced RAG | Modular RAG | Advanced RAG |
|----------|----------|--------------|-------------|---------------|
| **æª¢ç´¢ç­–ç•¥** | å–®ä¸€å‘é‡æª¢ç´¢ | å„ªåŒ–å‘é‡æª¢ç´¢ | å¤šæ¨¡çµ„æª¢ç´¢ | æ™ºèƒ½å¤šéšæ®µæª¢ç´¢ |
| **æŸ¥è©¢è™•ç†** | ç›´æ¥æª¢ç´¢ | åŸºæœ¬é è™•ç† | æ¨¡çµ„åŒ–è™•ç† | æ™ºèƒ½ç†è§£é‡å¯« |
| **ä¸Šä¸‹æ–‡ç®¡ç†** | å›ºå®šçª—å£ | å‹•æ…‹çª—å£ | éˆæ´»ç®¡ç† | æ™ºèƒ½å„ªåŒ– |
| **çµæœå“è³ª** | â­â­ | â­â­â­ | â­â­â­â­ | â­â­â­â­â­ |
| **å¯¦ç¾è¤‡é›œåº¦** | ä½ | ä¸­ | é«˜ | å¾ˆé«˜ |
| **ç¶­è­·æˆæœ¬** | ä½ | ä¸­ | ä¸­é«˜ | é«˜ |
| **é©ç”¨å ´æ™¯** | ç°¡å–®å•ç­” | ä¸€èˆ¬æ‡‰ç”¨ | è¤‡é›œæ‡‰ç”¨ | ä¼æ¥­ç´šæ‡‰ç”¨ |

### æ€§èƒ½æŒ‡æ¨™å°æ¯”

| æ€§èƒ½æŒ‡æ¨™ | åŸºç¤ RAG | Enhanced RAG | Modular RAG | Advanced RAG |
|----------|----------|--------------|-------------|---------------|
| **æº–ç¢ºç‡** | 60-70% | 70-80% | 80-85% | 85-95% |
| **å¬å›ç‡** | 50-60% | 60-70% | 70-80% | 80-90% |
| **å›æ‡‰æ™‚é–“** | < 1s | < 2s | < 3s | < 5s |
| **è³‡æºæ¶ˆè€—** | ä½ | ä¸­ | ä¸­é«˜ | é«˜ |
| **æ“´å±•æ€§** | æœ‰é™ | ä¸­ç­‰ | è‰¯å¥½ | å„ªç§€ |

---

## 8.1.4 Advanced RAG æ‡‰ç”¨å ´æ™¯

### ä¼æ¥­çŸ¥è­˜ç®¡ç†
- **æŠ€è¡“æ–‡æª”æŸ¥è©¢**ï¼šæ™ºèƒ½ç†è§£æŠ€è¡“å•é¡Œä¸¦æä¾›ç²¾ç¢ºç­”æ¡ˆ
- **æ”¿ç­–æ³•è¦è«®è©¢**ï¼šè¤‡é›œæ³•è¦æ¢æ–‡çš„æ™ºèƒ½è§£è®€
- **æ¥­å‹™æµç¨‹æŒ‡å°**ï¼šåŸºæ–¼ä¸Šä¸‹æ–‡çš„æµç¨‹æŒ‡å°
- **å°ˆå®¶çŸ¥è­˜å‚³æ‰¿**ï¼šå°ˆæ¥­çŸ¥è­˜çš„æ™ºèƒ½åŒ–å‚³æ‰¿

### å®¢æˆ¶æœå‹™ç³»çµ±
- **æ™ºèƒ½å®¢æœ**ï¼šç†è§£å®¢æˆ¶æ„åœ–ä¸¦æä¾›å€‹æ€§åŒ–æœå‹™
- **å•é¡Œè¨ºæ–·**ï¼šåŸºæ–¼ç—‡ç‹€æè¿°çš„æ™ºèƒ½å•é¡Œè¨ºæ–·
- **è§£æ±ºæ–¹æ¡ˆæ¨è–¦**ï¼šæ ¹æ“šå•é¡Œç‰¹å¾µæ¨è–¦æœ€ä½³è§£æ±ºæ–¹æ¡ˆ
- **æœå‹™å“è³ªç›£æ§**ï¼šå¯¦æ™‚ç›£æ§æœå‹™å“è³ªä¸¦å„ªåŒ–

### æ•™è‚²åŸ¹è¨“å¹³å°
- **å€‹æ€§åŒ–å­¸ç¿’**ï¼šæ ¹æ“šå­¸ç¿’è€…æ°´å¹³æä¾›é©åˆçš„å…§å®¹
- **æ™ºèƒ½ç­”ç–‘**ï¼šç†è§£å­¸ç¿’å•é¡Œä¸¦æä¾›è©³ç´°è§£ç­”
- **çŸ¥è­˜é—œè¯**ï¼šå»ºç«‹çŸ¥è­˜é»ä¹‹é–“çš„é—œè¯é—œä¿‚
- **å­¸ç¿’è·¯å¾‘è¦åŠƒ**ï¼šæ™ºèƒ½è¦åŠƒå€‹æ€§åŒ–å­¸ç¿’è·¯å¾‘

### ç ”ç©¶èˆ‡é–‹ç™¼
- **æ–‡ç»æª¢ç´¢**ï¼šæ™ºèƒ½æª¢ç´¢ç›¸é—œç ”ç©¶æ–‡ç»
- **æŠ€è¡“èª¿ç ”**ï¼šå¿«é€Ÿäº†è§£æŠ€è¡“ç™¼å±•è¶¨å‹¢
- **å°ˆåˆ©åˆ†æ**ï¼šæ™ºèƒ½åˆ†æå°ˆåˆ©æŠ€è¡“è¦é»
- **å‰µæ–°éˆæ„Ÿ**ï¼šåŸºæ–¼çŸ¥è­˜åº«æ¿€ç™¼å‰µæ–°æ€è·¯

---

## ğŸ“ æœ¬ç« é‡é»å›é¡§

1. **Advanced RAG æ¦‚å¿µ**ï¼šç†è§£äº† Advanced RAG çš„æ ¸å¿ƒç†å¿µå’ŒæŠ€è¡“ç‰¹é»
2. **æŠ€è¡“æ¼”é€²è·¯ç·š**ï¼šæŒæ¡äº†å¾åŸºç¤ RAG åˆ° Advanced RAG çš„ç™¼å±•æ­·ç¨‹
3. **æ ¸å¿ƒæŠ€è¡“çµ„ä»¶**ï¼šäº†è§£äº†æ™ºèƒ½æŸ¥è©¢è™•ç†ã€å¤šéšæ®µæª¢ç´¢ç­‰é—œéµæŠ€è¡“
4. **æŠ€è¡“å°æ¯”åˆ†æ**ï¼šæ¯”è¼ƒäº†ä¸åŒ RAG æŠ€è¡“çš„ç‰¹æ€§å’Œé©ç”¨å ´æ™¯
5. **æ‡‰ç”¨å ´æ™¯è¦åŠƒ**ï¼šè­˜åˆ¥äº† Advanced RAG çš„å…¸å‹æ‡‰ç”¨å ´æ™¯

### æŠ€è¡“è¦é»ç¸½çµ

| æŠ€è¡“è¦é» | é‡è¦æ€§ | å¯¦ç¾é›£åº¦ | æ‡‰ç”¨åƒ¹å€¼ |
|----------|--------|----------|----------|
| **æ™ºèƒ½æŸ¥è©¢è™•ç†** | â­â­â­â­â­ | é«˜ | æ¥µé«˜ |
| **å¤šéšæ®µæª¢ç´¢** | â­â­â­â­ | é«˜ | é«˜ |
| **ä¸Šä¸‹æ–‡ç®¡ç†** | â­â­â­â­ | ä¸­ | é«˜ |
| **å“è³ªæ§åˆ¶** | â­â­â­ | ä¸­ | ä¸­é«˜ |
| **è‡ªé©æ‡‰å„ªåŒ–** | â­â­â­ | é«˜ | ä¸­é«˜ |

### å¯¦æ–½å»ºè­°

1. **æ¼¸é€²å¼å‡ç´š**ï¼šå¾åŸºç¤ RAG é€æ­¥å‡ç´šåˆ° Advanced RAG
2. **é‡é»çªç ´**ï¼šå„ªå…ˆå¯¦ç¾å°æ¥­å‹™å½±éŸ¿æœ€å¤§çš„æŠ€è¡“çµ„ä»¶
3. **æ•ˆæœé©—è­‰**ï¼šå»ºç«‹å®Œæ•´çš„æ•ˆæœè©•ä¼°é«”ç³»
4. **æŒçºŒå„ªåŒ–**ï¼šåŸºæ–¼å¯¦éš›ä½¿ç”¨æ•ˆæœæŒçºŒæ”¹é€²
5. **åœ˜éšŠåŸ¹é¤Š**ï¼šåŸ¹é¤Šå…·å‚™ Advanced RAG æŠ€è¡“èƒ½åŠ›çš„åœ˜éšŠ

### ä¸‹ä¸€æ­¥å­¸ç¿’æ–¹å‘

åœ¨ä¸‹ä¸€ç¯€ä¸­ï¼Œæˆ‘å€‘å°‡æ·±å…¥å­¸ç¿’å¦‚ä½•æé«˜ RAG æº–ç¢ºç‡ï¼ŒåŒ…æ‹¬ï¼š
- Embedding æ¨¡å‹é¸æ“‡èˆ‡å„ªåŒ–
- æ–‡æœ¬åˆ†å¡Šç­–ç•¥æ”¹é€²
- æª¢ç´¢ç­–ç•¥å„ªåŒ–
- æ•ˆæœè©•ä¼°æ–¹æ³•

---

**åƒè€ƒè³‡æ–™ï¼š**
- [Retrieval-Augmented Generation for Knowledge-Intensive NLP Tasks](https://arxiv.org/abs/2005.11401)
- [Advanced RAG Techniques](https://arxiv.org/abs/2312.10997)
- [Modular RAG: Transforming RAG Systems](https://arxiv.org/abs/2407.21059)
- [Self-RAG: Learning to Critique and Correct](https://arxiv.org/abs/2310.11511)