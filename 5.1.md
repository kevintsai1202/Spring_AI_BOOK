# 5.1 懶得打字問 AI？用提示詞範本吧

> **本章重點**：學習使用提示詞範本（Prompt Template）來標準化和優化 AI 互動，提升提示詞的品質和一致性，為個性化 ChatBot 奠定基礎。

## 🎯 學習目標

完成本章學習後，您將能夠：

- 🎯 **理解提示詞範本的重要性**：掌握「Garbage in, Garbage out」原則在 AI 中的應用
- 🎯 **使用 PromptTemplate 類別**：學會建立和使用動態提示詞範本
- 🎯 **整合 ChatClient API**：將範本與現代化的 ChatClient 流暢 API 結合
- 🎯 **建立範本庫**：設計可重複使用的提示詞範本系統
- 🎯 **優化提示詞品質**：掌握提示詞設計的最佳實踐

---

## 5.1.1 為什麼需要提示詞範本？

### Garbage in, Garbage out

![提示詞範本](https://ithelp.ithome.com.tw/upload/images/20240810/201612907PBWefpaFK.jpg)

**Garbage in, Garbage out** 也適用在 AI 領域。有些人就是不知如何問 AI，得到的解答自然也不具參考價值，這時提示詞範本就派上用場了。

### 提示詞範本的核心價值

**1. 標準化互動模式**
```
❌ 不良提示詞：
"告訴我關於 Spring Boot"

✅ 優質提示詞範本：
"作為一個資深的 Java 開發專家，請詳細說明 {topic} 的核心概念、
主要特性、使用場景，並提供一個實際的程式碼範例。
請用繁體中文回答，並確保內容適合 {experience_level} 開發者。"
```

**2. 提升回應品質**
- 🎯 **明確的角色設定**：讓 AI 扮演特定專業角色
- 📋 **結構化要求**：指定回應的格式和內容結構
- 🌍 **語言和風格**：統一回應的語言和表達風格
- 🎚️ **難度控制**：根據使用者程度調整內容深度

**3. 提高開發效率**
- 🔄 **可重複使用**：一次設計，多次使用
- 🛠️ **參數化設計**：透過變數動態調整內容
- 📚 **範本庫管理**：建立企業級提示詞資產
- 🚀 **快速部署**：減少重複的提示詞設計工作

---

## 5.1.2 PromptTemplate 基礎使用

### 基本範本語法

```java
package com.example.service;

import org.springframework.ai.chat.prompt.Prompt;
import org.springframework.ai.chat.prompt.PromptTemplate;
import org.springframework.stereotype.Service;

import java.util.Map;

@Service
public class PromptTemplateService {
    
    /**
     * 基本範本使用範例
     */
    public Prompt createBasicPrompt(String topic, String level) {
        // 定義範本字串，使用 {變數名} 作為佔位符
        String template = """
            作為一個資深的技術專家，請詳細說明 {topic} 的相關知識。
            
            請包含以下內容：
            1. 核心概念和定義
            2. 主要特性和優勢
            3. 實際應用場景
            4. 簡單的程式碼範例
            
            目標受眾：{level} 開發者
            回答語言：繁體中文
            回答風格：專業且易懂
            """;
        
        // 建立 PromptTemplate 實例
        PromptTemplate promptTemplate = new PromptTemplate(template);
        
        // 提供變數值
        Map<String, Object> variables = Map.of(
            "topic", topic,
            "level", level
        );
        
        // 生成最終的 Prompt
        return promptTemplate.create(variables);
    }
}
```

### 與 ChatClient 整合

```java
package com.example.controller;

import com.example.service.PromptTemplateService;
import lombok.RequiredArgsConstructor;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.prompt.Prompt;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/template")
@RequiredArgsConstructor
public class TemplateController {
    
    private final ChatClient chatClient;
    private final PromptTemplateService promptTemplateService;
    
    /**
     * 使用範本進行 AI 對話
     * @param topic 主題
     * @param level 程度（初級/中級/高級）
     * @return AI 回應
     */
    @GetMapping("/explain")
    public String explainTopic(
            @RequestParam String topic,
            @RequestParam(defaultValue = "中級") String level) {
        
        // 使用範本服務建立 Prompt
        Prompt prompt = promptTemplateService.createBasicPrompt(topic, level);
        
        // 使用 ChatClient 執行對話
        return chatClient.prompt(prompt)
                .call()
                .content();
    }
    
    /**
     * 簡化的範本使用方式
     * @param framework 框架名稱
     * @return AI 回應
     */
    @GetMapping("/framework")
    public String explainFramework(@RequestParam String framework) {
        return chatClient.prompt("請問 {framework} 目前有哪些版本，各有什麼特殊能力和改進？")
                .user(Map.of("framework", framework))
                .call()
                .content();
    }
}
```

---

## 5.1.3 進階範本設計

### 多參數範本

```java
@Service
public class AdvancedPromptService {
    
    /**
     * 程式碼生成範本
     */
    public Prompt createCodeGenerationPrompt(String language, String functionality) {
        String template = """
            你是 {language} 開發專家。
            
            請生成 {functionality} 的程式碼：
            1. 完整程式碼實現
            2. 簡單使用說明
            """;
        
        PromptTemplate promptTemplate = new PromptTemplate(template);
        return promptTemplate.create(Map.of(
            "language", language,
            "functionality", functionality
        ));
    }
    
    /**
     * 錯誤診斷範本
     */
    public Prompt createDiagnosisPrompt(String technology, String errorMessage) {
        String template = """
            你是 {technology} 專家，請分析錯誤：
            
            錯誤訊息：{errorMessage}
            
            請提供：
            1. 錯誤原因
            2. 解決方法
            """;
        
        PromptTemplate promptTemplate = new PromptTemplate(template);
        return promptTemplate.create(Map.of(
            "technology", technology,
            "errorMessage", errorMessage
        ));
    }
}
```

### 條件式範本

```java
@Service
public class ConditionalPromptService {
    
    public Prompt createUserSpecificPrompt(String topic, String level) {
        String template = switch (level) {
            case "初級" -> """
                你是耐心的導師。請用簡單語言說明 {topic}：
                1. 基本概念
                2. 為什麼重要
                3. 學習建議
                """;
            case "中級" -> """
                你是技術專家。請說明 {topic}：
                1. 核心原理
                2. 應用場景
                3. 程式碼範例
                """;
            default -> """
                你是資深架構師。請深度分析 {topic}：
                1. 實現原理
                2. 架構設計
                3. 最佳實踐
                """;
        };
        
        return new PromptTemplate(template).create(Map.of("topic", topic));
    }
}
```

---

## 5.1.4 範本庫管理系統

### 範本配置類

```java
package com.example.config;

import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

import java.util.Map;

@Data
@Component
@ConfigurationProperties(prefix = "app.prompt.templates")
public class PromptTemplateConfig {
    
    /**
     * 預定義範本庫
     */
    private Map<String, String> library = Map.of(
        "explain", """
            作為一個 {role} 專家，請詳細說明 {topic}。
            
            請包含：
            1. 核心概念
            2. 主要特性
            3. 使用場景
            4. 實際範例
            
            目標受眾：{audience}
            回答語言：{language}
            """,
            
        "code-review", """
            你是一個資深的 {language} 程式碼審查專家。
            
            請審查以下程式碼：
            ```{language}
            {code}
            ```
            
            請提供：
            1. 程式碼品質評估
            2. 潛在問題識別
            3. 改進建議
            4. 最佳實踐建議
            
            請用 {language} 回答。
            """,
            
        "troubleshoot", """
            你是一個 {technology} 故障排除專家。
            
            **問題描述**：{problem}
            **錯誤訊息**：{error}
            **環境資訊**：{environment}
            
            請提供：
            ## 🔍 問題診斷
            ## 🛠️ 解決步驟
            ## 🚀 預防措施
            
            請提供具體可執行的解決方案。
            """
    );
    
    /**
     * 預設參數值
     */
    private Map<String, String> defaults = Map.of(
        "language", "繁體中文",
        "role", "技術專家",
        "audience", "中級開發者"
    );
}
```

### 範本管理服務

```java
package com.example.service;

import com.example.config.PromptTemplateConfig;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.prompt.Prompt;
import org.springframework.ai.chat.prompt.PromptTemplate;
import org.springframework.stereotype.Service;

import java.util.HashMap;
import java.util.Map;

@Service
@RequiredArgsConstructor
@Slf4j
public class PromptTemplateManager {
    
    private final PromptTemplateConfig config;
    
    /**
     * 根據範本名稱建立 Prompt
     * @param templateName 範本名稱
     * @param variables 變數值
     * @return 建立的 Prompt
     */
    public Prompt createPrompt(String templateName, Map<String, Object> variables) {
        String template = config.getLibrary().get(templateName);
        if (template == null) {
            throw new IllegalArgumentException("範本不存在: " + templateName);
        }
        
        // 合併預設值和使用者提供的變數
        Map<String, Object> mergedVariables = new HashMap<>(config.getDefaults());
        mergedVariables.putAll(variables);
        
        log.debug("使用範本 '{}' 建立 Prompt，變數：{}", templateName, mergedVariables);
        
        PromptTemplate promptTemplate = new PromptTemplate(template);
        return promptTemplate.create(mergedVariables);
    }
    
    /**
     * 動態註冊新範本
     * @param name 範本名稱
     * @param template 範本內容
     */
    public void registerTemplate(String name, String template) {
        config.getLibrary().put(name, template);
        log.info("註冊新範本：{}", name);
    }
    
    /**
     * 獲取所有可用範本名稱
     * @return 範本名稱列表
     */
    public Set<String> getAvailableTemplates() {
        return config.getLibrary().keySet();
    }
    
    /**
     * 驗證範本語法
     * @param template 範本內容
     * @param variables 測試變數
     * @return 是否有效
     */
    public boolean validateTemplate(String template, Map<String, Object> variables) {
        try {
            PromptTemplate promptTemplate = new PromptTemplate(template);
            promptTemplate.create(variables);
            return true;
        } catch (Exception e) {
            log.warn("範本驗證失敗：{}", e.getMessage());
            return false;
        }
    }
}
```

---

## 5.1.5 實際應用範例

### 智能客服範本系統

```java
package com.example.controller;

import com.example.service.PromptTemplateManager;
import lombok.RequiredArgsConstructor;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.prompt.Prompt;
import org.springframework.web.bind.annotation.*;

import java.util.Map;

@RestController
@RequestMapping("/api/customer-service")
@RequiredArgsConstructor
public class CustomerServiceController {
    
    private final ChatClient chatClient;
    private final PromptTemplateManager templateManager;
    
    /**
     * 技術支援
     * @param product 產品名稱
     * @param issue 問題描述
     * @param severity 嚴重程度
     * @return 支援回應
     */
    @PostMapping("/technical-support")
    public String technicalSupport(
            @RequestParam String product,
            @RequestParam String issue,
            @RequestParam(defaultValue = "medium") String severity) {
        
        // 註冊技術支援範本（如果尚未存在）
        String supportTemplate = """
            你是 {product} 的資深技術支援專家。
            
            **客戶問題**：{issue}
            **嚴重程度**：{severity}
            
            請提供專業的技術支援回應：
            
            ## 🔍 問題理解
            重述並確認問題的核心
            
            ## 🛠️ 解決方案
            提供具體的解決步驟
            
            ## 📋 後續追蹤
            建議的後續行動
            
            請保持專業、友善的語調，用繁體中文回答。
            """;
        
        templateManager.registerTemplate("technical-support", supportTemplate);
        
        // 建立 Prompt
        Prompt prompt = templateManager.createPrompt("technical-support", Map.of(
            "product", product,
            "issue", issue,
            "severity", severity
        ));
        
        return chatClient.prompt(prompt)
                .call()
                .content();
    }
    
    /**
     * 產品諮詢
     * @param category 產品類別
     * @param budget 預算範圍
     * @param requirements 需求描述
     * @return 諮詢回應
     */
    @PostMapping("/product-consultation")
    public String productConsultation(
            @RequestParam String category,
            @RequestParam String budget,
            @RequestParam String requirements) {
        
        String consultationTemplate = """
            你是一個專業的 {category} 產品顧問。
            
            **客戶需求**：{requirements}
            **預算範圍**：{budget}
            
            請提供個人化的產品建議：
            
            ## 🎯 需求分析
            分析客戶的核心需求
            
            ## 💡 產品推薦
            推薦最適合的產品方案
            
            ## 💰 價值說明
            說明推薦產品的價值和優勢
            
            ## 📞 下一步行動
            建議客戶的下一步行動
            
            請用專業且親切的語調回答。
            """;
        
        templateManager.registerTemplate("product-consultation", consultationTemplate);
        
        Prompt prompt = templateManager.createPrompt("product-consultation", Map.of(
            "category", category,
            "budget", budget,
            "requirements", requirements
        ));
        
        return chatClient.prompt(prompt)
                .call()
                .content();
    }
}
```

### 教育訓練範本系統

```java
@RestController
@RequestMapping("/api/education")
@RequiredArgsConstructor
public class EducationController {
    
    private final ChatClient chatClient;
    private final PromptTemplateManager templateManager;
    
    /**
     * 課程內容生成
     * @param subject 科目
     * @param level 程度
     * @param duration 時長（分鐘）
     * @return 課程內容
     */
    @PostMapping("/generate-lesson")
    public String generateLesson(
            @RequestParam String subject,
            @RequestParam String level,
            @RequestParam int duration) {
        
        String lessonTemplate = """
            你是一個經驗豐富的 {subject} 教師。
            
            請為 {level} 學生設計一堂 {duration} 分鐘的課程：
            
            ## 📚 課程目標
            明確的學習目標（3-5個）
            
            ## 🕐 課程大綱
            詳細的時間分配和內容安排
            
            ## 💡 教學活動
            互動式的教學活動設計
            
            ## 📝 評量方式
            檢驗學習成效的方法
            
            ## 🏠 課後作業
            鞏固學習的練習題目
            
            請確保內容適合目標學生程度，並具有實用性。
            """;
        
        templateManager.registerTemplate("lesson-plan", lessonTemplate);
        
        Prompt prompt = templateManager.createPrompt("lesson-plan", Map.of(
            "subject", subject,
            "level", level,
            "duration", String.valueOf(duration)
        ));
        
        return chatClient.prompt(prompt)
                .call()
                .content();
    }
}
```

---

## 5.1.6 範本設計最佳實踐

### 設計原則

**1. 清晰的角色定義**
```java
// ✅ 好的範本
String template = """
    你是一個擁有10年經驗的 Spring Boot 架構師，
    專精於微服務架構設計和效能優化。
    
    請針對 {question} 提供專業建議...
    """;

// ❌ 不好的範本
String template = "請回答 {question}";
```

**2. 結構化輸出格式**
```java
String template = """
    請按照以下格式回答：
    
    ## 🎯 核心概念
    [簡潔的概念說明]
    
    ## 🔧 實作方法
    [具體的實作步驟]
    
    ## 💡 最佳實踐
    [相關的最佳實踐建議]
    
    ## ⚠️ 注意事項
    [重要的注意事項]
    """;
```

**3. 參數驗證和預設值**
```java
@Service
public class ValidatedPromptService {
    
    public Prompt createValidatedPrompt(String template, Map<String, Object> variables) {
        // 驗證必要參數
        validateRequiredParameters(template, variables);
        
        // 設定預設值
        Map<String, Object> mergedVariables = applyDefaults(variables);
        
        // 清理和格式化參數
        Map<String, Object> cleanedVariables = cleanParameters(mergedVariables);
        
        PromptTemplate promptTemplate = new PromptTemplate(template);
        return promptTemplate.create(cleanedVariables);
    }
    
    private void validateRequiredParameters(String template, Map<String, Object> variables) {
        // 提取範本中的所有變數
        Set<String> templateVariables = extractTemplateVariables(template);
        
        // 檢查必要參數是否存在
        for (String var : templateVariables) {
            if (!variables.containsKey(var) || variables.get(var) == null) {
                throw new IllegalArgumentException("缺少必要參數: " + var);
            }
        }
    }
    
    private Map<String, Object> applyDefaults(Map<String, Object> variables) {
        Map<String, Object> result = new HashMap<>(variables);
        
        // 設定預設值
        result.putIfAbsent("language", "繁體中文");
        result.putIfAbsent("style", "專業且友善");
        result.putIfAbsent("format", "結構化");
        
        return result;
    }
    
    private Map<String, Object> cleanParameters(Map<String, Object> variables) {
        return variables.entrySet().stream()
            .collect(Collectors.toMap(
                Map.Entry::getKey,
                entry -> cleanParameterValue(entry.getValue())
            ));
    }
    
    private Object cleanParameterValue(Object value) {
        if (value instanceof String str) {
            // 清理字串：移除多餘空白、特殊字元等
            return str.trim().replaceAll("\\s+", " ");
        }
        return value;
    }
}
```

### 效能優化

```java
@Service
@Slf4j
public class OptimizedPromptService {
    
    // 快取編譯後的範本
    private final Map<String, PromptTemplate> templateCache = new ConcurrentHashMap<>();
    
    /**
     * 快取範本以提升效能
     */
    public Prompt createCachedPrompt(String templateKey, String templateContent, Map<String, Object> variables) {
        PromptTemplate template = templateCache.computeIfAbsent(templateKey, key -> {
            log.debug("編譯並快取範本：{}", key);
            return new PromptTemplate(templateContent);
        });
        
        return template.create(variables);
    }
    
    /**
     * 批次處理多個範本
     */
    public List<Prompt> createBatchPrompts(String templateContent, List<Map<String, Object>> variablesList) {
        PromptTemplate template = new PromptTemplate(templateContent);
        
        return variablesList.parallelStream()
            .map(template::create)
            .collect(Collectors.toList());
    }
    
    /**
     * 清理快取
     */
    @EventListener
    public void clearCache() {
        templateCache.clear();
        log.info("範本快取已清理");
    }
}
```

---

## 📝 本章重點回顧

1. **提示詞範本的價值**：理解了「Garbage in, Garbage out」原則和範本的重要性
2. **PromptTemplate 使用**：掌握了基本和進階的範本建立方法
3. **ChatClient 整合**：學會了將範本與現代化的 ChatClient API 結合
4. **範本庫管理**：建立了企業級的範本管理系統
5. **最佳實踐**：掌握了範本設計、驗證和優化的最佳實踐

### 關鍵技術要點

| 技術點 | 重要性 | 實現難度 | 使用場景 |
|--------|--------|----------|----------|
| **基礎範本** | ⭐⭐⭐ | 低 | 所有 AI 應用 |
| **參數化設計** | ⭐⭐⭐ | 中 | 動態內容生成 |
| **範本庫管理** | ⭐⭐ | 中 | 企業級應用 |
| **條件式範本** | ⭐⭐ | 高 | 複雜業務邏輯 |
| **效能優化** | ⭐ | 中 | 高併發場景 |

### 下一步學習方向

在下一章中，我們將學習如何處理多模態資料，讓 AI 不僅能理解文字，還能處理圖片、音訊等多種媒體格式，進一步提升 ChatBot 的智能化程度。

---

**參考資料：**
- [Spring AI Prompt Template Documentation](https://docs.spring.io/spring-ai/reference/api/prompt.html)
- [ChatClient API Reference](https://docs.spring.io/spring-ai/reference/api/chatclient.html)
- [Prompt Engineering Best Practices](https://platform.openai.com/docs/guides/prompt-engineering)