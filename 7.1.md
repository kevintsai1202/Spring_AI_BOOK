# 7.1 RAG æµç¨‹è©³è§£

> **æœ¬ç« é‡é»**ï¼šæ·±å…¥ç†è§£ RAGï¼ˆRetrieval-Augmented Generationï¼‰çš„å®Œæ•´å·¥ä½œæµç¨‹ï¼ŒæŒæ¡ä¼æ¥­ç´š RAG ç³»çµ±çš„è¨­è¨ˆåŸç†å’Œå¯¦ç¾æ–¹æ³•ã€‚

## ğŸ¯ å­¸ç¿’ç›®æ¨™

å®Œæˆæœ¬ç« å­¸ç¿’å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š

- ğŸ¯ **ç†è§£ RAG æ ¸å¿ƒæ¦‚å¿µ**ï¼šæŒæ¡æª¢ç´¢å¢å¼·ç”Ÿæˆçš„åŸºæœ¬åŸç†å’Œæ‡‰ç”¨å ´æ™¯
- ğŸ¯ **æŒæ¡ RAG å®Œæ•´æµç¨‹**ï¼šäº†è§£å¾æ–‡æª”è™•ç†åˆ°ç­”æ¡ˆç”Ÿæˆçš„æ¯å€‹æ­¥é©Ÿ
- ğŸ¯ **è¨­è¨ˆ RAG ç³»çµ±æ¶æ§‹**ï¼šå­¸æœƒè¨­è¨ˆå¯æ“´å±•çš„ä¼æ¥­ç´š RAG è§£æ±ºæ–¹æ¡ˆ
- ğŸ¯ **å¯¦ç¾åŸºç¤ RAG åŠŸèƒ½**ï¼šä½¿ç”¨ Spring AI å»ºç«‹ç¬¬ä¸€å€‹ RAG æ‡‰ç”¨
- ğŸ¯ **å„ªåŒ– RAG æ•ˆèƒ½**ï¼šæŒæ¡ RAG ç³»çµ±çš„æ•ˆèƒ½èª¿æ ¡å’Œæœ€ä½³å¯¦è¸

---

## 7.1.1 ä»€éº¼æ˜¯ RAGï¼Ÿ

### RAG çš„å®šç¾©èˆ‡åƒ¹å€¼

**RAGï¼ˆRetrieval-Augmented Generationï¼‰** æ˜¯ä¸€ç¨®çµåˆäº†è³‡è¨Šæª¢ç´¢å’Œæ–‡æœ¬ç”Ÿæˆçš„ AI æŠ€è¡“ï¼Œå®ƒèƒ½å¤ è®“å¤§å‹èªè¨€æ¨¡å‹ï¼ˆLLMï¼‰åŸºæ–¼å¤–éƒ¨çŸ¥è­˜åº«ä¾†ç”Ÿæˆæ›´æº–ç¢ºã€æ›´å…·æ™‚æ•ˆæ€§çš„å›ç­”ã€‚

**æ ¸å¿ƒåƒ¹å€¼**ï¼š
- ğŸ“š **çŸ¥è­˜æ“´å±•**ï¼šçªç ´ LLM è¨“ç·´è³‡æ–™çš„æ™‚é–“é™åˆ¶
- ğŸ¯ **æº–ç¢ºæ€§æå‡**ï¼šåŸºæ–¼å¯é çš„å¤–éƒ¨è³‡æ–™æºç”Ÿæˆç­”æ¡ˆ
- ğŸ”„ **å³æ™‚æ›´æ–°**ï¼šçŸ¥è­˜åº«å¯ä»¥å³æ™‚æ›´æ–°ï¼Œç„¡éœ€é‡æ–°è¨“ç·´æ¨¡å‹
- ğŸ’° **æˆæœ¬æ•ˆç›Š**ï¼šé¿å…é‡æ–°è¨“ç·´å¤§å‹æ¨¡å‹çš„é«˜æ˜‚æˆæœ¬
- ğŸ” **å¯è¿½æº¯æ€§**ï¼šç­”æ¡ˆä¾†æºå¯è¿½æº¯ï¼Œæé«˜å¯ä¿¡åº¦

### RAG vs å‚³çµ± LLM

| ç‰¹æ€§ | å‚³çµ± LLM | RAG ç³»çµ± |
|------|----------|----------|
| **çŸ¥è­˜ä¾†æº** | è¨“ç·´è³‡æ–™ | å¤–éƒ¨çŸ¥è­˜åº« + è¨“ç·´è³‡æ–™ |
| **çŸ¥è­˜æ›´æ–°** | éœ€è¦é‡æ–°è¨“ç·´ | å³æ™‚æ›´æ–°çŸ¥è­˜åº« |
| **æº–ç¢ºæ€§** | ä¾è³´è¨“ç·´è³‡æ–™ | åŸºæ–¼æœ€æ–°ã€å¯é è³‡æ–™ |
| **å¯è¿½æº¯æ€§** | ç„¡æ³•è¿½æº¯ | å¯è¿½æº¯åˆ°å…·é«”æ–‡æª” |
| **å°ˆæ¥­é ˜åŸŸ** | æ³›åŒ–èƒ½åŠ›å¼· | å°ˆæ¥­çŸ¥è­˜æ›´æº–ç¢º |
| **æˆæœ¬** | è¨“ç·´æˆæœ¬é«˜ | ç¶­è­·æˆæœ¬ä½ |

### RAG çš„æ‡‰ç”¨å ´æ™¯

**1. ä¼æ¥­çŸ¥è­˜ç®¡ç†**
```
å ´æ™¯ï¼šå“¡å·¥è©¢å•å…¬å¸æ”¿ç­–ã€æµç¨‹ã€ç”¢å“è³‡è¨Š
å„ªå‹¢ï¼š
- åŸºæ–¼æœ€æ–°çš„å…§éƒ¨æ–‡æª”
- ç¢ºä¿è³‡è¨Šçš„æº–ç¢ºæ€§å’Œä¸€è‡´æ€§
- æ¸›å°‘äººå·¥å®¢æœè² æ“”
```

**2. æŠ€è¡“æ–‡æª”åŠ©æ‰‹**
```
å ´æ™¯ï¼šé–‹ç™¼è€…æŸ¥è©¢ API æ–‡æª”ã€æŠ€è¡“è¦ç¯„
å„ªå‹¢ï¼š
- å³æ™‚åæ˜ æ–‡æª”æ›´æ–°
- æä¾›ç²¾ç¢ºçš„æŠ€è¡“è³‡è¨Š
- æ”¯æ´å¤šç‰ˆæœ¬æ–‡æª”æŸ¥è©¢
```

**3. å®¢æˆ¶æœå‹™ç³»çµ±**
```
å ´æ™¯ï¼šå®¢æˆ¶è©¢å•ç”¢å“åŠŸèƒ½ã€æ•…éšœæ’é™¤
å„ªå‹¢ï¼š
- åŸºæ–¼ç”¢å“æ‰‹å†Šå’Œ FAQ
- æä¾›å€‹æ€§åŒ–è§£æ±ºæ–¹æ¡ˆ
- 24/7 ä¸é–“æ–·æœå‹™
```

**4. æ³•å¾‹å’Œåˆè¦è«®è©¢**
```
å ´æ™¯ï¼šæŸ¥è©¢æ³•è¦æ¢æ–‡ã€åˆè¦è¦æ±‚
å„ªå‹¢ï¼š
- åŸºæ–¼æœ€æ–°æ³•è¦è³‡æ–™
- ç¢ºä¿åˆè¦æ€§å’Œæº–ç¢ºæ€§
- é™ä½æ³•å¾‹é¢¨éšª
```

---

## 7.1.2 RAG ç³»çµ±æ¶æ§‹æ¦‚è¦½

### å®Œæ•´çš„ RAG ç³»çµ±æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RAG System Architecture                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  User Interface Layer                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚   Web UI        â”‚    â”‚   Mobile App    â”‚               â”‚
â”‚  â”‚   Chat Bot      â”‚    â”‚   API Client    â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Application Layer                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              RAG Orchestration Engine                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Query Processing                             â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Retrieval Coordination                       â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Response Generation                          â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Result Ranking & Filtering                   â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Retrieval Layer                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚Vector Store â”‚ â”‚Search Engineâ”‚ â”‚Knowledge    â”‚          â”‚
â”‚  â”‚â€¢ Embeddings â”‚ â”‚â€¢ Full-text  â”‚ â”‚Graph        â”‚          â”‚
â”‚  â”‚â€¢ Similarity â”‚ â”‚â€¢ Keywords   â”‚ â”‚â€¢ Relations  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Data Processing Layer                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                ETL Pipeline                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚  Extract â†’ Transform â†’ Load                     â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Document Parsing                             â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Text Chunking                                â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Embedding Generation                         â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ Metadata Enrichment                          â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Data Sources Layer                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚Documents    â”‚ â”‚Databases    â”‚ â”‚APIs         â”‚          â”‚
â”‚  â”‚â€¢ PDF        â”‚ â”‚â€¢ SQL        â”‚ â”‚â€¢ REST       â”‚          â”‚
â”‚  â”‚â€¢ Word       â”‚ â”‚â€¢ NoSQL      â”‚ â”‚â€¢ GraphQL    â”‚          â”‚
â”‚  â”‚â€¢ Web Pages  â”‚ â”‚â€¢ Vector DB  â”‚ â”‚â€¢ External   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒçµ„ä»¶èªªæ˜

**1. è³‡æ–™ä¾†æºå±¤ï¼ˆData Sources Layerï¼‰**
- ğŸ“„ **æ–‡æª”è³‡æ–™**ï¼šPDFã€Wordã€Excelã€PowerPoint ç­‰
- ğŸ—„ï¸ **è³‡æ–™åº«**ï¼šé—œè¯å¼è³‡æ–™åº«ã€NoSQLã€å‘é‡è³‡æ–™åº«
- ğŸŒ **API ä»‹é¢**ï¼šREST APIã€GraphQLã€ç¬¬ä¸‰æ–¹æœå‹™
- ğŸ“Š **çµæ§‹åŒ–è³‡æ–™**ï¼šCSVã€JSONã€XML ç­‰æ ¼å¼

**2. è³‡æ–™è™•ç†å±¤ï¼ˆData Processing Layerï¼‰**
- ğŸ”„ **ETL ç®¡é“**ï¼šæå–ã€è½‰æ›ã€è¼‰å…¥è³‡æ–™
- âœ‚ï¸ **æ–‡æœ¬åˆ†å¡Š**ï¼šå°‡é•·æ–‡æª”åˆ‡åˆ†ç‚ºé©ç•¶å¤§å°çš„ç‰‡æ®µ
- ğŸ§® **å‘é‡åŒ–**ï¼šå°‡æ–‡æœ¬è½‰æ›ç‚ºæ•¸å€¼å‘é‡
- ğŸ·ï¸ **å…ƒè³‡æ–™å¢å¼·**ï¼šæ·»åŠ åˆ†é¡ã€æ¨™ç±¤ã€æ™‚é–“æˆ³ç­‰è³‡è¨Š

**3. æª¢ç´¢å±¤ï¼ˆRetrieval Layerï¼‰**
- ğŸ” **å‘é‡å­˜å„²**ï¼šåŸºæ–¼èªç¾©ç›¸ä¼¼æ€§çš„æª¢ç´¢
- ğŸ“ **å…¨æ–‡æœå°‹**ï¼šåŸºæ–¼é—œéµå­—çš„å‚³çµ±æœå°‹
- ğŸ•¸ï¸ **çŸ¥è­˜åœ–è­œ**ï¼šåŸºæ–¼å¯¦é«”é—œä¿‚çš„æª¢ç´¢

**4. æ‡‰ç”¨å±¤ï¼ˆApplication Layerï¼‰**
- ğŸ¯ **æŸ¥è©¢è™•ç†**ï¼šç†è§£å’Œé è™•ç†ç”¨æˆ¶æŸ¥è©¢
- ğŸ”— **æª¢ç´¢å”èª¿**ï¼šå”èª¿å¤šå€‹æª¢ç´¢æºçš„çµæœ
- ğŸ“ **å›æ‡‰ç”Ÿæˆ**ï¼šåŸºæ–¼æª¢ç´¢çµæœç”Ÿæˆæœ€çµ‚ç­”æ¡ˆ
- ğŸ“Š **çµæœæ’åº**ï¼šå°æª¢ç´¢çµæœé€²è¡Œæ’åºå’Œéæ¿¾

---

## 7.1.3 RAG å·¥ä½œæµç¨‹è©³è§£

### å®Œæ•´çš„ RAG å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RAG Workflow Process                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Phase 1: Data Preparation (Offline)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. Document Collection                                 â”‚ â”‚
â”‚  â”‚     â†“                                                   â”‚ â”‚
â”‚  â”‚  2. Document Parsing & Cleaning                         â”‚ â”‚
â”‚  â”‚     â†“                                                   â”‚ â”‚
â”‚  â”‚  3. Text Chunking & Segmentation                        â”‚ â”‚
â”‚  â”‚     â†“                                                   â”‚ â”‚
â”‚  â”‚  4. Embedding Generation                                â”‚ â”‚
â”‚  â”‚     â†“                                                   â”‚ â”‚
â”‚  â”‚  5. Vector Storage & Indexing                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Phase 2: Query Processing (Online)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. User Query Input                                    â”‚ â”‚
â”‚  â”‚     â†“                                                   â”‚ â”‚
â”‚  â”‚  2. Query Understanding & Enhancement                   â”‚ â”‚
â”‚  â”‚     â†“                                                   â”‚ â”‚
â”‚  â”‚  3. Query Embedding Generation                          â”‚ â”‚
â”‚  â”‚     â†“                                                   â”‚ â”‚
â”‚  â”‚  4. Similarity Search & Retrieval                       â”‚ â”‚
â”‚  â”‚     â†“                                                   â”‚ â”‚
â”‚  â”‚  5. Context Assembly & Ranking                          â”‚ â”‚
â”‚  â”‚     â†“                                                   â”‚ â”‚
â”‚  â”‚  6. LLM Generation with Context                         â”‚ â”‚
â”‚  â”‚     â†“                                                   â”‚ â”‚
â”‚  â”‚  7. Response Post-processing                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### éšæ®µä¸€ï¼šè³‡æ–™æº–å‚™ï¼ˆé›¢ç·šè™•ç†ï¼‰

**æ­¥é©Ÿ 1ï¼šæ–‡æª”æ”¶é›†**
```java
/**
 * æ–‡æª”æ”¶é›†æœå‹™
 */
@Service
public class DocumentCollectionService {
    
    public List<Document> collectDocuments(List<String> sources) {
        List<Document> documents = new ArrayList<>();
        
        for (String source : sources) {
            if (source.endsWith(".pdf")) {
                documents.addAll(loadPdfDocuments(source));
            } else if (source.startsWith("http")) {
                documents.addAll(loadWebDocuments(source));
            } else if (source.contains("database")) {
                documents.addAll(loadDatabaseDocuments(source));
            }
        }
        
        return documents;
    }
}
```

**æ­¥é©Ÿ 2ï¼šæ–‡æª”è§£æèˆ‡æ¸…ç†**
```java
/**
 * æ–‡æª”è™•ç†æœå‹™
 */
@Service
public class DocumentProcessingService {
    
    public Document processDocument(Document rawDocument) {
        // 1. æå–ç´”æ–‡æœ¬
        String cleanText = extractText(rawDocument);
        
        // 2. æ¸…ç†å’Œæ¨™æº–åŒ–
        cleanText = cleanAndNormalize(cleanText);
        
        // 3. æå–å…ƒè³‡æ–™
        Map<String, Object> metadata = extractMetadata(rawDocument);
        
        return new Document(cleanText, metadata);
    }
    
    private String cleanAndNormalize(String text) {
        return text
            .replaceAll("\\s+", " ")  // æ¨™æº–åŒ–ç©ºç™½å­—ç¬¦
            .replaceAll("[^\\p{L}\\p{N}\\p{P}\\p{Z}]", "")  // ç§»é™¤ç‰¹æ®Šå­—ç¬¦
            .trim();
    }
}
```

**æ­¥é©Ÿ 3ï¼šæ–‡æœ¬åˆ†å¡Š**
```java
/**
 * æ–‡æœ¬åˆ†å¡Šæœå‹™
 */
@Service
public class TextChunkingService {
    
    private static final int DEFAULT_CHUNK_SIZE = 1000;
    private static final int DEFAULT_OVERLAP = 200;
    
    public List<Document> chunkDocument(Document document) {
        String text = document.getContent();
        List<Document> chunks = new ArrayList<>();
        
        int start = 0;
        int chunkIndex = 0;
        
        while (start < text.length()) {
            int end = Math.min(start + DEFAULT_CHUNK_SIZE, text.length());
            
            // å°‹æ‰¾é©ç•¶çš„åˆ†å‰²é»ï¼ˆå¥è™Ÿã€æ®µè½ç­‰ï¼‰
            if (end < text.length()) {
                end = findBestSplitPoint(text, start, end);
            }
            
            String chunkText = text.substring(start, end);
            
            // å»ºç«‹åˆ†å¡Šæ–‡æª”
            Map<String, Object> chunkMetadata = new HashMap<>(document.getMetadata());
            chunkMetadata.put("chunk_index", chunkIndex);
            chunkMetadata.put("chunk_start", start);
            chunkMetadata.put("chunk_end", end);
            
            chunks.add(new Document(chunkText, chunkMetadata));
            
            start = end - DEFAULT_OVERLAP;  // é‡ç–Šè™•ç†
            chunkIndex++;
        }
        
        return chunks;
    }
}
```

**æ­¥é©Ÿ 4ï¼šå‘é‡åŒ–è™•ç†**
```java
/**
 * å‘é‡åŒ–æœå‹™
 */
@Service
public class EmbeddingService {
    
    private final EmbeddingModel embeddingModel;
    
    public List<Document> generateEmbeddings(List<Document> documents) {
        List<Document> embeddedDocuments = new ArrayList<>();
        
        // æ‰¹æ¬¡è™•ç†ä»¥æé«˜æ•ˆç‡
        List<List<Document>> batches = createBatches(documents, 100);
        
        for (List<Document> batch : batches) {
            List<String> texts = batch.stream()
                .map(Document::getContent)
                .collect(Collectors.toList());
            
            // ç”ŸæˆåµŒå…¥å‘é‡
            EmbeddingResponse embeddingResponse = embeddingModel.embedForResponse(texts);
            List<List<Double>> embeddings = embeddingResponse.getResults().stream()
                .map(result -> result.getOutput())
                .collect(Collectors.toList());
            
            // å°‡å‘é‡æ·»åŠ åˆ°æ–‡æª”ä¸­
            for (int i = 0; i < batch.size(); i++) {
                Document doc = batch.get(i);
                // Spring AI æœƒè‡ªå‹•è™•ç†åµŒå…¥å‘é‡ï¼Œä¸éœ€è¦æ‰‹å‹•è¨­ç½®
                embeddedDocuments.add(doc);
            }
        }
        
        return embeddedDocuments;
    }
}
```

### éšæ®µäºŒï¼šæŸ¥è©¢è™•ç†ï¼ˆç·šä¸Šè™•ç†ï¼‰

**æ­¥é©Ÿ 1ï¼šæŸ¥è©¢ç†è§£èˆ‡å¢å¼·**
```java
/**
 * æŸ¥è©¢è™•ç†æœå‹™
 */
@Service
public class QueryProcessingService {
    
    public ProcessedQuery processQuery(String rawQuery) {
        // 1. æŸ¥è©¢æ¸…ç†
        String cleanQuery = cleanQuery(rawQuery);
        
        // 2. æŸ¥è©¢æ“´å±•
        List<String> expandedQueries = expandQuery(cleanQuery);
        
        // 3. æ„åœ–è­˜åˆ¥
        QueryIntent intent = identifyIntent(cleanQuery);
        
        return ProcessedQuery.builder()
            .originalQuery(rawQuery)
            .cleanQuery(cleanQuery)
            .expandedQueries(expandedQueries)
            .intent(intent)
            .build();
    }
    
    private List<String> expandQuery(String query) {
        List<String> expanded = new ArrayList<>();
        expanded.add(query);
        
        // æ·»åŠ åŒç¾©è©
        expanded.addAll(findSynonyms(query));
        
        // æ·»åŠ ç›¸é—œè©å½™
        expanded.addAll(findRelatedTerms(query));
        
        return expanded;
    }
}
```

**æ­¥é©Ÿ 2ï¼šç›¸ä¼¼æ€§æœå°‹**

åœ¨ Spring AI ä¸­ï¼Œç›¸ä¼¼æ€§æœå°‹å·²ç¶“ç”± `QuestionAnswerAdvisor` å’Œ `VectorStore` å…§éƒ¨è‡ªå‹•è™•ç†ï¼Œé–‹ç™¼è€…ä¸éœ€è¦æ‰‹å‹•å¯¦ç¾æª¢ç´¢é‚è¼¯ï¼š

```java
/**
 * åŸºæœ¬çš„å‘é‡æª¢ç´¢ç¤ºä¾‹
 */
@Service
public class DocumentRetrievalService {
    
    private final VectorStore vectorStore;
    
    public DocumentRetrievalService(VectorStore vectorStore) {
        this.vectorStore = vectorStore;
    }
    
    /**
     * æ‰‹å‹•æª¢ç´¢æ–‡æª”ï¼ˆç•¶éœ€è¦è‡ªå®šç¾©æª¢ç´¢é‚è¼¯æ™‚ï¼‰
     */
    public List<Document> searchDocuments(String query, int topK, double threshold) {
        return vectorStore.similaritySearch(
            SearchRequest.builder()
                .query(query)
                .topK(topK)
                .similarityThreshold(threshold)
                .build()
        );
    }
}
```

**æ­¥é©Ÿ 3ï¼šä¸Šä¸‹æ–‡çµ„è£èˆ‡ç”Ÿæˆ**

åœ¨ Spring AI ä¸­ï¼ŒRAG çš„ä¸Šä¸‹æ–‡çµ„è£å’Œç”Ÿæˆç”± `QuestionAnswerAdvisor` è‡ªå‹•è™•ç†ï¼š

```java
/**
 * RAG ç”Ÿæˆæœå‹™ç¤ºä¾‹
 */
@Service
public class RAGGenerationService {
    
    private final ChatClient ragChatClient;
    
    public RAGGenerationService(ChatClient ragChatClient) {
        this.ragChatClient = ragChatClient;
    }
    
    /**
     * ä½¿ç”¨ RAG ç”Ÿæˆå›æ‡‰
     */
    public String generateResponse(String query) {
        // Spring AI çš„ QuestionAnswerAdvisor æœƒè‡ªå‹•ï¼š
        // 1. æª¢ç´¢ç›¸é—œæ–‡æª”
        // 2. çµ„è£ä¸Šä¸‹æ–‡
        // 3. æ§‹å»ºæç¤ºè©
        // 4. èª¿ç”¨ LLM ç”Ÿæˆå›æ‡‰
        return ragChatClient.prompt()
            .user(query)
            .call()
            .content();
    }
    
    /**
     * å¸¶æœ‰å‹•æ…‹éæ¿¾æ¢ä»¶çš„ RAG æŸ¥è©¢
     */
    public String generateResponseWithFilter(String query, String filterExpression) {
        return ragChatClient.prompt()
            .user(query)
            .advisors(a -> a.param(QuestionAnswerAdvisor.FILTER_EXPRESSION, filterExpression))
            .call()
            .content();
    }
}
```

---

## 7.1.4 Spring AI RAG å¯¦ç¾

### åŸºç¤ RAG é…ç½®

```java
/**
 * RAG ç³»çµ±é…ç½®
 */
@Configuration
@EnableConfigurationProperties(RAGProperties.class)
public class RAGConfig {
    
    @Bean
    public VectorStore vectorStore(EmbeddingModel embeddingModel) {
        return new SimpleVectorStore(embeddingModel);
    }
    
    @Bean
    public QuestionAnswerAdvisor questionAnswerAdvisor(
            VectorStore vectorStore,
            RAGProperties properties) {
        
        return QuestionAnswerAdvisor.builder(vectorStore)
            .searchRequest(SearchRequest.builder()
                .topK(properties.getTopK())
                .similarityThreshold(properties.getSimilarityThreshold())
                .build())
            .build();
    }
    
    @Bean
    public ChatClient ragChatClient(
            ChatModel chatModel,
            QuestionAnswerAdvisor questionAnswerAdvisor) {
        
        return ChatClient.builder(chatModel)
            .defaultAdvisors(questionAnswerAdvisor)
            .build();
    }
}
```

### RAG æœå‹™å¯¦ç¾

```java
/**
 * RAG æœå‹™å¯¦ç¾
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class RAGService {
    
    private final ChatClient ragChatClient;
    private final VectorStore vectorStore;
    private final DocumentProcessingService documentProcessor;
    
    /**
     * æ·»åŠ æ–‡æª”åˆ°çŸ¥è­˜åº«
     */
    public void addDocuments(List<Resource> resources) {
        log.info("Adding {} documents to knowledge base", resources.size());
        
        List<Document> documents = new ArrayList<>();
        
        for (Resource resource : resources) {
            try {
                // ä½¿ç”¨ Spring AI çš„ ETL pipeline è™•ç†æ–‡æª”
                List<Document> processedDocs = processDocumentWithETL(resource);
                documents.addAll(processedDocs);
                
            } catch (Exception e) {
                log.error("Failed to process document: {}", resource.getFilename(), e);
            }
        }
        
        // å­˜å„²åˆ°å‘é‡è³‡æ–™åº«
        vectorStore.add(documents);
        
        log.info("Successfully added {} document chunks to knowledge base", documents.size());
    }
    
    private List<Document> processDocumentWithETL(Resource resource) {
        // Spring AI çš„ ETL pipeline æœƒè‡ªå‹•ï¼š
        // 1. è§£ææ–‡æª”å…§å®¹
        // 2. åˆ†å¡Šè™•ç†
        // 3. ç”ŸæˆåµŒå…¥å‘é‡
        // é–‹ç™¼è€…åªéœ€è¦èª¿ç”¨ç›¸æ‡‰çš„ DocumentReader
        
        // æ ¹æ“šæ–‡ä»¶é¡å‹é¸æ“‡åˆé©çš„ DocumentReader
        // ä¾‹å¦‚ï¼šPdfDocumentReader, TextDocumentReader ç­‰
        
        // é€™è£¡ç°¡åŒ–è™•ç†ï¼Œå¯¦éš›æ‡‰ç”¨ä¸­æœƒæ ¹æ“šæ–‡ä»¶é¡å‹ä½¿ç”¨å°æ‡‰çš„ Reader
        return List.of(new Document(resource.toString()));
    }
    
    /**
     * RAG æŸ¥è©¢
     */
    public RAGResponse query(String question) {
        log.debug("Processing RAG query: {}", question);
        
        long startTime = System.currentTimeMillis();
        
        try {
            // RAG æŸ¥è©¢ä½¿ç”¨ ChatClient å…§å»ºçš„ Advisor æ©Ÿåˆ¶
            String response = ragChatClient.prompt()
                .user(question)
                .call()
                .content();
            
            long processingTime = System.currentTimeMillis() - startTime;
            
            return RAGResponse.builder()
                .question(question)
                .answer(response)
                .processingTimeMs(processingTime)
                .timestamp(LocalDateTime.now())
                .build();
                
        } catch (Exception e) {
            log.error("RAG query failed: {}", question, e);
            throw new RAGException("Failed to process query", e);
        }
    }
    
    /**
     * æå–æ–‡æª”ä¾†æº
     */
    private List<DocumentSource> extractSources(List<Document> documents) {
        return documents.stream()
            .map(doc -> DocumentSource.builder()
                .title(getDocumentTitle(doc))
                .source(getDocumentSource(doc))
                .relevanceScore(getRelevanceScore(doc))
                .build())
            .collect(Collectors.toList());
    }
}
```

### RAG REST API

```java
/**
 * RAG REST API æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api/rag")
@RequiredArgsConstructor
@Slf4j
public class RAGController {
    
    private final RAGService ragService;
    
    /**
     * RAG æŸ¥è©¢ç«¯é»
     */
    @PostMapping("/query")
    public ResponseEntity<RAGResponse> query(@RequestBody RAGQueryRequest request) {
        try {
            RAGResponse response = ragService.query(request.getQuestion());
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            log.error("RAG query failed", e);
            return ResponseEntity.badRequest()
                .body(RAGResponse.builder()
                    .question(request.getQuestion())
                    .error("æŸ¥è©¢è™•ç†å¤±æ•—ï¼š" + e.getMessage())
                    .timestamp(LocalDateTime.now())
                    .build());
        }
    }
    
    /**
     * æ·»åŠ æ–‡æª”ç«¯é»
     */
    @PostMapping("/documents")
    public ResponseEntity<ApiResponse> addDocuments(
            @RequestParam("files") List<MultipartFile> files) {
        
        try {
            List<Resource> resources = files.stream()
                .map(this::convertToResource)
                .collect(Collectors.toList());
            
            ragService.addDocuments(resources);
            
            return ResponseEntity.ok(ApiResponse.success(
                String.format("æˆåŠŸæ·»åŠ  %d å€‹æ–‡æª”åˆ°çŸ¥è­˜åº«", files.size())));
                
        } catch (Exception e) {
            log.error("Failed to add documents", e);
            return ResponseEntity.badRequest()
                .body(ApiResponse.error("æ–‡æª”æ·»åŠ å¤±æ•—ï¼š" + e.getMessage()));
        }
    }
    
    /**
     * çŸ¥è­˜åº«çµ±è¨ˆç«¯é»
     */
    @GetMapping("/stats")
    public ResponseEntity<KnowledgeBaseStats> getStats() {
        // å¯¦ç¾çŸ¥è­˜åº«çµ±è¨ˆé‚è¼¯
        KnowledgeBaseStats stats = KnowledgeBaseStats.builder()
            .totalDocuments(1000)
            .totalChunks(5000)
            .lastUpdated(LocalDateTime.now())
            .build();
        
        return ResponseEntity.ok(stats);
    }
}
```

---

## ğŸ“ æœ¬ç« é‡é»å›é¡§

1. **RAG æ ¸å¿ƒæ¦‚å¿µ**ï¼šç†è§£äº†æª¢ç´¢å¢å¼·ç”Ÿæˆçš„åŸºæœ¬åŸç†å’Œä¼æ¥­åƒ¹å€¼
2. **ç³»çµ±æ¶æ§‹è¨­è¨ˆ**ï¼šæŒæ¡äº†å®Œæ•´çš„ RAG ç³»çµ±åˆ†å±¤æ¶æ§‹
3. **å·¥ä½œæµç¨‹è©³è§£**ï¼šå­¸æœƒäº†å¾è³‡æ–™æº–å‚™åˆ°æŸ¥è©¢è™•ç†çš„å®Œæ•´æµç¨‹
4. **Spring AI å¯¦ç¾**ï¼šå®Œæˆäº†åŸºæ–¼ Spring AI çš„ RAG ç³»çµ±å¯¦ç¾
5. **API ä»‹é¢è¨­è¨ˆ**ï¼šå»ºç«‹äº†å®Œæ•´çš„ RAG æœå‹™ REST API

### æŠ€è¡“è¦é»ç¸½çµ

| æŠ€è¡“é» | é‡è¦æ€§ | å¯¦ç¾é›£åº¦ | ä¼æ¥­åƒ¹å€¼ |
|--------|--------|----------|----------|
| **RAG æ¶æ§‹è¨­è¨ˆ** | â­â­â­ | ä¸­ | ç³»çµ±åŸºç¤ |
| **æ–‡æª”è™•ç†æµç¨‹** | â­â­â­ | ä¸­ | è³‡æ–™å“è³ª |
| **å‘é‡æª¢ç´¢** | â­â­â­ | é«˜ | æª¢ç´¢æº–ç¢ºæ€§ |
| **ä¸Šä¸‹æ–‡çµ„è£** | â­â­ | ä¸­ | å›æ‡‰å“è³ª |
| **API è¨­è¨ˆ** | â­â­ | ä½ | ç³»çµ±æ•´åˆ |

### æœ€ä½³å¯¦è¸å»ºè­°

1. **æ–‡æª”å“è³ª**ï¼šç¢ºä¿è¼¸å…¥æ–‡æª”çš„å“è³ªå’Œçµæ§‹åŒ–ç¨‹åº¦
2. **åˆ†å¡Šç­–ç•¥**ï¼šæ ¹æ“šæ–‡æª”é¡å‹é¸æ“‡åˆé©çš„åˆ†å¡Šå¤§å°å’Œé‡ç–Šåº¦
3. **æª¢ç´¢å„ªåŒ–**ï¼šèª¿æ•´ç›¸ä¼¼æ€§é–¾å€¼å’Œæª¢ç´¢æ•¸é‡ä»¥å¹³è¡¡æº–ç¢ºæ€§å’Œæ•ˆèƒ½
4. **æç¤ºè©è¨­è¨ˆ**ï¼šè¨­è¨ˆæ¸…æ™°çš„æç¤ºè©æ¨¡æ¿ä»¥æé«˜ç”Ÿæˆå“è³ª
5. **æ•ˆèƒ½ç›£æ§**ï¼šå»ºç«‹å®Œæ•´çš„ RAG ç³»çµ±æ•ˆèƒ½ç›£æ§æ©Ÿåˆ¶

### ä¸‹ä¸€æ­¥å­¸ç¿’æ–¹å‘

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘å€‘å°‡æ·±å…¥å­¸ç¿’å¦‚ä½•å°‡å…§å®¹å‘é‡åŒ–ï¼ŒåŒ…æ‹¬ï¼š
- ä¸åŒåµŒå…¥æ¨¡å‹çš„é¸æ“‡å’Œæ¯”è¼ƒ
- å‘é‡åŒ–çš„æœ€ä½³å¯¦è¸
- å‘é‡å“è³ªè©•ä¼°å’Œå„ªåŒ–
- å¤šèªè¨€å‘é‡åŒ–è™•ç†

---

**åƒè€ƒè³‡æ–™ï¼š**
- [Spring AI RAG Documentation](https://docs.spring.io/spring-ai/reference/api/vectordbs.html)
- [Retrieval-Augmented Generation Paper](https://arxiv.org/abs/2005.11401)
- [Vector Database Best Practices](https://www.pinecone.io/learn/vector-database/)
- [RAG System Design Patterns](https://blog.langchain.dev/rag-from-scratch/)